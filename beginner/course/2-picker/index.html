<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4Z2ZY6ZE84")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&family=Frank+Ruhl+Libre:wght@200;300;400;500;600&family=Encode+Sans+Semi+Condensed:wght@400&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/all.min.css><link disabled id=dark-mode-theme rel=stylesheet href=/css/dark.css><link rel=stylesheet type=text/css href=/css/style.css><link rel=stylesheet type=text/css href=/css/my_style.css><title>万众一芯开放验证 | 第二讲·Picker 的安装与使用</title>
<meta name=description content></head><body style=width:100%;max-width:100%;margin:0;padding:0><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="d-flex justify-content-between align-items-center" style=width:100%><div class="d-flex align-items-center"><a class="navbar-brand navbar-brand-content" href=https://open-verify.cc/cn><img src=/images/logo.png></a><div class="collapse navbar-collapse" id=navbarNavDropdown><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class=nav-link href=/registration_portal/>报名入口汇总</a></li><li class=nav-item><a class=nav-link href=/learningresource/>学习资源</a></li><li class=nav-item><a class=nav-link href=/about/>关于我们</a></li></ul></div></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNavDropdown aria-controls=navbarNavDropdown aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" style=flex:1><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class="btn fas fa-moon" id=dark-mode-toggle></a></li></ul></div></div></nav><div id=content><div class=container><div class="py-5 rounded-3"><div class="container-fluid py-2"><h1 class="display-2 mb-4 text-center">第二讲·Picker 的安装与使用</h1><p class="bio fs-4 serif text-center">以 Python 语言为例，介绍 Picker 的安装与使用</p></div></div><div class="row justify-content-between mb-5"><div class=col-6>Created <span style=font-size:small>Jul 30, 2025</span>
- Last updated <span style=font-size:small>Jul 30, 2025</span></div><div class=col-6 style=text-align:right></div><hr class=dropdown-divider></div><div class="container py-2"><div class="serif main-content"><center><iframe src="//player.bilibili.com/player.html?isOutside=true&aid=115008604215641&bvid=BV1btbVzkEQK&cid=31619745234&p=1&poster=1&autoplay=0" scrolling=no border=0 frameborder=no framespacing=0 allowfullscreen style=width:80%;aspect-ratio:16/9></iframe></center><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#概览>概览</a></li><li><a href=#picker-简介>Picker 简介</a></li><li><a href=#picker-的安装>Picker 的安装</a><ul><li><a href=#docker-镜像>Docker 镜像</a></li><li><a href=#系统要求>系统要求</a></li><li><a href=#依赖安装>依赖安装</a><ul><li><a href=#安装基本编译工具>安装基本编译工具</a></li><li><a href=#安装-verilator>安装 Verilator</a></li></ul></li><li><a href=#检查可用版本-1>检查可用版本</a><ul><li><a href=#swig-编译安装>Swig 编译安装</a></li></ul></li><li><a href=#安装-verible>安装 Verible</a><ul><li><a href=#下载>下载</a></li><li><a href=#配置环境变量>配置环境变量</a></li></ul></li><li><a href=#picker-的安装-1>Picker 的安装</a></li></ul></li><li><a href=#picker-的基本功能>Picker 的基本功能</a><ul><li><a href=#dut-的创建>DUT 的创建</a><ul><li><a href=#创建-dut-类>创建 DUT 类</a></li></ul></li><li><a href=#操作-dut>操作 DUT</a><ul><li><a href=#端口操作>端口操作</a></li><li><a href=#xdata-写入模式>XData 写入模式</a></li><li><a href=#导出内部信号>导出内部信号</a></li><li><a href=#时钟操作>时钟操作</a></li></ul></li><li><a href=#波形的动态开启与关闭仅-verilator-支持>波形的动态开启与关闭（仅 Verilator 支持）</a></li><li><a href=#用-assert-编写验证代码>用 <code>assert</code> 编写验证代码</a><ul><li><a href=#随机数生成器的验证代码>随机数生成器的验证代码</a></li></ul></li></ul></li><li><a href=#覆盖率的收集导出>覆盖率的收集导出</a><ul><li><a href=#功能覆盖率的收集>功能覆盖率的收集</a></li><li><a href=#导出覆盖率文件>导出覆盖率文件</a></li><li><a href=#生成报告并查看>生成报告并查看</a></li></ul></li><li><a href=#高级功能简介>高级功能简介</a></li><li><a href=#picker-的命令参数>Picker 的命令参数</a><ul><li><a href=#全局选项参数>全局选项参数</a><ul><li><a href=#基本帮助和版本选项>基本帮助和版本选项</a></li><li><a href=#路径查询选项>路径查询选项</a></li></ul></li><li><a href=#export-子命令常用参数><code>export</code> 子命令常用参数</a><ul><li><a href=#必要参数>必要参数</a></li><li><a href=#输入文件相关参数>输入文件相关参数</a></li><li><a href=#输出控制参数>输出控制参数</a></li><li><a href=#仿真功能参数>仿真功能参数</a></li><li><a href=#编译选项参数>编译选项参数</a></li></ul></li></ul></li><li><a href=#练习>练习</a></li></ul></nav></div><h1 id=概览>概览</h1><p>本讲会介绍芯片验证辅助工具 Picker，该工具可将 RTL 设计模块打包为动态库，并提供多语言编程接口。</p><p>从这次课程开始，我们将使<strong>Python</strong>为芯片验证的高级语言，相关的示例也会用 Python 编写。</p><p>本次课程的主要内容包括：</p><ul><li><p>Picker 工具简介及优势</p></li><li><p>安装配置流程（Verilator、Swig、Verible 等）</p></li><li><p>基本功能讲解（DUT 创建、端口操作、时钟控制）</p></li><li><p>Picker 命令参数的详解</p></li><li><p>同步 FIFO 实践练习</p></li></ul><p>通过学习，您将掌握如何使用 Picker 及 Python 进行高效芯片验证，提升验证效率。</p><h1 id=picker-简介>Picker 简介</h1><p>Picker 是一个芯片验证辅助工具，具有两个主要功能：</p><ol><li><p><strong>打包 RTL 设计验证模块：</strong> Picker 可以将 RTL 设计验证模块（<code>.v/.scala/.sv</code>）打包成动态库，并提供多种高级语言（目前支持 C++、Python、Java、Scala、Golang）的编程接口来驱动电路</p></li><li><p><strong>UVM-TLM 事务封装到其他语言：</strong> picker 能够基于用户提供的 UVM sequence_item 进行自动化的 TLM 代码封装，提供 UVM 与其他高级语言（如 Python）的通信接口。 该工具允许用户基于现有的软件测试框架，例如 pytest、junit、TestNG、go test 等，进行芯片单元测试</p></li></ol><p>基于 Picker 进行验证的优点：</p><ol><li><p>不泄露 RTL 设计：经过 Picker 转换后，原始的设计文件（<code>.v</code>）被转化成了二进制文件（<code>.so</code>），脱离原始设计文件后，依旧可进行验证，且验证者无法获取 RTL 源代码</p></li><li><p>减少编译时间：当 DUT（设计待测）稳定时，只需要编译一次（打包成 <code>.so </code>文件）</p></li><li><p>用户范围广：提供的编程接口多，覆盖不同语言的开发者</p></li><li><p>使用丰富的软件生态：支持 Python3、Java、Golang 等生态系统</p></li><li><p>自动化的 UVM 事务封装：通过自动化封装 UVM 事务，实现 UVM 和 Python 的通信</p></li></ol><p>Picker 目前支持的 RTL 仿真器：</p><ol><li><p>Verilator</p></li><li><p>Synopsys VCS</p></li></ol><hr><h1 id=picker-的安装>Picker 的安装</h1><p>在开始使用 Picker 进行芯片验证之前，我们需要先完成 Picker 及其依赖工具的安装。本节将介绍安装步骤和可能遇到的问题。</p><h2 id=docker-镜像>Docker 镜像</h2><p>我们提供了打包好的 Docker 镜像：</p><ul><li><p>包含 Picker：<code>ghcr.io/xs-mlvp/envbase:latest</code></p></li><li><p>包含 Picker 和 Toffee：<code>ghcr.io/xs-mlvp/envfull:latest</code></p></li></ul><p>具体用法请查阅：<a href=https://github.com/XS-MLVP/tutorial-records>https://github.com/XS-MLVP/tutorial-records</a></p><h2 id=系统要求>系统要求</h2><p>Picker 需要在 Linux 系统环境下运行，推荐使用以下发行版：</p><ol><li><p>Debian 12/13</p></li><li><p>Ubuntu 22.04/24.04</p></li></ol><blockquote><p><strong>注意</strong>：以下命令仅保证在上述列举的 Linux 发行版中正常工作，如果您使用其他发行版，遇到问题请自行解决。</p></blockquote><h2 id=依赖安装>依赖安装</h2><p>Picker 依赖于以下工具：</p><ol><li><p>基本编译工具（如 gcc、cmake 等）</p></li><li><p>lcov</p></li><li><p>Verilator</p></li><li><p>Swig</p></li><li><p>Verible</p></li></ol><p>接下来，我们会逐步完成这些依赖工具的安装。</p><h3 id=安装基本编译工具>安装基本编译工具</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y build-essential git cmake python3-venv libpython3-dev <span style=color:#111>time</span> lcov
</span></span></code></pre></div><h3 id=安装-verilator>安装 Verilator</h3><h4 id=检查可用版本>检查可用版本</h4><p>首先查看包管理工具提供的 Verilator 版本：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt show verilator
</span></span></code></pre></div><img src=./assets/verilator-apt.png style=width:40%><p>如上图所示，如果版本号（Version） <strong>≥ 4.218</strong>，可以通过包管理器直接安装：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y verilator
</span></span></code></pre></div><p>否则，需要编译安装 Verilator，建议安装最新版本。</p><blockquote><p><strong>注意</strong>：从 Verilator 5.030 开始，代码覆盖率统计结果的合并策略发生了变化，但不影响功能验证。</p></blockquote><h4 id=编译安装-verilator>编译安装 Verilator</h4><p>获取源代码：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 从 github 拉取代码</span>
</span></span><span style=display:flex><span>git clone https://github.com/verilator/verilator.git
</span></span><span style=display:flex><span><span style=color:#75715e># 注意！！！如果拉取失败，可以考虑用下面的命令从 gitee 拉取</span>
</span></span><span style=display:flex><span>git clone https://gitee.com/mirrors/Verilator verilator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进入仓库</span>
</span></span><span style=display:flex><span><span style=color:#111>cd</span> verilator
</span></span></code></pre></div><p>然后切换分支到稳定版、安装编译依赖的工具，然后再进行编译安装：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 切换分支</span>
</span></span><span style=display:flex><span>git checkout stable
</span></span><span style=display:flex><span><span style=color:#75715e># 安装依赖</span>
</span></span><span style=display:flex><span>sudo apt install -y help2man perl perl-doc flex bison autoconf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 编译</span>
</span></span><span style=display:flex><span>autoconf
</span></span><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>make -j
</span></span><span style=display:flex><span><span style=color:#75715e># 安装</span>
</span></span><span style=display:flex><span>sudo -E make install
</span></span></code></pre></div><p>然后在命令行里输入<code>verilator -version</code>，出现类似下图内容表示安装成功：</p><img src=./assets/verilator-version.png style=width:40%;min-width:550px><h2 id=检查可用版本-1>检查可用版本</h2><p>首先查看包管理工具提供的 Swig 版本：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt show swig
</span></span></code></pre></div><img src=./assets/swig-apt.png style=width:20%;min-width:300px><p>如上图所示，如果版本号（Version） 如果版本号 <strong>≥ 4.2.0</strong>，可以通过包管理器直接安装：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y swig
</span></span></code></pre></div><p>否则，需要编译安装 swig，建议安装最新版本。</p><h3 id=swig-编译安装>Swig 编译安装</h3><p>如果你先前通过包管理器安装了 Swig，请先删除：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt purge -y swig
</span></span></code></pre></div><p>首先打开 Swig 源码的下载网站 <a href=https://www.swig.org/download.html>https://www.swig.org/download.html</a></p><center><img src=./assets/swig-website.png style=width:90%></center><p>截止在编写教程时，我们得到源码的链接为<code>wget http://prdownloads.sourceforge.net/swig/swig-4.3.1.tar.gz</code></p><blockquote><p>❓如果我打开的 swig 网站版本跟截图里的不一样，该怎么办？
没有问题，不低于 4.2.0 就行。</p></blockquote><p>随后在 Linux 中下载 swig 的源码：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 注意！下载的版本号可能不一样，以实际下载结果为准</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下载 swig 源码. 如果你对 Linux 比较熟悉，可以使用你喜欢的方法下载</span>
</span></span><span style=display:flex><span>sudo apt install -y wget <span style=color:#75715e># 安装wget</span>
</span></span><span style=display:flex><span>wget http://prdownloads.sourceforge.net/swig/swig-4.3.1.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tar xvf swig-4.3.1.tar.gz <span style=color:#75715e># 在当前目录解压缩</span>
</span></span><span style=display:flex><span><span style=color:#111>cd</span> swig-4.3.1 <span style=color:#75715e># 进入源码文件夹</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt install -y python3-pip libpcre2-dev <span style=color:#75715e># 安装依赖</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 编译</span>
</span></span><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>make -j
</span></span><span style=display:flex><span><span style=color:#75715e># 安装</span>
</span></span><span style=display:flex><span>sudo -E make install
</span></span></code></pre></div><p>执行命令<code>swig --version</code>，出现类似下图内容表示安装成功：</p><img src=./assets/swig-version.png style=width:60%;min-width:500px><h2 id=安装-verible>安装 Verible</h2><p>从 GitHub 下载 Verible 的二进制程序：https://github.com/chipsalliance/verible/releases</p><h3 id=下载>下载</h3><p>下载 verible 的二进制程序（x86）并解压缩：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 注意！下载的版本号可能不一样，以实际下载结果为准</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下载 verible, 如果你对 Linux 比较熟悉，可以使用你喜欢的方法下载</span>
</span></span><span style=display:flex><span>sudo apt install -y wget <span style=color:#75715e># 安装wget</span>
</span></span><span style=display:flex><span>wget https://github.com/chipsalliance/verible/releases/download/v0.0-3958-g7aae5c08/verible-v0.0-3958-g7aae5c08-linux-static-x86_64.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 解压缩</span>
</span></span><span style=display:flex><span>tar xvf verible-v0.0-3958-g7aae5c08-linux-static-x86_64.tar.gz
</span></span></code></pre></div><blockquote><p>⚠️警告：你需要把解压缩后的文件夹妥善安放在一个目录里，在环境变量配置好后不要移动</p></blockquote><h3 id=配置环境变量>配置环境变量</h3><p>在命令行中执行：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#111>echo</span> <span style=color:#111>$SHELL</span>
</span></span></code></pre></div><p>如果输出包含<code>bash</code>，说明使用的是 Bash Shell。以下配置基于 Bash，其他 Shell 请自行调整。</p><p>随后来到 verible 解压缩后所在的文件夹，以教程为例，输入<code>ls</code>命令后，能看到<code>verible-v0.0-3958-g7aae5c08-linux-static-x86_64</code>文件夹：</p><img src=./assets/verible-dir.png style=width:60%><p>之后添加环境变量：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># verible-v0.0-3958-g7aae5c08 以实际下载结果为准，然后替换成你解压缩后的文件夹</span>
</span></span><span style=display:flex><span><span style=color:#111>echo</span> <span style=color:#d88200>&#34;export PATH=\$PATH:</span><span style=color:#00a8c8>$(</span>realpath verible-v0.0-3958-g7aae5c08<span style=color:#00a8c8>)</span><span style=color:#d88200>/bin&#34;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span><span style=color:#111>source</span> ~/.bashrc
</span></span></code></pre></div><p>执行<code>verible-verilog-format --version</code>，出现类似下图内容表示安装成功：</p><img src=./assets/verible-version.png style=width:60%><h2 id=picker-的安装-1>Picker 的安装</h2><p>完成所有依赖工具的安装后，现在可以安装 Picker 本身。</p><p>首先下载 Picker 的源码并进入仓库：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/XS-MLVP/picker.git --depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#111>cd</span> picker
</span></span></code></pre></div><p>然后构建并安装：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make <span style=color:#75715e># 编译</span>
</span></span><span style=display:flex><span>sudo -E make install <span style=color:#75715e># 安装</span>
</span></span></code></pre></div><blockquote><p>⚠️注意：可通过 <code>make BUILD_XSPCOMM_SWIG=python,java,scala,golang,lua -j</code>开启其他语言的支持。各语言的开发环境需要自行配置。</p></blockquote><p>安装完成后，执行<code>picker</code>命令可以得到以下输出：</p><img src=./assets/picker-commands.png style=width:90%><p>完成安装后，运行以下示例验证安装是否正确：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bash example/Adder/release-verilator.sh --lang python
</span></span><span style=display:flex><span>bash example/RandomGenerator/release-verilator.sh --lang python
</span></span></code></pre></div><p>成功运行后，您将看到对<a href=https://open-verify.cc/mlvp/docs/quick-start/eg-adder/>加法器</a>和<a href=https://open-verify.cc/mlvp/docs/quick-start/eg-rmg/>随机数生成器</a>的测试过程及结果。</p><hr><h1 id=picker-的基本功能>Picker 的基本功能</h1><p>成功安装 Picker 后，我们将学习如何使用它进行 DUT（Design Under Test，待测设计）的创建和操作方法。</p><h2 id=dut-的创建>DUT 的创建</h2><p>以<a href=https://open-verify.cc/mlvp/docs/quick-start/eg-rmg/>随机数生成器</a>为例。</p><p>首先，创建一个 <code>example</code> 文件夹，然后进入。</p><blockquote><p>注意，后面的操作都在 <code>example</code> 文件夹中</p></blockquote><p>在 example 文件夹中创建<code>RandomGenerator.v</code>文件，内容为：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#00a8c8>module</span> <span style=color:#111>RandomGenerator</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>input</span> <span style=color:#00a8c8>wire</span> <span style=color:#111>clk</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>input</span> <span style=color:#00a8c8>wire</span> <span style=color:#111>reset</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>input</span> <span style=color:#111>[</span><span style=color:#ae81ff>15</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>seed</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>output</span> <span style=color:#111>[</span><span style=color:#ae81ff>15</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>random_number</span>
</span></span><span style=display:flex><span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>reg</span> <span style=color:#111>[</span><span style=color:#ae81ff>15</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#111>lfsr</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>always</span> <span style=color:#111>@(</span><span style=color:#00a8c8>posedge</span> <span style=color:#111>clk</span> <span style=color:#00a8c8>or</span> <span style=color:#00a8c8>posedge</span> <span style=color:#111>reset</span><span style=color:#111>)</span> <span style=color:#00a8c8>begin</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>reset</span><span style=color:#111>)</span> <span style=color:#00a8c8>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#111>lfsr</span> <span style=color:#f92672>&lt;=</span> <span style=color:#111>seed</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>end</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>begin</span>
</span></span><span style=display:flex><span>            <span style=color:#111>lfsr</span> <span style=color:#f92672>&lt;=</span> <span style=color:#111>{</span><span style=color:#111>lfsr</span><span style=color:#111>[</span><span style=color:#ae81ff>14</span><span style=color:#f92672>:</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>lfsr</span><span style=color:#111>[</span><span style=color:#ae81ff>15</span><span style=color:#111>]</span> <span style=color:#f92672>^</span> <span style=color:#111>lfsr</span><span style=color:#111>[</span><span style=color:#ae81ff>14</span><span style=color:#111>]};</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>end</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>assign</span> <span style=color:#111>random_number</span> <span style=color:#f92672>=</span> <span style=color:#111>lfsr</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>endmodule</span>
</span></span></code></pre></div><h3 id=创建-dut-类>创建 DUT 类</h3><p>使用 Picker 的<code>export</code>命令创建 DUT 类：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>picker <span style=color:#111>export</span> RandomGenerator.v --sname RandomGenerator -w RandomGenerator.fst --lang python --sim verilator
</span></span></code></pre></div><p><strong>命令参数解释</strong>：</p><ol><li><p><code>RandomGenerator.v</code>：指定 RTL 设计文件</p></li><li><p><code>--sname RandomGenerator</code>：指定顶层模块名称</p></li><li><p><code>-w RandomGenerator.fst</code>：启用波形输出，指定波形文件名</p></li><li><p><code>--lang python</code>：生成 Python 的 DUT</p></li><li><p><code>--sim verilator</code>：使用 Verilator 作为仿真器</p></li></ol><p>执行完成后，会生成一个同名文件夹，其中包含 DUT 类<code>DUTRandomGenerator</code>，目录结构为：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── RandomGenerator # 由Picker生成
</span></span><span style=display:flex><span>│   ├── example.py
</span></span><span style=display:flex><span>│   ├── __init__.py
</span></span><span style=display:flex><span>│   ├── libUT_RandomGenerator.py
</span></span><span style=display:flex><span>│   ├── libUTRandomGenerator.so
</span></span><span style=display:flex><span>│   ├── pli.tab
</span></span><span style=display:flex><span>│   ├── signals.json
</span></span><span style=display:flex><span>│   ├── _UT_RandomGenerator.so
</span></span><span style=display:flex><span>│   └── xspcomm
</span></span><span style=display:flex><span>└── RandomGenerator.v # 随机数生成器的设计文件
</span></span></code></pre></div><h4 id=实例化-dut-类>实例化 DUT 类</h4><p>现在可以通过 Python 代码实例化 DUT 类，创建<code>test_dut.py</code>文件：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span> <span style=color:#75715e># 创建DUT</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>通过<code>python3 test_dut.py</code>就能成功运行此文件。</p><p>在上面的代码中，我们先实例化了随机数生成器的 DUT，之后再调用了 <code>dut.Finish()</code>方法。</p><h4 id=关于finish方法>关于<code>Finish()</code>方法</h4><p><code>Finish()</code>方法是仿真控制中的关键函数，它具有以下重要功能：</p><ol><li><p><strong>结束仿真</strong>：正常终止仿真进程</p></li><li><p><strong>保存波形文件</strong>：将仿真过程中记录的波形数据写入指定格式的文件（如。fst)</p></li><li><p><strong>生成覆盖率文件</strong>：如果启用了覆盖率收集，会生成相应的覆盖率数据文件</p></li><li><p><strong>释放资源</strong>：清理仿真过程中分配的内存和其他系统资源</p></li></ol><p>如果需要生成波形文件或覆盖率报告，务必在仿真结束时调用<code>Finish()</code>方法。否则，波形和覆盖率数据将不会被保存。</p><h2 id=操作-dut>操作 DUT</h2><p>创建 DUT 类后，我们需要学习如何操作它，包括读写端口、控制时钟以及监控内部信号。</p><p>本节将使用随机数生成器作为示例，详细介绍 DUT 操作的各个方面，并会使用<code>DUTRandomGenerator</code>的实例展示相关操作。</p><p>假定目录结构如下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── RandomGenerator
</span></span><span style=display:flex><span>│   ├── example.py
</span></span><span style=display:flex><span>│   ├── __init__.py
</span></span><span style=display:flex><span>│   ├── libUT_RandomGenerator.py
</span></span><span style=display:flex><span>│   ├── libUTRandomGenerator.so
</span></span><span style=display:flex><span>│   ├── pli.tab
</span></span><span style=display:flex><span>│   ├── signals.json
</span></span><span style=display:flex><span>│   ├── _UT_RandomGenerator.so
</span></span><span style=display:flex><span>│   └── xspcomm
</span></span><span style=display:flex><span>│
</span></span><span style=display:flex><span>├── example.py # 假设代码都为位于该文件中
</span></span><span style=display:flex><span>└── RandomGenerator.v # 随机数生成器的设计文件
</span></span></code></pre></div><h3 id=端口操作>端口操作</h3><p>DUT 的所有端口及其导出的内部信号都以成员变量的形式定义在该 DUT 类。这些成员变量的类型为 XData 类型，Picker 用该类型对电路引脚的数据进行表示。</p><p>我们可以通过以下方式读取信号的值：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>           <span style=color:#75715e># 创建DUT </span>
</span></span><span style=display:flex><span>    <span style=color:#111>rand</span> <span style=color:#f92672>=</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>random_number</span><span style=color:#f92672>.</span><span style=color:#111>value</span>       <span style=color:#75715e># 读取引脚random_number的值, 与 `rand = dut.random_number.U()` 等价</span>
</span></span><span style=display:flex><span>    <span style=color:#111>rand_lsb</span> <span style=color:#f92672>=</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>random_number</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>      <span style=color:#75715e># 读取引脚random_number的最低位</span>
</span></span><span style=display:flex><span>    <span style=color:#111>rand_signed</span> <span style=color:#f92672>=</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>random_number</span><span style=color:#f92672>.</span><span style=color:#111>S</span><span style=color:#111>()</span>  <span style=color:#75715e># 按有符号类型读取引脚random_number的值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>如果要对端口赋值：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>    <span style=color:#75715e># 创建DUT </span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>12345</span>        <span style=color:#75715e># 十进制赋值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0b11011</span>      <span style=color:#75715e># 二进制赋值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0o12345</span>      <span style=color:#75715e># 八进制赋值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x12345</span>      <span style=color:#75715e># 十六进制赋值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>           <span style=color:#75715e># 所有bit赋值1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span>            <span style=color:#75715e># 与 a.Set(x) 等价</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>               <span style=color:#75715e># 对第1位进行赋值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;x&#34;</span>          <span style=color:#75715e># 赋值高阻态</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;z&#34;</span>          <span style=color:#75715e># 赋值不定态</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><h3 id=xdata-写入模式>XData 写入模式</h3><p>在Picker 中，XData 是电路引脚数据的表示方式，支持三种不同的写模式：</p><ul><li><p><strong>立即写模式（Imme）</strong> ：数据立即写入目标，不依赖时钟</p></li><li><p><strong>上升沿写模式（Rise）</strong> ：数据仅在时钟信号的上升沿时被写入目标。<strong>这是默认的写入模式</strong></p></li><li><p><strong>下降沿写模式（Fall）</strong> ：数据仅在时钟信号的下降沿时被写入目标</p></li></ul><p>这三种写模式可以通过<code>SetWriteMode()</code>方法，或使用<code>AsImmWrite()</code>、<code>AsRiseWrite()</code>和<code>AsFallWrite()</code>直接切换写入模式。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span> <span style=color:#75715e># 创建DUT </span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>AsRiseWrite</span><span style=color:#111>()</span>     <span style=color:#75715e># seed切换为上升沿写入，默认模式</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>AsFallWrite</span><span style=color:#111>()</span>     <span style=color:#75715e># seed切换为下降沿写入</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>AsImmWrite</span><span style=color:#111>()</span>      <span style=color:#75715e># seed切换为立即写入</span>
</span></span></code></pre></div><h3 id=导出内部信号>导出内部信号</h3><p>除了模块的引脚信号外，我们可能需要访问 DUT 内部的信号。Picker 提供了导出内部信号的机制，分为静态导出和动态获取两种方法。</p><h4 id=静态导出>静态导出</h4><p>我们把需要访问的内部信号写入<code>yaml</code>文件后，就可以通过 DUT 类获取内部的信号。</p><p>在随机数生成器的代码中，内部定义了一个<code>lfsr</code>寄存器，要想通过 DUT 类中访问，我们先要创建<code>internal.yaml</code>文件，内容为：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>RandomGenerator</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#d88200>&#34;reg [15:0] lfsr&#34;</span>
</span></span></code></pre></div><p>然后在原有命令的基础上，添加新的参数<code>--internal ./internal.yaml</code>，完整的命令如下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -r RandomGenerator <span style=color:#75715e># 记得删除之前创建的文件夹</span>
</span></span><span style=display:flex><span>picker <span style=color:#111>export</span> RandomGenerator.v -w RandomGenerator.fst --lang python --sim verilator --internal ./internal.yaml
</span></span></code></pre></div><p>这样就可以通过 DUT 类访问内部信号，导出的内部信号的名字遵循<code>模块名_信号名</code>的规则，例如<code>RandomGenerator_lfsr</code>。</p><h4 id=动态获取>动态获取</h4><p>动态获取有两种方式：</p><ul><li><p>通过 VPI（默认开启）</p></li><li><p>通过 Mem-Direct（有更好的性能）</p></li></ul><p>如果想通过 Mem-Direct 的模式访问，需要在原命令的基础上添加新参数<code>--rw 1</code>，需要注意的是该模式只支持 Verilator，完整的命令如下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -r RandomGenerator <span style=color:#75715e># 记得删除之前创建的文件夹</span>
</span></span><span style=display:flex><span>picker <span style=color:#111>export</span> RandomGenerator.v -w RandomGenerator.fst --lang python --sim verilator --rw <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>这样就可以通过：</p><ul><li><p><code>GetInternalSignalList</code>：列出所有的内部信号</p></li><li><p><code>GetInternalSignal("name")</code>：动态访问内部信号</p></li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#111>DUTRandomGenerator</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 初始化时钟，参数时钟引脚对应的名称，例如clk</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clk&#34;</span><span style=color:#111>)</span>               
</span></span><span style=display:flex><span>    <span style=color:#75715e># 列出所有内部信号</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>GetInternalSignalList</span><span style=color:#111>())</span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e># 动态访问</span>
</span></span><span style=display:flex><span>    <span style=color:#111>name</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;RandomGenerator_top.RandomGenerator.lfsr&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>lfsr</span> <span style=color:#f92672>=</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>GetInternalSignal</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 打印值</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>lfsr</span><span style=color:#f92672>.</span><span style=color:#111>value</span><span style=color:#111>)</span> 
</span></span></code></pre></div><h3 id=时钟操作>时钟操作</h3><p><code>XClock</code>是电路时钟的封装，用于控制时钟相关的操作。在传统仿真工具（例如 Verilator）中，需要手动为时钟信号赋值。但在 Picker 中，我们提供了相应的方法，可以把时钟引脚直接绑定到 XClock 上。只需要通过<code>Step()</code>方法，就可以同时更新时钟信号和电路状态。</p><p>每个 DUT 类均包含<code>xclock</code>成员变量（类型为<code>XClock</code>），它是驱动仿真时序的核心组件，通过：</p><ul><li><p><code>Step()</code>：控制时钟推进并更新电路状态</p><ul><li><p><code>Step()</code>：推进1个周期</p></li><li><p><code>Step(x)</code>：推进 x 个周期</p></li></ul></li><li><p><code>StepRis()</code>：控制上升沿触发逻辑</p></li><li><p><code>StepFal()</code>：控制下降沿触发逻辑</p></li></ul><p><code>xclock</code>还会直接绑定时钟端口实现信号同步更新，同时为波形记录、覆盖率采集等功能提供全局时序事件支持，DUT 类中所有时钟操作均通过调用<code>xclock</code>的接口实现。</p><h4 id=时钟的绑定和驱动>时钟的绑定和驱动</h4><p>RandomGenerator 的时钟端口是<code>clock</code>，我们可以通过<code>InitClock</code>方法绑定时钟端口，使用<code>Step</code>方法驱动时钟、刷新电路状态：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 初始化时钟，参数时钟引脚对应的名称，例如clk</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clk&#34;</span><span style=color:#111>)</span> 
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 时钟推进到下一个上升沿之前，与 `dut.xclock.Step()` 等价</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 时钟推进到后5个上升沿之前，与 `dut.xclock.Step(5)` 等价</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><blockquote><p><strong>提示</strong>：<code>Step()</code>方法并不是真的推进一个完整周期，而是推进到下一个上升沿之前。观察波形可以更好地理解时钟信号的变化关系。</p></blockquote><p>异步编程是实现电路并发驱动的重要手段，Picker 也提供了异步环境下的时钟方法：</p><ul><li><p><code>AStep(cycle: int)</code>：异步等待时钟经过 cycle 个周期， 例如：<code>await dut.AStep(5)</code></p></li><li><p><code>ACondition(condition)</code>：异步等待条件为真，注意<code>condtion</code>是一个返回布尔值的<strong>函数对象</strong></p></li><li><p><code>RunStep(cycle: int)</code>：驱动时钟信号，持续推进时钟 cycle 个时钟</p></li></ul><blockquote><p>后面几讲会详细介绍异步编程相关的内容，这里简单先了解 Picker 提供的异步方法。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>pin_value_is_beef</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#111>:</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>is_beef</span><span style=color:#111>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#111>bool</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>random_number</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xBEEF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>is_beef</span> <span style=color:#75715e># 返回的不是 is_beef()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>example_async</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#111>:</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Reset start.&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xBEEF</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Wait condition&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>await</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>ACondition</span><span style=color:#111>(</span><span style=color:#111>pin_value_is_beef</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#111>))</span>  <span style=color:#75715e># 等待引脚信号变为0xBEEF</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 等价于 await dut.ACondition(lambda: dut.random_number.value == 0xBEEF)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Wait 1 clock&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>await</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>AStep</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>  <span style=color:#75715e># 等待时钟经过1个周期, 与 `dut.xclock.AStep(1)` 等价</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Reset done.&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>async</span> <span style=color:#00a8c8>def</span> <span style=color:#75af00>main</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#111>:</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>asyncio</span><span style=color:#f92672>.</span><span style=color:#111>create_task</span><span style=color:#111>(</span><span style=color:#111>example_async</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>await</span> <span style=color:#111>asyncio</span><span style=color:#f92672>.</span><span style=color:#111>create_task</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>RunStep</span><span style=color:#111>(</span><span style=color:#ae81ff>10</span><span style=color:#111>))</span>  <span style=color:#75715e># 让时钟持续推进 10 个周期</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clk&#34;</span><span style=color:#111>)</span>  <span style=color:#75715e># 初始化时钟，参数时钟引脚对应的名称，例如clk</span>
</span></span><span style=display:flex><span>    <span style=color:#111>asyncio</span><span style=color:#f92672>.</span><span style=color:#111>run</span><span style=color:#111>(</span><span style=color:#111>main</span><span style=color:#111>(</span><span style=color:#111>dut</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><blockquote><p>❓问题：如果把<code>dut.RunStep(10)</code>修改为<code>dut.RunStep(1)</code>，还会打印<code>Reset done.</code>吗？</p></blockquote><h4 id=注册回调函数>注册回调函数</h4><p>回调函数允许在时钟的特定边沿执行自定义操作，通过<code>StepRis</code>和<code>StepFal</code>方法注册。时钟的回调函数必须至少有一个参数，传入的第一个参数是当前的周期数。</p><p>在下面的例子中，回调函数<code>callback</code>会在注册完成之后，在每个周期的上升沿输出当前的周期数；如果<code>reset</code>信号置高，还会输出<code>DUT reset.</code>。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>callback</span><span style=color:#111>(</span><span style=color:#111>cycles</span><span style=color:#111>,</span> <span style=color:#111>reset</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;The current clock cycle is </span><span style=color:#d88200>{</span><span style=color:#111>cycles</span><span style=color:#d88200>}</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;DUT reset.&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 初始化时钟，参数时钟引脚对应的名称，例如clk</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clk&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 注意！传入的是 callback，不是 callback()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>StepRis</span><span style=color:#111>(</span><span style=color:#111>callback</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#111>])</span> 
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 驱动时钟</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><blockquote><p><strong>注意</strong>：传入的是回调函数名<code>callback</code>，而不是函数调用<code>callback()</code>。
更完整的回调函数案例可以参考<a href=https://open-verify.cc/mlvp/docs/quick-start/eg-stack-callback>双端口栈（回调）</a>。</p></blockquote><h2 id=波形的动态开启与关闭仅-verilator-支持>波形的动态开启与关闭（仅 Verilator 支持）</h2><p>如果在导出 DUT 的时候开启了<code>-w</code>之后，我们还可以动态地控制波形的开启和关闭：</p><ul><li><p>CloseWaveform(): 停止向波形文件写入数据。调用后，已创建的波形文件将被保留，但后续的仿真活动不会再被记录</p><ul><li><p>建议在调用前执行一次 RefreshComb()，以确保电路的最终状态被正确捕获</p></li><li><p><code>RefreshComb()</code> 用于刷新电路的组合逻辑状态，<strong>与 <code>Step()</code> 的核心区别在于它不会推进仿真时钟</strong></p><ul><li>因此，仅当需要在不推进时钟的情况下更新电路状态时，才需要调用 <code>RefreshComb()</code>。在常规的时钟步进仿真中，直接使用 <code>Step()</code> 即可，<font style=color:red;font-weight:700>无需额外调用</font>此函数</li></ul></li></ul></li><li><p><code>OpenWaveform()</code>：在调用<code>CloseWaveform()</code>之后，<strong>恢复</strong>波形的导出</p></li></ul><p>我们在刚刚注册回调函数的例子中，添加关闭和开启波形的代码：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>callback</span><span style=color:#111>(</span><span style=color:#111>cycles</span><span style=color:#111>,</span> <span style=color:#111>reset</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;The current clock cycle is </span><span style=color:#d88200>{</span><span style=color:#111>cycles</span><span style=color:#d88200>}</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;DUT reset.&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span> 
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 初始化时钟，参数时钟引脚对应的名称，例如clk</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clk&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 注意！传入的是 callback，不是 callback()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>StepRis</span><span style=color:#111>(</span><span style=color:#111>callback</span><span style=color:#111>,</span> <span style=color:#111>[</span><span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#111>])</span> 
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>RefreshComb</span><span style=color:#111>()</span>   <span style=color:#75715e># 刷新电路</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>CloseWaveform</span><span style=color:#111>()</span> <span style=color:#75715e># 关闭波形</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>OpenWaveform</span><span style=color:#111>()</span> <span style=color:#75715e># 开启波形</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>打开波形文件可以发现，波形直接记录了<code>reset</code>信号保持 4 个低电平的状态。</p><h2 id=用-assert-编写验证代码>用 <code>assert</code> 编写验证代码</h2><p>在熟悉如何操作之后，我们就可以编写验证代码了，一般通过 <code>assert</code> 来判断结果的正确性。</p><p><code>assert</code> 是 Python 中的一个关键词，它有两种使用格式：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>assert</span> <span style=color:#111>布尔表达式</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>assert</span> <span style=color:#111>布尔表达式</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;提示字符串&#34;</span>
</span></span></code></pre></div><p>其中，布尔表达式部分要编写我们认为是正确的情况；提示字符串是可选部分，当表达式的结果为假时，会输出提示字符串的内容。</p><p>比如说，我们希望随机数生成器的结果为 <code>114514</code>，那么我们可以写：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>assert</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>random_number</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>114514</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Mismatch&#34;</span>
</span></span></code></pre></div><p>如果随机数生成器的结果不是 <code>114514</code>，那么最终会输出 &ldquo;Mismatch&rdquo;。</p><h3 id=随机数生成器的验证代码>随机数生成器的验证代码</h3><p>下面就是随机数生成器的验证代码：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>RandomGenerator</span> <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>random</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义参考模型</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>LFSR_16</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>seed</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>state</span> <span style=color:#f92672>=</span> <span style=color:#111>seed</span> <span style=color:#f92672>&amp;</span> <span style=color:#111>((</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>16</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>Step</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>new_bit</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>state</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>15</span><span style=color:#111>)</span> <span style=color:#f92672>^</span> <span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>state</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>14</span><span style=color:#111>)</span> <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>state</span> <span style=color:#f92672>=</span> <span style=color:#111>((</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>state</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#f92672>|</span> <span style=color:#111>new_bit</span> <span style=color:#111>)</span> <span style=color:#f92672>&amp;</span> <span style=color:#111>((</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>16</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#111>__name__</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;__main__&#34;</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUTRandomGenerator</span><span style=color:#111>()</span>            <span style=color:#75715e># 创建DUT </span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clk&#34;</span><span style=color:#111>)</span>                  <span style=color:#75715e># 指定时钟引脚，初始化时钟</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seed</span> <span style=color:#f92672>=</span> <span style=color:#111>random</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span><span style=color:#ae81ff>16</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>   <span style=color:#75715e># 生成随机种子</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>seed</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>seed</span>                 <span style=color:#75715e># 设置DUT种子</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># reset DUT</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>                   <span style=color:#75715e># reset 信号置1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>                            <span style=color:#75715e># 推进一个时钟周期（时序电路，需要通过Step推进）</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>reset</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>                   <span style=color:#75715e># reset 信号置0</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>                            <span style=color:#75715e># 推进一个时钟周期</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#111>ref</span> <span style=color:#f92672>=</span> <span style=color:#111>LFSR_16</span><span style=color:#111>(</span><span style=color:#111>seed</span><span style=color:#111>)</span>                   <span style=color:#75715e># 创建参考模型用于对比</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>65536</span><span style=color:#111>):</span>                <span style=color:#75715e># 循环65536次</span>
</span></span><span style=display:flex><span>        <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>                        <span style=color:#75715e># dut 推进一个时钟周期，生成随机数</span>
</span></span><span style=display:flex><span>        <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#111>Step</span><span style=color:#111>()</span>                        <span style=color:#75715e># ref 推进一个时钟周期，生成随机数</span>
</span></span><span style=display:flex><span>        <span style=color:#111>rand</span> <span style=color:#f92672>=</span> <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>random_number</span><span style=color:#f92672>.</span><span style=color:#111>value</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>assert</span> <span style=color:#111>rand</span> <span style=color:#f92672>==</span> <span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#111>state</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Mismatch&#34;</span>  <span style=color:#75715e># 对比DUT和参考模型生成的随机数</span>
</span></span><span style=display:flex><span>        <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#34;Cycle </span><span style=color:#d88200>{</span><span style=color:#111>i</span><span style=color:#d88200>}</span><span style=color:#d88200>, DUT: </span><span style=color:#d88200>{</span><span style=color:#111>rand</span><span style=color:#d88200>:</span><span style=color:#d88200>x</span><span style=color:#d88200>}</span><span style=color:#d88200>, REF: </span><span style=color:#d88200>{</span><span style=color:#111>ref</span><span style=color:#f92672>.</span><span style=color:#111>state</span><span style=color:#d88200>:</span><span style=color:#d88200>x</span><span style=color:#d88200>}</span><span style=color:#d88200>&#34;</span><span style=color:#111>)</span> <span style=color:#75715e># 打印结果</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 完成测试</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Test Passed&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>    <span style=color:#75715e># Finish函数会完成波形、覆盖率等文件的写入</span>
</span></span></code></pre></div><p>在这里，我们用 Python 代码实现了一个类<code>LSRF_16</code>，它被用来模拟设计模块的预期行为，被称为<strong>参考模型</strong>。</p><p>最终，我们通过一个循环，把设计模块每个周期的输出和参考模型的输出进行对比。当循环结束且没有报错，就代表这个模块的验证结束并且没有发现错误。</p><hr><h1 id=覆盖率的收集导出>覆盖率的收集导出</h1><blockquote><p>💡可选阅读部分：在下一讲会有更详细的介绍。</p></blockquote><p>接下来将介绍如何导出代码覆盖率和功能覆盖率。</p><p>对于代码覆盖率，<strong>需要保证在 Picker 创建 DUT 时添加<code>-c</code>参数</strong>，启动代码行覆盖率的自动收集。</p><p>如果使用 Python 来验证硬件，功能覆盖率的收集需要使用 toffee 和 toffee-test：</p><ul><li><p>toffee 是一个基于 Python的验证框架。</p></li><li><p>toffee-test 是一个用于为 toffee 框架提供测试支持的 Pytest 插件，它提供了测试报告生成功能。</p></li></ul><p>我们会在下一讲中详细介绍 toffee 和 toffee-test 的安装与使用，或者参考<a href=https://github.com/XS-MLVP/toffee-test/>仓库文档</a>。这里只介绍如何使用 toffee-test 提供的覆盖率收集功能，以及如何导出收集的结果。</p><h2 id=功能覆盖率的收集>功能覆盖率的收集</h2><p>编写<strong>覆盖点（Cover point）</strong>前，首先需要创建一个<strong>覆盖组（Cover group）</strong>，并指定覆盖组的名称</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>toffee.funcov</span> <span style=color:#00a8c8>as</span> <span style=color:#111>fc</span>
</span></span><span style=display:flex><span><span style=color:#111>g</span> <span style=color:#f92672>=</span> <span style=color:#111>fc</span><span style=color:#f92672>.</span><span style=color:#111>CovGroup</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Group-A&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>接着，需要往这个覆盖组中添加覆盖点。一般情况下，一个功能点对应一个或多个覆盖点，用来检查是否满足该功能。例如我们需要检查<code>Adder</code>的<code>cout</code>是否有<code>0</code>出现，我们可以通过如下方式添加：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># add_cover_point是等价</span>
</span></span><span style=display:flex><span><span style=color:#111>g</span><span style=color:#f92672>.</span><span style=color:#111>add_watch_point</span><span style=color:#111>(</span><span style=color:#111>adder</span><span style=color:#f92672>.</span><span style=color:#111>io_cout</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#111>{</span><span style=color:#d88200>&#34;io_cout is 0&#34;</span><span style=color:#111>:</span> <span style=color:#111>fc</span><span style=color:#f92672>.</span><span style=color:#111>Eq</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)},</span>
</span></span><span style=display:flex><span>                  <span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;cover_point_1&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>在上述覆盖点中，需要观察的数据为<code>io_cout</code>引脚，<strong>覆盖仓（Cover bin）</strong>的名称为<code>io_cout is 0</code>，覆盖点名称为<code>cover_point_1</code>。函数<code>add_watch_point</code>的参数说明如下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>add_watch_point</span><span style=color:#111>(</span><span style=color:#111>target</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>bins</span><span style=color:#111>:</span> <span style=color:#111>dict</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#111>name</span><span style=color:#111>:</span> <span style=color:#111>str</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span> <span style=color:#111>once</span><span style=color:#f92672>=</span><span style=color:#00a8c8>None</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#d88200>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#d88200>        @param target: 检查目标，可以是一个引脚，也可以是一个DUT对象
</span></span></span><span style=display:flex><span><span style=color:#d88200>        @param bins: 覆盖仓，dict格式，key为条件名称，value为具体检查方法或者检查方法的数组。
</span></span></span><span style=display:flex><span><span style=color:#d88200>        @param name: 覆盖点名称
</span></span></span><span style=display:flex><span><span style=color:#d88200>        @param once，如果once=True，表明只检查一次，一旦该覆盖点满足要求后就不再进行重复条件判断。
</span></span></span></code></pre></div><p>通常情况下，<code>target</code>为<code>DUT</code>引脚，<code>bins</code>中的检查函数来检查<code>target</code>的<code>value</code>是否满足预定义条件。<code>funcov</code>模块内存了部分检查函数，例如<code>Eq(x), Gt(x), Lt(x), Ge(x), Le(x), Ne(x), In(list), NotIn(list), isInRange([low,high])</code>等。当内置检查函数不满足要求时，也可以自定义，例如需要跨时钟周期进行检查等。自定义检查函数的输入参数为<code>target</code>，返回值为<code>bool</code>。例如：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>g</span><span style=color:#f92672>.</span><span style=color:#111>add_watch_point</span><span style=color:#111>(</span><span style=color:#111>adder</span><span style=color:#f92672>.</span><span style=color:#111>io_cout</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#d88200>&#34;io_cout is 0&#34;</span><span style=color:#111>:</span> <span style=color:#00a8c8>lambda</span> <span style=color:#111>x</span><span style=color:#111>:</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#d88200>&#34;io_cout is 1&#34;</span><span style=color:#111>:</span> <span style=color:#00a8c8>lambda</span> <span style=color:#111>x</span><span style=color:#111>:</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>                    <span style=color:#d88200>&#34;io_cout is x&#34;</span><span style=color:#111>:</span> <span style=color:#111>fc</span><span style=color:#f92672>.</span><span style=color:#111>Eq</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e># 注：zx态，vcs后端支持，verilator不支持</span>
</span></span><span style=display:flex><span>                  <span style=color:#111>},</span>
</span></span><span style=display:flex><span>                  <span style=color:#111>name</span><span style=color:#f92672>=</span><span style=color:#d88200>&#34;cover_point_1&#34;</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>当添加完所有的覆盖点后，需要在<code>DUT</code>的<code>Step</code>回调函数中调用<code>CovGroup</code>的<code>sample()</code>方法进行判断。在检查过程中，或者测试运行完后，可以通过<code>CovGroup</code>的<code>as_dict()</code>方法查看检查情况。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>StepRis</span><span style=color:#111>(</span><span style=color:#00a8c8>lambda</span> <span style=color:#111>x</span><span style=color:#111>:</span> <span style=color:#111>g</span><span style=color:#f92672>.</span><span style=color:#111>sample</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>g</span><span style=color:#f92672>.</span><span style=color:#111>as_dict</span><span style=color:#111>())</span>
</span></span></code></pre></div><h2 id=导出覆盖率文件>导出覆盖率文件</h2><p>在测试<code>case</code>每次运行结束时，可以通过<code>set_func_coverage(request, cov_groups)</code>告诉框架对所有的功能覆盖情况进行合并收集。相同名字的<code>CoverGroup</code>会被自动合并。</p><p>下面是一个简单的例子，通过<code>pytest . -sv</code>运行：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>pytest</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>toffee.funcov</span> <span style=color:#00a8c8>as</span> <span style=color:#111>fc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>toffee_test.reporter</span> <span style=color:#f92672>import</span> <span style=color:#111>set_func_coverage</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>g</span> <span style=color:#f92672>=</span> <span style=color:#111>fc</span><span style=color:#f92672>.</span><span style=color:#111>CovGroup</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Group X&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>init_function_coverage</span><span style=color:#111>(</span><span style=color:#111>g</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># add your points here</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>@pytest.fixture</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>dut_input</span><span style=color:#111>(</span><span style=color:#111>request</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># before test</span>
</span></span><span style=display:flex><span>    <span style=color:#111>init_function_coverage</span><span style=color:#111>(</span><span style=color:#111>g</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span> <span style=color:#f92672>=</span> <span style=color:#111>DUT</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>InitClock</span><span style=color:#111>(</span><span style=color:#d88200>&#34;clock&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>StepRis</span><span style=color:#111>(</span><span style=color:#00a8c8>lambda</span> <span style=color:#111>x</span><span style=color:#111>:</span> <span style=color:#111>g</span><span style=color:#f92672>.</span><span style=color:#111>sample</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>yield</span> <span style=color:#111>dut</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># after test</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dut</span><span style=color:#f92672>.</span><span style=color:#111>Finish</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>set_func_coverage</span><span style=color:#111>(</span><span style=color:#111>request</span><span style=color:#111>,</span> <span style=color:#111>g</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>g</span><span style=color:#f92672>.</span><span style=color:#111>clear</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_case1</span><span style=color:#111>(</span><span style=color:#111>dut_input</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>assert</span> <span style=color:#00a8c8>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_case2</span><span style=color:#111>(</span><span style=color:#111>dut_input</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>assert</span> <span style=color:#00a8c8>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div><p>在上述例子中，每个<code>case</code>都会通过<code>dut_input</code>函数来创建输入参数。该函数用<code>yield</code>返回<code>dut</code>，在运行<code>case</code>前初始化<code>dut</code>，并且设置在<code>dut</code>的<code>step</code>回调中执行<code>g.sample()</code>。运行完<code>case</code>后，调用<code>set_func_coverage</code>收集覆盖率，然后清空收集的信息。在仿真结束后，会生成一个<code>V{DUT_NAME}.dat</code>文件。</p><h2 id=生成报告并查看>生成报告并查看</h2><p>如果我们想生成并查看报告，可以在运行命令后添加<code>--toffee-report</code>，会自动生成可视化的报告。</p><hr><h1 id=高级功能简介>高级功能简介</h1><p>XData 和 XClock 的全部功能，可以查看<a href=https://open-verify.cc/mlvp/docs/env_usage/picker_usage/>工具介绍</a></p><p>Picker 还提供了一些高级功能，能够满足更复杂的验证需求，譬如多实例和多时钟。</p><p>但是这里不会展开详细讲解，感兴趣可以查阅：</p><ul><li><p>开放验证平台学习资源：https://open-verify.cc/mlvp/docs/env_usage/</p></li><li><p>picker 的 API 文档：https://github.com/XS-MLVP/picker/blob/master/doc/API.zh.md</p></li></ul><p>如果你想查看更多的例子，picker 的仓库也提供了一些示例：https://github.com/XS-MLVP/picker/tree/master/example</p><hr><h1 id=picker-的命令参数>Picker 的命令参数</h1><p>Picker 命令遵循以下基本结构：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>picker [全局选项] &lt;子命令&gt; [子命令选项] &lt;文件...&gt;
</span></span></code></pre></div><p>主要子命令包括：</p><ul><li><p><code>export</code>：将 RTL 项目源代码导出为软件库（如 C++/Python）</p></li><li><p><code>pack</code>：将 UVM 事务打包为 UVM 代理和 Python 类。但这里不会展开介绍，如果感兴趣请查阅文档。</p></li></ul><h2 id=全局选项参数>全局选项参数</h2><p>Picker 的全局选项用于获取帮助信息、查看版本以及定位各种库文件路径。这些选项可以在不指定子命令的情况下直接使用。</p><h3 id=基本帮助和版本选项>基本帮助和版本选项</h3><p><code>-h, --help</code>：打印帮助信息并退出。这是了解 Picker 基本用法的首选选项。</p><p><code>-v, --version</code>：显示 Picker 的版本号。在报告问题或确认兼容性时非常有用。</p><p><code>--check</code>：检查安装位置和支持的语言。这个选项可以帮助您验证 Picker 的安装状态和当前环境支持的所有语言。</p><img src=./assets/picker-help.png style=width:80%><h3 id=路径查询选项>路径查询选项</h3><p>以下选项用于查询 Picker 相关的各种路径信息，对于自定义开发和调试非常有用：</p><p><code>--show_default_template_path</code>：显示默认模板路径。当需要自定义生成代码的模板时，这个选项可以帮助您找到原始模板文件的位置。</p><p><code>--show_xcom_lib_location_cpp</code>：显示 C++版本 xspcomm 库和头文件的位置。在手动集成 C++项目时使用。</p><p><code>--show_xcom_lib_location_java</code>：显示 Java 版本 xspcomm-java.jar 的位置。在 Java 项目中使用 Picker 生成的代码时需要。</p><p><code>--show_xcom_lib_location_scala</code>：显示 Scala 版本 xspcomm-scala.jar 的位置。用于 Scala 项目集成。</p><p><code>--show_xcom_lib_location_python</code>：显示 Python 模块 xspcomm 的位置。在自定义 Python 环境中使用时很有帮助。</p><p><code>--show_xcom_lib_location_golang</code>：显示 Go 语言模块 xspcomm 的位置。用于 Go 项目集成。</p><p><code>--show_xcom_lib_location_lua</code>：显示 Lua 模块 xspcomm 的位置。在 Lua 环境中使用 Picker 生成的代码时需要。</p><img src=./assets/picker-check.png style=30%><h2 id=export-子命令常用参数><code>export</code> 子命令常用参数</h2><p><code>export</code>是最常用的子命令，用于生成 DUT 接口。以下是其关键参数的详细解释：</p><h3 id=必要参数>必要参数</h3><p><code>file</code>：指定 DUT 的顶层。v/.sv 源文件，必须包含顶层模块。这是唯一的必需参数。</p><h3 id=输入文件相关参数>输入文件相关参数</h3><p><code>--fs, --filelist</code>：指定 DUT 的.v/.sv 源文件列表，可以用逗号分隔或使用。txt 文件（每行一个 RTL 文件路径）。当设计包含多个文件时非常有用。</p><p><code>--sname, --source_module_name</code>：指定要处理的 RTL 模块名称。默认情况下，Picker 会选择用<code>-f</code>标记文件中的最后一个模块作为顶层模块。</p><p><code>--internal</code>：导出内部信号配置文件路径。默认为空，表示不导出内部引脚。当需要访问 DUT 内部信号时使用。</p><h3 id=输出控制参数>输出控制参数</h3><p><code>--lang, --language</code>：构建目标项目的语言，默认为 python。支持的选项包括 python/cpp/java/scala/golang/lua。</p><p><code>--tname, --target_module_name</code>：设置目标 DUT 的模块名和文件名。默认与源模块名相同。例如，使用<code>--tname top</code>将生成 UTtop.cpp 和 UTtop.hpp 文件，包含 UTtop 类。</p><p><code>--tdir, --target_dir</code>：存储所有结果的目标目录。如果以&rsquo;/&lsquo;结尾或为空，目录名将与目标模块名相同。</p><p><code>--sim</code>：选择仿真器，支持 vcs 或 verilator。默认为 verilator。</p><p><code>--e, --example</code>：是否构建示例项目，默认为 OFF。启用此选项会生成基本的使用示例。</p><p><code>--autobuild</code>：是否自动构建生成的项目，默认为 true。设置为 false 可以只生成文件而不编译。</p><h3 id=仿真功能参数>仿真功能参数</h3><p><code>--w, --wave_file_name</code>：波形文件名，为空表示不导出波形。指定文件名将启用波形记录功能。</p><p><code>--c, --coverage</code>：是否启用覆盖率收集，默认为 OFF。启用后可以生成覆盖率报告。</p><p><code>--checkpoints</code>：是否启用覆盖点（保存/恢复功能），默认为 OFF。启用后可以保存和恢复仿真状态。</p><p><code>--vpi</code>：是否启用 VPI（用于灵活访问内部信号），默认为 OFF。VPI 提供了更灵活的信号访问方式。</p><p><code>--F, --frequency</code>：设置<strong>仅 VCS</strong>的 DUT 频率，默认为 100MHz。单位可以是 Hz/KHz/MHz/GHz。</p><h3 id=编译选项参数>编译选项参数</h3><p><code>-V, --vflag</code>：传递给仿真器的用户自定义编译参数。例如<code>-V '-x-assign;fast;-Wall;--trace'</code>。</p><p><code>-C, --cflag</code>：用户自定义的 gcc/clang 编译命令，直接传递给编译器。例如<code>-C '-O3;-std;c++17;-I./include'</code>。</p><p><code>--verbose</code>：是否启用详细输出模式，默认为 OFF。启用后会显示更多调试信息。</p><hr><h1 id=练习>练习</h1><p>本讲的练习已经发布在新手任务中，请查阅<a href=/beginner/task/picker/>学习任务1: Picker 部分</a>。</p></div></div></div><div class="container mb-5"></div><div class=container><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-3"></div></div></div><script src=/js/bootstrap.min.js></script><script src=/js/jquery.min.js></script><script src=/js/isotope.pkgd.min.js></script><script src=/js/masonry.pkgd.min.js async></script><script src=/js/dark.js></script><script>var savedTheme=localStorage.getItem("dark-mode-storage")||"light";setTheme(savedTheme)</script><script src=/js/isotope.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script></body></html>