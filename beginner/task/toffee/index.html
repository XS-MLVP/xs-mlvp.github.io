<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4Z2ZY6ZE84")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&family=Frank+Ruhl+Libre:wght@200;300;400;500;600&family=Encode+Sans+Semi+Condensed:wght@400&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href=/css/bootstrap.min.css><link rel=stylesheet type=text/css href=/css/all.min.css><link disabled id=dark-mode-theme rel=stylesheet href=/css/dark.css><link rel=stylesheet type=text/css href=/css/style.css><link rel=stylesheet type=text/css href=/css/my_style.css><title>万众一芯开放验证 | 学习任务2: Toffee 部分</title>
<meta name=description content="用 Toffee 搭建验证环境"></head><body style=width:100%;max-width:100%;margin:0;padding:0><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="d-flex justify-content-between align-items-center" style=width:100%><div class="d-flex align-items-center"><a class="navbar-brand navbar-brand-content" href=https://open-verify.cc/cn><img src=/images/logo.png></a><div class="collapse navbar-collapse" id=navbarNavDropdown><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class=nav-link href=/registration_portal/>报名入口汇总</a></li><li class=nav-item><a class=nav-link href=/learningresource/>学习资源</a></li><li class=nav-item><a class=nav-link href=/about/>关于我们</a></li></ul></div></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNavDropdown aria-controls=navbarNavDropdown aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" style=flex:1><ul class="navbar-nav ms-auto mt-2 mt-lg-0"><li class=nav-item><a class="btn fas fa-moon" id=dark-mode-toggle></a></li></ul></div></div></nav><div id=content><div class=container><div class="py-4 rounded-3"><div class="container-fluid py-2"><h1 class="display-2 mb-4 text-center">学习任务2: Toffee 部分</h1></div><p class="text-center fs-4 fst-italic serif">用 Toffee 搭建验证环境</p><div class="text-center pt-4"></div></div><div class="row justify-content-center mb-5"><div class=col-12><p class="card-date m-0">Created Jul 22, 2025 -
Last updated: Jul 22, 2025</p><hr class=dropdown-divider><div class="row justify-content-between"><div class=col-sm-4></div><div class=col-sm-8 style=text-align:right></div></div></div></div><div class="container-fluid py-2 content"><div class="serif main-content"><h2 id=1-用-toffee-test-管理测试用例>1. 用 toffee-test 管理测试用例</h2><h3 id=准备工作>准备工作</h3><p>在根目录下创建<code>pyproject.toml</code>文件，内容为：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#111>[</span><span style=color:#75af00>tool</span><span style=color:#111>.</span><span style=color:#75af00>pytest</span><span style=color:#111>.</span><span style=color:#75af00>ini_options</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span><span style=color:#75af00>pythonpath</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;./&#34;</span>
</span></span></code></pre></div><blockquote><p>如果你对<code>pyproject.toml</code>在这里的作用感到好奇，请阅读 <a href=https://docs.pytest.org/en/stable/explanation/goodpractices.html>https://docs.pytest.org/en/stable/explanation/goodpractices.html</a></p></blockquote><h3 id=练习内容>练习内容</h3><p>把先前编写的测试用例用 toffee-test 进行管理：</p><ol><li><p>创建<code>tests</code>文件夹</p></li><li><p>在<code>tests</code>文件夹下创建<code>test_smoke.py</code>文件，把先前编写的代码用 toffee-test 进行管理。</p></li></ol><h2 id=2-使用-bundle-封装-dut>2. 使用 Bundle 封装 DUT</h2><h3 id=准备工作-1>准备工作</h3><p>创建 <code>tests</code> 和 <code>bundle</code> 文件夹，在 bundle 文件夹下创建<code>__init__.py</code>文件，用于存放 Bundle 的代码；在 tests 文件夹下创建<code>test_smoke.py</code>文件，用于存放这次练习的验证代码。</p><h3 id=练习内容-1>练习内容</h3><p>本次练习中，需要创建指定的 Bundle 类对 DUT 进行封装，然后编写一些新的测试用例：</p><ol><li><p>封装 FIFO 的端口：</p><ul><li><p>创建 <code>WriteBundle</code> 类，包含写入相关的端口</p></li><li><p>创建 <code>ReadBundle</code> 类，包含读取相关的端口</p></li><li><p>创建 <code>InternalBundle</code> 类，用于封装 FIFO 内部状态信号</p></li></ul></li><li><p>为 <code>ReadBundle</code> 添加 <code>dequeue</code> 方法： 实现方法 <code>dequeue(self)</code>，该方法执行一次读取操作。</p></li><li><p>为 <code>WriteBundle</code> 添加<code>enqueue</code>方法：实现方法 <code>enqueue(self, data)</code>，该方法执行一次写入操作。</p></li><li><p>使用封装好的 Bundle 环境，按照先前的<code>test_smoke_dut</code>的测试过程，创建测试用例<code>test_bundle</code></p></li><li><p>使用封装好的 Bundle 环境，编写测试用例<code>test_full_empty</code>：</p><ul><li><p>先将 fifo 装满后，判断<code>full_o</code>信号是否为 1</p></li><li><p>再清空 fifo，判断<code>empty_o</code>信号是否为 1</p></li><li><p>执行清空 fifo 时，检查出队序列是否与入队序列一致</p></li></ul></li></ol><h2 id=3-使用-agent-进一步封装>3. 使用 Agent 进一步封装</h2><h3 id=准备工作-2>准备工作</h3><p>这次练习相关代码存放到<code>agent/__init__.py</code>中</p><h3 id=练习内容-2>练习内容</h3><p>本次练习需要给 DUT 编写一个 Agent，然后再利用写好的 Agent 构建一些测试用例：</p><ol><li><p>编写<code>FIFOAgent</code>类：</p><ul><li><p>初始化时接收 <code>ReadBundle</code> 、 <code>WriteBundle</code>和<code>InternalBundle</code>。</p></li><li><p>实现一个 <code>reset</code> 驱动方法，用于执行 FIFO 的复位操作。</p></li><li><p>将在 <code>Bundle</code> 层面实现的 <code>enqueue</code> 和 <code>dequeue</code> 方法包装成 <code>Agent</code> 的驱动方法。</p></li></ul></li><li><p>使用<code>FIFOAgent</code>封装好的参数，按照<code>test_smoke_dut</code>的测试过程，创建测试用例<code>test_agent</code></p></li><li><p>思考：回顾你在 <code>Bundle</code> 和 <code>Agent</code> 练习中实现的 <code>enqueue</code> 和 <code>dequeue</code> 方法。将这些操作逻辑放在 <code>Bundle</code> 层实现（作为 <code>Bundle</code> 的方法），然后在 <code>Agent</code> 层简单调用 <code>@driver_method</code> 包装一下是更合适，还是直接在 <code>Agent</code> 的 <code>@driver_method</code> 中编写完整的信号操作逻辑更合适？或者有其他更好的方式？为什么？（提示：考虑代码复用、职责分离、抽象层次）</p></li><li><p>思考：当我们把不同功能的输入封装为多个驱动函数之后，似乎每次只能串行一个驱动函数，对于多个功能同时输入的情况该怎么办呢？请阅读 toffee 文档中<a href=https://pytoffee.readthedocs.io/zh-cn/latest/cases/executor.html#id2>如何同时调用多个驱动函数</a>部分，探索<code>Executor</code>的基本用法，然后在 Agent 中完成对<strong>同时进行读写操作</strong>的封装。（提示：文档中<code>Env</code>不影响理解，后续会进行介绍）。</p></li></ol><h2 id=4-收集功能覆盖率>4. 收集功能覆盖率</h2><h3 id=准备工作-3>准备工作</h3><ul><li><p>确保你已经理解了同步 FIFO 的设计规范。</p></li><li><p>确保你的 FIFO Agent 和 Bundle 代码是可用 的。</p></li><li><p>创建一个 <code>coverage</code> 文件夹（或在你现有的 <code>env</code> 文件夹下），用于存放覆盖率模型定义代码 （例如，<code>fifo_coverage.py</code>）。</p></li></ul><h3 id=练习内容-3>练习内容</h3><p>收集功能覆盖率并进行分析：</p><ol><li><p><strong>拆分 SyncFIFO 功能点和测试点：</strong> 根据你对同步 FIFO 规格的理解（或参考标准 FIFO 行为），列出其关键功能点。例如：</p><ul><li><p>基本操作：成功写入、成功读取、无操作。</p></li><li><p>边界状态：FIFO 空时尝试读取、FIFO 满时尝试写入、FIFO 空时写入、FIFO 满时读取。</p></li><li><p>指针行为：写指针追上读指针（写满）、读指针追上写指针（读空）、指针回绕。</p></li><li><p>数据完整性：写入的数据与后续读出的数据一致。</p></li><li><p>复位行为：复位后 FIFO 应为空，指针复位。 对于每个功能点，思考需要哪些测试点（输入激励条件）来验证它，以及需要观察哪些信号（覆盖点）来确认功能点被覆盖。</p></li></ul></li><li><p><strong>编写 SyncFIFO 功能覆盖率模型：</strong></p><ul><li><p>为上述拆分出的功能点创建对应的 <code>CovGroup</code> 函数（例如 <code>get_cover_group_boundary_operations</code>）。</p></li><li><p>在每个 <code>CovGroup</code> 函数内部，使用 <code>add_watch_point</code> 添加覆盖点和 Bins 来衡量对应的测试点是否被覆盖。利用之前介绍的比较函数、检查函数、工厂函数+Enum 等技巧。</p></li><li><p>思考每个 <code>CovGroup</code> 应该采用哪种采样方式（周期性采样还是基于特定序列的手动采样），并在 fixture 中进行相应的设置。</p></li></ul></li><li><p><strong>查看报告并尝试提高功能覆盖率：</strong></p><ul><li><p>运行包含覆盖率收集的测试用例，并查看生成的覆盖率报告 （如果不熟悉，请查阅 Toffee 的文档或新手教程第三讲）</p></li><li><p>分析报告，找出未覆盖的 Bins</p></li><li><p>尝试添加新的测试用例来提高覆盖率，但不要求功能覆盖率达到 100%，有提升就行</p></li></ul></li></ol><h2 id=5-编写参考模型并打包验证环境>5. 编写参考模型并打包验证环境</h2><h3 id=准备工作-4>准备工作</h3><p>在<code>env</code>目录下创建<code>ref.py</code>，用于存放参考模型的代码</p><h3 id=练习内容-4>练习内容</h3><p>编写参考模型并打包验证环境：</p><ol><li><p>编写同步 FIFO 的参考模型，并集成到验证环境中</p></li><li><p>让功能覆盖率达到 100%</p></li></ol></div></div></div></div><script src=/js/bootstrap.min.js></script><script src=/js/jquery.min.js></script><script src=/js/isotope.pkgd.min.js></script><script src=/js/masonry.pkgd.min.js async></script><script src=/js/dark.js></script><script>var savedTheme=localStorage.getItem("dark-mode-storage")||"light";setTheme(savedTheme)</script><script src=/js/isotope.js></script><script src=/js/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose"})</script></body></html>