<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://xs-mlvp.github.io/UnityChipForXiangShan/docs/03_add_test/">
<link rel="alternate" type="application/rss&#43;xml" href="https://xs-mlvp.github.io/UnityChipForXiangShan/docs/03_add_test/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/UnityChipForXiangShan/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/UnityChipForXiangShan/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-192x192.png" sizes="192x192">

<title>添加测试 | 万众一芯之香山处理器</title>
<meta name="description" content="添加一个全新的 DUT 测试用例，需要完成以下三部分内容(本节以前端的ifu下的rvc_expander为例)：
添加编译脚本： 在scripts目录下使用python编写对应rtl的编译文件（例如build_ut_frontend_ifu_rvc_expander.py）。 构建测试环境： 在目录中创建目标测试 UT 目录（例如ut_frontend/ifu/rvc_expander）。如果有需要的话，可以在tools、comm等模块中添加该 DUT 测试需要的基础工具。 添加测试用例： 在测试 UT 目录，按PyTest 规范添加测试用例。 如果是在已有的 DUT 测试中增加内容，按原有目录结构添加即可。
如何通过 picker 和 toffee 库进行 Python 芯片验证，请参考：https://open-verify.cc/mlvp/docs
在测试时还需要关心以下内容：
UT 模块说明: 在添加的模块顶层文件夹中，添加README.md说明，具体格式和要求请参考模板。 代码覆盖率：代码覆盖率是芯片验证的重要指标，一般需需要覆盖目标 DUT 的所有代码。 功能覆盖率：功能覆盖率即目标功能验证完成了多少，一般需要达到 100%。 在后续的文档中，我们将继续以rvc_expander模块为例，详细说明上述过程。
*注：目录或文件名称需要合理，以便于能通过命名知晓其具体含义。">
<meta property="og:title" content="添加测试" />
<meta property="og:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://xs-mlvp.github.io/UnityChipForXiangShan/docs/03_add_test/" />
<meta itemprop="name" content="添加测试">
<meta itemprop="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="添加测试"/>
<meta name="twitter:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."/>
<link rel="preload" href="/UnityChipForXiangShan/scss/main.min.28dee116d76198cd41791ec8d9adf684b9621dd93c371caac3e05359925d5d62.css" as="style" integrity="sha256-KN7hFtdhmM1BeR7I2a32hLliHdk8Nxyqw&#43;BTWZJdXWI=" crossorigin="anonymous">
<link href="/UnityChipForXiangShan/scss/main.min.28dee116d76198cd41791ec8d9adf684b9621dd93c371caac3e05359925d5d62.css" rel="stylesheet" integrity="sha256-KN7hFtdhmM1BeR7I2a32hLliHdk8Nxyqw&#43;BTWZJdXWI=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/UnityChipForXiangShan/css/prism.css"/>

    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4Z2ZY6ZE84');
    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />

<script>
    $(document).ready(function() {
        $('a[name="multi-lang-toggle"]').on('click', function(event) {
            var language = $(this).attr('lang');
            var codeDiv = $(this).closest('.highlight');
            var preNodes = codeDiv.find('pre');
            preNodes.each(function(index, preNode) {
                if ($(preNode).attr("name").toLowerCase().indexOf(language.toLowerCase()) !== -1) {
                    preNode.style.display = 'block';
                } else {
                    preNode.style.display = 'none';
                }
            });
            var alist = codeDiv.find('a[name="multi-lang-toggle"]');
            alist.each(function(index, aNode) {
                if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                    aNode.style.fontWeight = 'bold';
                } else {
                    aNode.style.fontWeight = 'normal';
                }
            });
        })
        $(this).find('pre[name^="group-lang-code-"]').each(function(index, preNode) {
            if (preNode.style.display !== 'none') {
                var language = $(preNode).attr("name").replace('group-lang-code-', '');
                var alist = $(this).closest('.highlight').find('a[name="multi-lang-toggle"]');
                alist.each(function(index, aNode) {
                    if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                        aNode.style.fontWeight = 'bold';
                    } else {
                        aNode.style.fontWeight = 'normal';
                    }
                });
            }
        });
    });
</script>
    
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/UnityChipForXiangShan/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">万众一芯之香山处理器</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/UnityChipForXiangShan/en/">English</a></li>
    </ul>
</div></li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="站内搜索…"
    aria-label="站内搜索…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/UnityChipForXiangShan/offline-search-index.1281e6474dc839eac243a5b8d2959149.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/UnityChipForXiangShan/docs/03_add_test/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">添加测试</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-dbf9b443ff7a2ae1b419d7f271fac95a">添加编译脚本</a></li>


    
  
    
    
	
<li>2: <a href="#pg-53f38485d7ee0ef1d06f36fbe61bda5b">构建测试环境</a></li>


    
  
    
    
	
<li>3: <a href="#pg-4cd74e2d3f7d9b1031b77dd328511afa">添加测试用例</a></li>


    
  
    
    
	
<li>4: <a href="#pg-c6c51e44e9add2a2d66a22a310fc796b">代码覆盖率</a></li>


    
  
    
    
	
<li>5: <a href="#pg-f2938880e10d36d978ade908698b9760">功能覆盖率</a></li>


    
  

    </ul>


<div class="content">
      <p>添加一个全新的 DUT 测试用例，需要完成以下三部分内容(本节以前端的<code>ifu</code>下的<code>rvc_expander</code>为例)：</p>
<ol>
<li><strong>添加编译脚本</strong>： 在<code>scripts</code>目录下使用<code>python</code>编写对应<code>rtl</code>的编译文件（例如<code>build_ut_frontend_ifu_rvc_expander.py</code>）。</li>
<li><strong>构建测试环境</strong>： 在目录中创建目标测试 UT 目录（例如<code>ut_frontend/ifu/rvc_expander</code>）。如果有需要的话，可以在<code>tools、comm</code>等模块中添加该 DUT 测试需要的基础工具。</li>
<li><strong>添加测试用例</strong>： 在测试 UT 目录，按<a href="https://docs.pytest.org/en/stable/">PyTest 规范</a>添加测试用例。</li>
</ol>
<p>如果是在已有的 DUT 测试中增加内容，按原有目录结构添加即可。</p>
<p>如何通过 picker 和 toffee 库进行 Python 芯片验证，请参考：<a href="https://open-verify.cc/mlvp/docs">https://open-verify.cc/mlvp/docs</a></p>
<p>在测试时还需要关心以下内容：</p>
<ol>
<li><strong>UT 模块说明</strong>: 在添加的模块顶层文件夹中，添加<code>README.md</code>说明，具体格式和要求请参考<a href="https://open-verify.cc/UnityChipForXiangShan/docs/10_template_ut_readme/">模板</a>。</li>
<li><strong>代码覆盖率</strong>：代码覆盖率是芯片验证的重要指标，一般需需要覆盖目标 DUT 的所有代码。</li>
<li><strong>功能覆盖率</strong>：功能覆盖率即目标功能验证完成了多少，一般需要达到 100%。</li>
</ol>
<p>在后续的文档中，我们将继续以<code>rvc_expander</code>模块为例，详细说明上述过程。</p>
<p>*注：目录或文件名称需要合理，以便于能通过命名知晓其具体含义。</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dbf9b443ff7a2ae1b419d7f271fac95a">1 - 添加编译脚本</h1>
    
	<h2 id="脚本目标">脚本目标</h2>
<p>在<code>scripts</code>目录下使用python编写对应rtl的编译文件（例如<code>build_ut_frontend_ifu_rvc_expander.py</code>）。<br>
该脚本的目标是提供 RTL 到 Python DUT 的编译、目标覆盖文件，以及自定义功能等内容。</p>
<h2 id="创建过程">创建过程</h2>
<h3 id="确定文件名称">确定文件名称</h3>
<p>在<a href="/UnityChipForXiangShan/">香山昆明湖 DUT 验证进展</a>中选择需要验证的 UT，如果没有或者进一步细化，可通过编辑<code>configs/dutree/xiangshan-kmh.yaml</code>自行添加。<br>
比如，我们要验证的是前端部分的<code>ifu</code>模块下的<code>rvc_expander</code>模块，那么需要在<code>configs/dutree/xiangshan-kmh.yaml</code>中添加对应的部分（目前yaml中已经有该模块了，此处为举例）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kmh_dut&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;所有昆明湖DUT&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;frontend&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;前端模块&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ifu&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;指令单元 (Instruction Fetch Unit)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;rvc_expander&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;RVC指令扩充器&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>脚本文件的命名格式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scripts/build_&lt;顶层模块&gt;_&lt;下层模块名&gt;_..._&lt;目标模块名&gt;.py
</span></span></code></pre></div><p>目前本项目内置了 4 个顶层模块：</p>
<ol>
<li>ut_frontend 前端</li>
<li>ut_backend 后端</li>
<li>ut_mem_block 访存</li>
<li>ut_misc 其他</li>
</ol>
<p>其中的子模块没有<code>ut_</code>前缀（顶层目录有该前缀是为了和其他目录区分开）。</p>
<p>例如验证目标 DUT 为<code>rvc_expander</code>模块：<br>
该模块是属于前端的，所以顶级模块为<code>ut_frontend</code>，它的下层模块为<code>ifu</code>，目标模块为<code>rvc_expander</code>。<br>
通过刚才我们打开的<code>yaml</code>文件也可以知道，<code>frontend</code>的children 为<code>ifu</code>，<code>ifu</code>的children 为<code>rvc_expander</code>。 <br>
所以，需要创建的脚本名称为<code>build_ut_frontend_ifu_rvc_expander.py</code>。</p>
<h3 id="编写-buildcfg---bool-函数">编写 build(cfg) -&gt; bool 函数</h3>
<p>build 函数定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">bool</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;编译DUT
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        cfg: 运行时配置，可通过它访问配置项，例如 cfg.rtl.version
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Return:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        返回 True 或者 False，表明该函数是否完成预期目标
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>build 在 make dut 时会被调用，其主要是将目标 RTL 转换为 Python 模块。在该过程中也可以加入其他必要过程，例如编译依赖项等。以<code>build_ut_frontend_ifu_rvc_expander.py</code>为例，主要完成了 RTL 检查、DUT 检查、RTL 编译、disasm 依赖编译等工作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">os</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">info</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># import 相关依赖</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee_test.markers</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">match_version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">is_all_file_exist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_root_dir</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 检查RTL版本（version参数为空，表示所有版本都支持）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">match_version</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rtl</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;openxiangshan-kmh-*&#34;</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ifu frontend rvc expander: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Unsupported RTL version </span><span style="color:#4e9a06">{</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rtl</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 检查在当前RTL中，目标文件是否存在</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">is_all_file_exist</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;rtl/RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">f</span> <span style="color:#204a87;font-weight:bold">is</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;File </span><span style="color:#4e9a06">{</span><span style="color:#000">f</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> not found&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果dut中不存在RVCExpander，则调用picker进行Python打包</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut/RVCExpander&#34;</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exporting RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#39;picker export --cp_lib false </span><span style="color:#4e9a06">{</span><span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rtl/RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> --lang python --tdir </span><span style="color:#4e9a06">{</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/ -w rvc.fst -c&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to export RVCExpander.sv: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果tools中不存在disasm/build，则需要编译disasm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tools/disasm/build&#34;</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Building disasm&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;make -C </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tools/disasm&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to build disasm&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 编译成功</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">line_coverage_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;RVCExpander.v&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>picker 的使用方式请参考其<a href="https://github.com/XS-MLVP/picker/blob/master/README.zh.md">文档</a>和<a href="https://open-verify.cc/mlvp/docs/env_usage/picker_usage/">使用</a></p>
<p>在<code>scripts</code>目录中可以创建子目录保存 UT 验证需要的文件，例如 rvc_expander 模块创建了<code>scripts/frontend_ifu_rvc_expander</code>目录，其中的<code>rtl_file.f</code>用来指定输入的 RTL 文件，<code>line_coverage.ignore</code>用来保存需要忽略的代码行统计。自定义目录的命名需要合理，且能通过名字判断其所属模块和文件。</p>
<h3 id="编写-line_coverage_filescfg---liststr-函数">编写 line_coverage_files(cfg) -&gt; list[str] 函数</h3>
<p>line_coverage_files 函数的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">line_coverage_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;指定需要覆盖的文件
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        cfg: 运行时配置，可通过它访问配置项，例如 cfg.rtl.version
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Return:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        返回统计代码行覆盖率的目标RTL文件名
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>在<code>build_ut_frontend_ifu_rvc_expander.py</code>文件中，<code>line_coverage_files</code>函数的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">line_coverage_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;RVCExpander.v&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>标识该模块关注的是对<code>RVCExpander.v</code>文件的覆盖。如果要开启测试结果处理，还需要在<code>configs/_default.yaml</code>中的<code>doc-result</code>下<code>disable=False</code>（默认参数是<code>False</code>，也就是开启状态）;如果不开启测试结果处理则(<code>disable = True</code>)。注意，如果不开启测试结果处理，那么上述函数就不会被调用。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-53f38485d7ee0ef1d06f36fbe61bda5b">2 - 构建测试环境</h1>
    
	<h2 id="确定目录结构">确定目录结构</h2>
<p>UT(Unit Test, 单元测试)所在的目录位置的层级结构应该与名称一致，例如<code>frontend.ifu.rvc_expander</code>应当位于<code>ut_frontend/ifu/rvc_expander</code>目录，且每层目录都需要有<code>__init__.py</code>，便于通过 python 进行<code>import</code>。</p>
<p><strong>本章节的文件为<code>your_module_wrapper.py</code></strong>（如果你的模块是<code>rvc_expander</code>，那么文件就是<code>rvc_expander_wrapper.py</code>）。</p>
<p>wrapper 是包装的意思，也就是我们测试中需要用到的方法封装成和dut解耦合的API提供给测试用例使用。</p>
<p>*注：解耦合是为了测试用例和 DUT 解耦，使得测试用例可以独立于 DUT 进行编写和调试，也就是在测试用例中，不需要知道 DUT 的具体实现细节，只需要知道如何使用 API 即可。可以参照<a href="https://open-verify.cc/mlvp/docs/mlvp/canonical_env/#%E5%B0%86%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81%E4%B8%8Edut%E8%BF%9B%E8%A1%8C%E8%A7%A3%E8%80%A6">将验证代码与DUT进行解耦</a></p>
<p>该文件应该放于<code>ut_frontend_or_backend/top_module/your_module/env</code>（这里依然以<code>rvc_expander</code>举例：<code>rvc_expander</code>属于前端，其顶层目录则应该是<code>ut_frontend</code>；<code>rvc_expander</code>的顶层模块是<code>ifu</code>，那么次级目录就是<code>ifu</code>;之后的就是<code>rvc_expander</code>自己了；最后，由于我们是在<strong>构建测试环境</strong>，再建一级<code>env</code>目录。将它们连起来就是：<code>ut_frontend_or_backend/top_module/your_module/env</code>）目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ut_frontend/ifu/rvc_expander
</span></span><span style="display:flex;"><span>├── classical_version
</span></span><span style="display:flex;"><span>│   ├── env
</span></span><span style="display:flex;"><span>│   │   ├── __init__.py
</span></span><span style="display:flex;"><span>│   │   └── rvc_expander_wrapper.py
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   └── test_rvc_expander.py
</span></span><span style="display:flex;"><span>├── __init__.py
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>└── toffee_version
</span></span><span style="display:flex;"><span>    ├── agent
</span></span><span style="display:flex;"><span>    │   └── __init__.py
</span></span><span style="display:flex;"><span>    ├── bundle
</span></span><span style="display:flex;"><span>    │   └── __init__.py
</span></span><span style="display:flex;"><span>    ├── env
</span></span><span style="display:flex;"><span>    │   ├── __init__.py
</span></span><span style="display:flex;"><span>    │   └── ref_rvc_expand.py
</span></span><span style="display:flex;"><span>    ├── __init__.py
</span></span><span style="display:flex;"><span>    └── <span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>        ├── __init__.py
</span></span><span style="display:flex;"><span>        ├── rvc_expander_fixture.py
</span></span><span style="display:flex;"><span>        └── test_rvc.py
</span></span></code></pre></div><p>这里<code>rvc_expander</code>目录下有<code>classical_version</code>传统版本和<code>toffee_version</code>使用toffee的版本。
传统版本就是使用<code>pytest</code>框架来进行测试，<code>toffee</code>只使用了其<code>Bundle</code>;而在toffee版本中，我们会使用更多<code>toffee</code>的特性。      <br>
一般来说，<strong>使用传统版本就已经可以覆盖绝大多数情况了</strong>，只有在传统版本不能满足需求时，才需要使用<code>toffee</code>版本。<br>
编写测试环境的时候，<strong>两个版本选择一个就行</strong>。<br>
模块（例如<code>rvc_expander</code>）中的代码目录结构由贡献者自行决定（我们写的时候并<strong>不需要再建一级<code>classical_version</code>或<code>toffee_version</code>目录</strong>），但需要满足 python 规范，且逻辑和命名合理。</p>
<h2 id="env-编写要求">Env 编写要求</h2>
<ul>
<li>需要进行 RTL 版本检查</li>
<li>Env 提供的 API 需要和引脚、时序无关</li>
<li>Env 提供的 API 需要稳定，不能随意进行接口/返回值修改</li>
<li>需要定义必要的 fixture</li>
<li>需要初始化功能检查点（功能检查点可以独立成一个模块）</li>
<li>需要进行覆盖率统计</li>
<li>需要有说明文档</li>
</ul>
<h2 id="编写测试环境传统版本">编写测试环境：传统版本</h2>
<p>在 UT 验证模块的测试环境中，目标是完成以下工作：</p>
<ol>
<li>对 DUT 进行功能封装，为测试提供稳定 API</li>
<li>定义功能覆盖率</li>
<li>定义必要 fixture 提供给测试用例</li>
<li>在合理时刻统计覆盖率</li>
</ol>
<p>以 IFU 环境中的 RVCExpander 为例（<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>）：</p>
<h3 id="1-dut-封装">1. DUT 封装</h3>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cover_group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cover_group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cover_group</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTRVCExpander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 创建DUT</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 通过 Bundle 使用前缀关联引脚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>                 <span style="color:#8f5902;font-style:italic"># 把 Bundle 与 DUT 进行绑定</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instr</span>         <span style="color:#8f5902;font-style:italic"># 给DUT引脚赋值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;fsIsOff&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fsIsOff</span>  <span style="color:#8f5902;font-style:italic"># 给DUT引脚赋值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RefreshComb</span><span style="color:#000;font-weight:bold">()</span>              <span style="color:#8f5902;font-style:italic"># 推动组合电路</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cover_group</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>           <span style="color:#8f5902;font-style:italic"># 调用sample对功能覆盖率进行统计</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_bits&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ill&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>  <span style="color:#8f5902;font-style:italic"># 返回结果 和 是否是非法指令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>                         <span style="color:#8f5902;font-style:italic"># 获取当前状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;instr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#8f5902;font-style:italic"># 输入指令</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;decode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_bits&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic"># 返回展开结果</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ill&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic"># 输入是否非法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上述例子中，<code>class RVCExpander</code>对<code>DUTRVCExpander</code>进行了封装，对外提供了两个 API：</p>
<ul>
<li>expand(instr: int, fsIsOff: bool) -&gt; (int, int) ：该函数用于接受输入指令 instr 进行解码，返回（结果，非法指令标记）。如果非法指令标记不为 0，者说明输入指令非法。</li>
<li>stat() -&gt; dict(instr, decode, ilegal)：该函数用于返回当前的状态，其中包含当前的输入指令，解码结果以及非法指令标记。</li>
</ul>
<p>上述 API <strong>屏蔽了 DUT 的引脚</strong>，对外程序通用功能。</p>
<h3 id="2-定义功能覆盖率">2. 定义功能覆盖率</h3>
<p>尽可能的在 Env 中定义好功能覆盖率，如果有必要也可以在测试用例中定义覆盖率。toffee 功能覆盖率的定义请参考<a href="http://localhost:1313/docs/03_add_test/05_cover_func/">什么是功能覆盖率</a>。为了完善功能检查点和测试用例之间的对应关系，功能覆盖率定义完成后，需要在适合的位置进行检查点和测试用例的对应（测试点反标）。</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee.funcov</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">fc</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建功能覆盖率组</span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UT_FCOV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;../../../CLASSIC&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Add watch points to the RVCExpander module to collect function coverage information&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 1. Add point RVC_EXPAND_RET to check expander return value:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin ERROR. The instruction is not illegal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin SUCCE. The instruction is not expanded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 5. Reverse mark function coverage to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_M</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># get the module name</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">module_name_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;../../test_rv_decode&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#  - mark RVC_EXPAND_RET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#000">_M</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;test_rvc_expand_16bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_randomN&#34;</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>在上述代码中添加了名为<code>RVC_EXPAND_RET</code>的功能检查点来检查<code>RVCExpander</code>模块是否具有返回非法指令的能力。需要满足<code>ERROR</code>和<code>SUCCE</code>两个条件，即<code>stat()</code>中的<code>ileage</code>需要有<code>True</code>也需要有<code>False</code>值。在定义完检查点后，通过<code>mark_function</code>方法，对会覆盖到该检查的测试用例进行了标记。</p>
<h3 id="3-定义必要fixture">3. 定义必要fixture</h3>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">version_check</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_version_checker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;openxiangshan-kmh-*&#34;</span><span style="color:#000;font-weight:bold">)</span>             <span style="color:#8f5902;font-style:italic"># 指定满足要的RTL版本</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">version_check</span><span style="color:#000;font-weight:bold">()</span>                                                    <span style="color:#8f5902;font-style:italic"># 进行版本检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span>                                          <span style="color:#8f5902;font-style:italic"># 获取调用该fixture的测试用例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wave_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/rvc_expander_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.fst&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#8f5902;font-style:italic"># 设置波形文件路径</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/rvc_expander_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.dat&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 设置代码覆盖率文件路径</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_dir</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dirname</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">makedirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coverage_dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist_ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>                           <span style="color:#8f5902;font-style:italic"># 目标目录不存在则创建目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">wave_file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                                                       <span style="color:#8f5902;font-style:italic"># 创建RVCExpander</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_in</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>                                    <span style="color:#8f5902;font-style:italic"># 设置io_in引脚的写入时机为立即写入             </span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_fsIsOff</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>                               <span style="color:#8f5902;font-style:italic"># 设置io_fsIsOff引脚的写入时机为立即写入  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>                              <span style="color:#8f5902;font-style:italic"># 初始化功能检查点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">expander</span>                                                     <span style="color:#8f5902;font-style:italic"># 返回创建好的 RVCExpander 给 Test Case</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>                                              <span style="color:#8f5902;font-style:italic"># Tests Case运行完成后，结束DUT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">)</span>                          <span style="color:#8f5902;font-style:italic"># 把生成的代码覆盖率文件告诉 toffee-report</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_func_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>                                      <span style="color:#8f5902;font-style:italic"># 把生成的功能覆盖率数据告诉 toffee-report</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">()</span>                                                          <span style="color:#8f5902;font-style:italic"># 清空功能覆盖统计</span>
</span></span></code></pre></div><p>上述 fixture 完成了以下功能：</p>
<ol>
<li>进行 RTL 版本检查，如果不满足<code>&quot;openxiangshan-kmh-*&quot;</code>要求，则跳过调用改 fixture 的测试用例</li>
<li>创建 DUT，并指定了波形，代码行覆盖率文件路径（路径中含有调用该 fixure 的用例名称：fname）</li>
<li>调用<code>init_rvc_expander_funcov</code>添加功能覆盖点</li>
<li>结束 DUT，处理代码行覆盖率和功能覆盖率（发往 toffee-report 进行处理）</li>
<li>清空功能覆盖率</li>
</ol>
<p>*注：在 PyTest 中，执行测试用例<code>test_A(rvc_expander, ....)</code>前（<strong>rvc_expander是我们在使用fixure装饰器时定义的方法名</strong>），会自动调用并执行<code>rvc_expander(request)</code>中<code>yield</code>关键字前的部分（相当于初始化），然后通过<code>yield</code>返回<code>rvc_expander</code>调用<code>test_A</code>用例（<strong>yield返回的对象，在测试用例里就是我们fixture下定义的方法名</strong>），用例执行完成后，再继续执行<code>fixture</code>中<code>yield</code>关键字之后的部分。比如：参照下面统计覆盖率的代码，倒数第四行的
<code>rvc_expand(rvc_expander, generate_rvc_instructions(start, end))</code>，其中的<code>rvc_expander</code>就是我们在<code>fixture</code>中定义的方法名，也就是<code>yield</code>返回的对象。</p>
<h3 id="4-统计覆盖率">4. 统计覆盖率</h3>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#000">T</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TAG_LONG_TIME_RUN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.parametrize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start,end&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#000;font-weight:bold">[(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)])</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with a full compressed instruction set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Description:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        Perform an expand check on 16-bit compressed instructions within the range from &#39;start&#39; to &#39;end&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Add check point: RVC_EXPAND_RANGE to check expander input range.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#   When run to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dynamic_bin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Reverse mark function to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Drive the expander and check the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">generate_rvc_instructions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># When go to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>                                                              <span style="color:#8f5902;font-style:italic"># 覆盖率采样</span>
</span></span></code></pre></div><p>在定义了覆盖率之后，还需要在测试用例中进行覆盖率统计。上述代码中，在测试用例中使用<code>add_watch_point</code>添加了一个功能检查点<code>rvc_expander</code>，并在后面进行了标记和采样,而且在最后一样对覆盖率进行了采样。
覆盖率采样，实际上是通过回调函数触发了一次<code>add_watch_point</code>中bins的判断，当其中bins的判断结果为<code>True</code>时，就会统计一次Pass。</p>
<h2 id="编写测试环境toffee版本">编写测试环境：toffee版本</h2>
<p>使用python语言进行的测试可以通过引入我们的开源测试框架<a href="https://github.com/XS-MLVP/toffee">toffee</a>来得到更好的支持。</p>
<p>toffee的官方教程可以参考<a href="https://open-verify.cc/mlvp/docs/mlvp/">这里</a>。</p>
<h3 id="bundle快捷dut封装">bundle：快捷DUT封装</h3>
<p>toffee通过Bundle实现了对DUT的绑定。toffee提供了多种建立Bundle与DUT绑定的方法。相关代码</p>
<h4 id="手动绑定">手动绑定</h4>
<p>toffee框架下，用于支持绑定引脚的最底层类是Signal，其通过命名匹配的方式和DUT中的各个引脚进行绑定。相关代码参照<code>ut_frontend/ifu/rvc_expander/toffee_version</code>。</p>
<p>以最简单的RVCExpander为例，其io引脚形如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">RVCExpander</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">input</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_in</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">input</span>         <span style="color:#000">io_fsIsOff</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_out_bits</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">output</span>        <span style="color:#000">io_ill</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>一共四个信号，io_in, io_fsIsOff, io_out_bits, io_ill。我们可以抽取共同的前缀，比如&quot;io_&quot;（不过由于in在python中有其他含义，其不能直接作为变量名，虽然可以使用setattr 和getattr方法来规避这个问题，但是出于代码简洁的考虑，我们只选取&quot;io&quot;作为前缀），将后续部分作为引脚名定义在对应的Bundle类中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpanderIOBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_fsIsOff</span> <span style="color:#000;font-weight:bold">,</span><span style="color:#000">_out_bits</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">_ill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>然后在更高一级的Env或者Bundle中，采取from_prefix的方式完成前缀的绑定：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpanderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RVCExpanderIOBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h4 id="自动定义bundle">自动定义Bundle</h4>
<p>实际上，Bundle类的定义也不一定需要写明，可以仅仅通过前缀绑定：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 通过 Bundle 使用前缀关联引脚</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>   
</span></span></code></pre></div><p>如果Bundle的from_prefix方法传入dut，其将根据前缀和DUT的引脚名自动生成引脚的定义，而在访问的时候，使用dict访问的思路即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instr</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;fsIsOff&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span></code></pre></div><h4 id="bundle代码生成">Bundle代码生成</h4>
<p>toffee框架的<a href="https://github.com/XS-MLVP/toffee/tree/master/scripts">scripts</a>提供了两个脚本。</p>
<p>bundle_code_gen.py脚本主要提供了三个方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_regex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">regex</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">):</span>
</span></span></code></pre></div><p>通过传入dut和生成规则（包括dict、prefix、regex三种），自动生成对应的bundle代码。</p>
<p>而bundle_code_intel_gen.py则解析picker生成的signals.json文件，自动生成层次化的bundle代码。可以直接在命令行调用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python bundle_code_intel_gen.py <span style="color:#ce5c00;font-weight:bold">[</span>signal<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>target<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>如发现自动生成脚本存在bug，欢迎提issue以便我们修正。</p>
<h3 id="agent驱动方法">Agent：驱动方法</h3>
<p>如果说Bundle是将DUT的数据职责进行抽象的话，那么Agent则是将DUT的行为职责封装为一个个接口。简单地说，Agent通过封装多个对外开放的方法，将多组IO操作抽象为一个具体的行为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpanderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">RVCExpanderIOBundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_method</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">):</span>             <span style="color:#8f5902;font-style:italic"># 传入参数：RVC指令和fs.status使能情况</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_in</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instr</span>                   <span style="color:#8f5902;font-style:italic"># 引脚赋值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_fsIsOff</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fsIsOff</span>            <span style="color:#8f5902;font-style:italic"># 引脚赋值</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">()</span>                        <span style="color:#8f5902;font-style:italic"># 推动时钟</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_out_bits</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic"># 返回值：扩展后指令</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_ill</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>                  <span style="color:#8f5902;font-style:italic"># 返回值：指令合法校验</span>
</span></span></code></pre></div><p>譬如，RVCExpander的指令扩展功能接收输入的指令（可能为RVI指令，也可能为RVC指令）和CSR对fs.status的使能情况。我们将这个功能抽象为expand方法，提供除self以外的两个参数。同时，指令扩展最终将会返回传入指令对应的RVI指令和该指令是否合法的判断，对应地，该方法也返回这两个值。</p>
<h3 id="env测试环境">Env：测试环境</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpanderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">DUTRVCExpander</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_in</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>        
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_fsIsOff</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>   <span style="color:#8f5902;font-style:italic"># 设置引脚写入时机</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpanderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RVCExpanderIOBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># 补全前缀，绑定DUT</span>
</span></span></code></pre></div><h3 id="覆盖率定义">覆盖率定义</h3>
<p>定义覆盖率组的方式和前述方式类似，这里就不再赘述了。</p>
<h3 id="测试套件定义">测试套件定义</h3>
<p>测试套件的定义略有不同：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@toffee_test.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toffee_request</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">toffee_test</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ToffeeRequest</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">asyncio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">version_check</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toffee_request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_dut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTRVCExpander</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">start_clock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee_request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_cov_groups</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">gr</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpanderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">expander</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cur_loop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_event_loop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">task</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">all_tasks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cur_loop</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__clock_loop&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">task</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CancelledError</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span>
</span></span></code></pre></div><p>由于toffee提供了更强大的测试覆盖率管理功能，因此不需要手动设置行覆盖率。同时，由于toffee的时钟机制，建议在套件代码最后额外检查任务是否全部结束。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4cd74e2d3f7d9b1031b77dd328511afa">3 - 添加测试用例</h1>
    
	<h2 id="命名要求">命名要求</h2>
<p>所有测试用例文件请以<code>test_*.py</code>的方式进行命名，<code>*</code>用测试目标替换（例如<code>test_rvc_expander.py</code>）。所有测试用例也需要以<code>test_</code>前缀开头。用例名称需要具有明确意义。</p>
<p>命名举例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_a</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#8f5902;font-style:italic"># 不合理，无法通过a判断测试目标</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#8f5902;font-style:italic"># 合理，可以通过用例名称大体知道测试内容</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><h2 id="使用-assert">使用 Assert</h2>
<p>在每个测试用例中，都需要通过<code>assert</code>来判断本测试是否通过。
<code>pytest</code>统计的是<code>assert</code>语句的结果，因此<code>assert</code>语句需要保证能够通过。</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_32bit</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;compare the RVC expand result with the reference
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        rvc_expander (warpper): the fixture of the RVC expander
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ref_insts (list[int]]): the reference instruction list
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">insn</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">disasmbly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rvc_expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is_32bit</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error, 32bit instruction need to be the same&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 1, dut: 0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">,disasm:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn_disasm</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 0, dut: 1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">find_error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error (</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06"> errros)&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">find_error</span>
</span></span></code></pre></div><h2 id="编写注释">编写注释</h2>
<p>每个测试用例都需要添加必要的说明和注释，需要满足<a href="https://peps.python.org/pep-0257/">Python 注释规范</a>。</p>
<p>测试用例说明参考格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">type_a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">type_b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test abstract
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        a (type_a): description of arg a.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        b (type_b): description of arg b.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Detailed test description here (if need).
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><h2 id="用例管理">用例管理</h2>
<p>为了方便测试用例管理，可通过 toffee-test 提供的<code>@pytest.mark.toffee_tags</code>标签功能，请参考
本网站的<a href="https://open-verify.cc/UnityChipForXiangShan/docs/98_others/">其他</a>部分和<a href="https://github.com/XS-MLVP/toffee-test/blob/master/README_zh.md#%E7%AE%A1%E7%90%86%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E8%B5%84%E6%BA%90">toffee-test</a>。</p>
<h2 id="参考用例">参考用例</h2>
<p>如果很多测试用例（Test）具有相同的操作，该公共操作部分可以提炼成一个通用函数。以 RVCExpander 验证为例，可以把压缩指令的展开与参考模型（disasm）的对比封装成以下函数：</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_32bit</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;compare the RVC expand result with the reference
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        rvc_expander (warpper): the fixture of the RVC expander
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ref_insts (list[int]]): the reference instruction list
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">insn</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">disasmbly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rvc_expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is_32bit</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error, 32bit instruction need to be the same&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 1, dut: 0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">,disasm:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn_disasm</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 0, dut: 1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">find_error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error (</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06"> errros)&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">find_error</span>
</span></span></code></pre></div><p>在上述公共部分中有 assert，因此调用该函数的 Test 也能提过该 assert 判断运行结果是否提过。</p>
<p>在测试用例的开发过程中，通常存在大量的调试工作，为了让验证环境快速就位，需要编写一些“冒烟测试”进行调试。RVCExpander 展开 16 位压缩指令的冒烟测试如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TAG_SMOKE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_smoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with 1 compressed instruction&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">generate_rvc_instructions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>为了方便进行管理，上述测试用例通过<code>toffee_tags</code>标记上了 SMOKE 标签。它的输入参数为<code>rvc_expander</code>，则在在运行时，会自动调用对应同名的<code>fixture</code>进行该参数的填充。</p>
<p>RVCExpander 展开 16 位压缩指令的测试目标是对 2^16 所有压缩指令进行遍历，检测所有情况是否都与参考模型 disasm 一致。在实现上，如果仅仅用一个 Test 进行遍历，则需要耗费大量时间，为此我们可以利用 PyTest 提供的<code>parametrize</code>对 test 进行参数化配置，然后通过<code>pytest-xdist</code>插件并行执行：</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#000">T</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TAG_LONG_TIME_RUN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.parametrize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start,end&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#000;font-weight:bold">[(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)])</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with a full compressed instruction set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Description:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        Perform an expand check on 16-bit compressed instructions within the range from &#39;start&#39; to &#39;end&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Add check point: RVC_EXPAND_RANGE to check expander input range.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#   When run to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Reverse mark function to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Drive the expander and check the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">generate_rvc_instructions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>在上述用例中定义了参数化参数<code>start</code>, <code>end</code>，用来指定压缩指令的开始值和结束值，然后通过装饰器<code>@pytest.mark.parametrize</code>对他们进行分组赋值。变量 N 可以指定将目标数据进行分组的组数，默认设置为 10 组。在运行时用例<code>test_rvc_expand_16bit_full</code>会展开为<code>test_rvc_expand_16bit_full[0-6553]</code>至<code>test_rvc_expand_16bit_full[58977-65536]</code>10 个测试用例运行。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6c51e44e9add2a2d66a22a310fc796b">4 - 代码覆盖率</h1>
    
	<p>代码覆盖率是一项评价指标，它衡量了被测代码中哪些部分被执行了，哪些部分没有被执行。通过统计代码覆盖率，可以评估测试的有效性和覆盖程度。</p>
<p>代码覆盖率包括：</p>
<ul>
<li>行覆盖率(line coverage): 被测代码中被执行的行数，最简单的指标，一般期望达到 100%。</li>
<li>条件覆盖率(branch coverage): 每一个控制结构的每个分支是否均被执行。例如，给定一个 if 语句，其 true 和 false 分支是否均被执行？</li>
<li>有限状态机覆盖率(fsm coverage): 状态机所有状态是否都达到过。</li>
<li>翻转覆盖率(toggle coverage): 统计被测代码中被执行的翻转语句，检查电路的每个节点是否都有 0 -&gt; 1 和 1 -&gt; 0 的跳变。</li>
<li>路径覆盖率(path coverage): 检查路径的覆盖情况。在 always 语句块和 initial 语句块中，有时会使用 if &hellip; else 和 case 语句，在电路结构上便会产生一系列的数据路径。。</li>
</ul>
<p>*我们主要使用的模拟器是 Verilator,优先考虑<strong>行覆盖率</strong>。Verilator 支持覆盖率统计，因此我们在构建 DUT 时，如果要开启覆盖率统计，需要在编译选项中添加<code>-c</code>参数。</p>
<h2 id="本项目中相关涉及位置">本项目中相关涉及位置</h2>
<p>开启覆盖率需要在编译时（使用 picker 命令时）加上“-c”参数（参考 picker 的<a href="https://github.com/XS-MLVP/picker/blob/master/README.zh.md#%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A">参数解释</a>），同时在文件中设置启用行覆盖率，这样在使用 toffee 测试时，才能够生成覆盖率统计文件。</p>
<p>结合上面的描述，在本项目中也就是编译，编写和启用行覆盖率函数和测试的时候会涉及到代码覆盖率：</p>
<h3 id="添加编译脚本部分">添加编译脚本部分</h3>
<p><a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/#编写-buildcfg---bool-函数">编写编译脚本</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 省略前面</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut/RVCExpander&#34;</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exporting RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#39;picker export --cp_lib false </span><span style="color:#4e9a06">{</span><span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rtl/RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                                              <span style="color:#4e9a06">}</span><span style="color:#4e9a06"> --lang python --tdir </span><span style="color:#4e9a06">{</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/ -w rvc.fst -c&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to export RVCExpander.sv: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 省略后面</span>
</span></span></code></pre></div><p>在<code>s, out, err=...</code>这一行，我们使用 picker 命令，并且开启代码了覆盖率(命令最后的&quot;-c&quot;参数)。</p>
<p><a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/#编写-line_coverage_filescfg---liststr-函数">设置目标覆盖文件(line_coverage_files 函数)</a></p>
<p>按照需求编写<code>line_coverage_files(cfg) -&gt; list[str]</code>函数，并且开启测试结果处理(<code>doc_result.disable = False</code>)让其被调用。</p>
<h3 id="构建测试环境部分">构建测试环境部分</h3>
<p><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#3-定义必要fixture">定义必要 fixture</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">)</span>                          <span style="color:#8f5902;font-style:italic"># 把生成的代码覆盖率文件告诉 toffee-report</span>
</span></span></code></pre></div><p>通过函数<code>toffee-test.set_line_coverage</code>把覆盖率文件传递给 toffe-test，这样其才能够收集数据，以便于后面生成的报告带有行覆盖率。</p>
<h2 id="忽略指定统计">忽略指定统计</h2>
<p>有时候，我们可能需要手动指定某些内容不参与覆盖率统计。例如有些是不需要被统计的，有些统计不到是正常的。这时候我们就可以忽略这些内容，这对优化覆盖率报告或调试非常有帮助。
目前我们的框架可以使用两种方式来实现忽略统计的功能：</p>
<h3 id="1通过-verilator-指定忽略统计的内容">1.通过 verilator 指定忽略统计的内容</h3>
<h4 id="使用-verilator_coverage_offon-指令">使用 verilator_coverage_off/on 指令</h4>
<p>Verilator 支持通过注释指令来忽略特定代码段的覆盖率统计。例如，使用如下的指令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// *verilator coverage_off*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 忽略统计的代码段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// *verilator coverage_on*
</span></span></span></code></pre></div><p>举个例子</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">example</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// *verilator coverage_off*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">debug_signal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">$display</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;This is for debugging only&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// *verilator coverage_on*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">enable</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">do_something</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>在上述示例中，debug_signal 部分的代码将不会计入覆盖率统计，而 enable 部分仍然会被统计。</p>
<p>更多 verilator 的忽略统计方式请参照<a href="https://veripool.org/guide/latest/exe_verilator.html#configuration-files">verilator 官方文档</a></p>
<h3 id="2通过-toffee-指定需要过滤掉的内存">2.通过 toffee 指定需要过滤掉的内存</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datfile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignore</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[]):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Pass
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        request (pytest.Request): Pytest的默认fixture，
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        datfile (string): DUT生成的
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ignore (list[str]): 覆盖率过滤文件/或者文件夹
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>ignore 参数可以指定在覆盖率文件中需要过滤掉的内容，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scripts/frontend_ifu_rvc_expander&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>在统计覆盖率时，会在&quot;scripts/frontend_ifu_rvc_expander&quot;目录中搜索到<code>line_coverage.ignore</code>文件，然后按其中每行的通配符进行过滤。</p>
<pre tabindex="0"><code class="language-ignore" data-lang="ignore"># Line covarge ignore file
# ignore Top file
*/RVCExpander_top*%
</code></pre><p>上述文件表示，在统计覆盖率时，会忽略掉包含&quot;RVCExpander_top&quot;关键字的文件（实际上是收集了对应的数据，但是最后统计的时候忽略了）。</p>
<h2 id="查看统计结果">查看统计结果</h2>
<p>在经过前面所有步骤之后，包括准备测试环境中的<a href="/UnityChipForXiangShan/docs/01_verfiy_env/#下载rtl代码">下载 RTL 代码</a>、<a href="/UnityChipForXiangShan/docs/01_verfiy_env/#编译DUT">编译 DUT</a>、<a href="/UnityChipForXiangShan/docs/01_verfiy_env/#编辑配置">编辑配置</a>
；添加测试中的<a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/">添加编译脚本</a>,<a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/">构建测试环境</a>、<a href="/UnityChipForXiangShan/docs/03_add_test/03_add_test/">添加测试用例</a>。</p>
<p>现在<a href="/UnityChipForXiangShan/docs/02_run_test/">运行测试</a>,之后就默认在<code>out/report</code>目录会生成 html 版本的测试报告。</p>
<p>也可以在<a href="https://open-verify.cc/UnityChipForXiangShan/docs/">进度概述</a>图形下方的“当前版本”选择对应的测试报告(按照测试时间命名)，然后点击右侧链接即可查看统计结果。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2938880e10d36d978ade908698b9760">5 - 功能覆盖率</h1>
    
	<p>功能覆盖率（Functional Coverage）是一种<strong>用户定义</strong>的度量标准，用于度量验证中已执行的设计规范的比例。功能覆盖率关注的是设计的功能和特性是否被测试用例覆盖到了。</p>
<p>反标是指将功能点与测试用例对应起来。这样，在统计时，就能看到每个功能点对应了哪些测试用例，从而方便查看哪些功能点用的测试用例多，哪些功能点用的测试用例少，有利于后期的测试用例优化。</p>
<h2 id="本项目中相关涉及位置">本项目中相关涉及位置</h2>
<p>功能覆盖率需要我们先定义了才能统计，主要是在构建测试环境的时候涉及。</p>
<p>在<a href="https://open-verify.cc/UnityChipForXiangShan/docs/03_add_test/02_build_env/">构建测试环境</a>中：</p>
<ul>
<li><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#2-定义功能覆盖率">定义功能覆盖率</a>： 创建了功能覆盖率组,添加观察点和反标</li>
<li><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#3-定义必要fixture">定义必要 fixture</a>： 把统计结果传递给 toffee-report</li>
<li><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#4-统计覆盖率">统计覆盖率</a>： 添加观察点和反标</li>
</ul>
<p>其他：</p>
<ul>
<li>在 Test case 中使用，可以在每个测试用例里也编写一个功能点。</li>
</ul>
<h2 id="功能覆盖率使用流程">功能覆盖率使用流程</h2>
<h3 id="指定-group-名称">指定 Group 名称</h3>
<p>测试报告通过 Group 名字和 DUT 名字进行匹配，利用 comm.UT_FCOV 获取 DUT 前缀，例如在 Python 模块<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>中进行如下调用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UT_FCOV</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 本模块名为：ut_frontend.ifu.rvc_expander.classical_version.env.rvc_expander_wrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过../../../去掉了classical_version和上级模块env，rvc_expander_wrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># UT_FCOV会默认去掉前缀 ut_</span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UT_FCOV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;../../../CLASSIC&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># name = UT_FCOV(&#34;../../../CLASSIC&#34;)</span>
</span></span></code></pre></div><p>name 的值为<code>frontend.ifu.rvc_expander.CLASSIC</code>，在最后统计结果时，会按照最长前缀匹配到目标 UT（即匹配到：frontend.ifu.rvc_expander 模块）</p>
<h3 id="创建覆盖率组">创建覆盖率组</h3>
<p>使用<code>toffee</code>的<code>funcov</code>可以创建覆盖率组。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee.funcov</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">fc</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用上面指定的GROUP名字</span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这两步也可以合成一句<code>g = fc.CovGroup(UT_FCOV(&quot;../../../CLASSIC&quot;))</code>。
创建的g对象就表示了一个功能覆盖率组，可以使用其来提供观察点和反标。</p>
<h3 id="添加观察点和反标">添加观察点和反标</h3>
<p>在每个测试用例内部，可以使用<code>add_watch_point</code>（<code>add_cover_point</code>是其别名，二者完全一致）来添加观察点和<code>mark_function</code>来添加反标。
观察点是，当对应的信号触发了我们在观察点内部定义的要求后，这个观察点的名字（也就是功能点）就会被统计到功能覆盖率中。
反标是，将功能点和测试用例进行关联，这样在统计时，就能看到每个功能点对应了哪些测试用例。</p>
<p>对于观察点的位置，需要根据实际情况来定，一般来说，在测试用例外直接添加观察点是没有问题的。
不过有时候我们可以更加的灵活。</p>
<ol>
<li>在测试用例之外（<code>decode_wrapper.py</code>中）</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Add watch points to the RVCExpander module to collect function coverage information&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 1. Add point RVC_EXPAND_RET to check expander return value:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin ERROR. The instruction is not illegal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin SUCCE. The instruction is not expanded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 5. Reverse mark function coverage to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_M</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># get the module name</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">module_name_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;../../test_rv_decode&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#  - mark RVC_EXPAND_RET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">_M</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;test_rvc_expand_16bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_randomN&#34;</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># The End                                                                              </span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">None</span> 
</span></span></code></pre></div><p>这个例子的第一个<code>g.add_watch_point</code>是放在测试用例之外的，因为它和现有的测试用例没有直接关系，放在测试用例之外反而更加方便。添加观察点之后，只要<code>add_watch_point</code>方法中的<code>bins</code>条件触发了，我们的<code>toffee-test</code>框架就能够收集到对应的功能点。</p>
<ol start="2">
<li>在测试用例之中（<code>test_rvc_expander.py</code>中）</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">32</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">TAG_LONG_TIME_RUN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TAG_RARELY_USED</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.parametrize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start,end&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#000;font-weight:bold">[(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)])</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_32bit_full</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with a full 32 bit instruction set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Description:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        Randomly generate N 32-bit instructions for each check, and repeat the process K times.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Add check point: RVC_EXPAND_ALL_32B to check instr bits.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_32B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dynamic_bin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Reverse mark function to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_32B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_rvc_expand_32bit_full</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Drive the expander and check the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">)]))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># When go to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>这个例子的观察点在测试用例里面，因为这里的<code>start</code>和<code>end</code>是由<code>pytest.mark.parametrize</code>来决定的，数值不是固定的，所以我们需要在测试用例里面添加观察点。</p>
<h3 id="采样">采样</h3>
<p>在上一个例子的最后，我们调用了<code>g.sample()</code>，这个函数的作用是告诉<code>toffee-test</code>，<code>add_watch_point</code>里的<code>bins</code>已经执行过了，判断一下是不是True，是的话就为这个观察点记录一次Pass。</p>
<p>有手动就有自动。我们可以在构建测试环境时，在定义fixture中加入<code>StepRis(lambda x: g.sample())</code>,这样就会在每个时钟周期的上升沿自动采样。</p>
<p>以下内容来自<code>ut_backend/ctrl_block/decode/env/decode_wrapper.py </code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">decoder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># before test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_rv_decoder_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">func_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># If the output directory does not exist, create it</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">output_dir_path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/log&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">makedirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">output_dir_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist_ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTDecodeStage</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/decode_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.fst&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">func_name</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coverage_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/decode_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.dat&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">func_name</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clock&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">decoder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># after test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/decode_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.dat&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">func_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">FileNotFoundError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;File not found: </span><span style="color:#4e9a06">{</span><span style="color:#000">coverage_file</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scripts/backend_ctrlblock_decode&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_func_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>如上面所示，我们在<code>yield</code>之前调用了<code>g.sample()</code>，这样就会在每个时钟周期的上升沿自动采样。</p>
<p><code>StepRis</code>函数的作用是在每个时钟周期的上升沿执行传入的函数，详情可参照<a href="https://open-verify.cc/mlvp/docs/env_usage/picker_usage/">picker使用介绍</a></p>

</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2024
    <span class="td-footer__authors">BOSC</span></span><span class="td-footer__all_rights_reserved">保留所有权利</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/UnityChipForXiangShan/js/main.min.37d14e870feb76f0f7a2a2422bae231efb0186c477999a4ab9ca7e9924ced592.js" integrity="sha256-N9FOhw/rdvD3oqJCK64jHvsBhsR3mZpKucp&#43;mSTO1ZI=" crossorigin="anonymous"></script>
<script src='/UnityChipForXiangShan/js/prism.js'></script>
<script src='/UnityChipForXiangShan/js/tabpane-persist.js'></script>

  </body>
</html>
