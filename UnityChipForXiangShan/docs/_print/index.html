<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://open-verify.cc/UnityChipForXiangShan/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://open-verify.cc/UnityChipForXiangShan/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/UnityChipForXiangShan/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/UnityChipForXiangShan/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-192x192.png" sizes="192x192">

<title>进度概述 | 万众一芯之香山处理器</title>
<meta name="description" content="本项目旨在通过开源众包的方式对香山处理器的昆明湖架构进行单元（Unit Test, UT）验证。下图是香山昆明湖架构各个模块验证情况。
当前版本： 20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101 20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e 20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08 20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b 20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c 20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa 20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153 20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702 20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693 20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a 20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436 20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c 20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c 20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db 20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0 20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e 20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61 20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c 20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b 20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6 20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42 查看测试报告 总统计数据如下：
总测试用例数（Total Cases）： - 测试用例通过数（Passed Cases）： - 测试用例通过率（Passed Rate）： - 测试用例未过数（Failed Cases）： - 测试用例跳过数（Skipped Cases）： - 测试用例跳过率（Skip Rate）： - 总功能覆盖点数（Function Coverage）： - 覆盖点已覆盖数（Covered Functions）： - 覆盖点已覆盖率（Covered Rate）： - 总代码行覆盖率（Total Lines）： - 总代码行覆盖数（Covered Lines）： - 总代码行覆盖率（Covered Rate）： - *总代码行会随着DUT的增加而不断增加，因此：总代码行覆盖率不是最终覆盖率
其他内容快捷连接：
DUT文档与功能 待确认bug列表 已发现bug列表 已修复bug列表 正在进行的任务列表 已完成的任务列表 香山昆明湖DUT验证进展 注：本文档中的统计信息根据测试结果自动生成">
<meta property="og:title" content="进度概述" />
<meta property="og:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://open-verify.cc/UnityChipForXiangShan/docs/" />
<meta itemprop="name" content="进度概述">
<meta itemprop="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="进度概述"/>
<meta name="twitter:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."/>
<link rel="preload" href="/UnityChipForXiangShan/scss/main.min.689b22b0041c8c7c7cf217802f908a4ce2122a5f8924320dd5431c6362fe39a7.css" as="style" integrity="sha256-aJsisAQcjHx88heAL5CKTOISKl&#43;JJDIN1UMcY2L&#43;Oac=" crossorigin="anonymous">
<link href="/UnityChipForXiangShan/scss/main.min.689b22b0041c8c7c7cf217802f908a4ce2122a5f8924320dd5431c6362fe39a7.css" rel="stylesheet" integrity="sha256-aJsisAQcjHx88heAL5CKTOISKl&#43;JJDIN1UMcY2L&#43;Oac=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/UnityChipForXiangShan/css/prism.css"/>

    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4Z2ZY6ZE84');
    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />

<script>
    $(document).ready(function() {
        $('a[name="multi-lang-toggle"]').on('click', function(event) {
            var language = $(this).attr('lang');
            var codeDiv = $(this).closest('.highlight');
            var preNodes = codeDiv.find('pre');
            preNodes.each(function(index, preNode) {
                if ($(preNode).attr("name").toLowerCase().indexOf(language.toLowerCase()) !== -1) {
                    preNode.style.display = 'block';
                } else {
                    preNode.style.display = 'none';
                }
            });
            var alist = codeDiv.find('a[name="multi-lang-toggle"]');
            alist.each(function(index, aNode) {
                if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                    aNode.style.fontWeight = 'bold';
                } else {
                    aNode.style.fontWeight = 'normal';
                }
            });
        })
        $(this).find('pre[name^="group-lang-code-"]').each(function(index, preNode) {
            if (preNode.style.display !== 'none') {
                var language = $(preNode).attr("name").replace('group-lang-code-', '');
                var alist = $(this).closest('.highlight').find('a[name="multi-lang-toggle"]');
                alist.each(function(index, aNode) {
                    if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                        aNode.style.fontWeight = 'bold';
                    } else {
                        aNode.style.fontWeight = 'normal';
                    }
                });
            }
        });
    });
</script>
    
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/UnityChipForXiangShan/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">万众一芯之香山处理器</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/UnityChipForXiangShan/en/docs/">English</a></li>
    </ul>
</div></li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="站内搜索…"
    aria-label="站内搜索…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/UnityChipForXiangShan/offline-search-index.dda6383ab2729c149632884c3205cdfc.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/UnityChipForXiangShan/docs/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">进度概述</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-0dcba8abab46333b47bb5f2e2beb4acc">目标验证单元</a></li>


    
  
    
    
	
<li>2: <a href="#pg-e819c695f47dc3893fee99c05230ff78">准备验证环境</a></li>


    
  
    
    
	
<li>3: <a href="#pg-a5fd55875e0540351befe9b3a6e05b98">运行测试</a></li>


    
  
    
    
	
<li>4: <a href="#pg-6f6b342069bf0da19ce0bf410bce92e2">添加测试</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-dbf9b443ff7a2ae1b419d7f271fac95a">添加编译脚本</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-53f38485d7ee0ef1d06f36fbe61bda5b">构建测试环境</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-4cd74e2d3f7d9b1031b77dd328511afa">添加测试用例</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-c6c51e44e9add2a2d66a22a310fc796b">代码覆盖率</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-f2938880e10d36d978ade908698b9760">功能覆盖率</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-07ebcfe55daf3596c9e3470979e4e81e">如何参与本项目</a></li>


    
  
    
    
	
<li>6: <a href="#pg-1d0ac3d7094a9a644440034e44c77115">模板-PR</a></li>


    
  
    
    
	
<li>7: <a href="#pg-4efe7d3d46d7929f2a2b248110be165b">模板-ISSUE</a></li>


    
  
    
    
	
<li>8: <a href="#pg-68658f28e70d830f706f538c1d44b165">模板-UT-README</a></li>


    
  
    
    
	
<li>9: <a href="#pg-08609283b091262ac299662399e11d12">常用API</a></li>


    
  
    
    
	
<li>10: <a href="#pg-8a2981468f57aaf0314d1df6c5431ce9">其他</a></li>


    
  
    
    
	
<li>11: <a href="#pg-69941129f79fb8261f7f1fe7b92e7c0a">必要规范</a></li>


    
  
    
    
	
<li>12: <a href="#pg-c1ae5de257a4994f185c724b61cc52e6">验证文档</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-85aa4b5fe3fa0c67d7bcebe4378a6f76">验证文档规范</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-f6da66656f78946ca5834eb79896448e">Frontend</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.2.1: <a href="#pg-29667896f8d34faad3302168726a92b6">IFU</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.2.1.1: <a href="#pg-f74282ae3d4b69fbe0da858a7c9107a5">F3PreDecoder</a></li>


    
  
    
    
	
<li>12.2.1.2: <a href="#pg-3b78267f9199bb88f87206c813e08a73">FrontendTrigger</a></li>


    
  
    
    
	
<li>12.2.1.3: <a href="#pg-337a93058a969bd1106bbae43f51763d">PredChecker</a></li>


    
  
    
    
	
<li>12.2.1.4: <a href="#pg-79296c4a2b615b1e55168353e62cb794">PreDecode</a></li>


    
  
    
    
	
<li>12.2.1.5: <a href="#pg-f3f3627a040d55087b6c36b4ee0f1f10">RVCExpander</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12.2.2: <a href="#pg-8232a31fca98c70ecc5a3e512677c27a">ITLB</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.2.2.1: <a href="#pg-8c8ea31c8faf4aa9bfcdd9a6dd4a60b2">IO接口说明</a></li>


    
  
    
    
	
<li>12.2.2.2: <a href="#pg-f567a757741a110183ec410da59a031f">功能详述</a></li>


    
  
    
    
	
<li>12.2.2.3: <a href="#pg-805af6e38a4c1680746577e8e7b92b0b">关键信号说明</a></li>


    
  
    
    
	
<li>12.2.2.4: <a href="#pg-d3961dca1de0386eb884ba104bb9559e">环境配置</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>12.3: <a href="#pg-17b3abe13a72e58e8c003d9471432196">Backend</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>12.4: <a href="#pg-5e69934b02d245d218b0a12e7951955f">Mem Block</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>12.5: <a href="#pg-790523663d2f74755027f36c25d1c322">Misc</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>13: <a href="#pg-3acd98556bb6e01bccfdb9fe2c4cfdc0">维护者</a></li>


    
  

    </ul>


<div class="content">
      <script src="../js/echarts.min.js"></script>
<script src="../js/chart_meta.js"></script>
<script>
function update_charts(data_url){
    show_meta_chart("meta_chart", data_url)
    updateDUTestStatus(data_url)
}
</script>
<p>本项目旨在通过开源众包的方式对<a href="https://github.com/OpenXiangShan/XiangShan">香山处理器</a>的昆明湖架构进行单元（Unit Test, UT）验证。下图是香山昆明湖架构各个模块验证情况。</p>
<div id="meta_chart" style="width: 100%;height:400px;"></div>
<div style="text-align: center; width: 100%;">

<label>当前版本：</label>
<select id="indexurlSelect" onchange="updateLink()" style="border: 0px">
    
    
    
    
    
    <option value="20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101" data-url="../data/reports//UnityChipForXiangShan/20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101"  selected>20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101</option>
    
    <option value="20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e" data-url="../data/reports//UnityChipForXiangShan/20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e"  >20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e</option>
    
    <option value="20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08" data-url="../data/reports//UnityChipForXiangShan/20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08"  >20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08</option>
    
    <option value="20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b" data-url="../data/reports//UnityChipForXiangShan/20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b"  >20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b</option>
    
    <option value="20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c" data-url="../data/reports//UnityChipForXiangShan/20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c"  >20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c</option>
    
    <option value="20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa" data-url="../data/reports//UnityChipForXiangShan/20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa"  >20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa</option>
    
    <option value="20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153" data-url="../data/reports//UnityChipForXiangShan/20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153"  >20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153</option>
    
    <option value="20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702" data-url="../data/reports//UnityChipForXiangShan/20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702"  >20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702</option>
    
    <option value="20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693" data-url="../data/reports//UnityChipForXiangShan/20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693"  >20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693</option>
    
    <option value="20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a" data-url="../data/reports//UnityChipForXiangShan/20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a"  >20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a</option>
    
    <option value="20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436" data-url="../data/reports//UnityChipForXiangShan/20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436"  >20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436</option>
    
    <option value="20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c" data-url="../data/reports//UnityChipForXiangShan/20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c"  >20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c</option>
    
    <option value="20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c" data-url="../data/reports//UnityChipForXiangShan/20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c"  >20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c</option>
    
    <option value="20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db" data-url="../data/reports//UnityChipForXiangShan/20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db"  >20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db</option>
    
    <option value="20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0" data-url="../data/reports//UnityChipForXiangShan/20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0"  >20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0</option>
    
    <option value="20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e" data-url="../data/reports//UnityChipForXiangShan/20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e"  >20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e</option>
    
    <option value="20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61" data-url="../data/reports//UnityChipForXiangShan/20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61"  >20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61</option>
    
    <option value="20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c" data-url="../data/reports//UnityChipForXiangShan/20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c"  >20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c</option>
    
    <option value="20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b" data-url="../data/reports//UnityChipForXiangShan/20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b"  >20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b</option>
    
    <option value="20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6" data-url="../data/reports//UnityChipForXiangShan/20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6"  >20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6</option>
    
    <option value="20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42" data-url="../data/reports//UnityChipForXiangShan/20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42"  >20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42</option>
    
</select>
<a id="indexgoLink" href="#" target=“_blank“>查看测试报告</a>

<script>
function updateLink() {
    var select = document.getElementById("indexurlSelect");
    var goLink = document.getElementById("indexgoLink");
    var opt = select.options[select.selectedIndex];
    if(!opt){
        return
    }
    var url = opt.getAttribute("data-url").replaceAll("/UnityChipForXiangShan/", "");
    goLink.href = url;
    
    window["update_charts"](url + "/ut_data_progress.json");
    
}
document.addEventListener('DOMContentLoaded', function() {
    updateLink()
});
</script>

</div>
<br>
<p>总统计数据如下：</p>
<table>
    <ol>
    <tr>
        <td>总测试用例数（Total Cases）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_cases_toal">-</em></td>
        <td>测试用例通过数（Passed Cases）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_cases_pass">-</em></td>
        <td>测试用例通过率（Passed Rate）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_cases_prate">-</em></td>
    </tr>
    <tr>
        <td>测试用例未过数（Failed Cases）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_cases_fail">-</em></td>
        <td>测试用例跳过数（Skipped Cases）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_cases_skip">-</em></td>
        <td>测试用例跳过率（Skip Rate）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_cases_srate">-</em></td>
    </tr>
    <tr>
        <td>总功能覆盖点数（Function Coverage）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_function_total">-</em></td>
        <td>覆盖点已覆盖数（Covered Functions）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_function_cover">-</em></td>
        <td>覆盖点已覆盖率（Covered Rate）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_function_rate">-</em></td>
    </tr>
    <tr>
        <td>总代码行覆盖率（Total Lines）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_line_total">-</em></td>
        <td>总代码行覆盖数（Covered Lines）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_line_cover">-</em></td>
        <td>总代码行覆盖率（Covered Rate）：</td>
        <td  style="text-align: left; font-weight: bold;"><em id="em_id_report_line_rate">-</em></td>
    </tr>
    </ol>
</table>
<p>*总代码行会随着DUT的增加而不断增加，因此：总代码行覆盖率不是最终覆盖率</p>
<p>其他内容快捷连接：</p>
<ul>
<li><strong><a href="https://open-verify.cc/UnityChipForXiangShan/docs/98_ut/">DUT文档与功能</a></strong></li>
<li><strong><a href="https://github.com/XS-MLVP/UnityChipForXiangShan/labels/bug%20need%20to%20confirm">待确认bug列表</a></strong></li>
<li><strong><a href="https://github.com/XS-MLVP/UnityChipForXiangShan/labels/bug%20confirmed">已发现bug列表</a></strong></li>
<li><strong><a href="https://github.com/XS-MLVP/UnityChipForXiangShan/labels/bug%20fixed">已修复bug列表</a></strong></li>
<li><strong><a href="https://open-verify.cc/crowdsourcing/kunming_lake">正在进行的任务列表</a></strong></li>
<li><strong><a href="https://open-verify.cc/crowdsourcing/kunming_lake">已完成的任务列表</a></strong></li>
</ul>
<br>
<div style="text-align: center; width: 100%;">
<h4 id="testmap">香山昆明湖DUT验证进展</h4>
</div>
<br>

<style>
.div-dut-test-report {
    all:none;
    display: flex;
    align-items: center;
    text-align: center;
     
    width: 100%;
    margin: 0 auto;
    overflow: auto;
}
.div-dut-test-report tbody {
    --bs-table-striped-bg: white;
}
.div-dut-test-report .td-name {
    text-align: left;
}
.div-dut-test-report .td-index {
    text-align: center;
}
.div-dut-test-report table {
    width: 90%;
    margin: 0 auto;
}
.div-dut-test-report td {
    text-align: right;
}

.div-dut-test-report .td-desc{
    text-align: left;
}

.div-dut-test-report th {
    text-align: right;
}
.div-dut-test-report tr {
    border-bottom: 1px solid #ddd;
}
.em-red {
    color: yellow;
    font-weight: bold;
    background-color: rgb(247, 36, 152);
    border-radius: 2px;
}
.em-orange {
    color: white;
    font-weight: bold;
    background-color: orange;
    border-radius: 2px;
}
.em-green {
    font-weight: bold;
    color: yellow;
    background-color: green;
    border-radius: 2px;
}
.modal-linecov {
    display: none;  
    position: absolute;  
    z-index: 1;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
}
.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
    position: absolute;
}
.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}


table .td-desc .tooltiptext {
  visibility: hidden;
  width: 250px;
  background-color: rgb(87, 87, 87);
  color: #fff1f1;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;

   
  position: absolute;
  z-index: 1;
}

.td-desc:hover .tooltiptext{
    visibility: visible;
}

</style>

<div id="line-file-modal" class="modal-linecov">
    <div class="modal-content" id="linecov-text">
    </div>
</div>

<div class="div-dut-test-report">
<table id="dut-test-items" align="center" class="td-initial">
</table>
</div>

<script>
function closeLineCovModal() {
    $("#line-file-modal").hide();
}

$(window).click(function(event) {
    var modal = $("#line-file-modal");
    if (! modal.is(":hidden")) {
        if (! $(event.target).closest(".modal-content").length){
            closeLineCovModal();
        }
    }
});

function updateDUTestStatus(data_url){
    $.getJSON(data_url, function (data) {
        $("#dut-test-items").html(
"            <tbody align=\"center\">\
    <tr>\
        <th class=\"td-index\">Index</th>\
        <th class=\"td-name\">Name</th>\
        <th class=\"td-desc\">Description </th> \
        <th>Document</th>\
        <th>&nbsp;&nbsp;Cases</th>\
        <th>&nbsp;&nbsp;&nbsp;Fail</th>\
        <th>&nbsp;&nbsp;&nbsp;SKip</th>\
        <th>CsRate (%)</th>\
        <th>Checks\
        <th>Fail\
        <th>CkRate (%)</th>\
        <th>Lines</th>\
        <th>CvRate (%)</th>\
        <th>Maintainer</th>\
    </tr>\
  </tbody>");
        var prefix = data.tree.meta.paths;
        var index = 1;
        function calcRateColor(rate){
            var color = "";
            if(rate < data.config.rate_low){
                color = "red";
            } else if(rate < data.config.rate_middle){
                color = "orange";
            } else if(rate > data.config.rate_high){
                color = "green";
            }
            return "<em class=\"em-"+color+"\">" + rate + "</em>";
        }
        function calcRate(a, b){
            if(b === 0){
                return 0;
            }
            return calcRateColor((a / b * 100).toFixed(2));
        }
        function redItem(item){
            if (item > 0) {
                return "<em class=\"em-red\">" + item + "</em>";
            }
            return item;
        }
        function getDocUrl(url){
            if(url){
                return "<a href=\"" + url + "\" target=\"_blank\">Detail</a>";
            }
            return "-";
        }
        function getLinFileUrl(paths){
            var txt = ""
            var meta = data.extend[paths]
            if (!meta) return txt;
            meta.target_line_coverage_files.forEach(f=> {
                var url = null;
                if(!f.includes("not found")){
                    meta.matched_line_coverage_files.forEach(u=> {
                        if(u[0].includes(f)){
                            var base_url = data_url.split("/").slice(0, -1).join("/");
                            txt += "<li><a href=\"" + base_url + u[0] + "\" target=\"_blank\">" + f + "</a> <em style=\"float: right;\"> ("
                                +u[1]+"/"+u[2]+")<em> </li>";
                        }else{
                            console.log("not found: " + f + " in " + u);
                        }
                    });
                }else{
                    txt += "<li>" + f + "</li>";
                }
            });
            return $("#linecov-text").html(txt);
        }
        function openLineCovModal(event, paths) {
            event.preventDefault();
            event.stopPropagation();
            closeLineCovModal();
            getLinFileUrl(paths);
            var modal = $("#line-file-modal")
            var text = $("#linecov-text")
            modal.css({
                left: event.pageX - text.width()/2 + "px",
                top: event.pageY - text.height()/2 + "px"
            });
            modal.show();
        }
        window.openLineCovModal = openLineCovModal;
        function getLineCovUrl(paths, hints, total){
            var text = hints + "/" + total;
            if(total > 0){
                return "<a href=\"\" onclick=\"openLineCovModal(event, '" + paths + "')\">" + text + "</a>";
            }
            return text;
        }
        function getCaseUrl(paths, pass, total){
            if (total < 1){
                return "0/0";
            }
            var url = data_url.split("/").slice(0, -1).join("/") + "?";
            var K = "K=details,file,,,span," + paths.split("/").slice(2, -1).join("/");
            return "<a href=\""+ url + K +"\" target=\"_blank\">" + pass + "/" + total + "</a>";
        }
        function getCaseFailSkipUrl(paths, fail, skip){
            if (fail < 1){
                if(skip){
                    return "0"
                }
                return redItem(fail);
            }
            var url = data_url.split("/").slice(0, -1).join("/") + "?";
            var key = skip ? "skipped" : "failed";
            var K = "K=details,file,span,"+key+",span," + paths.split("/").slice(2, -1).join("/");
            var text = skip? fail: redItem(fail);
            return "<a href=\""+ url + K +"\" target=\"_blank\">" + text + "</a>";
        }
        function getFuncovUrl(paths, cover, total){
            if (total < 1){
                return "0/0";
            }
            var group_name = paths.split("/").slice(2, -1).join(".")
            var url = data_url.split("/").slice(0, -1).join("/") + "?";
            var K_case = "ShowFunCov=1&K=li,group_name,,,span," + group_name + "&K=ul,group_name,,,span,"+ group_name;
            return "<a href=\""+ url + K_case +"\" target=\"_blank\">" + cover + "/" + total + "</a>";
        }
        function getFuncovFailUrl(paths, cover, total){
            if (total == cover || total < 1){
                return "0";
            }
            var group_name = paths.split("/").slice(2, -1).join(".")
            var url = data_url.split("/").slice(0, -1).join("/") + "?";
            var K_case = "ShowFunCov=1&K=li,group_name,,,span," + group_name + "&K=ul,group_name,,,span,"+ group_name;
            var K_fail = K_case + "&K=li,point_name,,,span,Failed&K=ul,grou_name,,,ul,failed";
            return "<a href=\""+ url + K_fail +"\" target=\"_blank\">" + redItem(total - cover) + "</a>";
        }

        function getDescComp(desc) {
            initial = "<td class=\"td-desc\">";
            end = "</td>"
            scale = 15
            if (desc.length <= scale){
                return initial + desc + end
            }

            emit_desc = desc.substr(0, scale) + "..."
            tooltip_res = "<div class=\"tooltiptext\">" + desc + "</div>"
            return initial + emit_desc + tooltip_res + end

        }

        function traverse(node) {
            if (!node.children || node.children.length === 0) {
                var meta = node.meta
                var desc = node.desc
                var maintainer = node.maintainers || "TBD"
                if (node.maintainers){
                    maintainers = []
                    for (let i = 0; i < node.maintainers.length; i++){
                        let cur = node.maintainers[i]
                        let tmp_maintainer = cur.name || "TBD";
                        if (tmp_maintainer.length > 5){
                            tmp_maintainer = tmp_maintainer.substr(0, 4) + "..."
                        }
                        if (cur.page){
                            tmp_maintainer = "<a style=\"display: block;\" href=\"" + cur.page + "\">" + tmp_maintainer + "</p>"
                        } else {
                            tmp_maintainer = "<p>" + tmp_maintainer + "</p>"
                        }
                        maintainers.push(tmp_maintainer)
                    }
                    maintainer = maintainers.join(' ')
                }
                $("#dut-test-items").html($("#dut-test-items").html() + 
                    "<tr><td class=\"td-index\">" + index + "</td>" +
                    "<td class=\"td-name\">" + meta.paths.replace(prefix + "/",
                        "").replaceAll("/", ".") + "</td>" +
                    getDescComp(desc) + 
                    "<td>" + getDocUrl(meta.doc_url) + "</td>" +
                    "<td>" + getCaseUrl(meta.paths, meta.cases.pass, meta.cases.total) + "</td>" +
                    "<td>" + getCaseFailSkipUrl(meta.paths, meta.cases.fail, false) + "</td>" +
                    "<td>" + getCaseFailSkipUrl(meta.paths, meta.cases.skip, true) + "</td>" +
                    "<td>" + calcRate(meta.cases.pass, meta.cases.total) + "</td>" +
                    "<td>" + getFuncovUrl(meta.paths, meta.functions.cover, meta.functions.total) + "</td>" +
                    "<td>" + getFuncovFailUrl(meta.paths, meta.functions.cover, meta.functions.total) + "</td>" +
                    "<td>" + calcRate(meta.functions.cover, meta.functions.total) + "</td>" +
                    "<td>" + getLineCovUrl(meta.paths, meta.lines.cover, meta.lines.total) + "</td>" +
                    "<td>" + calcRate(meta.lines.cover, meta.lines.total) + "</td>" +
                    "<td>" + maintainer + "</td>" +
                    "</tr>"
                );
                index++;
            } else {
                $.each(node.children, function(index, child) {
                    traverse(child);
                });
            }
        }
        traverse(data.tree);
    });
}
</script>

<div style="text-align: center; width: 100%;">
<br>
注：本文档中的统计信息根据测试结果自动生成<br>
数据自动更新日期：<em id="em_id_report_date">1970-01-01 00:00:00</em>
</div>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0dcba8abab46333b47bb5f2e2beb4acc">1 - 目标验证单元</h1>
    
	<script src="../../js/echarts.min.js"></script>
<script src="../../js/chart_datatree.js"></script>
<script>
function update_dut_charts(data_url){
    show_datatree_chart("datatree_chart", data_url)
}
</script>
<br>
<div id="datatree_chart" style="width: 90%;height:800px;"></div>
<div style="text-align: center; width: 100%;">

<label>当前版本：</label>
<select id="duturlSelect" onchange="updateLink()" style="border: 0px">
    
    
    
    
    
    <option value="20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101" data-url="../../data/reports//UnityChipForXiangShan/20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101"  selected>20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101</option>
    
    <option value="20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e" data-url="../../data/reports//UnityChipForXiangShan/20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e"  >20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e</option>
    
    <option value="20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08" data-url="../../data/reports//UnityChipForXiangShan/20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08"  >20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08</option>
    
    <option value="20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b" data-url="../../data/reports//UnityChipForXiangShan/20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b"  >20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b</option>
    
    <option value="20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c" data-url="../../data/reports//UnityChipForXiangShan/20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c"  >20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c</option>
    
    <option value="20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa" data-url="../../data/reports//UnityChipForXiangShan/20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa"  >20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa</option>
    
    <option value="20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153" data-url="../../data/reports//UnityChipForXiangShan/20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153"  >20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153</option>
    
    <option value="20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702" data-url="../../data/reports//UnityChipForXiangShan/20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702"  >20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702</option>
    
    <option value="20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693" data-url="../../data/reports//UnityChipForXiangShan/20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693"  >20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693</option>
    
    <option value="20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a" data-url="../../data/reports//UnityChipForXiangShan/20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a"  >20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a</option>
    
    <option value="20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436" data-url="../../data/reports//UnityChipForXiangShan/20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436"  >20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436</option>
    
    <option value="20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c" data-url="../../data/reports//UnityChipForXiangShan/20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c"  >20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c</option>
    
    <option value="20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c" data-url="../../data/reports//UnityChipForXiangShan/20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c"  >20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c</option>
    
    <option value="20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db" data-url="../../data/reports//UnityChipForXiangShan/20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db"  >20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db</option>
    
    <option value="20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0" data-url="../../data/reports//UnityChipForXiangShan/20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0"  >20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0</option>
    
    <option value="20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e" data-url="../../data/reports//UnityChipForXiangShan/20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e"  >20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e</option>
    
    <option value="20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61" data-url="../../data/reports//UnityChipForXiangShan/20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61"  >20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61</option>
    
    <option value="20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c" data-url="../../data/reports//UnityChipForXiangShan/20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c"  >20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c</option>
    
    <option value="20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b" data-url="../../data/reports//UnityChipForXiangShan/20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b"  >20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b</option>
    
    <option value="20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6" data-url="../../data/reports//UnityChipForXiangShan/20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6"  >20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6</option>
    
    <option value="20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42" data-url="../../data/reports//UnityChipForXiangShan/20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42"  >20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42</option>
    
</select>
<a id="dutgoLink" href="#" target=“_blank“>查看测试报告</a>

<script>
function updateLink() {
    var select = document.getElementById("duturlSelect");
    var goLink = document.getElementById("dutgoLink");
    var opt = select.options[select.selectedIndex];
    if(!opt){
        return
    }
    var url = opt.getAttribute("data-url").replaceAll("/UnityChipForXiangShan/", "");
    goLink.href = url;
    
    window["update_dut_charts"](url + "/ut_data_progress.json");
    
}
document.addEventListener('DOMContentLoaded', function() {
    updateLink()
});
</script>

</div>
<br>
<p>上图共有<em id="em_id_report_dut_total">-</em>个模块，默认情况下模块为灰色，当模块中的测试用例数大于<em id="em_id_report_dut_min_light">-</em>时，该模块被完全点亮。目前已经完全点亮的模块为<em  id="em_id_report_dut_lighted">-</em>个，待点亮的模块有<em  id="em_id_report_dut_lighted_no">-</em>个。</p>
<h4 id="通用处理器模块简介">通用处理器模块简介</h4>
<p>高性能处理器是现代计算设备的核心，它们通常由三个主要部分组成：前端、后端和访存系统。这些部分协同工作，以确保处理器能够高效地执行复杂的计算任务。</p>
<ul>
<li>
<p><strong>前端</strong>：前端部分，也被称为指令获取和解码阶段，负责从内存中获取指令并将其解码成处理器可以理解的格式。这一阶段是处理器性能的关键，因为它直接影响到处理器可以多快地开始执行指令。前端通常包括指令缓存、分支预测单元和指令解码器。指令缓存用于存储最近访问过的指令，以减少对主内存的访问次数，从而提高处理速度。分支预测单元则尝试预测程序中的条件分支，以便提前获取和解码后续指令，这样可以减少等待分支结果的时间。</p>
</li>
<li>
<p><strong>后端</strong>：后端部分，也称为执行阶段，是处理器中负责实际执行指令的地方。这一阶段包括了算术逻辑单元（ALU）、浮点单元（FPU）和各种执行单元。这些单元负责进行算术运算、逻辑运算、数据传输和其他处理器操作。后端的设计通常非常复杂，因为它需要支持多种指令集架构（ISA）并优化性能。为了提高效率，现代处理器通常采用超标量架构，这意味着它们可以同时执行多条指令。</p>
</li>
<li>
<p><strong>访存</strong>：访存系统是处理器与内存之间交互的桥梁。它包括了数据缓存、内存控制器和高速缓存一致性协议。数据缓存用于存储处理器频繁访问的数据，以减少对主内存的访问次数。内存控制器负责管理处理器与内存之间的数据传输。高速缓存一致性协议确保在多处理器系统中，所有处理器看到的内存状态是一致的。</p>
</li>
</ul>
<p>高性能处理器的设计需要在这三个部分之间找到平衡，以实现最佳的性能。这通常涉及到复杂的微架构设计，以及对处理器流水线的优化。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e819c695f47dc3893fee99c05230ff78">2 - 准备验证环境</h1>
    
	<h4 id="基础环境需求">基础环境需求</h4>
<p>本项目基于<code>Python</code>编程语言进行UT验证，采用的工具和测试框架为<a href="https://github.com/XS-MLVP/picker">picker</a>和<a href="https://github.com/XS-MLVP/toffee">toffee</a>，<strong>环境需求</strong>如下：</p>
<ol>
<li>Linux操作系统。建议WSL2下安装Ubuntu22.04。</li>
<li>Python。建议Python3.11。</li>
<li>picker。按照<a href="https://open-verify.cc/mlvp/docs/quick-start/installer/">快速开始</a>中的提示安装最新版本。</li>
<li>toffee。将在后面自动安装。也可按照<a href="https://open-verify.cc/mlvp/docs/mlvp/quick-start/">快速开始</a>中的提示手动安装最新版本。</li>
<li>lcov。用于后续test阶段报告生成。使用包管理器即可下载：<code>sudo apt install lcov</code></li>
</ol>
<p><strong>环境配置完成</strong>后，clone仓库：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/XS-MLVP/UnityChipForXiangShan.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> UnityChipForXiangShan
</span></span><span style="display:flex;"><span>pip3 install -r requirements.txt <span style="color:#8f5902;font-style:italic"># 安装python依赖（例如 toffee）</span>
</span></span></code></pre></div><h4 id="下载rtl代码">下载RTL代码：</h4>
<p>默认从仓库<a href="https://github.com/XS-MLVP/UnityChipXiangShanRTLs">https://github.com/XS-MLVP/UnityChipXiangShanRTLs</a>中下载。用户也可以自行按照XiangShan文档编译生成RTL。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make rtl    <span style="color:#8f5902;font-style:italic"># 该命下载最新的rtl代码，并解压至rtl目录，并创建软连接</span>
</span></span></code></pre></div><p>可以用以下命令指定下载的rtl版本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make rtl <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;rtl.version=\&#39;openxiangshan-kmh-fad7803d-24120901\&#39;&#34;</span>
</span></span></code></pre></div><p>所有RTL下载包请在<a href="https://github.com/XS-MLVP/UnityChipXiangShanRTLs">UnityChipXiangShanRTLs</a>中查看。</p>
<p>RTL压缩包的命名规范为：<code>名称-微架构-Git标记-日期编号.tar.gz</code>，例如<code>openxiangshan-kmh-97e37a2237-24092701.tar.gz</code>。在使用时，仓库代码会过滤掉git标记和后缀，例如通过 cfg.rtl.version 访问到的版本号为：<code>openxiangshan-kmh-24092701</code>。压缩包内的目录结构为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openxiangshan-kmh-97e37a2237-24092701.tar.gz
</span></span><span style="display:flex;"><span>└── rtl           <span style="color:#8f5902;font-style:italic"># 目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- *.sv      <span style="color:#8f5902;font-style:italic"># 所有sv文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">`</span>-- *.v       <span style="color:#8f5902;font-style:italic"># 所有v文件</span>
</span></span></code></pre></div><h4 id="编译dut">编译DUT</h4>
<p>该过程的目的是将RTL通过picker工具打包为Python模块。可以通过make命令指定被打包DUT，也可以一次性打包所有DUT。</p>
<p>如果想要自行打包某个dut，需要创建编写scripts目录中的build_ut_&lt;name&gt;.py脚本。这一脚本必须实现一个build方法，在打包时会被自动调用。此外还有一个line_coverage_files方法，用于指定行覆盖率参考的文件。</p>
<p>picker的打包支持内部信号的加入，详见picker的--internal参数，传递给其一个自定义的yaml即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 调用scripts目录中的build_ut_&lt;name&gt;.py中的build方法，创建待验证的Python版DUT</span>
</span></span><span style="display:flex;"><span>make dut <span style="color:#000">DUTS</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;name&gt;  <span style="color:#8f5902;font-style:italic"># DUTS的值如果有多个，需要用逗号隔开，支持通配符。DUTS默认值为 &#34;*&#34;，编译所有DUT</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如：</span>
</span></span><span style="display:flex;"><span>make dut <span style="color:#000">DUTS</span><span style="color:#ce5c00;font-weight:bold">=</span>backend_ctrl_block_decode
</span></span></code></pre></div><p>以<code>make dut DUTS=backend_ctrl_block_decode</code>为例，命令执行完成后，会在dut目录下生成对应的Python包：</p>
<pre tabindex="0"><code>dut/
├── __init__.py
├── DecodeStage
├── Predecode
└── RVCExpander
</code></pre><p>完成转换后，在测试用例代码中可以import对应的DUT，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">dut.PreDecode</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">DUTPreDecode</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTPreDecode</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h4 id="编辑配置">编辑配置</h4>
<p>运行rtl、dut、test等命令时，默认使用configs/_default.yaml中的配置项。</p>
<p>当然，也可以使用自定义配置，方法如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定自定义CFG文件</span>
</span></span><span style="display:flex;"><span>make <span style="color:#000">CFG</span><span style="color:#ce5c00;font-weight:bold">=</span>path/to/your_cfg.yaml
</span></span></code></pre></div><p>类似地，可以在命令行直接指定键值对传入。目前仅有test相关阶段支持命令行配置键值对：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定KV，传递命令行参数，键值对之间用空格隔开</span>
</span></span><span style="display:flex;"><span>make <span style="color:#204a87">test</span> <span style="color:#000">KV</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;log.term-level=\&#39;debug\&#39; test.skip-tags=[\&#39;RARELY_USED\&#39;]&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5fd55875e0540351befe9b3a6e05b98">3 - 运行测试</h1>
    
	<p>本项目基于PyTest测试框架进行验证。运行测试时，PyTest框架自动搜索所有<code>test_*.py</code>文件，并自动执行其中所有以<code>test_</code>开头的测试用例（Test Case）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行所有ut_*目录中的test case</span>
</span></span><span style="display:flex;"><span>make test_all
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行指定目录下的test case</span>
</span></span><span style="display:flex;"><span>make <span style="color:#204a87">test</span> <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;dir&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如执行ut_backend/ctrl_block/decode目录中所有的test case</span>
</span></span><span style="display:flex;"><span>make <span style="color:#204a87">test</span> <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">=</span>ut_backend/ctrl_block/decode
</span></span></code></pre></div><p>可通过<code>args</code>参数传递Pytest的运行参数，例如启动x-dist插件的多核功能：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make <span style="color:#204a87">test</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-n 4&#34;</span>     <span style="color:#8f5902;font-style:italic"># 启用 4 个进程</span>
</span></span><span style="display:flex;"><span>make <span style="color:#204a87">test</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-n auto&#34;</span>  <span style="color:#8f5902;font-style:italic"># 让框架自动选择启用多少个进程</span>
</span></span></code></pre></div><p>*注：x-dist可以在多节点上并发运行测试，可参考其<a href="https://pytest-xdist.readthedocs.io/en/stable/remote.html">文档</a></p>
<p>运行完成后，默认在<code>out/report</code>目录会生成html版本的测试报告，其 html 文件可通过浏览器直接打开查看（VS Code IDE建议安装<code>Open In Default Browser</code>插件）。</p>
<p>运行测试主要完成以下三部分内容：</p>
<ol>
<li>按要求运行Test Case，可通过<code>cfg.tests</code>中的选项进行配置</li>
<li>统计测试结果，输出测试报告。有toffee-report自动生成 (总测试报告，所有Test的结果合并在一起)</li>
<li>根据需要（<code>cfg.doc_result.disable = True</code>）在测试报告上进行进一步数据统计</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f6b342069bf0da19ce0bf410bce92e2">4 - 添加测试</h1>
    
	<p>添加一个全新的 DUT 测试用例，需要完成以下三部分内容(本节以前端的<code>ifu</code>下的<code>rvc_expander</code>为例)：</p>
<ol>
<li><strong>添加编译脚本</strong>： 在<code>scripts</code>目录下使用<code>python</code>编写对应<code>rtl</code>的编译文件（例如<code>build_ut_frontend_ifu_rvc_expander.py</code>）。</li>
<li><strong>构建测试环境</strong>： 在目录中创建目标测试 UT 目录（例如<code>ut_frontend/ifu/rvc_expander</code>）。如果有需要的话，可以在<code>tools、comm</code>等模块中添加该 DUT 测试需要的基础工具。</li>
<li><strong>添加测试用例</strong>： 在测试 UT 目录，按<a href="https://docs.pytest.org/en/stable/">PyTest 规范</a>添加测试用例。</li>
</ol>
<p>如果是在已有的 DUT 测试中增加内容，按原有目录结构添加即可。</p>
<p>如何通过 picker 和 toffee 库进行 Python 芯片验证，请参考：<a href="https://open-verify.cc/mlvp/docs">https://open-verify.cc/mlvp/docs</a></p>
<p>在测试时还需要关心以下内容：</p>
<ol>
<li><strong>UT 模块说明</strong>: 在添加的模块顶层文件夹中，添加<code>README.md</code>说明，具体格式和要求请参考<a href="https://open-verify.cc/UnityChipForXiangShan/docs/10_template_ut_readme/">模板</a>。</li>
<li><strong>代码覆盖率</strong>：代码覆盖率是芯片验证的重要指标，一般需需要覆盖目标 DUT 的所有代码。</li>
<li><strong>功能覆盖率</strong>：功能覆盖率即目标功能验证完成了多少，一般需要达到 100%。</li>
</ol>
<p>在后续的文档中，我们将继续以<code>rvc_expander</code>模块为例，详细说明上述过程。</p>
<p>*注：目录或文件名称需要合理，以便于能通过命名知晓其具体含义。</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dbf9b443ff7a2ae1b419d7f271fac95a">4.1 - 添加编译脚本</h1>
    
	<h2 id="脚本目标">脚本目标</h2>
<p>在<code>scripts</code>目录下使用python编写对应rtl的编译文件（例如<code>build_ut_frontend_ifu_rvc_expander.py</code>）。<br>
该脚本的目标是提供 RTL 到 Python DUT 的编译、目标覆盖文件，以及自定义功能等内容。</p>
<h2 id="创建过程">创建过程</h2>
<h3 id="确定文件名称">确定文件名称</h3>
<p>在<a href="/UnityChipForXiangShan/">香山昆明湖 DUT 验证进展</a>中选择需要验证的 UT，如果没有或者进一步细化，可通过编辑<code>configs/dutree/xiangshan-kmh.yaml</code>自行添加。<br>
比如，我们要验证的是前端部分的<code>ifu</code>模块下的<code>rvc_expander</code>模块，那么需要在<code>configs/dutree/xiangshan-kmh.yaml</code>中添加对应的部分（目前yaml中已经有该模块了，此处为举例）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kmh_dut&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;所有昆明湖DUT&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;frontend&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;前端模块&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ifu&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;指令单元 (Instruction Fetch Unit)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">children</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;rvc_expander&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;RVC指令扩充器&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>脚本文件的命名格式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scripts/build_&lt;顶层模块&gt;_&lt;下层模块名&gt;_..._&lt;目标模块名&gt;.py
</span></span></code></pre></div><p>目前本项目内置了 4 个顶层模块：</p>
<ol>
<li>ut_frontend 前端</li>
<li>ut_backend 后端</li>
<li>ut_mem_block 访存</li>
<li>ut_misc 其他</li>
</ol>
<p>其中的子模块没有<code>ut_</code>前缀（顶层目录有该前缀是为了和其他目录区分开）。</p>
<p>例如验证目标 DUT 为<code>rvc_expander</code>模块：<br>
该模块是属于前端的，所以顶级模块为<code>ut_frontend</code>，它的下层模块为<code>ifu</code>，目标模块为<code>rvc_expander</code>。<br>
通过刚才我们打开的<code>yaml</code>文件也可以知道，<code>frontend</code>的children 为<code>ifu</code>，<code>ifu</code>的children 为<code>rvc_expander</code>。 <br>
所以，需要创建的脚本名称为<code>build_ut_frontend_ifu_rvc_expander.py</code>。</p>
<h3 id="编写-buildcfg---bool-函数">编写 build(cfg) -&gt; bool 函数</h3>
<p>build 函数定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">bool</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;编译DUT
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        cfg: 运行时配置，可通过它访问配置项，例如 cfg.rtl.version
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Return:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        返回 True 或者 False，表明该函数是否完成预期目标
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>build 在 make dut 时会被调用，其主要是将目标 RTL 转换为 Python 模块。在该过程中也可以加入其他必要过程，例如编译依赖项等。以<code>build_ut_frontend_ifu_rvc_expander.py</code>为例，主要完成了 RTL 检查、DUT 检查、RTL 编译、disasm 依赖编译等工作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">os</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">info</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># import 相关依赖</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee_test.markers</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">match_version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">is_all_file_exist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_root_dir</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 检查RTL版本（version参数为空，表示所有版本都支持）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">match_version</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rtl</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;openxiangshan-kmh-*&#34;</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ifu frontend rvc expander: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Unsupported RTL version </span><span style="color:#4e9a06">{</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rtl</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 检查在当前RTL中，目标文件是否存在</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">is_all_file_exist</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;rtl/RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">f</span> <span style="color:#204a87;font-weight:bold">is</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;File </span><span style="color:#4e9a06">{</span><span style="color:#000">f</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> not found&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果dut中不存在RVCExpander，则调用picker进行Python打包</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut/RVCExpander&#34;</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exporting RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#39;picker export --cp_lib false </span><span style="color:#4e9a06">{</span><span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rtl/RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> --lang python --tdir </span><span style="color:#4e9a06">{</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/ -w rvc.fst -c&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to export RVCExpander.sv: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果tools中不存在disasm/build，则需要编译disasm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tools/disasm/build&#34;</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Building disasm&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;make -C </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tools/disasm&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to build disasm&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 编译成功</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">line_coverage_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;RVCExpander.v&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>picker 的使用方式请参考其<a href="https://github.com/XS-MLVP/picker/blob/master/README.zh.md">文档</a>和<a href="https://open-verify.cc/mlvp/docs/env_usage/picker_usage/">使用</a></p>
<p>在<code>scripts</code>目录中可以创建子目录保存 UT 验证需要的文件，例如 rvc_expander 模块创建了<code>scripts/frontend_ifu_rvc_expander</code>目录，其中的<code>rtl_file.f</code>用来指定输入的 RTL 文件，<code>line_coverage.ignore</code>用来保存需要忽略的代码行统计。自定义目录的命名需要合理，且能通过名字判断其所属模块和文件。</p>
<h3 id="编写-line_coverage_filescfg---liststr-函数">编写 line_coverage_files(cfg) -&gt; list[str] 函数</h3>
<p>line_coverage_files 函数的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">line_coverage_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;指定需要覆盖的文件
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        cfg: 运行时配置，可通过它访问配置项，例如 cfg.rtl.version
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Return:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        返回统计代码行覆盖率的目标RTL文件名
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>在<code>build_ut_frontend_ifu_rvc_expander.py</code>文件中，<code>line_coverage_files</code>函数的定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">line_coverage_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;RVCExpander.v&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>标识该模块关注的是对<code>RVCExpander.v</code>文件的覆盖。如果要开启测试结果处理，还需要在<code>configs/_default.yaml</code>中的<code>doc-result</code>下<code>disable=False</code>（默认参数是<code>False</code>，也就是开启状态）;如果不开启测试结果处理则(<code>disable = True</code>)。注意，如果不开启测试结果处理，那么上述函数就不会被调用。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-53f38485d7ee0ef1d06f36fbe61bda5b">4.2 - 构建测试环境</h1>
    
	<h2 id="确定目录结构">确定目录结构</h2>
<p>UT(Unit Test, 单元测试)所在的目录位置的层级结构应该与名称一致，例如<code>frontend.ifu.rvc_expander</code>应当位于<code>ut_frontend/ifu/rvc_expander</code>目录，且每层目录都需要有<code>__init__.py</code>，便于通过 python 进行<code>import</code>。</p>
<p><strong>本章节的文件为<code>your_module_wrapper.py</code></strong>（如果你的模块是<code>rvc_expander</code>，那么文件就是<code>rvc_expander_wrapper.py</code>）。</p>
<p>wrapper 是包装的意思，也就是我们测试中需要用到的方法封装成和dut解耦合的API提供给测试用例使用。</p>
<p>*注：解耦合是为了测试用例和 DUT 解耦，使得测试用例可以独立于 DUT 进行编写和调试，也就是在测试用例中，不需要知道 DUT 的具体实现细节，只需要知道如何使用 API 即可。可以参照<a href="https://open-verify.cc/mlvp/docs/mlvp/canonical_env/#%E5%B0%86%E9%AA%8C%E8%AF%81%E4%BB%A3%E7%A0%81%E4%B8%8Edut%E8%BF%9B%E8%A1%8C%E8%A7%A3%E8%80%A6">将验证代码与DUT进行解耦</a></p>
<p>该文件应该放于<code>ut_frontend_or_backend/top_module/your_module/env</code>（这里依然以<code>rvc_expander</code>举例：<code>rvc_expander</code>属于前端，其顶层目录则应该是<code>ut_frontend</code>；<code>rvc_expander</code>的顶层模块是<code>ifu</code>，那么次级目录就是<code>ifu</code>;之后的就是<code>rvc_expander</code>自己了；最后，由于我们是在<strong>构建测试环境</strong>，再建一级<code>env</code>目录。将它们连起来就是：<code>ut_frontend_or_backend/top_module/your_module/env</code>）目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ut_frontend/ifu/rvc_expander
</span></span><span style="display:flex;"><span>├── classical_version
</span></span><span style="display:flex;"><span>│   ├── env
</span></span><span style="display:flex;"><span>│   │   ├── __init__.py
</span></span><span style="display:flex;"><span>│   │   └── rvc_expander_wrapper.py
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   └── test_rvc_expander.py
</span></span><span style="display:flex;"><span>├── __init__.py
</span></span><span style="display:flex;"><span>├── README.md
</span></span><span style="display:flex;"><span>└── toffee_version
</span></span><span style="display:flex;"><span>    ├── agent
</span></span><span style="display:flex;"><span>    │   └── __init__.py
</span></span><span style="display:flex;"><span>    ├── bundle
</span></span><span style="display:flex;"><span>    │   └── __init__.py
</span></span><span style="display:flex;"><span>    ├── env
</span></span><span style="display:flex;"><span>    │   ├── __init__.py
</span></span><span style="display:flex;"><span>    │   └── ref_rvc_expand.py
</span></span><span style="display:flex;"><span>    ├── __init__.py
</span></span><span style="display:flex;"><span>    └── <span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>        ├── __init__.py
</span></span><span style="display:flex;"><span>        ├── rvc_expander_fixture.py
</span></span><span style="display:flex;"><span>        └── test_rvc.py
</span></span></code></pre></div><p>这里<code>rvc_expander</code>目录下有<code>classical_version</code>传统版本和<code>toffee_version</code>使用toffee的版本。
传统版本就是使用<code>pytest</code>框架来进行测试，<code>toffee</code>只使用了其<code>Bundle</code>;而在toffee版本中，我们会使用更多<code>toffee</code>的特性。      <br>
一般来说，<strong>使用传统版本就已经可以覆盖绝大多数情况了</strong>，只有在传统版本不能满足需求时，才需要使用<code>toffee</code>版本。<br>
编写测试环境的时候，<strong>两个版本选择一个就行</strong>。<br>
模块（例如<code>rvc_expander</code>）中的代码目录结构由贡献者自行决定（我们写的时候并<strong>不需要再建一级<code>classical_version</code>或<code>toffee_version</code>目录</strong>），但需要满足 python 规范，且逻辑和命名合理。</p>
<h2 id="env-编写要求">Env 编写要求</h2>
<ul>
<li>需要进行 RTL 版本检查</li>
<li>Env 提供的 API 需要和引脚、时序无关</li>
<li>Env 提供的 API 需要稳定，不能随意进行接口/返回值修改</li>
<li>需要定义必要的 fixture</li>
<li>需要初始化功能检查点（功能检查点可以独立成一个模块）</li>
<li>需要进行覆盖率统计</li>
<li>需要有说明文档</li>
</ul>
<h2 id="编写测试环境传统版本">编写测试环境：传统版本</h2>
<p>在 UT 验证模块的测试环境中，目标是完成以下工作：</p>
<ol>
<li>对 DUT 进行功能封装，为测试提供稳定 API</li>
<li>定义功能覆盖率</li>
<li>定义必要 fixture 提供给测试用例</li>
<li>在合理时刻统计覆盖率</li>
</ol>
<p>以 IFU 环境中的 RVCExpander 为例（<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>）：</p>
<h3 id="1-dut-封装">1. DUT 封装</h3>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cover_group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cover_group</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cover_group</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTRVCExpander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 创建DUT</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 通过 Bundle 使用前缀关联引脚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>                 <span style="color:#8f5902;font-style:italic"># 把 Bundle 与 DUT 进行绑定</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instr</span>         <span style="color:#8f5902;font-style:italic"># 给DUT引脚赋值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;fsIsOff&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fsIsOff</span>  <span style="color:#8f5902;font-style:italic"># 给DUT引脚赋值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RefreshComb</span><span style="color:#000;font-weight:bold">()</span>              <span style="color:#8f5902;font-style:italic"># 推动组合电路</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cover_group</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>           <span style="color:#8f5902;font-style:italic"># 调用sample对功能覆盖率进行统计</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_bits&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ill&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>  <span style="color:#8f5902;font-style:italic"># 返回结果 和 是否是非法指令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>                         <span style="color:#8f5902;font-style:italic"># 获取当前状态</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;instr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#8f5902;font-style:italic"># 输入指令</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;decode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_bits&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic"># 返回展开结果</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ill&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic"># 输入是否非法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上述例子中，<code>class RVCExpander</code>对<code>DUTRVCExpander</code>进行了封装，对外提供了两个 API：</p>
<ul>
<li>expand(instr: int, fsIsOff: bool) -&gt; (int, int) ：该函数用于接受输入指令 instr 进行解码，返回（结果，非法指令标记）。如果非法指令标记不为 0，者说明输入指令非法。</li>
<li>stat() -&gt; dict(instr, decode, ilegal)：该函数用于返回当前的状态，其中包含当前的输入指令，解码结果以及非法指令标记。</li>
</ul>
<p>上述 API <strong>屏蔽了 DUT 的引脚</strong>，对外程序通用功能。</p>
<h3 id="2-定义功能覆盖率">2. 定义功能覆盖率</h3>
<p>尽可能的在 Env 中定义好功能覆盖率，如果有必要也可以在测试用例中定义覆盖率。toffee 功能覆盖率的定义请参考<a href="http://localhost:1313/docs/03_add_test/05_cover_func/">什么是功能覆盖率</a>。为了完善功能检查点和测试用例之间的对应关系，功能覆盖率定义完成后，需要在适合的位置进行检查点和测试用例的对应（测试点反标）。</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee.funcov</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">fc</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建功能覆盖率组</span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UT_FCOV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;../../../CLASSIC&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Add watch points to the RVCExpander module to collect function coverage information&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 1. Add point RVC_EXPAND_RET to check expander return value:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin ERROR. The instruction is not illegal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin SUCCE. The instruction is not expanded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 5. Reverse mark function coverage to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_M</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># get the module name</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">module_name_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;../../test_rv_decode&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#  - mark RVC_EXPAND_RET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#000">_M</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;test_rvc_expand_16bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_randomN&#34;</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>在上述代码中添加了名为<code>RVC_EXPAND_RET</code>的功能检查点来检查<code>RVCExpander</code>模块是否具有返回非法指令的能力。需要满足<code>ERROR</code>和<code>SUCCE</code>两个条件，即<code>stat()</code>中的<code>ileage</code>需要有<code>True</code>也需要有<code>False</code>值。在定义完检查点后，通过<code>mark_function</code>方法，对会覆盖到该检查的测试用例进行了标记。</p>
<h3 id="3-定义必要fixture">3. 定义必要fixture</h3>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">version_check</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_version_checker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;openxiangshan-kmh-*&#34;</span><span style="color:#000;font-weight:bold">)</span>             <span style="color:#8f5902;font-style:italic"># 指定满足要的RTL版本</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">version_check</span><span style="color:#000;font-weight:bold">()</span>                                                    <span style="color:#8f5902;font-style:italic"># 进行版本检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span>                                          <span style="color:#8f5902;font-style:italic"># 获取调用该fixture的测试用例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wave_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/rvc_expander_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.fst&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#8f5902;font-style:italic"># 设置波形文件路径</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/rvc_expander_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.dat&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">fname</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 设置代码覆盖率文件路径</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_dir</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dirname</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">makedirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coverage_dir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist_ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>                           <span style="color:#8f5902;font-style:italic"># 目标目录不存在则创建目录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">wave_file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                                                       <span style="color:#8f5902;font-style:italic"># 创建RVCExpander</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_in</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>                                    <span style="color:#8f5902;font-style:italic"># 设置io_in引脚的写入时机为立即写入             </span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_fsIsOff</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>                               <span style="color:#8f5902;font-style:italic"># 设置io_fsIsOff引脚的写入时机为立即写入  </span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>                              <span style="color:#8f5902;font-style:italic"># 初始化功能检查点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">expander</span>                                                     <span style="color:#8f5902;font-style:italic"># 返回创建好的 RVCExpander 给 Test Case</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>                                              <span style="color:#8f5902;font-style:italic"># Tests Case运行完成后，结束DUT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">)</span>                          <span style="color:#8f5902;font-style:italic"># 把生成的代码覆盖率文件告诉 toffee-report</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_func_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>                                      <span style="color:#8f5902;font-style:italic"># 把生成的功能覆盖率数据告诉 toffee-report</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">()</span>                                                          <span style="color:#8f5902;font-style:italic"># 清空功能覆盖统计</span>
</span></span></code></pre></div><p>上述 fixture 完成了以下功能：</p>
<ol>
<li>进行 RTL 版本检查，如果不满足<code>&quot;openxiangshan-kmh-*&quot;</code>要求，则跳过调用改 fixture 的测试用例</li>
<li>创建 DUT，并指定了波形，代码行覆盖率文件路径（路径中含有调用该 fixure 的用例名称：fname）</li>
<li>调用<code>init_rvc_expander_funcov</code>添加功能覆盖点</li>
<li>结束 DUT，处理代码行覆盖率和功能覆盖率（发往 toffee-report 进行处理）</li>
<li>清空功能覆盖率</li>
</ol>
<p>*注：在 PyTest 中，执行测试用例<code>test_A(rvc_expander, ....)</code>前（<strong>rvc_expander是我们在使用fixure装饰器时定义的方法名</strong>），会自动调用并执行<code>rvc_expander(request)</code>中<code>yield</code>关键字前的部分（相当于初始化），然后通过<code>yield</code>返回<code>rvc_expander</code>调用<code>test_A</code>用例（<strong>yield返回的对象，在测试用例里就是我们fixture下定义的方法名</strong>），用例执行完成后，再继续执行<code>fixture</code>中<code>yield</code>关键字之后的部分。比如：参照下面统计覆盖率的代码，倒数第四行的
<code>rvc_expand(rvc_expander, generate_rvc_instructions(start, end))</code>，其中的<code>rvc_expander</code>就是我们在<code>fixture</code>中定义的方法名，也就是<code>yield</code>返回的对象。</p>
<h3 id="4-统计覆盖率">4. 统计覆盖率</h3>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#000">T</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TAG_LONG_TIME_RUN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.parametrize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start,end&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#000;font-weight:bold">[(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)])</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with a full compressed instruction set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Description:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        Perform an expand check on 16-bit compressed instructions within the range from &#39;start&#39; to &#39;end&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Add check point: RVC_EXPAND_RANGE to check expander input range.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#   When run to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dynamic_bin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Reverse mark function to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Drive the expander and check the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">generate_rvc_instructions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># When go to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>                                                              <span style="color:#8f5902;font-style:italic"># 覆盖率采样</span>
</span></span></code></pre></div><p>在定义了覆盖率之后，还需要在测试用例中进行覆盖率统计。上述代码中，在测试用例中使用<code>add_watch_point</code>添加了一个功能检查点<code>rvc_expander</code>，并在后面进行了标记和采样,而且在最后一样对覆盖率进行了采样。
覆盖率采样，实际上是通过回调函数触发了一次<code>add_watch_point</code>中bins的判断，当其中bins的判断结果为<code>True</code>时，就会统计一次Pass。</p>
<h2 id="编写测试环境toffee版本">编写测试环境：toffee版本</h2>
<p>使用python语言进行的测试可以通过引入我们的开源测试框架<a href="https://github.com/XS-MLVP/toffee">toffee</a>来得到更好的支持。</p>
<p>toffee的官方教程可以参考<a href="https://open-verify.cc/mlvp/docs/mlvp/">这里</a>。</p>
<h3 id="bundle快捷dut封装">bundle：快捷DUT封装</h3>
<p>toffee通过Bundle实现了对DUT的绑定。toffee提供了多种建立Bundle与DUT绑定的方法。相关代码</p>
<h4 id="手动绑定">手动绑定</h4>
<p>toffee框架下，用于支持绑定引脚的最底层类是Signal，其通过命名匹配的方式和DUT中的各个引脚进行绑定。相关代码参照<code>ut_frontend/ifu/rvc_expander/toffee_version</code>。</p>
<p>以最简单的RVCExpander为例，其io引脚形如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">RVCExpander</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">input</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_in</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">input</span>         <span style="color:#000">io_fsIsOff</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_out_bits</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">output</span>        <span style="color:#000">io_ill</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>一共四个信号，io_in, io_fsIsOff, io_out_bits, io_ill。我们可以抽取共同的前缀，比如&quot;io_&quot;（不过由于in在python中有其他含义，其不能直接作为变量名，虽然可以使用setattr 和getattr方法来规避这个问题，但是出于代码简洁的考虑，我们只选取&quot;io&quot;作为前缀），将后续部分作为引脚名定义在对应的Bundle类中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpanderIOBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_fsIsOff</span> <span style="color:#000;font-weight:bold">,</span><span style="color:#000">_out_bits</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">_ill</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>然后在更高一级的Env或者Bundle中，采取from_prefix的方式完成前缀的绑定：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpanderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RVCExpanderIOBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h4 id="自动定义bundle">自动定义Bundle</h4>
<p>实际上，Bundle类的定义也不一定需要写明，可以仅仅通过前缀绑定：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io_&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 通过 Bundle 使用前缀关联引脚</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>   
</span></span></code></pre></div><p>如果Bundle的from_prefix方法传入dut，其将根据前缀和DUT的引脚名自动生成引脚的定义，而在访问的时候，使用dict访问的思路即可：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instr</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;fsIsOff&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span></code></pre></div><h4 id="bundle代码生成">Bundle代码生成</h4>
<p>toffee框架的<a href="https://github.com/XS-MLVP/toffee/tree/master/scripts">scripts</a>提供了两个脚本。</p>
<p>bundle_code_gen.py脚本主要提供了三个方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_regex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">regex</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">):</span>
</span></span></code></pre></div><p>通过传入dut和生成规则（包括dict、prefix、regex三种），自动生成对应的bundle代码。</p>
<p>而bundle_code_intel_gen.py则解析picker生成的signals.json文件，自动生成层次化的bundle代码。可以直接在命令行调用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python bundle_code_intel_gen.py <span style="color:#ce5c00;font-weight:bold">[</span>signal<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>target<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>如发现自动生成脚本存在bug，欢迎提issue以便我们修正。</p>
<h3 id="agent驱动方法">Agent：驱动方法</h3>
<p>如果说Bundle是将DUT的数据职责进行抽象的话，那么Agent则是将DUT的行为职责封装为一个个接口。简单地说，Agent通过封装多个对外开放的方法，将多组IO操作抽象为一个具体的行为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpanderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">RVCExpanderIOBundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_method</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">):</span>             <span style="color:#8f5902;font-style:italic"># 传入参数：RVC指令和fs.status使能情况</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_in</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">instr</span>                   <span style="color:#8f5902;font-style:italic"># 引脚赋值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_fsIsOff</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fsIsOff</span>            <span style="color:#8f5902;font-style:italic"># 引脚赋值</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">()</span>                        <span style="color:#8f5902;font-style:italic"># 推动时钟</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_out_bits</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>             <span style="color:#8f5902;font-style:italic"># 返回值：扩展后指令</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_ill</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>                  <span style="color:#8f5902;font-style:italic"># 返回值：指令合法校验</span>
</span></span></code></pre></div><p>譬如，RVCExpander的指令扩展功能接收输入的指令（可能为RVI指令，也可能为RVC指令）和CSR对fs.status的使能情况。我们将这个功能抽象为expand方法，提供除self以外的两个参数。同时，指令扩展最终将会返回传入指令对应的RVI指令和该指令是否合法的判断，对应地，该方法也返回这两个值。</p>
<h3 id="env测试环境">Env：测试环境</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RVCExpanderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">DUTRVCExpander</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_in</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>        
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_fsIsOff</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>   <span style="color:#8f5902;font-style:italic"># 设置引脚写入时机</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpanderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RVCExpanderIOBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;io&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># 补全前缀，绑定DUT</span>
</span></span></code></pre></div><h3 id="覆盖率定义">覆盖率定义</h3>
<p>定义覆盖率组的方式和前述方式类似，这里就不再赘述了。</p>
<h3 id="测试套件定义">测试套件定义</h3>
<p>测试套件的定义略有不同：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@toffee_test.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toffee_request</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">toffee_test</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ToffeeRequest</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">asyncio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">version_check</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toffee_request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_dut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTRVCExpander</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">start_clock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee_request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_cov_groups</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">gr</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expander</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RVCExpanderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">expander</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cur_loop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_event_loop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">task</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">all_tasks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cur_loop</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__clock_loop&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">task</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">task</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CancelledError</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">break</span>
</span></span></code></pre></div><p>由于toffee提供了更强大的测试覆盖率管理功能，因此不需要手动设置行覆盖率。同时，由于toffee的时钟机制，建议在套件代码最后额外检查任务是否全部结束。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4cd74e2d3f7d9b1031b77dd328511afa">4.3 - 添加测试用例</h1>
    
	<h2 id="命名要求">命名要求</h2>
<p>所有测试用例文件请以<code>test_*.py</code>的方式进行命名，<code>*</code>用测试目标替换（例如<code>test_rvc_expander.py</code>）。所有测试用例也需要以<code>test_</code>前缀开头。用例名称需要具有明确意义。</p>
<p>命名举例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_a</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#8f5902;font-style:italic"># 不合理，无法通过a判断测试目标</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#8f5902;font-style:italic"># 合理，可以通过用例名称大体知道测试内容</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><h2 id="使用-assert">使用 Assert</h2>
<p>在每个测试用例中，都需要通过<code>assert</code>来判断本测试是否通过。
<code>pytest</code>统计的是<code>assert</code>语句的结果，因此<code>assert</code>语句需要保证能够通过。</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_32bit</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;compare the RVC expand result with the reference
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        rvc_expander (warpper): the fixture of the RVC expander
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ref_insts (list[int]]): the reference instruction list
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">insn</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">disasmbly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rvc_expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is_32bit</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error, 32bit instruction need to be the same&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 1, dut: 0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">,disasm:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn_disasm</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 0, dut: 1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">find_error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error (</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06"> errros)&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">find_error</span>
</span></span></code></pre></div><h2 id="编写注释">编写注释</h2>
<p>每个测试用例都需要添加必要的说明和注释，需要满足<a href="https://peps.python.org/pep-0257/">Python 注释规范</a>。</p>
<p>测试用例说明参考格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">type_a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">type_b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test abstract
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        a (type_a): description of arg a.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        b (type_b): description of arg b.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Detailed test description here (if need).
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><h2 id="用例管理">用例管理</h2>
<p>为了方便测试用例管理，可通过 toffee-test 提供的<code>@pytest.mark.toffee_tags</code>标签功能，请参考
本网站的<a href="https://open-verify.cc/UnityChipForXiangShan/docs/98_others/">其他</a>部分和<a href="https://github.com/XS-MLVP/toffee-test/blob/master/README_zh.md#%E7%AE%A1%E7%90%86%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E8%B5%84%E6%BA%90">toffee-test</a>。</p>
<h2 id="参考用例">参考用例</h2>
<p>如果很多测试用例（Test）具有相同的操作，该公共操作部分可以提炼成一个通用函数。以 RVCExpander 验证为例，可以把压缩指令的展开与参考模型（disasm）的对比封装成以下函数：</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_32bit</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;compare the RVC expand result with the reference
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        rvc_expander (warpper): the fixture of the RVC expander
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ref_insts (list[int]]): the reference instruction list
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">insn</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">ref_insts</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">disasmbly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rvc_expander</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fsIsOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is_32bit</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">insn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error, 32bit instruction need to be the same&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 1, dut: 0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">and</span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_ex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">instr_filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insn_disasm</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">):</span> 
</span></span><span style="display:flex;"><span>                <span style="color:#000">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;find bad inst:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">,disasm:</span><span style="color:#4e9a06">{</span><span style="color:#000">insn_disasm</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ref: 0, dut: 1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">find_error</span> <span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">find_error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;RVC expand error (</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06"> errros)&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">find_error</span>
</span></span></code></pre></div><p>在上述公共部分中有 assert，因此调用该函数的 Test 也能提过该 assert 判断运行结果是否提过。</p>
<p>在测试用例的开发过程中，通常存在大量的调试工作，为了让验证环境快速就位，需要编写一些“冒烟测试”进行调试。RVCExpander 展开 16 位压缩指令的冒烟测试如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TAG_SMOKE</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_smoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with 1 compressed instruction&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">generate_rvc_instructions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">101</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>为了方便进行管理，上述测试用例通过<code>toffee_tags</code>标记上了 SMOKE 标签。它的输入参数为<code>rvc_expander</code>，则在在运行时，会自动调用对应同名的<code>fixture</code>进行该参数的填充。</p>
<p>RVCExpander 展开 16 位压缩指令的测试目标是对 2^16 所有压缩指令进行遍历，检测所有情况是否都与参考模型 disasm 一致。在实现上，如果仅仅用一个 Test 进行遍历，则需要耗费大量时间，为此我们可以利用 PyTest 提供的<code>parametrize</code>对 test 进行参数化配置，然后通过<code>pytest-xdist</code>插件并行执行：</p>
<p>以下内容位于<code>ut_frontend/ifu/rvc_expander/classical_version/test_rvc_expander.py</code>中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#000">T</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TAG_LONG_TIME_RUN</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.parametrize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start,end&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#000;font-weight:bold">[(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)])</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with a full compressed instruction set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Description:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        Perform an expand check on 16-bit compressed instructions within the range from &#39;start&#39; to &#39;end&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Add check point: RVC_EXPAND_RANGE to check expander input range.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#   When run to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Reverse mark function to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_16B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_rvc_expand_16bit_full</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Drive the expander and check the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">generate_rvc_instructions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>在上述用例中定义了参数化参数<code>start</code>, <code>end</code>，用来指定压缩指令的开始值和结束值，然后通过装饰器<code>@pytest.mark.parametrize</code>对他们进行分组赋值。变量 N 可以指定将目标数据进行分组的组数，默认设置为 10 组。在运行时用例<code>test_rvc_expand_16bit_full</code>会展开为<code>test_rvc_expand_16bit_full[0-6553]</code>至<code>test_rvc_expand_16bit_full[58977-65536]</code>10 个测试用例运行。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6c51e44e9add2a2d66a22a310fc796b">4.4 - 代码覆盖率</h1>
    
	<p>代码覆盖率是一项评价指标，它衡量了被测代码中哪些部分被执行了，哪些部分没有被执行。通过统计代码覆盖率，可以评估测试的有效性和覆盖程度。</p>
<p>代码覆盖率包括：</p>
<ul>
<li>行覆盖率(line coverage): 被测代码中被执行的行数，最简单的指标，一般期望达到 100%。</li>
<li>条件覆盖率(branch coverage): 每一个控制结构的每个分支是否均被执行。例如，给定一个 if 语句，其 true 和 false 分支是否均被执行？</li>
<li>有限状态机覆盖率(fsm coverage): 状态机所有状态是否都达到过。</li>
<li>翻转覆盖率(toggle coverage): 统计被测代码中被执行的翻转语句，检查电路的每个节点是否都有 0 -&gt; 1 和 1 -&gt; 0 的跳变。</li>
<li>路径覆盖率(path coverage): 检查路径的覆盖情况。在 always 语句块和 initial 语句块中，有时会使用 if &hellip; else 和 case 语句，在电路结构上便会产生一系列的数据路径。。</li>
</ul>
<p>*我们主要使用的模拟器是 Verilator,优先考虑<strong>行覆盖率</strong>。Verilator 支持覆盖率统计，因此我们在构建 DUT 时，如果要开启覆盖率统计，需要在编译选项中添加<code>-c</code>参数。</p>
<h2 id="本项目中相关涉及位置">本项目中相关涉及位置</h2>
<p>开启覆盖率需要在编译时（使用 picker 命令时）加上“-c”参数（参考 picker 的<a href="https://github.com/XS-MLVP/picker/blob/master/README.zh.md#%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A">参数解释</a>），同时在文件中设置启用行覆盖率，这样在使用 toffee 测试时，才能够生成覆盖率统计文件。</p>
<p>结合上面的描述，在本项目中也就是编译，编写和启用行覆盖率函数和测试的时候会涉及到代码覆盖率：</p>
<h3 id="添加编译脚本部分">添加编译脚本部分</h3>
<p><a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/#编写-buildcfg---bool-函数">编写编译脚本</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 省略前面</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut/RVCExpander&#34;</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Exporting RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#39;picker export --cp_lib false </span><span style="color:#4e9a06">{</span><span style="color:#000">get_rtl_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rtl/RVCExpander.sv&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                                                              <span style="color:#4e9a06">}</span><span style="color:#4e9a06"> --lang python --tdir </span><span style="color:#4e9a06">{</span><span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dut&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/ -w rvc.fst -c&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to export RVCExpander.sv: </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 省略后面</span>
</span></span></code></pre></div><p>在<code>s, out, err=...</code>这一行，我们使用 picker 命令，并且开启代码了覆盖率(命令最后的&quot;-c&quot;参数)。</p>
<p><a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/#编写-line_coverage_filescfg---liststr-函数">设置目标覆盖文件(line_coverage_files 函数)</a></p>
<p>按照需求编写<code>line_coverage_files(cfg) -&gt; list[str]</code>函数，并且开启测试结果处理(<code>doc_result.disable = False</code>)让其被调用。</p>
<h3 id="构建测试环境部分">构建测试环境部分</h3>
<p><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#3-定义必要fixture">定义必要 fixture</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">)</span>                          <span style="color:#8f5902;font-style:italic"># 把生成的代码覆盖率文件告诉 toffee-report</span>
</span></span></code></pre></div><p>通过函数<code>toffee-test.set_line_coverage</code>把覆盖率文件传递给 toffe-test，这样其才能够收集数据，以便于后面生成的报告带有行覆盖率。</p>
<h2 id="忽略指定统计">忽略指定统计</h2>
<p>有时候，我们可能需要手动指定某些内容不参与覆盖率统计。例如有些是不需要被统计的，有些统计不到是正常的。这时候我们就可以忽略这些内容，这对优化覆盖率报告或调试非常有帮助。
目前我们的框架可以使用两种方式来实现忽略统计的功能：</p>
<h3 id="1通过-verilator-指定忽略统计的内容">1.通过 verilator 指定忽略统计的内容</h3>
<h4 id="使用-verilator_coverage_offon-指令">使用 verilator_coverage_off/on 指令</h4>
<p>Verilator 支持通过注释指令来忽略特定代码段的覆盖率统计。例如，使用如下的指令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// *verilator coverage_off*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 忽略统计的代码段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// *verilator coverage_on*
</span></span></span></code></pre></div><p>举个例子</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">example</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// *verilator coverage_off*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">debug_signal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">$display</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;This is for debugging only&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// *verilator coverage_on*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">enable</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">do_something</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>在上述示例中，debug_signal 部分的代码将不会计入覆盖率统计，而 enable 部分仍然会被统计。</p>
<p>更多 verilator 的忽略统计方式请参照<a href="https://veripool.org/guide/latest/exe_verilator.html#configuration-files">verilator 官方文档</a></p>
<h3 id="2通过-toffee-指定需要过滤掉的内存">2.通过 toffee 指定需要过滤掉的内存</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">datfile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignore</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[]):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Pass
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        request (pytest.Request): Pytest的默认fixture，
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        datfile (string): DUT生成的
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        ignore (list[str]): 覆盖率过滤文件/或者文件夹
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><p>ignore 参数可以指定在覆盖率文件中需要过滤掉的内容，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scripts/frontend_ifu_rvc_expander&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>在统计覆盖率时，会在&quot;scripts/frontend_ifu_rvc_expander&quot;目录中搜索到<code>line_coverage.ignore</code>文件，然后按其中每行的通配符进行过滤。</p>
<pre tabindex="0"><code class="language-ignore" data-lang="ignore"># Line covarge ignore file
# ignore Top file
*/RVCExpander_top*%
</code></pre><p>上述文件表示，在统计覆盖率时，会忽略掉包含&quot;RVCExpander_top&quot;关键字的文件（实际上是收集了对应的数据，但是最后统计的时候忽略了）。</p>
<h2 id="查看统计结果">查看统计结果</h2>
<p>在经过前面所有步骤之后，包括准备测试环境中的<a href="/UnityChipForXiangShan/docs/01_verfiy_env/#下载rtl代码">下载 RTL 代码</a>、<a href="/UnityChipForXiangShan/docs/01_verfiy_env/#编译DUT">编译 DUT</a>、<a href="/UnityChipForXiangShan/docs/01_verfiy_env/#编辑配置">编辑配置</a>
；添加测试中的<a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/">添加编译脚本</a>,<a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/">构建测试环境</a>、<a href="/UnityChipForXiangShan/docs/03_add_test/03_add_test/">添加测试用例</a>。</p>
<p>现在<a href="/UnityChipForXiangShan/docs/02_run_test/">运行测试</a>,之后就默认在<code>out/report</code>目录会生成 html 版本的测试报告。</p>
<p>也可以在<a href="https://open-verify.cc/UnityChipForXiangShan/docs/">进度概述</a>图形下方的“当前版本”选择对应的测试报告(按照测试时间命名)，然后点击右侧链接即可查看统计结果。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2938880e10d36d978ade908698b9760">4.5 - 功能覆盖率</h1>
    
	<p>功能覆盖率（Functional Coverage）是一种<strong>用户定义</strong>的度量标准，用于度量验证中已执行的设计规范的比例。功能覆盖率关注的是设计的功能和特性是否被测试用例覆盖到了。</p>
<p>反标是指将功能点与测试用例对应起来。这样，在统计时，就能看到每个功能点对应了哪些测试用例，从而方便查看哪些功能点用的测试用例多，哪些功能点用的测试用例少，有利于后期的测试用例优化。</p>
<h2 id="本项目中相关涉及位置">本项目中相关涉及位置</h2>
<p>功能覆盖率需要我们先定义了才能统计，主要是在构建测试环境的时候涉及。</p>
<p>在<a href="https://open-verify.cc/UnityChipForXiangShan/docs/03_add_test/02_build_env/">构建测试环境</a>中：</p>
<ul>
<li><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#2-定义功能覆盖率">定义功能覆盖率</a>： 创建了功能覆盖率组,添加观察点和反标</li>
<li><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#3-定义必要fixture">定义必要 fixture</a>： 把统计结果传递给 toffee-report</li>
<li><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/#4-统计覆盖率">统计覆盖率</a>： 添加观察点和反标</li>
</ul>
<p>其他：</p>
<ul>
<li>在 Test case 中使用，可以在每个测试用例里也编写一个功能点。</li>
</ul>
<h2 id="功能覆盖率使用流程">功能覆盖率使用流程</h2>
<h3 id="指定-group-名称">指定 Group 名称</h3>
<p>测试报告通过 Group 名字和 DUT 名字进行匹配，利用 comm.UT_FCOV 获取 DUT 前缀，例如在 Python 模块<code>ut_frontend/ifu/rvc_expander/classical_version/env/rvc_expander_wrapper.py</code>中进行如下调用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UT_FCOV</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 本模块名为：ut_frontend.ifu.rvc_expander.classical_version.env.rvc_expander_wrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过../../../去掉了classical_version和上级模块env，rvc_expander_wrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># UT_FCOV会默认去掉前缀 ut_</span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UT_FCOV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;../../../CLASSIC&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># name = UT_FCOV(&#34;../../../CLASSIC&#34;)</span>
</span></span></code></pre></div><p>name 的值为<code>frontend.ifu.rvc_expander.CLASSIC</code>，在最后统计结果时，会按照最长前缀匹配到目标 UT（即匹配到：frontend.ifu.rvc_expander 模块）</p>
<h3 id="创建覆盖率组">创建覆盖率组</h3>
<p>使用<code>toffee</code>的<code>funcov</code>可以创建覆盖率组。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee.funcov</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">fc</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用上面指定的GROUP名字</span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这两步也可以合成一句<code>g = fc.CovGroup(UT_FCOV(&quot;../../../CLASSIC&quot;))</code>。
创建的g对象就表示了一个功能覆盖率组，可以使用其来提供观察点和反标。</p>
<h3 id="添加观察点和反标">添加观察点和反标</h3>
<p>在每个测试用例内部，可以使用<code>add_watch_point</code>（<code>add_cover_point</code>是其别名，二者完全一致）来添加观察点和<code>mark_function</code>来添加反标。
观察点是，当对应的信号触发了我们在观察点内部定义的要求后，这个观察点的名字（也就是功能点）就会被统计到功能覆盖率中。
反标是，将功能点和测试用例进行关联，这样在统计时，就能看到每个功能点对应了哪些测试用例。</p>
<p>对于观察点的位置，需要根据实际情况来定，一般来说，在测试用例外直接添加观察点是没有问题的。
不过有时候我们可以更加的灵活。</p>
<ol>
<li>在测试用例之外（<code>decode_wrapper.py</code>中）</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">init_rvc_expander_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Add watch points to the RVCExpander module to collect function coverage information&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 1. Add point RVC_EXPAND_RET to check expander return value:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin ERROR. The instruction is not illegal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#    - bin SUCCE. The instruction is not expanded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stat</span><span style="color:#000;font-weight:bold">()[</span><span style="color:#4e9a06">&#34;ilegal&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 5. Reverse mark function coverage to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_M</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># get the module name</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">module_name_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;../../test_rv_decode&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#  - mark RVC_EXPAND_RET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_RET&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">_M</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;test_rvc_expand_16bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_full&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                              <span style="color:#4e9a06">&#34;test_rvc_expand_32bit_randomN&#34;</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">bin_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ERROR&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SUCCE&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># The End                                                                              </span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">None</span> 
</span></span></code></pre></div><p>这个例子的第一个<code>g.add_watch_point</code>是放在测试用例之外的，因为它和现有的测试用例没有直接关系，放在测试用例之外反而更加方便。添加观察点之后，只要<code>add_watch_point</code>方法中的<code>bins</code>条件触发了，我们的<code>toffee-test</code>框架就能够收集到对应的功能点。</p>
<ol start="2">
<li>在测试用例之中（<code>test_rvc_expander.py</code>中）</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">32</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">TAG_LONG_TIME_RUN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TAG_RARELY_USED</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.parametrize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start,end&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#000;font-weight:bold">[(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)])</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_rvc_expand_32bit_full</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;Test the RVC expand function with a full 32 bit instruction set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Description:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        Randomly generate N 32-bit instructions for each check, and repeat the process K times.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Add check point: RVC_EXPAND_ALL_32B to check instr bits.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;RANGE[</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">-</span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06">]&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_32B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dynamic_bin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Reverse mark function to the check point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mark_function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RVC_EXPAND_ALL_32B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">test_rvc_expand_32bit_full</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Drive the expander and check the result</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rvc_expand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rvc_expander</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">end</span><span style="color:#000;font-weight:bold">)]))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># When go to here, the range[start, end] is covered</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">covered</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>这个例子的观察点在测试用例里面，因为这里的<code>start</code>和<code>end</code>是由<code>pytest.mark.parametrize</code>来决定的，数值不是固定的，所以我们需要在测试用例里面添加观察点。</p>
<h3 id="采样">采样</h3>
<p>在上一个例子的最后，我们调用了<code>g.sample()</code>，这个函数的作用是告诉<code>toffee-test</code>，<code>add_watch_point</code>里的<code>bins</code>已经执行过了，判断一下是不是True，是的话就为这个观察点记录一次Pass。</p>
<p>有手动就有自动。我们可以在构建测试环境时，在定义fixture中加入<code>StepRis(lambda x: g.sample())</code>,这样就会在每个时钟周期的上升沿自动采样。</p>
<p>以下内容来自<code>ut_backend/ctrl_block/decode/env/decode_wrapper.py </code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">decoder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># before test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_rv_decoder_funcov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">func_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># If the output directory does not exist, create it</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">output_dir_path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/log&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">makedirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">output_dir_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist_ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTDecodeStage</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/decode_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.fst&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">func_name</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coverage_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/decode_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.dat&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">func_name</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clock&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">decoder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># after test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">decoder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_out_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decoder/decode_</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">.dat&#34;</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">func_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">FileNotFoundError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;File not found: </span><span style="color:#4e9a06">{</span><span style="color:#000">coverage_file</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coverage_file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_root_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scripts/backend_ctrlblock_decode&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_func_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>如上面所示，我们在<code>yield</code>之前调用了<code>g.sample()</code>，这样就会在每个时钟周期的上升沿自动采样。</p>
<p><code>StepRis</code>函数的作用是在每个时钟周期的上升沿执行传入的函数，详情可参照<a href="https://open-verify.cc/mlvp/docs/env_usage/picker_usage/">picker使用介绍</a></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-07ebcfe55daf3596c9e3470979e4e81e">5 - 如何参与本项目</h1>
    
	<h3 id="如何提交bug">如何提交Bug</h3>
<p>按 ISSUE 模板进行提交，标记上对应的标签（bug，bug等级等）</p>
<p>对应模块的维护者进行检查，并修改他给出的标记和香山分支</p>
<h3 id="如何提交文档">如何提交文档</h3>
<p>本仓库文档以PR的形式在本仓库提交，DUT文档在仓库<a href="https://github.com/XS-MLVP/UnityChipForXiangShan/tree/main/documents/content/zh-cn/docs/98_UT">UnityChipForXiangShan/documents/content/zh-cn/docs/98_UT</a>中进行提交。</p>
<p>本项目欢迎任何人以<a href="https://github.com/XS-MLVP/UnityChipForXiangShan/issues"><code>ISSUE</code></a>、<a href="https://github.com/XS-MLVP/env-xs-ov-00-bpu/discussions"><code>DISCUSS</code></a>、<a href="https://github.com/XS-MLVP/UnityChipForXiangShan/fork"><code>Fork</code></a>、<a href="https://github.com/XS-MLVP/env-xs-ov-00-bpu/pulls"><code>PR</code></a>的方式参与。</p>
<p>万众一芯QQ交流群：</p>
<image src="600480230.jpg" alter="600480230" width=300px />

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1d0ac3d7094a9a644440034e44c77115">6 - 模板-PR</h1>
    
	<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"># Description
</span></span></span><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Please include a summary of the changes and the related issue. 
</span></span><span style="display:flex;"><span>Please also include relevant motivation and context. 
</span></span><span style="display:flex;"><span>List any dependencies that are required for this change.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Fixes # (issue)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Type of change
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Please delete options that are not relevant.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Bug fix (non-breaking change which fixes an issue)
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> New feature (non-breaking change which adds functionality)
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Breaking change (fix or feature that would cause existing functionality to not work as expected)
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> This change requires a documentation update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"># How Has This Been Tested?
</span></span></span><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Please describe the tests that you ran to verify your changes. Provide instructions so we can reproduce. 
</span></span><span style="display:flex;"><span>Please also list any relevant details for your test configuration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Test A
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [x]</span> Test B
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">**Test Configuration**</span>:
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Firmware version:
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Hardware:
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> Toolchain:
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">*</span> SDK:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"># Checklist:
</span></span></span><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> My code follows the style guidelines of this project
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> I have performed a self-review of my code
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> I have commented my code, particularly in hard-to-understand areas
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> I have made corresponding changes to the documentation
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> My changes generate no new warnings
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> I have added tests that prove my fix is effective or that my feature works
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> New and existing unit tests pass locally with my changes
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Any dependent changes have been merged and published in downstream modules
</span></span></code></pre></div><p>展示效果如下：</p>
<h1 id="description">Description</h1>
<p>Please include a summary of the changes and the related issue. Please also include relevant motivation
and context. List any dependencies that are required for this change.</p>
<p>Fixes # (issue)</p>
<h2 id="type-of-change">Type of change</h2>
<p>Please delete options that are not relevant.</p>
<ul>
<li><input disabled="" type="checkbox"> Bug fix (non-breaking change which fixes an issue)</li>
<li><input disabled="" type="checkbox"> New feature (non-breaking change which adds functionality)</li>
<li><input disabled="" type="checkbox"> Breaking change (fix or feature that would cause existing functionality to not work as expected)</li>
<li><input disabled="" type="checkbox"> This change requires a documentation update</li>
</ul>
<h1 id="how-has-this-been-tested">How Has This Been Tested?</h1>
<p>Please describe the tests that you ran to verify your changes. Provide instructions so we can reproduce.
Please also list any relevant details for your test configuration</p>
<ul>
<li><input disabled="" type="checkbox"> Test A</li>
<li><input checked="" disabled="" type="checkbox"> Test B</li>
</ul>
<p><strong>Test Configuration</strong>:</p>
<ul>
<li>Firmware version:</li>
<li>Hardware:</li>
<li>Toolchain:</li>
<li>SDK:</li>
</ul>
<h1 id="checklist">Checklist:</h1>
<ul>
<li><input disabled="" type="checkbox"> My code follows the style guidelines of this project</li>
<li><input disabled="" type="checkbox"> I have added the appropriate labels</li>
<li><input disabled="" type="checkbox"> I have performed a self-review of my code</li>
<li><input disabled="" type="checkbox"> I have commented my code, particularly in hard-to-understand areas</li>
<li><input disabled="" type="checkbox"> I have made corresponding changes to the documentation</li>
<li><input disabled="" type="checkbox"> My changes generate no new warnings</li>
<li><input disabled="" type="checkbox"> I have added tests that prove my fix is effective or that my feature works</li>
<li><input disabled="" type="checkbox"> New and existing unit tests pass locally with my changes</li>
<li><input disabled="" type="checkbox"> Any dependent changes have been merged and published in downstream modules</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4efe7d3d46d7929f2a2b248110be165b">7 - 模板-ISSUE</h1>
    
	<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Description
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>A brief description of the issue.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Steps to Reproduce
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">1.</span> Describe the first step
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">2.</span> Describe the second step
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">3.</span> Describe the third step
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">4.</span> ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Expected Result
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Describe what you expected to happen.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Actual Result
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Describe what actually happened.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Screenshots
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>If applicable, add screenshots to help explain your problem.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Environment
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">-</span> OS: [e.g. Windows 10, macOS 10.15, Ubuntu 20.04]
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">-</span> Browser: [e.g. Chrome 86, Firefox 82, Safari 14]
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">-</span> Version: [e.g. 1.0.0]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## Additional Information
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>Add any other context about the problem here.
</span></span></code></pre></div><p>展示效果如下：</p>
<h2 id="description">Description</h2>
<p>A brief description of the issue.</p>
<h2 id="steps-to-reproduce">Steps to Reproduce</h2>
<ol>
<li>Describe the first step</li>
<li>Describe the second step</li>
<li>Describe the third step</li>
<li>&hellip;</li>
</ol>
<h2 id="expected-result">Expected Result</h2>
<p>Describe what you expected to happen.</p>
<h2 id="actual-result">Actual Result</h2>
<p>Describe what actually happened.</p>
<h2 id="screenshots">Screenshots</h2>
<p>If applicable, add screenshots to help explain your problem.</p>
<h2 id="environment">Environment</h2>
<ul>
<li>OS: [e.g. Windows 10, macOS 10.15, Ubuntu 20.04]</li>
<li>Browser: [e.g. Chrome 86, Firefox 82, Safari 14]</li>
<li>Version: [e.g. 1.0.0]</li>
</ul>
<h2 id="additional-information">Additional Information</h2>
<p>Add any other context about the problem here.</p>
<h2 id="checklist">Checklist</h2>
<ul>
<li><input disabled="" type="checkbox"> I have searched the existing issues</li>
<li><input disabled="" type="checkbox"> I have added the appropriate labels</li>
<li><input disabled="" type="checkbox"> I have reproduced the issue with the latest version</li>
<li><input disabled="" type="checkbox"> I have provided a detailed description of the bug</li>
<li><input disabled="" type="checkbox"> I have provided steps to reproduce the issue</li>
<li><input disabled="" type="checkbox"> I have included screenshots (if applicable)</li>
<li><input disabled="" type="checkbox"> I have provided the environment details (OS, version, etc.)</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-68658f28e70d830f706f538c1d44b165">8 - 模板-UT-README</h1>
    
	<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"># 模块名称
</span></span></span><span style="display:flex;"><span><span style="color:#000080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 测试目标
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">测试目标</span><span style="color:#a40000">、</span><span style="color:#c4a000">测试方法描述</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 测试环境
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">测试环境描述</span><span style="color:#a40000">，</span><span style="color:#c4a000">依赖描述</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 功能检测
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">给出目标待测功能与对应的检测方法</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>|序号|所属模块|功能描述|检查点描述|检查标识|检查项|
</span></span><span style="display:flex;"><span>|-|-|-|-|-|-|
</span></span><span style="display:flex;"><span>|-|-|-|-|-|-|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 验证接口
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">接口的描述</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 用例说明
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">#### 测试用例1
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>|步骤|操作内容|预期结果|覆盖功能点|
</span></span><span style="display:flex;"><span>|-|-|-|-|
</span></span><span style="display:flex;"><span>|-|-|-|-|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">#### 测试用例2
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>|步骤|操作内容|预期结果|覆盖功能点|
</span></span><span style="display:flex;"><span>|-|-|-|-|
</span></span><span style="display:flex;"><span>|-|-|-|-|
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 目录结构
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">对本模块的目录结构进行描述</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">## 检测列表
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 本文档符合指定[模板]()要求
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Env提供的API不包含任何DUT引脚和时序信息
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Env的API保持稳定（共有[ X ]个）
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> Env中对所支持的RTL版本（支持版本[ X ]）进行了检查
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 功能点（共有[ X ]个）与[设计文档]()一致
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 检查点（共有[ X ]个）覆盖所有功能点
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 检查点的输入不依赖任何DUT引脚，仅依赖Env的标准API
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 所有测试用例（共有[ X ]个）都对功能检查点进行了反标
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 所有测试用例都是通过 assert 进行的结果判断
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 所有DUT或对应wrapper都是通过fixture创建
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 在上述fixture中对RTL版本进行了检查
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 创建DUT或对应wrapper的fixture进行了功能和代码行覆盖率统计
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">- [ ]</span> 设置代码行覆盖率时对过滤需求进行了检查
</span></span></code></pre></div><p>展示效果如下：</p>
<h1 id="模块名称">模块名称</h1>
<h2 id="测试目标">测试目标</h2>
<p>&lt;测试目标、测试方法描述&gt;</p>
<h2 id="测试环境">测试环境</h2>
<p>&lt;测试环境描述，依赖描述&gt;</p>
<h2 id="功能检测">功能检测</h2>
<p>&lt;给出目标待测功能与对应的检测方法&gt;</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>所属模块</th>
<th>功能描述</th>
<th>检查点描述</th>
<th>检查标识</th>
<th>检查项</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="验证接口">验证接口</h2>
<p>&lt;接口的描述&gt;</p>
<h2 id="用例说明">用例说明</h2>
<h4 id="测试用例1">测试用例1</h4>
<table>
<thead>
<tr>
<th>步骤</th>
<th>操作内容</th>
<th>预期结果</th>
<th>覆盖功能点</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<h4 id="测试用例2">测试用例2</h4>
<table>
<thead>
<tr>
<th>步骤</th>
<th>操作内容</th>
<th>预期结果</th>
<th>覆盖功能点</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="目录结构">目录结构</h2>
<p>&lt;对本模块的目录结构进行描述&gt;</p>
<h2 id="检测列表">检测列表</h2>
<ul>
<li><input disabled="" type="checkbox"> 本文档符合指定<a href="/UnityChipForXiangShan/">模板</a>要求</li>
<li><input disabled="" type="checkbox"> Env提供的API不包含任何DUT引脚和时序信息</li>
<li><input disabled="" type="checkbox"> Env的API保持稳定（共有[ X ]个）</li>
<li><input disabled="" type="checkbox"> Env中对所支持的RTL版本（支持版本[ X ]）进行了检查</li>
<li><input disabled="" type="checkbox"> 功能点（共有[ X ]个）与<a href="/UnityChipForXiangShan/">设计文档</a>一致</li>
<li><input disabled="" type="checkbox"> 检查点（共有[ X ]个）覆盖所有功能点</li>
<li><input disabled="" type="checkbox"> 检查点的输入不依赖任何DUT引脚，仅依赖Env的标准API</li>
<li><input disabled="" type="checkbox"> 所有测试用例（共有[ X ]个）都对功能检查点进行了反标</li>
<li><input disabled="" type="checkbox"> 所有测试用例都是通过 assert 进行的结果判断</li>
<li><input disabled="" type="checkbox"> 所有DUT或对应wrapper都是通过fixture创建</li>
<li><input disabled="" type="checkbox"> 在上述fixture中对RTL版本进行了检查</li>
<li><input disabled="" type="checkbox"> 创建DUT或对应wrapper的fixture进行了功能和代码行覆盖率统计</li>
<li><input disabled="" type="checkbox"> 设置代码行覆盖率时对过滤需求进行了检查</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-08609283b091262ac299662399e11d12">9 - 常用API</h1>
    
	<h2 id="comm-模块">comm 模块</h2>
<p>在comm中提供了部分可公用的API，可通过以下方式进行调用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># import all</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or direct import functions you need</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">com</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">function_you_need</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or access from module</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">function_you_need</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="cfg-子模块">cfg 子模块</h3>
<h4 id="get_configcfgnone">get_config(cfg=None)</h4>
<p>获取当前的Config配置</p>
<ul>
<li>输入：如果cfg不为空，则返回cfg。否则则自动通过toffee获取全局Config。</li>
<li>返回：Config对象</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rtl</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="cfg_as_strcfg-cfgobject">cfg_as_str(cfg: CfgObject):</h4>
<p>把config对象转换为字符类型</p>
<ul>
<li>输入：Config对象</li>
<li>返回：编码后的Config对象</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cfg_str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cfg_as_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_config</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h4 id="cfg_from_strcfg_str">cfg_from_str(cfg_str)</h4>
<p>把字符类型的Config对象还原</p>
<ul>
<li>输入：编码后的Config对象</li>
<li>返回：Config对象</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cfg_from_str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg_str</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="dump_cfgcfg-cfgobject--none-cfg_filenone">dump_cfg(cfg: CfgObject = None, cfg_file=None)</h4>
<p>把config对象保持到文件</p>
<ul>
<li>输入：
<ul>
<li>cfg 需要保存的config</li>
<li>cfg_file 目标文件</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dump_cfg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config.yaml&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="functions-子模块">functions 子模块</h3>
<h4 id="get_log_dirsubdir-cfgnone">get_log_dir(subdir=&quot;&quot;, cfg=None)</h4>
<p>获取日志目录</p>
<ul>
<li>输入：
<ul>
<li>subdir： 子目录</li>
<li>cfg：配置文件</li>
</ul>
</li>
<li>输出：日志目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">my_log</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_log_dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_log&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_log</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># /workspace/UnityChipForXiangShan/out/log/my_log</span>
</span></span></code></pre></div><h4 id="get_out_dirsubdir-cfgnone">get_out_dir(subdir=&quot;&quot;, cfg=None)</h4>
<p>获取输出目录</p>
<ul>
<li>输入：
<ul>
<li>subdir： 子目录</li>
<li>cfg：配置文件</li>
</ul>
</li>
<li>输出：输出目录</li>
</ul>
<h4 id="get_rtl_dirsubdir-cfgnone">get_rtl_dir(subdir=&quot;&quot;, cfg=None)</h4>
<p>获取RTL目录</p>
<ul>
<li>输入：
<ul>
<li>subdir： 子目录</li>
<li>cfg：配置文件</li>
</ul>
</li>
<li>输出：RTL目录</li>
</ul>
<h4 id="get_root_dirsubdir">get_root_dir(subdir=&quot;&quot;)</h4>
<p>获取根目录：</p>
<ul>
<li>输入：根目录下的子目录</li>
<li>输出：当前仓库的根目录</li>
</ul>
<h4 id="is_all_file_existfiles_to_check-dir">is_all_file_exist(files_to_check, dir)</h4>
<p>判断文件是否在指定目录中都存在</p>
<ul>
<li>输入：
<ul>
<li>files_to_check: 需要检查的文件列表</li>
<li>dir：目标目录</li>
</ul>
</li>
<li>输出：是否都存在，只要有一个文件不存在都返回False</li>
</ul>
<h4 id="time_formatsecondsnone-fmtymd-hms">time_format(seconds=None, fmt=&quot;%Y%m%d-%H%M%S&quot;)</h4>
<p>格式化时间</p>
<ul>
<li>输入：
<ul>
<li>seconds：需要格式化的时间，为None表示当前时间</li>
<li>fmt：时间格式</li>
</ul>
</li>
<li>返回：格式化之后的时间字符串</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">time</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time_format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#8f5902;font-style:italic"># 20241202-083726</span>
</span></span></code></pre></div><h4 id="base64_encodeinput_str">base64_encode(input_str)</h4>
<p>base64编码：</p>
<ul>
<li>输入：需要编码的字符串</li>
<li>输出：编码之后的字符串</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">base64_encode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># dGVzdA==</span>
</span></span></code></pre></div><h4 id="base64_decodebase64_str">base64_decode(base64_str)</h4>
<p>base64解码：</p>
<ul>
<li>输入：bas64编码</li>
<li>输出：解码之后的原始字符串</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">base64_decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dGVzdA==&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic"># test</span>
</span></span></code></pre></div><h4 id="exe_cmdcmd-no_logfalse">exe_cmd(cmd, no_log=False)</h4>
<p>执行操作系统命令：</p>
<ul>
<li>输入：
<ul>
<li>cmd：需要执行的os命令</li>
<li>是否需要返回命令行输出</li>
</ul>
</li>
<li>输出：success，stdout、sterr
<ul>
<li>sucess：命令是否执行成功</li>
<li>命令标准输出字符串（no_log=True时，强制为空）</li>
<li>命令标准错误字符串（no_log=True时，强制为空）</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#000">su</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">er</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">exe_cmd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pwd&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">st</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="get_git_commit">get_git_commit()</h4>
<p>获取当前仓库git commit号</p>
<h4 id="get_git_branch">get_git_branch()</h4>
<p>获取当前仓库git 分支名称</p>
<h4 id="ut_fcovgroup-ignore_prefixut_">UT_FCOV(group, ignore_prefix=&ldquo;ut_&rdquo;)</h4>
<p>获取功能覆盖率分组</p>
<ul>
<li>输入：
<ul>
<li>group 分组名称</li>
<li>ignore_prefix需要去掉的前缀</li>
</ul>
</li>
<li>输出：带模块前缀的覆盖率分组名</li>
</ul>
<p>例如，在<code>ut_backend/ctrl_block/decode/env/decode_wrapper.py</code>中调用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UT_FCOV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;../../INT&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># out</span>
</span></span><span style="display:flex;"><span><span style="color:#000">backend</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ctrl_block</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">INT</span>
</span></span></code></pre></div><h4 id="get_version_checkertarget_version">get_version_checker(target_version)</h4>
<p>获取版本检测函数</p>
<ul>
<li>输入：目标版本字符串</li>
<li>输出：检测函数</li>
</ul>
<p>返回的检测函数，一般在fixture中进行版本判断。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">pytest</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">checker</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_version_checker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;openxiangshan-kmh-24092701+&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">fixture</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">checker</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><h4 id="module_name_withnames-prefixnone">module_name_with(names, prefix=None)</h4>
<p>给names统一加上模块前缀</p>
<ul>
<li>输入：
<ul>
<li>nanmes 需要添加前缀的字符列表</li>
<li>prefix 模块前缀</li>
</ul>
</li>
<li>返回：添加完成后的字符串列表</li>
</ul>
<p>例如在a/b/c/d/e.py文件中调用该方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">comm</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">comm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">module_name_with</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;X&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Y&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;../../x&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># out</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;a.b.c.x.X&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a.b.c.x.Y&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><h4 id="get_all_rtl_filestop_module-cfg"><code>get_all_rtl_files(top_module, cfg)</code></h4>
<p>获取名称为 <code>top_module</code> 的模块所依赖的所有 RTL 文件（<code>.v</code> 或 <code>.sv</code>）的列表，并确保列表的第一个元素是 <code>top_module</code> 所在文件的绝对路径。所有 RTL 文件均位于 <code>UnityChipForXiangShan/rtl/rtl</code> 目录下。</p>
<ul>
<li>
<p>输入：</p>
<ul>
<li><code>top_module</code>：模块名称，类型为 <code>str</code>。</li>
<li><code>cfg</code>：配置信息，类型为 <code>CfgObject</code>。</li>
</ul>
</li>
<li>
<p>输出：</p>
<ul>
<li>返回一个包含字符串的列表，列表中的每个字符串为模块依赖的 RTL 文件的绝对路径。列表的第一个元素为 <code>top_module</code> 所在文件的路径。</li>
</ul>
</li>
</ul>
<p>假设 <code>top_module</code> 为 <code>&quot;ALU&quot;</code>，且其依赖的 RTL 文件包括 <code>ALU.sv</code>、<code>adder.v</code> 和 <code>multiplier.v</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">paths</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_all_rtl_files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ALU&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">paths可能的内容：
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;/path/to/UnityChipForXiangShan/rtl/rtl/ALU.sv&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;/path/to/UnityChipForXiangShan/rtl/rtl/adder.v&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;/path/to/UnityChipForXiangShan/rtl/rtl/multiplier.v&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8a2981468f57aaf0314d1df6c5431ce9">10 - 其他</h1>
    
	<h2 id="测试用例管理">测试用例管理</h2>
<p>如果测试用例和目标RTL版本紧密相关，RTL发生变化，之前的测试用例不一定适用。此外，不同场景下有不同需求，例如验证测试环境时，不运行耗时太长的用例等。因此需要对用例进行管理，让用户能在在特定场景下跳过某些用例。为了实现该目标，我们需要通过<code>pytest.mark.toffee_tags</code>对于每个用例进行tag和version标记。然后在配置文件中设置需要跳过哪些tag或者只运行哪些tag的测试。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_tag&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;version1 &lt; version13&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_case_1</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>例如上述<code>test_case_1</code>被标记上了标签<code>my_tag</code>，支持版本设置为<code>version1</code>到<code>version13</code>。因此可以在配置文件中指定<code>test.skip-tags=[&quot;my_tag&quot;]</code>，来表示运行过程中跳过该用例。</p>
<p><code>pytest.mark.toffee_tags</code>的参数说明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_tags</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tag</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Optional</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">]</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>    <span style="color:#8f5902;font-style:italic"># 用例标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">version</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Optional</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[],</span>   <span style="color:#8f5902;font-style:italic"># 用例rtl版本需求</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">skip</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">callable</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic"># 自定义是否调过该用例，skip(tag, version, item): (skip, reason)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>toffee_tags</code>函数的参数<code>tag</code>支持<code>str</code>和<code>list[str]</code>类型。<code>version</code>参数也可以是<code>str</code>和<code>list[str]</code>类型，当为<code>list</code>类型时，进行精确匹配，如果为<code>str</code>则匹配规则如下：</p>
<ol>
<li><code>name-number1 &lt; namer-number2:</code> 表示版本需要在<code>number1</code>和<code>number2</code>之间（包含边界，<code>number</code>表示数字，也可以为小数，eg <code>1.11</code>）</li>
<li><code>name-number1+</code>：表示<code>number1</code>版本以及以后的版本</li>
<li><code>name-number1-</code>：表示<code>number1</code>版本以及以前的版本</li>
</ol>
<p>如果不存在上述情况，且有<code>*</code>或者<code>?</code>表示通配符类型。其他情况为精确匹配。</p>
<p>预定义标签，可以在comm/constants.py中查看，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Predefined tags for test cases</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_LONG_TIME_RUN</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;LONG_TIME_RUN&#34;</span>  <span style="color:#8f5902;font-style:italic"># 运行时间长</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_SMOKE</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;SMOKE&#34;</span>          <span style="color:#8f5902;font-style:italic"># 冒烟测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_RARELY_USED</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;RARELY_USED&#34;</span>    <span style="color:#8f5902;font-style:italic"># 非常少用</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_REGRESSION</span>    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;REGRESSION&#34;</span>     <span style="color:#8f5902;font-style:italic"># 回归测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_PERFORMANCE</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;PERFORMANCE&#34;</span>    <span style="color:#8f5902;font-style:italic"># 性能测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_STABILITY</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;STABILITY&#34;</span>      <span style="color:#8f5902;font-style:italic"># 稳定测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_SECURITY</span>      <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;SECURITY&#34;</span>       <span style="color:#8f5902;font-style:italic"># 安全测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_COMPATIBILITY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;COMPATIBILITY&#34;</span>  <span style="color:#8f5902;font-style:italic"># 兼容测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_OTHER</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;OTHER&#34;</span>          <span style="color:#8f5902;font-style:italic"># 其他</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_CI</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;CI&#34;</span>             <span style="color:#8f5902;font-style:italic"># 集成测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_DEBUG</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;DEBUG&#34;</span>          <span style="color:#8f5902;font-style:italic"># 测试</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TAG_DEMO</span>          <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;DEMO&#34;</span>           <span style="color:#8f5902;font-style:italic"># demo</span>
</span></span></code></pre></div><p>在默认配置中(<code>config/_default.yaml</code>)，会过滤掉：<code>LONG_TIME_RUN</code>、<code>REGRESSION</code>、<code>RARELY_USED</code>、<code>CI</code> 标记的测试。</p>
<p>可以通过<code>@pytest.mark.toffee_tags</code>可以为每个用例添加标签，也可以在模块中定义如下变量，实现对整个模块的所有测试用例添加标签。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">toffee_tags_default_tag</span>     <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>   <span style="color:#8f5902;font-style:italic"># 对应 tag 参数</span>
</span></span><span style="display:flex;"><span><span style="color:#000">toffee_tags_default_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>   <span style="color:#8f5902;font-style:italic"># 对应 version 参数</span>
</span></span><span style="display:flex;"><span><span style="color:#000">toffee_tags_default_skip</span>    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">None</span> <span style="color:#8f5902;font-style:italic"># 对应 skip 参数</span>
</span></span></code></pre></div><p>*注：本环境中的版本号会自动过滤掉git标记，例如下载的RTL名称为<code>openxiangshan-kmh-97e37a2237-24092701.tar.gz</code>，则其版本号在本项目中为：<code>openxiangshan-kmh-24092701</code>, 可通过<code>cfg.rtl.version</code>或者<code>comm.get_config().rtl.version</code>获得。</p>
<h2 id="版本检查">版本检查</h2>
<p>除了可以用标签<code>toffee_tags</code>自动检查版本外，还可以通过<code>get_version_checker</code>主动进行检查。一个单元测试通常由测试环境（Test Env）和测试用例组成（Test Case），Env对RTL引脚和功能进行封装，然后向Case提供稳定API，因此在Env中需要进行RTL版本判断，判断是否需要跳过使用本环境的所有测试用例。例如在Env中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">comm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">get_version_checker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">version_check</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">get_version_checker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;openxiangshan-kmh-*&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 获取RTL版本检查器，同toffee_tags中的veriosn参数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_fixture</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">version_check</span><span style="color:#000;font-weight:bold">()</span>                                        <span style="color:#8f5902;font-style:italic"># 在 fixture 中主动检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">....</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">dut</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>在上述例子中，Env在名称为<code>my_fixture</code>的<a href="https://docs.pytest.org/en/stable/explanation/fixtures.html">fixture</a>中主动进行了版本检查。因此，在测试用例每次调用它时都会进行版本检查，如果检查不满足要求，则会跳过该用例的执行。</p>
<h2 id="仓库目录说明">仓库目录说明</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>UnityChipForXiangShan
</span></span><span style="display:flex;"><span>├── LICENSE            <span style="color:#8f5902;font-style:italic"># 开源协议</span>
</span></span><span style="display:flex;"><span>├── Makefile           <span style="color:#8f5902;font-style:italic"># Makefile主文件</span>
</span></span><span style="display:flex;"><span>├── README.en.md       <span style="color:#8f5902;font-style:italic"># 英文readme</span>
</span></span><span style="display:flex;"><span>├── README.zh.md       <span style="color:#8f5902;font-style:italic"># 中文readme</span>
</span></span><span style="display:flex;"><span>├── __init__.py        <span style="color:#8f5902;font-style:italic"># Python模块文件，可以把整个UnityChipForXiangShan当成一个模块进行import</span>
</span></span><span style="display:flex;"><span>├── pytest.ini         <span style="color:#8f5902;font-style:italic"># PyTest 配置文件</span>
</span></span><span style="display:flex;"><span>├── comm               <span style="color:#8f5902;font-style:italic"># 公用组件：日志，函数，配置等</span>
</span></span><span style="display:flex;"><span>├── configs            <span style="color:#8f5902;font-style:italic"># 配置文件目录</span>
</span></span><span style="display:flex;"><span>├── documents          <span style="color:#8f5902;font-style:italic"># 文档</span>
</span></span><span style="display:flex;"><span>├── dut                <span style="color:#8f5902;font-style:italic"># dut生成目录</span>
</span></span><span style="display:flex;"><span>├── out                <span style="color:#8f5902;font-style:italic"># log，report等生成目录</span>
</span></span><span style="display:flex;"><span>├── requirements.txt   <span style="color:#8f5902;font-style:italic"># python依赖</span>
</span></span><span style="display:flex;"><span>├── rtl                <span style="color:#8f5902;font-style:italic"># rtl缓存</span>
</span></span><span style="display:flex;"><span>├── run.py             <span style="color:#8f5902;font-style:italic"># 主python入口文件</span>
</span></span><span style="display:flex;"><span>├── scripts            <span style="color:#8f5902;font-style:italic"># dut编译脚本</span>
</span></span><span style="display:flex;"><span>├── tools              <span style="color:#8f5902;font-style:italic"># 公共工具模块</span>
</span></span><span style="display:flex;"><span>├── ut_backend         <span style="color:#8f5902;font-style:italic"># 后端测试用例</span>
</span></span><span style="display:flex;"><span>├── ut_frontend        <span style="color:#8f5902;font-style:italic"># 前端测试用例</span>
</span></span><span style="display:flex;"><span>├── ut_mem_block       <span style="color:#8f5902;font-style:italic"># 访存测试用例</span>
</span></span><span style="display:flex;"><span>└── ut_misc            <span style="color:#8f5902;font-style:italic"># 其他测试用例</span>
</span></span></code></pre></div><h2 id="配置文件说明">配置文件说明</h2>
<p>默认配置与说明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认配置文件</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 配置加载顺序: _default.yaml -&gt; 用户指定的 *.yaml -&gt; 命令行参数 eg: log.term-level=&#39;debug&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># RTL 配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rtl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># RLT下载地址，从该地址获取所有*.gz.tar文件当成目标RTL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">base-url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://&lt;your_rtl_download_address&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 需要下载的RTL版本 eg: openxiangshan-kmh-97e37a2237-24092701</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 需要存储RTL的目录，相对于当前配置文件的路径</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cache-dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;../rtl&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 测试用例配置（tag和case支持通配符）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">test</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 跳过标签，所有带有该标签的测试用例都会被跳过</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">skip-tags</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;LONG_TIME_RUN&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;RARELY_USED&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;REGRESSION&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CI&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 目标标签，只有带有该标签的测试用例才会被执行（skip-tags会覆盖run-tags）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">run-tags</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 跳过的测试用例，所有带有该名字（或者模块名）的测试用例都会被跳过。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">skip-cases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 目标测试用例，只有带有该名字（或者模块名）的测试用例才会被执行（skip-cases会覆盖run-cases）。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">run-cases</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 跳过异常，所有抛出该异常的测试用例都会被跳过</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">skip-exceptions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 输出配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">output</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 输出目录，相对于当前配置文件的路径</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">out-dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;../out&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 测试报告配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">report</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 报告生成目录，相对于output.out-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">report-dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;report&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 报告名称，支持变量替换：%{host} 主机名，%{pid} 进程ID，%{time} 当前时间</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">report-name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;%{host}-%{pid}-%{time}/index.html&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 报告内容</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">information</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 报告标题</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;XiangShan KMH Test Report&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 报告用户信息</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">email</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;User@example.email.com&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 目标行覆盖率 eg: 90 表示 90%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">line_grate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">99</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 其他需要展示的信息，key为标题，value为内容</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">Version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1.0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 日志配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 根输出级别</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">root-level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;debug&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 终端输出级别</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">term-level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 文件日志输出级别</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">file-dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;log&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 文件日志名称，支持变量替换：%{host} 主机名，%{pid} 进程ID，%{time} 当前时间</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">file-name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;%{host}-%{pid}-%{time}.log&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 文件日志输出级别</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">file-level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 测试结果配置（该数据用于填充documents中的统计图等，原始数据来源于toffee-test生成的report）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  运行完测试后，可通过 `make doc` 查看结果</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">doc-result</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 是否开测试结果后处理</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 目标DUT的组织结构配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dutree</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;%{root}/configs/dutree/xiangshan-kmh.yaml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 结果名称，将会保存到输出的report目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">result-name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ut_data_progress.json&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 创建的测试报告的软连接到 hugo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">report-link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;%{root}/documents/static/data/reports&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可在上述配置文件中添加自定义参数，通过<code>cfg = comm.get_config()</code>获取全局配置信息，然后通过<code>cfg.your_key</code>进行访问。<code>cfg</code>信息为只读信息，默认情况下不能进行修改。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-69941129f79fb8261f7f1fe7b92e7c0a">11 - 必要规范</h1>
    
	<p>为了方便将所有人的贡献集合在一起，需要在编码、环境、文档编写等方面采用相同的“规范”。</p>
<h3 id="环境要求">环境要求</h3>
<ul>
<li><strong>python：</strong> 在python编码过程中，尽可能的采用标准库，采用兼容Python3大部分版本的通用语法（尽可能的在Python3.6 - Python3.12中通用），不要使用过旧或者过新的语法。</li>
<li><strong>操作系统：</strong> 建议Ubuntu 22.04，windows下，建议使用WSL2环境。</li>
<li><strong>hugo</strong> 建议版本 0.124.1（版本过旧不支持软连接）</li>
<li><strong>少依赖</strong> 尽可能少的使用第三方C++/C库</li>
<li><strong>picker</strong> 建议使用wheel安装picker工具和xspcomm库</li>
</ul>
<h3 id="测试用例">测试用例</h3>
<ul>
<li><strong>代码风格</strong> 建议采用 <a href="https://peps.python.org/pep-0008/">PEP 8 规范</a></li>
<li><strong>build脚本</strong> 需要按DUT的命名结构进行规范命名，不然无法正确收集验证结果。例如<code>backend.ctrl_block.decode</code>UT在scripts目录中对应的build文件名称应该为<code>build_ut_backend_ctrl_block_decode.py</code>(以固定前缀<code>build_ut_</code>开始，点<code>.</code>用下划线<code>_</code>进行替换)。在脚本中实现 <code>build(cfg) -&gt; bool</code> 和 <code>line_coverage_files(cfg) -&gt; list[str]</code> 方法。<code>build</code>用于编译DUT为<code>python</code>模块，<code>line_coverage_files</code>方法用于返回需要统计的代码行覆盖率文件。</li>
<li><strong>用例标签</strong> 如果用例无法做到版本通用，需要用<code>pytest.mark.toffee_tags</code>标记支持的版本。</li>
<li><strong>用例抽象</strong> 编写的测试用例输入不能出现DUT的具体引脚等强耦合内容，只能调用基于DUT之上的函数封装。例如对于加法器 adder，需要把dut的目标功能封装为 <code>dut_wrapper.add(a: int, b: int) -&gt; int, bool</code>，在test_case中仅仅调用 <code>sum, c = add(a, b)</code>进行测试。</li>
<li><strong>覆盖抽象</strong> 在编写功能覆盖率时，其检查点函数的输入也不能有DUT引脚。</li>
<li><strong>环境抽象</strong> 对于一个验证，通常分为2部分：Test Case 和 Env （用例以外的都统一称为Env，它包含DUT、驱动、监控等），其中Env需要提供对外的功能抽象接口，不能对外呈现出太多细节。</li>
<li><strong>测试说明</strong> 在每个DUT的验证环境中，需要通过<code>README.md</code>对该环境进行说明，例如需要对Env提供给Case的接口进行说明，目录结构说明等。</li>
</ul>
<h3 id="pr编写">PR编写</h3>
<ul>
<li><strong>标题</strong> 简洁明了，能概括PR的主要内容。</li>
<li><strong>详细描述</strong> 详细说明PR的目的，修改的内容以及相关背景信息。入解决已有的问题需要给出链接（例如Issue）。</li>
<li><strong>关联问题</strong> 在描述中关联相关问题，例如 <code>Fixes #123</code>，以便在合并PR时关闭关联问题。</li>
<li><strong>测试</strong> 需要进行测试，并对测试结果进行描述</li>
<li><strong>文档</strong> PR涉及到的文档需要同步修改</li>
<li><strong>分解</strong> 当PR涉及到的修改很多时，需要判断是否拆分成多个PR</li>
<li><strong>检查清单</strong> 检查编译是否通过、代码风格是否合理、是否测试通过、是否有必要的注释等</li>
<li><strong>模板</strong> 以及提供的PR模块请<a href="08_pr_template/">参考链接</a>。</li>
</ul>
<h3 id="issue编写">ISSUE编写</h3>
<p>要求同上</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c1ae5de257a4994f185c724b61cc52e6">12 - 验证文档</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-85aa4b5fe3fa0c67d7bcebe4378a6f76">12.1 - 验证文档规范</h1>
    
	<p>本规范规定了“万众一芯”的文档模板（不是验证报告的模板），已发布和将来将要发布的文档都需要遵循这一规范。</p>
<p>以下是文档模板：</p>
<h1 id="验证文档">验证文档</h1>
<h2 id="术语说明">术语说明</h2>
<p><em>[可选项]列出术语和关键概念解释，方便读者参考，如果没有或比较简单可以没有</em></p>
<h2 id="整体框图">整体框图</h2>
<p><em>[可选项]如果特别复杂的模块，可以加入一张整体框图</em></p>
<h2 id="流水级示意图">流水级示意图</h2>
<p><em>[可选项]如果模块存在多流水级，则可以加入一张流水级示意图</em></p>
<h2 id="子模块列表">子模块列表</h2>
<p><em>[可选项]如果有的话，请在这里列出</em></p>
<h2 id="模块功能说明">模块功能说明</h2>
<p><em>简述功能</em></p>
<p><em>简述功能划分，复杂的可以以表格形式呈现</em></p>
<h3 id="功能1说明">功能1说明</h3>
<p><em>针对功能1分解测试点</em></p>
<p><em>如果测试点较多可以先列一个小表格；针对每个测试点，给出设置cov_group的建议</em></p>
<h3 id="功能2说明">功能2说明</h3>
<p><em>针对功能2分解测试点</em></p>
<p><em>如果测试点较多可以先列一个小表格；针对每个测试点，给出设置cov_group的建议</em></p>
<h3 id="功能3说明">功能3说明</h3>
<p><em>针对功能3分解测试点</em></p>
<p><em>如果测试点较多可以先列一个小表格；针对每个测试点，给出设置cov_group的建议</em></p>
<p>&hellip;</p>
<h2 id="常量说明">常量说明</h2>
<p><em>说明本模块中需要用到的关键常量。（可省略）</em></p>
<h2 id="接口说明">接口说明</h2>
<p><em>详细解释各种接口的含义、来源</em></p>
<h2 id="接口时序">接口时序</h2>
<p><em>[可选项] 复杂的模块可以考虑添加接口时序说明</em></p>
<h2 id="测试点总表">测试点总表</h2>
<p><em>请用<code>&lt;mrs-testpoints&gt;&lt;/mrs-testpoints&gt;</code>标签包裹下面的测试点总表</em></p>
<p><em>请用<code>&lt;mrs-pn&gt;&lt;/mrs-pn&gt;</code>标签包裹您的每个测试点名称</em></p>
<p><em>完成上述两步主要是方便我们后续用脚本提取测试点</em></p>
<mrs-testpoints>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能名称</th>
<th>测试点名称</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.x.x</td>
<td>用英文大写</td>
<td><mrs-pn> 用英文大写？需要链接相应测试点</mrs-pn></td>
<td>简单解释输入输出需要的信息</td>
</tr>
</tbody>
</table>
</mrs-testpoints>
<p>子模块的文档格式类似</p>
<p>以下以FIFO为例，展示了一个简单的文档案例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#000">`timescale</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">ns</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000">ps</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">FIFO</span> <span style="color:#000;font-weight:bold">(</span> <span style="color:#8f5902;font-style:italic">//data_width = 8  data depth =8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">rst_n</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">wr_en</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#8f5902;font-style:italic">//写使能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">rd_en</span><span style="color:#000;font-weight:bold">,</span>          <span style="color:#8f5902;font-style:italic">//读使能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">wdata</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">//写入数据输入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">rdata</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">//读取数据输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">empty</span><span style="color:#000;font-weight:bold">,</span>         <span style="color:#8f5902;font-style:italic">//读空标志信号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">full</span>           <span style="color:#8f5902;font-style:italic">//写满标志信号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">rdata_reg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#0000cf;font-weight:bold">&#39;d0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">rdata</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rdata_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">reg</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>     <span style="color:#8f5902;font-style:italic">//数据存储单元(8bit数据8个)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">reg</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">wr_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;d0</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">//写指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">reg</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">rd_ptr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;d0</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">//读指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">wr_addr</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">//写地址(写指针的低3位)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">rd_addr</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">//读地址(读指针的低3位)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">wr_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">wr_ptr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">rd_addr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rd_ptr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">always</span><span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87;font-weight:bold">negedge</span> <span style="color:#000">rst_n</span><span style="color:#000;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">begin</span> <span style="color:#8f5902;font-style:italic">//写数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rst_n</span><span style="color:#000;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">wr_ptr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;d0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wr_en</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">full</span><span style="color:#000;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">wr_addr</span><span style="color:#000;font-weight:bold">]</span>  <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">wdata</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wr_ptr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">wr_ptr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;d1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">always</span><span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87;font-weight:bold">negedge</span> <span style="color:#000">rst_n</span><span style="color:#000;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">begin</span> <span style="color:#8f5902;font-style:italic">//读数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">rst_n</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rd_ptr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">&#39;d0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rd_en</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rdata_reg</span>  <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rd_addr</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rd_ptr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">rd_ptr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;d1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">empty</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">wr_ptr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">rd_ptr</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">//读空
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">full</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">wr_ptr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">rd_ptr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">],</span><span style="color:#000">rd_ptr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]});</span> <span style="color:#8f5902;font-style:italic">//写满
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><h1 id="fifo-验证文档">FIFO 验证文档</h1>
<h2 id="功能说明">功能说明</h2>
<p>本次需要验证的是FIFO，一种常见的硬件缓冲模块，在硬件电路中临时存储数据，并按照数据到达的顺序进行处理。</p>
<p>本次需要验证的FIFO每次可写可读8位数据，容量为8。</p>
<h3 id="功能1读fifo">功能1：读FIFO</h3>
<p>设置FIFO读使能之后，并且FIFO不为空时，可以从FIFO中读取数据。</p>
<h4 id="测试点11-常规读取a-idfifo_read_normal-a">测试点1.1 常规读取<a id="FIFO_READ_NORMAL"> </a></h4>
<p>当FIFO中已有数据时，设置读使能，从中读出一个数据。</p>
<p>建议对栈的状态进行观测。</p>
<h4 id="测试点12-空读a-idfifo_read_empty-a">测试点1.2 空读<a id="FIFO_READ_EMPTY"> </a></h4>
<p>当FIFO中无数据，设置读使能，不读取数据。</p>
<p>建议对栈的状态进行观测。</p>
<h4 id="测试点13-无读使能不读a-idfifo_read_no_en-a">测试点1.3 无读使能不读<a id="FIFO_READ_NO_EN"> </a></h4>
<p>当FIFO中有数据，不设置读使能，不应该读取数据（建议判断方法：多次写之后设置读使能，读指针的数据应和第一次写入的数据一致）。</p>
<h3 id="功能2写fifo">功能2：写FIFO</h3>
<p>设置FIFO写使能之后，并且FIFO尚有空位时，可以向FIFO写入一个数据。</p>
<h4 id="测试点21-常规写入a-idfifo_write_normal-a">测试点2.1 常规写入<a id="FIFO_WRITE_NORMAL"> </a></h4>
<p>当FIFO中尚有空间时，设置写使能，可向FIFO写入一个数据。</p>
<p>建议对栈的状态进行观测。</p>
<h4 id="测试点22-fifo已满无法写入a-idfifo_write_full-a">测试点2.2 FIFO已满无法写入<a id="FIFO_WRITE_FULL"> </a></h4>
<p>当FIFO中数据已满，设置写使能，无法写入数据。</p>
<p>建议监测栈整体的状态。</p>
<h4 id="测试点23-无写使能不写a-idfifo_write_no_en-a">测试点2.3 无写使能不写<a id="FIFO_WRITE_NO_EN"> </a></h4>
<p>当FIFO中有空间，不设置写使能，即使设置了待写入的数据，也不应该写入数据（建议判断方法：在保持写使能为假的情况下，连续读应该为空读）。</p>
<h3 id="功能3重置">功能3：重置</h3>
<p>设置rst为假后，清空队列。</p>
<h4 id="测试点31-重置-a-idfifo_reset_reset-a">测试点3.1 重置 <a id="FIFO_RESET_RESET"> </a></h4>
<p>设置rst为假后，下一周期时，队列应为空</p>
<h2 id="常量说明-1">常量说明</h2>
<p>FIFO的容量为8。</p>
<h2 id="接口说明-1">接口说明</h2>
<h3 id="输入接口">输入接口</h3>
<p>rst_n：1位信号，设置重置</p>
<p>wr_en：1位信号，表示写使能</p>
<p>wdata：8位信号，表示写入的数据</p>
<p>rd_en：1位信号，表示读使能</p>
<h3 id="输出接口">输出接口</h3>
<p>rdata：8位信号，表示读出的数据</p>
<p>empty：1位信号，表示栈已经空了</p>
<p>full：1位信号，表示栈已经满了</p>
<h2 id="测试点总表-1">测试点总表</h2>
<p>建议各个测试点的覆盖组使用下表描述的功能和测试点名称进行命名。</p>
<p>比如FIFO_READ的测试点覆盖点可以命名为FIFO_READ_NORMAL</p>
<mrs-testpoints>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能名称</th>
<th>测试点名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>FIFO_READ</td>
<td><a href="#FIFO_READ_NORMAL"><mrs-pn>NORMAL</mrs-pn></a></td>
<td>fifo有数据时，设置读使能，可以读出数据</td>
</tr>
<tr>
<td>1.2</td>
<td>FIFO_READ</td>
<td><a href="#FIFO_READ_EMPTY"><mrs-pn>EMPTY</mrs-pn></a></td>
<td>fifo为空时，设置读使能，无法读出数据</td>
</tr>
<tr>
<td>1.3</td>
<td>FIFO_READ</td>
<td><a href="#FIFO_READ_NO_EN"><mrs-pn>NO_EN</mrs-pn></a></td>
<td>fifo有数据时，不设置读使能，无法读出数据</td>
</tr>
<tr>
<td>2.1</td>
<td>FIFO_WRITE</td>
<td><a href="#FIFO_WRITE_NORMAL"><mrs-pn>NORMAL</mrs-pn></a></td>
<td>fifo未满时，设置写使能，可以写入数据</td>
</tr>
<tr>
<td>2.2</td>
<td>FIFO_WRITE</td>
<td><a href="#FIFO_WRITE_FULL"><mrs-pn>FULL</mrs-pn></a></td>
<td>fifo已满时，设置写使能，可以写入数据</td>
</tr>
<tr>
<td>2.3</td>
<td>FIFO_WRITE</td>
<td><a href="#FIFO_WRITE_NO_EN"><mrs-pn>NO_EN</mrs-pn></a></td>
<td>fifo未满时，不设置写使能，无法写入数据</td>
</tr>
<tr>
<td>3.1</td>
<td>FIFO_RESET</td>
<td><a href="#FIFO_RESET_RESET"><mrs-pn>RESET</mrs-pn></a></td>
<td>重置后，栈为空</td>
</tr>
</tbody>
</table>
</mrs-testpoints>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f6da66656f78946ca5834eb79896448e">12.2 - Frontend</h1>
    
	<p>前端模块验证文档</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-29667896f8d34faad3302168726a92b6">12.2.1 - IFU</h1>
    
	<h1 id="ifu简介"><strong>IFU简介</strong></h1>
<div class="ifu-ctx">
<p>IFU(Instruction Fetch Unit)，取指令单元，负责从内存或ICache取出指令，经过预译码、扩展RVC和预检之后，将指令交给后续译码器进行进一步的译码。</p>
<p>IFU的子模块包括PreDecode，F3PreDecoder，RVCExpander，PredChecker和FrontendTrigger。</p>
<p>以下是IFU的架构简图：</p>
<p><img alt="framework" src="framework.jpg"></p>
<h2 id="ifu功能介绍">IFU功能介绍</h2>
<h3 id="xs_ifu流水级划分"><strong>XS_IFU流水级划分</strong></h3>
<p>香山的IFU一共分为5个阶段。</p>
<p>F0阶段：接收FTQ请求，同时告诉FTQ自己已经ready了</p>
<p>F1阶段：从FTQ请求中先计算出每个指令的pc，half_pc、cut_ptr（这是后续将icache返回的指令码进行切分的依据）</p>
<p>F2阶段：从icache获取响应数据（缓存行）并校验，提取出异常信息（包括页错误、访问错误、mmio信息）；生成预测到的指令范围（但这并不是一个数字，而是一个用多位表示的bool数组，该位为1表示这一指令在预测块范围内）；从缓存行中，利用上一阶段求出的cut_ptr切分出17×2的初步指令码，最后进行预译码和指令扩展。</p>
<p>F3阶段：这一阶段主要是对译码阶段的结果进行预检查，以及MMIO状态下的处理逻辑。</p>
<p>WB（写回）阶段：将预检查的结果写回FTQ，并向IBuffer写指令码和前端信息。</p>
<h3 id="接收ftq取指令请求f0流水级">接收FTQ取指令请求（F0流水级）</h3>
<p>​	在F0流水级，IFU接收来自FTQ以预测块为单位的取指令请求。请求内容包括预测块起始地址、起始地址所在cache line的下一个cache line开始地址、下一个预测块的起始地址、该预测块在FTQ里的队列指针、该预测块有无taken的CFI指令（控制流指令）和该taken的CFI指令在预测块里的位置以及请求控制信号（请求是否有效和IFU是否ready）。每个预测块最多包含32字节指令码，最多为16条指令。IFU需要置位ready驱动FTQ向ICache发送请求。</p>
<h3 id="指令切分产生初始指令码f1f2流水级">指令切分产生初始指令码（F1、F2流水级）</h3>
<p>F0流水级时，FTQ同时会向ICache发送取缓存行的指令。这是ICache在其S2流水级需要返回的，所以IFU在F2流水级才会得到ICache返回的缓存行。在此之前，IFU会在F1流水线先进行PC的计算，以及计算切分缓存行的指针。</p>
<p>进入F2流水级，IFU将会针对每个指令，取出对应的异常信息、物理地址、客户物理地址等。同时，根据FTQ的taken信息，IFU将会计算该预测块在无跳转和跳转发生情况下的有效指令范围。无跳转情况下的指令有效范围ftr_range即当前预测块从起始地址到下一个预测块的起始地址的差值。有跳转情况下的指令有效范围jump_range即当前预测块的起始地址到预测块中第一个跳转指令地址的差值。</p>
<p>最后，IFU需要从缓存行和上一流水级计算的指针，完成对17x2字节初始指令码的拼接。这里的拼接代码可能存在一些迷惑性</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">f2_cache_response_data</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">fromICache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">_</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bits</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">f2_data_2_cacheline</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Cat</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">f2_cache_response_data</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">f2_cache_response_data</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><p>在调用cut之前，我们先是从ICache获取了缓存行（ICache返回的缓存行种类已经在ICache中进行了分类讨论，IFU中直接使用即可），然后将第0个缓存数据进行了拼接，
这一操作的原因来自于ICache中对数据的细粒度拆分：</p>
<p>fetch block可能跨缓存行，但是由于fetch block最大只有34B，如果将两个缓存行（2x64B）都传送给IFU则显得浪费，因此，fetch block的选择由ICache完成。</p>
<p>ICache返回给IFU的并不是直接的预测块，而是带有跨缓存行信息的64字节。</p>
<p>我们将每个缓存行分为8份，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cacheline 0: |0-7|0-6|0-5|0-4|0-3|0-2|0-1|0-0|
</span></span><span style="display:flex;"><span>cacheline 1: |1-7|1-6|1-5|1-4|1-3|1-2|1-1|1-0|
</span></span></code></pre></div><p>如果fetch block的起始位置为0-1，则必定不跨缓存行。</p>
<p>如果fetch block的起始位置为0-6，那么fetch block的位置为0-6~1-2，此时传送的缓存行结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cacheline 0: |0-7|0-6|xx|xx|xx|1-2|1-1|1-0|
</span></span></code></pre></div><p>由此，只要将该缓存行复制一遍，即可获得拼接后的fetch block。</p>
<p>综上所述，对这两种情况，我们都只需要把返回的cacheline复制一份拼接在一起，从中间截取就可以拿到数据。</p>
<h3 id="预译码f2流水级主要由predecode模块完成">预译码（F2流水级，主要由PreDecode模块完成）</h3>
<p>在F2流水级，我们需要将上一步完成切分的指令码交给PreDecode子模块,他的作用主要有二：</p>
<p>其一是生成预译码信息，包括该指令是否是有效指令的开始、是否是RVC指令、是否是CFI指令、CFI指令类型（branch/jal/jalr/call/ret）、CFI指令的目标地址计算偏移等。输出的预译码信息中brType域的编码如下:</p>
<table>
<thead>
<tr>
<th>CFI指令类型</th>
<th>brType类型编码</th>
</tr>
</thead>
<tbody>
<tr>
<td>非CFI</td>
<td>00</td>
</tr>
<tr>
<td>branch指令</td>
<td>01</td>
</tr>
<tr>
<td>jal指令</td>
<td>10</td>
</tr>
<tr>
<td>jalr指令</td>
<td>11</td>
</tr>
</tbody>
</table>
<p>（<strong><a id="brtype">brType类型一览</a></strong>）</p>
<p>其二是将初始指令码两两组合之后，得到16x4字节的指令码（从起始地址开始，2字节做地址递增，地址开始的4字节作为一条32位初始指令码）。</p>
<p>此外，预译码阶段还需要分类讨论，得出两种指令有效向量（起始指令是不是RVI指令的后半部分），并交给IFU进行判断，可以参阅后面的<a href="#kyck_32">跨预测块32位指令</a>处理部分</p>
<p>其他功能和详细内容参见PreDecode子模块的描述。</p>
<h3 id="指令扩展f3流水级">指令扩展（F3流水级）</h3>
<p>这一部分将从PreDecode返回的16条指令码分别送交指令扩展器进行32位指令扩展（RVI保持不变， RVC指令根据手册的规定进行扩充）。</p>
<p>但是，如果指令非法，需要向IBuffer写入原始指令码。</p>
<h3 id="预测错误预检查f3流水级主要由prechecker子模块完成">预测错误预检查（F3流水级，主要由PreChecker子模块完成）</h3>
<p>这一功能是为了将一些不依赖于执行结果的预测错误在早期就发现出来。这一阶段检查五类错误：</p>
<p><strong>jal类型错误</strong>：预测块的范围内有jal指令，但是预测器没有对这条指令预测跳转；</p>
<p><strong>ret类型错误</strong>：预测块的范围内有ret指令，但是预测器没有对这条指令预测跳转；</p>
<p><strong>无效指令预测错误</strong>：预测器对一条无效的指令（不在预测块范围/是一条32位指令中间）进行了预测；</p>
<p><strong>非CFI指令预测错误</strong>：预测器对一条有效但是不是CFI的指令进行了预测；</p>
<p><strong>转移目标地址错误</strong>：预测器给出的转移目标地址不正确。</p>
<p>在预检查的最后将会修正之前预测的各个指令的跳转情况。同时，如果存在jal或者ret类型预测错误，还将修正fixedRange——这是指令有效范围向量，可以看作一个bool数组，其中某一位为1也就是对应的指令在这一范围内。</p>
<h3 id="前端重定向wb阶段">前端重定向（WB阶段）</h3>
<p>如果在预测错误预检查的部分发现了上述的五类错误，那么需要在写回阶段产生一个前端重定向将F3以外的流水级进行冲刷，
从而让BPU能够从正确路径重新开始预测。</p>
<p>还有一种情况下需要冲刷流水线。在下一节中，如果误判了当前预测块的最后2B为RVI指令的上半部分，则也需要冲刷当前预测块F3之前的流水级。</p>
<h3 id="跨预测块32位指令处理a-idkyck_32a">跨预测块32位指令处理<a id="kyck_32"></a></h3>
<p>因为预测块的长度有限制，因此存在一条RVI指令前后两字节分别在两个预测块的情况。IFU首先在第一个预测块里检查最后2字节是不是一条RVI指令的开始，如果是并且该预测块没有跳转，那么就设置一个标识寄存器f3_lastHalf_valid，告诉接下来的预测块含有后半条指令。在F2预译码时，会产生两种不同的指令有效向量：</p>
<p>预测块起始地址开始即为一条指令的开始，以这种方式根据后续指令是RVC还是RVI产生指令有效向量</p>
<p>预测块起始地址是一条RVI指令的中间，以起始地址 + 2位一条指令的开始产生有效向量</p>
<p>在F3，根据是否有跨预测块RVI标识来决定选用哪种作为最终的指令有效向量，如果f3_lastHalf_valid为高则选择后一种（即这个预测块第一个2字节不是指令的开始）。IFU所做的处理只是把这条指令算在第一个预测块里，而把第二个预测块的起始地址位置的2字节通过改变指令有效向量来无效掉。</p>
<h3 id="将指令码和前端信息送入ibufferf3流水级">将指令码和前端信息送入IBuffer（F3流水级）</h3>
<p>F3流水级最终得到经过扩展的32位指令码（或者对于非法指令直接传递原始指令码），以及16条指令中每条指令的例外信息、
预译码信息、FTQ队列中的指针位置、其他后端需要的信息（比如经过折叠的PC）等。IFU除了常规的valid-ready控制信号外，
还会给IBuffer两个特殊的信号：一个是16位的io_toIbuffer_bits_valid（因为我们最后组合出来的指令也是16条，
所以这里每一位刚好也对应一个指令的状态，为1说明是一条指令的开始，为0则是说明是一条指令的中间），标识预测块里有效的指令。
另一个是16位的io_toIbuffer_bits_enqEnable，这个在io_toIbuffer_bits_valid的基础上与上了被修正过的预测块的指令范围fixedRange。
enqEnable为1表示这个2字节指令码是一条指令的开始且在预测块表示的指令范围内。</p>
<p>除此之外，异常信息也需要写给IBuffer。</p>
<p>注意一个特例：当且仅当发生guest page fault时，后端需要gpaddr信息，为了节省面积，gpaddr不走正常通路进入ibuffer，
而是随ftqPtr被发送到gpaMem，后端需要时从gpaMem读出。IFU需要保证gpf发生时通向gpaMem的valid拉高、gpaddr正确。</p>
<h3 id="分支预测overriding冲刷流水线">分支预测overriding冲刷流水线</h3>
<p>当FTQ内未缓存足够预测块时，IFU可能直接使用简单分支预测器提供的预测地址进行取指，这种情况下，当精确预测器发现简单预测器错误时，需要通知IFU取消正在进行的取指请求。具体而言，当BPU的S2流水级发现错误时，需要冲刷IFU的F0流水级；当BPU的S3流水级发现错误时，需要冲刷IFU的F0/F1流水级（BPU的简单预测器在S1给出结果，最晚在S3进行overriding，因此IFU的F2/F3流水级一定是最好的预测，不需要冲刷；类似地，不存在BPU S2到IFU F1的冲刷）。</p>
<p>IFU在收到BPU发送的冲刷请求时，会将F0/F1流水级上取指请求的指针与BPU发送的冲刷请求的指针进行比较，若冲刷的指针在取指的指针之前，说明当前取指请求在错误的执行路径上，需要进行流水线冲刷；反之，IFU可以忽略BPU发送的这一冲刷请求。此外，比较的时候还需要注意flag的情况，flag是一个指示队列循环的指针，flag不同即在不同的“圈”上，此时反而是idx的值更小，ftqIdx才会更大。</p>
<h3 id="指令信息和误预测信息写回ftqwb阶段">指令信息和误预测信息写回FTQ（WB阶段）</h3>
<p>在F3的下一级WB级，IFU将指令PC、预译码信息、错误预测指令的位置、正确的跳转地址以及预测块的正确指令范围等信息写回FTQ，同时传递该预测块的FTQ指针用以区分不同请求。</p>
<p>同时，正如前面提到的，IFU检测到预测错误时会进行前端冲刷，同样地，FTQ也需要据此进行冲刷，因此，这也是IFU写回错误信息的意义——可以辅助FTQ判断是否冲刷流水线。</p>
<h3 id="mmio处理逻辑">MMIO处理逻辑</h3>
<p>在处理器上电复位时，内存还没有准备好，此时需要从Flash中取指令执行。
这种情况下需要IFU向MMIO总线发送宽度为64位的请求从flash地址空间取指令执行。同时IFU禁止对MMIO总线的推测执行，即IFU需要等到每一条指令执行完成得到准确的下一条指令地址之后才继续向总线发送请求。</p>
<p>这之后，根据FTQ中的指令地址，决定是否MMIO取指令。</p>
<p><img alt="mmio_states" src="mmio_stmt.svg"></p>
<p>以上是MMIO状态机的简图。在一开始，处于m_idle状态，如果处于mmio请求的场景（在f3阶段有效且没有异常的情况下，ICache返回的pmp_mmio[0]为真，或者ITLB返回的PBMT为Uncache类型——nc或者io类型，对应值为1和2），则转换到m_waitLastCmt，之后只要之前所有的指令都已完成提交——或者这一指令就是第一条指令，
则进入m_sendReq状态将请求发送到InstrUncache模块，发送完成后进入m_waitResp状态。
接收请求后，由于MMIO总线的带宽限制为64位，
因此存在一条指令一次MMIO请求不能取得完整指令码的情况（这是由于MMIO并不支持非对齐访问，具体地说，如果RVI指令的起始地址的[2, 1]两位为b11，则64位总线无法一次传递所有指令），所以需要增加地址进行重发，进入m_sendTLB状态，
再次查询ITLB，如果tlb的pbmt状态和上一条的存在差别，则为访问异常，综合TLB自身的异常结果和根据pbmt判定的访问异常，如果存在异常，则直接把指令和异常信息发到Ibuffer，进入等待，否则进入m_sendPMP状态，向PMP发送请求，
这里需要查看pmp_recheck的结果，如果该请求的mmio状态和上一条的mmio状态不一致，那么说明可能存在访问错误，置为访问异常，否则根据PMP的回复结果决定是否存在PMP异常。
如果存在异常，则将报错信息发送给Ibuffer，直接进入等待。 一切正常的话，进入m_resendReq状态，重新发送请求到InstrUncache模块。
无论是否重发，最后获得完整数据之后，根据地址从64位数据中截取指令码。并以每个预测块一条指令的形式（相当于只有起始地址的指令）发送到IBuffer。
接下来进入m_waitCommit状态等待，直到ROB返回指令已提交的信号即进入m_commited状态，CFI指令由后端发送给FTQ进行冲刷，而顺序指令则由IFU复用前端重定向通路刷新流水线，
同时复用FTQ写回机制，把它当作一条错误预测的指令进行冲刷，重定向到该指令地址 + 2或者+4(根据这条指令是RVI还是RVC选择)</p>
<p>对于跨缓存行预测块，他们的mmio和pbmt状态应当等同。不匹配的错误应当只在后一个缓存行报告。</p>
<p>此外，如果当前pbmt为nc，则会跳过waitLastCmt和waitCommit状态。因为这些内存空间是幂等的，所以可以进行推测性取指。</p>
<h3 id="trigger实现对于pc的硬件断点功能">Trigger实现对于PC的硬件断点功能</h3>
<p>该工作主要由FrontEndTrigger子模块完成。</p>
<h2 id="ifu接口说明">IFU接口说明</h2>
<p>为方便测试开展，需要对IFU的接口进行进一步的说明，以明确各个接口的含义。</p>
<h3 id="ftq交互接口">FTQ交互接口</h3>
<p>编译后可用的接口包括：</p>
<h4 id="req-ftq取指请求">req FTQ取指请求</h4>
<p>req是FTQ向IFU的取指令请求，编译后包含以下成员：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>ftqIdx</td>
<td>指示当前预测块在FTQ中的位置。</td>
</tr>
<tr>
<td>ftqOffset</td>
<td>指示预测块的大小</td>
</tr>
<tr>
<td>startAddr</td>
<td>当前预测块的起始地址。</td>
</tr>
<tr>
<td>nextlineStart</td>
<td>起始地址所在cacheline的下一个cacheline的开始地址。</td>
</tr>
<tr>
<td>nextStartAddr</td>
<td>下一个预测块的起始地址</td>
</tr>
</tbody>
</table>
<h4 id="redirect-ftq重定向请求">redirect FTQ重定向请求</h4>
<p>FTQ会向IFU发送重定向请求，这通过fromFtq.redirect完成，从而指示IFU应该冲刷的内容。</p>
<p>编译后，redirect包含以下接口成员：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>ftqIdx</td>
<td>需要冲刷的ftq预测块序号，包含flag和value两个量。</td>
</tr>
<tr>
<td>level</td>
<td>重定向等级</td>
</tr>
<tr>
<td>ftq_offset</td>
<td>ftq预测块中跳转指令的位置</td>
</tr>
</tbody>
</table>
<p>此外，还有valid变量指示是否需要重定向。</p>
<h4 id="frombpuflush">fromBPUFlush</h4>
<p>来自BPU的冲刷请求，这是预测错误引起的，包括s3和s2两个同构成员，指示是否在BPU的s3和s2流水级发现了问题，s3的详细结构如下</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>valid</td>
<td>是否存在s3流水级冲刷要求</td>
</tr>
<tr>
<td>ftqIdx</td>
<td>s3流水级请求冲刷的预测块的指针</td>
</tr>
</tbody>
</table>
<h4 id="toftq_pdwb-写回">toFtq_pdWb 写回</h4>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>cfioffset</td>
<td>经由PredChecker修复的跳转指令的预测位置。但经过编译后，cfioffset的数值已经被优化了，只剩下了cfioffset_valid表示是否存在编译优化。</td>
</tr>
<tr>
<td>ftqIdx</td>
<td>表明预测块在FTQ中的位置，这条信息主要是对FTQ有用，要和FTQ传入的请求保持一致。</td>
</tr>
<tr>
<td>instrRange</td>
<td>可以看作是一个bool数组，表示该条指令是不是在这个预测块的有效指令范围内（即第一条有效跳转指令之前的指令）。</td>
</tr>
<tr>
<td>jalTarget</td>
<td>表明该预测块跳转指令的跳转目标。</td>
</tr>
<tr>
<td>misOffset</td>
<td>表明错误预测的指令在预测块中的位置。</td>
</tr>
<tr>
<td>pc</td>
<td>预测块中所有指令的PC指针。</td>
</tr>
<tr>
<td>pd</td>
<td>每条指令的预测信息，包括CFI指令的类型、isCall、isRet和isRVC。</td>
</tr>
<tr>
<td>target</td>
<td>该预测块最后一条指令的下一条指令的pc。</td>
</tr>
</tbody>
</table>
<h3 id="icache交互接口">ICache交互接口</h3>
<h4 id="控制信号">控制信号</h4>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>icache_ready</td>
<td>ICache通知IFU自己已经准备好了，可以发送缓存行了。</td>
</tr>
<tr>
<td>icache_stop</td>
<td>IFU在F3流水级之前出现了问题，通知ICache停下。</td>
</tr>
</tbody>
</table>
<h4 id="icacheinterresp-icache传送给ifu的信息">ICacheInter.resp ICache传送给IFU的信息</h4>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td>ICache传送的缓存行。</td>
</tr>
<tr>
<td>doubleLine</td>
<td>指示ICache传来的预测块是否跨缓存行。</td>
</tr>
<tr>
<td>exception</td>
<td>ICache向IFU报告每个缓存行上的异常情况，方便ICache生成每个指令的异常向量。</td>
</tr>
<tr>
<td>backendException</td>
<td>ICache向IFU报告后端是否存在异常</td>
</tr>
<tr>
<td>gpaddr</td>
<td>客户页地址</td>
</tr>
<tr>
<td>isForVSnonLeafPTE</td>
<td>是否为非叶的PTE，这个数据最终会流向写回gpaddrMem的信号</td>
</tr>
<tr>
<td>itlb_pbmt</td>
<td>ITLB基于客户页的内存类型，对MMIO状态有用</td>
</tr>
<tr>
<td>paddr</td>
<td>指令块的起始物理地址</td>
</tr>
<tr>
<td>vaddr</td>
<td>指令块起始虚拟地址、下一个缓存行的虚拟地址</td>
</tr>
<tr>
<td>pmp_mmio</td>
<td>指示当前指令块是否在MMIO空间</td>
</tr>
</tbody>
</table>
<h3 id="性能相关接口">性能相关接口</h3>
<p>ICachePerf和perf，可以先不关注。</p>
<h3 id="itlbinter">ITLBInter</h3>
<p>该接口仅在MMIO状态下，IFU重发请求时活跃。</p>
<h4 id="req-ifu向itlb发送的请求">req IFU向ITLB发送的请求</h4>
<p>这是IFU向ITLB发送的查询请求，只有一个量：bits_vaddr，传递需要让ITLB查询的虚拟地址。</p>
<h4 id="resp-itlb返回给ifu的查询结果">resp ITLB返回给IFU的查询结果</h4>
<p>这是ITLB返回给IFU的查询结果，包含如下接口：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>excp</td>
<td>指令的异常信息，包含三个量：访问异常指令af_instr、客户页错误指令gpf_instr、页错误指令pf_instr</td>
</tr>
<tr>
<td>gpaddr</td>
<td>客户页地址</td>
</tr>
<tr>
<td>isForVSnonLeafPTE</td>
<td>指示传入的是否是非叶PTE</td>
</tr>
<tr>
<td>paddr</td>
<td>指令物理地址</td>
</tr>
<tr>
<td>pbmt</td>
<td>指令的基于页的内存类型</td>
</tr>
</tbody>
</table>
<h3 id="uncacheinter">UncacheInter</h3>
<p>该接口在MMIO状态下活跃，负责接收IFU并返回指令码。</p>
<h4 id="touncache">toUncache</h4>
<p>这是IFU向Uncache发送的请求，除了ready和valid以外，还传送了一个48位数据，即需要获取的指令的物理地址。</p>
<h4 id="fromuncache">fromUncache</h4>
<p>这是Uncache给IFU的回复，除了valid以外，还传送一个32位数据，即指令码（可为RVC或RVI指令）</p>
<h3 id="toibuffer">toIbuffer</h3>
<p>IFU通过这个接口向Ibuffer写入取指结果。包含以下成员:</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>backendException</td>
<td>是否存在后端异常</td>
</tr>
<tr>
<td>crossPageIPFFix</td>
<td>表示跨页异常向量</td>
</tr>
<tr>
<td>valid</td>
<td>和一般意义上的valid相区别，表示每条指令是否是合法指令的开始（RVI指令的上半条或者RVC指令）</td>
</tr>
<tr>
<td>enqable</td>
<td>对每条指令，其为valid并且在预测块的范围内</td>
</tr>
<tr>
<td>exceptionType</td>
<td>每个指令的异常类型</td>
</tr>
<tr>
<td>foldpc</td>
<td>压缩过后的pc</td>
</tr>
<tr>
<td>ftqOffset</td>
<td>指令是否在预测块范围中</td>
</tr>
<tr>
<td>ftqPtr</td>
<td>ftq预测块在FTQ的位置</td>
</tr>
<tr>
<td>illegalInstr</td>
<td>这条指令是否为非法指令</td>
</tr>
<tr>
<td>instrs</td>
<td>拼接后的指令码</td>
</tr>
<tr>
<td>isLastInFtqEntry</td>
<td>判断该指令是否为这个预测块中最后一条有效指令的开始</td>
</tr>
<tr>
<td>pd</td>
<td>指令控制信息，包括CFI指令的类型和RVC指令的判定</td>
</tr>
<tr>
<td>triggered</td>
<td>指令是否触发前端的trigger</td>
</tr>
</tbody>
</table>
<h3 id="tobackend_gpaddrmem">toBackend_gpaddrMem</h3>
<p>这组接口在gpfault发生时使用，由IFU向gpaddrMem传递预测块指针和页错误地址。</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>waddr</td>
<td>传递ftq指针</td>
</tr>
<tr>
<td>wdata.gpaddr</td>
<td>传递出错的客户页地址</td>
</tr>
<tr>
<td>wdata.isForVSnonLeafPTE</td>
<td>指示是否为非叶PTE</td>
</tr>
<tr>
<td>wen</td>
<td>类似valid，指示gpaddrMem存在gpfault需要处理</td>
</tr>
</tbody>
</table>
<h3 id="io_csr_fsisoff">io_csr_fsIsOff</h3>
<p>指示是否使能了fs.CSR，对非法指令的判断很关键。</p>
<h3 id="rob_commits-来自rob的提交信息">rob_commits 来自ROB的提交信息</h3>
<p>共分为8个相同结构的rob_commit，包含以下成员</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>ftqIdx</td>
<td>预测块指针</td>
</tr>
<tr>
<td>ftqOffset</td>
<td>预测块的大小</td>
</tr>
</tbody>
</table>
<h3 id="pmp">pmp</h3>
<p>和物理内存保护相关，在mmio状态下重发请求时使用。</p>
<h4 id="req">req</h4>
<p>IFU向pmp发起的请求，传递前一步从ITLB查询得到的物理地址。</p>
<h4 id="resp">resp</h4>
<p>PMP给IFU的回复结果，包含以下成员</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>mmio</td>
<td>在MMIO空间</td>
</tr>
<tr>
<td>instr</td>
<td>对指令的判断结果，当指令不可执行时，该值为true</td>
</tr>
</tbody>
</table>
<h3 id="mmio_commits">mmio_commits</h3>
<h4 id="mmioftqptr">mmioFtqPtr</h4>
<p>IFU传递给FTQ的idx，用于查询上一个预测块的MMIO状态</p>
<h4 id="mmiolastcommit">mmioLastCommit</h4>
<p>上一个请求是MMIO请求</p>
<h3 id="frontendtrigger">frontendTrigger</h3>
<p>用于设置前端断点</p>
<p>包含以下成员：</p>
<h4 id="debugmode">debugMode</h4>
<p>debug的模式</p>
<h4 id="triggercanraisebpexp">triggerCanRaiseBpExp</h4>
<p>trigger是否可以引起断点异常</p>
<h4 id="tenablevec">tEnableVec</h4>
<p>信号数组，表示是否使能对应的trigger</p>
<h4 id="tupdate">tupdate</h4>
<p>表示更新的断点信息，其中包含tdata和addr，addr是请求设置的断点idx。</p>
<p>tdata包括下列成员：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>matchType</td>
<td>断点匹配类型，等于、大于、小于</td>
</tr>
<tr>
<td>action</td>
<td>触发执行的动作</td>
</tr>
<tr>
<td>tdata2</td>
<td>触发端点的基准数值</td>
</tr>
<tr>
<td>select</td>
<td>是否选择</td>
</tr>
<tr>
<td>chain</td>
<td>是否传导</td>
</tr>
</tbody>
</table>
<h2 id="ifu功能点和测试点">IFU功能点和测试点</h2>
<h3 id="功能点1-接收ftq预测块请求">功能点1 接收FTQ预测块请求</h3>
<h4 id="功能点11-f0流水级接收请求">功能点1.1 F0流水级接收请求</h4>
<p>向FTQ报告自己已ready。</p>
<p>所以，我们只需要在发送请求后检查和ftq相关的的ready情况即可。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ready置位</td>
<td>IFU接收FTQ请求后，设置ready</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-指令切分产生初始指令码">功能点2 指令切分产生初始指令码</h3>
<h4 id="功能点21-f1流水级计算信息和切分指针">功能点2.1 F1流水级计算信息和切分指针</h4>
<p>F1流水级也会计算PC。</p>
<p>同时还需要生成17位的切分指针（也就是从拼接后的缓存行切出初始指令码的idx数组，在昆明湖架构中，计算方式为拼接00和startAddr[5:1]，
然后分别与0～16相加） 用于后续从缓存行提取初始指令码。</p>
<p>所以，首先我们需要检查F1流水级生成的PC的正确与否。如果可能，也需要检查一下切分指针的生成。</p>
<p>所以，可以总结出以下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1.1</td>
<td>PC生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成PC</td>
</tr>
<tr>
<td>2.1.2</td>
<td>切取指针生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成后续切取缓存行的指针</td>
</tr>
</tbody>
</table>
<h4 id="功能点22-f2流水级获取指令信息">功能点2.2 F2流水级获取指令信息</h4>
<p>包括获取异常信息、物理地址、客户物理地址、是否在MMIO空间等。</p>
<p>获取异常信息之后，还需要计算异常向量。ICache会为每个缓存行返回一个异常类型，只需要计算每个指令pc属于哪个缓存行，
然后将对应缓存行的异常类型赋给该位置即可。</p>
<p>所以，只需要分别检查几种指令信息即可。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.2.1</td>
<td>异常向量生成</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个指令的异常向量</td>
</tr>
<tr>
<td>2.2.2</td>
<td>物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个端口的物理地址。</td>
</tr>
<tr>
<td>2.2.3</td>
<td>客户物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成0号端口的客户物理地址。</td>
</tr>
<tr>
<td>2.2.4</td>
<td>MMIO空间信息提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果判断当前取指请求是否属于MMIO空间。</td>
</tr>
</tbody>
</table>
<h4 id="功能点23-f2流水级计算预测块有效指令范围">功能点2.3 F2流水级计算预测块有效指令范围</h4>
<p>指令有效范围包括两种，无跳转和有跳转的</p>
<p>无跳转的指令有效范围为当前预测块从起始地址到下一个预测块的起始地址的所有指令。</p>
<p>有跳转的指令有效范围jump_range为当前预测块的起始地址到预测块中第一个跳转指令地址（包含第一个跳转指令地址）之间的所有指令。</p>
<p>最终的指令有效范围是两者相与的结果。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.3.1</td>
<td>无跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算无跳转指令有效范围</td>
</tr>
<tr>
<td>2.3.2</td>
<td>有跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算跳转指令有效范围</td>
</tr>
</tbody>
</table>
<h4 id="功能点24-提取初始指令码">功能点2.4 提取初始指令码</h4>
<p>IFU需要将ICache返回的缓存行复制一份并拼接。然后利用上一流水级计算的idx数组，从缓存行提取17x2字节的初始指令码。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.4</td>
<td>切取初始指令码</td>
<td>IFU根据上一流水级的切取指针，从缓存行提取初始指令码。</td>
</tr>
</tbody>
</table>
<h3 id="功能点3-预译码">功能点3 预译码</h3>
<p>多数的功能都由preDecoder子模块完成，因此这里只罗列由IFU本身需要完成的功能。</p>
<h4 id="功能点31-f3流水级选取指令有效向量">功能点3.1 F3流水级选取指令有效向量</h4>
<p>由于存在跨缓存行的32位指令，IFU需要做的是，根据上一个预测块最后两字节是否为一条RVI指令的开始，从两种指令有效开始向量中，选择一种。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1.1</td>
<td>上一预测块结尾为RVC或RVI下半部分</td>
<td>上一预测块的最后2字节恰为RVC指令或RVI指令的后半部分，选择第一位为True的有效开始向量</td>
</tr>
<tr>
<td>3.1.2</td>
<td>上一预测块结尾为RVI上半部分</td>
<td>上一预测块的最后2字节为RVI，选择第一位为False的有效开始向量</td>
</tr>
</tbody>
</table>
<h3 id="功能点4-指令扩展">功能点4 指令扩展</h3>
<p>将PreDecode返回的16条指令码分别送交指令扩展其进行32位指令扩展，RVI保持不变。RVC指令根据手册规定进行扩展。
如果指令非法，则需要将原始指令填写到CSR（控制状态寄存器）中。IFU自身仅仅控制最后填写的是哪种指令。</p>
<p>所以，我们对IFU模块，只关注最后写的指令是何种指令。注意，这里可以修改fsIsOff的入参，测试c.fp指令是否返回原始指令码</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>4.1</td>
<td>合法RVC指令写扩展指令码</td>
<td>对合法RVC指令，写扩展后的指令码</td>
</tr>
<tr>
<td>4.2</td>
<td>非法RVC指令写原始指令码</td>
<td>对非法RVC指令，写原始指令码</td>
</tr>
<tr>
<td>4.3</td>
<td>RVI指令不扩展</td>
<td>RVI指令直接写入原始指令即可</td>
</tr>
</tbody>
</table>
<h3 id="功能点5-预测错误预检">功能点5 预测错误预检</h3>
<p>主要由PredChecker子模块完成。测试点和PredChecker子模块的测试点类似，IFU没有额外的测试点。预检可以和重定向一起测试。</p>
<h3 id="功能点6-前端重定向和流水线冲刷">功能点6 前端重定向和流水线冲刷</h3>
<h4 id="功能点61-预测错误重定向">功能点6.1 预测错误重定向</h4>
<p>如果发现了预检阶段检出的错误，则需要产生前端重定向，将F3以外的流水级冲刷</p>
<p>只需要构造有预测错误的预测请求，检查冲刷情况即可。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.1.1</td>
<td>JAL预测错误冲刷</td>
<td>预测请求中存在JAL预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.2</td>
<td>RET预测错误冲刷</td>
<td>预测请求中存在RET预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.3</td>
<td>非CFI预测错误冲刷</td>
<td>预测请求中存在非CFI预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.4</td>
<td>无效指令预测错误冲刷</td>
<td>预测请求中存在无效指令预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.5</td>
<td>跳转目标错误冲刷</td>
<td>预测请求中存在跳转目标错误，需要冲刷流水线</td>
</tr>
</tbody>
</table>
<h4 id="功能点62-跨预测块32位指令处理">功能点6.2 跨预测块32位指令处理</h4>
<p>如果发现当前预测块的最后两个字节是一条RVI指令的开始，则设置一个标识f3_lastHalf_valid，告诉接下来的预测块含有后半条指令。</p>
<p>我们没有办法直接观察到这个标识，但是可以通过下一预测块来判定：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.2.1</td>
<td>跨预测块32位指令处理</td>
<td>连续传入两个预测块，其中有一条32位指令跨两个预测块，后一个预测块的指令开始向量的首位应该为False</td>
</tr>
</tbody>
</table>
<p>但是，如果这一判断出现问题（比如当前预测块存在跳转），则需要进行流水线冲刷。</p>
<p>这一功能需要PredChecker子模块“配合”（仅仅通过外部IO的修改很难触发这个防御机制），实现起来比较麻烦，但是还是列举一个测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.2.2</td>
<td>跨预测块指令误判</td>
<td>当IFU根据PredChecker修复的指令有效范围错判了跨预测块指令时，需要将F3以外的流水级全部冲刷</td>
</tr>
</tbody>
</table>
<h3 id="功能点7-将指令码和前端信息输出给ibuffer">功能点7 将指令码和前端信息输出给IBuffer</h3>
<h4 id="功能点71-传送指令码和前端信息">功能点7.1 传送指令码和前端信息</h4>
<p>传送给IBuffer的信息包括：经过扩展的32位指令码、16条指令中每条指令的例外信息、预译码信息、FTQ队列中的指针位置、其他后端需要的信息（经过折叠的PC）、
io_toIbuffer_bits_valid（表示指令是否是一条指令的开始）、io_toIbuffer_bits_enqEnable（前者与上被修正过的预测块指令范围，
从而还能表示指令是否在预测块表示的指令范围内）。</p>
<p>这里要做的只是确认这些信息是否正确传递</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.1.1</td>
<td>指令码传送</td>
<td>IFU向IBuffer传送扩展后的指令码</td>
</tr>
<tr>
<td>7.1.2</td>
<td>异常信息传送</td>
<td>IFU向IBuffer传送每个指令的异常信息</td>
</tr>
<tr>
<td>7.1.3</td>
<td>预译码信息传送</td>
<td>IFU向IBuffer传递每个指令的预译码信息</td>
</tr>
<tr>
<td>7.1.4</td>
<td>FTQ指针传送</td>
<td>IFU向IBuffer传送FTQ预测块的指针</td>
</tr>
<tr>
<td>7.1.5</td>
<td>折叠PC传送</td>
<td>IFU向IBuffer传送折叠的PC</td>
</tr>
<tr>
<td>7.1.6</td>
<td>有效开始向量</td>
<td>IFU向IBuffer传送表示指令有效和指令是否为指令开始的向量</td>
</tr>
</tbody>
</table>
<h4 id="功能点72-客户页错误传送gpaddr信息">功能点7.2 客户页错误传送gpaddr信息</h4>
<p>当且仅当发生guest page fault时，后端需要gpaddr信息，为了节省面积，gpaddr不走正常通路进入ibuffer，
而是随ftqPtr被发送到gpaMem，后端需要时从gpaMem读出。IFU需要保证gpf发生时通向gpaMem的valid拉高、gpaddr正确，同时还要传递预测块的ftqIdx（通过waddr传入）。</p>
<p>这里我们只需要确保在客户页错误发生时通向gpaMem的valid为高，且gpaddr正确填入。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.2</td>
<td>客户页错误</td>
<td>客户页错误发生时，IFU应将gpaMem的valid拉高且填入gpaddr</td>
</tr>
</tbody>
</table>
<h3 id="功能点8-分支预测冲刷流水线">功能点8 分支预测冲刷流水线</h3>
<p>当精确预测器发现简单预测器错误时，通知IFU取消正在进行的取指请求。</p>
<h4 id="功能点81-核验指针">功能点8.1 核验指针</h4>
<p>IFU收到BPU冲刷请求后，会将F0/F1流水级上取指令请求的指针比较，冲刷的指针在取指之前，即当前取指令请求在错误的执行路径上，才需要
冲刷IFU。</p>
<p>我们仍然需要从两个方向校验这个功能，即当冲刷指针在取指令的指针之前时，IFU能够对流水线进行冲刷。
然而，当冲刷指令在取指令的指针之后时，则不能对流水线进行冲刷。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.1.1</td>
<td>错误执行路径</td>
<td>当冲刷指针在取指令的指针之前时，IFU能够对流水线进行冲刷。</td>
</tr>
<tr>
<td>8.1.2</td>
<td>执行路径无误</td>
<td>当冲刷指令在取指令的指针之后时，IFU不能对流水线进行冲刷。</td>
</tr>
</tbody>
</table>
<h4 id="功能点82-bpu-s2流水级发现错误">功能点8.2 BPU S2流水级发现错误</h4>
<p>BPU的S2流水级发现错误时，需冲刷IFU的F0流水级</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>测试点8.2</td>
<td>BPU S2流水级发现错误</td>
<td>当BPU的S2流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0流水级进行冲刷</td>
</tr>
</tbody>
</table>
<h4 id="功能点83-bpu-s3流水级发现错误">功能点8.3 BPU S3流水级发现错误</h4>
<p>BPU的S3流水级发现错误时，需要冲刷IFU的F0和F1流水级</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.3</td>
<td>BPU S3流水级发现错误</td>
<td>当BPU的S3流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0和F1流水级进行冲刷</td>
</tr>
</tbody>
</table>
<h3 id="功能点9-指令信息和误预测信息写回ftq">功能点9 指令信息和误预测信息写回FTQ</h3>
<h4 id="功能点91-写回指令信息和误预测信息">功能点9.1 写回指令信息和误预测信息</h4>
<p>将指令PC、预译码信息、错误预测指令的位置、正确的跳转地址以及预测块的正确指令范围等信息写回FTQ，并传递该预测块的FTQ指针。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.1.1</td>
<td>写回指令PC</td>
<td>IFU的WB流水级，需要向FTQ写回指令PC</td>
</tr>
<tr>
<td>9.1.2</td>
<td>写回预译码信息</td>
<td>IFU的WB流水级，需要向FTQ写回每个指令的预译码信息</td>
</tr>
<tr>
<td>9.1.3</td>
<td>写回误预测指令位置</td>
<td>IFU的WB流水级，需要向FTQ写回BPU错误预测的指令位置</td>
</tr>
<tr>
<td>9.1.4</td>
<td>写回正确跳转地址</td>
<td>IFU的WB流水级，需要向FTQ写回该预测块的正确跳转地址</td>
</tr>
<tr>
<td>9.1.5</td>
<td>写回正确指令范围</td>
<td>IFU的WB流水级，需要向FTQ写回预测块的正确指令范围</td>
</tr>
<tr>
<td>9.1.6</td>
<td>传递预测块FTQ指针</td>
<td>IFU的WB流水级，需要向FTQ传递预测块的FTQ指针</td>
</tr>
</tbody>
</table>
<h3 id="功能点10-mmio处理">功能点10 MMIO处理</h3>
<h4 id="功能点101-上电复位处理">功能点10.1 上电复位处理</h4>
<p>处理器上电复位时，IFU需向MMIO总线发送宽度为64位的请求从flash地址空间取指令，并禁止对MMIO总线的推测执行。</p>
<p>上电的情况和正常情况其实没有任何区别，但是，上电时的MMIO请求没有任何差别，只是，第一条请求一定是MMIO，并且不需要等待。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1</td>
<td>第一条MMIO指令</td>
<td>IFU收到的第一条MMIO请求可以直接查询Instr Uncache</td>
</tr>
</tbody>
</table>
<h4 id="功能点102-向instruncache发送请求">功能点10.2 向InstrUncache发送请求</h4>
<p>在正常的处理逻辑下，如果请求地址处于MMIO地址空间，则IFU会向FTQ查询指令提交状态，IFU需要等待当前请求之前的所有请求（包括MMIO和非MMIO）提交完成，
才能向InstrUncache模块发送请求。</p>
<p>这里需要和FTQ交互，可以让FTQ模拟请求提交情况，从而测试等待情况。
如果MMIO请求之前的请求都已经提交，则也不需要等待。反之，则需要一直等待直到查询结果表明前面的指令均已提交。故设计测试点如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.2.1</td>
<td>阻塞等待提交</td>
<td>IFU收到MMIO请求后，查询FTQ，如果前面还有尚未提交的指令，持续等待</td>
</tr>
<tr>
<td>10.2.2</td>
<td>无阻塞发送请求</td>
<td>如果查到FTQ不再有未提交的指令，则IFU将指令发送给Instr Uncache</td>
</tr>
</tbody>
</table>
<h4 id="功能点103-跨总线请求处理">功能点10.3 跨总线请求处理</h4>
<p>由于MMIO不支持非对齐访问，因此当检测到的RVI指令地址[2,1]两位为b11时，64位总线无法一次传递所有指令，所以需要增加地址进行重发，再次查询ITLB。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.3.1</td>
<td>重发查询ITLB</td>
<td>遇到一次无法查询完毕的RVI指令时，需要向ITLB查询获得新增指令的物理地址</td>
</tr>
</tbody>
</table>
<p>如果存在异常，则直接将指令和异常信息发送到IBuffer并等待，否则向PMP发送请求。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.3.2.1</td>
<td>ITLB异常</td>
<td>IFU查询ITLB出现异常时，应当将异常信息发送到IBuffer，然后等待ROB提交完成</td>
</tr>
<tr>
<td>10.3.2.2</td>
<td>ITLB返回物理地址</td>
<td>IFU查询ITLB正常返回物理地址时，IFU继续向PMP请求检查</td>
</tr>
</tbody>
</table>
<p>根据pmp_recheck的结果，如果和上一次请求状态不一致，则说明存在访问错误，
为访问异常，不然则根据PMP的回复结果决定是否存在异常。如存在异常（访问异常和其他异常），则将报错信息发送给IBuffer并等待。如无异常，重新向InstrUncache模块
发送请求。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.3.3.1</td>
<td>请求状态不一致</td>
<td>IFU检查PMP之后如果发现重发请求状态和上一条请求状态不一致，是访问异常，需要将异常直接发送到IBuffer</td>
</tr>
<tr>
<td>10.3.3.2</td>
<td>PMP检查异常</td>
<td>PMP检查出现异常的情况下，也需要将异常直接发送到IBuffer并等待ROB提交。</td>
</tr>
<tr>
<td>10.3.3.3</td>
<td>Instr Cache请求重发</td>
<td>PMP检查若无异常，则向Instr Uncache发送请求获取指令码的后半部分。</td>
</tr>
</tbody>
</table>
<h4 id="功能点104-向ibuffer发送指令">功能点10.4 向IBuffer发送指令</h4>
<p>IFU获得完整数据之后，根据地址从64位数据中截取指令码，并以每个预测块一条指令的形式发送到Ibuffer。等待ROB返回指令已提交的信号。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.4</td>
<td>向IBuffer发送指令</td>
<td>IFU在获得完整数据后，截取获得指令码，以每个预测块一条指令的形式发送给IBuffer</td>
</tr>
</tbody>
</table>
<h4 id="功能点105-指令冲刷">功能点10.5 指令冲刷</h4>
<p>CFI指令的冲刷由后端发送给FTQ完成。所以不需要在这里设置测试点。</p>
<p>顺序指令由IFU复用前端重定向通路刷新流水线，并复用FTQ写回机制，将该指令当作误预测指令冲刷，重定向到+2或+4的位置。</p>
<p>+2和+4是由RVC和RVI指令决定的，所以设置测试点如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.5.1</td>
<td>RVI指令重定向</td>
<td>如果是RVI指令，传递给FTQ的冲刷请求应该重定向到PC+4</td>
</tr>
<tr>
<td>10.5.2</td>
<td>RVC指令重定向</td>
<td>如果是RVC指令，传递给FTQ的冲刷请求应该重定向到PC+2</td>
</tr>
</tbody>
</table>
<h4 id="功能点11-硬件断点">功能点11 硬件断点</h4>
<p>该功能主要由FrontEndTrigger子模块完成。不需要为这一功能额外设置测试点（参照FrontendTrigger的测试点即可）</p>
<h4 id="a-idifu_functions测试点汇总-a"><strong><a id="ifu_functions">测试点汇总 </a></strong></h4>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>接收FTQ预测块请求</td>
<td>ready置位</td>
<td>IFU接收FTQ请求后，设置ready</td>
</tr>
<tr>
<td>2.1.1</td>
<td>F1流水级计算信息和切分指针</td>
<td>PC生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成PC</td>
</tr>
<tr>
<td>2.1.2</td>
<td>F1流水级计算信息和切分指针</td>
<td>切取指针生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成后续切取缓存行的指针</td>
</tr>
<tr>
<td>2.2.1</td>
<td>F2流水级获取指令信息</td>
<td>异常向量生成</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个指令的异常向量</td>
</tr>
<tr>
<td>2.2.2</td>
<td>F2流水级获取指令信息</td>
<td>物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个端口的物理地址。</td>
</tr>
<tr>
<td>2.2.3</td>
<td>F2流水级获取指令信息</td>
<td>客户物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成0号端口的客户物理地址。</td>
</tr>
<tr>
<td>2.2.4</td>
<td>F2流水级获取指令信息</td>
<td>MMIO空间信息提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果判断当前取指请求是否属于MMIO空间。</td>
</tr>
<tr>
<td>2.3.1</td>
<td>F2流水级计算预测块有效指令范围</td>
<td>无跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算无跳转指令有效范围</td>
</tr>
<tr>
<td>2.3.2</td>
<td>F2流水级计算预测块有效指令范围</td>
<td>有跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算跳转指令有效范围</td>
</tr>
<tr>
<td>2.4</td>
<td>提取初始指令码</td>
<td>切取初始指令码</td>
<td>IFU根据上一流水级的切取指针，从缓存行提取初始指令码。</td>
</tr>
<tr>
<td>3.1.1</td>
<td>F3流水级选取指令有效向量</td>
<td>上一预测块结尾为RVC或RVI下半部分</td>
<td>上一预测块的最后2字节恰为RVC指令或RVI指令的后半部分，选择第一位为True的有效开始向量</td>
</tr>
<tr>
<td>3.1.2</td>
<td>F3流水级选取指令有效向量</td>
<td>上一预测块结尾为RVI上半部分</td>
<td>上一预测块的最后2字节为RVI，选择第一位为False的有效开始向量</td>
</tr>
<tr>
<td>4.1</td>
<td>指令扩展</td>
<td>合法RVC指令写扩展指令码</td>
<td>对合法RVC指令，写扩展后的指令码</td>
</tr>
<tr>
<td>4.2</td>
<td>指令扩展</td>
<td>非法RVC指令写原始指令码</td>
<td>对非法RVC指令，写原始指令码</td>
</tr>
<tr>
<td>4.3</td>
<td>指令扩展</td>
<td>RVI指令不扩展</td>
<td>RVI指令直接写入原始指令即可</td>
</tr>
<tr>
<td>6.1.1</td>
<td>预测错误重定向</td>
<td>JAL预测错误冲刷</td>
<td>预测请求中存在JAL预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.2</td>
<td>预测错误重定向</td>
<td>RET预测错误冲刷</td>
<td>预测请求中存在RET预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.3</td>
<td>预测错误重定向</td>
<td>非CFI预测错误冲刷</td>
<td>预测请求中存在非CFI预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.4</td>
<td>预测错误重定向</td>
<td>无效指令预测错误冲刷</td>
<td>预测请求中存在无效指令预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.5</td>
<td>预测错误重定向</td>
<td>跳转目标错误冲刷</td>
<td>预测请求中存在跳转目标错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.2.1</td>
<td>跨预测块32位指令处理</td>
<td>跨预测块32位指令处理</td>
<td>连续传入两个预测块，其中有一条32位指令跨两个预测块，后一个预测块的指令开始向量的首位应该为False</td>
</tr>
<tr>
<td>6.2.2</td>
<td>跨预测块32位指令处理</td>
<td>跨预测块指令误判</td>
<td>当IFU根据PredChecker修复的指令有效范围错判了跨预测块指令时，需要将F3以外的流水级全部冲刷</td>
</tr>
<tr>
<td>7.1.1</td>
<td>传送指令码和前端信息</td>
<td>指令码传送</td>
<td>IFU向IBuffer传送扩展后的指令码</td>
</tr>
<tr>
<td>7.1.2</td>
<td>传送指令码和前端信息</td>
<td>异常信息传送</td>
<td>IFU向IBuffer传送每个指令的异常信息</td>
</tr>
<tr>
<td>7.1.3</td>
<td>传送指令码和前端信息</td>
<td>预译码信息传送</td>
<td>IFU向IBuffer传递每个指令的预译码信息</td>
</tr>
<tr>
<td>7.1.4</td>
<td>传送指令码和前端信息</td>
<td>FTQ指针传送</td>
<td>IFU向IBuffer传送FTQ预测块的指针</td>
</tr>
<tr>
<td>7.1.5</td>
<td>传送指令码和前端信息</td>
<td>折叠PC传送</td>
<td>IFU向IBuffer传送折叠的PC</td>
</tr>
<tr>
<td>7.1.6</td>
<td>传送指令码和前端信息</td>
<td>有效开始向量</td>
<td>IFU向IBuffer传送表示指令有效和指令是否为指令开始的向量</td>
</tr>
<tr>
<td>7.2</td>
<td>客户页错误传送gpaddr信息</td>
<td>客户页错误</td>
<td>客户页错误发生时，IFU应将gpaMem的valid拉高且填入gpaddr</td>
</tr>
<tr>
<td>8.1.1</td>
<td>核验指针</td>
<td>错误执行路径</td>
<td>当冲刷指针在取指令的指针之前时，IFU能够对流水线进行冲刷。</td>
</tr>
<tr>
<td>8.1.2</td>
<td>核验指针</td>
<td>执行路径无误</td>
<td>当冲刷指令在取指令的指针之后时，IFU不能对流水线进行冲刷。</td>
</tr>
<tr>
<td>8.2</td>
<td>BPU S2流水级发现错误</td>
<td>BPU S2流水级发现错误</td>
<td>当BPU的S2流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0流水级进行冲刷</td>
</tr>
<tr>
<td>8.3</td>
<td>BPU S2流水级发现错误</td>
<td>BPU S3流水级发现错误</td>
<td>当BPU的S3流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0和F1流水级进行冲刷</td>
</tr>
<tr>
<td>9.1.1</td>
<td>写回指令信息和误预测信息</td>
<td>写回指令PC</td>
<td>IFU的WB流水级，需要向FTQ写回指令PC</td>
</tr>
<tr>
<td>9.1.2</td>
<td>写回指令信息和误预测信息</td>
<td>写回预译码信息</td>
<td>IFU的WB流水级，需要向FTQ写回每个指令的预译码信息</td>
</tr>
<tr>
<td>9.1.3</td>
<td>写回指令信息和误预测信息</td>
<td>写回误预测指令位置</td>
<td>IFU的WB流水级，需要向FTQ写回BPU错误预测的指令位置</td>
</tr>
<tr>
<td>9.1.4</td>
<td>写回指令信息和误预测信息</td>
<td>写回正确跳转地址</td>
<td>IFU的WB流水级，需要向FTQ写回该预测块的正确跳转地址</td>
</tr>
<tr>
<td>9.1.5</td>
<td>写回指令信息和误预测信息</td>
<td>写回指令范围</td>
<td>IFU的WB流水级，需要向FTQ写回预测块的正确指令范围</td>
</tr>
<tr>
<td>9.1.6</td>
<td>写回指令信息和误预测信息</td>
<td>传递预测块FTQ指针</td>
<td>IFU的WB流水级，需要向FTQ传递预测块的FTQ指针</td>
</tr>
<tr>
<td>10.1</td>
<td>上电复位处理</td>
<td>第一条MMIO指令</td>
<td>IFU收到的第一条MMIO请求可以直接查询Instr Uncache</td>
</tr>
<tr>
<td>10.2.1</td>
<td>向InstrUncache发送请求</td>
<td>阻塞等待提交</td>
<td>IFU收到MMIO请求后，查询FTQ，如果前面还有尚未提交的指令，持续等待</td>
</tr>
<tr>
<td>10.2.2</td>
<td>向InstrUncache发送请求</td>
<td>无阻塞发送请求</td>
<td>如果查到FTQ不再有未提交的指令，则IFU将指令发送给Instr Uncache</td>
</tr>
<tr>
<td>10.3.1</td>
<td>跨总线请求处理</td>
<td>重发查询ITLB</td>
<td>遇到一次无法查询完毕的RVI指令时，需要向ITLB查询获得新增指令的物理地址</td>
</tr>
<tr>
<td>10.3.2.1</td>
<td>跨总线请求处理</td>
<td>ITLB异常</td>
<td>IFU查询ITLB出现异常时，应当将异常信息发送到IBuffer，然后等待ROB提交完成</td>
</tr>
<tr>
<td>10.3.2.2</td>
<td>跨总线请求处理</td>
<td>ITLB返回物理地址</td>
<td>IFU查询ITLB正常返回物理地址时，IFU继续向PMP请求检查</td>
</tr>
<tr>
<td>10.3.3.1</td>
<td>跨总线请求处理</td>
<td>请求状态不一致</td>
<td>IFU检查PMP之后如果发现重发请求状态和上一条请求状态不一致，是访问异常，需要将异常直接发送到IBuffer</td>
</tr>
<tr>
<td>10.3.3.2</td>
<td>跨总线请求处理</td>
<td>PMP检查异常</td>
<td>PMP检查出现异常的情况下，也需要将异常直接发送到IBuffer并等待ROB提交。</td>
</tr>
<tr>
<td>10.3.3.3</td>
<td>跨总线请求处理</td>
<td>Instr Cache请求重发</td>
<td>PMP检查若无异常，则向Instr Uncache发送请求获取指令码的后半部分。</td>
</tr>
<tr>
<td>10.4</td>
<td>向IBuffer发送指令</td>
<td>向IBuffer发送指令</td>
<td>IFU在获得完整数据后，截取获得指令码，以每个预测块一条指令的形式发送给IBuffer</td>
</tr>
<tr>
<td>10.5.1</td>
<td>指令冲刷</td>
<td>RVI指令重定向</td>
<td>如果是RVI指令，传递给FTQ的冲刷请求应该重定向到PC+4</td>
</tr>
<tr>
<td>10.5.2</td>
<td>指令冲刷</td>
<td>RVC指令重定向</td>
<td>如果是RVC指令，传递给FTQ的冲刷请求应该重定向到PC+2</td>
</tr>
<tr>
<td>11.1.1</td>
<td>断点设置和检查</td>
<td>select1判定</td>
<td>给定tdata1的select位为1，随机构造其它输入，检查断点是否没有触发</td>
</tr>
<tr>
<td>11.1.2.1</td>
<td>断点设置和检查</td>
<td>select0关系匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>11.1.2.2</td>
<td>断点设置和检查</td>
<td>select0关系不匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位不匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>11.2.1</td>
<td>链式断点</td>
<td>chain位测试</td>
<td>对每个trigger，在满足PC断点触发条件的情况下，设置chain位，检查断点是否一定不触发</td>
</tr>
<tr>
<td>11.2.2</td>
<td>链式断点</td>
<td>timing测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，且两trigger的timing位不同，随机设置PC等，测试后一个trigger是否一定不触发</td>
</tr>
<tr>
<td>11.2.3.1</td>
<td>链式断点</td>
<td>未命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，且两trigger的timing位相同，设置后一个trigger命中而前一个未命中，检查后一个trigger是否一定不触发</td>
</tr>
<tr>
<td>11.2.3.2</td>
<td>链式断点</td>
<td>命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，且两trigger的timing位相同且均命中，检查后一个trigger是否触发</td>
</tr>
</tbody>
</table>
</div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f74282ae3d4b69fbe0da858a7c9107a5">12.2.1.1 - F3PreDecoder</h1>
    
	<div class="ifu-ctx">
<h1 id="子模块f3predecoder模块简介">子模块：F3PreDecoder模块简介</h1>
<p>这个模块是从PreDecoder中时序优化出来的，负责判定CFI指令的类型</p>
<h2 id="f3predecoder功能介绍">F3PreDecoder功能介绍</h2>
<h3 id="cfi指令类型判定">CFI指令类型判定</h3>
<p>要想确定CFI指令类型，只需要分别尝试匹配JAL、JALR、BR和他们的RVC版本即可，注意，RVC的EBREAK
不应该被视为CFI指令。在匹配的过程中，自然CFI指令的类型就被甄别出来了。在这一步中，我们将所有指令分到如下四类brType中：</p>
<table>
<thead>
<tr>
<th>CFI指令类型</th>
<th>brType类型编码</th>
</tr>
</thead>
<tbody>
<tr>
<td>非CFI</td>
<td>00</td>
</tr>
<tr>
<td>branch指令</td>
<td>01</td>
</tr>
<tr>
<td>jal指令</td>
<td>10</td>
</tr>
<tr>
<td>jalr指令</td>
<td>11</td>
</tr>
</tbody>
</table>
<h3 id="retcall判定">ret、call判定</h3>
<p>然后，我们需要判断是否为call或者ret，这可以通过rd和rs的取值来考察，具体来说，RISCV的RVI指令中，提供了对rd和rs取值的约定，
当二者取到link寄存器的序号（x1为标准的返回地址寄存器，x5为备用的link寄存器），分别对应着压栈和弹栈。详细的对应情况如下：</p>
<p><img alt="links" src="linkjal.png"></p>
<h2 id="f3predecoder接口说明">F3Predecoder接口说明</h2>
<p>in_instr: 传递 16 x 4B的拼接指令码</p>
<p>out_pd：每条指令的预译码信息，在F3Predecoder分析得到的是brType、isCall和isRet</p>
<h2 id="f3predecoder子模块测试点和功能点">F3PreDecoder子模块测试点和功能点</h2>
<h3 id="功能点1-cfi指令类型判定">功能点1 CFI指令类型判定</h3>
<p>要想确定CFI指令类型，只需要分别尝试匹配JAL、JALR、BR和他们的RVC版本即可，注意，RVC的EBREAK
不应该被视为CFI指令。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>非CFI判定</td>
<td>对传入的非CFI指令（包括RVC.EBREAK），应该判定为类型0</td>
</tr>
<tr>
<td>1.2</td>
<td>BR判定</td>
<td>对传入的BR指令，应该判定为类型1</td>
</tr>
<tr>
<td>1.3</td>
<td>JAL判定</td>
<td>对传入的JAL指令，应该判定为类型2</td>
</tr>
<tr>
<td>1.4</td>
<td>JALR判定</td>
<td>对传入的JALR指令，应该判定为类型3</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-retcall判定">功能点2 ret、call判定</h3>
<p>然后，需要判断是否为call或者ret，这可以通过rd和rs的取值来考察。当然，首先必须得满足无条件跳转指令。</p>
<p>对于类型2，只有不为RVC指令且目的寄存器rd为link寄存器（x1或x5）时，才为Call。</p>
<p>对于类型3，在RVI指令下，当rd为link寄存器时，必为Call。当rs为link寄存器且rd不为时，必为Ret。
在RVC指令下，对C.JALR指令，为call，对C.JR指令，当rs1为link时，为Ret</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>非CFI和BR不判定</td>
<td>对传入的非CFI和BR指令，都不应判定为call或者ret</td>
</tr>
<tr>
<td>2.2.1.1</td>
<td>RVI.JAL判定call</td>
<td>对传入的RVI.JAL指令，当rd设置为1或5，应当判定该指令为call</td>
</tr>
<tr>
<td>2.2.1.2</td>
<td>RVI.JAL例外</td>
<td>对传入的RVI.JAL指令，当rd设置为1和5之外的值，不应当判定该指令为call或ret</td>
</tr>
<tr>
<td>2.2.2</td>
<td>RVC.JAL不判定</td>
<td>对传入的RVC.JAL指令，无论什么情况都不能判定为call或ret</td>
</tr>
<tr>
<td>2.3.1.1</td>
<td>RVI.JALR和rd为link</td>
<td>传入RVI.JALR指令，并且rd为1或5，无论其他取值，都应判定为call</td>
</tr>
<tr>
<td>2.3.1.2</td>
<td>RVI.JALR且仅rs为link</td>
<td>传入RVI.JALR指令，rd不为1和5，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.3.1.3</td>
<td>RVI.JALR无link</td>
<td>对传入的JALR指令，若rd和rs均不为link，则不应判定为ret和cal</td>
</tr>
<tr>
<td>2.3.2.1</td>
<td>RVC.JALR为Ret</td>
<td>传入RVC.JALR指令，必定为call</td>
</tr>
<tr>
<td>2.3.2.2.1</td>
<td>RVC.JR且rs为link</td>
<td>传入RVC.JR指令，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.3.2.2.2</td>
<td>RVC.JR且rs不为link</td>
<td>传入RVC.JR指令，rs不为1或5，不应判定为ret</td>
</tr>
</tbody>
</table>
<h2 id="测试点汇总">测试点汇总</h2>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>CFI指令类型判定</td>
<td>非CFI判定</td>
<td>对传入的非CFI指令（包括RVC.EBREAK），应该判定为类型0</td>
</tr>
<tr>
<td>1.2</td>
<td>CFI指令类型判定</td>
<td>BR判定</td>
<td>对传入的BR指令，应该判定为类型1</td>
</tr>
<tr>
<td>1.3</td>
<td>CFI指令类型判定</td>
<td>JAL判定</td>
<td>对传入的JAL指令，应该判定为类型2</td>
</tr>
<tr>
<td>1.4</td>
<td>CFI指令类型判定</td>
<td>JALR判定</td>
<td>对传入的JALR指令，应该判定为类型3</td>
</tr>
<tr>
<td>2.1</td>
<td>ret、call判定</td>
<td>非CFI和BR不判定</td>
<td>对传入的非CFI和BR指令，都不应判定为call或者ret</td>
</tr>
<tr>
<td>2.2.1.1</td>
<td>ret、call判定</td>
<td>RVC.JAL判定call</td>
<td>对传入的RVC.JAL指令，当rd设置为1或5，应当判定该指令为call</td>
</tr>
<tr>
<td>2.2.1.2</td>
<td>ret、call判定</td>
<td>RVC.JAL例外</td>
<td>对传入的RVC.JAL指令，当rd设置为1和5之外的值，不应当判定该指令为call或ret</td>
</tr>
<tr>
<td>2.2.2</td>
<td>ret、call判定</td>
<td>RVI.JAL不判定</td>
<td>对传入的RVI.JAL指令，无论什么情况都不能判定为call或ret</td>
</tr>
<tr>
<td>2.3.1.1</td>
<td>ret、call判定</td>
<td>RVI.JALR和rd为link</td>
<td>传入RVI.JALR指令，并且rd为1或5，无论其他取值，都应判定为call</td>
</tr>
<tr>
<td>2.3.1.2</td>
<td>ret、call判定</td>
<td>RVI.JALR且仅rs为link</td>
<td>传入RVI.JALR指令，rd不为1和5，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.3.1.3</td>
<td>ret、call判定</td>
<td>RVI.JALR无link</td>
<td>对传入的JALR指令，若rd和rs均不为link，则不应判定为ret和cal</td>
</tr>
<tr>
<td>2.3.2.1</td>
<td>ret、call判定</td>
<td>RVC.JALR为Ret</td>
<td>传入RVC.JALR指令，必定为call</td>
</tr>
<tr>
<td>2.3.2.2.1</td>
<td>ret、call判定</td>
<td>RVC.JR且rs为link</td>
<td>传入RVC.JR指令，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.3.2.2.2</td>
<td>ret、call判定</td>
<td>RVC.JR且rs不为link</td>
<td>传入RVC.JR指令，rs不为1或5，不应判定为ret</td>
</tr>
</tbody>
</table>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3b78267f9199bb88f87206c813e08a73">12.2.1.2 - FrontendTrigger</h1>
    
	<div class="ifu-ctx">
<h1 id="frontendtrigger子模块">FrontendTrigger子模块</h1>
<p>该子模块的主要作用是在前端设置硬件断点和检查。</p>
<p>该模块的输入pc有一个隐含条件，那就是这个pc是通过ftq传递的startAddr计算出来的。</p>
<h2 id="frontendtrigger功能介绍">FrontendTrigger功能介绍</h2>
<h3 id="断点设置和断点检查">断点设置和断点检查</h3>
<p>在IFU的FrontendTrigger模块里共4个Trigger，编号为0,1,2,3，每个Trigger的配置信息（断点类型、匹配地址等）保存在tdata寄存器中。</p>
<p>当软件向CSR寄存器tselect、tdata1/2写入特定的值时，CSR会向IFU发送tUpdate请求，更新FrontendTrigger内的tdata寄存器中的配置信息。
目前前端的Trigger仅可以配置成PC断点（mcontrol(tdata1)寄存器的select位为0；当select=1时，该Trigger将永远不会命中，且不会产生异常）。</p>
<p>在取指时，IFU的F3流水级会向FrontendTrigger模块发起查询并在同一周期得到结果。后者会对取指块内每一条指令在每一个Trigger上做检查，
当指令的PC和tdata2寄存器内容的关系满足mcontrol的match位所指示的关系（香山支持match位为0、2、3，对应等于、大于等于、小于）时，
该指令会被标记为Trigger命中，随着执行在后端产生断点异常，进入M-Mode或调试模式。</p>
<h3 id="链式断点">链式断点</h3>
<p>根据RISCV的debug spec，香山实现的是mcontrol6。</p>
<p>当它们对应的Chain位被置时，只有当该Trigger和编号在它后面一位的Trigger同时命中，<del>且timing配置相同时</del>（在最新的手册中，这一要求已被删除），处理器才会产生异常。其中可以和6,8号trigger实现chain功能的7,9号trigger在后端访存部件中。</p>
<h2 id="frontendtrigger-接口说明">FrontendTrigger 接口说明</h2>
<p>设计上并没有提供一个或一组对外的接口来查询某个断点的状态，因此，要在测试中检查断点状态，要么需要检查内部信号的情况（仓库中提供的构建脚本已经暴露了所有内部信号），要么通过具体执行过程中，断点的触发情况来判定。</p>
<h3 id="输入接口">输入接口</h3>
<p>主要分为控制接口和执行信息（目前执行信息只有pc）</p>
<h4 id="控制接口-io_frontendtrigger">控制接口 io_frontendTrigger</h4>
<p>本接口存储了frontendTrigger的控制信息，包含以下信号/信号组：</p>
<h5 id="debugmode">debugMode</h5>
<p>当前是否处于debug模式下</p>
<h5 id="tenablevec">tEnableVec</h5>
<p>对FrontendTrigger的每个断点，指示其是否有效。</p>
<h5 id="tupdate">tUpdate</h5>
<p>更新断点的控制信息，包含以下信号/信号组：</p>
<p>valid：此次更新是否有效/是否更新。</p>
<p>bits_addr：此次更新的是哪个断点（0~3）</p>
<p>bits_tdata_action：断点触发条件达成后的行为</p>
<p>bits_tdata_chain：断点是否链式传导</p>
<p>bits_tdata_matchType：断点匹配类型（等于、大于、小于三种）</p>
<p>bits_tdata_select：目前为止，select为0时为pc断点</p>
<p>bits_tdata_tdata2：用于和PC比较的基准值</p>
<h5 id="triggercanraisebpexp">triggerCanRaiseBpExp</h5>
<p>trigger是否可以引起异常</p>
<h4 id="pc">pc</h4>
<p>pc有一个隐含条件，就是16条指令的pc必定是连续的</p>
<h3 id="输出接口">输出接口</h3>
<p>triggered：16条指令的断点触发情况。</p>
<h2 id="frontendtrigger-测试点和功能点">FrontEndTrigger 测试点和功能点</h2>
<h3 id="功能点1-设置断点和断点检查">功能点1 设置断点和断点检查</h3>
<p>FrontEndTrigger目前仅支持设置PC断点，这通过设置断点的tdata1寄存器的select位为0实现。
同时，tdata2寄存器的mcontrol位负责设置指令PC和tdata2寄存器的地址需要满足的关系，
关系满足时，该指令会被标记为trigger命中。</p>
<p>所以，基于以上功能描述，我们需要测试：</p>
<p>select位为1时，断点是否永远不会触发。</p>
<p>select位为0时，当PC和tdata2的数据的关系满足tdata2的match位时，是否会设置断点。</p>
<p>select位为0时，当PC和tdata2的数据的关系不满足tdata2的match位时，断点是否一定不会触发。</p>
<p>综上所述，我们在这一功能点设计的测试点如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>select1判定</td>
<td>给定tdata1的select位为1，随机构造其它输入，检查断点是否没有触发</td>
</tr>
<tr>
<td>1.2.1</td>
<td>select0关系匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>1.2.2</td>
<td>select0关系不匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位不匹配的输入，检查断点是否触发</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-链式断点">功能点2 链式断点</h3>
<p>当某一个trigger的chain位被置后，当其后的trigger的chain位未设置，且两个trigger均命中<del>并且两个trigger的timing相同</del>时，后一个trigger才会触发。</p>
<p>对0号trigger，不需要考虑链式的情况</p>
<p>由此，我们可以设置几种测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>chain位测试</td>
<td>对每个trigger，在满足PC断点触发条件的情况下，设置chain位，检查断点是否一定不触发。</td>
</tr>
<tr>
<td>2.2.1</td>
<td>未命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位<del>且两trigger的timing位相同</del>，设置后一个trigger命中而前一个未命中，检查后一个trigger是否一定不触发。</td>
</tr>
<tr>
<td>2.2.2</td>
<td>命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位<del>且两trigger的timing位相同</del>且均命中，检查后一个trigger是否触发。</td>
</tr>
</tbody>
</table>
<h2 id="测试点汇总"><strong>测试点汇总</strong></h2>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>断点设置和检查</td>
<td>select1判定</td>
<td>给定tdata1的select位为1，随机构造其它输入，检查断点是否没有触发</td>
</tr>
<tr>
<td>1.2.1</td>
<td>断点设置和检查</td>
<td>select0关系匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>1.2.2</td>
<td>断点设置和检查</td>
<td>select0关系不匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位不匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>2.1</td>
<td>链式断点</td>
<td>chain位测试</td>
<td>对每个trigger，在满足PC断点触发条件的情况下，设置chain位，检查断点是否一定不触发</td>
</tr>
<tr>
<td>2.2.1</td>
<td>链式断点</td>
<td>未命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，设置后一个trigger命中而前一个未命中，检查后一个trigger是否一定不触发</td>
</tr>
<tr>
<td>2.2.2</td>
<td>链式断点</td>
<td>命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，检查后一个trigger是否触发</td>
</tr>
</tbody>
</table>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-337a93058a969bd1106bbae43f51763d">12.2.1.3 - PredChecker</h1>
    
	<div class="ifu-ctx">
<h1 id="子模块predchecker简介">子模块：PredChecker简介</h1>
<p>分支预测检查器PredChecker接收来自IFU的预测块信息（包括预测跳转指令在预测块的位置、预测的跳转目标、预译码得到的指令信息、指令PC以及预译码得到的跳转目标偏移等），在模块内部检查五种类型的分支预测错误。模块内部分为两个流水线stage，分别输出信息，第一个stage输出给IFU的f3阶段，用于修正预测块的指令范围和预测结果。第二个stage输出给wb阶段，用于在发现分支预测错误时产生前端重定向以及写回给FTQ（Fetch Target Queue）正确的预测信息。</p>
<h2 id="predchecker功能介绍">PredChecker功能介绍</h2>
<h3 id="jal预测错误检查">JAL预测错误检查</h3>
<p>jal指令预测错误的条件是，预测块中有一条有效jal指令（由预译码信息给出），但是要么这个预测块没有预测跳转，要么此预测块预测跳转的指令在这条jal指令之后（即这条jal指令没有被预测跳转）。</p>
<h3 id="jalr预测错误检查">JALR预测错误检查</h3>
<p>jalr指令预测错误的条件是，预测块中有一条有效jalr指令（由预译码信息给出），而且这个指令不是ret指令，但是要么这个预测块没有预测跳转，要么此预测块预测跳转的指令在这条jalr指令之后（即这条jalr指令没有被预测跳转）。</p>
<h3 id="ret预测错误检查">RET预测错误检查</h3>
<p>ret指令预测错误的条件是，预测块中有一条有效ret指令（由预译码信息给出），但是要么这个预测块没有预测跳转，要么此预测块预测跳转的指令在这条ret指令之后（即这条ret指令没有被预测跳转）。</p>
<h3 id="更新指令有效范围向量">更新指令有效范围向量</h3>
<p>PredChecker在检查出Jal/Ret/JALR指令预测错误时，需要重新生成指令有效范围向量，有效范围截取到Jal/Ret指令的位置，之后的bit全部置为0。
需要注意的是，jal和ret指令的错误检查都会导致指令有效范围的缩短，
所以需要重新生成指令有效范伟fixedRange，同时修复预测结果。需要注意的是，这个修复只会针对RET预测错误和JAL预测错误导致的范围错误，对于后续要介绍的非CFI（控制流指令）预测错误和无效指令预测错误，尽管他们会造成预测块的范围偏小，但是不会进行修复，而是直接在这里进行重定向。这样，重定向后重新取的指令会从这个出错的指令开始。</p>
<h3 id="非cfi预测错误检查">非CFI预测错误检查</h3>
<p>非CFI预测错误的条件是被预测跳转的指令根据预译码信息显示不是一条CFI指令。</p>
<h3 id="无效指令预测错误检查">无效指令预测错误检查</h3>
<p>无效指令预测错误的条件是被预测的指令的位置根据预译码信息中的指令有效向量显示不是一条有效指令的开始。</p>
<h3 id="目标地址预测错误检查">目标地址预测错误检查</h3>
<p>目标地址预测错误的条件是，被预测的是一条有效的jal或者branch指令，同时预测的跳转目标地址和由指令码计算得到的跳转目标不一致。</p>
<h3 id="分级输出检查结果">分级输出检查结果</h3>
<p>以上PredChecker检查结果会分为两级分别输出，前面已经提到，Jal/Ret指令由于需要重新生成指令有效范围向量和重新指定预测位置，
所以需要在错误产生的当拍（F3）直接输出结果到Ibuffer用于及时更正进入后端的指令 。而由于时序的考虑，其他错误信息（比如五种错误的错误位置、正确的跳转地址等）则是等到下一拍（WB）阶段才返回给IFU做前端重定向。</p>
<h2 id="predchecker接口说明">PredChecker接口说明</h2>
<h3 id="输入接口">输入接口</h3>
<p>fire_in：这个信号可以简单认为是模块有效性的控制信号。</p>
<p>ftqOffset：来自BPU（分支预测单元）的预测信息，表示该预测块的跳转指令是否存在（valid），以及跳转指令的序号（bits）。</p>
<p>instrRange：来自PreDecode的预译码信息，对每条指令，表示该指令是否在预测块的有效指令范围内。</p>
<p>instrValid：来自PreDecode的预译码信息，表示的是对于每条32位的拼接指令，其是否为一条有效的指令（即低16位为一条RVC指令，或者整个32位为一条RVI指令）。</p>
<p>jumpOffset：来自PreDecode的预译码信息，如果某一指令为跳转指令，jumpOffset表示这个指令的跳转目标。</p>
<p>pc：指令的pc。</p>
<p>pds：来自PreDecode模块的预译码信息，包含指令的brType、是否为Ret（isRet）、是否为RVC指令（isRVC）。</p>
<p>target：来自BPU，下个预测块的开始地址。</p>
<h3 id="输出接口">输出接口</h3>
<h4 id="第一阶段输出">第一阶段输出</h4>
<p>fixedRange：修复的指令有效范围向量，对每条指令i，fixedRange_i为真表示这条指令是否在当前预测块的有效指令范围内</p>
<p>fixedTaken：修复过后的CFI指令选取情况，对每条指令，fixedTaken_i为真表示这条指令是否是这个预测块的第一条CFI指令</p>
<h4 id="第二阶段输出">第二阶段输出</h4>
<p>fixedMissPred：对每条指令，PredChecker检查出的存在预测错误的情况，fixedMissPred_i为真表示这条指令存在预测错误</p>
<p>fixedTarget：对每条指令，给出修复过的下一条指令的位置（可以是常规的pc+2或+4，或者如果是跳转指令，给出跳转目标）。</p>
<p>jalTarget：对每条指令，给出跳转目标。</p>
<p>faultType：每条指令的错误类型，取指范围包含noFault，jalFault，retFault，targetFault，notCFIFault，invalidTaken，jalrFault，分别对应数字0～6</p>
<h2 id="predchecker测试点和功能点">PredChecker测试点和功能点</h2>
<h3 id="功能点1-bpu预测信息的jal预测错误检查">功能点1 BPU预测信息的JAL预测错误检查</h3>
<p>PredChecker会对传入的预测块进行JAL预测错误预检查并修正指令有效范围向量和预测的跳转指令。</p>
<p>对这一模块的测试，我们分为两部分：正确的输入是否会误检和确有JAL检测错误的预测块输入能否检出。</p>
<p>对于误检，我们设计如下的测试点:</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1.1</td>
<td>误检测试1</td>
<td>预测块中没有JAL指令且BPU预测信息也没有取用任何跳转指令的输入，检查PredChecker是否会误报JAL预测错误。</td>
</tr>
<tr>
<td>1.1.2</td>
<td>误检测试2</td>
<td>预测块中有JAL指令且BPU预测信息取用的正是本条跳转指令的输入，检查PredChecker是否会误报JAL预测错误。</td>
</tr>
</tbody>
</table>
<p>对于JAL预测错误的正确检验，我们设计如下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.2.1</td>
<td>存在JAL未预测</td>
<td>预测块中存在JAL指令，但是BPU预测信息未预测跳转，检查PredChecker是否能检测出JAL预测错误。</td>
</tr>
<tr>
<td>1.2.2</td>
<td>预测的JAL并非第一条</td>
<td>预测块中存在JAL指令，但是BPU预测信息取的跳转指令在第一条JAL指令之后，检查PredChecker是否能检测出JAL预测错误。</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-bpu预测信息的ret预测错误检查">功能点2 BPU预测信息的RET预测错误检查</h3>
<p>PredChecker会对传入的预测块进行RET预测错误预检查并修正指令有效范围向量和新的预测结果。</p>
<p>和JAL预测错误类似，我们也按照误检和正检来构造。</p>
<p>对于误检，我们设计如下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1.1</td>
<td>误检测试1</td>
<td>预测块中没有RET指令且BPU预测信息也没有取用任何跳转指令的输入，检查PredChecker是否会误报RET预测错误。</td>
</tr>
<tr>
<td>2.1.2</td>
<td>误检测试2</td>
<td>预测块中有RET指令且BPU预测信息取用的正是本条跳转指令的输入，检查PredChecker是否会误报RET预测错误。</td>
</tr>
</tbody>
</table>
<p>对于RET预测错误的正确检出，我们设计如下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.2.1</td>
<td>存在RET未预测</td>
<td>预测块中存在RET指令，但是BPU预测信息未预测跳转，检查PredChecker是否能检测出RET预测错误。</td>
</tr>
<tr>
<td>2.2.2</td>
<td>预测的跳转并非第一条</td>
<td>预测块中存在RET指令，但是BPU预测信息取的跳转指令在第一条RET指令之后，检查PredChecker是否能检测出RET预测错误。</td>
</tr>
</tbody>
</table>
<h3 id="功能点3-bpu预测信息的jalr预测错误检查">功能点3 BPU预测信息的JALR预测错误检查</h3>
<p>PredChecker会对传入的预测块进行JALR预测错误预检查并修正指令有效范围向量和新的预测结果。</p>
<p>和JAL/RET预测错误类似，我们也按照误检和正检来构造。</p>
<p>对于误检，我们设计如下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1.1</td>
<td>误检测试1</td>
<td>预测块中没有JALR指令且BPU预测信息也没有取用任何跳转指令的输入，检查PredChecker是否会误报JALR预测错误。</td>
</tr>
<tr>
<td>3.1.2</td>
<td>误检测试2</td>
<td>预测块中有JALR指令且BPU预测信息取用的正是本条跳转指令的输入，检查PredChecker是否会误报JALR预测错误。</td>
</tr>
</tbody>
</table>
<p>对于JALR预测错误的正确检出，我们设计如下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.2.1</td>
<td>存在JALR未预测</td>
<td>预测块中存在JALR指令，但是BPU预测信息未预测跳转，检查PredChecker是否能检测出RET预测错误。</td>
</tr>
<tr>
<td>3.2.2</td>
<td>预测的跳转并非第一条</td>
<td>预测块中存在JALR指令，但是BPU预测信息取的跳转指令在第一条JALR指令之后，检查PredChecker是否能检测出JALR预测错误。</td>
</tr>
</tbody>
</table>
<h3 id="功能点4-更新指令有效范围向量和预测跳转的指令">功能点4 更新指令有效范围向量和预测跳转的指令</h3>
<p>PredChecker在检查出Jal/Ret指令预测错误时，需要重新生成指令有效范围向量，
有效范围截取到Jal/Ret指令的位置，之后的bit全部置为0。
同时，还需要根据每条指令的预译码信息和BPU的预测信息修复预测跳转的结果。</p>
<p>所以，根据功能要求，我们可以划分出三类情况，分别是预测的有效范围和取用的跳转指令正确的情况，
由于RET和JAL预测错误引起的有效范围偏大和错判非跳转指令和无效指令引起的有效范围偏小。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>4.1</td>
<td>有效范围无误</td>
<td>不存在任何错误的情况下，PredChecker应当保留之前的预测结果。</td>
</tr>
<tr>
<td>4.2</td>
<td>RET和JAL预测错误引起的范围偏大</td>
<td>如果检测到了JAL或RET类的预测错误，PredChecker应该将有效指令的范围修正为预测块开始至第一条跳转指令。同时，应该将预测跳转的指令位置修正为预测块中的第一条跳转指令。</td>
</tr>
<tr>
<td>4.3</td>
<td>非CFI和无效指令引起的预测范围偏小</td>
<td>如果出现了非控制流指令和无效指令的误预测，不应该将预测跳转的指令重新修正到预测块中第一条跳转指令，因为后续会直接冲刷并重新从重定向的位置取指令，如果这里修正的话，会导致下一预测块传入重复的指令</td>
</tr>
</tbody>
</table>
<h3 id="功能点5-非cfi预测错误检查">功能点5 非CFI预测错误检查</h3>
<p>非CFI预测错误的条件是被预测跳转的指令根据预译码信息显示不是一条CFI指令。</p>
<p>要检验这一功能，我们仍然按误检和正确检验来设计测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>5.1.1</td>
<td>误检测试1</td>
<td>构造不存在CFI指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检非CFI预测错误</td>
</tr>
<tr>
<td>5.1.2</td>
<td>误检测试2</td>
<td>构造存在CFI指令并且正确预测跳转的预测信息作为输入，测试PredChecker是否会错检非CFI预测错误</td>
</tr>
<tr>
<td>5.2</td>
<td>正确检测测试</td>
<td>构造不存在CFI指令但是预测了跳转的预测信息作为输入，测试PredChecker是否能检查出非CFI预测错误</td>
</tr>
</tbody>
</table>
<h3 id="功能点6-无效指令预测错误检查">功能点6 无效指令预测错误检查</h3>
<p>无效指令预测错误的条件是被预测的指令的位置根据预译码信息中的指令有效向量显示不是一条有效指令的开始。</p>
<p>要检验这一功能，我们按照误检和正确检测来设计测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.1.1</td>
<td>误检测试1</td>
<td>构造不存在跳转指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检无效指令预测错误</td>
</tr>
<tr>
<td>6.1.2</td>
<td>误检测试2</td>
<td>构造存在无效跳转指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检无效指令预测错误</td>
</tr>
<tr>
<td>6.1.3</td>
<td>误检测试3</td>
<td>构造存在有效跳转指令并且正确预测跳转的预测信息作为输入，测试PredChecker是否会错检无效指令预测错误</td>
</tr>
<tr>
<td>6.2</td>
<td>正确检测测试</td>
<td>构造无效指令但是预测了跳转的预测信息作为输入，测试PredChecker是否能检查出无效指令预测错误</td>
</tr>
</tbody>
</table>
<h3 id="功能点7-目标地址预测错误检查">功能点7 目标地址预测错误检查</h3>
<p>目标地址预测错误的条件是，被预测的是一条有效的jal或者branch指令，
同时预测的跳转目标地址和由指令码计算得到的跳转目标不一致。</p>
<p>和先前的思路一样，我们仍然按误检和检出两类组织测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.1.1</td>
<td>误检测试1</td>
<td>构造不存在跳转指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检目标地址预测错误</td>
</tr>
<tr>
<td>7.1.2</td>
<td>误检测试2</td>
<td>构造存在有效跳转指令并且正确预测跳转的预测信息作为输入，测试PredChecker是否会错检目标地址预测错误</td>
</tr>
<tr>
<td>7.2</td>
<td>正确检测测试</td>
<td>构造存在有效跳转指令的预测块和预测跳转但跳转目标计算错误的预测信息作为输入，测试PredChecker能否检出目标地址预测错误</td>
</tr>
</tbody>
</table>
<h3 id="功能点8-生成跳转和顺序目标">功能点8 生成跳转和顺序目标</h3>
<p>PredChecker还需要负责生成跳转和顺序目标。</p>
<p>我们通过随机生成译码信息进行测试</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.1</td>
<td>随机测试</td>
<td>随机提供译码信息，检测生成的跳转目标和顺序目标。</td>
</tr>
</tbody>
</table>
<h2 id="a-idpred_checker_functions测试点汇总a"><a id="pred_checker_functions">测试点汇总</a></h2>
<p>综上所述，所有的测试点如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1.1</td>
<td>BPU预测信息的JAL预测错误检查</td>
<td>误检测试1</td>
<td>预测块中没有JAL指令且BPU预测信息也没有取用任何跳转指令的输入，检查PredChecker是否会误报JAL预测错误。</td>
</tr>
<tr>
<td>1.1.2</td>
<td>BPU预测信息的JAL预测错误检查</td>
<td>误检测试2</td>
<td>预测块中有JAL指令且BPU预测信息取用的正是本条跳转指令的输入，检查PredChecker是否会误报JAL预测错误。</td>
</tr>
<tr>
<td>1.2.1</td>
<td>BPU预测信息的JAL预测错误检查</td>
<td>存在JAL未预测</td>
<td>预测块中存在JAL指令，但是BPU预测信息未预测跳转，检查PredChecker是否能检测出JAL预测错误。</td>
</tr>
<tr>
<td>1.2.2</td>
<td>BPU预测信息的JAL预测错误检查</td>
<td>预测的JAL并非第一条</td>
<td>预测块中存在JAL指令，但是BPU预测信息取的跳转指令在第一条JAL指令之后，检查PredChecker是否能检测出JAL预测错误。</td>
</tr>
<tr>
<td>2.1.1</td>
<td>BPU预测信息的RET预测错误检查</td>
<td>误检测试1</td>
<td>预测块中没有RET指令且BPU预测信息也没有取用任何跳转指令的输入，检查PredChecker是否会误报RET预测错误。</td>
</tr>
<tr>
<td>2.1.2</td>
<td>BPU预测信息的RET预测错误检查</td>
<td>误检测试2</td>
<td>预测块中有RET指令且BPU预测信息取用的正是本条跳转指令的输入，检查PredChecker是否会误报RET预测错误。</td>
</tr>
<tr>
<td>2.2.1</td>
<td>BPU预测信息的RET预测错误检查</td>
<td>存在RET未预测</td>
<td>预测块中存在RET指令，但是BPU预测信息未预测跳转，检查PredChecker是否能检测出RET预测错误。</td>
</tr>
<tr>
<td>2.2.2</td>
<td>BPU预测信息的RET预测错误检查</td>
<td>预测的跳转并非第一条</td>
<td>预测块中存在RET指令，但是BPU预测信息取的跳转指令在第一条RET指令之后，检查PredChecker是否能检测出RET预测错误。</td>
</tr>
<tr>
<td>3.1.1</td>
<td>BPU预测信息的JALR预测错误检查</td>
<td>误检测试1</td>
<td>预测块中没有JALR指令且BPU预测信息也没有取用任何跳转指令的输入，检查PredChecker是否会误报JALR预测错误。</td>
</tr>
<tr>
<td>3.1.2</td>
<td>BPU预测信息的JALR预测错误检查</td>
<td>误检测试2</td>
<td>预测块中有JALR指令且BPU预测信息取用的正是本条跳转指令的输入，检查PredChecker是否会误报JALR预测错误。</td>
</tr>
<tr>
<td>3.2.1</td>
<td>BPU预测信息的JALR预测错误检查</td>
<td>存在JALR未预测</td>
<td>预测块中存在JALR指令，但是BPU预测信息未预测跳转，检查PredChecker是否能检测出RET预测错误。</td>
</tr>
<tr>
<td>3.2.2</td>
<td>BPU预测信息的JALR预测错误检查</td>
<td>预测的跳转并非第一条</td>
<td>预测块中存在JALR指令，但是BPU预测信息取的跳转指令在第一条JALR指令之后，检查PredChecker是否能检测出JALR预测错误。</td>
</tr>
<tr>
<td>4.1</td>
<td>更新指令有效范围向量和预测跳转的指令</td>
<td>有效范围无误</td>
<td>不存在任何错误的情况下，PredChecker应当保留之前的预测结果。</td>
</tr>
<tr>
<td>4.2</td>
<td>更新指令有效范围向量和预测跳转的指令</td>
<td>RET和JAL预测错误引起的范围偏大</td>
<td>如果检测到了JAL或RET类的预测错误，PredChecker应该将有效指令的范围修正为预测块开始至第一条跳转指令。同时，应该将预测跳转的指令位置修正为预测块中的第一条跳转指令。</td>
</tr>
<tr>
<td>4.3</td>
<td>更新指令有效范围向量和预测跳转的指令</td>
<td>范围偏小不修正</td>
<td>如果出现了非控制流指令和无效指令的误预测，不应该将预测跳转的指令重新修正到预测块中第一条跳转指令，因为后续会直接冲刷并重新从重定向的位置取指令，如果这里修正的话，会导致下一预测块传入重复的指令。</td>
</tr>
<tr>
<td>5.1.1</td>
<td>非CFI预测错误检查</td>
<td>误检测试1</td>
<td>构造不存在CFI指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检非CFI预测错误</td>
</tr>
<tr>
<td>5.1.2</td>
<td>非CFI预测错误检查</td>
<td>误检测试2</td>
<td>构造存在CFI指令并且正确预测跳转的预测信息作为输入，测试PredChecker是否会错检非CFI预测错误</td>
</tr>
<tr>
<td>5.2</td>
<td>非CFI预测错误检查</td>
<td>正确检测测试</td>
<td>构造不存在CFI指令但是预测了跳转的预测信息作为输入，测试PredChecker是否能检查出非CFI预测错误</td>
</tr>
<tr>
<td>6.1.1</td>
<td>无效指令预测错误检查</td>
<td>误检测试1</td>
<td>构造不存在跳转指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检无效指令预测错误</td>
</tr>
<tr>
<td>6.1.2</td>
<td>无效指令预测错误检查</td>
<td>误检测试2</td>
<td>构造存在无效跳转指令并且未预测跳转的预测信息作为输入，测试PredChecker是否会错检无效指令预测错误</td>
</tr>
<tr>
<td>6.1.3</td>
<td>无效指令预测错误检查</td>
<td>误检测试3</td>
<td>构造存在有效跳转指令并且正确预测跳转的预测信息作为输入，测试PredChecker是否会错检无效指令预测错误</td>
</tr>
<tr>
<td>6.2</td>
<td>无效指令预测错误检查</td>
<td>正确检测测试</td>
<td>构造无效指令但是预测了跳转的预测信息作为输入，测试PredChecker是否能检查出无效指令预测错误</td>
</tr>
<tr>
<td>7.1.1</td>
<td>目标地址预测错误检查</td>
<td>误检测试1</td>
<td>构造不存在跳转指令并且未预测跳转的预测信息作输入，测试PredChecker是否会错检目标地址预测错误</td>
</tr>
<tr>
<td>7.1.2</td>
<td>目标地址预测错误检查</td>
<td>误检测试2</td>
<td>构造存在有效跳转指令并且正确预测跳转的预测信息作为输入，测试PredChecker是否会错检目标地址预测错误</td>
</tr>
<tr>
<td>7.2</td>
<td>目标地址预测错误检查</td>
<td>正确检测测试</td>
<td>构造存在有效跳转指令的预测块和预测跳转但跳转目标计算错误的预测信息作为输入，测试PredChecker能否检出目标地址预测错误</td>
</tr>
<tr>
<td>8.1</td>
<td>生成跳转和顺序目标</td>
<td>随机测试</td>
<td>随机提供译码信息，检测生成的跳转目标和顺序目标。</td>
</tr>
</tbody>
</table>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79296c4a2b615b1e55168353e62cb794">12.2.1.4 - PreDecode</h1>
    
	<div class="ifu-ctx">
<h1 id="子模块predecoder简介">子模块：PreDecoder简介</h1>
<p>预译码器PreDeocoder接受初始指令码并进行指令码拼接，拼接之后对每个指令码查询预译码表产生预译码信息，预译码信息包括该位置是否是有效指令开始、CFI指令类型、是否是RVC指令、是否是Call指令以及是否是Ret指令。预译码器会产生两种有效指令开始的向量，一种是默认第1个二字节必为有效指令开始，另一种是默认第2个二字节必为有效指令的开始，最终的选择在IFU端做。</p>
<p>所以，预译码器接收的输入是： 17 x 2B的初始指令码，这个2字节的初始指令码要么是一条RVC指令，要么是一条RVI指令的前半或后半部分。</p>
<p>预译码器的输出是：16x4B的拼接指令码；对每个4B指令码，该条指令是否为RVI或RVC指令（RVC指令只考虑该4B的低2B）；对每个4B指令码，该条指令的跳转偏移；两个16位的有效指令开始向量，其中第一种向量假定当前预测块的起始2字节为一条有效指令的开始，而第二种向量假定当前预测块的起始2字节为一条有效RVI指令的结束（但是由于第二种向量的前两位必然为0和1,所以编译优化后，第二种向量实际只有14个信号，表示2-15位；同理，第1种向量的第0位因为恒为1,所以也被优化）</p>
<h3 id="功能介绍">功能介绍</h3>
<h3 id="指令码生成">指令码生成</h3>
<p>预译码器接受来自IFU完成指令切分的17 × 2字节的初始指令码，并以4字节为窗口，2字节为步进长度，
从第1个2字节开始，直到第16个2字节，选出总共16个4字节的指令码。</p>
<h3 id="预译码信息生成">预译码信息生成</h3>
<p>预译码器根据指令码产生预译码信息，主要包括：是否是RVC指令、是否是CFI指令、
CFI指令类型（branch/jal/jalr/call/ret）、CFI指令的目标地址计算偏移。</p>
<p>首先是判断是否是RVC指令，RVC指令的具体格式参阅RISCV手册的描述：</p>
<p><img alt="RVC" src="RVCtable.png"></p>
<p>其中，决定指令是否为RVC的部分在于指令的[1, 0]两位，不为3的情况下都是RVC指令。</p>
<p>其余的指令性质判定功能（CFI类型、是否为call和ret）被时序优化到了F3PreDecoder中，不过也可以认为是PreDecoder的一部分，可以设置测试点进行测试</p>
<p>最后比较麻烦的是CFI指令的目标地址计算偏移，主要是对J和BR分支指令进行的计算，这需要综合RVI和RVC中jal和br指令的结构。
首先，是手册中对于C.J的描述</p>
<p><img alt="JOP" src="JOP.png"></p>
<p>这里对imm立即数的注解是，立即数的每一位最后对应到的是偏移的哪一位。</p>
<p>所以，可以认为立即数是这么重组的：</p>
<p>instr(12) + instr(8) + instr(10, 9) + instr(6) + instr(7) + instr(2) + instr(11) +instr(5,3) + &ldquo;0&rdquo;</p>
<p>而RVI中，对于JAL指令，是这么定义的：</p>
<p><img alt="RVIJ" src="RVIJ.png"></p>
<p>我们可以类似地计算立即数。</p>
<p>同样的，我们可以查询手册，参考BR类指令的立即数计算RVC和RVI指令对应的偏移。</p>
<p><img alt="RVIBR" src="RVIBR.png"></p>
<p><img alt="RVCBR" src="RVCBR.png"></p>
<h2 id="predecode接口说明">PreDecode接口说明</h2>
<h3 id="输入接口">输入接口</h3>
<p>in_bits_data 17 x 2B的初始指令码，其中，每2个字节既可以代表一条RVC指令，也可以代表一个RVI指令的一半。</p>
<h3 id="输出接口">输出接口</h3>
<p>instr：拼接后的 16 x 4B的初始指令码</p>
<p>jumpOffset：如果这条指令是跳转指令，则jumpOffset表示其跳转偏移</p>
<p>pd：每条指令预译码信息，包括valid、isRVC、brType、isRet、isCall。其中第0条指令的valid已经被优化了</p>
<p>hasHalfValid：这个信号需要和pd的valid结合起来看，PreDecode的一个功能是求出指令开始向量，也就是对每个4B的拼接指令，判断其低2B是否为一条有效指令的开始（即一条RVI指令的前半部分，或者一条RVC指令），但是需要分类讨论该预测块的第一个2B是否为一条有效指令的开始。hasHalfValid表示的是当前预测块的第一个2B指令为一条RVI指令的后半部分时，给出的指令开始向量。类似地，pd中的valid指的是当前预测块的第一个2B指令为一条指令的开始时，给出的指令开始向量。</p>
<h2 id="predecoder测试点和功能点">PreDecoder测试点和功能点</h2>
<h3 id="功能点1-生成指令码">功能点1 生成指令码</h3>
<p>子模块：PreDecoder简介</p>
<p>预译码器PreDeocoder接受初始指令码并进行指令码拼接，拼接之后对每个指令码查询预译码表产生预译码信息，预译码信息包括该位置是否是有效指令开始、CFI指令类型、是否是RVC指令、是否是Call指令以及是否是Ret指令。预译码器会产生两种有效指令开始的向量，一种是默认第1个二字节必为有效指令开始，另一种是默认第2个二字节必为有效指令的开始，最终的选择在IFU端做。</p>
<p>所以，预译码器接收的输入是： 17 x 2B的初始指令码，这个2字节的初始指令码要么是一条RVC指令，要么是一条RVI指令的前半或后半部分。</p>
<p>预译码器的输出是：16x4B的拼接指令码；对每个4B指令码，该条指令是否为RVI或RVC指令（RVC指令只考虑该4B的低2B）；对每个4B指令码，该条指令的跳转偏移；两个16位的有效指令开始向量，其中第一种向量假定当前预测块的起始2字节为一条有效指令的开始，而第二种向量假定当前预测块的起始2字节为一条有效RVI指令的结束（但是由于第二种向量的前两位必然为0和1,所以编译优化后，第二种向量实际只有14个信号，表示2-15位；同理，第1种向量的第0位因为恒为1,所以也被优化）
功能介绍
指令码生成</p>
<p>预译码器接受来自IFU完成指令切分的17 × 2字节的初始指令码，并以4字节为窗口，2字节为步进长度， 从第1个2字节开始，直到第16个2字节，选出总共16个4字节的指令码。
预译码信息生成</p>
<p>预译码器根据指令码产生预译码信息，主要包括：是否是RVC指令、是否是CFI指令、 CFI指令类型（branch/jal/jalr/call/ret）、CFI指令的目标地址计算偏移。</p>
<p>预译码器从IFU接收完成指令切分的17 x 2 字节的初始指令码，以4字节为窗口，2字节为步进长度，选出16 x 4字节的指令码</p>
<p>我们需要随机生成初始指令码，并测试拼接的结果。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>拼接测试</td>
<td>随机生成17 x 2字节的初始指令码，检验PreDecoder拼接结果</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-生成预译码信息">功能点2 生成预译码信息</h3>
<p>预译码器会根据指令码产生预译码信息，包括RVC指令的判定和CFI指令的目标地址计算偏移。</p>
<p>CFI类型的判定则时序优化到了F3PreDecoder中。
可以设计测试点测试PreDecode对F3PreDecoder的使用。</p>
<p>据此，我们可以设计下述测试点。</p>
<p>首先是判定RVC指令，我们随机生成输入初始指令码，对返回的16位RVC判定结果进行检验。
具体来说，对每32位指令，考虑RVC和RVI两种情况。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1.1</td>
<td>RVC判定</td>
<td>传入RVC指令，应该判断为RVC</td>
</tr>
<tr>
<td>2.1.2</td>
<td>RVI判定</td>
<td>传入RVI指令，不应判断为RVC</td>
</tr>
</tbody>
</table>
<p>然后，需要分别根据手册构造RVC和RVI扩展下的J指令和BR指令们，所以有如下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.2.1</td>
<td>RVC.J计算</td>
<td>对传入RVC扩展的J指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.2.2</td>
<td>RVI.J计算</td>
<td>对传入RVI扩展的J指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.2.3</td>
<td>RVC.BR计算</td>
<td>对传入RVC扩展的BR指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.2.4</td>
<td>RVI.BR计算</td>
<td>对传入RVI扩展的BR指令，检查计算的偏移</td>
</tr>
</tbody>
</table>
<p>参照F3PreDecoder的测试点，设计如下测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.3.1</td>
<td>非CFI判定</td>
<td>对传入的非CFI指令（包括RVC.EBREAK），应该判定为类型0</td>
</tr>
<tr>
<td>2.3.2</td>
<td>BR判定</td>
<td>对传入的BR指令，应该判定为类型1</td>
</tr>
<tr>
<td>2.3.3</td>
<td>JAL判定</td>
<td>对传入的JAL指令，应该判定为类型2</td>
</tr>
<tr>
<td>2.3.4</td>
<td>JALR判定</td>
<td>对传入的JALR指令，应该判定为类型3</td>
</tr>
<tr>
<td>2.4.1</td>
<td>非CFI和BR不判定</td>
<td>对传入的非CFI和BR指令，都不应判定为call或者ret</td>
</tr>
<tr>
<td>2.4.2.1.1</td>
<td>RVI.JAL判定call</td>
<td>对传入的RVI.JAL指令，当rd设置为1或5，应当判定该指令为call</td>
</tr>
<tr>
<td>2.4.2.1.2</td>
<td>RVI.JAL例外</td>
<td>对传入的RVI.JAL指令，当rd设置为1和5之外的值，不应当判定该指令为call或ret</td>
</tr>
<tr>
<td>2.4.2.2</td>
<td>RVC.JAL不判定</td>
<td>对传入的RVC.JAL指令，无论什么情况都不能判定为call或ret</td>
</tr>
<tr>
<td>2.4.3.1.1</td>
<td>RVI.JALR和rd为link</td>
<td>传入RVI.JALR指令，并且rd为1或5，无论其他取值，都应判定为call</td>
</tr>
<tr>
<td>2.4.3.1.2</td>
<td>RVI.JALR且仅rs为link</td>
<td>传入RVI.JALR指令，rd不为1和5，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.4.3.1.3</td>
<td>RVI.JALR无link</td>
<td>对传入的JALR指令，若rd和rs均不为link，则不应判定为ret和cal</td>
</tr>
<tr>
<td>2.4.3.2.1</td>
<td>RVC.JALR为Ret</td>
<td>传入RVC.JALR指令，必定为call</td>
</tr>
<tr>
<td>2.4.3.2.2.1</td>
<td>RVC.JR且rs为link</td>
<td>传入RVC.JR指令，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.4.3.2.2.2</td>
<td>RVC.JR且rs不为link</td>
<td>传入RVC.JR指令，rs不为1或5，不应判定为ret</td>
</tr>
</tbody>
</table>
<h3 id="功能点3-生成指令开始向量">功能点3 生成指令开始向量</h3>
<p>最后，预译码还需要生成两种指令开始向量：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.3.1</td>
<td>有效指令开始向量计算1</td>
<td>对预测块，假定第一条指令为一条有效指令的开始，对每条指令计算其是否为有效指令开始</td>
</tr>
<tr>
<td>2.3.2</td>
<td>有效指令开始向量计算2</td>
<td>对预测块，假定第一条指令为一条有效指令的结束，对每条指令计算其是否为有效指令开始</td>
</tr>
</tbody>
</table>
<h2 id="测试点汇总a-idpred_decoder_functions-a"><strong>测试点汇总</strong><a id="pred_decoder_functions"> </a></h2>
<p>综上所述，对PredDecoder，所有的测试点为：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>拼接指令码</td>
<td>拼接测试</td>
<td>随机生成17 x 2字节的初始指令码，检验PreDecoder拼接结果</td>
</tr>
<tr>
<td>2.1.1</td>
<td>RVC判定</td>
<td>RVC判定</td>
<td>传入RVC指令，应该判断为RVC</td>
</tr>
<tr>
<td>2.1.2</td>
<td>RVC判定</td>
<td>RVI判定</td>
<td>传入RVI指令，不应判断为RVC</td>
</tr>
<tr>
<td>2.2.1</td>
<td>跳转目标计算</td>
<td>RVC.J计算</td>
<td>对传入RVC扩展的J指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.2.2</td>
<td>跳转目标计算</td>
<td>RVI.J计算</td>
<td>对传入RVI扩展的J指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.2.3</td>
<td>跳转目标计算</td>
<td>RVC.BR计算</td>
<td>对传入RVC扩展的BR指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.2.4</td>
<td>跳转目标计算</td>
<td>RVI.BR计算</td>
<td>对传入RVI扩展的BR指令，检查计算的偏移</td>
</tr>
<tr>
<td>2.3.1</td>
<td>CFI指令类型判定</td>
<td>非CFI判定</td>
<td>对传入的非CFI指令（包括RVC.EBREAK），应该判定为类型0</td>
</tr>
<tr>
<td>2.3.2</td>
<td>CFI指令类型判定</td>
<td>BR判定</td>
<td>对传入的BR指令，应该判定为类型1</td>
</tr>
<tr>
<td>2.3.3</td>
<td>CFI指令类型判定</td>
<td>JAL判定</td>
<td>对传入的JAL指令，应该判定为类型2</td>
</tr>
<tr>
<td>2.3.4</td>
<td>CFI指令类型判定</td>
<td>JALR判定</td>
<td>对传入的JALR指令，应该判定为类型3</td>
</tr>
<tr>
<td>2.4.1</td>
<td>ret、call判定</td>
<td>非CFI和BR不判定</td>
<td>对传入的非CFI和BR指令，都不应判定为call或者ret</td>
</tr>
<tr>
<td>2.4.2.1.1</td>
<td>ret、call判定</td>
<td>RVI.JAL判定call</td>
<td>对传入的RVI.JAL指令，当rd设置为1或5，应当判定该指令为call</td>
</tr>
<tr>
<td>2.4.2.1.2</td>
<td>ret、call判定</td>
<td>RVI.JAL例外</td>
<td>对传入的RVI.JAL指令，当rd设置为1和5之外的值，不应当判定该指令为call或ret</td>
</tr>
<tr>
<td>2.4.2.2</td>
<td>ret、call判定</td>
<td>RVC.JAL不判定</td>
<td>对传入的RVC.JAL指令，无论什么情况都不能判定为call或ret</td>
</tr>
<tr>
<td>2.4.3.1.1</td>
<td>ret、call判定</td>
<td>RVI.JALR和rd为link</td>
<td>传入RVI.JALR指令，并且rd为1或5，无论其他取值，都应判定为call</td>
</tr>
<tr>
<td>2.4.3.1.2</td>
<td>ret、call判定</td>
<td>RVI.JALR且仅rs为link</td>
<td>传入RVI.JALR指令，rd不为1和5，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.4.3.1.3</td>
<td>ret、call判定</td>
<td>RVI.JALR无link</td>
<td>对传入的JALR指令，若rd和rs均不为link，则不应判定为ret和cal</td>
</tr>
<tr>
<td>2.4.3.2.1</td>
<td>ret、call判定</td>
<td>RVC.JALR为Ret</td>
<td>传入RVC.JALR指令，必定为call</td>
</tr>
<tr>
<td>2.4.3.2.2.1</td>
<td>ret、call判定</td>
<td>RVC.JR且rs为link</td>
<td>传入RVC.JR指令，rs为1或5，应判定为ret</td>
</tr>
<tr>
<td>2.4.3.2.2.2</td>
<td>ret、call判定</td>
<td>RVC.JR且rs不为link</td>
<td>传入RVC.JR指令，rs不为1或5，不应判定为ret</td>
</tr>
<tr>
<td>2.3.1</td>
<td>计算有效指令开始向量</td>
<td>有效指令开始向量计算1</td>
<td>对预测块，假定第一条指令为一条有效指令的开始，对每条指令计算其是否为有效指令开始</td>
</tr>
<tr>
<td>2.3.2</td>
<td>计算有效指令开始向量</td>
<td>有效指令开始向量计算2</td>
<td>对预测块，假定第一条指令为一条有效指令的结束，对每条指令计算其是否为有效指令开始</td>
</tr>
</tbody>
</table>
</div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f3f3627a040d55087b6c36b4ee0f1f10">12.2.1.5 - RVCExpander</h1>
    
	<div class="ifu-ctx">
<h1 id="子模块rvcexpander简介">子模块：RVCExpander简介</h1>
<p>RVCExpander是IFU的子模块，负责对传入的指令进行指令扩展，并解码计算非法信息。</p>
<p>该模块接收的输入量是两个：一条RVC指令或者RVI指令；CSR对fs.status的使能情况。</p>
<p>输出量也是两个：输入指令对应的RVI指令；RVC指令是否非法。</p>
<h2 id="指令扩展">指令扩展</h2>
<p>如果是RVI指令，则无需扩展。</p>
<p>否则对RVC指令，按照手册的约定进行扩展。</p>
<h2 id="非法指令判断">非法指令判断</h2>
<p>RVI指令永远判断为合法。</p>
<p>对于RVC指令的判定，详细内容参阅20240411的RISCV手册的26.8节表格列出的指令条件。</p>
<h2 id="rvcexpander接口说明">RVCExpander接口说明</h2>
<h3 id="输入接口">输入接口</h3>
<p>fsIsOff：表示CSR是否使能<code>fs.status</code></p>
<p>in：传入一个32位数据，其可以是一个完整的RVI指令，也可以是低16位RVC指令+高16位为RVI指令的一半（当然低16位也有可能是RVI指令的后半部分，但是RVCExpander不会区分，可以认为RVCExpander假定传入的32位数据的低16位一定为一条指令的开始）</p>
<h3 id="输出接口">输出接口</h3>
<p>ill：表示这条指令是否为非法指令</p>
<p>out_bits：对RVI指令，直接返回，对RVC指令，返回扩展后的32位指令。</p>
<h2 id="功能点和测试点">功能点和测试点</h2>
<h3 id="功能点1-指令扩展">功能点1 指令扩展</h3>
<p>RVCExpander负责接收预译码器拼接的指令码，并进行指令扩展，如果是16位RVC指令，需要按照RISCV手册的约定完成扩展</p>
<p>对此，我们需要随机生成RVI指令和RVC指令，送入预译码器：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>RVI指令保留</td>
<td>构造RVI指令传入，检查保留情况</td>
</tr>
<tr>
<td>1.2</td>
<td>RVC指令扩展</td>
<td>构造RVC指令传入，按手册检查扩展结果</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-非法指令判断">功能点2 非法指令判断</h3>
<p>RVCExpander在解析指令时，如发现指令违反了手册的约定，则需要判定该指令非法</p>
<p>对此，我们需要随机生成非法指令送入RVI中，并检测RVCExpander对合法位的校验；同时，我们还需要校验合法指令是否会被误判为非法指令：</p>
<p>此外，需要判定C.fp指令在CSR未使能fs.status的情况下，能否将这类指令判定为非法。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>常规非法指令测试</td>
<td>随机构造非法RVC指令传入，检查判断结果</td>
</tr>
<tr>
<td>2.2</td>
<td>合法指令测试</td>
<td>随机构造合法RVC指令传入，检查判断结果</td>
</tr>
<tr>
<td>2.3</td>
<td>C.fp指令测试</td>
<td>CSR未使能fs.status的情况下，C.fp指令应该为非法</td>
</tr>
</tbody>
</table>
<h2 id="测试点汇总-a-idrvc_expander_functions-a">测试点汇总 <a id="rvc_expander_functions"> </a></h2>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>指令扩展</td>
<td>RVI指令保留</td>
<td>构造RVI指令传入，检查保留情况</td>
</tr>
<tr>
<td>1.2</td>
<td>指令扩展</td>
<td>RVC指令扩展</td>
<td>构造RVC指令传入，按手册检查扩展结果</td>
</tr>
<tr>
<td>2.1</td>
<td>非法指令判断</td>
<td>非法指令测试</td>
<td>随机构造非法RVC指令传入，检查判断结果</td>
</tr>
<tr>
<td>2.2</td>
<td>非法指令判断</td>
<td>合法指令测试</td>
<td>随机构造合法RVC指令传入，检查判断结果</td>
</tr>
<tr>
<td>2.3</td>
<td>C.fp指令测试</td>
<td>CSR未使能fs.status的情况下，C.fp指令应该为非法</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="rvc扩展辅助阅读材料">RVC扩展辅助阅读材料</h2>
<p>为方便参考模型的书写，在这里根据20240411版本的手册内容整理了部分指令扩展的思路。</p>
<p>对于RVC指令来说，op = instr(1, 0)；funct = instr(15, 13)</p>
<table>
<thead>
<tr>
<th>op\funct</th>
<th>000</th>
<th>001</th>
<th>010</th>
<th>011</th>
<th>100</th>
<th>101</th>
<th>110</th>
<th>111</th>
</tr>
</thead>
<tbody>
<tr>
<td>00</td>
<td>addi4spn</td>
<td>fld</td>
<td>lw</td>
<td>ld</td>
<td>lbu<br>lhu;lh<br>sb;sh</td>
<td>fsd</td>
<td>sw</td>
<td>sd</td>
</tr>
<tr>
<td>01</td>
<td>addi</td>
<td>addiw</td>
<td>li</td>
<td>lui<br>addi16sp<br>zcmop</td>
<td>ARITHs<br>zcb</td>
<td>j</td>
<td>beqz</td>
<td>bnez</td>
</tr>
<tr>
<td>10</td>
<td>slli</td>
<td>fldsp</td>
<td>lwsp</td>
<td>ldsp</td>
<td>jr;mv<br>ebreak<br>jalr;add</td>
<td>fsdsp</td>
<td>fwsp</td>
<td>sdsp</td>
</tr>
</tbody>
</table>
<p>在开始阅读各指令的扩展规则时，需要了解一些RVC扩展的前置知识，比如：</p>
<p>rd&rsquo;, rs1&rsquo;和rs2&rsquo;寄存器：受限于16位指令的位宽限制，这几个寄存器只有3位来表示，他们对应到x8~x15寄存器。</p>
<h3 id="op--b00">op = b'00'</h3>
<h4 id="funct--b000-addi4spn">funct = b'000&rsquo;: ADDI4SPN</h4>
<image src="Caddi4spn.png" alter="addi4spn" width=600px />
<p>该指令将一个0扩展的非0立即数加到栈指针寄存器x2上，并将结果写入rd'</p>
<p>其中，nzuimm[5:4|9:6|2|3]的含义是：</p>
<p>这条指令的第12至11位是立即数的5至4位，第10至7位是立即数的9至6位，第6位是立即数的第2位，第7位是立即数的第3位。</p>
<p>这条指令最终扩展成为<strong>addi rd&rsquo;, x2, nzuimm[9:2]</strong></p>
<p>addi的格式形如：| imm[11:0] | rs1 | 000 | rd | 0010011 |</p>
<p>注意，该指令的立即数为0的时候，不合法。</p>
<h4 id="funct--b001-fld">funct = b'001&rsquo;: fld</h4>
<image src="Cfld.png" alter="fld" width=600px />
<p>该指令从内存加载一个双精度浮点数到rd&rsquo;寄存器。</p>
<p>offset的低三位是0，高位进行了0扩展。</p>
<p>这条指令最终扩展成为<strong>fld rd′,offset(rs1′)</strong></p>
<p>fld的格式形如： | imm[11:0] | rs1 | 011 | rd | 0000111 |</p>
<p>注意：在昆明湖环境下，该指令要求CSR使能fs.status，也即入参fsIsOff为假。</p>
<h4 id="funct--b010-lw">funct = b'010&rsquo;: lw</h4>
<image src="Cfld.png" alter="lw" width=600px />
<p>该指令从内存加载一个32位的值到rd&rsquo;寄存器。</p>
<p>offset的低两位是0，高位进行了0扩展。</p>
<p>这条指令最终扩展成为<strong>lw rd′,offset(rs1′)</strong></p>
<p>lw的格式形如： | imm[11:0] | rs1 | 010 | rd | 0000011 |</p>
<h4 id="funct--b011-ldsp">funct = b'011&rsquo;: ldsp</h4>
<image src="Cfld.png" alter="ld" width=600px />
<p>该指令从内存加载一个64位的值到rd&rsquo;寄存器。</p>
<p>offset的低两位是0，高位进行了0扩展。</p>
<p>这条指令最终扩展成为<strong>ld rd′,offset(rs1′)</strong></p>
<p>ld的格式形如： | imm[11:0] | rs1 | 011 | rd | 0000011 |</p>
<h4 id="funct--b100-zcb-extensions-1">funct = b'100&rsquo;: zcb extensions 1</h4>
<p>在RVC指令中，这部分对应的是zcb扩展中的5条指令：lbu,lhu,lh,sb,sh</p>
<p>在zcb扩展中，进一步地取instr[12:10]作为zcb扩展的指令码，我们记作funct_zcb</p>
<h5 id="funct_zcb--b000-lbu">funct_zcb = b'000&rsquo;: lbu</h5>
<p>| 100 | 000 | rs1&rsquo; | uimm[0|1] | rd&rsquo; | 00 |</p>
<p>这个指令从rs1&rsquo;+uimm的地址读取一字节，用0扩展并并加载到rd&rsquo;中。</p>
<p>最终翻译为 lb rd&rsquo;, uimm(rs1')</p>
<p>lb指令的格式形如：| imm[11:0] | rs1 | 000 | rd | 0000011 |</p>
<h5 id="funct_zcb--b001-instr6-0--lhu">funct_zcb = b'001&rsquo;, instr[6] =0 : lhu</h5>
<p>| 100 | 001 | rs1&rsquo; | 0 | uimm[1] | rd&rsquo; | 00 |</p>
<p>这个指令从地址rs1&rsquo; + uimm读取半word，用0扩展加载到rd&rsquo;中。</p>
<p>最终翻译为 lhu rd&rsquo;, uimm(rs1')</p>
<p>lhu指令的格式形如：| imm[11:0] | rs1 | 101 | rd | 0000011 |</p>
<h5 id="funct_zcb--b001-instr6-1--lh">funct_zcb = b'001&rsquo;, instr[6] =1 : lh</h5>
<p>| 100 | 001 | rs1&rsquo; | 1 | uimm[1] | rd&rsquo; | 00 |</p>
<p>这个指令从地址rs1&rsquo; + uimm读取半word，符号扩展并加载到rd&rsquo;中。</p>
<p>最终翻译为 lh rd&rsquo;, uimm(rs1')</p>
<p>lh指令的格式形如：| imm[11:0] | rs1 | 001 | rd | 0000011 |</p>
<h5 id="funct_zcb--b010-sb">funct_zcb = b'010&rsquo;： sb</h5>
<p>| 100 | 010 | rs1&rsquo; | uimm[0 | 1] | rd&rsquo; | 00 |</p>
<p>这个指令把rs2&rsquo;的低字节存储到地址rs1&rsquo; + uimm指示的内存地址中。</p>
<p>最终翻译为 sb rs2, uimm(rs1')</p>
<p>RVI中sb指令的格式形如：|imm[11:5] | rs2 | rs1 | 000 | imm[4:0] | 0100011 |</p>
<h5 id="funct_zcb--b011-sh">funct_zcb = b'011&rsquo;: sh</h5>
<p>| 100 | 011 | rs1&rsquo; | 0 | uimm[1] | rd&rsquo; | 00 |</p>
<p>这个指令把rs2&rsquo;的低半字存储到地址rs1&rsquo; + uimmz指示的内存地址中。</p>
<p>最终翻译为 sh rd&rsquo;, uimm(rs1')</p>
<p>sh指令的格式形如：|imm[11:5] | rs2 | rs1 | 001 | imm[4:0] | 0100011 |</p>
<h4 id="funct--b101-fsd">funct = b'101&rsquo;: fsd</h4>
<image src="Cfsd.png" alter="fsd" width=600px />
<p>fsd将rs2&rsquo;中的双精度浮点数存储到rs1&rsquo; + imm指示的内存区域</p>
<p>该指令的立即数低3位为0，同时进行了0符号扩展。</p>
<p>最终这个指令将被扩展为<strong>fsd rs2′, offset(rs1′)</strong></p>
<p>RVI的FSD格式形如：| imm[11:5]| rs2 | rs1 | 011 | imm[4:0] | 0100011 |</p>
<p>注意：在昆明湖环境下，该指令要求CSR使能fs.status，也即入参fsIsOff为假。</p>
<h4 id="funct--b110-sw">funct = b'110&rsquo;: sw</h4>
<image src="Cfsd.png" alter="sw" width=600px />
<p>sw将rs2&rsquo;中的一个字存储到rs1&rsquo; + imm指示的内存区域</p>
<p>该指令的立即数低2位为0，同时进行了0符号扩展。</p>
<p>最终这个指令将被扩展为<strong>sw rs2′, offset(rs1′)</strong></p>
<p>RVI的SW格式形如：| imm[11:5]| rs2 | rs1 | 010 | imm[4:0] | 0100011 |</p>
<h4 id="funct--b111-sd">funct = b'111&rsquo;: sd</h4>
<image src="Cfsd.png" alter="sd" width=600px />
<p>fsd将rs2&rsquo;中的双字存储到rs1&rsquo; + imm指示的内存区域</p>
<p>该指令的立即数低3位为0，同时进行了0符号扩展。</p>
<p>最终这个指令将被扩展为<strong>sd rs2′, offset(rs1′)</strong></p>
<p>RVI的SD格式形如：| imm[11:5]| rs2 | rs1 | 011 | imm[4:0] | 0100111 |</p>
<h3 id="op--b01">op = b'01'</h3>
<h4 id="funct--b000-addi">funct = b'000&rsquo;: addi</h4>
<image src="Caddi.png" alter="addi" width=600px />
<p>该指令将一个符号扩展的非0立即数加到rd存储的数字上，并将结果写入rd。</p>
<p>尽管手册规定立即数和rd不为0，但是立即数和rd为0的情况仍可视为合法。前者是HINT指令，而后者是NOP。</p>
<p>这条指令最终扩展成为<strong>addi rd, rd, imm</strong></p>
<p>addi的格式形如：| imm[11:0] | rs1 | 000 | rd | 0010011 |</p>
<h4 id="funct--b001-addiw">funct = b'001&rsquo;: addiw</h4>
<image src="Caddi.png" alter="addiw" width=600px />
<p>该指令的功能和addi类似，但是先计算得到32位数，然后再符号扩展至64位。</p>
<p>该指令的rd为0时非法。</p>
<p>当立即数不为0时，该指令最终扩展成为<strong>addiw, rd, rd, imm</strong></p>
<p>addiw的指令格式为| imm[11:0] | rs1 | 000 | rd | 0011011 |</p>
<p>如果立即数为0,该指令将会扩展成为sext.w rd，不过和addiw的格式是一样的，因此可以将他们归为一类。</p>
<h4 id="funct--b010-li">funct = b'010&rsquo;: li</h4>
<image src="Cli.png" alter="li" width=600px />
<p>该指令将符号扩展的立即数加载到rd中。</p>
<p>当立即数为0时，该指令为hint，可以看作合法。</p>
<p>这条指令最终扩展成为<strong>addi rd, x0, imm</strong></p>
<p>addi的格式形如：| imm[11:0] | rs1 | 000 | rd | 0010011 |</p>
<h4 id="funct--b011-luiaddi16spzcm">funct = b'011&rsquo;: lui/addi16sp/zcm</h4>
<image src="Cli.png" alter="lui" width=600px />
<p>当rd不为0且不为2时，为lui指令，可以扩展为<strong>lui rd, imm</strong></p>
<p>lui指令的格式形如： | imm[31:12] | rd | 0110111 |</p>
<p>当rd为0时，为hint，也可当作cli进行译码。</p>
<p>当rd为2时，为addi16sp指令：</p>
<image src="Caddi.png" alter="addi16sp" width=600px />
<p>扩展为<strong>addi x2, x2, nzimm[9:4]</strong></p>
<p>addi的格式形如：| imm[11:0] | rs1 | 000 | rd | 0010011 |</p>
<p>对addi16sp，立即数为0时非法。</p>
<p>此外，当第12至11位皆为0，第7位是1且第6至2位为0时，为zcmop，可以直接翻译为一个不起效的指令，比如与立即数0。</p>
<h4 id="funct--b100-arith--zcb-extension2">funct = b'100&rsquo;: arith &amp; zcb extension2</h4>
<p>在RVC指令中，这部分对应的是数学运算指令和zcb扩展中的另一部分指令，数学计算指令的对应如下：</p>
<image src="op01funct100.png" alter="arith" width=600px />
<p>其中SRLI64和SRAI64在昆明湖环境下可以不考虑。</p>
<h5 id="srli">srli</h5>
<image src="Csrli.png" alter="srli" width=600px />
<p>当funct2为00时，为srli。</p>
<p>最终可翻译为<strong>srli rd′, rd′, 64</strong></p>
<p>srli的格式形如：|0000000|shamt|rs1|101|rd|0010011|</p>
<h5 id="srai">srai</h5>
<image src="Csrli.png" alter="srai" width=600px />
<p>当funct2为01时，为srai。</p>
<p>最终可翻译为<strong>srai rd′, rd′, 64</strong></p>
<p>SRAI的格式形如：|0100000|shamt|rs1|101|rd|0010011|</p>
<h5 id="andi">andi</h5>
<image src="Candi.png" alter="andi" width=600px />
<p>该指令最终扩展为<strong>andi rd′, rd′, imm</strong></p>
<p>andi的格式形如|imm[11:0]|rs1|111|rd|0010011|</p>
<h5 id="sub">sub</h5>
<image src="Csub.png" alter="sub" width=600px />
<p>这条指令最终可以扩展为：<strong>sub rd′, rd′, rs2′</strong></p>
<p>sub指令的格式形如：|0100000|rs2|rs1|000|rd|0110011|</p>
<h5 id="xor">xor</h5>
<image src="Csub.png" alter="xor" width=600px />
<p>这条指令最终可以扩展为：<strong>xor rd′, rd′, rs2′</strong></p>
<p>xor指令的格式形如：|0000000|rs2|rs1|100|rd|0110011|</p>
<h5 id="or">or</h5>
<image src="Csub.png" alter="or" width=600px />
<p>这条指令最终可以扩展为：<strong>or rd′, rd′, rs2′</strong></p>
<p>or指令的格式形如：|0000000|rs2|rs1|110|rd|0110011|</p>
<h5 id="and">and</h5>
<image src="Csub.png" alter="and" width=600px />
<p>这条指令最终可以扩展为：<strong>and rd′, rd′, rs2′</strong></p>
<p>and指令的格式形如：|0000000|rs2|rs1|111|rd|0110011|</p>
<h5 id="subw">subw</h5>
<image src="Csub.png" alter="subw" width=600px />
<p>这条指令最终可以扩展为：<strong>subw rd′, rd′, rs2′</strong></p>
<p>subw指令的格式形如：|0100000|rs2|rs1|000|rd|0111011|</p>
<h5 id="addw">addw</h5>
<image src="Csub.png" alter="addw" width=600px />
<p>这条指令最终可以扩展为：<strong>addw rd′, rd′, rs2′</strong></p>
<p>addw指令的格式形如：|0000000|rs2|rs1|000|rd|0111011|</p>
<h5 id="mul">mul</h5>
<p>从mul开始的一部分指令属于zcb扩展。</p>
<p>zcb扩展中，当instr(12, 10) == &ldquo;111&rdquo;，且instr(6, 5)为&quot;10&quot;时，为mul指令。</p>
<p>zcb扩展中，当instr(12, 10) == &ldquo;111&rdquo;，且instr(6, 5)为&quot;11&quot;时，根据instr(4,2)，
共有000的zext.b，001的sext.b，010的zext.h，011的sext.h，100的zext.w和101的not。</p>
<image src="mul.png" alter="mul" width=600px />
<p>该指令可扩展为mul rd, rd, rs2</p>
<p>mul的格式为：|0000001|rs2|rs1|000|rd|0110011|</p>
<h5 id="zextb">zext.b</h5>
<image src="zextb.png" alter="mul" width=600px />
<p>这条指令可以翻译为：<strong>andi rd&rsquo;/rs1&rsquo;, rd&rsquo;/rs1&rsquo;, 0xff</strong></p>
<p>andi的格式形如|imm[11:0]|rs1|111|rd|0010011|</p>
<h5 id="sextb">sext.b</h5>
<image src="Csextb.png" alter="Csextb" width=600px />
<p>该指令翻译为<strong>sext.b rd, rd</strong></p>
<p>sext.b指令在RVI下形如:</p>
<image src="Isextb.png" alter="Isextb" width=600px />
<h5 id="zexth">zext.h</h5>
<image src="Czexth.png" alter="Czexth" width=600px />
<p>该指令翻译为<strong>zext.h rd, rd</strong></p>
<p>zext.h指令在RVI下形如:</p>
<image src="Izexth.png" alter="Izexth" width=600px />
<h5 id="sexth">sext.h</h5>
<image src="Csexth.png" alter="Csexth" width=600px />
<p>该指令翻译为<strong>sext.h rd, rd</strong></p>
<p>sext.h指令在RVI下形如:</p>
<image src="Isexth.png" alter="Isexth" width=600px />
<h5 id="zextw">zext.w</h5>
<image src="zextw.png" alter="zextw" width=600px />
<p>该指令等价为<strong>add.uw rd&rsquo;/rs1&rsquo;, rd&rsquo;/rs1&rsquo;, zero</strong></p>
<p>add.uw指令在RVI下形如:</p>
<image src="adduw.png" alter="adduw" width=600px />
<h5 id="not">not</h5>
<image src="not.png" alter="not" width=600px />
<p>该指令等价为<strong>xori rd&rsquo;/rs1&rsquo;, rd&rsquo;/rs1&rsquo;, -1</strong></p>
<p>xori指令在RVI下形如： | imm[11:0] | rs1| 100 | rd | 0010011 |</p>
<h4 id="funct--b101-j">funct = b'101&rsquo;: j</h4>
<image src="Cj.png" alter="j" width=600px />
<p>最终这个指令将被扩展为<strong>jal x0, offset</strong></p>
<p>jal的格式形如：| imm[20|10:1|11|19:12] | rd | 1101111 |</p>
<h4 id="funct--b110-beqz">funct = b'110&rsquo;: beqz</h4>
<image src="Cbnez.png" alter="beqz" width=600px />
<p>该指令可以扩展到<strong>beq rs1‘, x0, offset</strong></p>
<p>beq指令形如： |imm[12|10:5]|rs2|rs1|000|imm[4:1|11]|1100011|
imm[12|10:5]rs2rs1001imm[4:1|11]1100011BNE</p>
<h4 id="funct--b111-bnez">funct = b'111&rsquo;: bnez</h4>
<image src="Cbnez.png" alter="bnez" width=600px />
<p>最终这个指令将被扩展为<strong>bne rs1′, x0, offset</strong></p>
<p>bne指令形如：|imm[12|10:5]| rs2 | rs1 | 001 | imm[4:1|11] | 1100011|</p>
<h3 id="op--b10">op = b'10'</h3>
<h4 id="funct--b000-slli">funct = b'000&rsquo;: slli</h4>
<image src="Cslli.png" alter="slli" width=600px />
<p>该指令将一个符号扩展的非0立即数加到rd存储的数字上，并将结果写入rd。</p>
<p>尽管手册规定立即数和rd不为0，但是立即数和rd为0的情况仍可视为合法。前者是HINT指令，而后者是NOP。</p>
<p>这条指令最终扩展成为<strong>slli rd, rd, shamt[5:0]</strong></p>
<p>slli的格式形如：|000000|shamt|rs1|001|rd|0010011|</p>
<h4 id="funct--b001-fldsp">funct = b'001&rsquo;: fldsp</h4>
<image src="Cfldsp.png" alter="fldsp" width=600px />
<p>该指令最终扩展成为<strong>fld rd, offset(x2)</strong></p>
<p>fld的格式形如： | imm[11:0] | rs1 | 011 | rd | 0000111 |</p>
<p>该指令要求CSR使能fs.status</p>
<h4 id="funct--b010-lwsp">funct = b'010&rsquo;: lwsp</h4>
<image src="Cfldsp.png" alter="lwsp" width=600px />
<p>rd为0时非法。</p>
<p>这条指令最终扩展成为<strong>lw rd, offset(x2)</strong></p>
<p>lw的格式形如： | imm[11:0] | rs1 | 010 | rd | 0000011 |</p>
<h4 id="funct--b011-ldsp-1">funct = b'011&rsquo;: ldsp</h4>
<image src="Cfldsp.png" alter="ldsp" width=600px />
<p>rd为0时非法。</p>
<p>这条指令最终扩展成为<strong>ld rd, offset(x2)</strong></p>
<p>lw的格式形如： | imm[11:0] | rs1 | 011 | rd | 0000011 |</p>
<h4 id="funct--b100-jrmvebreakjalradd">funct = b'100&rsquo;: jr/mv/ebreak/jalr/add</h4>
<image src="op10funct100.png" alter="jrmvebreakjalradd" width=600px />
<h5 id="jr">jr</h5>
<image src="Cjr.png" alter="jr" width=600px />
<p>当rd为0时，非法。</p>
<p>该指令最终可以扩展为<strong>jalr x0, 0(rs1)</strong></p>
<p>jalr指令的格式为：|imm[11:0]|rs1|000|rd|1100111|</p>
<h5 id="mv">mv</h5>
<image src="Cmv.png" alter="mv" width=600px />
<p>rd为0时，是hint指令。</p>
<p>该指令最终可以扩展为<strong>add rd, x0, rs2</strong></p>
<p>add指令形如：|0000000|rs2|rs1|000|rd|0110011|</p>
<h5 id="ebreak">ebreak</h5>
<p>可以扩展为ebreak指令。</p>
<p>形如：|00000000000100000000000001110011|</p>
<h5 id="jalr">jalr</h5>
<image src="Cjr.png" alter="jalr" width=600px />
<p>该指令最终可以扩展为<strong>jalr x1, 0(rs1)</strong></p>
<p>jalr指令的格式为：|imm[11:0]|rs1|000|rd|1100111|</p>
<h5 id="add">add</h5>
<image src="Cmv.png" alter="mv" width=600px />
<p>该指令最终可以扩展为<strong>add rd, rd, rs2</strong></p>
<p>add指令形如：|0000000|rs2|rs1|000|rd|0110011|</p>
<h4 id="funct--b101-fsdsp">funct = b'101&rsquo;: fsdsp</h4>
<image src="Cfsdsp.png" alter="fsdsp" width=600px />
<p>这条指令最终扩展成为<strong>fsd rs2, offset(x2)</strong></p>
<p>RVI的FSD格式形如：| imm[11:5]| rs2 | rs1 | 011 | imm[4:0] | 0100011 |</p>
<p>该指令要求CSR使能fs.status</p>
<h4 id="funct--b110-swsp">funct = b'110&rsquo;: swsp</h4>
<image src="Cfsdsp.png" alter="swsp" width=600px />
<p>这条指令最终扩展成为<strong>sw rs2, offset(x2)</strong></p>
<p>RVI的SW格式形如：| imm[11:5]| rs2 | rs1 | 010 | imm[4:0] | 0100011 |</p>
<h4 id="funct--b111-sdsp">funct = b'111&rsquo;: sdsp</h4>
<image src="Cfsdsp.png" alter="sdsp" width=600px />
<p>该指令最终扩展成为<strong>sd rd, offset(x2)</strong></p>
<p>RVI的SD格式形如：| imm[11:5]| rs2 | rs1 | 011 | imm[4:0] | 0100111 |</p>
</div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8232a31fca98c70ecc5a3e512677c27a">12.2.2 - ITLB</h1>
    
	<h2 id="tlb-功能概述">TLB 功能概述</h2>
<p>现代操作系统通常采用虚拟内存管理机制（Virtual Memory Management），在处理器中对应需要内存管理单元（MMU，Memory Management Unit）来进行虚实地址的映射。MMU 负责处理 CPU 的内存访问请求，其功能包括虚实地址的映射、内存保护、CPU 高速缓存控制等。</p>
<p>虚实地址的映射是以页（Page）为单位的。在物理内存管理中，内核会将整个物理内存空间划分为一个一个的页帧（Page Frame），一般情况下页帧大小为 4KB，称为一个物理页帧，内核会将每一个物理页帧进行编号（PFN，Page Frame Number），每个页帧有唯一确定的 PFN。对于一个进程来说，如果它直接使用物理地址构建自己的地址空间，那么作为进程就需要关心每一个变量存放在哪一个物理地址，也就是说程序员需要清楚数据在内存中的具体布局，还需要每次都要考虑内存的分配问题；同时，对于多个进程同时进行的情况，哪些数据是共享的，如何避免地址冲突等等都会成为问题。</p>
<p><img alt="进程地址空间" src="address_space.png"></p>
<p>MMU 为每个进程创建自己的虚拟地址空间，存储虚实地址的映射，在进程的视角看来它独享一段确定的（通常是连续的）地址，避免了其它进程的干扰；同时提供了虚实地址转换功能，这使得进程不必关心实际的物理地址在哪里，只需要对自己的地址空间进行操作。同时，对于一个进程来说，每次访问内存时并不是访问整个虚拟内存空间，因此进程实际需要占用的物理内存大小可以小于其虚拟地址空间的大小，由操作系统来决定要把哪一部分留在内存中，将剩余部分保存在磁盘中，在需要时再加载进入内存，极大的扩展了可用内存空间。</p>
<i>
<p><strong>程序局部性原理</strong>，是计算机科学术语，指程序在执行时呈现出局部性规律，即在一段时间内，整个程序的执行仅限于程序中的某一部分。相应地，执行所访问的存储空间也局限于某个内存区域。局部性原理又表现为：<strong>时间局部性</strong>和<strong>空间局部性</strong>。</p>
<ul>
<li><strong>时间局部性</strong>是指如果程序中的某条指令一旦执行，则不久之后该指令可能再次被执行；如果某数据被访问，则不久之后该数据可能再次被访问。</li>
<li><strong>空间局部性</strong>是指一旦程序访问了某个存储单元，则不久之后，其附近的存储单元也将被访问。</li>
</ul>
</i>
<p><img alt="虚实页表映射" src="virtual2real_pagetable_mapping.png"></p>
<p>这样的由 MMU 创建的并负责维护的由虚拟地址指向物理地址的映射也将成为一项存储在一个物理页帧中，MMU 为了访问这样的物理页帧也需要一个根页表，根页表中存储着指向这些物理页帧的页表项（PTE），称为叶子 PTE。一个 PTE 的长度一般为 64 Bit（8 Bytes），而每一个一般物理页帧的大小为 4KB，这也就意味着一个物理页帧最多可以存储 4KB/8B = 2^9 个 PTE，因此根页表可以索引的范围即为 2^9 × 4KB = 2MB。2MB 的页表并不能满足内存日益增大的需要，在香山中实现的 SV48 即采用了四级页表的形式，通过四级的查询最终得到物理地址，每一级页表都能够索引 2^9 个下一级页表，最终找到需要的映射。四级页表下能够索引的地址范围达到了 2^9 × 2^9 × 2^9 × 2MB = 256TB。而页表本身也会比较大，如果存满的话大小会达到 4KB + 2^9 × 4KB + 2^9 × 2^9 × 4KB + 2^9 × 2^9 × 2^9 × 4KB = 537921540KB ≈ 513GB。当然，不是说每一级页表都要填满，页表的四级结构可以理解为一个多叉树形结构，只有需要用到的才会实际使用，很多的分支都不需要使用，因此页表的大小是可变的。</p>
<p>页表一般很大，需要存放在内存中，而处理器每一次访问内存的请求都需要先访问页表查找对应的物理页号然后再去读取所需数据，因此在不发生缺页的情况下，每次访存操作都需要两次访问内存才能得到物理地址，然后再次访问才能得到需要的数据。为了减少多次访存造成的开销，引入了地址转换后援缓存器（TLB，Translation Lookaside Buffer）。MMU 通常借助 TLB 来进行虚实地址的转换。TLB 一般是相连高速缓存（associative cache），相当于页表的 Cache，负责将最可能会用到的页表项对应的映射（虚拟地址与对应的物理地址）存储下来；在查找页表时首先查找 TLB 内存储的映射，如果没有命中再去查找内存中存储的完整页表。</p>
<p>同 Cache 一样，TLB 中页表项的组织方式一般有直接映射、全相联映射、组相连映射三种方式。直接映射一般通过模运算匹配，例如对昆明湖 48 行的 TLB 来说，其第 1 块只能对应内存的第 1/49/97/&hellip;/(n×48+1) 块，硬件结构简单、成本低、转换速度快，但是 TLB 表项利用率低，TLB miss 频繁，只适用于 TLB 大小与页表大小较接近的情况。全相联映射则不同，内存中的所有表项可以存放在 TLB 中的任意一项中，可以充分利用 TLB 的空间，冲突概率更低，但因此查找开销较高，适用于小容量 TLB。组相联映射是一种折中，可以二路组相联、四路组相联等。在香山的 TLB 模块中提供了丰富的参数配置，其中即包括采取哪一种相连方式，可以通过传入参数自行配置。本次验证的 ITLB 即采用 48 项全相联的结构。</p>
<p><img alt="二路组相联示意图" src="2waygroup.png">
<img alt="四路组相联示意图" src="4waygroup.png"></p>
<p>香山的 MMU 模块由 TLB、Repeator、L2TLB、PMP&amp;PMA 组成，其中 L2TLB 又包含了 Page Cache、Page Table Walker、Last Level Page Table Walker、Miss Queue 和 Prefetcher。在核内每次进行内存的操作（读写）时都需要通过 MMU 模块进行虚实地址的翻译，而 TLB 将被实例化为 ITLB（前端取指）和 DTLB（后端访存）。以 ITLB 为例，每当 ICache 或 IFU 需要进行取指操作，会先向 ITLB 发送一个地址转换请求，把需要转换的虚拟地址发给 ITLB；ITLB 接收到请求后就要查找自己存储的表项里有没有这个虚拟地址对应的映射，如果有的话就输出对应物理地址（paddr），之后由 PMP&amp;PMA 模块检查对该物理地址的访问是否有效（包括地址是否有效、访问者是否有访问权限、页表属性等，其中对 ITLB 来说由于取出来的物理地址是待执行的指令，需要检查是否可以执行），检查通过后就可以把物理地址返回给前端。如果 ITLB 发现自己没有存储这样的表项，那么立即回应 miss，并同时发起 PTW 请求。前端接收到 miss 信号后会通过一些调度策略重新发起访问，在香山中体现为 miss 后不断重新给 TLB 发请求直到 hit。PTW 请求将交由 Page Table Walker 来执行，通过一些策略访问 L2TLB、Page Cache、内存中的完整页表，之后把访问到的 PTE（页表项）发回给 TLB（如果 PTW 都找不到那么会发生 Page Fault，同样返回给 TLB，TLB 收到 Page Fault 后会上报并由操作系统等从磁盘中加载页面）。TLB 接收到 PTE 的同时将 PTE 填充进自己的缓存中并向前端返回物理地址，前端才能通过该物理地址找到对应的指令。</p>
<p><img alt="TLB功能示意图" src="TLBfunc.png"></p>
<p>香山实现了二级 TLB，包括 TLB 与 L2TLB。同样类似于 Cache 与 L2Cache，TLB（一级 TLB）通常是小容量、高速缓存，直接与处理器核心连接，用于加速最近访问过的虚拟地址到物理地址的转换；L2TLB（二级 TLB）容量较大，速度稍慢，但比直接访问内存要快。L2TLB 用来缓存更多的页表项，减少一级 TLB 未命中（TLB Miss）时对内存的频繁访问，香山目前有 1 个 ITLB 和 3 个 DTLB，都与同一个 L2TLB 连接。在这种二级结构下，TLB 未命中时将会首先查找 L2TLB，之后如果再次未命中才去访问内存，可以有效提高地址转换的命中率和性能。由于在 TLB 与 L2TLB 之间有着一定的物理距离，因此在 TLB 向 L2TLB 发出读取请求的时候需要进行加拍，这项工作交给了 MMU 中的 repeater 进行，是 TLB 与 L2TLB 之间的一个请求缓冲。同时，repeator 还需要负责对 TLB 向 L2TLB 发送的请求进行过滤（即 Filter 的功能），把重复的请求过滤掉，以减少 L2TLB 性能损失。</p>
<p>昆明湖架构支持 RISC-V 手册中定义的 Hypervisor 扩展，即 H 扩展。H 扩展为处理器提供了虚拟化的支持，即允许虚拟机运行在主机上，此时虚拟机将与主机共享 TLB，那么在 MMU 中也需要进行相应的调整与支持。TLB 需要能够同时容纳多个虚拟机的条目并做到隔离，同时需要引入 Hypervisor Page Table Walker（HPTW）用于遍历虚拟机的页表。</p>
<p>在 MMU 模块中还需要实现 PMP（Physical Memory Protection）与 PMA（Physical Memory Access）检查，不过这与 TLB 无关，在实现中无论请求是否有效或有足够权限，都会通过 TLB 先进行地址转换，之后再把转换的结果（物理地址）送到 PMP&amp;PMA 模块进行权限检查。</p>
<h2 id="验证功能点列表及说明">验证功能点列表及说明</h2>
<p>此处将给出划分功能点及测试点的示例。如果您划分了新的功能点，请及时与我们沟通，我们会根据沟通结果修正功能点列表。测试点原则上可根据验证实际情况自行划分，此处仅给出示例。</p>
<h3 id="功能点1tlb接收请求">功能点1：TLB接收请求</h3>
<h4 id="功能说明">功能说明</h4>
<p>TLB 应当正常接收来自 IFU 与 ICache 的取指令请求，查找自身页表并作出适当的反应：miss 情况下返回 miss 并同时向 PTW 发送遍历请求，hit 情况返回正确结果。验证时此处应关注 TLB 做出的反应，无需关注请求本身的多种情况。</p>
<h4 id="测试点示例">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>接收来自 IFU 请求（requestor0、1）</td>
<td>ITLB 根据请求查找自身缓存 TLBuffer，返回 hit/miss 结果</td>
</tr>
<tr>
<td>1.2</td>
<td>接收来自 ICache 请求（requestor2）</td>
<td>注意此处为阻塞式访问，每次访问后若 miss 应当 reset 后再次访问</td>
</tr>
<tr>
<td>1.3</td>
<td>接收条件判断（requestor0、1）</td>
<td>valid 信号</td>
</tr>
<tr>
<td>1.4</td>
<td>接受条件判断（requestor2）</td>
<td>valid-ready 信号</td>
</tr>
</tbody>
</table>
<h3 id="功能点2tlb-miss-处理">功能点2：TLB miss 处理</h3>
<h4 id="功能说明-1">功能说明</h4>
<p>miss 情况下发送页表遍历请求，额外需要注意边界情况下的请求处理，保证 TLB 发送的 PTW 请求正确。</p>
<h4 id="测试点示例-1">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>返回 miss 结果</td>
<td>比对后发现 miss 并返回</td>
</tr>
<tr>
<td>2.2</td>
<td>发起 PTW req（同时检验 PTW req valid 0/1）</td>
<td>从端口 0/1 发起页表遍历请求</td>
</tr>
<tr>
<td>2.3</td>
<td>发起 PTW req（同时检验 PTW req valid-ready 2）</td>
<td>从端口 2 发起页表遍历请求</td>
</tr>
<tr>
<td>2.4</td>
<td>不同情况下发起 PTW req</td>
<td>改变 CSR（vsatp、hgatp），依然能够正常发送请求</td>
</tr>
<tr>
<td>2.5</td>
<td>PTW resp valid 信号有效</td>
<td>检验该信号是否正常</td>
</tr>
<tr>
<td>2.6</td>
<td>重填 nonStage 条目，之后能正确访问</td>
<td>无</td>
</tr>
<tr>
<td>2.7</td>
<td>重填 OnlyStage1 条目，之后能正确访问</td>
<td>无</td>
</tr>
<tr>
<td>2.8</td>
<td>重填 OnleStage2 条目，之后能正确访问</td>
<td>无</td>
</tr>
<tr>
<td>2.9</td>
<td>重填 allStage 条目，之后能正确访问</td>
<td>无</td>
</tr>
</tbody>
</table>
<h3 id="功能点3tlb-hit-处理">功能点3：TLB hit 处理</h3>
<h4 id="功能说明-2">功能说明</h4>
<p>hit 情况下返回查询到的物理地址。requestor2 应当结束阻塞。</p>
<h4 id="测试点示例-2">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1</td>
<td>主机查询得到物理地址</td>
<td>paddr</td>
</tr>
<tr>
<td>3.2</td>
<td>虚拟机查询得到物理地址</td>
<td>gpaddr</td>
</tr>
<tr>
<td>3.3</td>
<td>虚拟机查询得到中间物理地址</td>
<td>IPA</td>
</tr>
</tbody>
</table>
<h3 id="功能点4替换策略">功能点4：替换策略</h3>
<h4 id="功能说明-3">功能说明</h4>
<p>根据文档说明，香山的 ITLB 使用 PLRU 替换策略，具体实现时使用的是外部提供的库。验证时可自学 PLRU 算法，并设计合理策略。</p>
<h4 id="测试点示例-3">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4.1</td>
<td>填满后持续重填随机次数</td>
<td>建议建立参考模型进行对比</td>
</tr>
<tr>
<td>4.2</td>
<td>随机 hit/miss 一段时间</td>
<td>建议建立参考模型进行对比</td>
</tr>
</tbody>
</table>
<h3 id="功能点5tlb-缓存大小">功能点5：TLB 缓存大小</h3>
<h4 id="功能说明-4">功能说明</h4>
<p>检验 TLB 是否能够支持理论最大（48*8）项页表条目的存储。注意 PLRU 替换策略将导致一定情况下不能填满，验证中无需考虑因为该策略导致的未填充满。</p>
<h4 id="测试点示例-4">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>5.1</td>
<td>顺序填充至满</td>
<td>检验最终能够存储的最大条目数，这将直接影响 TLB 加速取指的效率</td>
</tr>
<tr>
<td>5.2</td>
<td>乱序随机</td>
<td>模拟应用场景，记录并检验条目数</td>
</tr>
</tbody>
</table>
<h3 id="功能点6tlb-压缩">功能点6：TLB 压缩</h3>
<h4 id="功能说明-5">功能说明</h4>
<p>支持 TLB 压缩，具体可见文档。注意保证随机性。</p>
<h4 id="测试点示例-5">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.1</td>
<td>压缩 8 项条目</td>
<td>一个压缩条目内的 8 项页表项都可以正常 hit</td>
</tr>
<tr>
<td>6.2</td>
<td>全满压力测试</td>
<td>全部填满时可连续命中</td>
</tr>
<tr>
<td>6.3</td>
<td>idx 随机测试</td>
<td>检测对应 idx 信号是否有效</td>
</tr>
</tbody>
</table>
<h3 id="功能点7刷新">功能点7：刷新</h3>
<h4 id="功能说明-6">功能说明</h4>
<p>TLB 模块需要在进程切换等场景下频繁刷新，也需要接收定向刷新指令刷新指定条目。验证中要建立填入-刷新-检验miss情况的流程，建议自定义函数完成。注意页表属性 Global 的影响，自行制定合适的策略。</p>
<h4 id="测试点示例-6">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.1</td>
<td>SFENCE  rs1=0 rs2=0</td>
<td>刷新全部条目</td>
</tr>
<tr>
<td>7.2</td>
<td>SFENCE  rs1=0 rs2=1</td>
<td>刷新指定条目</td>
</tr>
<tr>
<td>7.3</td>
<td>SFENCE  rs1=1 rs2=0</td>
<td>刷新指定地址空间</td>
</tr>
<tr>
<td>7.4</td>
<td>SFENCE  rs1=1 rs2=1</td>
<td>刷新指定地址空间的指定条目</td>
</tr>
<tr>
<td>7.5</td>
<td>带 flushpipe 的 Sfence</td>
<td>清空流水线</td>
</tr>
<tr>
<td>7.6</td>
<td>SFENCE hv=1/hg=1</td>
<td>刷新虚拟机的条目</td>
</tr>
<tr>
<td>7.7</td>
<td>flushPipe0</td>
<td>清空流水线0</td>
</tr>
<tr>
<td>7.8</td>
<td>flushPipe1</td>
<td>清空流水线1</td>
</tr>
<tr>
<td>7.9</td>
<td>flushPipe2</td>
<td>清空流水线2</td>
</tr>
<tr>
<td>7.10</td>
<td>satp.changed</td>
<td>按一定策略刷新</td>
</tr>
<tr>
<td>7.11</td>
<td>vsatp.changed</td>
<td>按一定策略刷新</td>
</tr>
<tr>
<td>7.12</td>
<td>hgatp.changed</td>
<td>按一定策略刷新</td>
</tr>
</tbody>
</table>
<h3 id="功能点8reset">功能点8：Reset</h3>
<h4 id="功能说明-7">功能说明</h4>
<p>保证正常复位。TLB 工作流程涉及多个周期，需保证在各个阶段中执行 reset 均能正常复位。</p>
<h4 id="测试点示例-7">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.1</td>
<td>Reset 复位</td>
<td>检查所有信号按预期复位</td>
</tr>
<tr>
<td>8.2</td>
<td>请求同时复位</td>
<td>检查所有信号按预期复位</td>
</tr>
<tr>
<td>8.3</td>
<td>resp 同时复位</td>
<td>检查所有信号按预期复位</td>
</tr>
</tbody>
</table>
<h3 id="功能点9权限检查">功能点9：权限检查</h3>
<h4 id="功能说明-8">功能说明</h4>
<p>TLB 并不涉及复杂的页属性检查，仅涉及用户态/内核态的权限。由于 ITLB 存储的全部为指令页，页属性必须全部可执行。</p>
<h4 id="测试点示例-8">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.1</td>
<td>主机状态下（U/S）访问权限检查</td>
<td>U 只能访问 U=1，S 只能访问 U=0</td>
</tr>
<tr>
<td>9.2</td>
<td>虚拟机状态下（VU/VS）访问权限检查</td>
<td>VU 只能访问 U=1，VS 只能访问 U=0</td>
</tr>
<tr>
<td>9.3</td>
<td>权限切换时的行为</td>
<td>IT级别验证时报告权限切换时会出现一个信号异常，可重点关注</td>
</tr>
<tr>
<td>9.4</td>
<td>X=0</td>
<td>页面不可执行时的行为</td>
</tr>
</tbody>
</table>
<h3 id="功能点10异常处理">功能点10：异常处理</h3>
<h4 id="功能说明-9">功能说明</h4>
<p>ITLB 在异常方面承担的主要职责就是上报。当下层模块报告 GPF 时，由于 ITLB 不存储中间物理地址，此时重填需要首先发送一个带 GetGPA 标志的重填，标志当前重填请求是请求的虚拟机物理地址，PTW 会把这个请求标志发送回来，带该标志的 PTW resp 不会被存入 TLBuffer。</p>
<h4 id="测试点示例-9">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1</td>
<td>s1-pf</td>
<td>主机缺页异常</td>
</tr>
<tr>
<td>10.2</td>
<td>s1-af</td>
<td>主机访问权限异常</td>
</tr>
<tr>
<td>10.3</td>
<td>s2-gpf</td>
<td>虚拟机缺页异常</td>
</tr>
<tr>
<td>10.4</td>
<td>s2-gaf</td>
<td>虚拟机访问权限异常</td>
</tr>
<tr>
<td>10.5</td>
<td>getGPA 信号相关</td>
<td>验证中自行拆分</td>
</tr>
</tbody>
</table>
<h3 id="功能点11隔离">功能点11：隔离</h3>
<h4 id="功能说明-10">功能说明</h4>
<p>地址空间隔离，通过 asid、vmid 实现进程、虚拟机之间的隔离。</p>
<h4 id="测试点示例-10">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>11.1</td>
<td>进程间隔离</td>
<td>无</td>
</tr>
<tr>
<td>11.2</td>
<td>虚拟机间隔离</td>
<td>无</td>
</tr>
<tr>
<td>11.3</td>
<td>虚拟机的进程间隔离</td>
<td>无</td>
</tr>
</tbody>
</table>
<h3 id="功能点12并行访问">功能点12：并行访问</h3>
<h4 id="功能说明-11">功能说明</h4>
<p>模块包含 3 个端口，其访问是可以同时接收的，但是TLB的查询必须按序。TLB会将接收的请求暂存，以队列形式处理，当然 requestor2 作为阻塞式访问不参与这个过程。在实际场景下，对与 TLB miss 的情况，ICache 会自行组织重新持续发送请求。</p>
<h4 id="测试点示例-11">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>12.1</td>
<td>同时 hit</td>
<td>三个预期会 hit 的请求同一拍进入 TLB</td>
</tr>
<tr>
<td>12.2</td>
<td>同时 miss</td>
<td>三个预期会 miss 的请求同一拍进入 TLB</td>
</tr>
<tr>
<td>12.3</td>
<td>随机顺序回填</td>
<td>模拟实际场景持续发送请求，并以随机顺序回填</td>
</tr>
<tr>
<td>12.4</td>
<td>发送请求同时回填请求的地址</td>
<td>在同一拍对同一个地址发送请求&amp;回填</td>
</tr>
</tbody>
</table>
<h3 id="功能点13大小页支持">功能点13：大小页支持</h3>
<h4 id="功能说明-12">功能说明</h4>
<p>TLB 支持保存全部大小页，不同 level 的页面都应该可以存入 TLB 中。</p>
<h4 id="测试点示例-12">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>13.1</td>
<td>level=0</td>
<td>无</td>
</tr>
<tr>
<td>13.2</td>
<td>level=1</td>
<td>无</td>
</tr>
<tr>
<td>13.3</td>
<td>level=2</td>
<td>无</td>
</tr>
<tr>
<td>13.4</td>
<td>level=3</td>
<td>无</td>
</tr>
</tbody>
</table>
<h3 id="功能点14时序">功能点14：时序</h3>
<h4 id="功能点说明">功能点说明</h4>
<p>检验 TLB 时序，保证每拍的信号级别行为正确。</p>
<h4 id="测试点示例-13">测试点示例</h4>
<table>
<thead>
<tr>
<th>No.</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>14.1</td>
<td>请求命中时序（requestor0、1）</td>
<td>无</td>
</tr>
<tr>
<td>14.2</td>
<td>请求命中时序（requestor2）</td>
<td>无</td>
</tr>
<tr>
<td>14.3</td>
<td>请求miss时序（requestor0、1）</td>
<td>无</td>
</tr>
<tr>
<td>14.4</td>
<td>请求miss时序（requestor2）</td>
<td>无</td>
</tr>
</tbody>
</table>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8c8ea31c8faf4aa9bfcdd9a6dd4a60b2">12.2.2.1 - IO接口说明</h1>
    
	<h1 id="香山实例化-tlbsv-接口说明itlb">香山实例化 TLB.sv 接口说明（ITLB）</h1>
<h2 id="基本控制信号">基本控制信号</h2>
<ul>
<li><code>clock</code>: 时钟信号，驱动 <code>TLB</code> 的时序逻辑。</li>
<li><code>reset</code>: 复位信号，用于重置 <code>TLB</code> 的状态。</li>
</ul>
<h2 id="刷新sfence接口信号">刷新（SFENCE）接口信号</h2>
<ul>
<li><code>io_sfence_valid</code>: <code>SFENCE</code> 操作的有效性标志。</li>
<li><code>io_sfence_bits_rs1</code>: <code>SFENCE</code> 操作是否使用寄存器 <code>rs1</code> 的值。</li>
<li><code>io_sfence_bits_rs2</code>: <code>SFENCE</code> 操作是否使用寄存器 <code>rs2</code> 的值。</li>
<li><code>io_sfence_bits_addr</code>: <code>SFENCE</code> 操作指定的地址，用于选择性刷新特定地址的 <code>TLB</code> 条目。</li>
<li><code>io_sfence_bits_id</code>: 刷新操作指定的 <code>asid/vmid</code>，用于选择性刷新特定地址空间的 <code>TLB</code> 条目。</li>
<li><code>io_sfence_bits_flushPipe</code>: 刷新整个管道。</li>
<li><code>io_sfence_bits_hv</code>: 指示指令是否为 <code>HFENCE.VVMA</code>，即是否刷新虚拟化下由 <code>vsatp</code> 寄存器控制的条目。</li>
<li><code>io_sfence_bits_hg</code>: 指示指令是否为 <code>HFENCE.GVMA</code>，即是否刷新由 <code>hgatp</code> 寄存器控制的条目。</li>
</ul>
<h2 id="控制与状态寄存器csr接口信号">控制与状态寄存器（CSR）接口信号</h2>
<ul>
<li><code>io_csr_satp_mode</code>: <code>SATP</code> 寄存器的模式字段（如裸模式、<code>Sv32</code>、<code>Sv39</code> 等）。</li>
<li><code>io_csr_satp_asid</code>: 当前 <code>SATP</code> 寄存器的 <code>ASID</code>（地址空间标识符）。</li>
<li><code>io_csr_satp_changed</code>: 指示 <code>SATP</code> 寄存器的值是否已更改。</li>
<li><code>io_csr_vsatp_mode</code>: <code>VSATP</code> 寄存器的模式字段。</li>
<li><code>io_csr_vsatp_asid</code>: <code>VSATP</code> 寄存器的 <code>ASID</code>。</li>
<li><code>io_csr_vsatp_changed</code>: 指示 <code>VSATP</code> 寄存器的值是否已更改。</li>
<li><code>io_csr_hgatp_mode</code>: <code>HGATP</code> 寄存器的模式字段。</li>
<li><code>io_csr_hgatp_vmid</code>: <code>HGATP</code> 寄存器的 <code>VMID</code>（虚拟机标识符）。</li>
<li><code>io_csr_hgatp_changed</code>: 指示 <code>HGATP</code> 寄存器的值是否已更改。</li>
<li><code>io_csr_priv_virt</code>: 指示是否在虚拟模式下运行。</li>
<li><code>io_csr_priv_imode</code>: 指令模式的特权级（如用户态、内核态等）。</li>
</ul>
<h2 id="请求者requestor接口信号">请求者（Requestor）接口信号</h2>
<h3 id="requestor-0-信号">Requestor 0 信号</h3>
<ul>
<li><code>io_requestor_0_req_valid</code>: <code>requestor0</code> 的请求有效信号。</li>
<li><code>io_requestor_0_req_bits_vaddr</code>: <code>requestor0</code> 的请求虚拟地址。</li>
<li><code>io_requestor_0_resp_bits_paddr_0</code>: <code>requestor0</code> 的物理地址响应信号。</li>
<li><code>io_requestor_0_resp_bits_gpaddr_0</code>: <code>requestor0</code> 的物理地址转换为 <code>GPA</code>（<code>Guest Physical Address</code>）的响应信号。</li>
<li><code>io_requestor_0_resp_bits_miss</code>: <code>requestor0</code> 请求的地址未命中的信号。</li>
<li><code>io_requestor_0_resp_bits_excp_0_gpf_instr</code>: <code>requestor0</code> 出现 <code>General Protection Fault</code> (<code>GPF</code>) 异常的信号。</li>
<li><code>io_requestor_0_resp_bits_excp_0_pf_instr</code>: <code>requestor0</code> 出现 <code>Page Fault</code> (<code>PF</code>) 异常的信号。</li>
<li><code>io_requestor_0_resp_bits_excp_0_af_instr</code>: <code>requestor0</code> 出现 <code>Access Fault</code> (<code>AF</code>) 异常的信号。</li>
</ul>
<h3 id="requestor-1-信号">Requestor 1 信号</h3>
<ul>
<li><code>io_requestor_1_req_valid</code>: <code>requestor1</code> 的请求有效信号。</li>
<li><code>io_requestor_1_req_bits_vaddr</code>: <code>requestor1</code> 的请求虚拟地址。</li>
<li><code>io_requestor_1_resp_bits_paddr_0</code>: <code>requestor1</code> 的物理地址响应信号。</li>
<li><code>io_requestor_1_resp_bits_gpaddr_0</code>: <code>requestor1</code> 的 <code>GPA</code> 响应信号。</li>
<li><code>io_requestor_1_resp_bits_miss</code>: <code>requestor1</code> 的未命中信号。</li>
<li><code>io_requestor_1_resp_bits_excp_0_gpf_instr</code>: <code>requestor1</code> 出现 <code>GPF</code> 异常的信号。</li>
<li><code>io_requestor_1_resp_bits_excp_0_pf_instr</code>: <code>requestor1</code> 出现 <code>PF</code> 异常的信号。</li>
<li><code>io_requestor_1_resp_bits_excp_0_af_instr</code>: <code>requestor1</code> 出现 <code>AF</code> 异常的信号。</li>
</ul>
<h3 id="requestor-2-信号">Requestor 2 信号</h3>
<ul>
<li><code>io_requestor_2_req_ready</code>: <code>requestor2</code> 的请求就绪信号。</li>
<li><code>io_requestor_2_req_valid</code>: <code>requestor2</code> 的请求有效信号。</li>
<li><code>io_requestor_2_req_bits_vaddr</code>: <code>requestor2</code> 的请求虚拟地址。</li>
<li><code>io_requestor_2_resp_ready</code>: <code>requestor2</code> 的响应就绪信号。</li>
<li><code>io_requestor_2_resp_valid</code>: <code>requestor2</code> 的响应有效信号。</li>
<li><code>io_requestor_2_resp_bits_paddr_0</code>: <code>requestor2</code> 的物理地址响应信号。</li>
<li><code>io_requestor_2_resp_bits_gpaddr_0</code>: <code>requestor2</code> 的 <code>GPA</code> 响应信号。</li>
<li><code>io_requestor_2_resp_bits_excp_0_gpf_instr</code>: <code>requestor2</code> 出现 <code>GPF</code> 异常的信号。</li>
<li><code>io_requestor_2_resp_bits_excp_0_pf_instr</code>: <code>requestor2</code> 出现 <code>PF</code> 异常的信号。</li>
<li><code>io_requestor_2_resp_bits_excp_0_af_instr</code>: <code>requestor2</code> 出现 <code>AF</code> 异常的信号。</li>
</ul>
<h2 id="刷新管道flush-pipe信号">刷新管道（Flush Pipe）信号</h2>
<ul>
<li><code>io_flushPipe_0</code>: 刷新管道 <code>0</code> 的信号。</li>
<li><code>io_flushPipe_1</code>: 刷新管道 <code>1</code> 的信号。</li>
<li><code>io_flushPipe_2</code>: 刷新管道 <code>2</code> 的信号。</li>
</ul>
<h2 id="页表遍历page-table-walker-ptw接口信号">页表遍历（Page Table Walker, PTW）接口信号</h2>
<h3 id="ptw-请求信号">PTW 请求信号</h3>
<ul>
<li><code>io_ptw_req_0_valid</code>: <code>PTW req0</code> 有效信号。</li>
<li><code>io_ptw_req_0_bits_vpn</code>: <code>PTW req0</code> 的虚拟页号（<code>VPN</code>）。</li>
<li><code>io_ptw_req_0_bits_s2xlate</code>: 指示 <code>PTW req0</code> 的转换模式。</li>
<li><code>io_ptw_req_0_bits_getGpa</code>: <code>PTW req0</code> 的获取 <code>GPA</code> 信号。</li>
<li><code>io_ptw_req_1_valid</code>: <code>PTW req1</code> 有效信号。</li>
<li><code>io_ptw_req_1_bits_vpn</code>: <code>PTW req1</code> 的虚拟页号。</li>
<li><code>io_ptw_req_1_bits_s2xlate</code>: 指示 <code>PTW req1</code> 的转换模式。</li>
<li><code>io_ptw_req_1_bits_getGpa</code>: <code>PTW req1</code> 的获取 <code>GPA</code> 信号。</li>
<li><code>io_ptw_req_2_ready</code>: <code>PTW req2</code> 就绪信号。</li>
<li><code>io_ptw_req_2_valid</code>: <code>PTW req2</code> 有效信号。</li>
<li><code>io_ptw_req_2_bits_vpn</code>: <code>PTW req2</code> 的虚拟页号。</li>
<li><code>io_ptw_req_2_bits_s2xlate</code>: 指示 <code>PTW req2</code> 的转换模式。</li>
<li><code>io_ptw_req_2_bits_getGpa</code>: <code>PTW req2</code> 的获取 <code>GPA</code> 信号。</li>
</ul>
<h3 id="ptw-响应信号">PTW 响应信号</h3>
<ul>
<li><code>io_ptw_resp_valid</code>: <code>PTW resp</code> 有效信号。</li>
<li><code>io_ptw_resp_bits_s2xlate</code>: 指示 <code>PTW resp</code> 的地址转换类型。</li>
<li><code>io_ptw_resp_bits_s1_entry_tag</code>: <code>PTW resp</code> 的第一阶段页表条目标签。</li>
<li><code>io_ptw_resp_bits_s1_entry_asid</code>: <code>PTW resp</code> 的第一阶段页表条目 <code>ASID</code>。</li>
<li><code>io_ptw_resp_bits_s1_entry_vmid</code>: <code>PTW resp</code> 的第一阶段页表条目 <code>VMID</code>。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_d</code>: <code>PTW resp</code> 的第一阶段页表条目可写位。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_a</code>: <code>PTW resp</code> 的第一阶段页表条目已访问位。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_g</code>: <code>PTW resp</code> 的第一阶段页表条目全局位。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_u</code>: <code>PTW resp</code> 的第一阶段页表条目用户模式位。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_x</code>: <code>PTW resp</code> 的第一阶段页表条目可执行位。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_w</code>: <code>PTW resp</code> 的第一阶段页表条目可写位。</li>
<li><code>io_ptw_resp_bits_s1_entry_perm_r</code>: <code>PTW resp</code> 的第一阶段页表条目可读位。</li>
<li><code>io_ptw_resp_bits_s1_entry_level</code>: <code>PTW resp</code> 的第一阶段页表条目级别。</li>
<li><code>io_ptw_resp_bits_s1_entry_ppn</code>: <code>PTW resp</code> 的第一阶段页表条目物理页号（<code>PPN</code>）。</li>
<li><code>io_ptw_resp_bits_s1_addr_low</code>: <code>PTW resp</code> 的第一阶段页表条目地址低位。</li>
<li><code>io_ptw_resp_bits_s1_ppn_low_*</code>: <code>PTW resp</code> 的第一阶段页表条目 <code>PPN</code> 低位。</li>
<li><code>io_ptw_resp_bits_s1_valididx_*</code>: <code>PTW resp</code> 的第一阶段页表条目有效索引。</li>
<li><code>io_ptw_resp_bits_s1_pteidx_*</code>: <code>PTW resp</code> 的第一阶段页表条目 <code>PTE</code> 索引。</li>
<li><code>io_ptw_resp_bits_s1_pf</code>: <code>PTW resp</code> 的第一阶段页表条目出现 <code>PF</code>。</li>
<li><code>io_ptw_resp_bits_s1_af</code>: <code>PTW resp</code> 的第一阶段页表条目出现 <code>AF</code>。</li>
<li><code>io_ptw_resp_bits_s2_entry_tag</code>: <code>PTW resp</code> 的第二阶段页表条目标签。</li>
<li><code>io_ptw_resp_bits_s2_entry_vmid</code>: <code>PTW resp</code> 的第二阶段页表条目 <code>VMID</code>。</li>
<li><code>io_ptw_resp_bits_s2_entry_ppn</code>: <code>PTW resp</code> 的第二阶段页表条目 <code>PPN</code>。</li>
<li><code>io_ptw_resp_bits_s2_entry_perm_*</code>: <code>PTW resp</code> 的第二阶段页表条目的权限位。</li>
<li><code>io_ptw_resp_bits_s2_entry_level</code>: <code>PTW resp</code> 的第二阶段页表条目级别。</li>
<li><code>io_ptw_resp_bits_s2_gpf</code>: <code>PTW resp</code> 的第二阶段页表条目 <code>GPF</code> 信号。</li>
<li><code>io_ptw_resp_bits_s2_gaf</code>: <code>PTW resp</code> 的第二阶段页表条目 <code>GAF</code> 信号。</li>
<li><code>io_ptw_resp_bits_getGpa</code>: <code>PTW resp</code> 的获取 <code>GPA</code> 信号。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f567a757741a110183ec410da59a031f">12.2.2.2 - 功能详述</h1>
    
	<h2 id="支持-sv48-分页机制">支持 SV48 分页机制</h2>
<p><code>SV48</code> （<code>Supervisor-mode Virtual Memory</code>）是一种基于 <code>RISC-V</code> 的页表虚拟内存寻址模式，指定了 <code>48</code> 位虚拟地址空间的结构，支持 <code>256TB</code> 的虚拟内存地址空间。使用四级页表结构：</p>
<p><img alt="Sv48_vaddr" src="Sv48_vaddr.png"></p>
<p><img alt="Sv48_paddr" src="Sv48_paddr.png"></p>
<p><img alt="Sv48_pagetable" src="Sv48_pagetable.png"></p>
<p>在 <code>SV48</code> 的一个 <code>PTE</code> 中包含了如下字段：</p>
<ul>
<li>
<p><code>N</code>:</p>
<ul>
<li>指示是否为 <code>NAPOT PTE</code>。供 <code>Svnapot</code> 扩展使用，如果未实现 <code>Svnapot</code> 则该位必须由软件置 <code>0</code>，否则应当出现 <code>Page Fault</code>。目前香山昆明湖架构尚未支持此扩展。</li>
</ul>
</li>
<li>
<p><code>PBMT</code>:</p>
<ul>
<li><code>Page-Based Memory Types</code>，即基于页面的内存类型，供 <code>Svpbmt</code> 扩展使用，允许操作系统为每个页面指定不同的内存访问属性。
<ul>
<li><code>0</code>: <code>None</code>，没有特定的内存属性。</li>
<li><code>1</code>: <code>NC</code>，非缓存、幂等、弱序（<code>RVWMO</code>），适用于主存。</li>
<li><code>2</code>: <code>IO</code>，非缓存、非幂等、强序（<code>I/O</code> 排序），适用于 <code>I/O</code> 设备。</li>
<li><code>3</code>: <code>Reserved</code>，保留供将来标准使用。</li>
</ul>
</li>
</ul>
<p>同样的，如果未实现 <code>Svpbmt</code> 则这两位必须由软件置 <code>0</code>，否则应当出现 <code>Page Fault</code>。</p>
</li>
<li>
<p><code>Reserved</code>:</p>
<ul>
<li>保留位，供未来的标准使用。如果有任意一位不是 <code>0</code> 则会触发 <code>PF</code> 异常。</li>
</ul>
</li>
<li>
<p><code>PPN</code>:</p>
<ul>
<li>表示物理页框号，指向实际的物理内存页。<code>PPN</code> 与页面内偏移结合形成完整的物理地址，用于地址转换。</li>
</ul>
</li>
<li>
<p><code>RSW</code>:</p>
<ul>
<li>保留供软件使用的位，通常用于特定的标志或操作，以便在软件实现中提供灵活性。</li>
</ul>
</li>
<li>
<p><code>D</code>:</p>
<ul>
<li>脏位，指示该页面是否被写入。如果该位为 <code>1</code>，表示该页的数据已被修改，需在换出时写回到存储设备。</li>
</ul>
</li>
<li>
<p><code>A</code>:</p>
<ul>
<li>访问位，指示该页是否被访问过。如果该位为 <code>1</code>，表示该页已被读取或写入，用于页面替换算法。</li>
</ul>
</li>
<li>
<p><code>G</code>:</p>
<ul>
<li>全局页位，指示该页是否是全局页。如果该位为 <code>1</code>，表示该页对所有进程可见，用于共享代码或数据。</li>
</ul>
</li>
<li>
<p><code>U</code>:</p>
<ul>
<li>用户访问权限位，指示该页是否可被用户（<code>U</code>）模式访问。如果该位为 <code>1</code>，用户模式可以访问该页；若为 <code>0</code>，则仅限于特权模式。</li>
</ul>
</li>
<li>
<p><code>X</code>:</p>
<ul>
<li>可执行位，指示该页是否可执行。如果该位为 <code>1</code>，表示该页可以执行代码；若为 <code>0</code>，则不可执行。</li>
</ul>
</li>
<li>
<p><code>W</code>:</p>
<ul>
<li>可写位，指示该页是否可写。如果该位为 <code>1</code>，表示该页可以写入数据；若为 <code>0</code>，则不可写。</li>
</ul>
</li>
<li>
<p><code>R</code>:</p>
<ul>
<li>可读位，指示该页是否可读。如果该位为 <code>1</code>，表示该页可以读取数据；若为 <code>0</code>，则不可读。</li>
</ul>
</li>
<li>
<p><code>V</code>:</p>
<ul>
<li>有效位，指示该页表项是否有效。如果该位为 <code>1</code>，表示该项有效，可以进行地址转换；若为 <code>0</code>，则表示该项无效。</li>
</ul>
</li>
</ul>
<p>值得一提的是，如果该 <code>PTE</code> 并不是叶子 <code>PTE</code>，即它所存储的 <code>PPN</code> 用来指向下一级页表，那么它的 <code>X</code>、<code>W</code>、<code>R</code> 位应全为零。在手册中的要求如下：</p>
<p><img alt="XWR 示意图" src="XWR.png"></p>
<p><code>RISC-V H</code> 扩展即 <code>Hypervisor</code> 扩展，增加了对虚拟化和 <code>hypervisor</code> 模式的支持，将会允许虚拟机监控程序和虚拟机的管理程序，允许操作系统运行在虚拟机上，并可以通过 <code>hypervisor</code> 调度虚拟机的运行。在 <code>hypervisor</code> 下使用 <code>SV48x4</code> 寻址模式，支持四倍页表扩展。</p>
<p><img alt="Sv48x4 虚拟地址" src="Sv48x4.png"></p>
<p><code>VPN[3]</code> 进行了两位的扩展，也即大小从原来的 <code>4KB</code> 变为 <code>16KB</code>，支持 $2^{11}$ 个 <code>PTE</code>。值得注意的是，<code>SV48x4</code> 作用于虚拟机物理地址 <code>VPA</code>，在虚拟机上创建进程地址空间时仍然采用的是 <code>SV48</code>。也正是因此，虚拟机进行虚实地址转换的时候，首先将 <code>48</code> 位的虚拟机虚拟地址（<code>GVA</code>）转换为 <code>50</code> 位的虚拟机物理地址（<code>GPA</code>），之后再将 <code>GPA</code>（相当于主机的 <code>HVA</code>）转换为主机物理地址（<code>HPA</code>）。在页表项中存储的是 <code>44</code> 位的 <code>PPN</code>，这是由 <code>56</code> 位的物理地址去掉 <code>12</code> 位的页内偏移得到的，因此完全可以存的下扩展了两位（<code>38</code> 位）的 <code>VPN</code>。</p>
<p>出于对面积等的优化考虑，在香山中采用 <code>48</code> 位的主机物理地址，而不是 <code>Sv48</code> 要求的 <code>56</code> 位物理地址，这是因为 <code>48</code> 位的物理地址已经可以索引 <code>256TB</code> 的物理地址空间，目前来说已经足够使用。但是由于 <code>TLB</code> 对虚拟机的支持，在虚拟机两阶段地址转换过程中（两阶段地址转换可见支持两阶段虚实地址翻译过程部分），虚拟机通过 <code>VS</code> 阶段转换的结果仍然是 <code>56</code> 位的虚拟机物理地址，只不过在进入 <code>G</code> 阶段地址转换时，<code>G</code> 阶段要求传入的 <code>GPA</code> 的高 <code>6</code> 位必须为 <code>0</code>，这是因为在 <code>Sv48x4</code> 中客户机物理地址要求为 <code>50</code> 位，而 <code>VS</code> 阶段得到的物理地址是 <code>56</code> 位。为了保持 <code>gpaddr</code> 的完整性，<code>PTW</code> 传入 <code>TLB</code> 的 <code>ppn</code> 信号的位宽依然为 <code>44</code> 位，然而由于 <code>TLB</code> 不存储中间转换结果（中间物理地址 <code>IPA</code>），也就不需要存储 <code>44</code> 位的 <code>ppn</code>，在 <code>TLB</code> 表项中存储的只有主机的 <code>ppn</code>，也即 <code>36</code> 位的 <code>ppn</code>。</p>
<h2 id="支持缓存映射条目">支持缓存映射条目</h2>
<p><code>TLB</code> 中存储的条目并不是页表项 <code>PTE</code>，而是一个映射，一个从虚拟地址（来自于请求）到物理地址（来自于查找结果）的映射，当然还有一些访问所必须的信息。在目前的香山中 <code>TLB</code> 所存储的条目包含 <code>tag[35]</code>、<code>asid[16]</code>、<code>vmid[14]</code>、<code>level[2]</code>、<code>ppn[33]</code>、<code>8 × ppn_low[3]</code>、<code>8 × valididx</code>、<code>8 × pteidx</code>、<code>s2xlate</code>、<code>perm[6]</code>、<code>g_perm[4]</code>。为供以后使用 <code>svpbmt</code> 扩展，还存储了 <code>pbmt</code> 与 <code>g_pbmt</code> 字段。</p>
<p><img alt="TLB 缓存条目" src="TLBstore.png"></p>
<ul>
<li>
<p><strong>tag[34:0]</strong></p>
<ul>
<li><code>tag</code>，用于匹配条目。来源于 <code>VPN</code> 的高 <code>35</code> 位，在匹配的过程中，输入一个 <code>38</code> 位的 <code>VPN</code>，通过将输入的 <code>VPN</code> 的前 <code>35</code> 位与 <code>tag</code> 比较找到对应的条目，可以看到在一个条目中存储了 <code>PPN</code> 的高位部分和 <code>8</code> 个 <code>ppn_low</code>，之后将 <code>VPN</code> 的后三位作为索引，可以索引这 <code>8</code> 个 <code>ppn_low</code>，即可将 <code>ppn</code> 与 <code>ppn_low[vpn_low]</code> 拼接得到物理页框号。</li>
</ul>
</li>
<li>
<p><strong>asid[15:0]</strong></p>
<ul>
<li>地址空间标识符，用于区分不同的进程地址空间。</li>
</ul>
</li>
<li>
<p><strong>vmid[13:0]</strong></p>
<ul>
<li>虚拟机标识符，用于区分不同的虚拟机。</li>
</ul>
</li>
<li>
<p><strong>level[1:0]</strong></p>
<ul>
<li>指示页面的大小。<code>0</code>：<code>4KB</code>，<code>1</code>：<code>2MB</code>，<code>2</code>：<code>1GB</code>，<code>3</code>：<code>512GB</code>。</li>
</ul>
</li>
<li>
<p><strong>ppn[32:0]</strong></p>
<ul>
<li>物理页框号的高 <code>33</code> 位。在 <code>Sv48</code> 要求下本该是 <code>41</code> 位，出于面积考虑优化至 <code>33</code> 位（见支持 <code>Sv48</code> 分页机制部分）。</li>
</ul>
</li>
<li>
<p><strong>ppn_low[2:0]×8</strong></p>
<ul>
<li>物理页框号的低 <code>3</code> 位。用于 <code>TLB</code> 压缩（见支持 <code>TLB</code> 压缩部分）。</li>
</ul>
</li>
<li>
<p><strong>valididx×8</strong></p>
<ul>
<li>指示对应的 <code>ppn_low</code> 是否有效。用于 <code>TLB</code> 压缩，为 <code>0</code> 表示条目无效，即对应物理地址没有存储页表条目。</li>
</ul>
</li>
<li>
<p><strong>pteidx×8</strong></p>
<ul>
<li>指示原始请求对应压缩条目的哪一项。例如 <code>vpn</code> 低三位为 <code>010</code>，那么 <code>pteidx[3]</code> 为 <code>1</code>，其它 <code>7</code> 位为 <code>0</code>。</li>
</ul>
</li>
<li>
<p><strong>s2xlate[1:0]</strong></p>
<ul>
<li>指示是否启用两阶段地址转换。<code>0b00</code>：不启用，<code>0b01</code>：仅使用第一阶段，<code>0b10</code>：仅使用第二阶段，<code>0b11</code>：启用两阶段地址转换。</li>
</ul>
</li>
<li>
<p><strong>perm[5:0]</strong></p>
<ul>
<li>指示主机的权限以及异常信息，包括 <code>pf</code>、<code>af</code>、<code>a</code>、<code>g</code>、<code>u</code>、<code>x</code> 六位。其中 <code>pf</code>（<code>page fault</code>）指示是否发生缺页异常；<code>af</code>（<code>access fault</code>）指示是否发生地址错误等访问错误异常；<code>a</code>（<code>access</code>）指示该表项是否最近被访问过，任何形式的访问（包括读、写、取指）均会将 <code>a</code> 位置 <code>1</code>，用于页面替换算法；<code>g</code>（<code>global</code>）指示该条目指向的页面是否为全局页面；<code>u</code>（<code>user</code>）指示该条目指向的页面是否可以被用户模式访问，<code>u</code> 位为 <code>1</code> 说明可以被 <code>UMode</code> 访问，为 <code>0</code> 说明可以被 <code>SMode</code> 访问；<code>x</code>（执行）指示该条目指向的页面是否可执行，<code>itlb</code> 用于取指的加速，所有取出的条目必须是可执行的。</li>
</ul>
</li>
<li>
<p><strong>g_perm[3:0]</strong></p>
<ul>
<li>指示虚拟机的权限以及异常信息，包括 <code>gpf</code>、<code>gaf</code>、<code>a</code>、<code>x</code> 四位，虚拟机的 <code>g</code> 和 <code>u</code> 两位不单独存储，与主机共用。一般情况下虚拟机对全局页、用户模式的处理与主机相同，而替换策略与访问权限控制可能不同，所以共用了 <code>g</code>、<code>u</code> 而不共用 <code>a</code>、<code>x</code>。<code>gpf</code>（<code>guest page fault</code>）为虚拟机缺页异常，<code>gaf</code>（<code>guest access fault</code>）为虚拟机访问错误异常。</li>
</ul>
</li>
</ul>
<p>香山的 <code>ITLB</code> 采用 <code>48</code> 项全相联的结构，保存全部大小页，共能存储 <code>48</code> 条映射。</p>
<p>在支持 <code>H</code> 扩展的前提下，对于不同的 <code>s2xlate</code> 的状态 <code>TLB</code> 中存储的条目的值代表的意义也会有所区别：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>s2xlate</th>
<th>tag</th>
<th>ppn</th>
<th>perm</th>
<th>g_perm</th>
<th>level</th>
</tr>
</thead>
<tbody>
<tr>
<td>noS2xlate</td>
<td>b00</td>
<td>非虚拟化下的虚拟页号</td>
<td>非虚拟化下的物理页号</td>
<td>非虚拟化下的页表项 perm</td>
<td>不使用</td>
<td>非虚拟化下的页表项 level</td>
</tr>
<tr>
<td>allStage</td>
<td>b11</td>
<td>第一阶段页表的虚拟页号</td>
<td>第二阶段页表的物理页号</td>
<td>第一阶段页表的 perm</td>
<td>第二阶段页表的 perm</td>
<td>两阶段翻译中最大的 level</td>
</tr>
<tr>
<td>onlyStage1</td>
<td>b01</td>
<td>第一阶段页表的虚拟页号</td>
<td>第一阶段页表的物理页号</td>
<td>第一阶段页表的 perm</td>
<td>不使用</td>
<td>第一阶段页表的 level</td>
</tr>
<tr>
<td>onlyStage2</td>
<td>b10</td>
<td>第二阶段页表的虚拟页号</td>
<td>第二阶段页表的物理页号</td>
<td>不使用</td>
<td>第二阶段页表的 perm</td>
<td>第二阶段页表的 level</td>
</tr>
</tbody>
</table>
<p>支持 <code>H</code> 扩展后 <code>TLB</code> 中缓存的条目会有所变化（表中未提及的条目即没有变化）：</p>
<table>
<thead>
<tr>
<th>支持 H 扩展</th>
<th>vmid</th>
<th>s2xlate</th>
<th>g_perm</th>
</tr>
</thead>
<tbody>
<tr>
<td>否</td>
<td>不保存</td>
<td>不保存</td>
<td>不保存</td>
</tr>
<tr>
<td>是</td>
<td>14位</td>
<td>2位</td>
<td>4位</td>
</tr>
</tbody>
</table>
<h2 id="支持保存全部大小页">支持保存全部大小页</h2>
<p>在 <code>RISC-V</code> 架构中，大小页机制旨在优化虚拟内存的使用效率和性能。<code>Sv48</code> 支持多种页面大小，包括 <code>4KB</code>、<code>2MB</code>、<code>1GB</code> 页，在标准的设计中没有定义 <code>512GB</code> 的页，理论上可行，但目前并没有这样的需要，<code>512GB</code> 的页也无法加载进内存，因此标准不做要求。但是出于对完整性的考虑，香山中依然实现了对 <code>512GB</code> 大页的支持。</p>
<p><img alt="Sv48 大小页示意图" src="Sv48%E5%A4%A7%E5%B0%8F%E9%A1%B5%E7%A4%BA%E6%84%8F%E5%9B%BE.png"></p>
<p>在一般的应用程序需求中，<code>4KB</code> 的页面足够满足日常的使用，可以存储较小的数据结构以及程序等，常用于大多数应用程序中。然而，有的程序可能会需要频繁访问大的数据结构或数据集，这时引入大页可以提升内存访问效率。每个大页覆盖的虚拟地址空间更大，可以显著减少页表条目的数量；在映射相同数量的内存时，所需的页表条目会大幅降低，这可以减少内存开销、减少页表查找频率，从而优化内存访问速度，尤其对频繁访问大块内存的应用，能够显著提升性能。大页通常包含连续的数据，可以提高命中率，更有效地利用缓存资源。</p>
<p>当然，由于大页覆盖的地址空间较大，可能导致内存碎片，而未被使用的大页空间无法被其他请求有效利用，也会浪费一定的内存资源。同时，管理不同大小的页面为内存管理带来了额外的复杂性。在混合使用小页和大页时，操作系统需要复杂的算法来优化内存分配和使用。现代操作系统通常采用混合使用大小页的模式以满足不同应用的不同需求。</p>
<p>在香山的 <code>TLB</code> 中，支持保存任意大小的页面，这是通过保存页面的 <code>level</code> 来实现的。根据不同的 <code>level</code>，可以决定最终生成物理地址的方法（<code>index</code> 为页内偏移，来源于 <code>vaddr</code> 的低 <code>12</code> 位；<code>ppn</code>、<code>ppn_low</code>、<code>tag</code> 来源于 <code>TLB</code> 中存储的映射条目）：</p>
<table>
<thead>
<tr>
<th>level</th>
<th>页面大小</th>
<th>paddr[47:0]</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>4KB</td>
<td>ppn[32:0] + ppn_low[2:0] + index[11:0]</td>
</tr>
<tr>
<td>1</td>
<td>2MB</td>
<td>ppn[32:6] + tag[8:0] + index[11:0]</td>
</tr>
<tr>
<td>2</td>
<td>1GB</td>
<td>ppn[32:15] + tag[17:0] + index[11:0]</td>
</tr>
<tr>
<td>3</td>
<td>512GB</td>
<td>ppn[32:24] + tag[26:0] + index[11:0]</td>
</tr>
</tbody>
</table>
<h2 id="支持-tlb-压缩">支持 TLB 压缩</h2>
<p>随着虚拟地址空间的不断扩展，传统 <code>TLB</code> 的大小和效率面临挑战，可能不足以覆盖应用程序的需求，导致频繁的缺失（<code>TLB miss</code>），从而影响系统性能，导致性能瓶颈。为了应对这一问题，<code>TLB</code> 压缩技术应运而生，旨在提高 <code>TLB</code> 的有效性和性能。</p>
<p>在操作系统分配内存的时候，由于使用伙伴地址分配策略等原因，会倾向于将连续的物理页分配给连续的虚拟页。虽然随着程序的不断运行，页分配逐渐的从有序趋向于无序，但是这种页的相连性普遍存在，因此可以通过将多个连续的页表项在 <code>TLB</code> 硬件中合成为一个 <code>TLB</code> 项，以增大 <code>TLB</code> 容量。<code>TLB</code> 压缩通过优化页表结构，支持连续的映射，通过引入范围映射（<code>range mapping</code>）机制，一个 <code>TLB</code> 条目可以映射一段连续的虚拟地址到一段连续的物理地址。</p>
<p>在实际中，以香山昆明湖架构为例，在 <code>TLB</code> 中存储 <code>35</code> 位的 <code>vpn_high</code>（即 <code>tag</code>），剩下的三位用于索引对应的 <code>ppn_low</code>（一共有 <code>8</code> 个所以需要 <code>3</code> 位来索引）。每次匹配中，<code>TLB</code> 用传入的 <code>vaddr[49:15]</code>（高 <code>35</code> 位）与 <code>tag</code> 进行匹配，找到对应的条目，这个条目中可以存储 <code>8</code> 个 <code>PTE</code>，再根据 <code>vaddr[14:12]</code> 找到对应的 <code>ppn_low</code>，之后检查对应的 <code>valididx</code> 是否有效，如果有效说明 <code>hit</code>，将 <code>ppn_low</code> 与 <code>ppn_high</code> 拼接得到 <code>PPN</code>，再与 <code>vaddr[11:0]</code> 拼接得到 <code>paddr</code>。</p>
<p><img alt="香山 TLB 压缩示意图" src="TLB%E5%8E%8B%E7%BC%A9.png"></p>
<p>在支持了 <code>H</code> 扩展后（见支持两阶段虚实地址翻译），<code>TLB</code> 压缩仅在 <code>OnlyStage1</code> 和 <code>noS2xlate</code> 下启用，在其他情况下不启用。</p>
<p>支持 <code>TLB</code> 压缩后 <code>TLB</code> 中缓存的条目会有所变化（表中未提及的条目即没有变化）：</p>
<table>
<thead>
<tr>
<th>是否压缩</th>
<th>tag</th>
<th>ppn</th>
<th>valididx</th>
<th>pteidx</th>
<th>ppn_low</th>
</tr>
</thead>
<tbody>
<tr>
<td>否</td>
<td>38位</td>
<td>36位</td>
<td>不保存</td>
<td>不保存</td>
<td>不保存</td>
</tr>
<tr>
<td>是</td>
<td>35位</td>
<td>33位</td>
<td>8位</td>
<td>8位</td>
<td>8×3位</td>
</tr>
</tbody>
</table>
<p>在支持了大小页的情况下，<code>TLB</code> 压缩在大页情况下（<code>2MB/1GB/512GB</code>）不启用，仅在查询结果为小页（<code>4KB</code>）情况下启用。大页在返回时会将 <code>valididx</code> 的 <code>8</code> 位全部设置为 <code>1</code>，而由于大页的查询过程中只需要 <code>PPN</code> 的高位，大页下不使用 <code>ppn_low</code>，<code>ppn_low</code> 的值在此时是未定义的。</p>
<h2 id="支持-hypervisor-扩展与两阶段虚实地址翻译">支持 Hypervisor 扩展与两阶段虚实地址翻译</h2>
<p>在 <code>RISC-V</code> 特权指令手册中定义了虚实地址的翻译过程：</p>
<ol>
<li>
<p>设 <code>a</code> 为 <code>satp.ppn</code> × <code>PAGESIZE</code>，并设 <code>i = LEVELS - 1</code>。（对于 <code>Sv48</code>，<code>PAGESIZE = 2^{12}</code>，<code>LEVELS = 4</code>）此时，<code>satp</code> 寄存器必须处于活动状态，即有效的特权模式必须是 <code>S</code> 模式或 <code>U</code> 模式。</p>
</li>
<li>
<p>设 <code>pte</code> 为地址 <code>a + va.vpn[i]</code> × <code>PTESIZE</code> 处的 <code>PTE</code> 值。（对于 <code>Sv48</code>，<code>PTESIZE = 8</code>）如果访问 <code>pte</code> 违反了 <code>PMA</code> 或 <code>PMP</code> 检查，则引发与原始访问类型相应的访问错误异常。</p>
</li>
<li>
<p>如果 <code>pte.v = 0</code>，或者 <code>pte.r = 0</code> 且 <code>pte.w = 1</code>，或者 <code>pte</code> 中设置了任何为未来标准使用保留的位或编码，则停止并引发与原始访问类型相应的页面错误异常。</p>
</li>
<li>
<p>否则，<code>PTE</code> 是有效的。如果 <code>pte.r = 1</code> 或 <code>pte.x = 1</code>，则转到步骤 5。否则，此 <code>PTE</code> 是指向下一级页面表的指针。设 <code>i = i - 1</code>。如果 <code>i &lt; 0</code>，则停止并引发与原始访问类型相应的页面错误异常。否则，设 <code>a = pte.ppn</code> × <code>PAGESIZE</code> 并转到步骤 2。</p>
</li>
<li>
<p>找到了叶子 <code>PTE</code>。根据当前特权模式和 <code>mstatus</code> 寄存器的 <code>SUM</code> 和 <code>MXR</code> 字段的值，确定请求的内存访问是否被 <code>pte.r</code>、<code>pte.w</code>、<code>pte.x</code> 和 <code>pte.u</code> 位允许。如果不允许，则停止并引发与原始访问类型相应的页面错误异常。</p>
</li>
<li>
<p>如果 <code>i &gt; 0</code> 且 <code>pte.ppn[i-1 : 0] = 0</code>，则这是一个未对齐的大页；停止并引发与原始访问类型相应的页面错误异常。</p>
</li>
<li>
<p>如果 <code>pte.a = 0</code>，或者如果原始内存访问是存储且 <code>pte.d = 0</code>，则引发与原始访问类型相应的页面错误异常，或者执行以下操作：</p>
<ul>
<li>如果对 <code>pte</code> 的存储将违反 <code>PMA</code> 或 <code>PMP</code> 检查，则引发与原始访问类型相应的访问错误异常。</li>
<li>以原子方式执行以下步骤：
<ul>
<li>比较 <code>pte</code> 与地址 <code>a + va.vpn[i]</code> × <code>PTESIZE</code> 处的 <code>PTE</code> 值。</li>
<li>如果值匹配，将 <code>pte.a</code> 设为 <code>1</code>，并且如果原始内存访问是存储，还将 <code>pte.d</code> 设为 <code>1</code>。</li>
<li>如果比较失败，返回步骤 2。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>翻译成功。翻译后的物理地址如下：</p>
<ul>
<li><code>pa.pgoff = va.pgoff</code>。</li>
<li>如果 <code>i &gt; 0</code>，则这是一个大页翻译，且 <code>pa.ppn[i - 1 : 0] = va.vpn[i - 1 : 0]</code>。</li>
<li><code>pa.ppn[LEVELS - 1 : i] = pte.ppn[LEVELS - 1 : i]</code>。</li>
</ul>
</li>
</ol>
<p>在一般的虚实地址翻译过程中，将按照如上所述的过程进行转换，由 satp 寄存器控制进行地址翻译。其中，前端取指通过 <code>ITLB</code> 进行地址翻译，后端访存通过 <code>DTLB</code> 进行地址翻译。<code>ITLB</code> 和 <code>DTLB</code> 如果 <code>miss</code>，会通过 <code>Repeater</code> 向 <code>L2TLB</code> 发送请求。在目前设计中，前端取指和后端访存对 <code>TLB</code> 均采用非阻塞式访问，即一个请求 <code>miss</code> 后，会将请求 <code>miss</code> 的信息返回，请求来源调度重新发送 <code>TLB</code> 查询请求，直至命中。也就是说，<code>TLB</code> 本体是非阻塞的，可以向它连续发送请求，无论结果都可以在下一拍发送任意的请求，但是总体上由于前端的调度，体现为阻塞访问。</p>
<p>在支持了 <code>H</code> 扩展的前提下，香山的虚拟化地址翻译过程会经历两个阶段的地址转换，可以将它划分为 <code>VS</code> 阶段和 <code>G</code> 阶段。<code>VS</code> 阶段的地址转换由 <code>vsatp</code> 寄存器控制，其实与主机的 <code>satp</code> 寄存器非常相似。</p>
<p><img alt="VS 阶段：GVA 至 GPA" src="GVA-GPA.png"></p>
<p>页表项（<code>PTE</code>）的长度为 <code>64 bit</code>，也即每个 <code>4KB</code> 的页面可以存储 $2^9$ 个 <code>PTE</code>。在 <code>vsatp</code> 寄存器中存储了第一级页表（即根页表）的物理地址 <code>PPN</code>，通过这个 <code>PPN</code> 可以找到根页表，并根据 <code>GVA</code> 中的 <code>VPN[3]</code> 找到对应页表项 <code>PTE</code>，在 <code>PTE</code> 中存储了指向下一级页表的 <code>PPN</code> 以及权限位等。以此方式通过逐级的查找最终达到叶子 <code>PTE</code> 并得到 <code>PPN</code>，与 <code>offset</code> 合成后得到 <code>GPA</code>。注意这里的 <code>GPA</code> 应当是 <code>50</code> 位的，最后一级的 <code>PPN</code> 应当是 <code>38</code> 位的，这是因为支持 <code>SV48x4</code> 的原因，虚拟机的物理地址被拓宽了两位。这样的拓宽并不难实现，只需要在主机分配虚拟机内存空间的时候分配一个 <code>16KB</code> 的大页作为根页表即可；通过多使用 <code>12KB</code>（本来分配的根页表大小是 <code>4KB</code>）的物理内存就可以实现虚拟机地址空间增大四倍。至于页表项能否放下多了两位的 <code>PPN</code>，观察 <code>PTE</code> 中 <code>PPN</code> 的位数为 <code>44</code> 位，不需要担心这个问题。<code>44</code> 位的 <code>PPN</code> 放 <code>38</code> 位，前六位并没有清零要求，但是是被忽略的。</p>
<p><img alt="G 阶段：GPA 至 HPA" src="GPA-HPA.png"></p>
<p><code>G</code> 阶段的地址翻译则不同，由于支持了 <code>SV48x4</code>，其根页表被扩展为 <code>11</code> 位 <code>16KB</code>，因此需要特别注意 <code>hgatp</code> 寄存器中存储的 <code>PPN</code> 应当对齐 <code>16KB</code> 页，在标准情况下 <code>PPN</code> 的最后两 <code>bit</code> 应当被固定为零，意味着 <code>hgatp</code> 寄存器应当指向一个 <code>16KB</code> 页的起始地址，以避免根页表在不同的小页面内。</p>
<p>在实际的实现中，地址的翻译并不是这样理想化的先查虚拟机的页表得到 <code>GPA</code> 再使用这个 <code>GPA</code> 查主机的页表得到 <code>HPA</code>。事实上的实现中，我们通过虚拟机的页表查到的下一级页表的物理地址是 <code>GPA</code>，并不能通过它访问到下一级页表，每次访问虚拟机的下一级页表都需要进行一次 <code>GPA</code> 到 <code>HPA</code> 的转换。比如此时给定一个 <code>GVA</code>，之后在虚拟机的一级页表（根页表）中根据 <code>GVA[2]</code>（<code>11 bit</code>）查找得到一个 <code>PTE</code>，这个 <code>PTE</code> 存储的是二级页表的 <code>GPA</code>，得到这个 <code>GPA</code> 并不能找到二级页表，因此需要将它转换为 <code>HPA</code>，也就是 <code>G</code> 阶段的地址翻译。依次查找直到找到最终需要的那个 <code>HPA</code>，共需要经历五次 <code>G</code> 阶段地址翻译，才能得到最终的 <code>HPA</code>。</p>
<p><img alt="香山昆明湖架构 TLB 两阶段地址翻译过程" src="%E9%A6%99%E5%B1%B1%E5%9C%B0%E5%9D%80%E7%BF%BB%E8%AF%91%E8%BF%87%E7%A8%8B.png"></p>
<h2 id="支持阻塞式与非阻塞式访问">支持阻塞式与非阻塞式访问</h2>
<p>阻塞式访问代表着 <code>TLB</code> 的端口同时仅支持一个请求，阻塞端口带 <code>valid-ready</code> 握手信号。在 <code>TLB</code> 准备好接收请求时，会将 <code>ready</code> 置 <code>1</code>，由外部检测到 <code>ready</code> 后会发送请求。请求到达 <code>TLB</code> 时 <code>valid</code> 为 <code>1</code> 则 <code>TLB</code> 接收请求并将 <code>ready</code> 置 <code>0</code>，不再接受新的请求。之后 <code>TLB</code> 会对请求进行匹配，查找结果，如果 <code>miss</code> 则发送 <code>ptw</code> 请求（同样为阻塞），等待直到 <code>ptw</code> 返回结果（物理地址或 <code>pf</code> 异常），然后 <code>TLB</code> 将结果保存并上报给请求方，再将 <code>ready</code> 置 <code>1</code>。</p>
<p>对于非阻塞式请求，仅带 <code>valid</code> 信号，每当 <code>valid</code> 置 <code>1</code>，<code>TLB</code> 即接受请求并在下一拍返回结果（<code>hit/miss/异常</code>），无论是否命中都能在请求下一拍得到结果。如果 <code>miss</code> 的话，<code>TLB</code> 在返回 <code>miss</code> 结果同时会发起 <code>PTW</code> 请求（非阻塞），<code>PTW</code> 接收到请求则进行处理，在处理完成后回填进 <code>TLB</code> 中，然后如果请求方再次发起请求就可以命中。在香山 <code>ITLB</code> 的具体实现中，<code>TLB</code> 本体虽然是非阻塞的，不存储请求的信息，但当前端发起的取指请求 <code>miss</code> 后，将会由前端进行调度不断发起相同取指请求直到 <code>hit</code>，才能将指令送到处理器进行处理，因此会体现出阻塞的效果。</p>
<table>
<thead>
<tr>
<th>请求来源</th>
<th>iCache</th>
<th>IFU</th>
</tr>
</thead>
<tbody>
<tr>
<td>请求数量</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>请求类型</td>
<td>非阻塞请求</td>
<td>阻塞请求</td>
</tr>
<tr>
<td>握手信号</td>
<td>仅带 valid 信号</td>
<td>带 valid 和 ready 信号</td>
</tr>
<tr>
<td>处理方式</td>
<td>可以继续处理其他指令</td>
<td>等待 iTLB 响应后继续处理指令</td>
</tr>
</tbody>
</table>
<h2 id="支持读取-ptw-返回条目">支持读取 PTW 返回条目</h2>
<p>每次 <code>TLB</code> 发生 <code>miss</code> 之后，会向 <code>L2TLB</code> 发送 <code>Page Table Walk</code> 请求。由于 <code>TLB</code> 与 <code>L2TLB</code> 之间有比较长的物理距离，需要在中间加拍，这项工作由 <code>repeator</code> 完成。同时，<code>repeator</code> 还需要对 <code>PTW</code> 请求进行过滤，以避免 <code>TLB</code> 中出现重复项，因此也被称为 <code>filter</code>。目前香山中 <code>TLB</code> 发出的 <code>PTW</code> 请求的内容包含 <code>VPN</code>、<code>s2xlate</code>、<code>getGPA</code> 三个信号以及必要的控制信号：</p>
<ul>
<li>
<p><strong>VPN</strong>：</p>
<ul>
<li>虚拟页框号，<code>TLB</code> 在 <code>miss</code> 之后会将 <code>VPN</code> 发送给 <code>PTW</code> 用于索引对应的物理页，<code>PTW</code> 会将叶子页表的 <code>PPN</code> 返回给 <code>TLB</code>，下次 <code>TLB</code> 查询的时候就可以找到该页并可以通过页内偏移找到物理地址。</li>
</ul>
</li>
<li>
<p><strong>s2xlate</strong>：</p>
<ul>
<li>两阶段地址转换标志，指示当前的两阶段地址转换模式。<code>TLB</code> 中该标志将通过 <code>vsatp</code> 与 <code>hgatp</code> 寄存器的 <code>mode</code> 域进行判断：</li>
</ul>
<table>
<thead>
<tr>
<th>s2xlate</th>
<th>vsatp.mode</th>
<th>hgatp.mode</th>
</tr>
</thead>
<tbody>
<tr>
<td>0b00</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>0b01</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>0b10</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>0b11</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>getGPA</strong>：</p>
<ul>
<li>指示当前 <code>PTW</code> 请求是否为请求客户机物理地址。用于客户机缺页等情况的处理（详见支持发生 <code>GPF</code> 时重新发起请求部分）。</li>
</ul>
</li>
</ul>
<p>在支持了 <code>TLB</code> 压缩后，<code>PTW</code> 返回的结果主要包括 <code>resp_valid</code>、<code>tag[33:0]</code>、<code>asid[15:0]</code>、<code>perm[6:0]</code>、<code>level[1:0]</code>、<code>ppn[35:0]</code>、<code>addr_low[2:0]</code>、<code>ppn_low[2:0]</code> × <code>8</code>、<code>valididx</code> × <code>8</code>、<code>pteidx</code> × <code>8</code>、<code>pf</code>、<code>af</code>（各个信号的含义可见支持缓存映射条目部分）。<code>TLB</code> 接收到有效的 <code>PTW resp</code> 后即将这些条目存进自己的缓存中。</p>
<p>在支持了 <code>H</code> 扩展后，<code>TLB</code> 压缩仅在 <code>noS2xlate</code> 和 <code>onlyStage1</code> 时启用，需要添加 <code>s2xlate</code> 信号指示两阶段地址转换的类型，并分开返回 <code>s1</code> 和 <code>s2</code>。其中，<code>s1</code> 阶段可以与之前的主机地址转换合并，在主机地址转换中，<code>s1</code> 添加的部分信号以及位宽不适用，添加或扩充的信号如下所示：</p>
<table>
<thead>
<tr>
<th>支持 H 扩展</th>
<th>s2xlate[1:0]</th>
<th>tag</th>
<th>vmid[13:0]</th>
<th>ppn</th>
<th>s2</th>
<th>getGPA</th>
</tr>
</thead>
<tbody>
<tr>
<td>否</td>
<td>无</td>
<td>[32:0]</td>
<td>无</td>
<td>[32:0]</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>是</td>
<td>有</td>
<td>[34:0]</td>
<td>有</td>
<td>[40:0]</td>
<td>有</td>
<td>有</td>
</tr>
</tbody>
</table>
<p>其中，<code>tag</code> 扩充的两位是由于虚拟机采用 <code>Sv48x4</code>，将 <code>hypervisor</code> 下的虚拟地址从 <code>48</code> 位扩充为 <code>50</code> 位，因此 <code>tag</code> 相应需要多两位。<code>vmid</code> 指示虚拟机号。<code>ppn</code> 多的 <code>8</code> 位是因为主机采用 <code>48</code> 位物理地址，而第一阶段转换出来的虚拟机物理地址为 <code>56</code> 位（在进入下一阶段时要求前 <code>6</code> 位是 <code>0</code>，变为 <code>50</code> 位），<code>getGPA</code> 可见后面支持发生 <code>GPF</code> 时重新发起请求部分。</p>
<p><code>s2</code> 部分用于第二阶段地址转换，即从虚拟机物理地址到主机物理地址的转换，此时 <code>asid</code> 无效，<code>resp</code> 的信号包括 <code>tag[37:0]</code>、<code>vmid[13:0]</code>、<code>ppn[37:0]</code>、<code>perm[6:0]</code>、<code>level</code>、<code>gpf</code>、<code>gaf</code>。由于不考虑 <code>TLB</code> 压缩，<code>tag</code> 即为 <code>38</code> 位，来自 <code>50</code> 位虚拟地址的高 <code>38</code> 位。值得注意，在目前的香山昆明湖架构中，这里的 <code>ppn</code> 有效的位数仅有后 <code>36</code> 位，之所以 <code>ppn</code> 位宽为 <code>38</code> 位是出于优化的需要，香山 <code>TLB</code> 中通过 <code>readResult</code> 方法从 <code>PTW</code> 中读取信息，<code>s1</code>、<code>s2</code> 阶段复用了 <code>readResult</code> 方法，由于在 <code>s1</code> 阶段的需要用到 <code>50</code> 位的物理地址，<code>readResult.ppn</code> 被定义为 <code>38</code> 位，以至于在 <code>verilog</code> 文件中传入 <code>s2.ppn</code> 时也需要额外多传 <code>2</code> 位，事实上这两位仅仅传进 <code>TLB</code> 中而不起作用，可以忽略。</p>
<table>
<thead>
<tr>
<th>支持 H 扩展</th>
<th>s2_tag[37:0]</th>
<th>s2_vmid[14:0]</th>
<th>s2_ppn[37:0]</th>
<th>s2_perm[6:0]</th>
<th>s2_level[1:0]</th>
<th>gpf</th>
<th>gaf</th>
</tr>
</thead>
<tbody>
<tr>
<td>否</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>是</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
</tbody>
</table>
<p>添加了 <code>H</code> 拓展后的 <code>MMU</code>，<code>PTW</code> 返回的结构分为三部分，第一部分 <code>s1</code> 是原先设计中的 <code>PtwSec-torResp</code>，存储第一阶段翻译的页表，第二部分 <code>s2</code> 是 <code>HptwResp</code>，存储第二阶段翻译的页表，第三部分是 <code>s2xlate</code>，代表这次 <code>resp</code> 的类型，仍然分为 <code>noS2xlate</code>、<code>allStage</code>、<code>onlyStage1</code> 和 <code>onlyStage2</code>。如下图。其中 <code>PtwSectorEntry</code> 是采用了 <code>TLB</code> 压缩技术的 <code>PtwEntry</code>。</p>
<p><img alt="PTW resp 结构示意图" src="PTW_resp%E7%BB%93%E6%9E%84%E7%A4%BA%E6%84%8F.png"></p>
<h2 id="支持回填条目与两阶段条目融合">支持回填条目与两阶段条目融合</h2>
<p>参照支持缓存映射条目与支持读取 <code>PTW</code> 返回条目，对于主机地址转换（<code>nos2xlate</code>）的情况对应填入 <code>entry</code> 中的对应表项即可，此时访客有关信号无效。注意大页时，即 <code>level</code> 不为 <code>0</code> 时，<code>ppn_low</code> 无效。</p>
<table>
<thead>
<tr>
<th>TLB entry</th>
<th>填入的来自 PTW 的信号</th>
</tr>
</thead>
<tbody>
<tr>
<td>s2xlate[1:0]</td>
<td>0b00 (nos2xlate)</td>
</tr>
<tr>
<td>tag[34:0]</td>
<td>s1.tag[34:0]</td>
</tr>
<tr>
<td>asid[15:0]</td>
<td>s1.asid[15:0]</td>
</tr>
<tr>
<td>vmid[13:0]</td>
<td>无效</td>
</tr>
<tr>
<td>level[1:0]</td>
<td>s1.level[1:0]</td>
</tr>
<tr>
<td>ppn[32:0]</td>
<td>s1.ppn[32:0]</td>
</tr>
<tr>
<td>ppn_low[2:0]×8</td>
<td>s1.ppn_low_*</td>
</tr>
<tr>
<td>valididx×8</td>
<td>s1.valididx_*</td>
</tr>
<tr>
<td>pteidx×8</td>
<td>s1.pteidx_*</td>
</tr>
<tr>
<td>perm_pf</td>
<td>s1.pf</td>
</tr>
<tr>
<td>perm_af</td>
<td>s1.af</td>
</tr>
<tr>
<td>perm_a</td>
<td>s1.perm.a</td>
</tr>
<tr>
<td>perm_g</td>
<td>s1.perm.g</td>
</tr>
<tr>
<td>perm_u</td>
<td>s1.perm.u</td>
</tr>
<tr>
<td>perm_x</td>
<td>s1.perm.x</td>
</tr>
<tr>
<td>gperm_gpf</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_gaf</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_a</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_x</td>
<td>无效</td>
</tr>
<tr>
<td><em>s2xlate=0b00 时填入 TLB entry 示意表</em></td>
<td></td>
</tr>
</tbody>
</table>
<p>在 <code>OnlyStage1</code> 的情况下，主机的异常信号以及部分不可复用的权限位无效，其余均与主机地址转换一致。</p>
<table>
<thead>
<tr>
<th>TLB entry</th>
<th>填入的来自 PTW 的信号</th>
</tr>
</thead>
<tbody>
<tr>
<td>s2xlate[1:0]</td>
<td>0b01 (OnlyStage1)</td>
</tr>
<tr>
<td>tag[34:0]</td>
<td>s1.tag[34:0]</td>
</tr>
<tr>
<td>asid[15:0]</td>
<td>s1.asid[15:0]</td>
</tr>
<tr>
<td>vmid[13:0]</td>
<td>s1.vmid[13:0]</td>
</tr>
<tr>
<td>level[1:0]</td>
<td>s1.level[1:0]</td>
</tr>
<tr>
<td>ppn[32:0]</td>
<td>s1.ppn[32:0]</td>
</tr>
<tr>
<td>ppn_low[2:0]×8</td>
<td>s1.ppn_low_*</td>
</tr>
<tr>
<td>valididx×8</td>
<td>s1.valididx_*</td>
</tr>
<tr>
<td>pteidx×8</td>
<td>s1.pteidx_*</td>
</tr>
<tr>
<td>perm_pf</td>
<td>s1.pf</td>
</tr>
<tr>
<td>perm_af</td>
<td>s1.af</td>
</tr>
<tr>
<td>perm_a</td>
<td>s1.perm.a</td>
</tr>
<tr>
<td>perm_g</td>
<td>s1.perm.g</td>
</tr>
<tr>
<td>perm_u</td>
<td>s1.perm.u</td>
</tr>
<tr>
<td>perm_x</td>
<td>s1.perm.x</td>
</tr>
<tr>
<td>gperm_gpf</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_gaf</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_a</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_x</td>
<td>无效</td>
</tr>
<tr>
<td><em>s2xlate=0b01 时填入 TLB entry 示意表</em></td>
<td></td>
</tr>
</tbody>
</table>
<p>对于 <code>OnlyStage2</code> 的情况，<code>asid</code> 无效，<code>vmid</code> 使用 <code>s1.vmid</code>（由于 <code>PTW</code> 模块无论什么情况都会填写这个字段，所以可以直接使用这个字段写入），<code>pteidx</code> 根据 <code>s2</code> 的 <code>tag</code> 的低 <code>3</code> 位来确定。如果 <code>s2</code> 是大页，那么 <code>TLB</code> 项的 <code>valididx</code> 均为有效，否则 <code>TLB</code> 项的 <code>pteidx</code> 对应 <code>valididx</code> 有效。<code>ppn</code> 的填写复用了 <code>allStage</code> 的逻辑，将在 <code>allStage</code> 的情况下介绍。</p>
<table>
<thead>
<tr>
<th>TLB entry</th>
<th>填入的来自 PTW 的信号</th>
</tr>
</thead>
<tbody>
<tr>
<td>s2xlate[1:0]</td>
<td>0b10 (OnlyStage2)</td>
</tr>
<tr>
<td>tag[34:0]</td>
<td>s2.tag[37:3]</td>
</tr>
<tr>
<td>asid[15:0]</td>
<td>无效</td>
</tr>
<tr>
<td>vmid[13:0]</td>
<td>s1.vmid[13:0]</td>
</tr>
<tr>
<td>level[1:0]</td>
<td>s2.level[1:0]</td>
</tr>
<tr>
<td>ppn[32:0]</td>
<td>s2.ppn[35:3]</td>
</tr>
<tr>
<td>ppn_low[2:0]×8</td>
<td>{ s2.ppn[2:0], 无效×7 }</td>
</tr>
<tr>
<td>valididx×8</td>
<td>{ 1， 0×7 }</td>
</tr>
<tr>
<td>pteidx×8</td>
<td>s2.tag[2:0]</td>
</tr>
<tr>
<td>perm_pf</td>
<td>无效</td>
</tr>
<tr>
<td>perm_af</td>
<td>无效</td>
</tr>
<tr>
<td>perm_a</td>
<td>无效</td>
</tr>
<tr>
<td>perm_g</td>
<td>无效</td>
</tr>
<tr>
<td>perm_u</td>
<td>无效</td>
</tr>
<tr>
<td>perm_x</td>
<td>无效</td>
</tr>
<tr>
<td>gperm_gpf</td>
<td>s2.gpf</td>
</tr>
<tr>
<td>gperm_gaf</td>
<td>s2.gaf</td>
</tr>
<tr>
<td>gperm_a</td>
<td>s2.perm.a</td>
</tr>
<tr>
<td>gperm_x</td>
<td>s2.perm.x</td>
</tr>
<tr>
<td><em>s2xlate=0b10 时填入 TLB entry 示意表</em></td>
<td></td>
</tr>
</tbody>
</table>
<p>如果两阶段地址转换均启用，<code>TLB</code> 将两阶段的结果合并存储，并丢弃中间物理地址（<code>s1</code> 阶段的 <code>ppn</code>），仅存储最终物理地址。<code>level</code> 需要取 <code>s1.level</code> 与 <code>s2.level</code> 中的较大值，此时需要注意，当 <code>s1</code> 阶段为大页，而 <code>s2</code> 阶段为小页的情况下，例如中间物理地址指向一个 <code>2MB</code> 页，而 <code>s2</code> 阶段转换的结果却是一个 <code>4KB</code> 页，在这种情况下，需要特殊处理，将 <code>s1.tag</code> 的高位（在此例子中为高 <code>11+9+9=29</code> 位）和 <code>s2.tag</code> 的低位（在此例子中为低 <code>9</code> 位）共 <code>38</code> 位合并存储到 <code>tag</code> 与 <code>pteidx</code> 中，如果不足 <code>38</code> 位则在后面补 <code>0</code>（例如中间物理地址指向 <code>1GB</code> 页而 <code>s2</code> 阶段指向 <code>2MB</code> 页，此时 <code>tag[34:0] = {s1.tag[34:15], s2.tag[17:9], 6'b0}</code>）。在这种情况（<code>s1</code> 大页 <code>s2</code> 小页）下 <code>ppn</code> 也需要处理后存储，根据 <code>s2.level</code> 将 <code>s2.ppn</code> 与 <code>s2.tag</code> 进行拼接后存储。</p>
<table>
<thead>
<tr>
<th>TLB entry</th>
<th>填入的来自 PTW 的信号</th>
</tr>
</thead>
<tbody>
<tr>
<td>s2xlate[1:0]</td>
<td>0b11 (allStage)</td>
</tr>
<tr>
<td>tag[34:0]</td>
<td>根据策略选择 s1.tag/s2.tag 的部分位</td>
</tr>
<tr>
<td>asid[15:0]</td>
<td>s1.asid</td>
</tr>
<tr>
<td>vmid[13:0]</td>
<td>s1.vmid</td>
</tr>
<tr>
<td>level[1:0]</td>
<td>s1.level 与 s2.level 的较大者</td>
</tr>
<tr>
<td>ppn[32:0]</td>
<td>s2.ppn 与 s2.tag 根据 s2.level 的拼接的高位</td>
</tr>
<tr>
<td>ppn_low[2:0]×8</td>
<td>s2.ppn 与 s2.tag 根据 s2.level 的拼接的低位</td>
</tr>
<tr>
<td>valididx×8</td>
<td>根据 level 确定</td>
</tr>
<tr>
<td>pteidx×8</td>
<td>tag 的低位</td>
</tr>
<tr>
<td>perm_pf</td>
<td>s1.pf</td>
</tr>
<tr>
<td>perm_af</td>
<td>s1.af</td>
</tr>
<tr>
<td>perm_a</td>
<td>s1.perm.a</td>
</tr>
<tr>
<td>perm_g</td>
<td>s1.perm.g</td>
</tr>
<tr>
<td>perm_u</td>
<td>s1.perm.u</td>
</tr>
<tr>
<td>perm_x</td>
<td>s1.perm.x</td>
</tr>
<tr>
<td>gperm_gpf</td>
<td>s2.gpf</td>
</tr>
<tr>
<td>gperm_gaf</td>
<td>s2.gaf</td>
</tr>
<tr>
<td>gperm_a</td>
<td>s2.perm.a</td>
</tr>
<tr>
<td>gperm_x</td>
<td>s2.perm.x</td>
</tr>
<tr>
<td><em>s2xlate=0b11 时填入 TLB entry 示意表</em></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="支持发生-gpf-时重新发起-ptw-请求">支持发生 GPF 时重新发起 PTW 请求</h2>
<p>在香山的 <code>TLB</code> 中并不会保存中间物理地址。在两阶段地址转换过程中，如果第一阶段发生缺页异常，即 <code>PTW</code> 返回 <code>gpf</code>，此时 <code>TLB</code> 将 <code>PTW</code> 返回的结果存入 <code>TLB</code> 项内，请求方再次请求的时候发现 <code>gpf</code>，此时 <code>TLB</code> 会返回 <code>miss</code>，即使已经存储了这个映射。同时，<code>TLB</code> 将发起带 <code>getGPA</code> 标志的 <code>PTW</code> 请求，请求这个虚拟地址，并维护一组寄存器暂存相关信号：</p>
<table>
<thead>
<tr>
<th>信号</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>need_gpa</td>
<td>表示此时有一个请求正在获取 gpaddr</td>
</tr>
<tr>
<td>need_gpa_robidx</td>
<td>存储请求的 ROB（Reorder Buffer）索引，用于跟踪请求来源，目前未使用</td>
</tr>
<tr>
<td>need_gpa_vpn[37:0]</td>
<td>存储请求的 vpn，即 50 位虚拟地址的高 38 位</td>
</tr>
<tr>
<td>need_gpa_gvpn[43:0]</td>
<td>存储获取的 gpaddr 的 gvpn，虚拟机通过转换得到的 56 位虚拟机物理地址的高 44 位，前六位在第二阶段地址转换中被要求为全 0</td>
</tr>
<tr>
<td>need_gpa_refill</td>
<td>表示该请求的 gpaddr 已经被填入 need_gpa_gvpn</td>
</tr>
</tbody>
</table>
<p>每当 <code>TLB</code> 发起带 <code>getGPA</code> 标志的请求时，就会将 <code>need_gpa</code> 置 <code>1</code>，并将请求的 <code>vpn</code> 填入到 <code>need_gpa_vpn</code> 中，同时将 <code>need_gpa_refill</code> 置 <code>0</code>。当 <code>PTW</code> 返回结果的时候，<code>TLB</code> 将 <code>PTW resp</code> 中的 <code>vpn</code> 提取出来与 <code>need_gpa_vpn</code> 进行比较，判断是否是对之前 <code>getGPA</code> 请求的回应。如果是，那么将 <code>PTW resp</code> 中的 <code>s2 tag</code> 填入到 <code>need_gpa_gvpn</code> 中并将 <code>need_gpa_refill</code> 置 <code>1</code>，表示已经获取到需要的 <code>gvpn</code>。下一次 <code>TLB</code> 接收到相同请求时就可以通过 <code>need_gpa_gvpn</code> 得到 <code>gpaddr</code>，之后 <code>TLB</code> 会将 <code>need_gpa</code> 置 <code>0</code>，但保留其它寄存器，因此下次其它的请求发生 <code>gpf</code> 时也可以再次使用相同的 <code>need_gpa_vpn</code> 找到 <code>paddr</code> 而无需再次发起 <code>PTW</code> 请求。</p>
<p>注意这里的 <code>gvpn</code> 是 <code>44</code> 位的，这是由于客户机采用 <code>56</code> 位物理地址，为了维护 <code>gpaddr</code> 的完整性，所以在这里需要存储 <code>44</code> 位的 <code>gvpn</code>，但是事实上 <code>gvpn</code> 的前 <code>6</code> 位一定会是 <code>0</code>，否则说明第一阶段产生了错误的物理地址，会触发 <code>gpf</code>，在此时需要将错误信息保存在 <code>mtval2/htval</code> 寄存器中，因此需要完整的 <code>gpaddr</code>，正常情况下并不需要。（当发生页面错误时，<code>mtval2</code> 将被填充为生成错误的物理地址，帮助异常处理程序；<code>htval</code> 将被填充为导致异常的虚拟地址，帮助 <code>hypervisor</code> 识别问题）</p>
<p>如果发生了 <code>redirect</code>，即重定向（可能触发了跳转/分支指令等或发生异常），此时之前的指令可能不会再访问 <code>TLB</code>，<code>TLB</code> 需要根据 <code>robidx</code> 跟踪请求来源，有选择性地刷新相关的寄存器（即上表中提到的）。目前香山昆明湖架构中尚未实现，而是通过在需要 <code>redirect</code> 的时候发送 <code>flushPipe</code> 指令来实现的，无论哪一个请求端口被刷新均会导致这些寄存器被刷新。</p>
<p><code>getGPA</code> 标志并不用于判断指令是否是请求 <code>gpaddr</code>，<code>PTW</code> 不需要关心请求是干什么的，只需要负责查找并返回结果；<code>TLB</code> 内会通过一系列寄存器的比较来判断。这个信号的作用在于防止 <code>TLB</code> 重填，每次 <code>TLB</code> 发送带 <code>getGPA</code> 标志的请求时，<code>PTW</code> 在返回时会将 <code>getGPA</code> 信号传递回 <code>TLB</code>，从而使 <code>TLB</code> 不进行重填，不存储此项 <code>gpaddr</code>。</p>
<h2 id="支持-plru-替换算法">支持 PLRU 替换算法</h2>
<p><code>LRU</code>（<code>Least Recently Used</code>）算法核心思想就是替换掉最近最少使用的页，也就是最长时间没有访问的页。<code>LRU</code> 算法将内存中的每个页组织成了一个链表的形式，如图所示：</p>
<p><img alt="LRU 算法示意图" src="LRU%E7%AE%97%E6%B3%95.png"></p>
<p>链表有两端，一端是最近最少使用的页，可以称为 <code>LRU</code> 端，另一端是最近刚刚使用的页，即最近使用最频繁的页，称之为 <code>MRU</code>（<code>Most Recently Used</code>）端。每次访问的时候如果命中，那么就将命中的页移动到 <code>MRU</code> 端，如果 <code>miss</code> 则触发缺页，此时需要加载页面。如果这时候内存已满，那么就需要进行页面替换，选择 <code>LRU</code> 端的页进行替换，并把新访问的页放在 <code>MRU</code> 端。这就是 <code>LRU</code> 替换算法，是 <code>cache</code> 替换的经典算法。</p>
<p>但是由于 <code>LRU</code> 需要为 <code>cache</code> 行维护一个链表数据结构，在多路组相联的 <code>cache</code> 行中需要为每一路配置链表并跟踪每一行的使用时间，<code>LRU</code> 算法有着巨大的开销。因此虽然 <code>LRU</code> 在页面替换中表现出色，也依然不常使用。</p>
<p>在香山的昆明湖架构中，<code>TLB</code> 采用 <code>PLRU</code>（<code>pseudo-LRU</code>）替换算法，详细来说是 <code>tree-based PLRU</code> 算法。假设当前 <code>Cache</code> 是 <code>n</code> 路组相联（<code>n</code> 一般是 <code>2</code> 的整数幂）的结构，那么需要定义 <code>n-1</code> 位用来进行二叉树索引，假设为 <code>0</code> 表示左，为 <code>1</code> 表示右，如图所示：</p>
<p><img alt="PLRU 二叉索引示意图" src="PLRU%E7%B4%A2%E5%BC%95.png"></p>
<p>对目前的香山昆明湖架构来说，采用每路 <code>48 cache</code> 行的二路组相联结构下，<code>PLRU</code> 需要维护一个 <code>48</code> 项的链表和一个一级的二叉树（<code>1</code> 位），而采用 <code>LRU</code> 将需要维护一个 <code>48</code> 项的链表和 <code>48</code> 个 <code>2</code> 项的链表，有一定的开销优势，随着路数的增加，优势会更加明显；同时，对二叉树的维护成本也比链表更低。</p>
<p>当然，<code>PLRU</code> 多级二叉树的选择策略下并不能做到与 <code>LRU</code> 一样精确控制，每次二分地排除掉一半不一定能找到绝对 <code>LRU</code> 的条目。</p>
<h2 id="支持-sfencevma-指令">支持 SFENCE.VMA 指令</h2>
<p><code>SFENCE.VMA</code> 指令（<code>Supervisor Memory-Management Fence Instruction</code>）是定义在 <code>RISC-V</code> 指令架构的指令：</p>
<p><img alt="SFECE.VMA 指令" src="SFENCE_VMA.png"></p>
<p>在内存管理中，页表负责将虚拟地址映射到物理地址。当修改了页表后，这些修改不会自动在处理器的缓存中生效。为了确保后续的指令能使用更新后的页表，必须通过 <code>SFENCE.VMA</code> 指令来刷新这些缓存。此外，处理器在执行指令时，可能隐式地对内存管理数据结构进行读取和写入操作，但这些隐式操作和显式的内存操作通常是无序的。<code>SFENCE.VMA</code> 指令可以强制处理器将某些隐式操作在显式操作之前完成，从而确保操作的顺序性。</p>
<p><code>SFENCE.VMA</code> 是 <code>RISC-V</code> 架构中的一条特权指令，用于刷新与地址翻译相关的本地硬件缓存，处理内存管理数据结构的同步，特别是当需要确保对这些数据结构的修改在不同的硬件组件之间保持一致时需要频繁使用该指令。<code>SFENCE.VMA</code> 只影响本地核心（<code>hart</code>），如果需要在多个核心之间同步，则需要核间中断等额外机制。虽然 <code>SFENCE.VMA</code> 指令对于维护一致性至关重要，但频繁调用可能会影响系统性能，因此，应根据实际需要合理使用，以平衡一致性和性能之间的关系。</p>
<p><code>SFENCE.VMA</code> 的行为依赖于 <code>rs1</code> 和 <code>rs2</code>，在 <code>RISC-V</code> 特权指令集中如下所述：</p>
<table>
<thead>
<tr>
<th>条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>- 如果 <code>rs1=x0</code> 且 <code>rs2=x0</code>，栅栏会对所有地址空间的页面表的所有读写进行排序，并将所有地址翻译缓存条目标记为 invalid。</td>
</tr>
<tr>
<td>- 如果 <code>rs1=x0</code> 且 <code>rs2</code> 不是 <code>x0</code>，栅栏会对指定的地址空间的页面表的所有读写进行排序，但不对全局映射进行排序。它还会失效与指定地址空间匹配的地址翻译缓存条目，但不包括全局映射的条目。</td>
</tr>
<tr>
<td>- 如果 <code>rs1</code> 不是 <code>x0</code> 且 <code>rs2=x0</code>，栅栏会对所有地址空间的与 <code>rs1</code> 对应的虚拟地址的叶子页面表条目的读写进行排序，并失效包含该虚拟地址的所有叶子页面表条目的地址翻译缓存条目。</td>
</tr>
<tr>
<td>- 如果 <code>rs1</code> 不是 <code>x0</code> 且 <code>rs2</code> 不是 <code>x0</code>，栅栏会对与 <code>rs1</code> 对应的虚拟地址在指定地址空间的叶子页面表条目的读写进行排序，并失效与 <code>rs1</code> 对应的虚拟地址并匹配指定地址空间的所有叶子页面表条目的地址翻译缓存条目，但不包括全局映射的条目。</td>
</tr>
<tr>
<td>- 如果 <code>rs1</code> 中的值不是有效的虚拟地址，则 <code>SFENCE.VMA</code> 指令没有效果，且不会引发异常。</td>
</tr>
<tr>
<td>- 当 <code>rs2=x0</code> 时，<code>rs2</code> 中的值的 <code>SXLEN-1:ASIDMAX</code> 位保留供将来标准使用。在标准扩展定义其用法之前，这些位应由软件置为零并被当前实现忽略。此外，如果 <code>ASIDLEN &lt; ASIDMAX</code>，则实现应忽略 <code>rs2</code> 中值的 <code>ASIDMAX-1:ASIDLEN</code> 位。</td>
</tr>
</tbody>
</table>
<p><code>SFENCE.VMA</code> 指令的作用是确保在执行该指令之前的所有写入操作已经被提交到内存。这意味着 <code>Store Buffer</code> 中的所有未完成写入都会被写入到 <code>DCache</code> 或最终的内存地址中；<code>SFENCE.VMA</code> 发出刷新信号，通知 <code>MMU</code>（内存管理单元）更新 <code>TLB</code>（转换后备缓冲区）等内部状态。这一刷新信号是瞬时的，并且没有返回确认信号。在验证时需要通过再次访问观察是否 <code>miss</code> 的形式来进行，也可以通过分析波形文件观察 <code>TLB</code> 内部寄存器行为。</p>
<table>
<thead>
<tr>
<th>Store Buffer（存储缓冲区）</th>
</tr>
</thead>
<tbody>
<tr>
<td>Store Buffer 用于提高内存写入效率，允许 CPU 在发出写入操作后，立即继续执行后续指令，而不需要等待内存系统确认写入完成。这有助于减少 CPU 的闲置时间，提高指令执行的整体效率。写回时，写入数据首先被放入 Store Buffer，随后，数据会按某种策略写入主内存（如 DCache 或其他存储层级）。Store Buffer 维护写入操作的顺序，但不保证这些写入操作立即反映在内存中。在多核处理器中，Store Buffer 可以帮助降低缓存一致性协议的复杂性。</td>
</tr>
</tbody>
</table>
<h2 id="支持-hfencevvma-与-hfencegvma-指令">支持 HFENCE.VVMA 与 HFENCE.GVMA 指令</h2>
<p>事实上，对 <code>hv</code>（<code>SFENCE Bundle</code> 中的信号，用于刷新第一阶段地址转换的条目）和 <code>hg</code>（<code>SFENCE Bundle</code> 中的信号，用于刷新第二阶段地址转换的条目）信号不为 <code>0</code> 的情况执行的指令并不是 <code>SFENCE.VMA</code>，而是 <code>HFENCE.VVMA</code> 和 <code>HFENCE.GVMA</code>：</p>
<p><img alt="HFENCE.VVMA 与 HFENCE.GVMA" src="HFENCE.png"></p>
<p>这两个指令与 <code>SFENCE.VMA</code> 功能很相似，区别在于 <code>HFENCE.VVMA</code> 适用于由 <code>vsatp</code> 控制的 <code>VS</code> 级别内存管理数据结构；<code>HFENCE.GVMA</code> 适用于由 <code>hgatp</code> 控制的虚拟机监管程序 <code>G</code> 阶段内存管理数据结构。</p>
<p><code>HFENCE.VVMA</code> 仅在 <code>M</code> 模式或 <code>HS</code> 模式生效，类似于暂时进入 <code>VS</code> 模式并执行 <code>SFENCE.VMA</code> 指令，可以保证当前 <code>hart</code> 之前的所有存储操作在后续的隐式读取 <code>VS</code> 级别内存管理数据结构之前都已经排序；注意这里所说的隐式读取指的仅有在 <code>HFENCE.VVMA</code> 之后执行的，并且 <code>hgatp.VMID</code> 与执行 <code>HFENCE.VVMA</code> 相同的时候，简单来说就是仅对当前这一个虚拟机生效。<code>rs1</code> 与 <code>rs2</code> 的功能与 <code>SFENCE.VMA</code> 相同。</p>
<p>对 <code>HFENCE.GVMA</code> 来说，<code>rs1</code> 指定的是客机的物理地址。由于主机采用 <code>SV48</code> 而虚拟机采用 <code>SV48x4</code>，客机物理地址比主机物理地址多两位，因此此时需要将 <code>rs1</code> 对应的客机物理地址右移两位。如果某一个虚拟机的地址翻译模式更改了，也即 <code>hgatp.MODE</code> 对某个 <code>VMID</code> 更改了，则必须使用 <code>HFENCE.GVMA</code> 指令，将 <code>rs1</code> 设为 <code>0</code>，<code>rs2</code> 设为 <code>0</code> 或 <code>VMID</code> 进行刷新。</p>
<p>在香山中，由于 <code>TLB</code> 本身不存储中间物理地址，也即 <code>TLB</code> 并不存储 <code>VS</code> 阶段转换出来的虚拟机物理地址，也无法单独提供 <code>G</code> 阶段地址转换请求。在 <code>TLB</code> 中存储的是两阶段地址翻译的最终结果，因此 <code>HFENCE.VVMA</code> 与 <code>HFENCE.GVMA</code> 在 <code>TLB</code> 中作用相同，均为刷新掉两阶段地址翻译的结果。无论 <code>hv</code> 与 <code>hg</code> 哪一个信号为 <code>1</code> 都将刷新两阶段的条目。</p>
<h2 id="支持-sinval-扩展">支持 SINVAL 扩展</h2>
<p>在 <code>RISC-V</code> 特权指令集中定义了 <code>Svinval</code> 扩展（<code>Supervisor Virtual Address Invalidation</code>），在香山昆明湖架构实现了该扩展。<code>Svinval</code> 扩展的意义在于将 <code>SFENCE.VMA</code> 指令更加细化为 <code>SFENCE.W.INVAL</code>、<code>SINVAL.VMA</code>、<code>SFENCE.INVAL.IR</code> 三条指令（<code>HFENCE.VVMA</code> 和 <code>HFENCE.GVMA</code> 同理）。</p>
<p><code>SINVAL.VMA</code> 指令事实上与 <code>SFENCE.VMA</code> 指令的功能基本一致，只是添加了对 <code>SFENCE.W.INVAL</code> 与 <code>SFENCE.INVAL.IR</code> 两个指令的相互排序，可以理解为需要在两个指令中间进行。<code>SFENCE.W.INVAL</code> 指令用于确保当前 <code>RISC-V hart</code> 可见的任何先前存储在后续由同一个 <code>hart</code> 执行的 <code>SINVAL.VMA</code> 指令之前被重新排序。<code>SFENCE.INVAL.IR</code> 指令确保当前 <code>hart</code> 执行的任何先前 <code>SINVAL.VMA</code> 指令在后续隐式引用内存管理数据结构之前被排序。当由单个 <code>hart</code> 按顺序（不一定连续）执行 <code>SFENCE.W.INVAL</code>、<code>SINVAL.VMA</code> 和 <code>SFENCE.INVAL.IR</code> 时，可以相当于执行了 <code>SFENCE.VMA</code> 指令。</p>
<p><img alt="SINVAL.VMA" src="SINVAL_VMA.png"></p>
<p><img alt="SFENCE.W.INVAL 和 SFENCE.INVAL.IR" src="SFENCE_W_INVAL&INVAL_IR.png"></p>
<h2 id="支持软件更新-ad-位">支持软件更新 A/D 位</h2>
<p><code>A</code> 位（<code>Access</code>）用于指示某一页面是否被访问过。如果处理器对该页面进行任何形式的访问（读/写/取指），则 <code>A</code> 位会被设置为 <code>1</code>。每当 <code>CPU</code> 访问某个页面时，操作系统或硬件会自动将 <code>A</code> 位设置为 <code>1</code>，这种更新通常是硬件支持的，由处理器在地址转换时自动进行。</p>
<p><code>D</code> 位（<code>Dirty</code>）指示页面是否被修改。如果页面在内存中被写入，则 <code>D</code> 位会被设置为 <code>1</code>，表示该页面的内容已被更改。当处理器对页面进行写操作时，通常会自动将 <code>D</code> 位设置为 <code>1</code>，这种更新通常也是由硬件支持的。在页面替换过程中，操作系统会检查 <code>D</code> 位，如果 <code>D</code> 位为 <code>1</code>，操作系统会将页面写回到磁盘，并在写回后清除 <code>D</code> 位，以表示页面已经被保存且不再是“脏”的。</p>
<p>在香山昆明湖架构中，并不支持硬件更新 <code>A/D</code> 位，而是在需要更新的时候通过 <code>Page Fault</code> 通知软件进行页表更新。具体来说，每当处理器访问某一页时检查该页 <code>A</code> 位如果是 <code>0</code>，那么会发生 <code>PF</code>；同样的，每当处理器写入某一页时检查该页的 <code>D</code> 位如果是 <code>0</code>，同样会发生 <code>PF</code>。在软件处理异常后，操作系统会允许处理器再次访问页面，只有在页表得到更新且相关状态位（<code>A</code> 和 <code>D</code> 位）被正确设置后，处理器才能继续进行后续的内存访问。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-805af6e38a4c1680746577e8e7b92b0b">12.2.2.3 - 关键信号说明</h1>
    
	<h2 id="相关-csr-寄存器">相关 CSR 寄存器</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">csr</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Input</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">TlbCsrBundle</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>csr</code>：包含 <code>satp</code>、<code>vsatp</code>、<code>hgatp</code> 三个寄存器的信息以及一些权限信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TlbCsrBundle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">XSBundle</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">satp</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">TlbSatpBundle</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">vsatp</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">TlbSatpBundle</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">hgatp</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">TlbHgatpBundle</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">priv</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bundle</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">mxr</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">vmxr</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">vsum</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">virt</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">spvp</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">imode</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">dmode</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">toPrintable</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Printable</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#4e9a06">&#34;Satp mode:0x${Hexadecimal(satp.mode)} asid:0x${Hexadecimal(satp.asid)} ppn:0x${Hexadecimal(satp.ppn)} &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#4e9a06">&#34;Priv mxr:${priv.mxr} sum:${priv.sum} imode:${priv.imode} dmode:${priv.dmode}&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>TlbCsrBundle</code> 中包含了 <code>satp</code>、<code>vsatp</code>、<code>hgatp</code> 以及 <code>priv</code> 特权标志。其中 <code>satp</code> 与 <code>vsatp</code> 通过 <code>TlbSatpBundle</code> 实现，包括 <code>mode</code>、<code>asid</code>、<code>ppn</code>、<code>changed</code> 以及一个 <code>apply</code> 方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">SatpStruct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">XSBundle</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">mode</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">asid</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">ppn</span>  <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">44.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TlbSatpBundle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">SatpStruct</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">changed</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Todo: remove it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">apply</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">satp_value</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">UInt</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Unit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">require</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">satp_value</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getWidth</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">XLEN</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">sa</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">satp_value</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">asTypeOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">SatpStruct</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mode</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mode</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">asid</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">asid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ppn</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ppn</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">changed</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DataChanged</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">asid</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// when ppn is changed, software need do the flush
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>hgatp</code> 通过 <code>TlbHgatpBundle</code> 实现，区别在于将 <code>asid</code> 替换为 <code>vmid</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HgatpStruct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">XSBundle</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">mode</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">vmid</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">ppn</span>  <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">44.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TlbHgatpBundle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">HgatpStruct</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">changed</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Todo: remove it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">apply</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">hgatp_value</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">UInt</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Unit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">require</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">hgatp_value</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getWidth</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">XLEN</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">sa</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">hgatp_value</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">asTypeOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">HgatpStruct</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mode</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">mode</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">vmid</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vmid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ppn</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ppn</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">changed</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DataChanged</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">sa</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vmid</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// when ppn is changed, software need do the flush
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="satp"><code>SATP</code></h4>
<ul>
<li><code>satp (Supervisor Address Translation and Protection)</code> 用于内核态（<code>Supervisor mode</code>）进行虚拟地址到物理地址的转换管理，通常在非虚拟化环境或作为虚拟机监控程序（<code>VMM</code>）时使用。</li>
<li><code>mode</code>：地址转换模式，控制虚拟地址的转换，位宽为 <code>4</code>。其允许的值包含 <code>0</code>、<code>8</code>、<code>9</code>，如果是其它值应当触发 <code>illegal instruction fault</code>。
<ul>
<li><code>0</code>: <code>Bare</code> 模式，不进行地址转换。</li>
<li><code>8</code>: <code>SV39</code> 模式，使用三级页表支持 <code>39</code> 位虚拟地址空间。</li>
<li><code>9</code>: <code>SV48</code> 模式，使用四级页表支持 <code>48</code> 位虚拟地址空间。</li>
</ul>
</li>
<li><code>asid</code>：地址空间标识符，用于区分不同进程，香山昆明湖架构使用的 <code>SV48</code> 中最大长度为 <code>16</code>。</li>
<li><code>ppn</code>：<code>Page Table Pointer</code>，根页表的物理页框号，其位宽为 <code>44</code> 位，由物理地址右移 <code>12</code> 位得到。</li>
</ul>
<p><img alt="SATP" src="satp.png"></p>
<h4 id="vsatp"><code>VSATP</code></h4>
<ul>
<li><code>vsatp (Virtual Supervisor Address Translation and Protection)</code> 是虚拟机中客体操作系统的地址转换寄存器，提供虚拟机的虚拟地址到中间物理地址（<code>IPA</code>）的转换。</li>
<li><code>mode</code>：页表模式，控制虚拟地址的转换，模式值与 <code>satp</code> 中的类似。</li>
<li><code>asid</code>：虚拟机内地址空间标识符。</li>
<li><code>ppn</code>：虚拟机页表的物理基地址。</li>
</ul>
<p><img alt="VSATP" src="vsatp.png"></p>
<h4 id="hgatp"><code>HGATP</code></h4>
<ul>
<li><code>hgatp (Hypervisor Guest Address Translation and Protection)</code> 是虚拟机监控程序（<code>Hypervisor</code>）的二级地址转换寄存器，用于将虚拟机的中间物理地址（<code>IPA</code>）转换为主机物理地址（<code>HPA</code>）。</li>
<li><code>mode</code>：页表模式，如 <code>SV39x4</code> 或 <code>SV48x4</code>，用于虚拟机的二级地址转换。
<ul>
<li><code>0</code>: <code>Bare</code> 模式，不进行二级地址转换。</li>
<li><code>8</code>: <code>SV39x4</code> 模式，即 <code>39</code> 位虚拟地址空间，允许四倍页表扩展。</li>
<li><code>9</code>: <code>SV48x4</code> 模式，即 <code>48</code> 位虚拟地址空间，允许四倍页表扩展。</li>
</ul>
</li>
<li><code>vmid</code>：虚拟机标识符，区分不同虚拟机。</li>
<li><code>ppn</code>：二级页表的物理基地址。</li>
</ul>
<p><img alt="HGATP" src="hgatp.png"></p>
<p><code>satp</code> 管理主机地址空间的虚拟地址到物理地址的转换，<code>vsatp</code> 用于虚拟机中的虚拟地址到中间物理地址（<code>IPA</code>）的转换，而 <code>hgatp</code> 则负责虚拟机二级地址转换，将 <code>IPA</code> 转换为主机物理地址。</p>
<h4 id="priv"><code>PRIV</code></h4>
<ul>
<li>
<p><strong>mxr</strong> : <code>Bool()</code><br>
机器可执行只读（MXR）位。控制在用户模式下是否允许执行某些在机器层面被标记为只读的页面。</p>
</li>
<li>
<p><strong>sum</strong> : <code>Bool()</code><br>
特权模式可访问用户（SUM）位。控制特权模式下对用户模式地址的访问权限。</p>
</li>
<li>
<p><strong>vmxr</strong> : <code>Bool()</code><br>
虚拟机器可执行只读（<code>VMXR</code>）位。控制虚拟机内的用户是否可以执行只读页面。</p>
</li>
<li>
<p><strong>vsum</strong> : <code>Bool()</code><br>
虚拟特权模式可访问用户（<code>VSUM</code>）位。控制虚拟化环境中特权模式对用户模式地址的访问权限。</p>
</li>
<li>
<p><strong>virt</strong> : <code>Bool()</code><br>
虚拟化状态位。指示当前系统是否处于虚拟化模式。</p>
</li>
<li>
<p><strong>spvp</strong> : <code>UInt(1.W)</code><br>
超级特权虚拟模式（<code>SPVP</code>）。指示当前是否处于虚拟化环境中的超级特权模式。</p>
</li>
<li>
<p><strong>imode</strong> : <code>UInt(2.W)</code><br>
指示当前（<code>ITLB</code>）指令的处理模式：</p>
<ul>
<li><code>0x3</code> : <strong>ModeM</strong>（机器模式）</li>
<li><code>0x2</code> : <strong>ModeH</strong>（虚拟机监控程序模式，已删除）</li>
<li><code>0x1</code> : <strong>ModeS</strong>（特权模式）</li>
<li><code>0x0</code> : <strong>ModeU</strong>（用户模式）</li>
</ul>
</li>
<li>
<p><strong>dmode</strong> : <code>UInt(2.W)</code><br>
指示当前（<code>DTLB</code>）数据的处理模式。</p>
</li>
</ul>
<h4 id="changed"><code>changed</code></h4>
<ul>
<li>用于标志对应 <code>CSR</code> 中的信息是否更改，一旦 <code>Mode</code> 或 <code>Asid</code>（<code>Vmid</code>）更改则必须同步将 <code>changed</code> 置 <code>1</code>，<code>TLB</code> 在检测到 <code>changed</code> 为 <code>1</code> 时将会执行刷新操作，刷新掉旧的 <code>Asid</code>（<code>Vmid</code>）的映射。</li>
</ul>
<h4 id="base_connect">base_connect()</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">base_connect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">sfence</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">SfenceBundle</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">csr</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">TlbCsrBundle</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Unit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sfence</span> <span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#000">sfence</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">csr</span> <span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#000">csr</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// overwrite satp. write satp will cause flushpipe but csr.priv won&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// satp will be delayed several cycles from writing, but csr.priv won&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// so inside mmu, these two signals should be divided
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">base_connect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">sfence</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">SfenceBundle</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">csr</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">TlbCsrBundle</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">satp</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">TlbSatpBundle</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sfence</span> <span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#000">sfence</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">csr</span> <span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#000">csr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">csr</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">satp</span> <span style="color:#204a87;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">satp</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="sfence">sfence</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">sfence</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Input</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">SfenceBundle</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>sfence</code>：用于传入 <code>SfenceBundle</code>，执行 <code>SFENCE</code> 指令刷新 <code>TLB</code> 缓存。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">SfenceBundle</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">XSBundle</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">valid</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">bits</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Bundle</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">rs1</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">rs2</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">addr</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">VAddrBits</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">UInt</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">AsidLength</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#000">W</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// asid or vmid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">flushPipe</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">hv</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">hg</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Bool</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">toPrintable</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Printable</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#4e9a06">&#34;valid:0x${Hexadecimal(valid)} rs1:${bits.rs1} rs2:${bits.rs2} addr:${Hexadecimal(bits.addr)}, flushPipe:${bits.flushPipe}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="valid"><code>valid</code></h4>
<ul>
<li>有效标志信号，指示 <code>SFENCE.VMA</code> 操作的请求是否有效。如果该信号为高（<code>1</code>），表示当前的 <code>SFENCE.VMA</code> 操作需要执行；如果为低（<code>0</code>），则没有操作需要执行。</li>
</ul>
<h4 id="rs1"><code>rs1</code></h4>
<ul>
<li>表示需要使用 <code>SFENCE.VMA</code> 指令中的 <code>rs1</code> 寄存器的值，这个值通过信号 <code>addr</code> 传入，标记了需要刷新的虚拟地址。</li>
<li>当 <code>rs1</code> 为非零时，表示 <code>SFENCE.VMA</code> 只针对该虚拟地址所对应的页表条目进行刷新操作；如果 <code>rs1</code> 为零，则表示刷新所有虚拟地址的映射。</li>
</ul>
<h4 id="rs2"><code>rs2</code></h4>
<ul>
<li>表示需要使用 <code>SFENCE.VMA</code> 指令中的 <code>rs2</code> 寄存器的值，其中存储着需要刷新的 <code>ASID</code>，通过信号 <code>id</code> 传入。</li>
<li>当 <code>rs2</code> 为非零时，表示 <code>SFENCE.VMA</code> 只对指定的 <code>ASID</code> 进行刷新操作；如果 <code>rs2</code> 为零，则表示刷新所有地址空间的映射。这个信号主要用于区分不同进程的地址空间。</li>
</ul>
<h4 id="addr"><code>addr</code></h4>
<ul>
<li>表示 <code>SFENCE.VMA</code> 指令中 <code>rs1</code> 对应的虚拟地址（可能是部分地址）。该信号提供了具体的虚拟地址信息，当 <code>rs1</code> 为非零时，<code>TLB</code> 将使用该地址作为参考，刷新与该地址对应的页表条目。它用于精细控制哪些地址映射需要被刷新。</li>
<li>信号的位宽为 <code>VAddrBits</code>，即虚拟地址的位宽，可见于 \ref{subsec:consts}，大小被定义为 <code>50</code>，其中事实上使用的只有 <code>addr[47:12]</code>，也即四级页表的四级索引部分，用于找到对应虚拟地址的页表项。</li>
</ul>
<h4 id="id"><code>id</code></h4>
<ul>
<li>表示 <code>SFENCE.VMA</code> 操作涉及的地址空间标识符（<code>ASID</code>）。用于指定某个具体的 <code>ASID</code>。它允许在多地址空间的场景下（例如多个进程共享一个处理器），只刷新某个特定进程的地址映射。</li>
<li>信号位宽为 <code>AsidLength</code>，可见于 \ref{subsec:consts}，大小为 <code>16</code>，意味着同时支持 $2^{16}$ 个虚拟地址空间。</li>
</ul>
<h4 id="flushpipe"><code>flushPipe</code></h4>
<ul>
<li>控制是否需要 <strong>清空流水线</strong>。<code>SFENCE.VMA</code> 操作不仅可能涉及刷新 <code>TLB</code>，还可能需要清空流水线以确保所有未完成的指令（可能依赖旧的地址映射）不会继续使用过时的页表映射。这个信号为高时，表示需要清空流水线。</li>
</ul>
<h4 id="hv"><code>hv</code></h4>
<ul>
<li>表示当前指令是否为 <code>HFENCE.VVMA</code>。</li>
</ul>
<h4 id="hg"><code>hg</code></h4>
<ul>
<li>表示当前指令是否为 <code>HFENCE.GVMA</code>。</li>
</ul>
<h2 id="外部传入参数">外部传入参数</h2>
<h4 id="参数说明">参数说明</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TLB</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Width</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">nRespDups</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Block</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Seq</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">Boolean</span><span style="color:#ce5c00;font-weight:bold">],</span> <span style="color:#000">q</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">TLBParameters</span><span style="color:#ce5c00;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">implicit</span> <span style="color:#000">p</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Parameters</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">TlbModule</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">HasCSRConst</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">HasPerfEvents</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Width: Int</code></td>
<td>指示 <code>requestor</code> 的数量</td>
</tr>
<tr>
<td><code>nRespDups: Int = 1</code></td>
<td>需要复制 <code>response</code> 的数目，默认为 <code>1</code>（不复制）</td>
</tr>
<tr>
<td><code>Block: Seq[Boolean]</code></td>
<td>指示每个 <code>requestor</code> 是否被阻塞</td>
</tr>
<tr>
<td><code>q: TLBParameters</code></td>
<td>TLB 使用的参数</td>
</tr>
<tr>
<td><code>p: Parameter</code></td>
<td>全局参数（香山架构参数）</td>
</tr>
</tbody>
</table>
<p>实例化 <code>TLB</code> 时以香山架构的 <code>itlb</code> 为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">itlb</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Module</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">TLB</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">itlbPortNum</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">nRespDups</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">fill</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">PortNumber</span><span style="color:#ce5c00;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">itlbParams</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><ul>
<li>
<p><code>Width</code> 值为 <code>coreParams.itlbParams</code>（实际计算逻辑）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#000">itlbPortNum</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ICacheParameters</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#000">PortNumber</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>  <span style="color:#8f5902;font-style:italic">// Parameters.scala: line 276
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ICacheParameters</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">PortNumber</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>                 <span style="color:#8f5902;font-style:italic">// ICache.scala: line 43
</span></span></span></code></pre></div><p>最终 <code>Width = 3</code></p>
</li>
<li>
<p><code>Block</code> 参数说明：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">fill</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">PortNumber</span><span style="color:#ce5c00;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// 前 2 端口不阻塞，第 3 端口阻塞
</span></span></span></code></pre></div><p>对应 <code>itlb</code> 的三个 <code>requestor</code>：<code>requestor0/1</code> 不阻塞，<code>requestor2</code> 阻塞。</p>
</li>
</ul>
<h2 id="vaddrbits">VAddrBits</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">VAddrBits</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">HasHExtension</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">EnableSv48</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GPAddrBitsSv48x4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GPAddrBitsSv39x4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">EnableSv48</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">VAddrBitsSv48</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">VAddrBitsSv39</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic">// Parameters.scala: line 596~608
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 相关参数定义
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">HasHExtension</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">HasHExtension</span>  <span style="color:#8f5902;font-style:italic">// Parameters.scala: line582
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">HasHExtension</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Boolean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>      <span style="color:#8f5902;font-style:italic">// Parameters.scala: line66
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">EnableSv48</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Boolean</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>         <span style="color:#8f5902;font-style:italic">// Parameters.scala: line91
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 地址位宽定义
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">VAddrBitsSv39</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">39</span>
</span></span><span style="display:flex;"><span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GPAddrBitsSv39x4</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">41</span>
</span></span><span style="display:flex;"><span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">VAddrBitsSv48</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">48</span>
</span></span><span style="display:flex;"><span><span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GPAddrBitsSv48x4</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">50</span>        <span style="color:#8f5902;font-style:italic">// Parameters.scala: line71~74
</span></span></span></code></pre></div><ul>
<li><strong>香山昆明湖架构下的值</strong>：<code>50</code></li>
<li><strong>地址处理逻辑</strong>：
<ul>
<li>主机地址转换时仅使用后 48 位（前两位忽略）</li>
<li>支持虚拟机时，物理地址扩展为 50 位（符合 <code>Sv48x4</code> 规范）</li>
</ul>
</li>
</ul>
<h2 id="asidlength">AsidLength</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsidLength</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">coreParams</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsidLength</span>  <span style="color:#8f5902;font-style:italic">// Parameters.scala: line 619
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">AsidLength</span><span style="color:#204a87;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">Int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16</span>                    <span style="color:#8f5902;font-style:italic">// Parameters.scala: line 79
</span></span></span></code></pre></div><ul>
<li><strong>ASID 位宽</strong>：16 位</li>
<li><strong>作用</strong>：标识地址空间，防止进程/虚拟机虚拟地址冲突</li>
<li><strong>支持规模</strong>：
<ul>
<li>最大 <code>65536</code> 个并发进程（16 位）</li>
<li>虚拟机通过 <code>vmid</code> 标识（14 位，支持 <code>16384</code> 个虚拟机，符合手册要求）</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3961dca1de0386eb884ba104bb9559e">12.2.2.4 - 环境配置</h1>
    
	<h2 id="推荐使用wsl2ubuntu2204gtkwave">推荐使用WSL2+Ubuntu22.04+GTKWave</h2>
<p>我们推荐Windows10/11用户通过WSL2进行开发，在此给出通过此方法进行环境配置的教程集锦，仅供参考。如环境安装过程中出现任何问题，欢迎在QQ群（群号：<b>976081653</b>）中提出，我们将尽力帮助解决。此页面将收集大家提出的所有环境配置相关问题并提供解决方案，欢迎随时向我们提问！</p>
<h2 id="1在windows下安装wsl2ubuntu2204">1、在Windows下安装WSL2（Ubuntu22.04）</h2>
<p>参考资源：</p>
<p>&mdash; 微软官方教程：<a href="https://learn.microsoft.com/zh-cn/windows/wsl/install">如何使用 WSL 在 Windows 上安装 Linux</a></p>
<p>&mdash; 其它资源：<a href="https://blog.csdn.net/HHHBan/article/details/126843786">安装WSL2和Ubuntu22.04版本</a></p>
<h2 id="2打开wsl换源">2、打开WSL，换源</h2>
<p>推荐使用清华源：<a href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/">清华大学开源软件镜像站-Ubuntu软件仓库</a></p>
<h2 id="3配置验证环境">3、配置验证环境</h2>
<p>请参照<a href="https://open-verify.cc/mlvp/docs/quick-start/installer/">开放验证平台学习资源-快速开始-搭建验证环境</a>配置picker环境。</p>
<h2 id="4使用-gtkwave">4、使用 GTKWave</h2>
<p>使用<a href="https://co.ccslab.cn/tips/win-gtkwave/">重庆大学硬件综合设计实验文档-Windows原生GTKWave</a>给出的方法，可以通过在WSL中输入 <code>gtkwave.exe wave.fst</code> 打开在Windows下安装的GTKWave。请注意，gtkwave在使用中需要进入fst文件所在文件夹，否则会出现无法
initialize的情况。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> out
</span></span><span style="display:flex;"><span>gtkwave.exe <span style="color:#ce5c00;font-weight:bold">{</span>test_name<span style="color:#ce5c00;font-weight:bold">}</span>.fst
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ..
</span></span></code></pre></div><h2 id="5使用vscode插件live-server查看验证报告">5、使用VSCode插件Live Server查看验证报告</h2>
<p>成功安装插件Live Server后，打开文件列表，定位到 <code>/out/report/2025*-itlb-doc-*/index.html</code> 右键并选择 <code>Open With Live Server</code>，之后在浏览器中打开提示的端口（默认为<code>//localhost:5500</code>）即可。</p>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-17b3abe13a72e58e8c003d9471432196">12.3 - Backend</h1>
    
	<p>后端模块验证文档</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e69934b02d245d218b0a12e7951955f">12.4 - Mem Block</h1>
    
	<p>访存模块验证文档</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-790523663d2f74755027f36c25d1c322">12.5 - Misc</h1>
    
	<p>其他模块验证文档</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3acd98556bb6e01bccfdb9fe2c4cfdc0">13 - 维护者</h1>
    
	<p>在提交 issue、pull request、discussion 时，如果指定对应模块的 maintainer 能更及时的得到响应。目前已有的维护人员如下（首字母排名）：</p>
<p><strong>验证工具：</strong></p>
<ul>
<li>picker：<a href="https://github.com/Makiras">Makiras</a>, <a href="https://github.com/SFangYy">SFangYy</a>, <a href="https://github.com/yaozhicheng">yaozhicheng</a></li>
<li>toffee/toffe-test：<a href="https://github.com/Miical">Miical</a>, <a href="https://github.com/yaozhicheng">yaozhicheng</a></li>
</ul>
<!-- <script src="../../js/echarts.min.js"></script> -->
<script>
function update_maintainers(data_url){
    updateMaintainers(data_url)
}
</script>
<div style="text-align: center; width: 100%;">

<label>当前版本：</label>
<select id="maintainersurlSelect" onchange="updateLink()" style="border: 0px">
    
    
    
    
    
    <option value="20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101" data-url="../../data/reports//UnityChipForXiangShan/20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101"  selected>20250306075137-main-0ca85ce5acfa0894762be5d008a2bf85bed08101</option>
    
    <option value="20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e" data-url="../../data/reports//UnityChipForXiangShan/20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e"  >20250306021736-main-8fcdd79da758da0a651aa1a763732a98d640589e</option>
    
    <option value="20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08" data-url="../../data/reports//UnityChipForXiangShan/20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08"  >20250303064534-main-3baa11d910f8949c77dadf50b0f8d95fd78cfc08</option>
    
    <option value="20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b" data-url="../../data/reports//UnityChipForXiangShan/20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b"  >20250221085945-main-1bcaa98e96a9bc8404c5e71c8490aca66f56722b</option>
    
    <option value="20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c" data-url="../../data/reports//UnityChipForXiangShan/20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c"  >20250210003155-main-2b529583954cafe6f145a5d8d49740ebd4d0fa4c</option>
    
    <option value="20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa" data-url="../../data/reports//UnityChipForXiangShan/20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa"  >20250206064001-main-8e09f7c86acf67eb7649bd67df3ec51dccc77aaa</option>
    
    <option value="20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153" data-url="../../data/reports//UnityChipForXiangShan/20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153"  >20250201121154-main-9595c680af64cc08a12f22a1d595ce111249f153</option>
    
    <option value="20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702" data-url="../../data/reports//UnityChipForXiangShan/20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702"  >20250123032900-main-88fa1057ab93bd8286fc2705a1fd203397995702</option>
    
    <option value="20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693" data-url="../../data/reports//UnityChipForXiangShan/20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693"  >20250121015322-main-2f2073ab1f56cc01fed1da01d6ddc6ed52880693</option>
    
    <option value="20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a" data-url="../../data/reports//UnityChipForXiangShan/20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a"  >20241223133801-main-2a8c1ab351e4ea786c55435dd18f60c0c523cc8a</option>
    
    <option value="20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436" data-url="../../data/reports//UnityChipForXiangShan/20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436"  >20241220061304-main-187577e01df03a8ff7ffc828b79070bd5e582436</option>
    
    <option value="20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c" data-url="../../data/reports//UnityChipForXiangShan/20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c"  >20241218062220-main-a866912fc3a6df3d17b857a1a898f6f9e5c5957c</option>
    
    <option value="20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c" data-url="../../data/reports//UnityChipForXiangShan/20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c"  >20241217100236-main-53f30b46ed6e6eeb261894c4a71a60f69777ef8c</option>
    
    <option value="20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db" data-url="../../data/reports//UnityChipForXiangShan/20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db"  >20241216044913-main-7d081626cef0910d9490d169053ee32a8e0c51db</option>
    
    <option value="20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0" data-url="../../data/reports//UnityChipForXiangShan/20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0"  >20241213025923-main-d09f78a58caeeb64347ca2587f1f3f2b2a59e6a0</option>
    
    <option value="20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e" data-url="../../data/reports//UnityChipForXiangShan/20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e"  >20241212091919-main-c54c0c2e590cf334b986f8ef3eacc53329f4ed1e</option>
    
    <option value="20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61" data-url="../../data/reports//UnityChipForXiangShan/20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61"  >20241204085334-main-335e7e0d4ffc2c7a17f8d95e7c75cbd428b14a61</option>
    
    <option value="20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c" data-url="../../data/reports//UnityChipForXiangShan/20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c"  >20241204062337-main-f8903a8c4021ba3e310bf097b07147892729341c</option>
    
    <option value="20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b" data-url="../../data/reports//UnityChipForXiangShan/20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b"  >20241201142531-main-365f53f574ba5c6875b3389824a3c898c642ed2b</option>
    
    <option value="20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6" data-url="../../data/reports//UnityChipForXiangShan/20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6"  >20241129112435-main-79ccae9d5df92c4e167547564b97bd8846b7ecb6</option>
    
    <option value="20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42" data-url="../../data/reports//UnityChipForXiangShan/20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42"  >20241129111104-main-8e0cb45a86ec3ffd779723e17ede379081431c42</option>
    
</select>
<a id="maintainersgoLink" href="#" target=“_blank“></a>

<script>
function updateLink() {
    var select = document.getElementById("maintainersurlSelect");
    var goLink = document.getElementById("maintainersgoLink");
    var opt = select.options[select.selectedIndex];
    if(!opt){
        return
    }
    var url = opt.getAttribute("data-url").replaceAll("/UnityChipForXiangShan/", "");
    goLink.href = url;
    
    window["update_maintainers"](url + "/ut_data_progress.json");
    
}
document.addEventListener('DOMContentLoaded', function() {
    updateLink()
});
</script>

</div>
<br>

<style>
#father-maintainers{
    font-size: 18px;
}

#son-maintainers{
    font-size: 16px;
}

#father-maintainers p, #son-maintainers .dynamic {
    margin-left: 20px;  
    text-indent: -20px;  
    padding-left: 20px;  
    position: relative;
}

#father-maintainers p::before, #son-maintainers .dynamic::before {
    content: "•";  
    font-size: 18px;  
    color: black;  
    position: absolute;
    left: 0;
    top: 0;
}
    
</style>
    
    
<div id="div-maintainers">
    <div id="father-maintainers">
        <p style="font-weight: bold;">主UT模块</p>
    </div>

    <div id="son-maintainers">
        <p style="font-weight: bold;">子UT模块</p>
    </div>
</div>
    
<script>

function updateMaintainers(data_url){
    $.getJSON(data_url, function (data) {
        var index = 1;
        $("#father-maintainers").html(`<p style="font-weight: bold;">主UT模块</p>`);
        $("#son-maintainers").html(`<p style="font-weight: bold;">子UT模块</p>`);
        const prefixes = []
        const fathers = []
        const sons = []
        
        function traverse(node, level = 1) {
            const name = node.name || "Unnamed";
            var maintainer = "TBD";
            if (node.maintainers){
                maintainers = []
                for (let i = 0; i < node.maintainers.length; i++){
                    let cur = node.maintainers[i]
                    let tmp_maintainer = cur.name || "TBD";
                    if (cur.page){
                        tmp_maintainer = "<a href=\"" + cur.page + "\">" + tmp_maintainer + "</a>"
                    } else {
                        tmp_maintainer = "<a>" + tmp_maintainer + "</a>"
                    }
                    maintainers.push(tmp_maintainer)
                }
                maintainer = maintainers.join(' ')
            }
            
            var has_son =  node.children && (node.children.length > 0)
            
            if (level > 1){
                prefixes.push(name);
                if (level == 2){

                    fathers.push("<p class=\"dynamic\">" + prefixes.join('.') + ": " + maintainer + "</p>")

                } else {
                    push_son = (!has_son) || (has_son && maintainer !== "TBD")
                    if (push_son){
                        sons.push("<p class=\"dynamic\">" + prefixes.join('.') + ": " + maintainer + "</p>")

                    }
                }
            }

            if (node.children && node.children.length > 0) {
                $.each(node.children, function (index, child) {
                    traverse(child, level + 1);
                });
            }

            if (level > 1){
                prefixes.pop()
            }
        }
        
        traverse(data.tree);
        

        
        $("#father-maintainers").html($("#father-maintainers").html() + fathers.join(''));
        $("#son-maintainers").html($("#son-maintainers").html() + sons.join(''));
    });
}
</script>

<p>*其他维护者陆续更新中</p>
<p>如果您对本项目感兴趣，欢迎申请成为本项目中的维护者。</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">BOSC</span></span><span class="td-footer__all_rights_reserved">保留所有权利</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/UnityChipForXiangShan/js/main.min.37d14e870feb76f0f7a2a2422bae231efb0186c477999a4ab9ca7e9924ced592.js" integrity="sha256-N9FOhw/rdvD3oqJCK64jHvsBhsR3mZpKucp&#43;mSTO1ZI=" crossorigin="anonymous"></script>
<script src='/UnityChipForXiangShan/js/prism.js'></script>
<script src='/UnityChipForXiangShan/js/tabpane-persist.js'></script>

  </body>
</html>
