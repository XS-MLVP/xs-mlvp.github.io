<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="alternate" type="text/html" href="https://open-verify.cc/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/_print/">
<link rel="alternate" type="application/rss&#43;xml" href="https://open-verify.cc/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/index.xml">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/UnityChipForXiangShan/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/UnityChipForXiangShan/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/UnityChipForXiangShan/favicons/android-192x192.png" sizes="192x192">

<title>IFU | 万众一芯之香山处理器</title>
<meta name="description" content="IFU简介 IFU(Instruction Fetch Unit)，取指令单元，负责从内存或ICache取出指令，经过预译码、扩展RVC和预检之后，将指令交给后续译码器进行进一步的译码。
IFU的子模块包括PreDecode，F3PreDecoder，RVCExpander，PredChecker和FrontendTrigger。
以下是IFU的架构简图：
IFU功能介绍 XS_IFU流水级划分 香山的IFU一共分为5个阶段。
F0阶段：接收FTQ请求，同时告诉FTQ自己已经ready了
F1阶段：从FTQ请求中先计算出每个指令的pc，half_pc、cut_ptr（这是后续将icache返回的指令码进行切分的依据）
F2阶段：从icache获取响应数据（缓存行）并校验，提取出异常信息（包括页错误、访问错误、mmio信息）；生成预测到的指令范围（但这并不是一个数字，而是一个用多位表示的bool数组，该位为1表示这一指令在预测块范围内）；从缓存行中，利用上一阶段求出的cut_ptr切分出17×2的初步指令码，最后进行预译码和指令扩展。
F3阶段：这一阶段主要是对译码阶段的结果进行预检查，以及MMIO状态下的处理逻辑。
WB（写回）阶段：将预检查的结果写回FTQ，并向IBuffer写指令码和前端信息。
接收FTQ取指令请求（F0流水级） ​	在F0流水级，IFU接收来自FTQ以预测块为单位的取指令请求。请求内容包括预测块起始地址、起始地址所在cache line的下一个cache line开始地址、下一个预测块的起始地址、该预测块在FTQ里的队列指针、该预测块有无taken的CFI指令（控制流指令）和该taken的CFI指令在预测块里的位置以及请求控制信号（请求是否有效和IFU是否ready）。每个预测块最多包含32字节指令码，最多为16条指令。IFU需要置位ready驱动FTQ向ICache发送请求。
指令切分产生初始指令码（F1、F2流水级） F0流水级时，FTQ同时会向ICache发送取缓存行的指令。这是ICache在其S2流水级需要返回的，所以IFU在F2流水级才会得到ICache返回的缓存行。在此之前，IFU会在F1流水线先进行PC的计算，以及计算切分缓存行的指针。
进入F2流水级，IFU将会针对每个指令，取出对应的异常信息、物理地址、客户物理地址等。同时，根据FTQ的taken信息，IFU将会计算该预测块在无跳转和跳转发生情况下的有效指令范围。无跳转情况下的指令有效范围ftr_range即当前预测块从起始地址到下一个预测块的起始地址的差值。有跳转情况下的指令有效范围jump_range即当前预测块的起始地址到预测块中第一个跳转指令地址的差值。
最后，IFU需要从缓存行和上一流水级计算的指针，完成对17x2字节初始指令码的拼接。这里的拼接代码可能存在一些迷惑性
val f2_cache_response_data = fromICache.map(_.bits.data) val f2_data_2_cacheline = Cat(f2_cache_response_data(0), f2_cache_response_data(0)) 在调用cut之前，我们先是从ICache获取了缓存行（ICache返回的缓存行种类已经在ICache中进行了分类讨论，IFU中直接使用即可），然后将第0个缓存数据进行了拼接， 这一操作的原因来自于ICache中对数据的细粒度拆分：
fetch block可能跨缓存行，但是由于fetch block最大只有34B，如果将两个缓存行（2x64B）都传送给IFU则显得浪费，因此，fetch block的选择由ICache完成。
ICache返回给IFU的并不是直接的预测块，而是带有跨缓存行信息的64字节。
我们将每个缓存行分为8份，如下所示：
cacheline 0: |0-7|0-6|0-5|0-4|0-3|0-2|0-1|0-0| cacheline 1: |1-7|1-6|1-5|1-4|1-3|1-2|1-1|1-0| 如果fetch block的起始位置为0-1，则必定不跨缓存行。
如果fetch block的起始位置为0-6，那么fetch block的位置为0-6~1-2，此时传送的缓存行结构如下：
cacheline 0: |0-7|0-6|xx|xx|xx|1-2|1-1|1-0| 由此，只要将该缓存行复制一遍，即可获得拼接后的fetch block。
综上所述，对这两种情况，我们都只需要把返回的cacheline复制一份拼接在一起，从中间截取就可以拿到数据。
预译码（F2流水级，主要由PreDecode模块完成） 在F2流水级，我们需要将上一步完成切分的指令码交给PreDecode子模块,他的作用主要有二：
其一是生成预译码信息，包括该指令是否是有效指令的开始、是否是RVC指令、是否是CFI指令、CFI指令类型（branch/jal/jalr/call/ret）、CFI指令的目标地址计算偏移等。输出的预译码信息中brType域的编码如下:
CFI指令类型 brType类型编码 非CFI 00 branch指令 01 jal指令 10 jalr指令 11 （brType类型一览）">
<meta property="og:title" content="IFU" />
<meta property="og:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://open-verify.cc/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/" />
<meta itemprop="name" content="IFU">
<meta itemprop="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="IFU"/>
<meta name="twitter:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."/>
<link rel="preload" href="/UnityChipForXiangShan/scss/main.min.689b22b0041c8c7c7cf217802f908a4ce2122a5f8924320dd5431c6362fe39a7.css" as="style" integrity="sha256-aJsisAQcjHx88heAL5CKTOISKl&#43;JJDIN1UMcY2L&#43;Oac=" crossorigin="anonymous">
<link href="/UnityChipForXiangShan/scss/main.min.689b22b0041c8c7c7cf217802f908a4ce2122a5f8924320dd5431c6362fe39a7.css" rel="stylesheet" integrity="sha256-aJsisAQcjHx88heAL5CKTOISKl&#43;JJDIN1UMcY2L&#43;Oac=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/UnityChipForXiangShan/css/prism.css"/>

    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4Z2ZY6ZE84');
    </script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />

<script>
    $(document).ready(function() {
        $('a[name="multi-lang-toggle"]').on('click', function(event) {
            var language = $(this).attr('lang');
            var codeDiv = $(this).closest('.highlight');
            var preNodes = codeDiv.find('pre');
            preNodes.each(function(index, preNode) {
                if ($(preNode).attr("name").toLowerCase().indexOf(language.toLowerCase()) !== -1) {
                    preNode.style.display = 'block';
                } else {
                    preNode.style.display = 'none';
                }
            });
            var alist = codeDiv.find('a[name="multi-lang-toggle"]');
            alist.each(function(index, aNode) {
                if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                    aNode.style.fontWeight = 'bold';
                } else {
                    aNode.style.fontWeight = 'normal';
                }
            });
        })
        $(this).find('pre[name^="group-lang-code-"]').each(function(index, preNode) {
            if (preNode.style.display !== 'none') {
                var language = $(preNode).attr("name").replace('group-lang-code-', '');
                var alist = $(this).closest('.highlight').find('a[name="multi-lang-toggle"]');
                alist.each(function(index, aNode) {
                    if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                        aNode.style.fontWeight = 'bold';
                    } else {
                        aNode.style.fontWeight = 'normal';
                    }
                });
            }
        });
    });
</script>
    
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/UnityChipForXiangShan/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">万众一芯之香山处理器</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/UnityChipForXiangShan/en/">English</a></li>
    </ul>
</div></li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="站内搜索…"
    aria-label="站内搜索…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/UnityChipForXiangShan/offline-search-index.dda6383ab2729c149632884c3205cdfc.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="站内搜索…"
    aria-label="站内搜索…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/UnityChipForXiangShan/offline-search-index.dda6383ab2729c149632884c3205cdfc.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse foldable-nav" id="td-section-nav">
    <div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none">
      <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/UnityChipForXiangShan/en/">English</a></li>
    </ul>
</div>
    </div>
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-unitychipforxiangshandocs-li">
  <a href="/UnityChipForXiangShan/docs/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-unitychipforxiangshandocs"><span class="">进度概述</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs00_unitychip_for_xiangshan-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs00_unitychip_for_xiangshan-check"/>
  <label for="m-unitychipforxiangshandocs00_unitychip_for_xiangshan-check"><a href="/UnityChipForXiangShan/docs/00_unitychip_for_xiangshan/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs00_unitychip_for_xiangshan"><span class="">目标验证单元</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs01_verfiy_env-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs01_verfiy_env-check"/>
  <label for="m-unitychipforxiangshandocs01_verfiy_env-check"><a href="/UnityChipForXiangShan/docs/01_verfiy_env/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs01_verfiy_env"><span class="">准备验证环境</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs02_run_test-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs02_run_test-check"/>
  <label for="m-unitychipforxiangshandocs02_run_test-check"><a href="/UnityChipForXiangShan/docs/02_run_test/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs02_run_test"><span class="">运行测试</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-unitychipforxiangshandocs03_add_test-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs03_add_test-check"/>
  <label for="m-unitychipforxiangshandocs03_add_test-check"><a href="/UnityChipForXiangShan/docs/03_add_test/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs03_add_test"><span class="">添加测试</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs03_add_test01_build_script-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs03_add_test01_build_script-check"/>
  <label for="m-unitychipforxiangshandocs03_add_test01_build_script-check"><a href="/UnityChipForXiangShan/docs/03_add_test/01_build_script/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs03_add_test01_build_script"><span class="">添加编译脚本</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs03_add_test02_build_env-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs03_add_test02_build_env-check"/>
  <label for="m-unitychipforxiangshandocs03_add_test02_build_env-check"><a href="/UnityChipForXiangShan/docs/03_add_test/02_build_env/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs03_add_test02_build_env"><span class="">构建测试环境</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs03_add_test03_add_test-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs03_add_test03_add_test-check"/>
  <label for="m-unitychipforxiangshandocs03_add_test03_add_test-check"><a href="/UnityChipForXiangShan/docs/03_add_test/03_add_test/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs03_add_test03_add_test"><span class="">添加测试用例</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs03_add_test04_cover_line-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs03_add_test04_cover_line-check"/>
  <label for="m-unitychipforxiangshandocs03_add_test04_cover_line-check"><a href="/UnityChipForXiangShan/docs/03_add_test/04_cover_line/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs03_add_test04_cover_line"><span class="">代码覆盖率</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs03_add_test05_cover_func-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs03_add_test05_cover_func-check"/>
  <label for="m-unitychipforxiangshandocs03_add_test05_cover_func-check"><a href="/UnityChipForXiangShan/docs/03_add_test/05_cover_func/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs03_add_test05_cover_func"><span class="">功能覆盖率</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs06_join_us-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs06_join_us-check"/>
  <label for="m-unitychipforxiangshandocs06_join_us-check"><a href="/UnityChipForXiangShan/docs/06_join_us/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs06_join_us"><span class="">如何参与本项目</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs08_template_pr-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs08_template_pr-check"/>
  <label for="m-unitychipforxiangshandocs08_template_pr-check"><a href="/UnityChipForXiangShan/docs/08_template_pr/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs08_template_pr"><span class="">模板-PR</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs09_template_issue-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs09_template_issue-check"/>
  <label for="m-unitychipforxiangshandocs09_template_issue-check"><a href="/UnityChipForXiangShan/docs/09_template_issue/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs09_template_issue"><span class="">模板-ISSUE</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs10_template_ut_readme-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs10_template_ut_readme-check"/>
  <label for="m-unitychipforxiangshandocs10_template_ut_readme-check"><a href="/UnityChipForXiangShan/docs/10_template_ut_readme/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs10_template_ut_readme"><span class="">模板-UT-README</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs95_api-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs95_api-check"/>
  <label for="m-unitychipforxiangshandocs95_api-check"><a href="/UnityChipForXiangShan/docs/95_api/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs95_api"><span class="">常用API</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs96_others-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs96_others-check"/>
  <label for="m-unitychipforxiangshandocs96_others-check"><a href="/UnityChipForXiangShan/docs/96_others/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs96_others"><span class="">其他</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs97_constraint-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs97_constraint-check"/>
  <label for="m-unitychipforxiangshandocs97_constraint-check"><a href="/UnityChipForXiangShan/docs/97_constraint/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs97_constraint"><span class="">必要规范</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-unitychipforxiangshandocs98_ut-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut-check" checked/>
  <label for="m-unitychipforxiangshandocs98_ut-check"><a href="/UnityChipForXiangShan/docs/98_ut/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut"><span class="">验证文档</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut00_standard-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut00_standard-check"/>
  <label for="m-unitychipforxiangshandocs98_ut00_standard-check"><a href="/UnityChipForXiangShan/docs/98_ut/00_standard/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut00_standard"><span class="">验证文档规范</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-unitychipforxiangshandocs98_ut01_frontend-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend-check" checked/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut01_frontend"><span class="">Frontend</span></a></label>
  
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu-check" checked/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend01_ifu-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/" class="align-left ps-0  active td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu"><span class="td-sidebar-nav-active-item">IFU</span></a></label>
  
  <ul class="ul-4 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu02_f3predecoder-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu02_f3predecoder-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend01_ifu02_f3predecoder-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/02_f3predecoder/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu02_f3predecoder"><span class="">F3PreDecoder</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu05_frontend_trigger-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu05_frontend_trigger-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend01_ifu05_frontend_trigger-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/05_frontend_trigger/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu05_frontend_trigger"><span class="">FrontendTrigger</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu04_pred_checker-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu04_pred_checker-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend01_ifu04_pred_checker-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/04_pred_checker/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu04_pred_checker"><span class="">PredChecker</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu01_predecode-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu01_predecode-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend01_ifu01_predecode-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/01_predecode/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu01_predecode"><span class="">PreDecode</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu03_ifu_rvc_exp-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu03_ifu_rvc_exp-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend01_ifu03_ifu_rvc_exp-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/03_ifu_rvc_exp/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend01_ifu03_ifu_rvc_exp"><span class="">RVCExpander</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend02_itlb-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/02_itlb/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb"><span class="">ITLB</span></a></label>
  
  <ul class="ul-4 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb04_io-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb04_io-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend02_itlb04_io-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/02_itlb/04_io/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb04_io"><span class="">IO接口说明</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb02_func-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb02_func-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend02_itlb02_func-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/02_itlb/02_func/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb02_func"><span class="">功能详述</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb03_keysignal-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb03_keysignal-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend02_itlb03_keysignal-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/02_itlb/03_keysignal/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb03_keysignal"><span class="">关键信号说明</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb01_env-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb01_env-check"/>
  <label for="m-unitychipforxiangshandocs98_ut01_frontend02_itlb01_env-check"><a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/02_itlb/01_env/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs98_ut01_frontend02_itlb01_env"><span class="">环境配置</span></a></label>
  
</li>
  </ul>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut02_backend-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut02_backend-check"/>
  <label for="m-unitychipforxiangshandocs98_ut02_backend-check"><a href="/UnityChipForXiangShan/docs/98_ut/02_backend/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut02_backend"><span class="">Backend</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut03_memblock-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut03_memblock-check"/>
  <label for="m-unitychipforxiangshandocs98_ut03_memblock-check"><a href="/UnityChipForXiangShan/docs/98_ut/03_memblock/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut03_memblock"><span class="">Mem Block</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs98_ut04_misc-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs98_ut04_misc-check"/>
  <label for="m-unitychipforxiangshandocs98_ut04_misc-check"><a href="/UnityChipForXiangShan/docs/98_ut/04_misc/" class="align-left ps-0  td-sidebar-link td-sidebar-link__section" id="m-unitychipforxiangshandocs98_ut04_misc"><span class="">Misc</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-unitychipforxiangshandocs99_maintain-li">
  <input type="checkbox" id="m-unitychipforxiangshandocs99_maintain-check"/>
  <label for="m-unitychipforxiangshandocs99_maintain-check"><a href="/UnityChipForXiangShan/docs/99_maintain/" class="align-left ps-0  td-sidebar-link td-sidebar-link__page" id="m-unitychipforxiangshandocs99_maintain"><span class="">维护者</span></a></label>
  
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/XS-MLVP/UnityChipForXiangShan/documents/tree/main/content/zh-cn/docs/98_UT/01_frontend/01_ifu/_index.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> 查看页面源码</a>
  <a href="https://github.com/XS-MLVP/UnityChipForXiangShan/documents/edit/main/content/zh-cn/docs/98_UT/01_frontend/01_ifu/_index.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> 编辑此页</a>
  <a href="https://github.com/XS-MLVP/UnityChipForXiangShan/documents/new/main/content/zh-cn/docs/98_UT/01_frontend/01_ifu?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> 添加子页面</a>
  <a href="https://github.com/XS-MLVP/UnityChipForXiangShan/documents/issues/new?title=IFU" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> 提交文档问题</a>
  <a href="https://github.com/XS-MLVP/UnityChipForXiangShan//issues/new" class="td-page-meta--project td-page-meta__project-issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> 提交项目问题</a>
  <a id="print" href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/_print/"><i class="fa-solid fa-print fa-fw"></i> 整节打印</a>

</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ifu功能介绍">IFU功能介绍</a>
      <ul>
        <li><a href="#xs_ifu流水级划分"><strong>XS_IFU流水级划分</strong></a></li>
        <li><a href="#接收ftq取指令请求f0流水级">接收FTQ取指令请求（F0流水级）</a></li>
        <li><a href="#指令切分产生初始指令码f1f2流水级">指令切分产生初始指令码（F1、F2流水级）</a></li>
        <li><a href="#预译码f2流水级主要由predecode模块完成">预译码（F2流水级，主要由PreDecode模块完成）</a></li>
        <li><a href="#指令扩展f3流水级">指令扩展（F3流水级）</a></li>
        <li><a href="#预测错误预检查f3流水级主要由prechecker子模块完成">预测错误预检查（F3流水级，主要由PreChecker子模块完成）</a></li>
        <li><a href="#前端重定向wb阶段">前端重定向（WB阶段）</a></li>
        <li><a href="#跨预测块32位指令处理a-idkyck_32a">跨预测块32位指令处理<a id="kyck_32"></a></a></li>
        <li><a href="#将指令码和前端信息送入ibufferf3流水级">将指令码和前端信息送入IBuffer（F3流水级）</a></li>
        <li><a href="#分支预测overriding冲刷流水线">分支预测overriding冲刷流水线</a></li>
        <li><a href="#指令信息和误预测信息写回ftqwb阶段">指令信息和误预测信息写回FTQ（WB阶段）</a></li>
        <li><a href="#mmio处理逻辑">MMIO处理逻辑</a></li>
        <li><a href="#trigger实现对于pc的硬件断点功能">Trigger实现对于PC的硬件断点功能</a></li>
      </ul>
    </li>
    <li><a href="#ifu接口说明">IFU接口说明</a>
      <ul>
        <li><a href="#ftq交互接口">FTQ交互接口</a></li>
        <li><a href="#icache交互接口">ICache交互接口</a></li>
        <li><a href="#性能相关接口">性能相关接口</a></li>
        <li><a href="#itlbinter">ITLBInter</a></li>
        <li><a href="#uncacheinter">UncacheInter</a></li>
        <li><a href="#toibuffer">toIbuffer</a></li>
        <li><a href="#tobackend_gpaddrmem">toBackend_gpaddrMem</a></li>
        <li><a href="#io_csr_fsisoff">io_csr_fsIsOff</a></li>
        <li><a href="#rob_commits-来自rob的提交信息">rob_commits 来自ROB的提交信息</a></li>
        <li><a href="#pmp">pmp</a></li>
        <li><a href="#mmio_commits">mmio_commits</a></li>
        <li><a href="#frontendtrigger">frontendTrigger</a></li>
      </ul>
    </li>
    <li><a href="#ifu功能点和测试点">IFU功能点和测试点</a>
      <ul>
        <li><a href="#功能点1-接收ftq预测块请求">功能点1 接收FTQ预测块请求</a></li>
        <li><a href="#功能点2-指令切分产生初始指令码">功能点2 指令切分产生初始指令码</a></li>
        <li><a href="#功能点3-预译码">功能点3 预译码</a></li>
        <li><a href="#功能点4-指令扩展">功能点4 指令扩展</a></li>
        <li><a href="#功能点5-预测错误预检">功能点5 预测错误预检</a></li>
        <li><a href="#功能点6-前端重定向和流水线冲刷">功能点6 前端重定向和流水线冲刷</a></li>
        <li><a href="#功能点7-将指令码和前端信息输出给ibuffer">功能点7 将指令码和前端信息输出给IBuffer</a></li>
        <li><a href="#功能点8-分支预测冲刷流水线">功能点8 分支预测冲刷流水线</a></li>
        <li><a href="#功能点9-指令信息和误预测信息写回ftq">功能点9 指令信息和误预测信息写回FTQ</a></li>
        <li><a href="#功能点10-mmio处理">功能点10 MMIO处理</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/UnityChipForXiangShan/docs/">进度概述</a></li>
  <li class="breadcrumb-item">
    <a href="/UnityChipForXiangShan/docs/98_ut/">验证文档</a></li>
  <li class="breadcrumb-item">
    <a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/">Frontend</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    IFU</li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>IFU</h1>
  
	<header class="article-meta">
		
  </header>
	<h1 id="ifu简介"><strong>IFU简介</strong></h1>
<div class="ifu-ctx">
<p>IFU(Instruction Fetch Unit)，取指令单元，负责从内存或ICache取出指令，经过预译码、扩展RVC和预检之后，将指令交给后续译码器进行进一步的译码。</p>
<p>IFU的子模块包括PreDecode，F3PreDecoder，RVCExpander，PredChecker和FrontendTrigger。</p>
<p>以下是IFU的架构简图：</p>
<p><img alt="framework" src="framework.jpg"></p>
<h2 id="ifu功能介绍">IFU功能介绍</h2>
<h3 id="xs_ifu流水级划分"><strong>XS_IFU流水级划分</strong></h3>
<p>香山的IFU一共分为5个阶段。</p>
<p>F0阶段：接收FTQ请求，同时告诉FTQ自己已经ready了</p>
<p>F1阶段：从FTQ请求中先计算出每个指令的pc，half_pc、cut_ptr（这是后续将icache返回的指令码进行切分的依据）</p>
<p>F2阶段：从icache获取响应数据（缓存行）并校验，提取出异常信息（包括页错误、访问错误、mmio信息）；生成预测到的指令范围（但这并不是一个数字，而是一个用多位表示的bool数组，该位为1表示这一指令在预测块范围内）；从缓存行中，利用上一阶段求出的cut_ptr切分出17×2的初步指令码，最后进行预译码和指令扩展。</p>
<p>F3阶段：这一阶段主要是对译码阶段的结果进行预检查，以及MMIO状态下的处理逻辑。</p>
<p>WB（写回）阶段：将预检查的结果写回FTQ，并向IBuffer写指令码和前端信息。</p>
<h3 id="接收ftq取指令请求f0流水级">接收FTQ取指令请求（F0流水级）</h3>
<p>​	在F0流水级，IFU接收来自FTQ以预测块为单位的取指令请求。请求内容包括预测块起始地址、起始地址所在cache line的下一个cache line开始地址、下一个预测块的起始地址、该预测块在FTQ里的队列指针、该预测块有无taken的CFI指令（控制流指令）和该taken的CFI指令在预测块里的位置以及请求控制信号（请求是否有效和IFU是否ready）。每个预测块最多包含32字节指令码，最多为16条指令。IFU需要置位ready驱动FTQ向ICache发送请求。</p>
<h3 id="指令切分产生初始指令码f1f2流水级">指令切分产生初始指令码（F1、F2流水级）</h3>
<p>F0流水级时，FTQ同时会向ICache发送取缓存行的指令。这是ICache在其S2流水级需要返回的，所以IFU在F2流水级才会得到ICache返回的缓存行。在此之前，IFU会在F1流水线先进行PC的计算，以及计算切分缓存行的指针。</p>
<p>进入F2流水级，IFU将会针对每个指令，取出对应的异常信息、物理地址、客户物理地址等。同时，根据FTQ的taken信息，IFU将会计算该预测块在无跳转和跳转发生情况下的有效指令范围。无跳转情况下的指令有效范围ftr_range即当前预测块从起始地址到下一个预测块的起始地址的差值。有跳转情况下的指令有效范围jump_range即当前预测块的起始地址到预测块中第一个跳转指令地址的差值。</p>
<p>最后，IFU需要从缓存行和上一流水级计算的指针，完成对17x2字节初始指令码的拼接。这里的拼接代码可能存在一些迷惑性</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">f2_cache_response_data</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">fromICache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">_</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bits</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">val</span> <span style="color:#000">f2_data_2_cacheline</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">Cat</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">f2_cache_response_data</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">f2_cache_response_data</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span></code></pre></div><p>在调用cut之前，我们先是从ICache获取了缓存行（ICache返回的缓存行种类已经在ICache中进行了分类讨论，IFU中直接使用即可），然后将第0个缓存数据进行了拼接，
这一操作的原因来自于ICache中对数据的细粒度拆分：</p>
<p>fetch block可能跨缓存行，但是由于fetch block最大只有34B，如果将两个缓存行（2x64B）都传送给IFU则显得浪费，因此，fetch block的选择由ICache完成。</p>
<p>ICache返回给IFU的并不是直接的预测块，而是带有跨缓存行信息的64字节。</p>
<p>我们将每个缓存行分为8份，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cacheline 0: |0-7|0-6|0-5|0-4|0-3|0-2|0-1|0-0|
</span></span><span style="display:flex;"><span>cacheline 1: |1-7|1-6|1-5|1-4|1-3|1-2|1-1|1-0|
</span></span></code></pre></div><p>如果fetch block的起始位置为0-1，则必定不跨缓存行。</p>
<p>如果fetch block的起始位置为0-6，那么fetch block的位置为0-6~1-2，此时传送的缓存行结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>cacheline 0: |0-7|0-6|xx|xx|xx|1-2|1-1|1-0|
</span></span></code></pre></div><p>由此，只要将该缓存行复制一遍，即可获得拼接后的fetch block。</p>
<p>综上所述，对这两种情况，我们都只需要把返回的cacheline复制一份拼接在一起，从中间截取就可以拿到数据。</p>
<h3 id="预译码f2流水级主要由predecode模块完成">预译码（F2流水级，主要由PreDecode模块完成）</h3>
<p>在F2流水级，我们需要将上一步完成切分的指令码交给PreDecode子模块,他的作用主要有二：</p>
<p>其一是生成预译码信息，包括该指令是否是有效指令的开始、是否是RVC指令、是否是CFI指令、CFI指令类型（branch/jal/jalr/call/ret）、CFI指令的目标地址计算偏移等。输出的预译码信息中brType域的编码如下:</p>
<table>
<thead>
<tr>
<th>CFI指令类型</th>
<th>brType类型编码</th>
</tr>
</thead>
<tbody>
<tr>
<td>非CFI</td>
<td>00</td>
</tr>
<tr>
<td>branch指令</td>
<td>01</td>
</tr>
<tr>
<td>jal指令</td>
<td>10</td>
</tr>
<tr>
<td>jalr指令</td>
<td>11</td>
</tr>
</tbody>
</table>
<p>（<strong><a id="brtype">brType类型一览</a></strong>）</p>
<p>其二是将初始指令码两两组合之后，得到16x4字节的指令码（从起始地址开始，2字节做地址递增，地址开始的4字节作为一条32位初始指令码）。</p>
<p>此外，预译码阶段还需要分类讨论，得出两种指令有效向量（起始指令是不是RVI指令的后半部分），并交给IFU进行判断，可以参阅后面的<a href="#kyck_32">跨预测块32位指令</a>处理部分</p>
<p>其他功能和详细内容参见PreDecode子模块的描述。</p>
<h3 id="指令扩展f3流水级">指令扩展（F3流水级）</h3>
<p>这一部分将从PreDecode返回的16条指令码分别送交指令扩展器进行32位指令扩展（RVI保持不变， RVC指令根据手册的规定进行扩充）。</p>
<p>但是，如果指令非法，需要向IBuffer写入原始指令码。</p>
<h3 id="预测错误预检查f3流水级主要由prechecker子模块完成">预测错误预检查（F3流水级，主要由PreChecker子模块完成）</h3>
<p>这一功能是为了将一些不依赖于执行结果的预测错误在早期就发现出来。这一阶段检查五类错误：</p>
<p><strong>jal类型错误</strong>：预测块的范围内有jal指令，但是预测器没有对这条指令预测跳转；</p>
<p><strong>ret类型错误</strong>：预测块的范围内有ret指令，但是预测器没有对这条指令预测跳转；</p>
<p><strong>无效指令预测错误</strong>：预测器对一条无效的指令（不在预测块范围/是一条32位指令中间）进行了预测；</p>
<p><strong>非CFI指令预测错误</strong>：预测器对一条有效但是不是CFI的指令进行了预测；</p>
<p><strong>转移目标地址错误</strong>：预测器给出的转移目标地址不正确。</p>
<p>在预检查的最后将会修正之前预测的各个指令的跳转情况。同时，如果存在jal或者ret类型预测错误，还将修正fixedRange——这是指令有效范围向量，可以看作一个bool数组，其中某一位为1也就是对应的指令在这一范围内。</p>
<h3 id="前端重定向wb阶段">前端重定向（WB阶段）</h3>
<p>如果在预测错误预检查的部分发现了上述的五类错误，那么需要在写回阶段产生一个前端重定向将F3以外的流水级进行冲刷，
从而让BPU能够从正确路径重新开始预测。</p>
<p>还有一种情况下需要冲刷流水线。在下一节中，如果误判了当前预测块的最后2B为RVI指令的上半部分，则也需要冲刷当前预测块F3之前的流水级。</p>
<h3 id="跨预测块32位指令处理a-idkyck_32a">跨预测块32位指令处理<a id="kyck_32"></a></h3>
<p>因为预测块的长度有限制，因此存在一条RVI指令前后两字节分别在两个预测块的情况。IFU首先在第一个预测块里检查最后2字节是不是一条RVI指令的开始，如果是并且该预测块没有跳转，那么就设置一个标识寄存器f3_lastHalf_valid，告诉接下来的预测块含有后半条指令。在F2预译码时，会产生两种不同的指令有效向量：</p>
<p>预测块起始地址开始即为一条指令的开始，以这种方式根据后续指令是RVC还是RVI产生指令有效向量</p>
<p>预测块起始地址是一条RVI指令的中间，以起始地址 + 2位一条指令的开始产生有效向量</p>
<p>在F3，根据是否有跨预测块RVI标识来决定选用哪种作为最终的指令有效向量，如果f3_lastHalf_valid为高则选择后一种（即这个预测块第一个2字节不是指令的开始）。IFU所做的处理只是把这条指令算在第一个预测块里，而把第二个预测块的起始地址位置的2字节通过改变指令有效向量来无效掉。</p>
<h3 id="将指令码和前端信息送入ibufferf3流水级">将指令码和前端信息送入IBuffer（F3流水级）</h3>
<p>F3流水级最终得到经过扩展的32位指令码（或者对于非法指令直接传递原始指令码），以及16条指令中每条指令的例外信息、
预译码信息、FTQ队列中的指针位置、其他后端需要的信息（比如经过折叠的PC）等。IFU除了常规的valid-ready控制信号外，
还会给IBuffer两个特殊的信号：一个是16位的io_toIbuffer_bits_valid（因为我们最后组合出来的指令也是16条，
所以这里每一位刚好也对应一个指令的状态，为1说明是一条指令的开始，为0则是说明是一条指令的中间），标识预测块里有效的指令。
另一个是16位的io_toIbuffer_bits_enqEnable，这个在io_toIbuffer_bits_valid的基础上与上了被修正过的预测块的指令范围fixedRange。
enqEnable为1表示这个2字节指令码是一条指令的开始且在预测块表示的指令范围内。</p>
<p>除此之外，异常信息也需要写给IBuffer。</p>
<p>注意一个特例：当且仅当发生guest page fault时，后端需要gpaddr信息，为了节省面积，gpaddr不走正常通路进入ibuffer，
而是随ftqPtr被发送到gpaMem，后端需要时从gpaMem读出。IFU需要保证gpf发生时通向gpaMem的valid拉高、gpaddr正确。</p>
<h3 id="分支预测overriding冲刷流水线">分支预测overriding冲刷流水线</h3>
<p>当FTQ内未缓存足够预测块时，IFU可能直接使用简单分支预测器提供的预测地址进行取指，这种情况下，当精确预测器发现简单预测器错误时，需要通知IFU取消正在进行的取指请求。具体而言，当BPU的S2流水级发现错误时，需要冲刷IFU的F0流水级；当BPU的S3流水级发现错误时，需要冲刷IFU的F0/F1流水级（BPU的简单预测器在S1给出结果，最晚在S3进行overriding，因此IFU的F2/F3流水级一定是最好的预测，不需要冲刷；类似地，不存在BPU S2到IFU F1的冲刷）。</p>
<p>IFU在收到BPU发送的冲刷请求时，会将F0/F1流水级上取指请求的指针与BPU发送的冲刷请求的指针进行比较，若冲刷的指针在取指的指针之前，说明当前取指请求在错误的执行路径上，需要进行流水线冲刷；反之，IFU可以忽略BPU发送的这一冲刷请求。此外，比较的时候还需要注意flag的情况，flag是一个指示队列循环的指针，flag不同即在不同的“圈”上，此时反而是idx的值更小，ftqIdx才会更大。</p>
<h3 id="指令信息和误预测信息写回ftqwb阶段">指令信息和误预测信息写回FTQ（WB阶段）</h3>
<p>在F3的下一级WB级，IFU将指令PC、预译码信息、错误预测指令的位置、正确的跳转地址以及预测块的正确指令范围等信息写回FTQ，同时传递该预测块的FTQ指针用以区分不同请求。</p>
<p>同时，正如前面提到的，IFU检测到预测错误时会进行前端冲刷，同样地，FTQ也需要据此进行冲刷，因此，这也是IFU写回错误信息的意义——可以辅助FTQ判断是否冲刷流水线。</p>
<h3 id="mmio处理逻辑">MMIO处理逻辑</h3>
<p>在处理器上电复位时，内存还没有准备好，此时需要从Flash中取指令执行。
这种情况下需要IFU向MMIO总线发送宽度为64位的请求从flash地址空间取指令执行。同时IFU禁止对MMIO总线的推测执行，即IFU需要等到每一条指令执行完成得到准确的下一条指令地址之后才继续向总线发送请求。</p>
<p>这之后，根据FTQ中的指令地址，决定是否MMIO取指令。</p>
<p><img alt="mmio_states" src="mmio_stmt.svg"></p>
<p>以上是MMIO状态机的简图。在一开始，处于m_idle状态，如果处于mmio请求的场景（在f3阶段有效且没有异常的情况下，ICache返回的pmp_mmio[0]为真，或者ITLB返回的PBMT为Uncache类型——nc或者io类型，对应值为1和2），则转换到m_waitLastCmt，之后只要之前所有的指令都已完成提交——或者这一指令就是第一条指令，
则进入m_sendReq状态将请求发送到InstrUncache模块，发送完成后进入m_waitResp状态。
接收请求后，由于MMIO总线的带宽限制为64位，
因此存在一条指令一次MMIO请求不能取得完整指令码的情况（这是由于MMIO并不支持非对齐访问，具体地说，如果RVI指令的起始地址的[2, 1]两位为b11，则64位总线无法一次传递所有指令），所以需要增加地址进行重发，进入m_sendTLB状态，
再次查询ITLB，如果tlb的pbmt状态和上一条的存在差别，则为访问异常，综合TLB自身的异常结果和根据pbmt判定的访问异常，如果存在异常，则直接把指令和异常信息发到Ibuffer，进入等待，否则进入m_sendPMP状态，向PMP发送请求，
这里需要查看pmp_recheck的结果，如果该请求的mmio状态和上一条的mmio状态不一致，那么说明可能存在访问错误，置为访问异常，否则根据PMP的回复结果决定是否存在PMP异常。
如果存在异常，则将报错信息发送给Ibuffer，直接进入等待。 一切正常的话，进入m_resendReq状态，重新发送请求到InstrUncache模块。
无论是否重发，最后获得完整数据之后，根据地址从64位数据中截取指令码。并以每个预测块一条指令的形式（相当于只有起始地址的指令）发送到IBuffer。
接下来进入m_waitCommit状态等待，直到ROB返回指令已提交的信号即进入m_commited状态，CFI指令由后端发送给FTQ进行冲刷，而顺序指令则由IFU复用前端重定向通路刷新流水线，
同时复用FTQ写回机制，把它当作一条错误预测的指令进行冲刷，重定向到该指令地址 + 2或者+4(根据这条指令是RVI还是RVC选择)</p>
<p>对于跨缓存行预测块，他们的mmio和pbmt状态应当等同。不匹配的错误应当只在后一个缓存行报告。</p>
<p>此外，如果当前pbmt为nc，则会跳过waitLastCmt和waitCommit状态。因为这些内存空间是幂等的，所以可以进行推测性取指。</p>
<h3 id="trigger实现对于pc的硬件断点功能">Trigger实现对于PC的硬件断点功能</h3>
<p>该工作主要由FrontEndTrigger子模块完成。</p>
<h2 id="ifu接口说明">IFU接口说明</h2>
<p>为方便测试开展，需要对IFU的接口进行进一步的说明，以明确各个接口的含义。</p>
<h3 id="ftq交互接口">FTQ交互接口</h3>
<p>编译后可用的接口包括：</p>
<h4 id="req-ftq取指请求">req FTQ取指请求</h4>
<p>req是FTQ向IFU的取指令请求，编译后包含以下成员：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>ftqIdx</td>
<td>指示当前预测块在FTQ中的位置。</td>
</tr>
<tr>
<td>ftqOffset</td>
<td>指示预测块的大小</td>
</tr>
<tr>
<td>startAddr</td>
<td>当前预测块的起始地址。</td>
</tr>
<tr>
<td>nextlineStart</td>
<td>起始地址所在cacheline的下一个cacheline的开始地址。</td>
</tr>
<tr>
<td>nextStartAddr</td>
<td>下一个预测块的起始地址</td>
</tr>
</tbody>
</table>
<h4 id="redirect-ftq重定向请求">redirect FTQ重定向请求</h4>
<p>FTQ会向IFU发送重定向请求，这通过fromFtq.redirect完成，从而指示IFU应该冲刷的内容。</p>
<p>编译后，redirect包含以下接口成员：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>ftqIdx</td>
<td>需要冲刷的ftq预测块序号，包含flag和value两个量。</td>
</tr>
<tr>
<td>level</td>
<td>重定向等级</td>
</tr>
<tr>
<td>ftq_offset</td>
<td>ftq预测块中跳转指令的位置</td>
</tr>
</tbody>
</table>
<p>此外，还有valid变量指示是否需要重定向。</p>
<h4 id="frombpuflush">fromBPUFlush</h4>
<p>来自BPU的冲刷请求，这是预测错误引起的，包括s3和s2两个同构成员，指示是否在BPU的s3和s2流水级发现了问题，s3的详细结构如下</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>valid</td>
<td>是否存在s3流水级冲刷要求</td>
</tr>
<tr>
<td>ftqIdx</td>
<td>s3流水级请求冲刷的预测块的指针</td>
</tr>
</tbody>
</table>
<h4 id="toftq_pdwb-写回">toFtq_pdWb 写回</h4>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>cfioffset</td>
<td>经由PredChecker修复的跳转指令的预测位置。但经过编译后，cfioffset的数值已经被优化了，只剩下了cfioffset_valid表示是否存在编译优化。</td>
</tr>
<tr>
<td>ftqIdx</td>
<td>表明预测块在FTQ中的位置，这条信息主要是对FTQ有用，要和FTQ传入的请求保持一致。</td>
</tr>
<tr>
<td>instrRange</td>
<td>可以看作是一个bool数组，表示该条指令是不是在这个预测块的有效指令范围内（即第一条有效跳转指令之前的指令）。</td>
</tr>
<tr>
<td>jalTarget</td>
<td>表明该预测块跳转指令的跳转目标。</td>
</tr>
<tr>
<td>misOffset</td>
<td>表明错误预测的指令在预测块中的位置。</td>
</tr>
<tr>
<td>pc</td>
<td>预测块中所有指令的PC指针。</td>
</tr>
<tr>
<td>pd</td>
<td>每条指令的预测信息，包括CFI指令的类型、isCall、isRet和isRVC。</td>
</tr>
<tr>
<td>target</td>
<td>该预测块最后一条指令的下一条指令的pc。</td>
</tr>
</tbody>
</table>
<h3 id="icache交互接口">ICache交互接口</h3>
<h4 id="控制信号">控制信号</h4>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>icache_ready</td>
<td>ICache通知IFU自己已经准备好了，可以发送缓存行了。</td>
</tr>
<tr>
<td>icache_stop</td>
<td>IFU在F3流水级之前出现了问题，通知ICache停下。</td>
</tr>
</tbody>
</table>
<h4 id="icacheinterresp-icache传送给ifu的信息">ICacheInter.resp ICache传送给IFU的信息</h4>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>data</td>
<td>ICache传送的缓存行。</td>
</tr>
<tr>
<td>doubleLine</td>
<td>指示ICache传来的预测块是否跨缓存行。</td>
</tr>
<tr>
<td>exception</td>
<td>ICache向IFU报告每个缓存行上的异常情况，方便ICache生成每个指令的异常向量。</td>
</tr>
<tr>
<td>backendException</td>
<td>ICache向IFU报告后端是否存在异常</td>
</tr>
<tr>
<td>gpaddr</td>
<td>客户页地址</td>
</tr>
<tr>
<td>isForVSnonLeafPTE</td>
<td>是否为非叶的PTE，这个数据最终会流向写回gpaddrMem的信号</td>
</tr>
<tr>
<td>itlb_pbmt</td>
<td>ITLB基于客户页的内存类型，对MMIO状态有用</td>
</tr>
<tr>
<td>paddr</td>
<td>指令块的起始物理地址</td>
</tr>
<tr>
<td>vaddr</td>
<td>指令块起始虚拟地址、下一个缓存行的虚拟地址</td>
</tr>
<tr>
<td>pmp_mmio</td>
<td>指示当前指令块是否在MMIO空间</td>
</tr>
</tbody>
</table>
<h3 id="性能相关接口">性能相关接口</h3>
<p>ICachePerf和perf，可以先不关注。</p>
<h3 id="itlbinter">ITLBInter</h3>
<p>该接口仅在MMIO状态下，IFU重发请求时活跃。</p>
<h4 id="req-ifu向itlb发送的请求">req IFU向ITLB发送的请求</h4>
<p>这是IFU向ITLB发送的查询请求，只有一个量：bits_vaddr，传递需要让ITLB查询的虚拟地址。</p>
<h4 id="resp-itlb返回给ifu的查询结果">resp ITLB返回给IFU的查询结果</h4>
<p>这是ITLB返回给IFU的查询结果，包含如下接口：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>excp</td>
<td>指令的异常信息，包含三个量：访问异常指令af_instr、客户页错误指令gpf_instr、页错误指令pf_instr</td>
</tr>
<tr>
<td>gpaddr</td>
<td>客户页地址</td>
</tr>
<tr>
<td>isForVSnonLeafPTE</td>
<td>指示传入的是否是非叶PTE</td>
</tr>
<tr>
<td>paddr</td>
<td>指令物理地址</td>
</tr>
<tr>
<td>pbmt</td>
<td>指令的基于页的内存类型</td>
</tr>
</tbody>
</table>
<h3 id="uncacheinter">UncacheInter</h3>
<p>该接口在MMIO状态下活跃，负责接收IFU并返回指令码。</p>
<h4 id="touncache">toUncache</h4>
<p>这是IFU向Uncache发送的请求，除了ready和valid以外，还传送了一个48位数据，即需要获取的指令的物理地址。</p>
<h4 id="fromuncache">fromUncache</h4>
<p>这是Uncache给IFU的回复，除了valid以外，还传送一个32位数据，即指令码（可为RVC或RVI指令）</p>
<h3 id="toibuffer">toIbuffer</h3>
<p>IFU通过这个接口向Ibuffer写入取指结果。包含以下成员:</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>backendException</td>
<td>是否存在后端异常</td>
</tr>
<tr>
<td>crossPageIPFFix</td>
<td>表示跨页异常向量</td>
</tr>
<tr>
<td>valid</td>
<td>和一般意义上的valid相区别，表示每条指令是否是合法指令的开始（RVI指令的上半条或者RVC指令）</td>
</tr>
<tr>
<td>enqable</td>
<td>对每条指令，其为valid并且在预测块的范围内</td>
</tr>
<tr>
<td>exceptionType</td>
<td>每个指令的异常类型</td>
</tr>
<tr>
<td>foldpc</td>
<td>压缩过后的pc</td>
</tr>
<tr>
<td>ftqOffset</td>
<td>指令是否在预测块范围中</td>
</tr>
<tr>
<td>ftqPtr</td>
<td>ftq预测块在FTQ的位置</td>
</tr>
<tr>
<td>illegalInstr</td>
<td>这条指令是否为非法指令</td>
</tr>
<tr>
<td>instrs</td>
<td>拼接后的指令码</td>
</tr>
<tr>
<td>isLastInFtqEntry</td>
<td>判断该指令是否为这个预测块中最后一条有效指令的开始</td>
</tr>
<tr>
<td>pd</td>
<td>指令控制信息，包括CFI指令的类型和RVC指令的判定</td>
</tr>
<tr>
<td>triggered</td>
<td>指令是否触发前端的trigger</td>
</tr>
</tbody>
</table>
<h3 id="tobackend_gpaddrmem">toBackend_gpaddrMem</h3>
<p>这组接口在gpfault发生时使用，由IFU向gpaddrMem传递预测块指针和页错误地址。</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>waddr</td>
<td>传递ftq指针</td>
</tr>
<tr>
<td>wdata.gpaddr</td>
<td>传递出错的客户页地址</td>
</tr>
<tr>
<td>wdata.isForVSnonLeafPTE</td>
<td>指示是否为非叶PTE</td>
</tr>
<tr>
<td>wen</td>
<td>类似valid，指示gpaddrMem存在gpfault需要处理</td>
</tr>
</tbody>
</table>
<h3 id="io_csr_fsisoff">io_csr_fsIsOff</h3>
<p>指示是否使能了fs.CSR，对非法指令的判断很关键。</p>
<h3 id="rob_commits-来自rob的提交信息">rob_commits 来自ROB的提交信息</h3>
<p>共分为8个相同结构的rob_commit，包含以下成员</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>ftqIdx</td>
<td>预测块指针</td>
</tr>
<tr>
<td>ftqOffset</td>
<td>预测块的大小</td>
</tr>
</tbody>
</table>
<h3 id="pmp">pmp</h3>
<p>和物理内存保护相关，在mmio状态下重发请求时使用。</p>
<h4 id="req">req</h4>
<p>IFU向pmp发起的请求，传递前一步从ITLB查询得到的物理地址。</p>
<h4 id="resp">resp</h4>
<p>PMP给IFU的回复结果，包含以下成员</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>mmio</td>
<td>在MMIO空间</td>
</tr>
<tr>
<td>instr</td>
<td>对指令的判断结果，当指令不可执行时，该值为true</td>
</tr>
</tbody>
</table>
<h3 id="mmio_commits">mmio_commits</h3>
<h4 id="mmioftqptr">mmioFtqPtr</h4>
<p>IFU传递给FTQ的idx，用于查询上一个预测块的MMIO状态</p>
<h4 id="mmiolastcommit">mmioLastCommit</h4>
<p>上一个请求是MMIO请求</p>
<h3 id="frontendtrigger">frontendTrigger</h3>
<p>用于设置前端断点</p>
<p>包含以下成员：</p>
<h4 id="debugmode">debugMode</h4>
<p>debug的模式</p>
<h4 id="triggercanraisebpexp">triggerCanRaiseBpExp</h4>
<p>trigger是否可以引起断点异常</p>
<h4 id="tenablevec">tEnableVec</h4>
<p>信号数组，表示是否使能对应的trigger</p>
<h4 id="tupdate">tupdate</h4>
<p>表示更新的断点信息，其中包含tdata和addr，addr是请求设置的断点idx。</p>
<p>tdata包括下列成员：</p>
<table>
<thead>
<tr>
<th>接口名</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>matchType</td>
<td>断点匹配类型，等于、大于、小于</td>
</tr>
<tr>
<td>action</td>
<td>触发执行的动作</td>
</tr>
<tr>
<td>tdata2</td>
<td>触发端点的基准数值</td>
</tr>
<tr>
<td>select</td>
<td>是否选择</td>
</tr>
<tr>
<td>chain</td>
<td>是否传导</td>
</tr>
</tbody>
</table>
<h2 id="ifu功能点和测试点">IFU功能点和测试点</h2>
<h3 id="功能点1-接收ftq预测块请求">功能点1 接收FTQ预测块请求</h3>
<h4 id="功能点11-f0流水级接收请求">功能点1.1 F0流水级接收请求</h4>
<p>向FTQ报告自己已ready。</p>
<p>所以，我们只需要在发送请求后检查和ftq相关的的ready情况即可。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>ready置位</td>
<td>IFU接收FTQ请求后，设置ready</td>
</tr>
</tbody>
</table>
<h3 id="功能点2-指令切分产生初始指令码">功能点2 指令切分产生初始指令码</h3>
<h4 id="功能点21-f1流水级计算信息和切分指针">功能点2.1 F1流水级计算信息和切分指针</h4>
<p>F1流水级也会计算PC。</p>
<p>同时还需要生成17位的切分指针（也就是从拼接后的缓存行切出初始指令码的idx数组，在昆明湖架构中，计算方式为拼接00和startAddr[5:1]，
然后分别与0～16相加） 用于后续从缓存行提取初始指令码。</p>
<p>所以，首先我们需要检查F1流水级生成的PC的正确与否。如果可能，也需要检查一下切分指针的生成。</p>
<p>所以，可以总结出以下的测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1.1</td>
<td>PC生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成PC</td>
</tr>
<tr>
<td>2.1.2</td>
<td>切取指针生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成后续切取缓存行的指针</td>
</tr>
</tbody>
</table>
<h4 id="功能点22-f2流水级获取指令信息">功能点2.2 F2流水级获取指令信息</h4>
<p>包括获取异常信息、物理地址、客户物理地址、是否在MMIO空间等。</p>
<p>获取异常信息之后，还需要计算异常向量。ICache会为每个缓存行返回一个异常类型，只需要计算每个指令pc属于哪个缓存行，
然后将对应缓存行的异常类型赋给该位置即可。</p>
<p>所以，只需要分别检查几种指令信息即可。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.2.1</td>
<td>异常向量生成</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个指令的异常向量</td>
</tr>
<tr>
<td>2.2.2</td>
<td>物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个端口的物理地址。</td>
</tr>
<tr>
<td>2.2.3</td>
<td>客户物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成0号端口的客户物理地址。</td>
</tr>
<tr>
<td>2.2.4</td>
<td>MMIO空间信息提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果判断当前取指请求是否属于MMIO空间。</td>
</tr>
</tbody>
</table>
<h4 id="功能点23-f2流水级计算预测块有效指令范围">功能点2.3 F2流水级计算预测块有效指令范围</h4>
<p>指令有效范围包括两种，无跳转和有跳转的</p>
<p>无跳转的指令有效范围为当前预测块从起始地址到下一个预测块的起始地址的所有指令。</p>
<p>有跳转的指令有效范围jump_range为当前预测块的起始地址到预测块中第一个跳转指令地址（包含第一个跳转指令地址）之间的所有指令。</p>
<p>最终的指令有效范围是两者相与的结果。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.3.1</td>
<td>无跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算无跳转指令有效范围</td>
</tr>
<tr>
<td>2.3.2</td>
<td>有跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算跳转指令有效范围</td>
</tr>
</tbody>
</table>
<h4 id="功能点24-提取初始指令码">功能点2.4 提取初始指令码</h4>
<p>IFU需要将ICache返回的缓存行复制一份并拼接。然后利用上一流水级计算的idx数组，从缓存行提取17x2字节的初始指令码。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.4</td>
<td>切取初始指令码</td>
<td>IFU根据上一流水级的切取指针，从缓存行提取初始指令码。</td>
</tr>
</tbody>
</table>
<h3 id="功能点3-预译码">功能点3 预译码</h3>
<p>多数的功能都由preDecoder子模块完成，因此这里只罗列由IFU本身需要完成的功能。</p>
<h4 id="功能点31-f3流水级选取指令有效向量">功能点3.1 F3流水级选取指令有效向量</h4>
<p>由于存在跨缓存行的32位指令，IFU需要做的是，根据上一个预测块最后两字节是否为一条RVI指令的开始，从两种指令有效开始向量中，选择一种。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1.1</td>
<td>上一预测块结尾为RVC或RVI下半部分</td>
<td>上一预测块的最后2字节恰为RVC指令或RVI指令的后半部分，选择第一位为True的有效开始向量</td>
</tr>
<tr>
<td>3.1.2</td>
<td>上一预测块结尾为RVI上半部分</td>
<td>上一预测块的最后2字节为RVI，选择第一位为False的有效开始向量</td>
</tr>
</tbody>
</table>
<h3 id="功能点4-指令扩展">功能点4 指令扩展</h3>
<p>将PreDecode返回的16条指令码分别送交指令扩展其进行32位指令扩展，RVI保持不变。RVC指令根据手册规定进行扩展。
如果指令非法，则需要将原始指令填写到CSR（控制状态寄存器）中。IFU自身仅仅控制最后填写的是哪种指令。</p>
<p>所以，我们对IFU模块，只关注最后写的指令是何种指令。注意，这里可以修改fsIsOff的入参，测试c.fp指令是否返回原始指令码</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>4.1</td>
<td>合法RVC指令写扩展指令码</td>
<td>对合法RVC指令，写扩展后的指令码</td>
</tr>
<tr>
<td>4.2</td>
<td>非法RVC指令写原始指令码</td>
<td>对非法RVC指令，写原始指令码</td>
</tr>
<tr>
<td>4.3</td>
<td>RVI指令不扩展</td>
<td>RVI指令直接写入原始指令即可</td>
</tr>
</tbody>
</table>
<h3 id="功能点5-预测错误预检">功能点5 预测错误预检</h3>
<p>主要由PredChecker子模块完成。测试点和PredChecker子模块的测试点类似，IFU没有额外的测试点。预检可以和重定向一起测试。</p>
<h3 id="功能点6-前端重定向和流水线冲刷">功能点6 前端重定向和流水线冲刷</h3>
<h4 id="功能点61-预测错误重定向">功能点6.1 预测错误重定向</h4>
<p>如果发现了预检阶段检出的错误，则需要产生前端重定向，将F3以外的流水级冲刷</p>
<p>只需要构造有预测错误的预测请求，检查冲刷情况即可。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.1.1</td>
<td>JAL预测错误冲刷</td>
<td>预测请求中存在JAL预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.2</td>
<td>RET预测错误冲刷</td>
<td>预测请求中存在RET预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.3</td>
<td>非CFI预测错误冲刷</td>
<td>预测请求中存在非CFI预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.4</td>
<td>无效指令预测错误冲刷</td>
<td>预测请求中存在无效指令预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.5</td>
<td>跳转目标错误冲刷</td>
<td>预测请求中存在跳转目标错误，需要冲刷流水线</td>
</tr>
</tbody>
</table>
<h4 id="功能点62-跨预测块32位指令处理">功能点6.2 跨预测块32位指令处理</h4>
<p>如果发现当前预测块的最后两个字节是一条RVI指令的开始，则设置一个标识f3_lastHalf_valid，告诉接下来的预测块含有后半条指令。</p>
<p>我们没有办法直接观察到这个标识，但是可以通过下一预测块来判定：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.2.1</td>
<td>跨预测块32位指令处理</td>
<td>连续传入两个预测块，其中有一条32位指令跨两个预测块，后一个预测块的指令开始向量的首位应该为False</td>
</tr>
</tbody>
</table>
<p>但是，如果这一判断出现问题（比如当前预测块存在跳转），则需要进行流水线冲刷。</p>
<p>这一功能需要PredChecker子模块“配合”（仅仅通过外部IO的修改很难触发这个防御机制），实现起来比较麻烦，但是还是列举一个测试点：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.2.2</td>
<td>跨预测块指令误判</td>
<td>当IFU根据PredChecker修复的指令有效范围错判了跨预测块指令时，需要将F3以外的流水级全部冲刷</td>
</tr>
</tbody>
</table>
<h3 id="功能点7-将指令码和前端信息输出给ibuffer">功能点7 将指令码和前端信息输出给IBuffer</h3>
<h4 id="功能点71-传送指令码和前端信息">功能点7.1 传送指令码和前端信息</h4>
<p>传送给IBuffer的信息包括：经过扩展的32位指令码、16条指令中每条指令的例外信息、预译码信息、FTQ队列中的指针位置、其他后端需要的信息（经过折叠的PC）、
io_toIbuffer_bits_valid（表示指令是否是一条指令的开始）、io_toIbuffer_bits_enqEnable（前者与上被修正过的预测块指令范围，
从而还能表示指令是否在预测块表示的指令范围内）。</p>
<p>这里要做的只是确认这些信息是否正确传递</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.1.1</td>
<td>指令码传送</td>
<td>IFU向IBuffer传送扩展后的指令码</td>
</tr>
<tr>
<td>7.1.2</td>
<td>异常信息传送</td>
<td>IFU向IBuffer传送每个指令的异常信息</td>
</tr>
<tr>
<td>7.1.3</td>
<td>预译码信息传送</td>
<td>IFU向IBuffer传递每个指令的预译码信息</td>
</tr>
<tr>
<td>7.1.4</td>
<td>FTQ指针传送</td>
<td>IFU向IBuffer传送FTQ预测块的指针</td>
</tr>
<tr>
<td>7.1.5</td>
<td>折叠PC传送</td>
<td>IFU向IBuffer传送折叠的PC</td>
</tr>
<tr>
<td>7.1.6</td>
<td>有效开始向量</td>
<td>IFU向IBuffer传送表示指令有效和指令是否为指令开始的向量</td>
</tr>
</tbody>
</table>
<h4 id="功能点72-客户页错误传送gpaddr信息">功能点7.2 客户页错误传送gpaddr信息</h4>
<p>当且仅当发生guest page fault时，后端需要gpaddr信息，为了节省面积，gpaddr不走正常通路进入ibuffer，
而是随ftqPtr被发送到gpaMem，后端需要时从gpaMem读出。IFU需要保证gpf发生时通向gpaMem的valid拉高、gpaddr正确，同时还要传递预测块的ftqIdx（通过waddr传入）。</p>
<p>这里我们只需要确保在客户页错误发生时通向gpaMem的valid为高，且gpaddr正确填入。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.2</td>
<td>客户页错误</td>
<td>客户页错误发生时，IFU应将gpaMem的valid拉高且填入gpaddr</td>
</tr>
</tbody>
</table>
<h3 id="功能点8-分支预测冲刷流水线">功能点8 分支预测冲刷流水线</h3>
<p>当精确预测器发现简单预测器错误时，通知IFU取消正在进行的取指请求。</p>
<h4 id="功能点81-核验指针">功能点8.1 核验指针</h4>
<p>IFU收到BPU冲刷请求后，会将F0/F1流水级上取指令请求的指针比较，冲刷的指针在取指之前，即当前取指令请求在错误的执行路径上，才需要
冲刷IFU。</p>
<p>我们仍然需要从两个方向校验这个功能，即当冲刷指针在取指令的指针之前时，IFU能够对流水线进行冲刷。
然而，当冲刷指令在取指令的指针之后时，则不能对流水线进行冲刷。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.1.1</td>
<td>错误执行路径</td>
<td>当冲刷指针在取指令的指针之前时，IFU能够对流水线进行冲刷。</td>
</tr>
<tr>
<td>8.1.2</td>
<td>执行路径无误</td>
<td>当冲刷指令在取指令的指针之后时，IFU不能对流水线进行冲刷。</td>
</tr>
</tbody>
</table>
<h4 id="功能点82-bpu-s2流水级发现错误">功能点8.2 BPU S2流水级发现错误</h4>
<p>BPU的S2流水级发现错误时，需冲刷IFU的F0流水级</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>测试点8.2</td>
<td>BPU S2流水级发现错误</td>
<td>当BPU的S2流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0流水级进行冲刷</td>
</tr>
</tbody>
</table>
<h4 id="功能点83-bpu-s3流水级发现错误">功能点8.3 BPU S3流水级发现错误</h4>
<p>BPU的S3流水级发现错误时，需要冲刷IFU的F0和F1流水级</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>8.3</td>
<td>BPU S3流水级发现错误</td>
<td>当BPU的S3流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0和F1流水级进行冲刷</td>
</tr>
</tbody>
</table>
<h3 id="功能点9-指令信息和误预测信息写回ftq">功能点9 指令信息和误预测信息写回FTQ</h3>
<h4 id="功能点91-写回指令信息和误预测信息">功能点9.1 写回指令信息和误预测信息</h4>
<p>将指令PC、预译码信息、错误预测指令的位置、正确的跳转地址以及预测块的正确指令范围等信息写回FTQ，并传递该预测块的FTQ指针。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>9.1.1</td>
<td>写回指令PC</td>
<td>IFU的WB流水级，需要向FTQ写回指令PC</td>
</tr>
<tr>
<td>9.1.2</td>
<td>写回预译码信息</td>
<td>IFU的WB流水级，需要向FTQ写回每个指令的预译码信息</td>
</tr>
<tr>
<td>9.1.3</td>
<td>写回误预测指令位置</td>
<td>IFU的WB流水级，需要向FTQ写回BPU错误预测的指令位置</td>
</tr>
<tr>
<td>9.1.4</td>
<td>写回正确跳转地址</td>
<td>IFU的WB流水级，需要向FTQ写回该预测块的正确跳转地址</td>
</tr>
<tr>
<td>9.1.5</td>
<td>写回正确指令范围</td>
<td>IFU的WB流水级，需要向FTQ写回预测块的正确指令范围</td>
</tr>
<tr>
<td>9.1.6</td>
<td>传递预测块FTQ指针</td>
<td>IFU的WB流水级，需要向FTQ传递预测块的FTQ指针</td>
</tr>
</tbody>
</table>
<h3 id="功能点10-mmio处理">功能点10 MMIO处理</h3>
<h4 id="功能点101-上电复位处理">功能点10.1 上电复位处理</h4>
<p>处理器上电复位时，IFU需向MMIO总线发送宽度为64位的请求从flash地址空间取指令，并禁止对MMIO总线的推测执行。</p>
<p>上电的情况和正常情况其实没有任何区别，但是，上电时的MMIO请求没有任何差别，只是，第一条请求一定是MMIO，并且不需要等待。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1</td>
<td>第一条MMIO指令</td>
<td>IFU收到的第一条MMIO请求可以直接查询Instr Uncache</td>
</tr>
</tbody>
</table>
<h4 id="功能点102-向instruncache发送请求">功能点10.2 向InstrUncache发送请求</h4>
<p>在正常的处理逻辑下，如果请求地址处于MMIO地址空间，则IFU会向FTQ查询指令提交状态，IFU需要等待当前请求之前的所有请求（包括MMIO和非MMIO）提交完成，
才能向InstrUncache模块发送请求。</p>
<p>这里需要和FTQ交互，可以让FTQ模拟请求提交情况，从而测试等待情况。
如果MMIO请求之前的请求都已经提交，则也不需要等待。反之，则需要一直等待直到查询结果表明前面的指令均已提交。故设计测试点如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.2.1</td>
<td>阻塞等待提交</td>
<td>IFU收到MMIO请求后，查询FTQ，如果前面还有尚未提交的指令，持续等待</td>
</tr>
<tr>
<td>10.2.2</td>
<td>无阻塞发送请求</td>
<td>如果查到FTQ不再有未提交的指令，则IFU将指令发送给Instr Uncache</td>
</tr>
</tbody>
</table>
<h4 id="功能点103-跨总线请求处理">功能点10.3 跨总线请求处理</h4>
<p>由于MMIO不支持非对齐访问，因此当检测到的RVI指令地址[2,1]两位为b11时，64位总线无法一次传递所有指令，所以需要增加地址进行重发，再次查询ITLB。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.3.1</td>
<td>重发查询ITLB</td>
<td>遇到一次无法查询完毕的RVI指令时，需要向ITLB查询获得新增指令的物理地址</td>
</tr>
</tbody>
</table>
<p>如果存在异常，则直接将指令和异常信息发送到IBuffer并等待，否则向PMP发送请求。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.3.2.1</td>
<td>ITLB异常</td>
<td>IFU查询ITLB出现异常时，应当将异常信息发送到IBuffer，然后等待ROB提交完成</td>
</tr>
<tr>
<td>10.3.2.2</td>
<td>ITLB返回物理地址</td>
<td>IFU查询ITLB正常返回物理地址时，IFU继续向PMP请求检查</td>
</tr>
</tbody>
</table>
<p>根据pmp_recheck的结果，如果和上一次请求状态不一致，则说明存在访问错误，
为访问异常，不然则根据PMP的回复结果决定是否存在异常。如存在异常（访问异常和其他异常），则将报错信息发送给IBuffer并等待。如无异常，重新向InstrUncache模块
发送请求。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.3.3.1</td>
<td>请求状态不一致</td>
<td>IFU检查PMP之后如果发现重发请求状态和上一条请求状态不一致，是访问异常，需要将异常直接发送到IBuffer</td>
</tr>
<tr>
<td>10.3.3.2</td>
<td>PMP检查异常</td>
<td>PMP检查出现异常的情况下，也需要将异常直接发送到IBuffer并等待ROB提交。</td>
</tr>
<tr>
<td>10.3.3.3</td>
<td>Instr Cache请求重发</td>
<td>PMP检查若无异常，则向Instr Uncache发送请求获取指令码的后半部分。</td>
</tr>
</tbody>
</table>
<h4 id="功能点104-向ibuffer发送指令">功能点10.4 向IBuffer发送指令</h4>
<p>IFU获得完整数据之后，根据地址从64位数据中截取指令码，并以每个预测块一条指令的形式发送到Ibuffer。等待ROB返回指令已提交的信号。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.4</td>
<td>向IBuffer发送指令</td>
<td>IFU在获得完整数据后，截取获得指令码，以每个预测块一条指令的形式发送给IBuffer</td>
</tr>
</tbody>
</table>
<h4 id="功能点105-指令冲刷">功能点10.5 指令冲刷</h4>
<p>CFI指令的冲刷由后端发送给FTQ完成。所以不需要在这里设置测试点。</p>
<p>顺序指令由IFU复用前端重定向通路刷新流水线，并复用FTQ写回机制，将该指令当作误预测指令冲刷，重定向到+2或+4的位置。</p>
<p>+2和+4是由RVC和RVI指令决定的，所以设置测试点如下：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.5.1</td>
<td>RVI指令重定向</td>
<td>如果是RVI指令，传递给FTQ的冲刷请求应该重定向到PC+4</td>
</tr>
<tr>
<td>10.5.2</td>
<td>RVC指令重定向</td>
<td>如果是RVC指令，传递给FTQ的冲刷请求应该重定向到PC+2</td>
</tr>
</tbody>
</table>
<h4 id="功能点11-硬件断点">功能点11 硬件断点</h4>
<p>该功能主要由FrontEndTrigger子模块完成。不需要为这一功能额外设置测试点（参照FrontendTrigger的测试点即可）</p>
<h4 id="a-idifu_functions测试点汇总-a"><strong><a id="ifu_functions">测试点汇总 </a></strong></h4>
<table>
<thead>
<tr>
<th>序号</th>
<th>功能</th>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>接收FTQ预测块请求</td>
<td>ready置位</td>
<td>IFU接收FTQ请求后，设置ready</td>
</tr>
<tr>
<td>2.1.1</td>
<td>F1流水级计算信息和切分指针</td>
<td>PC生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成PC</td>
</tr>
<tr>
<td>2.1.2</td>
<td>F1流水级计算信息和切分指针</td>
<td>切取指针生成</td>
<td>IFU接收FTQ请求后，在F1流水级生成后续切取缓存行的指针</td>
</tr>
<tr>
<td>2.2.1</td>
<td>F2流水级获取指令信息</td>
<td>异常向量生成</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个指令的异常向量</td>
</tr>
<tr>
<td>2.2.2</td>
<td>F2流水级获取指令信息</td>
<td>物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成属于每个端口的物理地址。</td>
</tr>
<tr>
<td>2.2.3</td>
<td>F2流水级获取指令信息</td>
<td>客户物理地址提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果生成0号端口的客户物理地址。</td>
</tr>
<tr>
<td>2.2.4</td>
<td>F2流水级获取指令信息</td>
<td>MMIO空间信息提取</td>
<td>IFU接收ICache内容后，会根据ICache的结果判断当前取指请求是否属于MMIO空间。</td>
</tr>
<tr>
<td>2.3.1</td>
<td>F2流水级计算预测块有效指令范围</td>
<td>无跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算无跳转指令有效范围</td>
</tr>
<tr>
<td>2.3.2</td>
<td>F2流水级计算预测块有效指令范围</td>
<td>有跳转指令有效范围生成</td>
<td>IFU根据FTQ请求，计算跳转指令有效范围</td>
</tr>
<tr>
<td>2.4</td>
<td>提取初始指令码</td>
<td>切取初始指令码</td>
<td>IFU根据上一流水级的切取指针，从缓存行提取初始指令码。</td>
</tr>
<tr>
<td>3.1.1</td>
<td>F3流水级选取指令有效向量</td>
<td>上一预测块结尾为RVC或RVI下半部分</td>
<td>上一预测块的最后2字节恰为RVC指令或RVI指令的后半部分，选择第一位为True的有效开始向量</td>
</tr>
<tr>
<td>3.1.2</td>
<td>F3流水级选取指令有效向量</td>
<td>上一预测块结尾为RVI上半部分</td>
<td>上一预测块的最后2字节为RVI，选择第一位为False的有效开始向量</td>
</tr>
<tr>
<td>4.1</td>
<td>指令扩展</td>
<td>合法RVC指令写扩展指令码</td>
<td>对合法RVC指令，写扩展后的指令码</td>
</tr>
<tr>
<td>4.2</td>
<td>指令扩展</td>
<td>非法RVC指令写原始指令码</td>
<td>对非法RVC指令，写原始指令码</td>
</tr>
<tr>
<td>4.3</td>
<td>指令扩展</td>
<td>RVI指令不扩展</td>
<td>RVI指令直接写入原始指令即可</td>
</tr>
<tr>
<td>6.1.1</td>
<td>预测错误重定向</td>
<td>JAL预测错误冲刷</td>
<td>预测请求中存在JAL预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.2</td>
<td>预测错误重定向</td>
<td>RET预测错误冲刷</td>
<td>预测请求中存在RET预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.3</td>
<td>预测错误重定向</td>
<td>非CFI预测错误冲刷</td>
<td>预测请求中存在非CFI预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.4</td>
<td>预测错误重定向</td>
<td>无效指令预测错误冲刷</td>
<td>预测请求中存在无效指令预测错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.1.5</td>
<td>预测错误重定向</td>
<td>跳转目标错误冲刷</td>
<td>预测请求中存在跳转目标错误，需要冲刷流水线</td>
</tr>
<tr>
<td>6.2.1</td>
<td>跨预测块32位指令处理</td>
<td>跨预测块32位指令处理</td>
<td>连续传入两个预测块，其中有一条32位指令跨两个预测块，后一个预测块的指令开始向量的首位应该为False</td>
</tr>
<tr>
<td>6.2.2</td>
<td>跨预测块32位指令处理</td>
<td>跨预测块指令误判</td>
<td>当IFU根据PredChecker修复的指令有效范围错判了跨预测块指令时，需要将F3以外的流水级全部冲刷</td>
</tr>
<tr>
<td>7.1.1</td>
<td>传送指令码和前端信息</td>
<td>指令码传送</td>
<td>IFU向IBuffer传送扩展后的指令码</td>
</tr>
<tr>
<td>7.1.2</td>
<td>传送指令码和前端信息</td>
<td>异常信息传送</td>
<td>IFU向IBuffer传送每个指令的异常信息</td>
</tr>
<tr>
<td>7.1.3</td>
<td>传送指令码和前端信息</td>
<td>预译码信息传送</td>
<td>IFU向IBuffer传递每个指令的预译码信息</td>
</tr>
<tr>
<td>7.1.4</td>
<td>传送指令码和前端信息</td>
<td>FTQ指针传送</td>
<td>IFU向IBuffer传送FTQ预测块的指针</td>
</tr>
<tr>
<td>7.1.5</td>
<td>传送指令码和前端信息</td>
<td>折叠PC传送</td>
<td>IFU向IBuffer传送折叠的PC</td>
</tr>
<tr>
<td>7.1.6</td>
<td>传送指令码和前端信息</td>
<td>有效开始向量</td>
<td>IFU向IBuffer传送表示指令有效和指令是否为指令开始的向量</td>
</tr>
<tr>
<td>7.2</td>
<td>客户页错误传送gpaddr信息</td>
<td>客户页错误</td>
<td>客户页错误发生时，IFU应将gpaMem的valid拉高且填入gpaddr</td>
</tr>
<tr>
<td>8.1.1</td>
<td>核验指针</td>
<td>错误执行路径</td>
<td>当冲刷指针在取指令的指针之前时，IFU能够对流水线进行冲刷。</td>
</tr>
<tr>
<td>8.1.2</td>
<td>核验指针</td>
<td>执行路径无误</td>
<td>当冲刷指令在取指令的指针之后时，IFU不能对流水线进行冲刷。</td>
</tr>
<tr>
<td>8.2</td>
<td>BPU S2流水级发现错误</td>
<td>BPU S2流水级发现错误</td>
<td>当BPU的S2流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0流水级进行冲刷</td>
</tr>
<tr>
<td>8.3</td>
<td>BPU S2流水级发现错误</td>
<td>BPU S3流水级发现错误</td>
<td>当BPU的S3流水级出现错误，并且当前取指指针在错误执行路径上时，需要对IFU的F0和F1流水级进行冲刷</td>
</tr>
<tr>
<td>9.1.1</td>
<td>写回指令信息和误预测信息</td>
<td>写回指令PC</td>
<td>IFU的WB流水级，需要向FTQ写回指令PC</td>
</tr>
<tr>
<td>9.1.2</td>
<td>写回指令信息和误预测信息</td>
<td>写回预译码信息</td>
<td>IFU的WB流水级，需要向FTQ写回每个指令的预译码信息</td>
</tr>
<tr>
<td>9.1.3</td>
<td>写回指令信息和误预测信息</td>
<td>写回误预测指令位置</td>
<td>IFU的WB流水级，需要向FTQ写回BPU错误预测的指令位置</td>
</tr>
<tr>
<td>9.1.4</td>
<td>写回指令信息和误预测信息</td>
<td>写回正确跳转地址</td>
<td>IFU的WB流水级，需要向FTQ写回该预测块的正确跳转地址</td>
</tr>
<tr>
<td>9.1.5</td>
<td>写回指令信息和误预测信息</td>
<td>写回指令范围</td>
<td>IFU的WB流水级，需要向FTQ写回预测块的正确指令范围</td>
</tr>
<tr>
<td>9.1.6</td>
<td>写回指令信息和误预测信息</td>
<td>传递预测块FTQ指针</td>
<td>IFU的WB流水级，需要向FTQ传递预测块的FTQ指针</td>
</tr>
<tr>
<td>10.1</td>
<td>上电复位处理</td>
<td>第一条MMIO指令</td>
<td>IFU收到的第一条MMIO请求可以直接查询Instr Uncache</td>
</tr>
<tr>
<td>10.2.1</td>
<td>向InstrUncache发送请求</td>
<td>阻塞等待提交</td>
<td>IFU收到MMIO请求后，查询FTQ，如果前面还有尚未提交的指令，持续等待</td>
</tr>
<tr>
<td>10.2.2</td>
<td>向InstrUncache发送请求</td>
<td>无阻塞发送请求</td>
<td>如果查到FTQ不再有未提交的指令，则IFU将指令发送给Instr Uncache</td>
</tr>
<tr>
<td>10.3.1</td>
<td>跨总线请求处理</td>
<td>重发查询ITLB</td>
<td>遇到一次无法查询完毕的RVI指令时，需要向ITLB查询获得新增指令的物理地址</td>
</tr>
<tr>
<td>10.3.2.1</td>
<td>跨总线请求处理</td>
<td>ITLB异常</td>
<td>IFU查询ITLB出现异常时，应当将异常信息发送到IBuffer，然后等待ROB提交完成</td>
</tr>
<tr>
<td>10.3.2.2</td>
<td>跨总线请求处理</td>
<td>ITLB返回物理地址</td>
<td>IFU查询ITLB正常返回物理地址时，IFU继续向PMP请求检查</td>
</tr>
<tr>
<td>10.3.3.1</td>
<td>跨总线请求处理</td>
<td>请求状态不一致</td>
<td>IFU检查PMP之后如果发现重发请求状态和上一条请求状态不一致，是访问异常，需要将异常直接发送到IBuffer</td>
</tr>
<tr>
<td>10.3.3.2</td>
<td>跨总线请求处理</td>
<td>PMP检查异常</td>
<td>PMP检查出现异常的情况下，也需要将异常直接发送到IBuffer并等待ROB提交。</td>
</tr>
<tr>
<td>10.3.3.3</td>
<td>跨总线请求处理</td>
<td>Instr Cache请求重发</td>
<td>PMP检查若无异常，则向Instr Uncache发送请求获取指令码的后半部分。</td>
</tr>
<tr>
<td>10.4</td>
<td>向IBuffer发送指令</td>
<td>向IBuffer发送指令</td>
<td>IFU在获得完整数据后，截取获得指令码，以每个预测块一条指令的形式发送给IBuffer</td>
</tr>
<tr>
<td>10.5.1</td>
<td>指令冲刷</td>
<td>RVI指令重定向</td>
<td>如果是RVI指令，传递给FTQ的冲刷请求应该重定向到PC+4</td>
</tr>
<tr>
<td>10.5.2</td>
<td>指令冲刷</td>
<td>RVC指令重定向</td>
<td>如果是RVC指令，传递给FTQ的冲刷请求应该重定向到PC+2</td>
</tr>
<tr>
<td>11.1.1</td>
<td>断点设置和检查</td>
<td>select1判定</td>
<td>给定tdata1的select位为1，随机构造其它输入，检查断点是否没有触发</td>
</tr>
<tr>
<td>11.1.2.1</td>
<td>断点设置和检查</td>
<td>select0关系匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>11.1.2.2</td>
<td>断点设置和检查</td>
<td>select0关系不匹配判定</td>
<td>给定tdata1的select位为0，构造PC与tdata2数据的关系同tdata2的match位不匹配的输入，检查断点是否触发</td>
</tr>
<tr>
<td>11.2.1</td>
<td>链式断点</td>
<td>chain位测试</td>
<td>对每个trigger，在满足PC断点触发条件的情况下，设置chain位，检查断点是否一定不触发</td>
</tr>
<tr>
<td>11.2.2</td>
<td>链式断点</td>
<td>timing测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，且两trigger的timing位不同，随机设置PC等，测试后一个trigger是否一定不触发</td>
</tr>
<tr>
<td>11.2.3.1</td>
<td>链式断点</td>
<td>未命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，且两trigger的timing位相同，设置后一个trigger命中而前一个未命中，检查后一个trigger是否一定不触发</td>
</tr>
<tr>
<td>11.2.3.2</td>
<td>链式断点</td>
<td>命中测试</td>
<td>对两个trigger，仅设置前一个trigger的chain位，且两trigger的timing位相同且均命中，检查后一个trigger是否触发</td>
</tr>
</tbody>
</table>
</div>
  <div class="section-index">
    
    
    <hr class="panel-line">
        <div class="entry">
                <h5>
                    <a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/02_f3predecoder/">F3PreDecoder</a>
                </h5>
                <p></p>
            </div>
        <div class="entry">
                <h5>
                    <a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/05_frontend_trigger/">FrontendTrigger</a>
                </h5>
                <p></p>
            </div>
        <div class="entry">
                <h5>
                    <a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/04_pred_checker/">PredChecker</a>
                </h5>
                <p></p>
            </div>
        <div class="entry">
                <h5>
                    <a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/01_predecode/">PreDecode</a>
                </h5>
                <p></p>
            </div>
        <div class="entry">
                <h5>
                    <a href="/UnityChipForXiangShan/docs/98_ut/01_frontend/01_ifu/03_ifu_rvc_exp/">RVCExpander</a>
                </h5>
                <p></p>
            </div>
        </div>
<div class="td-page-meta__lastmod">
  最后修改 March 11, 2025: <a href="https://github.com/XS-MLVP/UnityChipForXiangShan/documents/commit/6fee10b560dba2a7050d6e3653dca351995031f1">add doc format options (#88) (6fee10b)</a>
</div>
</div>

          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">BOSC</span></span><span class="td-footer__all_rights_reserved">保留所有权利</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/UnityChipForXiangShan/js/main.min.37d14e870feb76f0f7a2a2422bae231efb0186c477999a4ab9ca7e9924ced592.js" integrity="sha256-N9FOhw/rdvD3oqJCK64jHvsBhsR3mZpKucp&#43;mSTO1ZI=" crossorigin="anonymous"></script>
<script src='/UnityChipForXiangShan/js/prism.js'></script>
<script src='/UnityChipForXiangShan/js/tabpane-persist.js'></script>

  </body>
</html>