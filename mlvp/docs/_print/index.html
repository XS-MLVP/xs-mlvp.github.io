<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://open-verify.cc/mlvp/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://open-verify.cc/mlvp/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/mlvp/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/mlvp/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/mlvp/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/mlvp/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-192x192.png" sizes="192x192">

<title>学习资源 | 开放验证平台学习资源</title>
<meta name="description" content="本学习资源介绍验证相关的基本概念、技术，以及如何使用本项目提供的开源工具进行芯片验证
学习本材料前，假定您已经拥有linux、python等相关基础知识。
相关学习材料：
《Linux 101》在线讲义 Python官方教程 Javatpoint上的Git基础 若计划参与本平台上发布的“开源开放验证项目”，建议提前完本材料的学习。">
<meta property="og:url" content="https://open-verify.cc/mlvp/docs/">
  <meta property="og:site_name" content="开放验证平台学习资源">
  <meta property="og:title" content="学习资源">
  <meta property="og:description" content="本学习资源介绍验证相关的基本概念、技术，以及如何使用本项目提供的开源工具进行芯片验证
学习本材料前，假定您已经拥有linux、python等相关基础知识。
相关学习材料：
《Linux 101》在线讲义 Python官方教程 Javatpoint上的Git基础 若计划参与本平台上发布的“开源开放验证项目”，建议提前完本材料的学习。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="学习资源">
  <meta itemprop="description" content="本学习资源介绍验证相关的基本概念、技术，以及如何使用本项目提供的开源工具进行芯片验证
学习本材料前，假定您已经拥有linux、python等相关基础知识。
相关学习材料：
《Linux 101》在线讲义 Python官方教程 Javatpoint上的Git基础 若计划参与本平台上发布的“开源开放验证项目”，建议提前完本材料的学习。">
  <meta itemprop="dateModified" content="2025-10-28T20:13:02+08:00">
  <meta itemprop="wordCount" content="8">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="学习资源">
  <meta name="twitter:description" content="本学习资源介绍验证相关的基本概念、技术，以及如何使用本项目提供的开源工具进行芯片验证
学习本材料前，假定您已经拥有linux、python等相关基础知识。
相关学习材料：
《Linux 101》在线讲义 Python官方教程 Javatpoint上的Git基础 若计划参与本平台上发布的“开源开放验证项目”，建议提前完本材料的学习。">
<link rel="preload" href="/mlvp/scss/main.min.3bb6570761fbbb25e6691001febc67f331f0953db4e4e1cfb79172c2e6a5819e.css" as="style" integrity="sha256-O7ZXB2H7uyXmaRAB/rxn8zHwlT205OHPt5FywualgZ4=" crossorigin="anonymous">
<link href="/mlvp/scss/main.min.3bb6570761fbbb25e6691001febc67f331f0953db4e4e1cfb79172c2e6a5819e.css" rel="stylesheet" integrity="sha256-O7ZXB2H7uyXmaRAB/rxn8zHwlT205OHPt5FywualgZ4=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/mlvp/css/prism.css"/>

    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4Z2ZY6ZE84');
    </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />

<script>
    $(document).ready(function() {
        $('a[name="multi-lang-toggle"]').on('click', function(event) {
            var language = $(this).attr('lang');
            var codeDiv = $(this).closest('.highlight');
            var preNodes = codeDiv.find('pre');
            preNodes.each(function(index, preNode) {
                if ($(preNode).attr("name").toLowerCase().indexOf(language.toLowerCase()) !== -1) {
                    preNode.style.display = 'block';
                } else {
                    preNode.style.display = 'none';
                }
            });
            var alist = codeDiv.find('a[name="multi-lang-toggle"]');
            alist.each(function(index, aNode) {
                if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                    aNode.style.fontWeight = 'bold';
                } else {
                    aNode.style.fontWeight = 'normal';
                }
            });
        })
        $(this).find('pre[name^="group-lang-code-"]').each(function(index, preNode) {
            if (preNode.style.display !== 'none') {
                var language = $(preNode).attr("name").replace('group-lang-code-', '');
                var alist = $(this).closest('.highlight').find('a[name="multi-lang-toggle"]');
                alist.each(function(index, aNode) {
                    if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                        aNode.style.fontWeight = 'bold';
                    } else {
                        aNode.style.fontWeight = 'normal';
                    }
                });
            }
        });
    });
</script>
    
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/mlvp/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">开放验证平台学习资源</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/mlvp/en/docs/">English</a></li>
    </ul>
</div></li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="站内搜索…"
    aria-label="站内搜索…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/mlvp/offline-search-index.6de4b99d520f594cab5024ab22c3e2c8.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/mlvp/docs/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">学习资源</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-6546478d87b4368b79e83eb0e32c466c">快速开始</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-4d867707798ab2157e2ebf55f2ff5ecf">搭建验证环境</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-ed0dac32f7bc588e473d2d5d54f6678e">案例一：简单加法器</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-c05bb6c77ec711a62c2f3e22fed11380">案例二：随机数生成器</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-8754821d205ce3dd872f355001bd1199">案例三：双端口栈（回调）</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-8b6f24fda4c11d593a6c671bbe7427ce">案例四：双端口栈（协程）</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-7351c618ae63b98e5898f0913a6c55f5">基础工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-ea0963a557e19f6f121695eff48e4632">工具介绍</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-f3644e5a33edc980188913395528ef79">波形生成</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-5e24b3d167d3b33da0ef1cb2f151ba27">多文件输入</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-625b33435a15ffee912f47c5443ffc13">覆盖率统计</a></li>


    
  
    
    
	
<li>2.5: <a href="#pg-23517bcdab7f12a802c8349bb10fd62e">多时钟</a></li>


    
  
    
    
	
<li>2.6: <a href="#pg-7f6542656fa3ae5b8529f1bb909b3e00">多实例</a></li>


    
  
    
    
	
<li>2.7: <a href="#pg-5d14fb48f09c8e7b39f81cc2a6999931">内部信号</a></li>


    
  
    
    
	
<li>2.8: <a href="#pg-a2e75c30d9ecce2bb906ec293eb6678e">集成测试框架</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.8.1: <a href="#pg-59e8c01d61d7cbb458b1aedd8931a8d4">PyTest</a></li>


    
  
    
    
	
<li>2.8.2: <a href="#pg-e228270a25eab6e1035925a8e92bf6f0">Hypothesis</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-60a985e164b2bc20af6e01e35f5b2af0">验证基础</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-13bda523e6e63f16e87df4b0401a9d7f">芯片验证</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-d3cde34a1f60a51b0990066a7b5fc0c9">数字电路</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-f9d4c1f404f62253b519fd8af17d8389">创建DUT</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-82b31af9e0ee05c3d251234b764020ed">DUT验证</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-9677ff4fee20856211cd5ff4272fe758">验证报告</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-9bbc770803b9bc1e63b3586d9d27b4a2">高级案例</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-def016dedd85ad313b8a6618f0995331">完整果壳 Cache 验证</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-ddd72ebc8a861fa48194266f6ffaaf60">TileLink 协议</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-3116bc87ca15222db8a1ea63529f340c">验证框架</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-465ae94d8a227578b663e5f9d84233ab">(AI)验证智能体</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-74e4e4ada00d6610843bbbd117f4cd16">工具介绍</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-6d7ccde5388a9664f923cf6de9f5e2d0">使用</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.2.1: <a href="#pg-4c2f0764b1448b4485db5bdc8abbc971">MCP集成模式（推荐）</a></li>


    
  
    
    
	
<li>6.2.2: <a href="#pg-7735a0965a81b3fff45d8f9c0238a813">直接使用模式</a></li>


    
  
    
    
	
<li>6.2.3: <a href="#pg-fbd7beae096d8cd3a81879ce0d6d9759">人机协同验证</a></li>


    
  
    
    
	
<li>6.2.4: <a href="#pg-56fd437efd30e85d1af55e127ea86585">参数说明</a></li>


    
  
    
    
	
<li>6.2.5: <a href="#pg-5fdb5ae128eebcc1e92c02708d6ec432">TUI</a></li>


    
  
    
    
	
<li>6.2.6: <a href="#pg-496947e48f69f9f9e929fe92771d84e0">FAQ</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.3: <a href="#pg-123be64371eca729c53f6175259c146a">工作流</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-f2c9a60e5e9f300f565a6d475173df02">定制功能</a></li>


    
  
    
    
	
<li>6.5: <a href="#pg-41ee5298b8c6094ee5f1fde353978dbe">工具列表</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-636f24d07e5c63a708ce945a0d50c36c">多语言支持</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-53c158edebe1befb67901d2b20c2f954">验证接口</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-57d72ed5388a70f688d60bc387d15b92">验证案例</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.2.1: <a href="#pg-50973acd0ef39be0a54f167be428bdba">加法器</a></li>


    
  
    
    
	
<li>7.2.2: <a href="#pg-fccab6f4706bebc2fd1fa8ce99a21cc1">CoupledL2</a></li>


    
  

    </ul>
    
  

    </ul>
    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>本学习资源介绍验证相关的基本概念、技术，以及如何使用本项目提供的开源工具进行芯片验证</p>

</div>

<p><strong><span style="color:red;">学习本材料前，假定您已经拥有linux、python等相关基础知识。</span></strong></p>
<p>相关学习材料：</p>
<ol>
<li><a href="https://101.ustclug.org/" target="_blank">《Linux 101》在线讲义</a></li>
<li><a href="https://docs.python.org/3/tutorial/index.html" target="_blank">Python官方教程</a></li>
<li><a href="https://www.javatpoint.com/git" target="_blank">Javatpoint上的Git基础</a></li>
</ol>
<p>若计划参与本平台上发布的“开源开放验证项目”，建议提前完本材料的学习。</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6546478d87b4368b79e83eb0e32c466c">1 - 快速开始</h1>
    <div class="lead">如何使用开放验证平台的环境参与到硬件验证中来。</div>
	

<div class="pageinfo pageinfo-primary">
<p>在开始前本页会 简单的介绍什么是验证，以及示例里面用到的概念，如 DUT (Design Under Test) 和 RM (Reference Model) 。</p>

</div>

<h3 id="芯片验证">芯片验证</h3>
<p>芯片验证是确保芯片设计正确性和可靠性的重要环节，主要包括功能验证、形式验证和物理验证等形式，本学习材料仅仅包含对功能验证的介绍，且侧重于基于仿真器的芯片功能验证。芯片功能验证的流程和方法与软件测试有比较大的共同点，例如都有单元测试、系统测试、黑盒测试、白盒测试等。在验证指标上也有共同特点，例如功能覆盖率、代码覆盖率等等。从某种形式上说，除了使用的工具和编程语言不一样外，他们的目标和流程几乎相同。<strong>因此，在不考虑工具和编程语言的情况下，会软件测试的工程师应当就会芯片验证。</strong> 但在实际工作中，软件测试和芯片验证属于两个完全不相交的行业，其主要原因是验证工具和验证语言的不同，导致软件测试工程师很难实现跨界。在芯片验证领域，通常使用硬件描述语言进行验证（例如 Verilog 或者 System Verilog），使用专业商业工具进行电路仿真。硬件描述语言不同于C++/Python等高级软件编程语言，具有独特的“时钟”特性，对于软件领域的工程师不友好，学习成本高。</p>
<p><strong>为了打通芯片验证与传统软件测试之间的壁垒，让更多的人参与到芯片验证，本项目提供如下内容：</strong></p>
<blockquote><p>
多语言验证工具（Picker），让用户可以使用自己擅长的编程语言进行芯片验证
<p>验证框架（toffee），如何在不关心时钟的情况下进行功能验证</p>
<p>介绍基本电路、验证知识，方便软件背景爱好者更能容易的理解电路特征</p>
<p>提供基本学习材料，学习基本验证知识</p>
<p>提供真实高性能芯片验证案例，让爱好者可以远程参与验证工作</p>
</blockquote></p>
<h3 id="基本术语">基本术语</h3>
<p><strong>DUT：</strong> DUT（Design Under Test）指待测试设计，通常指设计好的RTL代码。</p>
<p><strong>RM：</strong> Reference Model （RM）指代待测试单元对应的参考模型，参考模型通常被认为是标准的，没有错误的。</p>
<p><strong>RTL：</strong> 指寄存器传输级（Register Transfer Level），通常指代芯片设计对应的 verilog 或者 vhdl 代码。</p>
<p><strong>覆盖率：</strong> 测试覆盖率是指测试范围与整个需求范围的百分比。在芯片验证领域，通常有代码行覆盖率、函数覆盖率、功能覆盖率等。</p>
<p><strong>DV：</strong> DV中的D通常指设计（Desgin），V指验证（Verification）。合在一起指设计与验证协同工作。</p>
<p><strong>差分测试（difftest）：</strong> 选取两个（或以上）功能相同的被测对象，选取符合被测对象要求的同一测试用例分别提交被测对象进行执行，以观测执行结果是否存在差异的过程。</p>
<h3 id="工具介绍">工具介绍</h3>
<p>本学习材料用到的核心工具为 picker （<a href="https://github.com/XS-MLVP/picker">https://github.com/XS-MLVP/picker</a>），它的作用是将RTL编写的设计模块自动提供高级编程语言接口（Python/C++等）。基于该工具，软件开发（测试）背景的验证人员可以不用去学习 Verilog/VHDL 等硬件描述语言进行芯片验证。</p>
<h3 id="系统需求">系统需求</h3>
<p>建议操作系统：Ubuntu 22.04 LTS</p>
<blockquote><p>
在系统结构开发、科研的过程中，Linux 是最为常用的平台，这主要是因为 Linux 拥有丰富的软件、工具资源：由于 Linux 的开源性，各大重要工具软件（如 Verilator）可以很容易地面向 Linux 进行开发。
在本课程的实验中，多语言验证工具Picker、Swig等工具都可以在 Linux 上稳定运行。
</blockquote></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4d867707798ab2157e2ebf55f2ff5ecf">1.1 - 搭建验证环境</h1>
    <div class="lead">安装相关依赖，<strong>下载、构建并安装</strong>对应的工具。</div>
	<h2 id="源码安装picker工具">源码安装Picker工具</h2>
<h3 id="依赖安装">依赖安装</h3>
<ol>
<li><a href="https://cmake.org/download/">cmake</a> ( &gt;=3.11 )</li>
<li><a href="https://gcc.gnu.org/">gcc</a> ( 支持c++20,至少为gcc版本10, <strong>建议11及以上</strong> )</li>
<li><a href="https://www.python.org/downloads/">python3</a> ( &gt;=3.8 )</li>
<li><a href="https://verilator.org/guide/latest/install.html#git-quick-install">verilator</a> ( <strong>&gt;=4.218</strong> )</li>
<li><a href="https://github.com/chipsalliance/verible">verible-verilog-format</a> ( &gt;=0.0-3428-gcfcbb82b )</li>
<li><a href="http://www.swig.org/">swig</a> ( &gt;=<strong>4.2.0</strong>, 用于多语言支持 )</li>
</ol>
<blockquote>
<p>请注意，请确保<code>verible-verilog-format</code>等工具的路径已经添加到环境变量<code>$PATH</code>中，可以直接命令行调用。</p></blockquote>
<h3 id="下载源码">下载源码</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/XS-MLVP/picker.git --depth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> picker
</span></span><span style="display:flex;"><span>make init
</span></span></code></pre></div><h3 id="构建并安装">构建并安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> picker
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可通过 make BUILD_XSPCOMM_SWIG=python,java,scala,golang 开启其他语言支持。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 各语言需要自己的开发环境，需要自行配置，例如javac等</span>
</span></span><span style="display:flex;"><span>sudo -E make install
</span></span></code></pre></div><blockquote>
<p>默认的安装的目标路径是 <code>/usr/local</code>， 二进制文件被置于 <code>/usr/local/bin</code>，模板文件被置于 <code>/usr/local/share/picker</code>。
如果需要修改安装目录，可以通过指定ARGS给cmake传递参数，例如<code>make ARGS=&quot;-DCMAKE_INSTALL_PREFIX=your_instal_dir&quot;</code>
安装时会自动安装 <code>xspcomm</code>基础库（<a href="https://github.com/XS-MLVP/xcomm">https://github.com/XS-MLVP/xcomm</a>），该基础库是用于封装 <code>RTL</code> 模块的基础类型，位于 <code>/usr/local/lib/libxspcomm.so</code>。 <strong>可能需要手动设置编译时的链接目录参数(-L)</strong>
如果开启了Java等语言支持，还会安装 <code>xspcomm</code> 对应的多语言软件包。</p></blockquote>
<p><strong>picker也可以编译为wheel文件，通过pip安装</strong></p>
<p>通过以下命令把picker打包成wheel安装包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make wheel <span style="color:#8f5902;font-style:italic"># or BUILD_XSPCOMM_SWIG=python,java,scala,golang make wheel</span>
</span></span></code></pre></div><p>编译完成后，wheel文件位于dist目录，然后通过pip安装，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install dist/xspcomm-0.0.1-cp311-cp311-linux_x86_64.whl
</span></span><span style="display:flex;"><span>pip install dist/picker-0.0.1-cp311-cp311-linux_x86_64.whl
</span></span></code></pre></div><p>安装完成后，执行<code>picker</code>命令可以得到以下输出:</p>
<pre tabindex="0"><code>XDut Generate.
Convert DUT(*.v/*.sv) to C++ DUT libs.

Usage: ./build/bin/picker [OPTIONS] [SUBCOMMAND]

Options:
  -h,--help                   Print this help message and exit
  -v,--version                Print version
  --show_default_template_path
                              Print default template path
  --show_xcom_lib_location_cpp
                              Print xspcomm lib and include location
  --show_xcom_lib_location_java
                              Print xspcomm-java.jar location
  --show_xcom_lib_location_scala
                              Print xspcomm-scala.jar location
  --show_xcom_lib_location_python
                              Print python module xspcomm location
  --show_xcom_lib_location_golang
                              Print golang module xspcomm location
  --check                     check install location and supproted languages

Subcommands:
  export                      Export RTL Projects Sources as Software libraries such as C++/Python
  pack                        Pack UVM transaction as a UVM agent and Python class
</code></pre><h3 id="安装测试">安装测试</h3>
<p>当前picker有export和pack两个子命令。</p>
<p>export 子命令用于将RTL设计转换成其他高级编程语言对应的“库”，可以通过软件的方式进行驱动。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --help
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Export RTL Projects Sources as Software libraries such as C++/Python
</span></span><span style="display:flex;"><span>Usage: picker export [OPTIONS] file...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Positionals:
</span></span><span style="display:flex;"><span>  file TEXT ... REQUIRED      DUT .v/.sv source file, contain the top module
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>  -h,--help                   Print this help message and exit
</span></span><span style="display:flex;"><span>  --fs,--filelist TEXT ...    DUT .v/.sv source files, contain the top module, split by comma.
</span></span><span style="display:flex;"><span>                              Or use &#39;*.txt&#39; file  with one RTL file path per line to specify the file list
</span></span><span style="display:flex;"><span>  --sim TEXT [verilator]      vcs or verilator as simulator, default is verilator
</span></span><span style="display:flex;"><span>  --lang,--language TEXT:{python,cpp,java,scala,golang} [python]
</span></span><span style="display:flex;"><span>                              Build example project, default is python, choose cpp, java or python
</span></span><span style="display:flex;"><span>  --sdir,--source_dir TEXT    Template Files Dir, default is ${picker_install_path}/../picker/template
</span></span><span style="display:flex;"><span>  --sname,--source_module_name TEXT ...
</span></span><span style="display:flex;"><span>                              Pick the module in DUT .v file, default is the last module in the -f marked file
</span></span><span style="display:flex;"><span>  --tname,--target_module_name TEXT
</span></span><span style="display:flex;"><span>                              Set the module name and file name of target DUT, default is the same as source.
</span></span><span style="display:flex;"><span>                              For example, -T top, will generate UTtop.cpp and UTtop.hpp with UTtop class
</span></span><span style="display:flex;"><span>  --tdir,--target_dir TEXT    Target directory to store all the results. If it ends with &#39;/&#39; or is empty,
</span></span><span style="display:flex;"><span>                              the directory name will be the same as the target module name
</span></span><span style="display:flex;"><span>  --internal TEXT             Exported internal signal config file, default is empty, means no internal pin
</span></span><span style="display:flex;"><span>  -F,--frequency TEXT [100MHz]
</span></span><span style="display:flex;"><span>                              Set the frequency of the **only VCS** DUT, default is 100MHz, use Hz, KHz, MHz, GHz as unit
</span></span><span style="display:flex;"><span>  -w,--wave_file_name TEXT    Wave file name, emtpy mean don&#39;t dump wave
</span></span><span style="display:flex;"><span>  -c,--coverage               Enable coverage, default is not selected as OFF
</span></span><span style="display:flex;"><span>  --cp_lib,--copy_xspcomm_lib BOOLEAN [1]
</span></span><span style="display:flex;"><span>                              Copy xspcomm lib to generated DUT dir, default is true
</span></span><span style="display:flex;"><span>  -V,--vflag TEXT             User defined simulator compile args, passthrough.
</span></span><span style="display:flex;"><span>                              Eg: &#39;-v -x-assign=fast -Wall --trace&#39; || &#39;-C vcs -cc -f filelist.f&#39;
</span></span><span style="display:flex;"><span>  -C,--cflag TEXT             User defined gcc/clang compile command, passthrough. Eg:&#39;-O3 -std=c++17 -I./include&#39;
</span></span><span style="display:flex;"><span>  --verbose                   Verbose mode
</span></span><span style="display:flex;"><span>  -e,--example                Build example project, default is OFF
</span></span><span style="display:flex;"><span>  --autobuild BOOLEAN [1]     Auto build the generated project, default is true
</span></span></code></pre></div><p>pack子命令用于将UVM中的 sequence_item 转换为其他语言，然后通过TLM进行通信（目前支持Python，其他语言在开发中）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker pack --help
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Pack uvm transaction as a uvm agent and python class
</span></span><span style="display:flex;"><span>Usage: picker pack [OPTIONS] file...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Positionals:
</span></span><span style="display:flex;"><span>  file TEXT ... REQUIRED      Sv source file, contain the transaction define
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>  -h,--help                   Print this help message and exit
</span></span><span style="display:flex;"><span>  -e,--example                Generate example project based on transaction, default is OFF
</span></span><span style="display:flex;"><span>  -c,--force                  Force delete folder when the code has already generated by picker
</span></span><span style="display:flex;"><span>  -r,--rename TEXT ...        Rename transaction name in picker generate code
</span></span></code></pre></div><h4 id="参数解释">参数解释</h4>
<h5 id="export">export:</h5>
<ul>
<li><code>file TEXT ... REQUIRED</code>：必须。位置参数，DUT.v/.sv 源文件，包含顶层模块</li>
<li><code>-h,--help</code>: 可选。打印此帮助信息并退出</li>
<li><code>--fs,--filelist TEXT ...</code>: 可选。DUT .v/.sv 源文件，包含顶层模块，逗号分隔。或使用 &lsquo;*.txt&rsquo; 文件，每行指定一个 RTL 文件路径来指定文件列表</li>
<li><code>--sim TEXT [verilator]</code>: 可选。使用 vcs 或 verilator 作为模拟器，默认是 verilator</li>
<li><code>--lang,--language TEXT:{python,cpp,java,scala,golang} [python]</code>: 可选。构建示例项目，默认是 python，可选择 cpp、java 或 python</li>
<li><code>--sdir,--source_dir TEXT</code>: 可选。模板文件目录，默认是 ${picker_install_path}/../picker/template</li>
<li><code>--sname,--source_module_name TEXT ...</code>: 可选。在 DUT .v 文件中选择模块，默认是 -f 标记的文件中的最后一个模块</li>
<li><code>--tname,--target_module_name TEXT</code>: 可选。设置目标 DUT 的模块名和文件名，默认与源相同。例如，-T top 将生成 UTtop.cpp 和 UTtop.hpp，并包含 UTtop 类</li>
<li><code>--tdir,--target_dir TEXT</code>: 可选。代码生成渲染文件的目标目录，默认为DUT的模块名。如果该参数以&rsquo;/&lsquo;结尾，则在该参数指定的目录中创建以DUT模块名的子目录。</li>
<li><code>--internal TEXT</code>: 可选。导出的内部信号配置文件，默认为空，表示没有内部引脚</li>
<li><code>-F,--frequency TEXT [100MHz]</code>: 可选。设置 <strong>仅 VCS</strong> DUT 的频率，默认是 100MHz，可以使用 Hz、KHz、MHz、GHz 作为单位</li>
<li><code>-w,--wave_file_name TEXT</code>: 可选。波形文件名，空表示不导出波形</li>
<li><code>-c,--coverage</code>: 可选。启用覆盖率，默认不选择为 OFF</li>
<li><code>--cp_lib,--copy_xspcomm_lib BOOLEAN [1]</code>: 可选。将 xspcomm 库复制到生成的 DUT 目录，默认是 true</li>
<li><code>-V,--vflag TEXT</code>: 可选。用户定义的模拟器编译参数，透传。例如：&rsquo;-v -x-assign=fast -Wall &ndash;trace&rsquo; 或 &lsquo;-C vcs -cc -f filelist.f&rsquo;</li>
<li><code>-C,--cflag TEXT</code>: 可选。用户定义的 gcc/clang 编译命令，透传。例如：&rsquo;-O3 -std=c++17 -I./include&rsquo;</li>
<li><code>--verbose</code>: 可选。详细模式</li>
<li><code>-e,--example</code>: 可选。构建示例项目，默认是 OFF</li>
<li><code>--autobuild BOOLEAN [1]</code>: 可选。自动构建生成的项目，默认是 true</li>
</ul>
<p>静态多模块支持：</p>
<p>picker在生成dut_top.sv/v的封装时，可以通过<code>--sname</code>参数指定多个模块名称和对应的数量。例如在a.v和b.v设计文件中分别有模块A和B，需要DUT中有2个A，3个B，生成的模块名称为C（若不指定，默认名称为A_B），则可执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker path/a.v,path/b.v --sname A,2,B,3 --tname C
</span></span></code></pre></div><p>环境变量：</p>
<ul>
<li><code>DUMPVARS_OPTION</code>: 设置<code>$dumpvars</code>的option参数。例如<code>DUMPVARS_OPTION=&quot;+mda&quot; picker ....</code> 开启vcs中数组波形的支持。</li>
<li><code>SIMULATOR_FLAGS</code>: 传递给后端仿真器的参数。具体可参考所使用的后端仿真器文档。</li>
<li><code>CFLAGS</code>: 设置后端仿真器的<code>-cflags</code>参数。</li>
</ul>
<h5 id="pack">pack:</h5>
<ul>
<li><code>file</code>: 必需。待解析的UVM transaction文件</li>
<li><code>--example, -e</code>: 可选。根据UVM的transaction生成示例项目。</li>
<li><code>--force， -c</code>: 可选。若已存在picker根据当前transaction解析出的文件，通过该命令可强制删除该文件，并重新生成</li>
<li><code>--rename, -r</code>: 可选。配置生成文件以及生成的agent的名称，默认为transaction名。</li>
</ul>
<h3 id="测试examples">测试Examples</h3>
<p>编译完成后，在picker目录执行以下命令，进行测试：</p>
<pre tabindex="0"><code>bash example/Adder/release-verilator.sh --lang cpp
bash example/Adder/release-verilator.sh --lang python

# 默认仅开启 cpp 和 Python 支持
#   支持其他语言编译命令为：make BUILD_XSPCOMM_SWIG=python,java,scala,golang
bash example/Adder/release-verilator.sh --lang java
bash example/Adder/release-verilator.sh --lang scala
bash example/Adder/release-verilator.sh --lang golang

bash example/RandomGenerator/release-verilator.sh --lang cpp
bash example/RandomGenerator/release-verilator.sh --lang python
bash example/RandomGenerator/release-verilator.sh --lang java
</code></pre><h3 id="参考材料">参考材料</h3>
<p>如何基于picker进行芯片验证，可参考：<a href="https://open-verify.cc/mlvp/docs/">https://open-verify.cc/mlvp/docs/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ed0dac32f7bc588e473d2d5d54f6678e">1.2 - 案例一：简单加法器</h1>
    <div class="lead">基于一个简单的加法器验证展示工具的原理和使用方法，这个加法器内部是简单的组合逻辑。</div>
	<h2 id="rtl源码">RTL源码</h2>
<p>在本案例中，我们驱动一个 64 位的加法器（组合电路），其源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A verilog 64-bit full adder with carry in and carry out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">Adder</span> <span style="color:#000;font-weight:bold">#(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">parameter</span> <span style="color:#000">WIDTH</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">cout</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">cout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">}</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>该加法器包含一个 64 位的加法器，其输入为两个 64 位的数和一个进位信号，输出为一个 64 位的和和一个进位信号。</p>
<h2 id="测试过程">测试过程</h2>
<p>在测试过程中，我们将创建一个名为 Adder 的文件夹，其中包含一个 Adder.v 文件。该文件内容即为上述的 RTL 源码。</p>
<h3 id="将rtl导出为-python-module">将RTL导出为 Python Module</h3>
<h4 id="生成中间文件">生成中间文件</h4>
<p>进入 Adder 文件夹，执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --autobuild<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> Adder.v -w Adder.fst --sname Adder --tdir picker_out_adder/ --lang python -e --sim verilator
</span></span></code></pre></div><p>*注：&ndash;tdir 指定的是目标构建目录，如果该参数值为空或者以“/”结尾，picker则会自动以DUT的目标模块名创建构建目录。例如 <code>--tdir picker_out_adder</code>指定了当前目录下的picker_out_adder为构建目录，而参数<code>--tdir picker_out_adder/</code>则指定picker在当前目录picker_out_adder中创建Adder目录作为目标构建目录。</p>
<p>该命令的含义是：</p>
<ol>
<li>将 Adder.v 作为 Top 文件，并将 Adder 作为 Top Module，基于 verilator 仿真器生成动态库，生成目标语言为 Python。</li>
<li>启用波形输出，目标波形文件为Adder.fst。</li>
<li>包含用于驱动示例项目的文件(-e)，同时codegen完成后不自动编译(-autobuild=false)。</li>
<li>最终的文件输出路径是 picker_out_adder</li>
</ol>
<p>在使用该命令时，还有部分命令行参数没有使用，这些命令将在后续的章节中介绍。</p>
<p>输出的目录结构如下，<strong>请注意这部分均为中间文件</strong>，不能直接使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker_out_adder/
</span></span><span style="display:flex;"><span>└── Adder
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- Adder.v <span style="color:#8f5902;font-style:italic"># 原始的RTL源码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- Adder_top.sv <span style="color:#8f5902;font-style:italic"># 生成的Adder_top顶层封装，使用DPI驱动Adder模块的inputs和outputs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- Adder_top.v <span style="color:#8f5902;font-style:italic"># 生成的Adder_top顶层封装，因为Verdi不支持导入SV源码使用，因此需要生成一个Verilog版本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- CMakeLists.txt <span style="color:#8f5902;font-style:italic"># 用于调用仿真器编译基本的cpp class并将其打包成有裸DPI函数二进制动态库(libDPIAdder.so)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- Makefile <span style="color:#8f5902;font-style:italic"># 生成的Makefile，用于调用CMakeLists.txt，并让用户可以通过make命令编译出libAdder.so，并手动调整Makefile的配置参数。或者编译示例项目</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- cmake <span style="color:#8f5902;font-style:italic"># 生成的cmake文件夹，用于调用不同仿真器编译RTL代码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- vcs.cmake
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- verilator.cmake
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- cpp <span style="color:#8f5902;font-style:italic"># CPP example目录，包含示例代码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- CMakeLists.txt <span style="color:#8f5902;font-style:italic"># 用于将libDPIAdder.so使用基础数据类型封装为一个可直接操作的类（libUTAdder.so），而非裸DPI函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- Makefile
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- cmake
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- vcs.cmake
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- verilator.cmake
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- dut.cpp <span style="color:#8f5902;font-style:italic"># 生成的cpp UT封装，包含了对libDPIAdder.so的调用，及UTAdder类的声明及实现</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- dut.hpp <span style="color:#8f5902;font-style:italic"># 头文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- example.cpp <span style="color:#8f5902;font-style:italic"># 调用UTAdder类的示例代码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- dut_base.cpp <span style="color:#8f5902;font-style:italic"># 用于调用与驱动不同仿真器编译结果的基类，通过继承封装为统一的类，用于隐藏所有仿真器相关的代码细节。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- dut_base.hpp
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- filelist.f <span style="color:#8f5902;font-style:italic"># 多文件项目使用的其他文件列表，请查看 -f 参数的介绍。本案例中为空</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- mk
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- cpp.mk <span style="color:#8f5902;font-style:italic"># 用于控制以cpp为目标语言时的Makefile，包含控制编译示例项目（-e，example）的逻辑</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- python.mk <span style="color:#8f5902;font-style:italic"># 同上，目标语言是python</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">`</span>-- python
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- CMakeLists.txt
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- Makefile
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- cmake
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- vcs.cmake
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- verilator.cmake
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- dut.i <span style="color:#8f5902;font-style:italic"># SWIG配置文件，用于将libDPIAdder.so的基类与函数声明，依据规则用swig导出到python，提供python调用的能力</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">`</span>-- dut.py <span style="color:#8f5902;font-style:italic"># 生成的python UT封装，包含了对libDPIAdder.so的调用，及UTAdder类的声明及实现，等价于 libUTAdder.so</span>
</span></span></code></pre></div><h4 id="构建中间文件">构建中间文件</h4>
<p>进入 <code>picker_out_adder/Adder</code> 目录并执行 <code>make</code> 命令，即可生成最终的文件。</p>
<blockquote>
<p>由 <code>Makefile</code> 定义的自动编译过程流如下：</p>
<ol>
<li>通过 <code>cmake/*.cmake</code> 定义的仿真器调用脚本，编译 <code>Adder_top.sv</code> 及相关文件为 <code>libDPIAdder.so</code> 动态库。</li>
<li>通过 <code>CMakelists.txt</code> 定义的编译脚本，将 <code>libDPIAdder.so</code> 通过 <code>dut_base.cpp</code> 封装为 <code>libUTAdder.so</code> 动态库。并将1、2步产物拷贝到 <code>UT_Adder</code> 目录下。</li>
<li>通过 <code>dut_base.hpp</code> 及 <code>dut.hpp</code> 等头文件，利用 <code>SWIG</code> 工具生成封装层，并最终在 <code>UT_Adder</code> 这一目录中构建一个 Python Module。</li>
<li>如果有 <code>-e</code> 参数，则将预先定义好的 <code>example.py</code> 置于 <code>UT_Adder</code> 目录的上级目录，作为如何调用该 Python Module 的示例代码。</li>
</ol></blockquote>
<p>最终目录结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker_out_adder/
</span></span><span style="display:flex;"><span>└── Adder
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- _UT_Adder.so <span style="color:#8f5902;font-style:italic"># Swig生成的wrapper动态库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- __init__.py <span style="color:#8f5902;font-style:italic"># Python Module的初始化文件，也是库的定义文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- libDPIAdder.a <span style="color:#8f5902;font-style:italic"># 仿真器生成的库文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- libUTAdder.so <span style="color:#8f5902;font-style:italic"># 基于dut_base生成的libDPI动态库封装</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- libUT_Adder.py <span style="color:#8f5902;font-style:italic"># Swig生成的Python Module</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">`</span>-- xspcomm <span style="color:#8f5902;font-style:italic"># xspcomm基础库，固定文件夹，不需要关注</span>
</span></span></code></pre></div><h3 id="配置测试代码">配置测试代码</h3>
<blockquote>
<p>在picker_out_adder中添加 <code>example.py</code>：</p></blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成无符号随机数</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">():</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">63</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">63</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">63</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过python实现的加法器参考模型</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">reference_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">carry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">carry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">carry</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">carry</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">random_test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建DUT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 默认情况下，引脚赋值不会立马写入，而是在下一次时钟上升沿写入，这对于时序电路适用，但是Adder为组合电路，所以需要立即写入</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#   因此需要调用AsImmWrite()方法更改引脚赋值行为</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 循环测试</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">114514</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># DUT：对Adder电路引脚赋值，然后驱动组合电路 （对于时序电路，或者需要查看波形，可通过dut.Step()进行驱动）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RefreshComb</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 参考模型：计算结果</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ref_sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref_cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">reference_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 检查结果</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ref_sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;sum mismatch: 0x</span><span style="color:#4e9a06">{dut.sum.value:x}</span><span style="color:#4e9a06"> != 0x</span><span style="color:#4e9a06">{ref_sum:x}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ref_cout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cout mismatch: 0x</span><span style="color:#4e9a06">{dut.cout.value:x}</span><span style="color:#4e9a06"> != 0x</span><span style="color:#4e9a06">{ref_cout:x}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;[test </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">] a=0x</span><span style="color:#4e9a06">{</span><span style="color:#000">a</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, b=0x</span><span style="color:#4e9a06">{</span><span style="color:#000">b</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cin=0x</span><span style="color:#4e9a06">{</span><span style="color:#000">cin</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> =&gt; sum: 0x</span><span style="color:#4e9a06">{</span><span style="color:#000">ref_sum</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout: 0x</span><span style="color:#4e9a06">{</span><span style="color:#000">ref_cout</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 完成测试</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Test Passed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">random_test</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="运行测试">运行测试</h3>
<p>在 <code>picker_out_adder</code> 目录下执行 <code>python3 example.py</code> 命令，即可运行测试。在测试完成后我们即可看到 example 示例项目的输出。</p>
<pre tabindex="0"><code>[...]
[test 114507] a=0x7adc43f36682cffe, b=0x30a718d8cf3cc3b1, cin=0x0 =&gt; sum: 0x12358823834579604399, cout: 0x0
[test 114508] a=0x3eb778d6097e3a72, b=0x1ce6af17b4e9128, cin=0x0 =&gt; sum: 0x4649372636395916186, cout: 0x0
[test 114509] a=0x42d6f3290b18d4e9, b=0x23e4926ef419b4aa, cin=0x1 =&gt; sum: 0x7402657300381600148, cout: 0x0
[test 114510] a=0x505046adecabcc, b=0x6d1d4998ed457b06, cin=0x0 =&gt; sum: 0x7885127708256118482, cout: 0x0
[test 114511] a=0x16bb10f22bd0af50, b=0x5813373e1759387, cin=0x1 =&gt; sum: 0x2034576336764682968, cout: 0x0
[test 114512] a=0xc46c9f4aa798106, b=0x4d8f52637f0417c4, cin=0x0 =&gt; sum: 0x6473392679370463434, cout: 0x0
[test 114513] a=0x3b5387ba95a7ac39, b=0x1a378f2d11b38412, cin=0x0 =&gt; sum: 0x6164045699187683403, cout: 0x0
Test Passed
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c05bb6c77ec711a62c2f3e22fed11380">1.3 - 案例二：随机数生成器</h1>
    <div class="lead">基于一个16bit的LFSR随机数生成器展示工具的用法，该随机数生成器内部存在时钟信号、时序逻辑与寄存器。</div>
	<h2 id="rtl源码">RTL源码</h2>
<p>在本案例中，我们驱动一个随机数生成器，其源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">RandomGenerator</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">reset</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">seed</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">random_number</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">reset</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">lfsr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">seed</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">lfsr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">]};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">random_number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>该随机数生成器包含一个 16 位的 LFSR，其输入为一个 16 位的种子数，输出为一个 16 位的随机数。LFSR 的更新规则为：</p>
<ol>
<li>将当前的 LFSR 的最高位与次高位异或，称为new_bit。</li>
<li>将原来的 LFSR 向左平移一位，将 new_bit 放在最低位。</li>
<li>丢弃最高位。</li>
</ol>
<h2 id="测试过程">测试过程</h2>
<p>在测试过程中，我们将创建一个名为 RandomGenerator 的文件夹，其中包含一个 RandomGenerator.v 文件。该文件内容即为上述的 RTL 源码。</p>
<h3 id="将rtl构建为-python-module">将RTL构建为 Python Module</h3>
<h4 id="生成中间文件">生成中间文件</h4>
<p>进入 RandomGenerator 文件夹，执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --autobuild<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> RandomGenerator.v -w RandomGenerator.fst --sname RandomGenerator --tdir picker_out_rmg/ --lang python -e --sim verilator
</span></span></code></pre></div><p>该命令的含义是：</p>
<ol>
<li>将RandomGenerator.v作为 Top 文件，并将RandomGenerator作为 Top Module，基于 verilator 仿真器生成动态库，生成目标语言为 Python。</li>
<li>启用波形输出，目标波形文件为RandomGenerator.fst</li>
<li>包含用于驱动示例项目的文件(-e)，同时codegen完成后不自动编译(-autobuild=false)。</li>
<li>最终的文件输出路径是 picker_out_rmg</li>
</ol>
<p>输出的目录类似<a href="/mlvp/docs/quick-start/eg-adder/#%e7%94%9f%e6%88%90%e4%b8%ad%e9%97%b4%e6%96%87%e4%bb%b6">加法器验证-生成中间文件</a>，这里不再赘述。</p>
<h4 id="构建中间文件">构建中间文件</h4>
<p>进入 <code>picker_out_rmg</code> 目录并执行 make 命令，即可生成最终的文件。</p>
<blockquote>
<p>备注：其编译过程类似于 <a href="/mlvp/docs/quick-start/eg-adder/#%e6%9e%84%e5%bb%ba%e4%b8%ad%e9%97%b4%e6%96%87%e4%bb%b6">加法器验证-编译流程</a>，这里不再赘述。</p></blockquote>
<p>最终目录结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>picker_out_rmg
</span></span><span style="display:flex;"><span>└── RandomGenerator
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- RandomGenerator.fst <span style="color:#8f5902;font-style:italic"># 测试的波形文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>-- UT_RandomGenerator
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- RandomGenerator.fst.hier
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- _UT_RandomGenerator.so <span style="color:#8f5902;font-style:italic"># Swig生成的wrapper动态库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- __init__.py  <span style="color:#8f5902;font-style:italic"># Python Module的初始化文件，也是库的定义文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- libDPIRandomGenerator.a <span style="color:#8f5902;font-style:italic"># 仿真器生成的库文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- libUTRandomGenerator.so <span style="color:#8f5902;font-style:italic"># 基于dut_base生成的libDPI动态库封装</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- libUT_RandomGenerator.py <span style="color:#8f5902;font-style:italic"># Swig生成的Python Module</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- xspcomm  <span style="color:#8f5902;font-style:italic"># xspcomm基础库，固定文件夹，不需要关注</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">`</span>-- example.py <span style="color:#8f5902;font-style:italic"># 示例代码</span>
</span></span></code></pre></div><h3 id="配置测试代码">配置测试代码</h3>
<blockquote>
<p>在picker_out_rmg中创建 <code>example.py</code>：</p></blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">RandomGenerator</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 定义参考模型</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LFSR_16</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seed</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">new_bit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">new_bit</span> <span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTRandomGenerator</span><span style="color:#000;font-weight:bold">()</span>            <span style="color:#8f5902;font-style:italic"># 创建DUT </span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clk&#34;</span><span style="color:#000;font-weight:bold">)</span>                  <span style="color:#8f5902;font-style:italic"># 指定时钟引脚，初始化时钟</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">16</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic"># 生成随机种子</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">seed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">seed</span>                 <span style="color:#8f5902;font-style:italic"># 设置DUT种子</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ref</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">LFSR_16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">)</span>                   <span style="color:#8f5902;font-style:italic"># 创建参考模型用于对比</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># reset DUT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">reset</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>                   <span style="color:#8f5902;font-style:italic"># reset 信号置1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">()</span>                            <span style="color:#8f5902;font-style:italic"># 推进一个时钟周期（DUTRandomGenerator是时序电路，需要通过Step推进）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">reset</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>                   <span style="color:#8f5902;font-style:italic"># reset 信号置0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">()</span>                            <span style="color:#8f5902;font-style:italic"># 推进一个时钟周期</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">65536</span><span style="color:#000;font-weight:bold">):</span>                <span style="color:#8f5902;font-style:italic"># 循环65536次</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">()</span>                        <span style="color:#8f5902;font-style:italic"># dut 推进一个时钟周期，生成随机数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ref</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">()</span>                        <span style="color:#8f5902;font-style:italic"># ref 推进一个时钟周期，生成随机数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">random_number</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ref</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Mismatch&#34;</span>  <span style="color:#8f5902;font-style:italic"># 对比DUT和参考模型生成的随机数</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Cycle </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, DUT: </span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">random_number</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, REF: </span><span style="color:#4e9a06">{</span><span style="color:#000">ref</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">state</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 打印结果</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 完成测试</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Test Passed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>    <span style="color:#8f5902;font-style:italic"># Finish函数会完成波形、覆盖率等文件的写入</span>
</span></span></code></pre></div><h3 id="运行测试程序">运行测试程序</h3>
<p>在 <code>picker_out_rmg</code> 目录下执行 <code>python example.py</code> 即可运行测试程序。在运行完成后，若输出 <code>Test Passed</code>，则表示测试通过。完成运行后，会生成波形文件：RandomGenerator.fst，可在bash中通过以下命令进行查看。</p>
<blockquote>
<p>gtkwave RandomGenerator.fst</p></blockquote>
<p>输出示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>···
</span></span><span style="display:flex;"><span>Cycle 65529, DUT: d9ea, REF: d9ea
</span></span><span style="display:flex;"><span>Cycle 65530, DUT: b3d4, REF: b3d4
</span></span><span style="display:flex;"><span>Cycle 65531, DUT: 67a9, REF: 67a9
</span></span><span style="display:flex;"><span>Cycle 65532, DUT: cf53, REF: cf53
</span></span><span style="display:flex;"><span>Cycle 65533, DUT: 9ea6, REF: 9ea6
</span></span><span style="display:flex;"><span>Cycle 65534, DUT: 3d4d, REF: 3d4d
</span></span><span style="display:flex;"><span>Cycle 65535, DUT: 7a9a, REF: 7a9a
</span></span><span style="display:flex;"><span>Test Passed, destroy UT_RandomGenerator
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8754821d205ce3dd872f355001bd1199">1.4 - 案例三：双端口栈（回调）</h1>
    <div class="lead">双端口栈是一个拥有两个端口的栈，每个端口都支持push和pop操作。本案例以双端口栈为例，展示如何使用回调函数驱动DUT</div>
	<h2 id="双端口栈简介">双端口栈简介</h2>
<p>双端口栈是一种数据结构，支持两个端口同时进行操作。与传统单端口栈相比，双端口栈允许同时进行数据的读写操作，在例如多线程并发读写等场景下，双端口栈能够提供更好的性能。本例中，我们提供了一个简易的双端口栈实现，其源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">dual_port_stack</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">rst</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Interface 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">in0_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">in0_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">in0_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">in0_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">out0_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">out0_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">out0_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">out0_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Interface 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">in1_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">in1_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">in1_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">in1_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">out1_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">out1_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">out1_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">out1_cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Command definitions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">localparam</span> <span style="color:#000">CMD_PUSH</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#0000cf;font-weight:bold">&#39;b00</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">localparam</span> <span style="color:#000">CMD_POP</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#0000cf;font-weight:bold">&#39;b01</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">localparam</span> <span style="color:#000">CMD_PUSH_OKAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#0000cf;font-weight:bold">&#39;b10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">localparam</span> <span style="color:#000">CMD_POP_OKAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#0000cf;font-weight:bold">&#39;b11</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Stack memory and pointer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">stack_mem</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">sp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000">busy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">out0_data_reg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out1_data_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">out0_cmd_reg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out1_cmd_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000">out0_valid_reg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out1_valid_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">out0_data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out0_data_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">out0_cmd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out0_cmd_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">out0_valid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out0_valid_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">out1_data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out1_data_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">out1_cmd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out1_cmd_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">out1_valid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">out1_valid_reg</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">rst</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rst</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Interface 0 Request Handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">in0_valid</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">in0_ready</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">in0_cmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f57900">CMD_PUSH:</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out0_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">stack_mem</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">sp</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">in0_data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out0_cmd_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">CMD_PUSH_OKAY</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f57900">CMD_POP:</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out0_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out0_data_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">stack_mem</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out0_cmd_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">CMD_POP_OKAY</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out0_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">endcase</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Interface 1 Request Handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">in1_valid</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">in1_ready</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">in1_cmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f57900">CMD_PUSH:</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out1_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">stack_mem</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">sp</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">in1_data</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out1_cmd_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">CMD_PUSH_OKAY</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f57900">CMD_POP:</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out1_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out1_data_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">stack_mem</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out1_cmd_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">CMD_POP_OKAY</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">out1_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">endcase</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Interface 0 Response Handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">out0_ready</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">out0_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Interface 1 Response Handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">out1_ready</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">out1_valid_reg</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">in0_ready</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">in0_cmd</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">CMD_PUSH</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">in0_cmd</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">CMD_POP</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">busy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">in1_ready</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">in1_cmd</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">CMD_PUSH</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">in1_cmd</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">CMD_POP</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">sp</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">busy</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in0_ready</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">in0_valid</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>在该实现中，除了时钟信号(clk)和复位信号(rst)之外，还包含了两个端口的输入输出信号，它们拥有相同的接口定义。每个端口的信号含义如下：</p>
<ul>
<li>请求端口（in）
<ul>
<li><code>in_valid</code> 输入数据有效信号</li>
<li><code>in_ready</code> 输入数据准备好信号</li>
<li><code>in_data</code> 输入数据</li>
<li><code>in_cmd</code> 输入命令 （0:PUSH, 1:POP）</li>
</ul>
</li>
<li>响应端口（out）
<ul>
<li><code>out_valid</code> 输出数据有效信号</li>
<li><code>out_ready</code> 输出数据准备好信号</li>
<li><code>out_data</code> 输出数据</li>
<li><code>out_cmd</code> 输出命令 （2:PUSH_OKAY, 3:POP_OKAY）</li>
</ul>
</li>
</ul>
<p>当我们想通过一个端口对栈进行一次操作时，首先需要将需要的数据和命令写入到输入端口，然后等待输出端口返回结果。</p>
<p>具体地，如果我们想对栈进行一次 PUSH 操作。首先我们应该将需要 PUSH 的数据写入到 <code>in_data</code> 中，然后将 <code>in_cmd</code> 设置为 0，表示 PUSH 操作，并将 <code>in_valid</code> 置为 1，表示输入数据有效。接着，我们需要等待 <code>in_ready</code> 为 1，保证数据已经正确的被接收，此时 PUSH 请求已经被正确发送。</p>
<p>命令发送成功后，我们需要在响应端口等待栈的响应信息。当 <code>out_valid</code> 为 1 时，表示栈已经完成了对应的操作，此时我们可以从 <code>out_data</code> 中读取栈的返回数据（POP 操作的返回数据将会放置于此），从 <code>out_cmd</code> 中读取栈的返回命令。当读取到数据后，需要将 <code>out_ready</code> 置为 1，以通知栈正确接收到了返回信息。</p>
<p>如果两个端口的请求同时有效时，栈将会优先处理端口 0 的请求。</p>
<h2 id="构建驱动环境">构建驱动环境</h2>
<p>与案例一和案例二类似，在对双端口栈进行测试之前，我们首先需要利用 Picker 工具将 RTL 代码构建为 Python Module。在构建完成后，我们将通过 Python 脚本驱动 RTL 代码进行测试。</p>
<p>首先，创建名为 <code>dual_port_stack.v</code> 的文件，并将上述的 RTL 代码复制到该文件中，接着在相同文件夹下执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --autobuild<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> dual_port_stack.v -w dual_port_stack.fst --sname dual_port_stack --tdir picker_out_dual_port_stack/ --lang python -e --sim verilator
</span></span></code></pre></div><p>生成好的驱动环境位于 <code>picker_out_dual_port_stack</code> 文件夹中, 其中 <code>dual_port_stack</code> 为生成的 Python Module。</p>
<p>若自动编译运行过程中无错误发生，则代表环境被正确构建。</p>
<h2 id="利用回调函数驱动-dut">利用回调函数驱动 DUT</h2>
<p>在本案例中，为了测试双端口栈的功能，我们需要对其进行驱动。但你可能很快就会发现，仅仅使用案例一和案例二中的方法很难对双端口栈进行驱动。因为在此前的测试中，DUT只有一条执行逻辑，给DUT输入数据后等待DUT输出即可。</p>
<p>但双端口栈却不同，它的两个端口是两个独立的执行逻辑，在驱动中，这两个端口可能处于完全不同的状态，例如端口0在等待DUT返回数据时，端口1有可能正在发送新的请求。这种情况下，使用简单的串行执行逻辑将很难对DUT进行驱动。</p>
<p>因此我们在本案例中我们将以双端口栈为例，介绍一种基于回调函数的驱动方法，来完成此类DUT的驱动。</p>
<h3 id="回调函数简介">回调函数简介</h3>
<p>回调函数是一种常见的编程技术，它允许我们将一个函数传入，并等待某个条件满足后被调用。构建产生的 Python Module 中，我们提供了向内部执行环境注册回调函数的接口 <code>StepRis</code>，使用方法如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">dual_port_stack</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">DUTdual_port_stack</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cycles</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;The current clock cycle is </span><span style="color:#4e9a06">{</span><span style="color:#000">cycles</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTdual_port_stack</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">callback</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>你可以直接运行该代码来查看回调函数的效果。</p>
<p>在上述代码中，我们定义了一个回调函数 <code>callback</code> ，它接受一个参数 <code>cycles</code> ，并在每次调用时打印当前的时钟周期。接着通过 <code>StepRis</code> 将该回调函数注册到 DUT 中。</p>
<p>注册回调函数后，每运行一次 <code>Step</code> 函数，即每个时钟周期，都会在时钟信号上升沿去调用该回调函数，并传入当前的时钟周期。</p>
<p>通过这种方式，我们可以将不同的执行逻辑都写成回调函数的方式，并将多个回调函数注册到 DUT 中，从而实现对 DUT 的并行驱动。</p>
<h3 id="基于回调函数驱动的双端口栈">基于回调函数驱动的双端口栈</h3>
<p>通过回调函数的形式来完成一条完整的执行逻辑，通常我们会使用状态机的模式进行编写。每调用一次回调函数，就会引起状态机内部的状态变化，多次调用回调函数，就会完成一次完整的执行逻辑。</p>
<p>下面是一个基于回调函数驱动的双端口栈的示例代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">dual_port_stack</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">enum</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Enum</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackModel</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stack</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">commit_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;push&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">commit_pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut_data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pop&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut_data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">model_data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">model_data</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">dut_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;The model data </span><span style="color:#4e9a06">{</span><span style="color:#000">model_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is not equal to the dut data </span><span style="color:#4e9a06">{</span><span style="color:#000">dut_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Pass: </span><span style="color:#4e9a06">{</span><span style="color:#000">model_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> == </span><span style="color:#4e9a06">{</span><span style="color:#000">dut_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">SinglePortDriver</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Enum</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IDLE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WAIT_REQ_READY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WAIT_RESP_VALID</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BusCMD</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Enum</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">PUSH</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">POP</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">PUSH_OKAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">POP_OKAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">StackModel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">model</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">port_dict</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">IDLE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">operation_num</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remaining_delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">PUSH</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">POP</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">step_callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cycle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">WAIT_REQ_READY</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_ready&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">WAIT_RESP_VALID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">PUSH</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">model</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">commit_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">WAIT_RESP_VALID</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">IDLE</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remaining_delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_cmd&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">POP_OKAY</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">model</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">commit_pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_data&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">IDLE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remaining_delay</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">operation_num</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">operation_num</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">operation_num</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">WAIT_REQ_READY</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">remaining_delay</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_stack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">StackModel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">port0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SinglePortDriver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">port1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SinglePortDriver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port0</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step_callback</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step_callback</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTdual_port_stack</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clk&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">test_stack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>在上述代码中，实现了这样的驱动过程：每个端口独立对DUT进行驱动，并在一个请求完成后添加随机延迟，每个端口分别完成了 10 次 <code>PUSH</code> 操作与 10 次 <code>POP</code> 操作。</p>
<p>在 <code>PUSH</code> 或 <code>POP</code> 请求生效时，会调用同一个 <code>StackModel</code> 中的 <code>commit_push</code> 或 <code>commit_pop</code> 函数，以模拟栈的行为，并在每次 <code>POP</code> 操作完成后对比 DUT 的返回数据与模型的数据是否一致。</p>
<p>为了实现对单个端口的驱动行为，我们实现了 <code>SinglePortDriver</code> 类，其中实现了一个接口进行收发的完整过程，通过 <code>step_callback</code> 函数来实现内部的更新逻辑。</p>
<p>在测试函数 <code>test_stack</code> 中，我们为双端口栈的每一个端口都创建了一个 <code>SinglePortDriver</code> 实例，传入了对应的接口，并通过 <code>StepRis</code> 函数将其对应的回到函数其注册到 DUT 中。之后调用 <code>dut.Step(200)</code> 时，每个时钟周期中都会自动调用一次回调函数，来完成整个驱动逻辑。</p>
<p><strong>SinglePortDriver 驱动逻辑</strong></p>
<p>上面提到，一般使用回调函数的形式需要将执行逻辑实现为状态机，因此在 <code>SinglePortDriver</code> 类中，需要记录包含端口所处的状态，它们分别是：</p>
<ul>
<li><code>IDLE</code>：空闲状态，等待下一次操作
<ul>
<li>在空闲状态下，需要查看另一个状态 <code>remaining_delay</code> 来判断当前是否已经延时结束，如果延时结束可立即进行下一次操作，否则继续等待。</li>
<li>当需要执行下一次操作时，需要查看状态 <code>operation_num</code> （当前已经执行的操作数）来决定下一次操作时 <code>PUSH</code> 还是 <code>POP</code>。之后调用相关函数对端口进行一次赋值，并将状态切换至 <code>WAIT_REQ_READY</code>。</li>
</ul>
</li>
<li><code>WAIT_REQ_READY</code>：等待请求端口准备好
<ul>
<li>当请求发出后（<code>in_valid</code> 有效），此时需要等待 <code>in_ready</code> 信号有效，以确保请求已经被正确接受。</li>
<li>当请求被正确接受后，需要将 <code>in_valid</code> 置为 0，同时将 <code>out_ready</code> 置为 1，表示请求发送完毕，准备好接收回复。</li>
</ul>
</li>
<li><code>WAIT_RESP_VALID</code>：等待响应端口返回数据
<ul>
<li>当请求被正确接受后，需要等待 DUT 的回复，即等待 <code>out_valid</code> 信号有效。当 <code>out_valid</code> 信号有效时，表示回复已经产生，一次请求完成，于是将 <code>out_ready</code> 置为 0，同时将状态切换至 <code>IDLE</code>。</li>
</ul>
</li>
</ul>
<h3 id="运行测试">运行测试</h3>
<p>在picker_out_dual_port_stack中创建<code>exmaple.py</code>文件，将上述代码复制到其中，然后执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> picker_out_dual_port_stack
</span></span><span style="display:flex;"><span>python3 example.py
</span></span></code></pre></div><p>可直接运行本案例的测试代码，你将会看到类似如下的输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>push <span style="color:#0000cf;font-weight:bold">77</span>
</span></span><span style="display:flex;"><span>push <span style="color:#0000cf;font-weight:bold">140</span>
</span></span><span style="display:flex;"><span>push <span style="color:#0000cf;font-weight:bold">249</span>
</span></span><span style="display:flex;"><span>push <span style="color:#0000cf;font-weight:bold">68</span>
</span></span><span style="display:flex;"><span>push <span style="color:#0000cf;font-weight:bold">104</span>
</span></span><span style="display:flex;"><span>push <span style="color:#0000cf;font-weight:bold">222</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">43</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">43</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">43</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">211</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">211</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">211</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">16</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">255</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">255</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">255</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">222</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">222</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">222</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">104</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>在输出中，你可以看到每次 <code>PUSH</code> 和 <code>POP</code> 操作的数据，以及每次 <code>POP</code> 操作的结果。如果输出中没有错误信息，则表示测试通过。</p>
<h2 id="回调函数驱动的优劣">回调函数驱动的优劣</h2>
<p>通过使用回调函数，我们能够完成对 DUT 的并行驱动，正如本例所示，我们通过两个回调函数实现了对拥有两个独立执行逻辑的端口的驱动。回调函数在简单的场景下，为我们提供了一种简单的并行驱动方法。</p>
<p>但是通过本例也可以看出，仅仅实现一套简单的“请求-回复”流程，就需要维护大量的内部状态，回调函数将本应完整的执行逻辑拆分为了多次函数调用，为代码的编写和调试增加了诸多复杂性。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8b6f24fda4c11d593a6c671bbe7427ce">1.5 - 案例四：双端口栈（协程）</h1>
    <div class="lead">双端口栈是一个拥有两个端口的栈，每个端口都支持push和pop操作。本案例以双端口栈为例，展示如何使用协程驱动DUT</div>
	<h2 id="双端口栈简介与环境构建">双端口栈简介与环境构建</h2>
<p>本案例中使用的双端口栈与案例三中的实现完全相同，请查看案例三中的<a href="../eg-stack-callback#%E5%8F%8C%E7%AB%AF%E5%8F%A3%E6%A0%88%E7%AE%80%E4%BB%8B">双端口栈简介</a>及<a href="../eg-stack-callback#%E6%9E%84%E5%BB%BA%E9%A9%B1%E5%8A%A8%E7%8E%AF%E5%A2%83">构建驱动环境</a>。</p>
<h2 id="利用协程驱动-dut">利用协程驱动 DUT</h2>
<p>在案例三中，我们使用了回调函数的方式来驱动DUT，回调函数虽然给我们提供了一种能够完成并行操作的方式，然而其却把完成的执行流程割裂为多次函数调用，并需要维护大量中间状态，导致代码的编写及调试变得较为复杂。</p>
<p>在本案例中，我们将会介绍一种通过协程驱动的方法，这种方法不仅能够做到并行操作，同时能够很好地避免回调函数所带来的问题。</p>
<h3 id="协程简介">协程简介</h3>
<p>协程是一种“轻量级”的线程，通过协程，你可以实现与线程相似的并发执行的行为，但其开销却远小于线程。其实现原理是，协程库实现了一个运行于单线程之上的事件循环（EventLoop），程序员可以定义若干协程并且加入到事件循环，由事件循环负责这些协程的调度。</p>
<p>一般来说，我们定义的协程在执行过程中会持续执行，直到遇到一个需要等待的“事件”，此时事件循环就会暂停执行该协程，并调度其他协程运行。当事件发生后，事件循环会再次唤醒该协程，继续执行。</p>
<p>对于硬件验证中的并行执行来说，这种特性正是我们所需要的，我们可以创建多个协程，来完成验证中的多个驱动任务。我们可以将时钟的执行当做事件，在每个协程中等待这个事件，当时钟信号到来时，事件循环会唤醒所有等待的协程，使其继续执行，直到他们等待下一个时钟信号。</p>
<p>我们用 Python 中的 <code>asyncio</code> 来实现对协程的支持：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">dual_port_stack</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">{</span><span style="color:#000">name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_dut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;coroutine 1&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;coroutine 2&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RunStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTdual_port_stack</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clk&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">test_dut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>你可以直接运行上述代码来观察协程的执行过程。在上述代码中我们用 <code>create_task</code> 创建了两个协程任务并加入到事件循环中，每个协程任务中，会不断打印一个数字并等待下一个时钟信号到来。</p>
<p>我们使用 <code>dut.RunStep(10)</code> 来创建一个后台时钟，它会不断产生时钟同步信号，使得其他协程能够在时钟信号到来时继续执行。</p>
<h3 id="基于协程驱动的双端口栈">基于协程驱动的双端口栈</h3>
<p>利用协程，我们就可以将驱动双端口栈中单个端口逻辑写成一个独立的执行流，不需要再去维护大量的中间状态。</p>
<p>下面是我们提供的一个简单的使用协程驱动的验证代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">dual_port_stack</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">enum</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Enum</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackModel</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stack</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">commit_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Push&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">commit_pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut_data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pop&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut_data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">model_data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">model_data</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">dut_data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;The model data </span><span style="color:#4e9a06">{</span><span style="color:#000">model_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is not equal to the dut data </span><span style="color:#4e9a06">{</span><span style="color:#000">dut_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Pass: </span><span style="color:#4e9a06">{</span><span style="color:#000">model_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> == </span><span style="color:#4e9a06">{</span><span style="color:#000">dut_data</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">SinglePortDriver</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BusCMD</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Enum</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">PUSH</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">POP</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">PUSH_OKAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">POP_OKAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">StackModel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">model</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">port_dict</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">send_req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_push</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">PUSH</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is_push</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">POP</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ACondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_ready&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is_push</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">model</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">commit_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">receive_resp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ACondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_valid&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_cmd&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">BusCMD</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">POP_OKAY</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">model</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">commit_pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_dict</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;out_data&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_once</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">is_push</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send_req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_push</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">receive_resp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_once</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_push</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_once</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_push</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_stack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">StackModel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">port0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SinglePortDriver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in0_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out0_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">port1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">SinglePortDriver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stack</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">model</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;in_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">in1_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_valid&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_valid</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_ready&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_ready</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_data</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;out_cmd&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">stack</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">out1_cmd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port0</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">main</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">main</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RunStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTdual_port_stack</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clk&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">test_stack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>与案例三类似，我们定义了一个 <code>SinglePortDriver</code> 类，用于驱动单个端口的逻辑。在 <code>main</code> 函数中，我们创建了两个 <code>SinglePortDriver</code> 实例，分别用于驱动两个端口。我们将两个端口的驱动过程放在了入口函数 <code>main</code> 中，并通过 <code>asyncio.create_task</code> 将其加入到事件循环中，在最后我们通过 <code>dut.RunStep(200)</code> 来创建了后台时钟，以推动测试的进行。</p>
<p>该代码实现了与案例三一致的测试逻辑，即在每个端口中对栈进行 10 次 PUSH 和 10 次 POP 操作，并在操作完成后添加随机延迟。但你可以清晰的看到，利用协程进行编写，不需要维护任何的中间状态。</p>
<p><strong>SinglePortDriver 逻辑</strong></p>
<p>在 <code>SinglePortDriver</code> 类中，我们将一次操作封装为 <code>exec_once</code> 这一个函数，在 <code>main</code> 函数中只需要首先调用 10 次 <code>exec_once(is_push=True)</code> 来完成 PUSH 操作，再调用 10 次 <code>exec_once(is_push=False)</code> 来完成 POP 操作即可。</p>
<p>在 <code>exec_once</code> 函数中，我们首先调用 <code>send_req</code> 函数来发送请求，然后调用 <code>receive_resp</code> 函数来接收响应，最后通过等待随机次数的时钟信号来模拟延迟。</p>
<p><code>send_req</code> 和 <code>receive_resp</code> 函数的实现逻辑类似，只需要将对应的输入输出信号设置为对应的值，然后等待对应的信号变为有效即可，可以完全根据端口的执行顺序来编写。</p>
<p>类似地，我们使用 <code>StackModel</code> 类来模拟栈的行为，在 <code>commit_push</code> 和 <code>commit_pop</code> 函数中分别模拟了 PUSH 和 POP 操作，并在 POP 操作中进行了数据的比较。</p>
<h3 id="运行测试">运行测试</h3>
<p>在picker_out_dual_port_stack文件夹中创建<code>example.py</code>将上述代码复制到其中，然后执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> picker_out_dual_port_stack
</span></span><span style="display:flex;"><span>python3 example.py
</span></span></code></pre></div><p>可直接运行本案例的测试代码，你将会看到类似如下的输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">141</span>
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">102</span>
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">63</span>
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">172</span>
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">208</span>
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">130</span>
</span></span><span style="display:flex;"><span>Push <span style="color:#0000cf;font-weight:bold">151</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">102</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">102</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">102</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">138</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">138</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">138</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">56</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">56</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">56</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">153</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">153</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">153</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">129</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">129</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">129</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">235</span>
</span></span><span style="display:flex;"><span>Pass: <span style="color:#000">235</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">235</span>
</span></span><span style="display:flex;"><span>Pop <span style="color:#0000cf;font-weight:bold">151</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>在输出中，你可以看到每次 <code>PUSH</code> 和 <code>POP</code> 操作的数据，以及每次 <code>POP</code> 操作的结果。如果输出中没有错误信息，则表示测试通过。</p>
<h2 id="协程驱动的优劣">协程驱动的优劣</h2>
<p>通过协程函数，我们可以很好地实现并行操作，同时避免了回调函数所带来的问题。每个独立的执行流都能被完整保留，实现为一个协程，大大方便了代码的编写。</p>
<p>然而，在更为复杂的场景下你会发现，实现了众多协程，会使得协程之间的同步和时序管理变得复杂。尤其是你需要在两个不与DUT直接交互的协程之间进行同步时，这种现象会尤为明显。</p>
<p>在这时候，你就需要一套协程编写的规范以及验证代码的设计模式，来帮助你更好地编写基于协程的验证代码。因此，我们提供了 toffee 库，它提供了一套基于协程的验证代码设计模式，你可以通过使用 toffee 来更好地编写验证代码，你可以在<a href="https://github.com/XS-MLVP/toffee">这里</a>去进一步了解 toffee。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7351c618ae63b98e5898f0913a6c55f5">2 - 基础工具</h1>
    <div class="lead">开放验证平台的基础工具的详细使用方法。</div>
	

<div class="pageinfo pageinfo-primary">
<p>在开始前本页会 简单的介绍什么是验证，以及示例里面用到的概念，如 DUT (Design Under Test) 和 RM (Reference Model) 。</p>

</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ea0963a557e19f6f121695eff48e4632">2.1 - 工具介绍</h1>
    <div class="lead">验证工具的基本使用。</div>
	

<div class="pageinfo pageinfo-primary">
<p>为满足开放验证的环境要求，我们开发了 Picker 工具，用于将 RTL 设计转换为多语言接口，并在此基础上进行验证，我们将会使用 Picker 工具生成的环境作为基础的验证环境。接下来我们将介绍 Picker 工具，及其基础的使用方法。</p>

</div>

<h2 id="picker-简介">Picker 简介</h2>
<p>picker 是一个芯片验证辅助工具，具有两个主要功能：</p>
<ol>
<li><strong>打包RTL设计验证模块：</strong> picker 可以将 RTL 设计验证模块（.v/.scala/.sv）打包成动态库，并提供多种高级语言（目前支持 C++、Python、Java、Scala、Golang）的编程接口来驱动电路。</li>
<li><strong>UVM-TLM代码自动生成：</strong> picker 能够基于用户提供的 UVM sequence_item 进行自动化的 TLM 代码封装，提供 UVM 与其他高级语言（如 Python）的通信接口。
该工具允许用户基于现有的软件测试框架，例如 pytest、junit、TestNG、go test 等，进行芯片单元测试。</li>
</ol>
<p>基于 Picker 进行验证的优点:</p>
<ol>
<li>不泄露 RTL 设计：经过 Picker 转换后，原始的设计文件（.v）被转化成了二进制文件（.so），脱离原始设计文件后，依旧可进行验证，且验证者无法获取 RTL 源代码。</li>
<li>减少编译时间：当 DUT（设计待测）稳定时，只需要编译一次（打包成 .so 文件）。</li>
<li>用户范围广：提供的编程接口多，覆盖不同语言的开发者。</li>
<li>使用丰富的软件生态：支持 Python3、Java、Golang 等生态系统。</li>
<li>自动化的 UVM 事务封装：通过自动化封装 UVM 事务，实现 UVM 和 Python 的通信。</li>
</ol>
<p>Picker 目前支持的 RTL 仿真器：</p>
<ol>
<li>Verilator</li>
<li>Synopsys VCS</li>
</ol>
<p><strong>Picker的工作原理</strong><br>
<code>Picker</code>的主要功能就是将<code>Verilog</code>代码转换为C++或者Python代码，以Chisel开发的处理器为例:先通过Chisel自带的工具将其转换为Verilog代码，再通Picker提供高级编程语言接口。</p>
<p><img src="Picker_working_principle.svg" alt="Picker的工作原理"></p>
<h2 id="python-模块生成">Python 模块生成</h2>
<h3 id="生成模块的过程">生成模块的过程</h3>
<p>Picker 导出 Python Module 的方式是基于 C++ 的。</p>
<ul>
<li><strong>Picker 是 代码生成(codegen)工具，它会先生成项目文件，再利用 make 编译出二进制文件。</strong></li>
<li>Picker 首先会利用仿真器将 RTL 代码编译为 C++ Class，并编译为动态库。（见C++步骤详情）</li>
<li>再基于 Swig 工具，利用上一步生成的 C++ 的头文件定义，将动态库导出为 Python Module。</li>
<li>最终将生成的模块导出到目录，并按照需求清理或保留其他中间文件。</li>
</ul>
<blockquote>
<p>Swig 是一个用于将 C/C++ 导出为其他高级语言的工具。该工具会解析 C++ 头文件，并生成对应的中间代码。
如果希望详细了解生成过程，请参阅 <a href="http://www.swig.org/Doc4.2/SWIGDocumentation.html">Swig 官方文档</a>。
如果希望知道 Picker 如何生成 C++ Class，请参阅 <a href="docs/quick-start/multi-lang/cpp">C++</a>。</p></blockquote>
<ul>
<li>该这个模块和标准的 Python 模块一样，可以被其他 Python 程序导入并调用，文件结构也与普通 Python 模块无异。</li>
</ul>
<h2 id="python-模块使用">Python 模块使用</h2>
<ul>
<li>参数 <code>--language python</code> 或 <code>--lang python</code> 用于指定生成Python基础库。</li>
<li>参数 <code>--example, -e</code> 用于生成包含示例项目的可执行文件。</li>
<li>参数 <code>--verbose, -v</code> 用于保留生成项目时的中间文件。</li>
</ul>
<h3 id="使用工具生成python的dut类">使用工具生成Python的DUT类</h3>
<p>以案例一中的<a href="/mlvp/docs/quick-start/eg-adder/">简单加法器</a>为例：</p>
<ul>
<li>Picker会自动生成Python的一个基础类，我们称之为DUT类，以前加法器为例，用户需要编写测试用例，即导入上一章节生成的 Python Module，并调用其中的方法，以实现对硬件模块的操作。
目录结构为：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker_out_adder
</span></span><span style="display:flex;"><span>├── Adder                   <span style="color:#8f5902;font-style:italic"># Picker 工具生成的项目</span>
</span></span><span style="display:flex;"><span>│   ├── _UT_Adder.so
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   ├── libUTAdder.so
</span></span><span style="display:flex;"><span>│   ├── libUT_Adder.py
</span></span><span style="display:flex;"><span>│   └── signals.json
</span></span><span style="display:flex;"><span>└── example.py              <span style="color:#8f5902;font-style:italic"># 用户需要编写的代码</span>
</span></span></code></pre></div><ul>
<li>在DUT对应的DUTAdder类中共有8个方法(位于Adder/<strong>init</strong>.py文件)，具体如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic"># 初始化时钟，参数时钟引脚对应的名称，例如clk</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">:</span><span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>         <span style="color:#8f5902;font-style:italic"># 推进电路i个周期</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">callback</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Callable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kwargs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{})</span>  <span style="color:#8f5902;font-style:italic"># 设置上升沿回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">StepFal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">callback</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">Callable</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kwargs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{})</span>  <span style="color:#8f5902;font-style:italic"># 设置下降沿回调函数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">SetWaveform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic"># 设置波形文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">SetCoverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic"># 设置代码覆盖率文件</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">RefreshComb</span><span style="color:#000;font-weight:bold">()</span>           <span style="color:#8f5902;font-style:italic"># 推进组合电路</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>                <span style="color:#8f5902;font-style:italic"># 销毁电路</span>
</span></span></code></pre></div><ul>
<li>DUT对应的引脚，例如reset，clock等在DUTAdder类中以成员变量的形式呈现。如下所示，可以通过value进行引脚的读取和写入。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>  <span style="color:#8f5902;font-style:italic"># 通过给引脚的.value属性赋值完成对引脚的赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>    <span style="color:#8f5902;font-style:italic"># 对引脚输入a的第12bit进行赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>  <span style="color:#8f5902;font-style:italic"># 读取引脚a的值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">]</span>    <span style="color:#8f5902;font-style:italic"># 读取引脚a的第12bit的值</span>
</span></span></code></pre></div><h4 id="驱动dut的一般流程">驱动DUT的一般流程</h4>
<ol>
<li><strong>创建DUT，设置引脚模式</strong>。默认情况下，引脚是在一下个周期的上升沿进行赋值，如果是组合逻辑，需要设置赋值模式为立即赋值。</li>
<li><strong>初始化时钟</strong>。其目的是将时钟引脚与DUT内置的xclock进行绑定。组合逻辑没有时钟可以忽略。</li>
<li><strong>reset电路</strong>。大部分时序电路都需要reset。</li>
<li><strong>给DUT输入引脚写入数据</strong>。通过“pin.Set(x)”接口，或者pin.vaulue=x进行赋值。</li>
<li><strong>驱动电路</strong>。时序电路用Step，组合电路用RefreshComb。</li>
<li><strong>获取DUT各个引脚的输出进行检测</strong>。例如和参考模型进行的结果进行assert对比。</li>
<li><strong>完成验证，销毁DUT</strong>。调用Finish()时，会把波形，覆盖率等写入到文件。</li>
</ol>
<p>对应伪代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Python DUT 的名字可通过 --tdir 指定</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">DUT</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1 创建</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUT</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SetWaveform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test.fst&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clock&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3 reset</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">reset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">reset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 4 输入数据</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">input_pin1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x123123</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">input_pin3</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0b1011&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 5 驱动电路 </span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 6 得到结果</span>
</span></span><span style="display:flex;"><span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">output_pin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 7 销毁</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="其他数据类型">其他数据类型</h3>
<p>一般情况下，通过上述DUT类自带的接口就能完成绝大部分DUT的验证，但一些特殊情况需要其他对应的接口，例如自定义时钟、异步操作、推进组合电路并写入波形、修改引脚属性等。</p>
<p>在picker生成的DUT类中，除了<strong>XData类型的引脚成员变量</strong>外，还有<strong>XClock类型的xclock</strong>和<strong>XPort类型的xport</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">xport</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">XPort</span>         <span style="color:#8f5902;font-style:italic"># 成员变量 xport，用于管理DUT中的所有引脚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">xclock</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">XClock</span>       <span style="color:#8f5902;font-style:italic"># 成员变量 xclock，用于管理时钟</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># DUT 引脚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">b</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">XData</span>
</span></span></code></pre></div><h4 id="xdata-类">XData 类</h4>
<ul>
<li>DUT引脚中的数据通常位宽不确定，且有四种状态：0、1、Z和X。为此picker提供了XData进行电路引脚数据表示。</li>
</ul>
<p><strong>主要方法</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">XData</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#拆分XData，例如把一个32位XData中的第7-10位创建成为一个独立XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#  name：名称，start：开始位，width：位宽，例如auto sub = a.SubDataRef(&#34;sub_pin&#34;, 0, 4)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">SubDataRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">width</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">GetWriteMode</span><span style="color:#000;font-weight:bold">():</span><span style="color:#000">WriteMode</span>     <span style="color:#8f5902;font-style:italic">#获取XData的写模式，写模式有三种：Imme立即写，Rise上升沿写，Fall下降沿写</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">SetWriteMode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">WriteMode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">#设置XData的写模式 eg: a.SetWriteMode(WriteMode::Imme)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">DataValid</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">bool</span>             <span style="color:#8f5902;font-style:italic">#检测数据是否有效（Value中含有X或者Z态返回false否者true）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">W</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">int</span>             <span style="color:#8f5902;font-style:italic">#获取XData的位宽（如果为0，表示XData为verilog中的logic类型，否则为Vec类型的位宽）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">U</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">int</span>             <span style="color:#8f5902;font-style:italic">#获取XData的值（无符号，同 x = a.value）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">S</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">int</span>             <span style="color:#8f5902;font-style:italic">#获取XData的值（有符号类型）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">str</span>        <span style="color:#8f5902;font-style:italic">#将XData转位16进制的字符串类型，eg: &#34;0x123ff&#34;，如果出现?，表现对应的4bit中有x或z态</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">):</span><span style="color:#204a87">bool</span>   <span style="color:#8f5902;font-style:italic">#判断2个XData是否相等</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>          <span style="color:#8f5902;font-style:italic">#对XData进行赋值，value类型可以为：XData, string, int, bytes等</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">GetBytes</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#204a87">bytes</span>   <span style="color:#8f5902;font-style:italic">#以bytes格式获取XData中的数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">):</span><span style="color:#204a87">bool</span> <span style="color:#8f5902;font-style:italic">#连接2个XData，只有In和Out类型的可以连接，当Out数据发生变化时，In类型的XData会自动写入</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">IsInIO</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">bool</span>       <span style="color:#8f5902;font-style:italic">#判断XData是否为In类型，改类型可读可写</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">IsOutIO</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">bool</span>      <span style="color:#8f5902;font-style:italic">#判断XData是否为Out类型，改类型只可读</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">IsBiIO</span><span style="color:#000;font-weight:bold">():</span><span style="color:#204a87">bool</span>       <span style="color:#8f5902;font-style:italic">#判断XData是否为Bi类型，改类型可读可写</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">IsImmWrite</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#204a87">bool</span>  <span style="color:#8f5902;font-style:italic">#判断XData是否为Imm写入模式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">IsRiseWrite</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#204a87">bool</span> <span style="color:#8f5902;font-style:italic">#判断XData是否为Rise写入模式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">IsFallWrite</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#204a87">bool</span> <span style="color:#8f5902;font-style:italic">#判断XData是否为Fall写入模式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsImmWrite</span><span style="color:#000;font-weight:bold">()</span>        <span style="color:#8f5902;font-style:italic">#更改XData的写模式为Imm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsRiseWrite</span><span style="color:#000;font-weight:bold">()</span>       <span style="color:#8f5902;font-style:italic">#更改XData的写模式为Rise</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsFallWrite</span><span style="color:#000;font-weight:bold">()</span>       <span style="color:#8f5902;font-style:italic">#更改XData的写模式为Fall</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsBiIO</span><span style="color:#000;font-weight:bold">()</span>            <span style="color:#8f5902;font-style:italic">#更改XData为Bi类型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsInIO</span><span style="color:#000;font-weight:bold">()</span>            <span style="color:#8f5902;font-style:italic">#更改XData为In类型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsOutIO</span><span style="color:#000;font-weight:bold">()</span>           <span style="color:#8f5902;font-style:italic">#更改XData为Out类型</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">FlipIOType</span><span style="color:#000;font-weight:bold">()</span>        <span style="color:#8f5902;font-style:italic">#将XData的IO类型进行取反，例如In变为Out或者Out变为In</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Invert</span><span style="color:#000;font-weight:bold">()</span>            <span style="color:#8f5902;font-style:italic">#将XData中的数据进行取反</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">At</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">PinBind</span>  <span style="color:#8f5902;font-style:italic">#获取第index, eg: x = a.At(12).Get() or a.At(12).Set(1)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">AsBinaryString</span><span style="color:#000;font-weight:bold">()</span>    <span style="color:#8f5902;font-style:italic">#将XData的数据变为二进制字符串，eg: &#34;1001011&#34;</span>
</span></span></code></pre></div><p>为了简化赋值操作，XData 对 Set(value) 和 U() 方法进行了属性赋值重载，可以通过<code>pin.value=x</code> 和 <code>x=pin.value</code>进行赋值和取值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用.value可以进行访问</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a 为XData类型</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">12345</span>        <span style="color:#8f5902;font-style:italic"># 十进制赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0b11011</span>      <span style="color:#8f5902;font-style:italic"># 二进制赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0o12345</span>      <span style="color:#8f5902;font-style:italic"># 八进制赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x12345</span>      <span style="color:#8f5902;font-style:italic"># 十六进制赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>           <span style="color:#8f5902;font-style:italic"># 所有bit赋值1, a.value = x 与 a.Set(x) 等价</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>              <span style="color:#8f5902;font-style:italic"># 对第31位进行赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x&#34;</span>          <span style="color:#8f5902;font-style:italic"># 赋值高阻态</span>
</span></span><span style="display:flex;"><span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;z&#34;</span>          <span style="color:#8f5902;font-style:italic"># 赋值不定态</span>
</span></span><span style="display:flex;"><span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>            <span style="color:#8f5902;font-style:italic"># 获取值，与 x = a.U() 等价</span>
</span></span></code></pre></div><h3 id="xport-类">XPort 类</h3>
<ul>
<li>在处理少数几个XData引脚时，直接操作XData是比较清晰和直观的。但是，当涉及到多个XData时，进行批量管理就不太方便了。XPort是对XData的一种封装，它允许我们对多个XData进行集中操作。我们还提供了一些方法来方便地进行批量管理。</li>
</ul>
<p><strong>初始化与添加引脚</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;p&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">#创建前缀为p的XPort实例</span>
</span></span></code></pre></div><p><strong>主要方法</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">XPort</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">XPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prefix</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>      <span style="color:#8f5902;font-style:italic">#创建前缀为prefix的port， eg：p = XPort(&#34;tile_link_&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">PortCount</span><span style="color:#000;font-weight:bold">():</span> <span style="color:#204a87">int</span>        <span style="color:#8f5902;font-style:italic">#获取端口中的Pin数量（即绑定的XData个数）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pin_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">XData</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">#添加Pin, eg：p.Add(&#34;reset&#34;, dut.reset)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pin_name</span><span style="color:#000;font-weight:bold">)</span>           <span style="color:#8f5902;font-style:italic">#删除Pin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xport2</span><span style="color:#000;font-weight:bold">)</span>         <span style="color:#8f5902;font-style:italic">#链接2个Port</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">NewSubPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">subprefix</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">XPort</span> <span style="color:#8f5902;font-style:italic"># 创建子Port，以subprefix开头的所有Pin构成子Port</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">raw_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">XData</span>         <span style="color:#8f5902;font-style:italic"># 获取XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">SetZero</span><span style="color:#000;font-weight:bold">()</span>                                <span style="color:#8f5902;font-style:italic">#设置Port中的所有XData为0</span>
</span></span></code></pre></div><h3 id="xclock-类">XClock 类</h3>
<ul>
<li>XClock是电路时钟的封装，用于驱动电路。在传统仿真工具（例如Verilator）中，需要手动为clk赋值，并通过step_eval函数更新状态。但在我们的工具中，我们提供了相应的方法，可以将时钟直接绑定到XClock上。只需使用我们的Step()方法，就可以同时更新clk和电路状态。</li>
</ul>
<p><strong>初始化与添加引脚</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stepfunc</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">#参数stepfunc为DUT后端提供的电路推进方法，例如verilaor的step_eval等</span>
</span></span></code></pre></div><p><strong>主要方法</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>       <span style="color:#8f5902;font-style:italic">#将Clock和时钟进行绑定， eg：clock.Add(dut.clk)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xport</span><span style="color:#000;font-weight:bold">)</span>       <span style="color:#8f5902;font-style:italic">#将Clock和XData进行绑定</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">RefreshComb</span><span style="color:#000;font-weight:bold">()</span>                     <span style="color:#8f5902;font-style:italic">#推进电路状态，不推进时间，不dump波形</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">RefreshCombT</span><span style="color:#000;font-weight:bold">()</span>                    <span style="color:#8f5902;font-style:italic">#推进电路状态（推进时间，dump波形）</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>                   <span style="color:#8f5902;font-style:italic">#推进电路s个时钟周期，  DUT.Step = DUT.xclock.Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kwargs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#8f5902;font-style:italic">#设置上升沿回调函数，DUT.StepRis = DUT.xclock.StepRis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">StepFal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kwargs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#8f5902;font-style:italic">#设置下降沿回调函数，DUT.StepFal = DUT.xclock.StepFal</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 异步方法</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">AStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cycle</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">)</span>      <span style="color:#8f5902;font-style:italic">#异步推进cycle个时钟， eg：await dut.AStep(5)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">ACondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">condition</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">#异步等待conditon()为true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">ANext</span><span style="color:#000;font-weight:bold">()</span>                <span style="color:#8f5902;font-style:italic">#异步推进一个时钟周期，等同AStep(1)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">RunStep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cycle</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">#持续推进时钟cycle个时钟，用于最外层</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f3644e5a33edc980188913395528ef79">2.2 - 波形生成</h1>
    <div class="lead">生成电路波形</div>
	<h2 id="使用方法">使用方法</h2>
<p>在使用 Picker 工具封装 DUT 时，使用选项<code>-w [wave_file]</code>指定需要保存的波形文件。
针对不同的后端仿真器，支持不同的波形文件类型，具体如下：</p>
<ol>
<li><a href="https://www.veripool.org/wiki/verilator">Verilator</a>
<ul>
<li><code>.vcd</code>格式的波形文件。</li>
<li><code>.fst</code>格式的波形文件，更高效的压缩文件。</li>
</ul>
</li>
<li><a href="https://www.synopsys.com/verification/simulation/vcs.html">VCS</a>
<ul>
<li><code>.fsdb</code>格式的波形文件，更高效的压缩文件。</li>
</ul>
</li>
</ol>
<p>需要注意的是，如果你选择自行生成 <code>libDPI_____.so</code> 文件，那么波形文件格式不受上述约束的限制。因为波形文件是在仿真器构建 <code>libDPI.so</code> 时决定的，如果你自行生成，那么波形文件格式也需要自行用对应仿真器的配置指定。</p>
<h3 id="python-示例">Python 示例</h3>
<p>正常情况下，dut需要被<strong>显式地声明完成任务</strong>，以通知进行模拟器的后处理工作（写入波形、覆盖率等文件）。
在Python中，需要在完成所有测试后，<strong>调用dut的<code>.Finish()</code>方法</strong>以通知模拟器任务已完成，进而将文件flush到磁盘。</p>
<p>以<a href="/mlvp/docs/quick-start/eg-adder/">加法器</a>为例，以下为测试程序：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic"># flush the wave file to disk</span>
</span></span></code></pre></div><p>运行结束后即可生成指定文件名的波形文件。</p>
<h2 id="查看结果">查看结果</h2>
<h3 id="gtkwave">GTKWave</h3>
<p>使用 GTKWave 打开 <code>fst</code> 或 <code>vcd</code> 波形文件，即可查看波形图。</p>
<p><img src="GTKwave.png" alt="GTKWave"></p>
<h3 id="verdi">Verdi</h3>
<p>使用 Verdi 打开 <code>fsdb</code> 或 <code>vcd</code> 波形文件，即可查看波形图。</p>
<p><img src="verdiwave.png" alt="Verdi"></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e24b3d167d3b33da0ef1cb2f151ba27">2.3 - 多文件输入</h1>
    <div class="lead">处理多个Verilog源文件</div>
	<h2 id="多文件输入输出">多文件输入输出</h2>
<p>在许多情况中，某文件下的某个模块会例化其他文件下的模块，在这种情况下您可以使用Picker工具的<code>-f</code>选项处理多个verilog源文件。例如，假设您有<code>Cache.sv</code>, <code>CacheStage.sv</code>以及<code>CacheMeta.sv</code>三个源文件：</p>
<h3 id="文件列表">文件列表</h3>
<h4 id="cachesv">Cache.sv</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sv" data-lang="sv"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// In 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">Cache</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">CacheStage</span> <span style="color:#000">s1</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">CacheStage</span> <span style="color:#000">s2</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">CacheStage</span> <span style="color:#000">s3</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">CacheMeta</span> <span style="color:#000">cachemeta</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><h4 id="cachestagesv">CacheStage.sv</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sv" data-lang="sv"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// In CacheStage.sv
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">CacheStage</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><h4 id="cachemetasv">CacheMeta.sv</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sv" data-lang="sv"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// In CacheMeta.sv
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">CacheMeta</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><h3 id="应用方式">应用方式</h3>
<p>其中，待测模块为Cache，位于<code>Cache.sv</code>中，则您可以通过以下命令生成DUT：</p>
<h4 id="命令行指定">命令行指定</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> Cache.sv --fs CacheStage.sv,CacheMeta.sv --sname Cache
</span></span></code></pre></div><h4 id="通过文件列表文件指定">通过文件列表文件指定</h4>
<p>您也可以通过传入.txt文件的方式来实现多文件输入：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> Cache.sv --fs src.txt --sname Cache
</span></span></code></pre></div><p>其中<code>src.txt</code>的内容为:</p>
<pre tabindex="0"><code>CacheStage.sv
CacheMeta.sv
</code></pre><h3 id="注意事项">注意事项</h3>
<ol>
<li>需要注意的是，使用多文件输入时仍需要指定待测顶层模块所在的文件，例如上文中所示的<code>Cache.sv</code>。</li>
<li>在使用多文件输入时，Picker会将所有文件都交给仿真器，仿真器同时进行编译，因此需要保证所有文件中的模块名不重复。</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-625b33435a15ffee912f47c5443ffc13">2.4 - 覆盖率统计</h1>
    <div class="lead">覆盖率工具</div>
	<blockquote>
<p>Picker 工具支持生成代码行覆盖率报告，toffee-test（<a href="https://github.com/XS-MLVP/toffee-test">https://github.com/XS-MLVP/toffee-test</a>） 项目支持生成功能覆盖率报告。</p></blockquote>
<h2 id="代码行覆盖率">代码行覆盖率</h2>
<p>目前 Picker 工具支持基于 Verilator 仿真器生成的代码行覆盖率报告。</p>
<h3 id="verilator">Verilator</h3>
<p>Verilator 仿真器提供了<a href="https://verilator.org/guide/latest/exe_verilator_coverage.html">覆盖率支持</a>功能。
该功能的实现方式是：</p>
<ol>
<li>利用 <code>verilator_coverage</code> 工具处理或合并覆盖率数据库，最终针对多个 DUT 生成一个 <code>coverage.info</code> 文件。</li>
<li>利用 <code>lcov</code> 工具的 <code>genhtml</code> 命令基于<code>coverage.info</code>和 RTL 代码源文件，生成完整的代码覆盖率报告。</li>
</ol>
<p>使用时的流程如下：</p>
<ol>
<li>使用 Picker 生成 dut 时，使能 COVERAGE 功能 （添加<code>-c</code>选项）。</li>
<li>仿真器运行完成后，<code>dut.Finish()</code> 之后会生成覆盖率数据库文件 <code>V{DUT_NAME}.dat</code>。</li>
<li>基于 <code>verilator_coverage</code> 的 write-info 功能将其转换成 <code>.info</code>文件。</li>
<li>基于 <code>lcov</code> 的 <code>genhtml</code> 功能，使用<code>.info</code>文件和文件中指定的<strong>rtl 源文件</strong>，生成 html 报告。</li>
</ol>
<blockquote>
<p>注意： 文件中指定的<strong>rtl 源文件</strong>是指在生成的<code>DUT</code>时使用的源文件路径，需要保证这些路径在当前环境下是有效的。简单来说，需要编译时用到的所有<code>.sv/.v</code>文件都需要在当前环境下存在，并且目录不变。</p></blockquote>
<h4 id="verilator_coverage">verilator_coverage</h4>
<p><code>verilator_coverage</code> 工具用于处理 <code>DUT</code> 运行后生成的 <code>.dat</code> 的覆盖率数据。该工具可以处理并合并多个 <code>.dat</code> 文件，同时具有两类功能：</p>
<ol>
<li>
<p>基于 <code>.dat</code> 文件生成 <code>.info</code> 文件，用于后续生成网页报告。</p>
<ul>
<li>
<p><code>-annotate &lt;output_dir&gt;</code>：以标注的形式在源文件中呈现覆盖率情况，结果保存到<code>output_dir</code>中。形式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sv" data-lang="sv"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100000</span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">logic</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// Begins with whitespace, because
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                        <span style="color:#8f5902;font-style:italic">// number of hits (100000) is above the limit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">000000</span>  <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">logic</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// Begins with %, because
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                        <span style="color:#8f5902;font-style:italic">// number of hits (0) is below the limit.
</span></span></span></code></pre></div></li>
<li>
<p><code>-annotate-min &lt;count&gt;</code>：指定上述的 limit 为 count</p>
</li>
</ul>
</li>
<li>
<p>可以将 <code>.dat</code> 文件，结合源代码文件，将覆盖率数据以标注的形式与源代码结合在一起，并写入到指定目录。</p>
<ul>
<li><code>-write &lt;merged-datafile&gt; -read &lt;datafiles&gt;</code>：将若干个.dat(<code>datafiles</code>)文件合并为一个.dat 文件</li>
<li><code>-write-info &lt;merged-info&gt; -read &lt;datafiles&gt;</code>：将若干个.dat(<code>datafiles</code>)文件合并为一个.info 文件</li>
</ul>
</li>
</ol>
<h4 id="genhtml">genhtml</h4>
<p>由 <code>locv</code> 包提供的 <code>genhtml</code> 可以由上述的.info 文件导出可读性更好的 html 报告。命令格式为：<code>genhtml [OPTIONS] &lt;infofiles&gt;</code>。
建议使用<code>-o &lt;outputdir&gt;</code>选项将结果输出到指定目录。</p>
<p>以<a href="/mlvp/docs/quick-start/eg-adder/">加法器</a>为例。</p>
<p><img src="adder.jpg" alt="adder.jpg"></p>
<h2 id="使用示例">使用示例</h2>
<p>如果您使用 Picker 时打开了<code>-c</code>选项，那么在仿真结束后，会生成一个<code>V{DUT_NAME}.dat</code>文件。并且顶层目录会有一个 Makefile 文件，其中包含了生成覆盖率报告的命令。</p>
<p>命令内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-make" data-lang="make"><span style="display:flex;"><span><span style="color:#000">coverage</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    verilator_coverage -write-info coverage.info ./<span style="color:#4e9a06">${</span><span style="color:#000">TARGET</span><span style="color:#4e9a06">}</span>/V<span style="color:#4e9a06">${</span><span style="color:#000">PROJECT</span><span style="color:#4e9a06">}</span>_coverage.dat
</span></span><span style="display:flex;"><span>    genhtml coverage.info --output-directory coverage
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p>在 shell 中输入<code>make coverage</code>,其会根据生成的.dat 文件生成 coverage.info，再使用<code>genhtml</code>再 coverage 目录下生成 html 报告。</p>
<h2 id="vcs">VCS</h2>
<p>VCS 对应的文档正在完善当中。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-23517bcdab7f12a802c8349bb10fd62e">2.5 - 多时钟</h1>
    <div class="lead">多时钟示例</div>
	<p>部分电路有多个时钟，XClock 类提供了分频功能，可以通过它实现对多时钟电路的驱动。</p>
<h2 id="xclock-中的-freqdivwith-接口">XClock 中的 FreqDivWith 接口</h2>
<p>XClock 函数提供如下分频接口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">XClock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">div</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// 分频数，，即绑定的XClock的频率为原时钟频率的div分之1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                     <span style="color:#000">XClock</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// 绑定的XClock
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">shift</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">// 对波形进行 shift 个半周期的移位
</span></span></span></code></pre></div><h2 id="xclock-的一般驱动流程">XClock 的一般驱动流程</h2>
<ol>
<li>创建 XClock，绑定 DUT 的驱动函数</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 假设已经创建了DUT，并将其命名为dut</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建XClock</span>
</span></span><span style="display:flex;"><span><span style="color:#000">xclock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">simStep</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ol start="2">
<li>绑定关联 clk 引脚</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># clk是dut的时钟引脚</span>
</span></span><span style="display:flex;"><span><span style="color:#000">xclock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Add方法具有别名：AddPin</span>
</span></span></code></pre></div><ol start="3">
<li>通过 XPort 绑定与 clk 关联的引脚</li>
</ol>
<p>因为在我们的工具中，对于端口的读写是通过 xclock 来驱动的，所以如果不将与 clk 关联的引脚绑定到 XClock 上，那么在驱动时，相关的引脚数值不会发生变化。<br>
比如，我们要进行复位操作，那么可以将 reset 绑定到 xclock 上。</p>
<p>方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xport</span><span style="color:#000;font-weight:bold">)</span>       <span style="color:#8f5902;font-style:italic">#将Clock和XData进行绑定</span>
</span></span></code></pre></div><p>举例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># xclock.Add(dut.xport.Add(pin_name, XData))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">xclock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;reset&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><hr>
<p>在经过了前面的绑定之后，接下来可以使用了。<br>
我们根据需要来设置回调、设置分频。当然，时序电路肯定也要驱动时钟。<br>
这些方法都可以参照<a href="https://open-verify.cc/mlvp/docs/env_usage/picker_usage/#xclock-%E7%B1%BB">工具介绍</a>。</p>
<p>下面是举例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># func为回调函数，args为自定义参数</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#设置上升沿回调函数</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kwargs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#设置下降沿回调函数</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepFal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kwargs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 假设xclock是XClock的实例</span>
</span></span><span style="display:flex;"><span><span style="color:#000">xclock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">half_clock</span><span style="color:#000;font-weight:bold">)</span>           <span style="color:#8f5902;font-style:italic"># 将xclock的频率分频为原来的一半</span>
</span></span><span style="display:flex;"><span><span style="color:#000">xclock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">left_clock</span><span style="color:#a40000">，</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>      <span style="color:#8f5902;font-style:italic"># 将xclock的频率不变，对波形进行一个周期的左移</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">#推进10个时钟周期</span>
</span></span></code></pre></div><h2 id="多时钟案例">多时钟案例</h2>
<p>例如多时钟电路有 6 个 clock，每个 clock 都有一个对应的计数器，设计代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">multi_clock</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk6</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">reg1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">reg2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">reg3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">reg4</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">reg5</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">reg6</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">initial</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#0000cf;font-weight:bold">&#39;b0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#0000cf;font-weight:bold">&#39;b0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#0000cf;font-weight:bold">&#39;b0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#0000cf;font-weight:bold">&#39;b0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#0000cf;font-weight:bold">&#39;b0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#0000cf;font-weight:bold">&#39;b0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg1</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">reg1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg2</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">reg2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg3</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">reg3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg4</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">reg4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk5</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg5</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">reg5</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reg6</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">reg6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>通过picker导出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> multi_clock.v -w mc.fst --tdir picker_out/MultiClock --lang python
</span></span></code></pre></div><p>可以通过如下 Python 进行多时钟驱动：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">MultiClock</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">xspcomm</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">XClock</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_multi_clock</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建DUT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTmulti_clock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建主时钟</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">simStep</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建子时钟</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">XClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 给子时钟添加相关的clock引脚及关联端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SelectPins</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;reg1&#34;</span><span style="color:#000;font-weight:bold">]))</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AddPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SelectPins</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;reg2&#34;</span><span style="color:#000;font-weight:bold">]))</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AddPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk3</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SelectPins</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;reg3&#34;</span><span style="color:#000;font-weight:bold">]))</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AddPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk3</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk4</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SelectPins</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;reg4&#34;</span><span style="color:#000;font-weight:bold">]))</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AddPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk4</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk5</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SelectPins</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;reg5&#34;</span><span style="color:#000;font-weight:bold">]))</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AddPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk5</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">clk6</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SelectPins</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;reg6&#34;</span><span style="color:#000;font-weight:bold">]))</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">AddPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clk6</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">xdata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 将主时钟频率分频到子时钟</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">FreqDivWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clk6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 驱动时钟</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main_clock</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">test_multi_clock</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>上述代码输出的波形如下：</p>
<p><img src="multiclock.png" alt="multi_clock"></p>
<p>可以看到：</p>
<ul>
<li>clk2 的周期是 clk1 的 2 倍</li>
<li>clk3 的周期是 clk1 的 3 倍，</li>
<li>clk4 的周期和 clk1 相同，但是进行了半个周期的右移</li>
<li>clk5 的周期和 clk2 相同，但是进行了半个周期的左移</li>
<li>clk6 的周期和 clk3 相同，但是进行了一个周期的左移</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f6542656fa3ae5b8529f1bb909b3e00">2.6 - 多实例</h1>
    <div class="lead">多实例示例</div>
	<p>在Verilog中，一个module只有一个实例，但很多测试场景下需要实现多个module，为此picker提供了动态多实例和静态多实例的支持。</p>
<h2 id="动态多实例">动态多实例</h2>
<p>动态多实例相当于类的实例化，在创建dut的同时实例化对应的module，所以用户无感知。支持最大16个实例同时运行。</p>
<p>例子：</p>
<p>以Adder为例，我们可以在测试时根据需要在合适的位置创建多个dut，来动态创建多个Adder实例。
当需要销毁一个dut时，也不会影响后续创建新的dut。</p>
<p>创建一个名为 picker_out_adder 的文件夹，其中包含一个 Adder.v 文件。该文件的源码参考<a href="https://open-verify.cc/mlvp/docs/quick-start/eg-adder/">案例一：简单加法器</a>。</p>
<p>运行下述命令将RTL导出为 Python Module：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> Adder.v --autobuild <span style="color:#204a87">true</span> -w Adder.fst --sname Adder
</span></span></code></pre></div><p>在picker_out_adder中添加 <code>example.py</code>，动态创建多个Adder实例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">127</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 可以通过创建多个dut，实例化多个Adder，理论上支持最大16个实例同时运行</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 这里通过循环创建了7个dut</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">.fst&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">d</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;DUT: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 通过Finish()函数在合适的时机撤销某个dut，也即销毁某个实例</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">d</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 可以根据需要在合适的时机创建新的Adder实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 下面创建了一个新的dut，旨在说明可以在程序结束前的任何时机创建新的dut</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut_new</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;new.fst&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;DUT: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut_new</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>注：目前仅支持 verilator模拟器</p>
<h2 id="静态多实例">静态多实例</h2>
<p>静态多实例的使用不如动态多实例灵活，相当于在进行dut封装时就创建了n个目标模块。
需要在使用 picker 生成 dut_top.sv/v 的封装时，通过&ndash;sname参数指定多个模块名称和对应的数量。</p>
<h3 id="单个模块需要多实例">单个模块需要多实例</h3>
<p>同样以Adder为例，在使用picker对dut进行封装时执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> Adder.v --autobuild <span style="color:#204a87">true</span> -w Adder.fst --sname Adder,3
</span></span></code></pre></div><p>通过&ndash;sname参数指定在dut中创建3个Adder，封装后dut的引脚定义为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># init.py </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这里仅放置了部分代码</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># all Pins</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 静态多实例</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>可以看到在 picker 生成 dut 时，就在 DUTAdder 内创建了多个Adder实例。</p>
<p>下面是简单的多实例代码举例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">127</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 在dut内部实例化了多个Adder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">waveform_filename</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.fst&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Adder_0: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Adder_1: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Adder_2: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_2_cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 静态多实例不可以根据需要动态的创建新的Adder实例，三个Adder实例的周期与dut的生存周期相同</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="多个模块需要多实例">多个模块需要多实例</h3>
<p>例如在 Adder.v 和 RandomGenerator.v 设计文件中分别有模块 Adder 和 RandomGenerator，RandomGenerator.v文件的源码为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">RandomGenerator</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">reset</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">seed</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">random_number</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">reset</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">lfsr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">seed</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">lfsr</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">126</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">126</span><span style="color:#000;font-weight:bold">]};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">random_number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lfsr</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>需要 DUT 中有 2 个 Adder，3 个 RandomGenerator，生成的模块名称为 RandomAdder（若不指定，默认名称为 Adder_Random），则可执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> Adder.v,RandomGenerator.v --sname Adder,2,RandomGenerator,3 --tname RandomAdder -w randomadder.fst
</span></span></code></pre></div><p>得到封装后的dut为<code>DUTRandomAdder</code>，包含2个Adder实例和3个RandomGenerator实例。</p>
<p>封装后dut的引脚定义为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># init.py </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这里仅放置了部分代码</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DUTRandomAdder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># all Pins</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 静态多实例</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_clk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_reset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_random_number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_clk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_reset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_random_number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_clk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_reset</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_random_number</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XPin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xsp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">XData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Out</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>可以看到在 picker 生成 dut 时，就在 DUTAdder 内创建了多个Adder实例。</p>
<p>对应的测试代码举例为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">RandomAdder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">127</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 在dut内部实例化了多个Adder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTRandomAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RandomGenerator_0_clk&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RandomGenerator_1_clk&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RandomGenerator_2_clk&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random_int</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 在dut内部实例化了多个RandomGenerator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">128</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_seed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">seed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_reset</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Cycle </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, DUT: </span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_0_random_number</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_seed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">seed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_reset</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Cycle </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, DUT: </span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_1_random_number</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_seed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">seed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_reset</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Cycle </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, DUT: </span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">RandomGenerator_2_random_number</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">x</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Adder_0: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_0_cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Adder_1: sum=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, cout=</span><span style="color:#4e9a06">{</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Adder_1_cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 静态多实例各个模块多个实例的生命周期与dut的生命周期相同</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5d14fb48f09c8e7b39f81cc2a6999931">2.7 - 内部信号</h1>
    <div class="lead">内部信号示例</div>
	<p>内部信号是指未在模块IO端口中暴露，但在模块内部承担控制、数据传输或状态跟踪等功能的信号。通常，picker在将RTL转换为DUT时只会自动暴露IO端口，内部信号不会被主动导出。</p>
<p>但在需要对模块内部逻辑进行更细致验证，或根据已知bug进一步定位问题时，验证人员往往需要访问这些内部信号。除了传统的verilator和VCS等工具，picker还提供了内部信号提取机制，可作为辅助手段。</p>
<h2 id="动机">动机</h2>
<p>以上限计数器为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">UpperCounter</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>           
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">reset</span><span style="color:#000;font-weight:bold">,</span>         
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">count</span>   
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">upper</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000">upper</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;b1111</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">always</span> <span style="color:#000;font-weight:bold">@(</span><span style="color:#204a87;font-weight:bold">posedge</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#0000cf;font-weight:bold">&#39;b0000</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">upper</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">begin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>模块的IO信号指的是直接写在模块定义中的信号，也就是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">UpperCounter</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">clk</span><span style="color:#000;font-weight:bold">,</span>           
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#204a87;font-weight:bold">wire</span> <span style="color:#000">reset</span><span style="color:#000;font-weight:bold">,</span>         
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#204a87;font-weight:bold">reg</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">count</span>   
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>该部分中的 clk、reset 和 count 是 IO 信号，可以直接暴露访问。而紧接着的 <code>wire upper;</code> 则属于内部信号，其取值由模块输入和模块内部逻辑共同决定。本案例中的计数器逻辑较为简单，但对于更大规模的硬件模块，常常会遇到以下难题：</p>
<ul>
<li>当模块输出与预期不符时，问题范围较大，难以及时定位，需要有效手段快速缩小排查范围；</li>
<li>模块内部逻辑复杂，理解和分析存在困难，此时也需要借助内部信号作为关键标记，理清模块运行机制。</li>
</ul>
<p>针对上述问题，访问和分析内部信号是非常有效的手段。传统上，通常借助如 Verilator、VCS 等仿真工具来查看内部信号。<strong>为进一步降低验证门槛，picker 还提供了三种内部信号访问方式：DPI 直接导出、VPI 动态访问和直接内存读写。</strong></p>
<h2 id="dpi-直接导出">DPI 直接导出</h2>
<p>DPI即Direct Programming Interface，是verilog与其他语言交互的接口，在picker的默认实现中，支持了为待测硬件模块的IO端口提供DPI。在执行picker时，如果添加了--internal
选项，则可同样为待测模块的内部信号提供DPI。此时，picker将会基于预定义的内部信号文件，在将verilog转化为DUT时，同步抽取rtl中的内部信号和IO端口一并暴露出来。</p>
<h3 id="编写信号文件">编写信号文件</h3>
<p>信号文件是我们向picker指定需要提取的内部信号的媒介，它规定了需提取内部信号的模块和该模块需要提取的内部信号。</p>
<p>示例internal.yaml，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">UpperCounter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;wire upper&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>第一行是模块名称，如UpperCounter，第二行开始是需要提取的模块内部信号，以“类型 信号名”的格式写出。比如，upper的类型为wire，我们就写成“wire upper”
（理论上只要信号名符合verilog代码中的变量名就可以匹配到对应的信号，类型随便写都没问题，但还是建议写verilog语法支持的类型，比如wire、log、logic等）</p>
<p>内部信号提取的能力取决于模拟器，譬如，verilator就无法提取下划线_开头的信号。</p>
<p>注：多位宽的内部信号需要显式写出位宽，所以实际的格式是“类型 [宽度] 信号名”</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">UpperCounter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;wire upper&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;reg [3:0] another_multiples&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 本案例中这个信号不存在，只是用于说明yaml的格式</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="选项支持">选项支持</h3>
<p>写好信号文件之后，需要在运行picker时显式指定内部文件，这通过internal选项完成：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>--internal<span style="color:#ce5c00;font-weight:bold">=[</span>internal_signal_file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>完整命令如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --autobuild<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> upper_counter.sv -w upper_counter.fst --sname UpperCounter <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--tdir picker_out_upper_counter/ --lang python -e --sim verilator --internal<span style="color:#ce5c00;font-weight:bold">=</span>internal.yaml
</span></span></code></pre></div><p>我们可以找到picker为DUT配套生成的signals.json文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;UpperCounter_upper&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;High&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Low&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Pin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;wire&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;_&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;clk&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;High&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Low&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Pin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;input&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;_&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;High&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Low&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Pin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;output&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;_&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;reset&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;High&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">-1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Low&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Pin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;input&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;_&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这个文件展示了picker生成的信号接口，可以看到，第一个信号UpperCounter_upper就是我们需要提取的内部信号，
其中第一个下划线之前的部分是我们在internal.yaml中的第一行定义的模块名UpperCounter，后面的部分则是内部信号名。</p>
<h3 id="信号访问">信号访问</h3>
<p>picker完成提取之后，内部信号的访问和io信号的访问就没有什么区别了，本质上他们都是dut上的一个XData，使用“dut.信号名”的方式访问即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">UpperCounter</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTUpperCounter</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">UpperCounter_upper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="vpi动态访问">VPI动态访问</h2>
<p>VPI（Verilog Procedural Interface）是Verilog语言的一种标准接口，用于在仿真时让C语言等外部程序与Verilog仿真器进行交互。通过VPI，用户可以在C程序中访问、读取、修改Verilog仿真中的信号、变量、模块实例等信息，还可以注册回调函数，实现对仿真过程的控制和扩展。VPI常用于开发自定义系统任务、实现高级验证功能、动态信号访问和波形处理等。VPI 是 IEEE 1364 标准的一部分。</p>
<h3 id="选项支持-1">选项支持</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --help
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>--vpi Enable VPI, <span style="color:#204a87;font-weight:bold">for</span> flexible internal signal access default is OFF
</span></span></code></pre></div><p>可通过参数<code>--vpi</code>开启VPI支持，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> upper_counter.sv --sname UpperCounter --tdir picker_out_upper_counter/ --lang python --vpi
</span></span></code></pre></div><h3 id="信号访问-1">信号访问</h3>
<p>开启<code>--vpi</code>后，可通过DUT的接口<code>dut.GetInternalSignalList(use_vpi=True)</code>列出所有内部可访问信号，通过<code>dut.GetInternalSignal(name, use_vpi=True)</code>动态构建XData进行数据访问。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">UpperCounter</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTUpperCounter</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 列出所有内部信号</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 或者通过 dut.VPIInternalSignalList()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GetInternalSignalList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">use_vpi</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 动态构建 XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">internal_upper</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GetInternalSignal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;UpperCounter.upper&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">use_vpi</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 读访问</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">internal_upper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 写访问 (虽然能写入，但是dut step后值会被覆盖，不建议对非reg类型进行写操作)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">internal_upper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x1</span>
</span></span></code></pre></div><h2 id="直接内存读写">直接内存读写</h2>
<p>无论是基于DPI还是VPI进行内部信号访问都有一定的性能开销，为了实现极致性能体验，picker针对verilator/GSIM仿真器实现了内部信号直接访问。</p>
<h3 id="选项支持-2">选项支持</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> --help
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>--rw,--access-mode ENUM:value in <span style="color:#ce5c00;font-weight:bold">{</span>dpi-&gt;0,mem_direct-&gt;1<span style="color:#ce5c00;font-weight:bold">}</span> OR <span style="color:#ce5c00;font-weight:bold">{</span>0,1<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>可通过参数<code>--rw 1</code>开启针对verilator仿真器内部信号直接读写功能，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>picker <span style="color:#204a87">export</span> upper_counter.sv --sname UpperCounter --tdir picker_out_upper_counter/ --lang python --rw <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><h3 id="信号访问-2">信号访问</h3>
<p>开启<code>直接内存读写</code>后，可通过<code>dut.GetInternalSignalList(use_vpi=False)</code>列出所有内部信号，通过<code>dut.GetInternalSignal(name, use_vpi=False)</code>动态构建XData实现信号读写。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">UpperCounter</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTUpperCounter</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 列出所有内部信号</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GetInternalSignalList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">use_vpi</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 动态构建 XData</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">internal_upper</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">GetInternalSignal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;UpperCounter_top.UpperCounter.upper&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">use_vpi</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 读访问</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">internal_upper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 写访问 (虽然能写入，但是dut step后值会被覆盖，不建议对非reg类型进行写操作)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">internal_upper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x1</span>
</span></span></code></pre></div><h2 id="内部信号访问方法对比">内部信号访问方法对比</h2>
<p>picker提供的每种内部信号访问方法都有各自的优缺点，需要按需要进行选择。</p>
<table>
  <thead>
      <tr>
          <th>方法名称</th>
          <th>开启参数</th>
          <th>优点</th>
          <th>缺点</th>
          <th>访问接口</th>
          <th>支持仿真器</th>
          <th>适用场景</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>DPI 直接导出</td>
          <td>&ndash;internal=cfg.yaml</td>
          <td>速度快</td>
          <td>需要提前指定信号<br>信号只读<br>修改后需要重新编译</td>
          <td>无（同普通引脚）</td>
          <td>verilator、VCS</td>
          <td>信号少，不需要写操作</td>
      </tr>
      <tr>
          <td>VPI动态访问</td>
          <td>&ndash;vpi</td>
          <td>灵活，信号全<br>不需要提前指定信号</td>
          <td>速度慢</td>
          <td>GetInternalSignalList<br>GetInternalSignal</td>
          <td>verilator、VCS</td>
          <td>小规模电路或不在意仿真速度</td>
      </tr>
      <tr>
          <td>直接内存读写</td>
          <td>&ndash;rw 1</td>
          <td>速度快<br>灵活<br>不需要提前指定信号</td>
          <td>部分信号可能被优化掉</td>
          <td>GetInternalSignalList<br>GetInternalSignal</td>
          <td>verilator、GSIM</td>
          <td>大规模电路，例如整个香山核</td>
      </tr>
  </tbody>
</table>
<p>*注： 上述方法彼此独立，可以混用</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a2e75c30d9ecce2bb906ec293eb6678e">2.8 - 集成测试框架</h1>
    <div class="lead">可用软件测试框架</div>
	

<div class="pageinfo pageinfo-primary">
<p>在芯片验证的传统实践中，UVM等框架被广泛采用。尽管它们提供了一整套验证方法，但通常只适用于特定的硬件描述语言和仿真环境。本工具突破了这些限制，能够将仿真代码转换成C++或Python，使得我们可以利用软件验证工具来进行更全面的测试。<br>
因为Python具有强大的生态系统，所以本项目主要以Python作为示例，简单介绍Pytest和Hypothesis两个经典软件测试框架。<strong>Pytest以其简洁的语法和丰富的功能，轻松应对各种测试需求</strong>。而<strong>Hypothesis则通过生成测试用例，揭示出意料之外的边缘情况，提高了测试的全面性和深度</strong>。<br>
我们的项目从一开始就设计为与多种现代软件测试框架兼容。我们鼓励您探索这些工具的潜力，并将其应用于您的测试流程中。通过亲身实践，您将更深刻地理解这些工具如何提升代码的质量和可靠性。让我们一起努力，提高芯片开发的质量。</p>

</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59e8c01d61d7cbb458b1aedd8931a8d4">2.8.1 - PyTest</h1>
    <div class="lead">可用来管理测试，生成测试报告</div>
	<h2 id="软件测试">软件测试</h2>
<blockquote>
<p>在正式开始pytest 之间我们先了解一下软件的测试，软件测试一般分为如下四个方面</p>
<ul>
<li>单元测试：称模块测试，针对软件设计中的最小单位——程序模块，进行正确性检查的测试工作</li>
<li>集成测试：称组装测试，通常在单元测试的基础上，将所有程序模块进行有序的、递增测试，重点测试不同模块的接口部分</li>
<li>系统测试：将整个软件系统看成一个整体进行测试，包括对功能、性能以及软件所运行的软硬件环境进行测试</li>
<li>验收测试：指按照项目任务书或合同、供需双方约定的验收依据文档进行的对整个系统的测试与评审，决定是否接收或拒收系统</li>
</ul></blockquote>
<p>pytest最初是作为一个单元测试框架而设计的，但它也提供了许多功能，使其能够进行更广泛的测试，包括集成测试，系统测试，他是一个非常成熟的全功能的python 测试框架。
它通过收集测试函数和模块，并提供丰富的断言库来简化测试的编写和运行，是一个非常成熟且功能强大的 Python 测试框架，具有以下几个特点：</p>
<ul>
<li><strong>简单灵活</strong>：Pytest 容易上手，且具有灵活性。</li>
<li><strong>支持参数化</strong>：您可以轻松地为测试用例提供不同的参数。</li>
<li><strong>全功能</strong>：Pytest 不仅支持简单的单元测试，还可以处理复杂的功能测试。您甚至可以使用它来进行自动化测试，如 Selenium 或 Appium 测试，以及接口自动化测试（结合 Pytest 和 Requests 库）。</li>
<li><strong>丰富的插件生态</strong>：Pytest 有许多第三方插件，您还可以自定义扩展。一些常用的插件包括：
<ul>
<li><code>pytest-selenium</code>：集成 Selenium。</li>
<li><code>pytest-html</code>：生成HTML测试报告。</li>
<li><code>pytest-rerunfailures</code>：在失败的情况下重复执行测试用例。</li>
<li><code>pytest-xdist</code>：支持多 CPU 分发。</li>
</ul>
</li>
<li><strong>与 Jenkins 集成良好</strong>。</li>
<li><strong>支持 Allure 报告框架</strong>。</li>
</ul>
<p>本文将基于测试需求简单介绍pytest的用法，其<a href="https://learning-pytest.readthedocs.io/zh/latest/">完整手册</a>在这里，供同学们进行深入学习。</p>
<h2 id="pytest安装">Pytest安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装pytest：</span>
</span></span><span style="display:flex;"><span>pip install pytest
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 升级pytest</span>
</span></span><span style="display:flex;"><span>pip install -U pytest
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看pytest版本</span>
</span></span><span style="display:flex;"><span>pytest --version
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看已安装包列表</span>
</span></span><span style="display:flex;"><span>pip list
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看pytest帮助文档</span>
</span></span><span style="display:flex;"><span>pytest -h
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装第三方插件</span>
</span></span><span style="display:flex;"><span>pip install pytest-sugar
</span></span><span style="display:flex;"><span>pip install pytest-rerunfailures
</span></span><span style="display:flex;"><span>pip install pytest-xdist
</span></span><span style="display:flex;"><span>pip install pytest-assume
</span></span><span style="display:flex;"><span>pip install pytest-html
</span></span></code></pre></div><h2 id="pytest使用">Pytest使用</h2>
<h3 id="命名规则">命名规则</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 首先在使用pytest 时我们的模块名通常是以test开头或者test结尾，也可以修改配置文件，自定义命名规则</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># test_*.py 或 *_test.py</span>
</span></span><span style="display:flex;"><span><span style="color:#000">test_demo1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">demo2_test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 模块中的类名要以Test 开始且不能有init 方法</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TestDemo1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TestLogin</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 类中定义的测试方法名要以test_开头</span>
</span></span><span style="display:flex;"><span><span style="color:#000">test_demo1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">test_demo2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 测试用例</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">test_one</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_demo1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;测试用例1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_demo2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;测试用例2&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="pytest-参数">Pytest 参数</h3>
<p>pytest支持很多参数，可以通过help命令查看</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pytest -help
</span></span></code></pre></div><p>我们在这里列出来常用的几个：</p>
<p>-m: 用表达式指定多个标记名。 pytest 提供了一个装饰器 @pytest.mark.xxx，用于标记测试并分组（xxx是你定义的分组名），以便你快速选中并运行，各个分组直接用 and、or 来分割。</p>
<p>-v: 运行时输出更详细的用例执行信息 不使用-v参数，运行时不会显示运行的具体测试用例名称；使用-v参数，会在 console 里打印出具体哪条测试用例被运行。</p>
<p>-q: 类似 unittest 里的 verbosity，用来简化运行输出信息。 使用 -q 运行测试用例，仅仅显示很简单的运行信息， 例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.s..  <span style="color:#ce5c00;font-weight:bold">[</span>100%<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> passed, <span style="color:#0000cf;font-weight:bold">1</span> skipped in 9.60s
</span></span></code></pre></div><p>-k: 可以通过表达式运行指定的测试用例。 它是一种模糊匹配，用 and 或 or 区分各个关键字，匹配范围有文件名、类名、函数名。</p>
<p>-x: 出现一条测试用例失败就退出测试。 在调试时，这个功能非常有用。当出现测试失败时，停止运行后续的测试。</p>
<p>-s: 显示print内容 在运行测试脚本时，为了调试或打印一些内容，我们会在代码中加一些print内容，但是在运行pytest时，这些内容不会显示出来。如果带上-s，就可以显示了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pytest test_se.py -s
</span></span></code></pre></div><h3 id="pytest-选择测试用例执行">Pytest 选择测试用例执行</h3>
<p><strong>在 Pytest 中，您可以按照测试文件夹、测试文件、测试类和测试方法的不同维度来选择执行测试用例。</strong></p>
<ul>
<li>按照测试文件夹执行</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行所有当前文件夹及子文件夹下的所有测试用例</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#ce5c00;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行跟当前文件夹同级的tests文件夹及子文件夹下的所有测试用例</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#ce5c00;font-weight:bold">../</span><span style="color:#000">tests</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 按照测试文件执行</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行test_se.py下的所有的测试用例</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#000">test_se</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 按照测试类执行，必须以如下格式：</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#000">文件名</span> <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">py</span><span style="color:#000;font-weight:bold">::</span> <span style="color:#000">测试类</span><span style="color:#a40000">，</span><span style="color:#000">其中</span><span style="color:#a40000">“</span><span style="color:#000;font-weight:bold">::</span><span style="color:#a40000">”</span><span style="color:#000">是分隔符</span><span style="color:#a40000">，</span><span style="color:#000">用于分割测试module和测试类</span><span style="color:#a40000">。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行test_se.py文件下的，类名是TestSE下的所有测试用例</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#000">test_se</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">py</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">TestSE</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 测试方法执行，必须以如下格式：</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#000">文件名</span> <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">py</span><span style="color:#000;font-weight:bold">::</span> <span style="color:#000">测试类</span> <span style="color:#000;font-weight:bold">::</span> <span style="color:#000">测试方法</span><span style="color:#a40000">，</span><span style="color:#000">其中</span> <span style="color:#a40000">“</span><span style="color:#000;font-weight:bold">::</span><span style="color:#a40000">”</span> <span style="color:#000">是分隔符</span><span style="color:#a40000">，</span><span style="color:#000">用于分割测试module</span><span style="color:#a40000">、</span><span style="color:#000">测试类</span><span style="color:#a40000">，</span><span style="color:#000">以及测试方法</span><span style="color:#a40000">。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行test_se.py文件下的，类名是TestSE下的，名字为test_get_new_message的测试用例</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span> <span style="color:#000">test_se</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">py</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">TestSE</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">test_get_new_message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以上选择测试用例的方法均是在**命令行**，如果您想直接在测试程序里执行可以直接在main函数中**调用pytest.main()**,其格式为：</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pytest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">main</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">模块</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">py</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">类</span><span style="color:#000;font-weight:bold">::</span><span style="color:#000">方法</span><span style="color:#000;font-weight:bold">])</span>
</span></span></code></pre></div><blockquote>
<p>此外，Pytest 还支持控制测试用例执行的多种方式，例如过滤执行、多进程运行、重试运行等。</p></blockquote>
<h2 id="使用pytest编写验证">使用Pytest编写验证</h2>
<ul>
<li>在测试过程中，我们使用之前验证过的加法器，进入Adder文件夹，在picker_out_adder目录下新建一个test_adder.py文件，内容如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 导入测试模块和所需的库</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">pytest</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ctypes</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">random</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用 pytest fixture 来初始化和清理资源</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">adder</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建 DUTAdder 实例，加载动态链接库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 执行一次时钟步进，准备 DUT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># yield 语句之后的代码会在测试结束后执行，用于清理资源</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">dut</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 清理DUT资源，并生成测试覆盖率报告和波形</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TestFullAdder</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 将 full_adder 定义为静态方法，因为它不依赖于类实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">full_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0b1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ctypes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">c_uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">ctypes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">c_uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0b1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#0000cf;font-weight:bold">0xffffffffffffffff</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cout</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 使用 pytest.mark.usefixtures 装饰器指定使用的 fixture</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@pytest.mark.usefixtures</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;adder&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 定义测试方法，adder 参数由 pytest 通过 fixture 注入</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adder</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 进行多次随机测试</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">114514</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># 随机生成 64 位的 a 和 b，以及 1 位的进位 cin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getrandbits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getrandbits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getrandbits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># 设置 DUT 的输入</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># 执行一次时钟步进</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># 使用静态方法计算预期结果</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">full_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># 断言 DUT 的输出与预期结果相同</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pytest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">main</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#39;-v&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;test_adder.py::TestFullAdder&#39;</span><span style="color:#000;font-weight:bold">])</span>
</span></span></code></pre></div><ul>
<li>运行测试之后输出如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>collected <span style="color:#0000cf;font-weight:bold">1</span> item
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> test_adder.py ✓                                                 100% ██████████
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Results <span style="color:#ce5c00;font-weight:bold">(</span>4.33s<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span></code></pre></div><blockquote>
<p>测试成功表明，在经过114514次循环之后，我们的设备暂时没有发现bug。然而，使用多次循环的随机数生成测试用例会消耗大量资源，并且这些随机生成的测试用例可能无法有效覆盖所有边界条件。在下一部分，我们将介绍一种更有效的测试用例生成方法。</p></blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e228270a25eab6e1035925a8e92bf6f0">2.8.2 - Hypothesis</h1>
    <div class="lead">可用来生成激励</div>
	<h1 id="hypothesis">Hypothesis</h1>
<p>在上一节中，我们通过手动编写测试用例，并为每个用例指定输入和预期输出。这种方式存在一些问题，例如测试用例覆盖不全面、<strong>边界条件</strong> 容易被忽略等。它是一个用于属性基于断言的软件测试的 Python 库。Hypothesis 的主要目标是使测试<strong>更简单、更快速、更可靠</strong>。它使用了一种称为<strong>属性基于断言</strong>的测试方法，即你可以为你的代码编写一些假（hypotheses），然后 Hypothesis 将会自动生成测试用例并验证这些假设。这使得编写全面且高效的测试变得更加容易。Hypothesis 可以自动生成各种类型的输入数据，包括基本类型（例如整数、浮点数、字符串等）、容器类型（例如列表、集合、字典等）、自定义类型等。然后，它会根据你提供的属性（即断言）进行测试，如果发现测试失败，它将尝试缩小输入数据的范围以找出最小的失败案例。通过 Hypothesis，你可以更好地覆盖代码的边界条件，并发现那些你可能没有考虑到的错误情况。这有助于提高代码的质量和可靠性。</p>
<h2 id="基本概念">基本概念</h2>
<ul>
<li>测试函数：即待测试的函数或方法，我们需要对其进行测试。</li>
<li>属性：定义了测试函数应该满足的条件。属性是以装饰器的形式应用于<strong>测试函数</strong>上的。</li>
<li>策略：用于生成测试数据的生成器。Hypothesis 提供了一系列内置的策略，如整数、字符串、列表等。我们也可以<strong>自定义策略</strong>。</li>
<li>测试生成器：基于策略生成测试数据的函数。Hypothesis 会自动为我们生成测试数据，并将其作为参数传递给测试函数。</li>
</ul>
<p>本文将基于测试需求简单介绍Hypothesis的用法，其<a href="https://hypothesis.readthedocs.io/en/latest/">完整手册</a>在这里，供同学们进行深入学习。</p>
<h2 id="安装">安装</h2>
<p>使用pip安装，在python中导入即可使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pip install hypothesis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import hypothesis
</span></span></code></pre></div><h2 id="基本用法">基本用法</h2>
<h3 id="属性和策略">属性和策略</h3>
<p>Hypothesis 使用属性装饰器来定义测试函数的属性。最常用的装饰器是 @given，它指定了测试函数应该满足的属性。 <br>
我们可以通过@given 装饰器定义了一个测试函数 test_addition。并给x 添加对应的属性，测试生成器会自动为测试函数生成测试数据，并将其作为参数传递给函数，例如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">addition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@given</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">integers</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">integers</span><span style="color:#000;font-weight:bold">())</span>　　
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_addition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">):</span>　　   
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">addition</span><span style="color:#a40000">（</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#a40000">）</span>
</span></span></code></pre></div><p>其中integers () 是一个内置的策略，用于生成整数类型的测试数据。Hypothesis 提供了丰富的内置策略，用于生成各种类型的测试数据。除了integers ()之外，还有字符串、布尔值、列表、字典等策略。例如使用 text () 策略生成字符串类型的测试数据，使用 lists (text ()) 策略生成字符串列表类型的测试数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@given</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">text</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">l</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">lists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">text</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_string_concatenation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">):</span>　　   
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>　　   
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>除了可以使用内置的策略以外，还可以使用自定义策略来生成特定类型的测试数据，例如我们可以生产一个非负整形的策略</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">non_negative_integers</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>　　<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">integers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">min_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@given</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">non_negative_integers</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>　　<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_positive_addition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>　　<span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">x</span>
</span></span></code></pre></div><h3 id="期望">期望</h3>
<p>我们可以通过expect 来指明需要的函数期待得到的结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@given</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">integers</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_addition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expected</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">actual</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">addition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="假设和断言">假设和断言</h3>
<p>在使用 Hypothesis 进行测试时，我们可以使用标准的 Python 断言来验证测试函数的属性。Hypothesis 会自动为我们生成测试数据，并根据属性装饰器中定义的属性来运行测试函数。如果断言失败，Hypothesis 会尝试缩小测试数据的范围，以找出导致失败的最小样例。</p>
<p>假如我们有一个字符串反转函数，我们可以通过assert 来判断翻转两次后他是不是等于自身</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_reverse_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">expected</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">actual</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">addition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">actual</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">expected</span>
</span></span></code></pre></div><h2 id="编写测试">编写测试</h2>
<ul>
<li>
<p>Hypothesis 中的测试由两部分组成：一个看起来像您选择的测试框架中的常规测试但带有一些附加参数的函数，以及一个@given指定如何提供这些参数的装饰器。以下是如何使用它来验证我们之前验证过的全加器的示例：</p>
</li>
<li>
<p>在上一节的代码基础上，我们进行一些修改，将生成测试用例的方法从随机数修改为integers ()方法，修改后的代码如下：</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">Adder</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">pytest</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">hypothesis</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">given</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strategies</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">st</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用 pytest fixture 来初始化和清理资源</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scope</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;class&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">adder</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建 DUTAdder 实例，加载动态链接库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># yield 语句之后的代码会在测试结束后执行，用于清理资源</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">dut</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 清理DUT资源，并生成测试覆盖率报告和波形</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TestFullAdder</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 将 full_adder 定义为静态方法，因为它不依赖于类实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">full_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0b1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">128</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0b1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Sum</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#0000cf;font-weight:bold">0xffffffffffffffffffffffffffffffff</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cout</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 使用 hypothesis 自动生成测试用例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@given</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">st</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">integers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">min_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0xffffffffffffffff</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">st</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">integers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">min_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0xffffffffffffffff</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">st</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">integers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">min_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 定义测试方法，adder 参数由 pytest 通过 fixture 注入</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_full_adder_with_hypothesis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 计算预期的和与进位</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sum_expected</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout_expected</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">full_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 设置 DUT 的输入</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 执行一次时钟步进</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 断言 DUT 的输出与预期结果相同</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">sum_expected</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#000">cout_expected</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 以详细模式运行指定的测试</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pytest</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">main</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#39;-v&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;test_adder.py::TestFullAdder&#39;</span><span style="color:#000;font-weight:bold">])</span>
</span></span></code></pre></div><blockquote>
<p>这个例子中，@given 装饰器和 strategies 用于生成符合条件的随机数据。st.integers() 是生成指定范围整数的策略，用于为 a 和 b 生成 0 到 0xffffffffffffffff 之间的数，以及为 cin 生成 0 或 1。Hypothesis会自动重复运行这个测试，每次都使用不同的随机输入，这有助于揭示潜在的边界条件或异常情况。</p></blockquote>
<ul>
<li>运行测试，输出结果如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>collected <span style="color:#0000cf;font-weight:bold">1</span> item                                                               
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> test_adder.py ✓                                                 100% ██████████
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Results <span style="color:#ce5c00;font-weight:bold">(</span>0.42s<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>       <span style="color:#0000cf;font-weight:bold">1</span> passed
</span></span></code></pre></div><blockquote>
<p>可以看到在很短的时间里我们已经完成了测试</p></blockquote>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-60a985e164b2bc20af6e01e35f5b2af0">3 - 验证基础</h1>
    <div class="lead">介绍开放验证平台工作所需要的基础知识。</div>
	

<div class="pageinfo pageinfo-primary">
<p>介绍芯片验证，以果壳 Cache 为例，介绍基本的验证流程、报告撰写。</p>

</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-13bda523e6e63f16e87df4b0401a9d7f">3.1 - 芯片验证</h1>
    <div class="lead">关于芯片验证的基本概念</div>
	

<div class="pageinfo pageinfo-primary">
<p>本页简单介绍什么是芯片验证，以及示例里面用到的概念，如 DUT (Design Under Test) 和 RM (Reference Model) 。</p>
<p>芯片验证过程需要和企业、团队的实际情况契合，没有符合所有要求，必须参考的绝对标准。</p>

</div>

<h2 id="什么是芯片验证">什么是芯片验证</h2>
<hr>
<p>芯片从设计到成品的过程主要包括芯片设计、芯片制造、芯片封测试三大阶段。在芯片设计中，又分前端设计和后端设计，前端设计也称之为逻辑设计，目标是让电路逻辑达到预期功能要求。后端设计也称为物理设计，主要工作是优化布局布线，减小芯片面积，降低功耗，提高频率等。芯片验证（Chip Verification）是芯片设计流程中的一个重要环节。它的目标是确保设计的芯片在功能、性能和功耗等方面都满足预定的规格。验证过程通常包括功能验证、时序验证和功耗验证等多个步骤，使用的方法和工具包括仿真、形式验证、硬件加速和原型制作等。<strong>针对本文，芯片验证仅包含对芯片前端设计的验证，验证设计的电路逻辑是否满足既定需求（&ldquo;Does this proposed design do what is intended?&quot;），通常也称为功能验证（Functional verification），不包含功耗、频率等后端设计</strong>。</p>
<blockquote><p>
对于芯片产品，一旦设计错误被制造出来修改成本将会非常高昂，因为可能需要召回产品，并重新制造芯片，无论是经济成本还是时间成本都十分昂贵。经典由于芯片验证不足导致失败的典型案例如下：
<p><strong>Intel Pentium FDIV Bug</strong>：在1994年，Intel的Pentium处理器被发现存在一个严重的除法错误，这个错误被称为FDIV bug。这个错误是由于在芯片的浮点单元中，一个查找表中的几个条目错误导致的。这个错误在大多数应用中不会出现，但在一些特定的计算中会导致结果错误。由于这个错误，Intel不得不召回了大量的处理器，造成了巨大的经济损失。</p>
<p><strong>Ariane 5 Rocket Failure</strong>：虽然这不是一个芯片的例子，但它展示了硬件验证的重要性。在1996年，欧洲空间局的Ariane 5火箭在发射后不久就爆炸了。原因是火箭的导航系统中的一个64位浮点数被转换为16位整数时溢出，导致系统崩溃。这个错误在设计阶段没有被发现，导致了火箭的失败。</p>
<p><strong>AMD Barcelona Bug</strong>：在2007年，AMD的Barcelona处理器被发现存在一个严重的转译查找缓冲（TLB）错误。这个错误会导致系统崩溃或者重启。AMD不得不通过降低处理器的频率和发布BIOS更新来解决这个问题，这对AMD的声誉和财务状况造成了重大影响。</p>
<p>这些案例都强调了芯片验证的重要性。如果在设计阶段就能发现并修复这些错误，那么就可以避免这些昂贵的失败。验证不足的案例不仅发生在过去，也发生在现在，例如某新入局 ASIC 芯片市场的互联网企业打造一款 55 纳米芯片，极力追求面积缩减并跳过验证环节，最终导致算法失败，三次流片皆未通过测试，平均每次流片失败导致企业损失约 50 万美元。</p>
</p></blockquote>
<h2 id="芯片验证流程">芯片验证流程</h2>
<hr>
<p><img src="ic-verify.drawio.svg" alt="验证在芯片设计中的位置"></p>
<p>芯片设计和验证的耦合关系如上图所示，设计和验证有同样的输入，即规范文档（specification）。参考规范，设计与验证人员双方按照各自的理解，以及各自的需求进行独立编码实现。设计方需要满足的前提是编码的RTL代码“可综合”，需要考虑电路特性，而验证方一般只要考虑功能是否满足要求，编码限制少。双方完成模块开发后，需要进行健全性对比测试（Sanity Test），判定功能是否表现一致，若不一致需要进行协同排查，确定问题所在并进行修复，再进行对比测试，直到所有功能点都满足预期。由于芯片设计和芯片验证耦合度很高，因此有些企业在研发队伍上也进行了直接耦合，为每个子模块的设计团队都配置了对应的验证团队（DV）。上图中的设计与验证的耦合流程为粗粒度的关系，具体到具体芯片（例如Soc、DDR）、具体企业等都有其适合自身的合作模式。</p>
<p>在上述对比测试中，设计方的产出的模块通常称为DUT（Design Under Test），验证方开发的模型通常称为RM（Reference Model）。针对图中的验证工作，按照流程可以有：编写验证计划、创建验证平台、整理功能点、构建测试用例、运行调试、收集Bug/覆盖率、回归测试、编写测试报告等多个阶段。</p>
<blockquote><p>
<p><strong>验证计划：</strong> 验证计划描述了如何进行验证，以及如何保证验证质量，达到功能验证要求。在文档结构上通常包含验证目标，验证策略、验证环境、验证项、验证过程、风险防范、资源及时间表、结果和报告等部分。验证目标明确需要验证的功能或性能指标，这些目标应该直接从芯片的规范文档中提取。验证策略描述如何进行验证，包括可能使用的验证方法，例如仿真、形式化、FPGA加速等，以及如何组织验证任务。验证环境用于描述具体的测试环境，例如验证工具类型，版本号等。验证项包含了需要验证的具体项以及预期结果。验证计划可以有总计划，也可以针对具体验证的子任务进行编写。</p>
<p><strong>平台搭建：</strong> 验证平台是具体验证任务的执行环境，同一类验证任务可以使用相同的验证平台。验证平台的搭建是验证流程中的关键步骤、具体包含验证工具选择（例如是采用软件仿真，还是采用形式化验证，或者硬件加速）、环境配置（例如配置服务器环境，FPGA环境）、创建测试环境、基本测试案例等。创建好基本测试平台，跑通基本测试案例，也通常称为“冒烟测试”。后继具体的测试代码，都将基于该测试平台进行，因此测试平台需要具有可重用性。验证平台通常包含测试框架和被测试代码，以及对应的基本信号激励。</p>
<p><strong>功能点整理：</strong> 根据规范手册（spec）列出DUT的基本功能，并对其进行明确的描述，以及如何对该功能点进行测试。功能点整理过程中，需要根据重要性、风险、复杂性等因数对其进行优先级排序。功能点整理还需要对各个功能点进行追踪和状态，如果发现原始功能点有更新需要及时进行对应计划的同步。</p>
<p><strong>测试用例：</strong> 测试用例是指一组条件或变量，用于确定DUT是否满足特定需求并能正确运行。每个测试用例通常包含测试条件，输入数据，预期结果，实际结果和测试结果。通过运行测试用例并比较预期结果和实际结果，可以确定系统或应用是否正确实现了特定的功能或需求。在芯片验证中，测试用例是用来验证芯片设计是否满足规格要求的重要工具。</p>
<p><strong>编码实现：</strong> 编码实现即测试用例的具体执行过程，包括测试数据生成、测试框架选择、编程语言选择、参考模型编写等。编码实现是对功能点和测试用例充分理解后工作，如果理解不到位，可能导致DUT无法驱动，不能发现潜在bug等问题。</p>
<p><strong>收集bug/覆盖率：</strong> 验证的目标就是提前发现设计中存在的bug，因此需要对发现的bug进行收集和管理。每发现一个新缺陷，需要给定唯一标号，并同设计工程师进行bug定级，然后进行状态追踪。能发现bug最好，但在实际验证中不是每次测试都能发现bug，因此需要另外一个指标评价验证是否到位。该指标通常采用覆盖率，当覆盖率超过一点阈值（例如代码覆盖率大于90%）后方可任务进行了充分验证。</p>
<p><strong>回归测试：</strong> 验证和设计是一个相互迭代的过程，因此当验证出bug后，需要设计进行修正，且需要保证修正后的DUT仍然能正常工作。这种测试的目的是捕获可能由于修改而引入的新错误，或者重新激活旧错误。回归测试可以是全面的，也就是说，它涵盖了所有的功能，或者可以是选择性的，只针对某些特定的功能或系统部分。</p>
<p><strong>测试报告：</strong> 测试报告是对整个验证过程的总结，它提供了关于测试活动的全面视图，包括测试的目标、执行的测试用例、发现的问题和缺陷、测试覆盖率和测试效率等。</p>
</blockquote></p>
<h2 id="芯片验证层次">芯片验证层次</h2>
<hr>
<p>按照验证对象的大小，芯片验证通常包含UT、BT、IT、ST四个层次。</p>
<p><strong>单元测试（Unit Testing， UT）：</strong> 这是最低的验证层次，主要针对单个模块或组件进行。目标是验证每个模块或组件的功能是否正确。</p>
<p><strong>块测试（Block Testing，BT）：</strong> 很多时候，单个模块和其他模块存在紧耦合，如果进行单独UT测试，可能存在信号处理复杂，功能验证不准确等问题，这时候可以把多个有耦合关系的模块合并成一个DUT块进行测试。</p>
<p><strong>集成测试（Integration Testing）：</strong> 在单元测试的基础上，将多个模块或组件组合在一起，验证它们能否正确地协同工作，通常用于测试子系统功能是否正常。</p>
<p><strong>系统测试（System Testing）：</strong> ST通常也称为Top验证，在集成测试的基础上，将所有的模块或组件组合在一起，形成一个完整的系统，验证系统的功能是否正确，以及系统的性能是否满足要求。</p>
<p>理论上，这些层次的验证通常按照从低到高的顺序进行，每个层次的验证都建立在前一个层次的验证的基础上。但实际验证活动中，需要根据企业验证人员的规模、熟练度，功能需求等进行选择，不一定所有层次的验证都需要涉及。在每个层次，都需要编写相应的测试用例，运行测试，收集和分析结果，以确保芯片设计的正确性和质量。</p>
<h2 id="芯片验证指标">芯片验证指标</h2>
<hr>
<p>芯片验证的指标，通常包含功能正确性、测试覆盖率、缺陷密度、验证效率、验证成本等多个方面。功能正确性是最基本的验证指标，即芯片是否能够正确地执行其设计的功能。这通常通过运行一系列的功能测试用例来验证，包括正常情况下的功能测试，以及异常情况下的鲁棒性测试。测试覆盖率是指测试用例覆盖了多少设计的功能点，以及覆盖的程度如何。高的测试覆盖率通常意味着更高的验证质量。测试覆盖率可以进一步细分为代码覆盖率、功能覆盖率、条件覆盖率等。缺陷密度是指在一定的设计规模或代码量中，发现的缺陷的数量。低的缺陷密度通常意味着更高的设计质量。验证效率是指在一定的时间和资源下，能够完成的验证工作量。高的验证效率通常意味着更高的验证生产力。验证成本是指进行验证所需要的总体资源，包括人力、设备、时间等。低的验证成本通常意味着更高的验证经济性。</p>
<blockquote><p>
<p>功能正确性是验证的绝对指标，但在实践中，很多时候无法确定测试方案是否完备，所有测试空间是否全部测试到位，因此需要一个可量化的指标来指导验证是否足够充分，是否可以结束验证。该指标通常采用“测试覆盖率”。测试覆盖率通常有代码覆盖率（行，函数，分支）、功能覆盖率。</p>
<p><strong>代码行覆盖率：</strong> 即在测试过程中，DUT的设计代码中有多少行被执行；</p>
<p><strong>函数覆盖率：</strong> 即在测试过程中，DUT的设计代码中有多少函数被执行；</p>
<p><strong>分支覆盖率：</strong> 即在测试过程中，DUT的设计代码中有多少分支被执行（if else）；</p>
<p><strong>功能覆盖率：</strong> 即在测试过程中，有多少预定义功能被触发。</p>
<p>高的代码覆盖率可以提高验证的质量和可靠性，但并不能保证验证的完全正确性，因为它不能覆盖所有的输入和状态组合。因此，除了追求高的代码覆盖率，还需要结合其他测试方法和指标，如功能测试、性能测试、缺陷密度等。</p>
</blockquote></p>
<h2 id="芯片验证管理">芯片验证管理</h2>
<hr>
<p>芯片验证管理是一个涵盖了芯片验证过程中所有活动的<strong>管理过程</strong>，包括之前提到的验证策略的制定、验证环境的搭建、测试用例的编写和执行、结果的收集和分析、以及问题和缺陷的跟踪和修复等。芯片验证管理的目标是确保芯片设计满足所有的功能和性能要求，以及规格和标准。</p>
<p>在芯片验证管理中，首先需要制定一个详细的验证策略，包括验证的目标、范围、方法、时间表等。然后，需要搭建一个适合的验证环境，包括硬件设备、软件工具、测试数据等。接下来，需要编写一系列的测试用例，覆盖所有的功能和性能点，然后执行这些测试用例，收集和分析结果，找出问题和缺陷。最后，需要跟踪和修复这些问题和缺陷，直到所有的测试用例都能通过。</p>
<p>芯片验证管理是一个复杂的过程，需要多种技能和知识，包括芯片设计、测试方法、项目管理等。它需要与芯片设计、生产、销售等其他活动紧密协作，以确保芯片的质量和性能。芯片验证管理的效果直接影响到芯片的成功和公司的竞争力。因此，芯片验证管理是芯片开发过程中的一个重要环节。</p>
<p>芯片验证管理过程可以基于“项目管理平台”和“bug管理平台”进行，基于平台的管理效率通常情况下明显高于基于人工的管理模式。</p>
<h2 id="芯片验证现状">芯片验证现状</h2>
<hr>
<p>当前，芯片验证通常是在芯片设计公司内部完成的，这一过程不仅技术上复杂，而且具有巨大的成本。从验收与设计的紧密关系来看，芯片验证不可避免地涉及芯片设计的源代码。然而，芯片设计公司通常将芯片设计源代码视为商业机密，这使得必须由公司内部人员来执行芯片验证，难以将验证工作外包。</p>

<figure>
    <img src="time_of_verification.png"
         alt="验证工作量占比" width="700px"/> 
</figure>

<p>芯片验证的重要性在于确保设计的芯片在各种条件下能够可靠运行。验证工作不仅仅是为了满足技术规格，还需要应对不断增长的复杂性和新兴技术的要求。随着半导体行业的发展，芯片验证的工作量不断增加，尤其是对于复杂的芯片而言，验证工作已经超过了设计工作，占比超过70%。这使得在工程师人员配比上，验证工程师人数通常是设计工程师人数的2倍或以上（例如zeku的三千人规模团队中，大约有一千人的设计工程师，两千人的验证工程师。其他大型芯片设计公司的验证人员占比类似或更高）。</p>
<p>由于验证工作的特殊性，需要对芯片设计源代码进行访问，这在很大程度上限制了芯片验证的外包可能性。芯片设计源代码被视为公司的核心商业机密，涉及到技术细节和创新，因此在安全和法律层面上不太可能与外部方共享。这也导致了公司内部人员必须承担验证工作的重任，增加了公司内部的工作负担和成本。</p>
<p>在当前情况下，芯片验证工程师的需求持续增加。他们需要具备深厚的技术背景，熟悉各种验证工具和方法，并且对新兴技术有敏锐的洞察力。由于验证工作的复杂性，验证团队通常需要庞大的规模，这与设计团队规模形成鲜明对比。</p>
<p>为了应对这一挑战，行业可能需要不断探索创新的验证方法和工具，以提高验证效率，降低成本。</p>
<blockquote><p>
小结：复杂芯片验证成本昂贵，表现在如下几个方面
<p><strong>验证工作量大：</strong> 对于复杂芯片，验证工作在整个芯片设计工作中，占比超过 70%。</p>
<p><strong>人力成本高：</strong> 验证工程师人数是设计工程师人数的2倍，对于复杂业务，工程师数量在千人以上。</p>
<p><strong>内部验证：</strong> 芯片设计公司为了保证商业秘密（芯片设计代码）不被泄露，只能选择招聘大量验证工程师，在公司内部进行验证工作。</p>
</blockquote></p>
<h2 id="芯片验证众包">芯片验证众包</h2>
<hr>
<p>相比与硬件，软件领域为了减少软件测试成本，测试外包（分包）已经成为常态，该领域的分包业务非常成熟，市场规模已经是千亿人民币级别，并朝万亿级别规模进发。从工作内容上看，软件测试和硬件验证，有非常大的共同特征（系统的目的不同的对象），如果以软件的方式对硬件验证进行分包是否可行？</p>
<p><img src="maket_of_soft_test.png" alt="软件外包市场"></p>
<blockquote><p>
把芯片验证工作进行外包（分包）面临诸多挑战，例如：
<p><strong>从业人员基数少：</strong> 相比软件领域，硬件开发者数量少了几个数量级。例如在github的统计上（https://madnight.github.io/githut/#/pull_requests/2023/2），传统软件编程语言占（Python、Java、C++，Go）比接近 50%， 而硬件描述语言，verilog占比仅 0.076%，这能从侧面反应出各自领域的开发者数量。</p>
<p><strong>验证工具商业化：</strong> 企业中使用的验证工具（仿真器、形式化、数据分析）几乎都是商业工具，这类工具对于普通人来说几乎不可见，自学难度高。</p>
<p><strong>开放学习资料少：</strong> 芯片验证涉及到访问芯片设计的源代码，而这些源代码通常被视为公司的商业机密和专有技术。芯片设计公司可能不愿意公开详细的验证过程和技术，限制了学习材料的可用性。</p>
</blockquote></p>
<h4 id="可行性分析">可行性分析</h4>
<p>虽然芯片验证领域一直以来相对封闭，但从技术角度而言，采用分包的方式进行验证是一种可行的选择。这主要得益于以下几个因素：</p>
<p>首先，随着开源芯片项目的逐渐增多，验证过程中所涉及的源代码已经变得更加开放和透明。这些开源项目在设计和验证过程中没有商业机密的顾虑，为学习和研究提供了更多的可能性。即使某些项目涉及商业机密，也可以通过采用加密等方式来隐藏设计代码，从而在一定程度上解决了商业机密的问题，使验证更容易实现。</p>
<p>其次，芯片验证领域已经涌现出大量的基础验证工具，如verilator和systemc等。这些工具为验证工程师提供了强大的支持，帮助他们更高效地进行验证工作。通过这些工具，验证过程的复杂性和难度得到了一定程度的缓解，为采用分包的验证方法提供了更为可行的技术基础。</p>
<p>在开源软件领域，已经有一些成功的案例可供参考。例如，Linux内核的验证过程采用了分包的方式，不同的开发者和团队分别负责不同的模块验证，最终形成一个整体完备的系统。类似地，机器学习领域的ImageNet项目也采用了分包标注的策略，通过众包的方式完成大规模的图像标注任务。这些案例为芯片验证领域提供了成功的经验，证明了分包验证在提高效率、降低成本方面的潜力。</p>
<p>因此，尽管芯片验证领域相对于其他技术领域而言仍显得封闭，但技术的进步和开源项目的增多为采用分包验证提供了新的可能性。通过借鉴其他领域的成功经验和利用现有的验证工具，我们有望在芯片验证中推动更加开放、高效的验证方法的应用，进一步促进行业的发展。这种技术的开放性和灵活性将为验证工程师提供更多的选择，推动芯片验证领域迎来更为创新和多样化的发展。</p>
<h4 id="技术路线">技术路线</h4>
<blockquote><p>
<p>为了克服挑战，让更多的人参与到芯片验证，本项目从如下几个技术方向进行持续尝试</p>
<p><strong>提供多语言验证工具：</strong> 传统芯片验证是基于System Verilog编程语言进行，但是该语言用户基数少，为了让其他软件开发/测试的技术人员参与到芯片验证，本项目提供多语言验证转换工具<a href="https://github.com/XS-MLVP/picker">Picker</a>，它可以让验证者使用自己熟悉的编程语言（例如C++/Python/Java/Go）基于开源验证工具参与验证工作。</p>
<p><strong>提供验证学习材料：</strong> 芯片验证学习材料少，主要原因由于商业公司几乎不可能公开其内部资料，为此本项目会持续更新学习材料，让验证人员可在线，免费学习所需要的技能。</p>
<p><strong>提供真实芯片验证案例：</strong> 为了让学习材料更具使用性，本项目以“香山昆明湖（工业级高性能risc-v处理器）IP核”作为基础，从中摘取模块持续更新验证案例。</p>
<p><strong>组织芯片设计分包验证：</strong> 学以致用是每个人学习的期望目标，为此本项目定期组织芯片设计的验证分包，让所有人（无论你是大学生、验证专家、软件开发测试者、还是中学生）都可以参与到真实芯片的设计工作中去。</p>
</blockquote></p>
<p>本项目的目标是达到如下愿景，“打开传统验证模式的黑盒，让所有感兴趣的人可以随时随地的，用自己擅长的编程语言参与芯片验证”。</p>

<figure>
    <img src="landscape.png"
         alt="愿景" width="700px"/> 
</figure>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3cde34a1f60a51b0990066a7b5fc0c9">3.2 - 数字电路</h1>
    <div class="lead">关于数字电路的基本概念</div>
	

<div class="pageinfo pageinfo-primary">
<p>本页将介绍数字电路的基础知识。数字电路是利用数字信号的电子电路。近年来，绝大多数的计算机都是基于数字电路实现的。</p>

</div>

<h2 id="什么是数字电路">什么是数字电路</h2>
<hr>
<p>数字电路是一种利用两种不连续的电位来表示信息的电子电路。在数字电路中，通常使用两个电源电压，分别表示高电平（H）和低电平（L），分别代表数字1和0。这样的表示方式通过离散的电信号，以二进制形式传递和处理信息。</p>
<p>大多数数字电路的实现基于场效应管，其中最常用的是 MOSFET（Metal-Oxide-Semiconductor Field-Effect Transistor，金属氧化物半导体场效应管）。MOSFET 是一种半导体器件，可以在电场的控制下调控电流流动，从而实现数字信号的处理。</p>
<p>在数字电路中，MOSFET 被组合成各种逻辑电路，如与门、或门、非门等。这些逻辑门通过不同的组合方式，构建了数字电路中的各种功能和操作。以下是一些数字电路的基本特征：</p>
<p><strong>(1) 电位表示信息：</strong> 数字电路使用两种电位，即高电平和低电平，来表示数字信息。通常，高电平代表数字1，低电平代表数字0。</p>
<p><strong>(2) MOSFET 实现：</strong> MOSFET 是数字电路中最常用的元件之一。通过控制 MOSFET 的导通和截止状态，可以实现数字信号的处理和逻辑运算。</p>
<p><strong>(3) 逻辑门的组合：</strong> 逻辑门是数字电路的基本构建块，由 MOSFET 组成。通过组合不同的逻辑门，可以构建复杂的数字电路，实现各种逻辑功能。</p>
<p><strong>(4) 二进制表达：</strong> 数字电路中的信息通常使用二进制系统进行表示。每个数字都可以由一串二进制位组成，这些位可以在数字电路中被处理和操作。</p>
<p><strong>(5) 电平转换和信号处理：</strong> 数字电路通过电平的变化和逻辑操作，实现信号的转换和处理。这种离散的处理方式使得数字电路非常适用于计算和信息处理任务。</p>
<h2 id="为什么要学习数字电路">为什么要学习数字电路</h2>
<hr>
<p>学习数字电路是芯片验证过程中的基础和必要前提，主要体现在以下多个方面：</p>
<p><strong>(1) 理解设计原理：</strong> 数字电路是芯片设计的基础，了解数字电路的基本原理和设计方法是理解芯片结构和功能的关键。芯片验证的目的是确保设计的数字电路在实际硬件中按照规格正常工作，而理解数字电路原理是理解设计的关键。</p>
<p><strong>(2) 设计规范：</strong> 芯片验证通常涉及验证设计是否符合特定的规范和功能要求。学习数字电路可以帮助理解这些规范，从而更好地构建测试用例和验证流程，确保验证的全面性和准确性。</p>
<p><strong>(3) 时序和时钟：</strong> 时序问题是数字电路设计和验证中的常见挑战。学习数字电路可以帮助理解时序和时钟的概念，以确保验证过程中能够正确处理时序问题，避免电路中的时序迟滞和冲突。</p>
<p><strong>(4) 逻辑分析：</strong> 芯片验证通常涉及对逻辑的分析，确保电路的逻辑正确性。学习数字电路可以培养对逻辑的深刻理解，从而更好地进行逻辑分析和故障排查。</p>
<p><strong>(5) 测试用例编写：</strong> 在芯片验证中，需要编写各种测试用例来确保设计的正确性。对数字电路的理解可以帮助设计更全面、有针对性的测试用例，涵盖电路的各个方面。</p>
<p><strong>(6) 信号完整性：</strong> 学习数字电路有助于理解信号在电路中的传播和完整性问题。在芯片验证中，确保信号在不同条件下的正常传递是至关重要的，特别是在高速设计中。</p>
<p>整体而言，学习数字电路为芯片验证提供了基础知识和工具，使验证工程师能够更好地理解设计，编写有效的测试用例，分析验证结果，并解决可能出现的问题。数字电路的理论和实践经验对于芯片验证工程师来说都是不可或缺的。</p>
<h2 id="数字电路基础知识">数字电路基础知识</h2>
<p>可以通过以下在线资源进行数字电路学习：</p>
<ul>
<li><a href="https://www.xuetangx.com/course/THU08081000386/19317632">清华大学数字电路基础</a></li>
<li><a href="https://soc.ustc.edu.cn/Digital/">中科大数字电路实验</a></li>
<li><a href="https://github.com/apachecn/huazhang-cs-books/blob/master/%E6%95%B0%E5%AD%97%E8%AE%BE%E8%AE%A1%E5%92%8C%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E5%8E%9F%E4%B9%A6%E7%AC%AC2%E7%89%88.pdf">数字设计和计算机体系结构</a></li>
<li><a href="https://ocw.mit.edu/courses/6-374-analysis-and-design-of-digital-integrated-circuits-fall-2003/download/">MIT 数字集成电路分析与设计</a></li>
</ul>
<h2 id="硬件描述语言chisel">硬件描述语言Chisel</h2>
<hr>
<h3 id="传统描述语言">传统描述语言</h3>
<p>硬件描述语言（Hardware Description Language，简称 HDL）是一种用于描述数字电路、系统和硬件的语言。它允许工程师通过编写文本文件来描述硬件的结构、功能和行为，从而实现对硬件设计的抽象和建模。</p>
<p>HDL 通常被用于设计和仿真数字电路，如处理器、存储器、控制器等。它提供了一种形式化的方法来描述硬件电路的行为和结构，使得设计工程师可以更方便地进行硬件设计、验证和仿真。</p>
<p>常见的硬件描述语言包括：</p>
<ul>
<li>Verilog：Verilog 是最常用的 HDL 之一，它是一种基于事件驱动的硬件描述语言，广泛应用于数字电路设计、验证和仿真。</li>
<li>VHDL：VHDL 是另一种常用的 HDL，它是一种面向对象的硬件描述语言，提供了更丰富的抽象和模块化的设计方法。</li>
<li>SystemVerilog：SystemVerilog 是 Verilog 的扩展，它引入了一些高级特性，如对象导向编程、随机化测试等，使得 Verilog 更适用于复杂系统的设计和验证。</li>
</ul>
<h3 id="chisel">Chisel</h3>
<p>Chisel 是一种现代化高级的硬件描述语言，与传统的 Verilog 和 VHDL 不同，它是基于 Scala 编程语言的硬件构建语言。Chisel 提供了一种更加现代化和灵活的方法来描述硬件，通过利用 Scala 的特性，可以轻松地实现参数化、抽象化和复用，同时保持硬件级别的效率和性能。</p>
<p>Chisel 的特点包括：</p>
<ul>
<li>现代化的语法：Chisel 的语法更加接近软件编程语言，如 Scala，使得硬件描述更加直观和简洁。</li>
<li>参数化和抽象化：Chisel 支持参数化和抽象化，可以轻松地创建可配置和可重用的硬件模块。</li>
<li>类型安全：Chisel 是基于 Scala 的，因此具有类型安全的特性，可以在编译时检测到许多错误。</li>
<li>生成性能优化的硬件：Chisel 代码可以被转换成 Verilog，然后由标准的 EDA 工具链进行综合、布局布线和仿真，生成性能优化的硬件。</li>
<li>强大的仿真支持：Chisel 提供了与 ScalaTest 和 Firrtl 集成的仿真支持，使得对硬件进行仿真和验证更加方便和灵活。</li>
</ul>
<h4 id="chisel版的全加法器实例">Chisel版的全加法器实例</h4>
<p>电路设计如下图所示：</p>

<figure>
    <img src="fulladder.png"
         alt="全加器电路" width="500px"/> 
</figure>

<p>完整的Chisel代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">examples</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">chisel3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">class</span> <span style="color:#000">FullAdder</span> <span style="color:#000">extends</span> <span style="color:#000">Module</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Define IO ports
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">val</span> <span style="color:#000">io</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">IO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">new</span> <span style="color:#000">Bundle</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">val</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Input</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000">W</span><span style="color:#000;font-weight:bold">))</span>    <span style="color:#8f5902;font-style:italic">// Input port &#39;a&#39; of width 1 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">val</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Input</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000">W</span><span style="color:#000;font-weight:bold">))</span>    <span style="color:#8f5902;font-style:italic">// Input port &#39;b&#39; of width 1 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">val</span> <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Input</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000">W</span><span style="color:#000;font-weight:bold">))</span>  <span style="color:#8f5902;font-style:italic">// Input port &#39;cin&#39; (carry-in) of width 1 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">val</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000">W</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// Output port &#39;sum&#39; of width 1 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">val</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Output</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000">W</span><span style="color:#000;font-weight:bold">))</span><span style="color:#8f5902;font-style:italic">// Output port &#39;cout&#39; (carry-out) of width 1 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Calculate sum bit (sum of a, b, and cin)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">val</span> <span style="color:#000">s1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">b</span>               <span style="color:#8f5902;font-style:italic">// XOR operation between &#39;a&#39; and &#39;b&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s1</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cin</span>              <span style="color:#8f5902;font-style:italic">// XOR operation between &#39;s1&#39; and &#39;cin&#39;, result assigned to &#39;sum&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Calculate carry-out bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">val</span> <span style="color:#000">s3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">b</span>               <span style="color:#8f5902;font-style:italic">// AND operation between &#39;a&#39; and &#39;b&#39;, result assigned to &#39;s3&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">val</span> <span style="color:#000">s2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">s1</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cin</span>               <span style="color:#8f5902;font-style:italic">// AND operation between &#39;s1&#39; and &#39;cin&#39;, result assigned to &#39;s2&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s2</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">s3</span>                 <span style="color:#8f5902;font-style:italic">// OR operation between &#39;s2&#39; and &#39;s3&#39;, result assigned to &#39;cout&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Chisel 学习材料可以参考官方文档：<a href="https://www.chisel-lang.org/docs">https://www.chisel-lang.org/docs</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9d4c1f404f62253b519fd8af17d8389">3.3 - 创建DUT</h1>
    <div class="lead">以果壳cache为例，介绍如何创建基于chisel的DUT</div>
	

<div class="pageinfo pageinfo-primary">
<p>以果壳cache为例，介绍如何创建基于Chisel的DUT</p>

</div>

<p>在本文档中，DUT（Design Under Test）是指在芯片验证过程中，被验证的对象电路或系统。DUT是验证的主体，在基于picker工具创建DUT时，需要考虑被测对象的功能、性能要求和验证目标，例如是需要更快的执行速度，还是需要更详细的测试信息。通常情况下DUT，即RTL编写的源码，与外围环境一起构成验证环境（test_env），然后基于该验证环境编写测试用例。在本项目中，DUT是需要测试的Python模块，需要通过RTL进行转换。传统的RTL语言包括Verilog、System Verilog、VHDL等，然而作为新兴的RTL设计语言，Chisel（<a href="https://www.chisel-lang.org/">https://www.chisel-lang.org/</a>）也以其面向对象的特征和便捷性，逐渐在RTL设计中扮演越来越重要的角色。本章以<a href="https://github.com/OSCPU/NutShell">果壳处理器-NutShell</a>中的cache源代码到Python模块的转换为例进行介绍如何创建DUT。</p>
<h2 id="chisel与果壳">Chisel与果壳</h2>
<p>准确来说，Chisel是基于Scala语言的高级硬件构造（HCL）语言。传统HDL是描述电路，而HCL则是生成电路，更加抽象和高级。同时Chisel中提供的Stage包则可以将HCL设计转化成Verilog、System Verilog等传统的HDL语言设计。配合上Mill、Sbt等Scala工具则可以实现自动化的开发。</p>
<p>果壳是使用 Chisel 语言模块化设计的、基于 RISC-V RV64 开放指令集的顺序单发射处理器实现。果壳更详细的介绍请参考链接：<a href="https://oscpu.github.io/NutShell-doc/">https://oscpu.github.io/NutShell-doc/</a></p>
<h2 id="果壳-cache">果壳 cache</h2>
<p>果壳cache（Nutshell Cache）是果壳处理器中使用的缓存模块。其采用三级流水设计，当第三级流水检出当前请求为MMIO或者发生重填（refill）时，会阻塞流水线。同时，果壳cache采用可定制的模块化设计，通过改变参数可以生成存储空间大小不同的一级cache（L1 Cache）或者二级cache（L2 Cache）。此外，果壳cache留有一致性（coherence）接口，可以处理一致性相关的请求。</p>
<p><img src="nt_cache.png" alt="nt_cache"></p>
<h2 id="chisel-转-verilog">Chisel 转 Verilog</h2>
<p>Chisel中的<code>stage</code>库可以帮助由Chisel代码生成Verilog、System Verilog等传统的HDL代码。以下将简单介绍如何由基于Chisel的cache实现转换成对应的Verilog电路描述。</p>
<h3 id="初始化果壳环境">初始化果壳环境</h3>
<p>首先从源仓库下载整个果壳源代码，并进行初始化：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir cache-ut
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> cache-ut
</span></span><span style="display:flex;"><span>git clone https://github.com/OSCPU/NutShell.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> NutShell <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> git checkout 97a025d
</span></span><span style="display:flex;"><span>make init
</span></span></code></pre></div><h3 id="创建scala编译配置">创建scala编译配置</h3>
<p>在cache-ut目录下创建build.sc，其中内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">$file.NutShell.build</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">mill._</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">scalalib</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">_</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">coursier.maven.MavenRepository</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">mill.scalalib.TestModule._</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 指定Nutshell的依赖
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#000">difftest</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">NutShell</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CommonNS</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">millSourcePath</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pwd</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#4e9a06">&#34;NutShell&#34;</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#4e9a06">&#34;difftest&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Nutshell 配置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#000">NtShell</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">NutShell</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CommonNS</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">NutShell</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">HasChiselTests</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">millSourcePath</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pwd</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#4e9a06">&#34;NutShell&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">moduleDeps</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">super</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">moduleDeps</span> <span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">difftest</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UT环境配置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#000">ut</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">NutShell</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CommonNS</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">ScalaTest</span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">millSourcePath</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pwd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">override</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">moduleDeps</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">super</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">moduleDeps</span> <span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NtShell</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="实例化-cache">实例化 cache</h3>
<p>创建好配置信息后，按照scala规范，创建src/main/scala源代码目录。之后，就可以在源码目录中创建nut_cache.scala，利用如下代码实例化Cache并转换成Verilog代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">ut_nutshell</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">chisel3._</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">chisel3.util._</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">nutcore._</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">top._</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">chisel3.stage._</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">object</span> <span style="color:#000">CacheMain</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">App</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ChiselStage</span><span style="color:#ce5c00;font-weight:bold">).</span><span style="color:#000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Seq</span><span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ChiselGeneratorAnnotation</span><span style="color:#ce5c00;font-weight:bold">(()</span> <span style="color:#204a87;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Cache</span><span style="color:#ce5c00;font-weight:bold">()(</span><span style="color:#000">CacheConfig</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ro</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;tcache&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">userBits</span> <span style="color:#204a87;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#ce5c00;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="生成rtl">生成RTL</h3>
<p>完成上述所有文件的创建后（build.sc，src/main/scala/nut_cache.scala），在cache-ut目录下执行如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir build
</span></span><span style="display:flex;"><span>mill --no-server -d ut.runMain ut_nutshell.CacheMain --target-dir build --output-file Cache
</span></span></code></pre></div><p>注：mill环境的配置请参考 <a href="https://mill-build.com/mill/Intro_to_Mill.html">https://mill-build.com/mill/Intro_to_Mill.html</a></p>
<p>上述命令成功执行完成后，会在build目录下生成verilog文件：Cache.v。之后就可以通过picker工具进行Cache.v到 Python模块的转换。除去chisel外，其他HCL语言几乎都能生成对应的 RTL代码，因此上述基本流程也适用于其他HCL。</p>
<h3 id="dut编译">DUT编译</h3>
<p>一般情况下，如果需要DUT生成波形、覆盖率等会导致DUT的执行速度变慢，因此在通过picker工具生成python模块时会根据多种配置进行生成：（1）关闭所有debug信息；（2）开启波形；（3）开启代码行覆盖率。其中第一种配置的目标是快速构建环境，进行回归测试等；第二种配置用于分析具体错误，时序等；第三种用于提升覆盖率。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-82b31af9e0ee05c3d251234b764020ed">3.4 - DUT验证</h1>
    <div class="lead">介绍验证的一般流程</div>
	

<div class="pageinfo pageinfo-primary">
<p>本节介绍基于Picker验证DUT的一般流程</p>

</div>

<p>开放验证平台的目标是功能性验证，其一般有以下步骤：</p>
<h3 id="1-确定验证对象和目标">1. 确定验证对象和目标</h3>
<p>通常来说，同时交付给验证工程师的还有DUT的设计文档。此时您需要阅读文档或者源代码，了解验证对象的基本功能、主体结构以及预期功能。</p>
<h3 id="2-构建基本验证环境">2. 构建基本验证环境</h3>
<p>充分了解设计之后，您需要构建验证的基本环境。例如，除了由Picker生成的DUT外，您可能还需要搭建用于比对的参考模型，也可能需要为后续功能点的评测搭建信号的监听平台。</p>
<h3 id="3-功能点与测试点分解">3. 功能点与测试点分解</h3>
<p>在正式开始验证之前，您还需要提取功能点，并将其进一步分解成测试点。提取和分解方法可以参考：<a href="https://blog.csdn.net/W1Z1Q/article/details/124547192">CSDN:芯片验证系列——Testpoints分解</a></p>
<h3 id="4-构造测试用例">4. 构造测试用例</h3>
<p>有了测试点之后，您需要构造测试用例来覆盖相应的测试点。一个用例可能覆盖多个测试点。</p>
<h3 id="5-收集测试结果">5. 收集测试结果</h3>
<p>运行完所有的测试用例之后，您需要汇总所有的测试结果。一般来说包括代码行覆盖率以及功能覆盖率。前者可以通过Picker工具提供的覆盖率功能获得，后者则需要您通过监听DUT的行为判断某功能是否被用例覆盖到。</p>
<h3 id="6-评估测试结果">6. 评估测试结果</h3>
<p>最后您需要评估得到的结果，如是否存在错误的设计、某功能是否无法被触发、设计文档表述是否与DUT行为一致、设计文档是否表述清晰等。</p>
<hr>
<p>接下来我们以<strong>果壳Cache的MMIO读写为例</strong>，介绍一般验证流程：</p>
<p><strong>1 确定验证对象和目标</strong>：
果壳Cache的MMIO读写功能。MMIO是一类特殊的IO映射，其支持通过访问内存地址的方式访问IO设备寄存器。由于IO设备的寄存器状态是随时可能改变的，因此不适合将其缓存在cache中。当收到MMIO请求时，果壳cache不会在普通的cache行中查询命中/缺失情况，而是会直接访问MMIO的内存区域来读取或者写入数据。</p>
<p><strong>2 构建基本验证环境</strong>：
我们可以将验证环境大致分为五个部分：
<img src="env.png" alt="env" width="800" height="600"></p>
<blockquote>
<p><strong>1. Testcase Driver</strong>：负责由用例产生相应的信号驱动
<strong>2. Monitor</strong>：监听信号，判断功能是否被覆盖以及功能是否正确
<strong>3. Ref Cache</strong>：一个简单的参考模型
<strong>4. Memory/MMIO Ram</strong>：外围设备的模拟，用于模拟相应cache的请求
<strong>5. Nutshell Cache Dut</strong>：由Picker生成的DUT</p></blockquote>
<p>此外，您可能还需要对DUT的接口做进一步封装以实现更方便的读写请求操作，具体可以参考<a href="https://github.com/yzcccccccccc/XS-MLVP-NutShellCache/blob/master/UT_Cache/util/cachewrapper.py">Nutshll cachewrapper</a>。</p>
<p><strong>3 功能点与测试点分解</strong>：
果壳cache可以响应MMIO请求，进一步分解可以得到一下测试点：</p>
<blockquote>
<p><strong>测试点1</strong>：MMIO请求会被转发到MMIO端口上
<strong>测试点2</strong>：cache响应MMIO请求时，不会发出突发传输（Burst Transfer）的请求
<strong>测试点3</strong>：cache响应MMIO请求时，会阻塞流水线</p></blockquote>
<p><strong>4 构造测试用例</strong>：
测试用例的构造是简单的，已知通过<a href="/zh-cn/docs/basic/create_dut">创建DUT</a>得到的Nutshell cache的MMIO地址范围是<code>0x30000000</code>~<code>0x7fffffff</code>，则我们只需访问这段内存区间，应当就能获得MMIO的预期结果。需要注意的是，为了触发阻塞流水线的测试点，您可能需要连续地发起请求。
以下是一个简单的测试用例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># import CacheWrapper here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">mmio_test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">CacheWrapper</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mmio_lb</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x30000000</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mmio_rb</span>	<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x30001000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">[MMIO Test]: Start MMIO Serial Test&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">addr</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mmio_lb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mmio_rb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">addr1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">addr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">addr2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">addr3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">trigger_read_req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">trigger_read_req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">trigger_read_req</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">recv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">recv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">recv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[MMIO Test]: Finish MMIO Serial Test&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>5 收集测试结果</strong>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#4e9a06">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    In tb_cache.py
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># import packages here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">TestCache</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">setup_class</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">print_blue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Cache Test Start&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;libDPICache.so&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">init_clock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clock&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># Init here</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">testlist</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;mmio_serial&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">teardown_class</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">print_blue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">Cache Test End&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__reset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># Reset cache and devices</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># MMIO Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_mmio</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mmio_serial&#34;</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">testlist</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic"># Run test</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">..test.test_mmio</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">mmio_test</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">mmio_test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ref_cache</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">mmio test is not included&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">setup_class</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># test</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">test_mmio</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">teardown_class</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;__main__&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TestCache</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>运行：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    python3 tb_cache.py
</span></span></code></pre></div><p>以上仅为大致的运行流程，具体可以参考：<a href="https://github.com/yzcccccccccc/XS-MLVP-NutShellCache">Nutshell Cache Verify</a>。</p>
<p><strong>6 评估运行结果</strong>
运行结束之后可以得到以下数据：
行覆盖率：
<img src="line_cov.png" alt="line_cov" width="800" height="600"></p>
<p>功能覆盖率：
<img src="func_cov.png" alt="func_cov" width="400" height="300"></p>
<p>可以看到预设的MMIO功能均被覆盖且被正确触发。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9677ff4fee20856211cd5ff4272fe758">3.5 - 验证报告</h1>
    <div class="lead">概述验证报告的结构与内容。</div>
	

<div class="pageinfo pageinfo-primary">
<p>在我们完成DUT验证后，编写验证报告是至关重要的一环。本节将从整体角度概述验证报告的结构以及报告所需覆盖的内容。</p>

</div>

<p>验证报告是对整个验证过程的回顾，是验证合理与否的重要支持文件。一般情况下，验证报告需要包含以下内容：</p>
<blockquote>
<ol>
<li>文档基本信息（作者、日志、版本等）</li>
<li>验证对象（验证目标）</li>
<li>功能点介绍</li>
<li>验证方案</li>
<li>测试点分解</li>
<li>测试用例</li>
<li>测试环境</li>
<li>结果分析</li>
<li>缺陷分析</li>
<li>测试结论</li>
</ol></blockquote>
<p>以下内容对列表进行进一步解释，具体示例可以参考<a href="nutshell_cache_report_demo.pdf">nutshell_cache_report_demo.pdf</a></p>
<hr>
<h3 id="1-基本信息">1. 基本信息</h3>
<p>应当包括作者、日志、版本、日期等。</p>
<h3 id="2-验证对象验证目标">2. 验证对象（验证目标）</h3>
<p>需要对您的验证对象做必要的介绍，可以包括其结构、基本功能、接口信息等。</p>
<h3 id="3-功能点介绍">3. 功能点介绍</h3>
<p>通过阅读设计文档或者源码，您需要总结DUT的目标功能，并将其细化为各功能点。</p>
<h3 id="4-验证方案">4. 验证方案</h3>
<p>应当包括您计划的验证流程以及验证框架。同时，您也应当接受您的框架各部分是如何协同工作的。</p>
<h3 id="5-测试点分解">5. 测试点分解</h3>
<p>针对功能点提出的测试方法。具体可以包括在怎样的信号输入下应当观测到怎样的信号输出。</p>
<h3 id="6-测试用例">6. 测试用例</h3>
<p>测试点的具体实现。一个测试用例可以包括多个测试点。</p>
<h3 id="7-测试环境">7. 测试环境</h3>
<p>包括硬件信息、软件版本信息等。</p>
<h3 id="8-结果分析">8. 结果分析</h3>
<p>结果分析一般指覆盖率分析。通常来说应当考虑两类覆盖率：<br>
<strong>1. 行覆盖率</strong>： 在测试用例中有多少RTL行代码被执行。一般来说我们要求行覆盖率在98%以上。<br>
<strong>2. 功能覆盖率</strong>：根据相应的信号判断您提取的功能点是否被覆盖且被正确触发。一般我们要求测试用例覆盖每个功能点。</p>
<h3 id="9-缺陷分析">9. 缺陷分析</h3>
<p>对DUT存在的缺陷进行分析。可以包括设计文档的规范性和详细性、DUT功能的正确性（是否存在bug）、DUT功能是否能被触发等方面。</p>
<h3 id="10-验证结论">10. 验证结论</h3>
<p>验证结论是在完成芯片验证过程后得出的最终结论，是对以上内容的总结。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9bbc770803b9bc1e63b3586d9d27b4a2">4 - 高级案例</h1>
    <div class="lead">基于开放验证平台完成验证的复杂案例。</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-def016dedd85ad313b8a6618f0995331">4.1 - 完整果壳 Cache 验证</h1>
    <div class="lead">利用Python语言对果壳Cache进行验证，</div>
	<h2 id="验证报告">验证报告</h2>
<p><a href="https://github.com/XS-MLVP/Example-NutShellCache/blob/master/nutshell_cache_report_demo.pdf">https://github.com/XS-MLVP/Example-NutShellCache/blob/master/nutshell_cache_report_demo.pdf</a></p>
<h2 id="验证环境用例代码">验证环境&amp;用例代码</h2>
<p><a href="https://github.com/XS-MLVP/Example-NutShellCache">https://github.com/XS-MLVP/Example-NutShellCache</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ddd72ebc8a861fa48194266f6ffaaf60">4.2 - TileLink 协议</h1>
    <div class="lead">基于C++驱动使用 TillLink 协议的 L2 Cache</div>
	
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3116bc87ca15222db8a1ea63529f340c">5 - 验证框架</h1>
    <div class="lead">搭建硬件验证环境所需的框架——Toffee</div>
	<p><strong>Toffee</strong> 是使用 Python 语言编写的一套硬件验证框架，它依赖于多语言转换工具 <a href="https://github.com/XS-MLVP/picker">Picker</a>，该工具能够将硬件设计的 Verilog 代码转换为 Python Package，使得用户可以使用 Python 来驱动并验证硬件设计。</p>
<p>其吸收了部分 UVM 验证方法学，以保证验证环境的规范性和可复用性，并重新设计了整套验证环境的搭建方式，使其更符合软件领域开发者的使用习惯，从而使软件开发者可以轻易地上手硬件验证工作。</p>
<p>在 <a href="https://pytoffee.readthedocs.io/zh-cn/latest/">Toffee Documentation</a> 中查看 Toffee 的详细使用说明。</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-465ae94d8a227578b663e5f9d84233ab">6 - (AI)验证智能体</h1>
    <div class="lead">基于大模型进行自动化UT验证智能体</div>
	<p><strong>UCAgent</strong> 是一个基于大语言模型的自动化硬件验证智能体，专注于芯片设计的单元测试(Unit Test)验证工作。该项目通过 AI 技术自动分析硬件设计，生成测试用例，并执行验证任务生成测试报告，从而提高验证效率。</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-74e4e4ada00d6610843bbbd117f4cd16">6.1 - 工具介绍</h1>
    <div class="lead">工具介绍与安装。</div>
	

<div class="pageinfo pageinfo-primary">
<p>随着芯片设计的愈发复杂，其验证难度和耗时也成倍增长，而近年来大语言模型的能力突飞猛进。于是我们推出了 UCAgent——一个基于大语言模型的自动化硬件验证 AI 代理，专注于芯片设计的单元测试(Unit Test)验证工作。
接下来我将从介绍、安装、使用、工作流、高级这五个方面来说明 UCAgent。</p>

</div>

<h2 id="介绍">介绍</h2>
<h3 id="背景">背景</h3>
<ul>
<li>芯片验证时间已经占据了芯片开发时间的 50-60%，并且设计工程师也将 49%的时间投入了硬件验证工作，但是 2024 年首次流片成功率仅有 14%。</li>
<li>随着 LLM 与编程类 Agent 兴起，将“硬件验证”抽象为“软件测试问题”可实现高比例自动化。</li>
</ul>
<h3 id="ucagent-是什么">UCAgent 是什么</h3>
<ul>
<li>面向芯片设计单元测试(Unit Test)的 AI Agent，基于 LLM 驱动，围绕“阶段化工作流 + 工具编排”自动/半自动完成需求理解、测试生成、执行与报告产出。</li>
<li>以用户为主导，LLM 为助理的协作式交互 Agent</li>
<li>以 Picker &amp; Toffee 为基础，DUT 以 Python 包形式被测试；可与 OpenHands/Copilot/Claude Code/Gemini-CLI/Qwen Code/ 等通过 MCP 协议深度协作。</li>
</ul>
<h3 id="能力与目标">能力与目标</h3>
<ul>
<li>自动/半自动：生成/完善测试代码与文档、运行用例、汇总报告</li>
<li>完整：功能覆盖率、代码行覆盖率与文档一致性</li>
<li>可集成：支持标准 CLI、TUI；提供 MCP server 接口便于外部 Code Agent 接入</li>
<li>目标：有效减少用户在验证过程中的重复工作</li>
</ul>
<h2 id="安装">安装</h2>
<h3 id="系统要求">系统要求</h3>
<ul>
<li>Python 版本： 3.11+</li>
<li>操作系统：Linux / macOS</li>
<li>API 需求：可访问 OpenAI 兼容 API</li>
<li>内存：建议 4GB+</li>
<li>依赖：<a href="https://github.com/XS-MLVP/picker">picker</a>（将 Verilog DUT 导出为 Python 包）</li>
</ul>
<h3 id="安装方式">安装方式</h3>
<ul>
<li>
<p>方式一：克隆仓库并安装依赖</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/XS-MLVP/UCAgent.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> UCAgent
</span></span><span style="display:flex;"><span>pip install -r requirements.txt
</span></span></code></pre></div></li>
<li>
<p>方式二（pip 安装）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install git+https://git@github.com/XS-MLVP/UCAgent@main
</span></span><span style="display:flex;"><span>ucagent --help <span style="color:#8f5902;font-style:italic"># 确认安装成功</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="使用">使用</h2>
<h3 id="快速开始">快速开始</h3>
<ol>
<li>
<p>pip 安装 UCAgent</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install git+https://git@github.com/XS-MLVP/UCAgent@main
</span></span></code></pre></div></li>
<li>
<p>准备 DUT（待测模块）</p>
</li>
</ol>
<ul>
<li>
<p>创建目录：在<code>{工作区}</code>目录下创建<code>Adder</code>目录。(<code>{工作区}</code>是指当前运行<code>ucagent</code>命令的地方，其他的的目录都以<code>{工作区}</code>为根目录)</p>
<ul>
<li><code>mkdir -p Adder</code></li>
</ul>
</li>
<li>
<p>RTL：使用<a href="https://open-verify.cc/mlvp/docs/quick-start/eg-adder/">快速开始-简单加法器</a>的加法器,将其代码放入<code>Adder/Adder.v</code></p>
</li>
<li>
<p>注入 bug：将输出和位宽修改为 63 位（用于演示位宽错误导致的缺陷）。</p>
<ul>
<li>
<p>将<code>Adder.v</code>第九行由<code>output [WIDTH-1:0] sum,</code>改为<code>output [WIDTH-2:0] sum,</code>，<code>vim Adder/Adder.v</code>。目前的 verilog 代码为：</p>
<div class="highlight line-numbers"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A verilog 64-bit full adder with carry in and carry out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">Adder</span> <span style="color:#000;font-weight:bold">#(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">parameter</span> <span style="color:#000">WIDTH</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000">cout</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">cout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">}</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<ol start="3">
<li>将 RTL 导出为 Python Module
<blockquote>
<p>picker 可以将 RTL 设计验证模块打包成动态库，并提供 Python 的编程接口来驱动电路。参照<a href="https://open-verify.cc/mlvp/docs/env_usage/picker_usage/">基础工具-工具介绍</a>和<a href="https://github.com/XS-MLVP/picker/blob/master/README.zh.md">picker 文档</a></p></blockquote>
</li>
</ol>
<ul>
<li>直接在<code>{工作区}</code>目录下执行命令<code>picker export Adder/Adder.v --rw 1 --sname Adder --tdir output/ -c -w output/Adder/Adder.fst</code></li>
</ul>
<ol start="4">
<li>编写 README</li>
</ol>
<ul>
<li>
<p>将加法器的说明、验证目标、bug 分析和其他都写在<code>Adder</code>文件夹的<code>README.md</code>文件中，同时将这个文件向<code>output/Adder</code>文件夹复制一份。</p>
<ul>
<li>
<p>将内容写入 readme 中，<code>vim Adder/README.md</code>，将下面内容复制到<code>README.md</code>中。</p>
</li>
<li>
<p>复制文件，<code>cp Adder/README.md output/Adder/README.md</code>。</p>
</li>
<li>
<p><code>Adder/README.md</code>内容可以是如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">### Adder 64 位加法器
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>输入 a, b, cin 输出 sum，cout
</span></span><span style="display:flex;"><span>实现 sum = a + b + cin
</span></span><span style="display:flex;"><span>cin 是进位输入
</span></span><span style="display:flex;"><span>cout 是进位输出
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">### 验证目标
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>只要验证加法相关的功能，其他验证，例如波形、接口等，不需要出现
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">### bug 分析
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>在 bug 分析时，请参考源码：examples/MyAdder/Adder.v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">### 其他
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>
</span></span><span style="display:flex;"><span>所有的文档和注释都用中文编写
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<ol start="5">
<li>安装 Qwen Code CLI</li>
</ol>
<ul>
<li>直接使用<code>npm</code>全局安装<code>sudo npm install -g @qwen-code/qwen-code</code>。（需要本地有<a href="https://nodejs.org/zh-cn/download/">nodejs 环境</a>）</li>
<li>其他安装方式请参考：<a href="https://qwenlm.github.io/qwen-code-docs/zh/deployment/">Qwen Code 执行与部署</a></li>
</ul>
<ol start="6">
<li>配置 Qwen Code CLI</li>
</ol>
<ul>
<li>修改<code>~/.qwen/settings.json</code> 配置文件，<code>vim ~/.qwen/settings.json</code>，示例 Qwen 配置文件如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;mcpServers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&#34;unitytest&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">&#34;httpUrl&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://localhost:5000/mcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">&#34;timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ol start="7">
<li>启动 MCP Server<a id="命令"></a></li>
</ol>
<ul>
<li>在<code>{工作区}</code>目录下：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ucagent output/ Adder -s -hm --tui --mcp-server-no-file-tools --no-embed-tools
</span></span></code></pre></div>见到如下图则表示启动成功：
<img src="tui.png" alt="tui.png"></li>
</ul>
<ol start="8">
<li>启动 Qwen Code</li>
</ol>
<ul>
<li>在<code>UCAgent/output</code>目录输入<code>qwen</code>启动 Qwen Code，看见 &gt;QWEN 图就表示启动成功。</li>
</ul>
<p><img src="qwen.png" alt="qwen.png"></p>
<ol start="9">
<li>开始验证</li>
</ol>
<ul>
<li>在框内输入提示词并且<strong>同意 Qwen Code 的使用工具、命令和读写文件请求</strong>。（通过<code>j/k</code>控制上/下）提示词如下：
<blockquote>
<p>请通过工具 RoleInfo 获取你的角色信息和基本指导，然后完成任务。请使用工具 ReadTextFile 读取文件。你需要在当前工作目录进行文件操作，不要超出该目录。</p></blockquote>
</li>
</ul>
<p><img src="qwen-allow.png" alt="qwen-allow.png"></p>
<p>有时候 Qwen Code 停止了，但是我们不确定是否完成了任务，此时可以通过查看 server 的 tui 界面来确认。</p>
<p><img src="tui-pause.png" alt="tui-pause.png">
此时 Mission 部分显示阶段还在 13，所以我们还要让 Qwen Code 继续执行任务。</p>
<p><img src="qwen-pause.png" alt="qwen-pause.png">
中途停止了，但是任务没有完成，可以通过在输入框里输入“继续”来继续。</p>
<ol start="10">
<li>结果分析<a id="详细输出"></a></li>
</ol>
<p>最终的结果都在<code>output</code>文件夹中，其中的内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── Adder  <span style="color:#8f5902;font-style:italic"># 打包好的python DUT</span>
</span></span><span style="display:flex;"><span>├── Guide_Doc <span style="color:#8f5902;font-style:italic"># 各种模板文件</span>
</span></span><span style="display:flex;"><span>├── uc_test_report <span style="color:#8f5902;font-style:italic"># 跑完的测试报告，包含可以直接网页运行的index.html</span>
</span></span><span style="display:flex;"><span>└── unity_test <span style="color:#8f5902;font-style:italic"># 各种生成的文档和测试用例文件</span>
</span></span><span style="display:flex;"><span>    └── tests <span style="color:#8f5902;font-style:italic"># 测试用例及其依赖</span>
</span></span></code></pre></div><ul>
<li>
<p>Guide_Doc：这些文件是“规范/示例/模板型”的参考文档，启动时会从<code>vagent/lang/zh/doc/Guide_Doc</code>复制到工作区的 <code>Guide_Doc/</code>（当前以 output 作为 workspace 时即 <code>output/Guide_Doc/</code>）。它们不会被直接执行，供人和 AI 作为编写 unity_test 文档与测试的范式与规范，并被语义检索工具读取，在 UCAgent 初始化时复制过来。</p>
<ul>
<li>
<p>dut_functions_and_checks.md<br>
用途：定义功能分组 FG-、功能点 FC-、检测点 CK-* 的组织方式与写法规范，要求覆盖所有功能点，每个功能点至少一个检测点。<br>
最终要产出的对应物：unity_test/{DUT}_functions_and_checks.md（如 <code>Adder_functions_and_checks.md</code>）。</p>
</li>
<li>
<p>dut_fixture.md<br>
用途：说明如何编写 DUT Fixture/Env（包含接口、时序、复位、激励、监视、检查、钩子等），给出标准写法和必备项。<br>
对应物：unity_test/DutFixture 与 EnvFixture 相关实现/文档。</p>
</li>
<li>
<p>dut_api_instruction.md<br>
用途：DUT API 设计与文档规范（接口命名、参数、返回、约束、边界条件、错误处理、示例）。<br>
对应物：unity_test/{DUT}_api.md 或 API 实现+测试（如 <code>Adder_api.py</code>）。</p>
</li>
<li>
<p>dut_function_coverage_def.md<br>
用途：功能覆盖（Functional Coverage）定义方法，如何从 FG/FC/CK 推导覆盖项、covergroup/coverpoint/bin 的组织与命名。<br>
对应物：coverage 定义文件与生成的覆盖数据、以及相关说明文档，如<code>Adder_function_coverage_def.py</code>。</p>
</li>
<li>
<p>dut_line_coverage.md<br>
用途：行覆盖采集与分析方法，如何启用、统计、解读未命中行、定位冗余或缺失测试。<br>
对应物：行覆盖数据文件与分析笔记（unity_test/{DUT}_line_coverage_analysis.md，如 <code>Adder_line_coverage_analysis.md</code>）。</p>
</li>
<li>
<p>dut_test_template.md<br>
用途：测试用例的骨架/模板，给出最小可行的结构与编写范式（Arrange-Act-Assert、前后置、标记/选择器等）。<br>
对应物：tests/ 下各具体测试文件的基本结构参考。</p>
</li>
<li>
<p>dut_test_case.md<br>
用途：单个测试用例的撰写规范（命名、输入空间、边界/异常、可重复性、断言质量、日志、标记）。<br>
对应物：tests/ 中具体 test_xxx.py::test_yyy 的质量基准与填写要求。</p>
</li>
<li>
<p>dut_test_program.md<br>
用途：测试计划/测试编排（回归集合、分层/分阶段执行、标记与选择、超时控制、先后顺序、依赖关系）。<br>
对应物：回归集配置、命令/脚本、阶段化执行策略文档。</p>
</li>
<li>
<p>dut_test_summary.md<br>
用途：测试阶段性/最终总结的结构（通过率、覆盖率、主要问题、修复状态、风险/残留问题、下一步计划）。<br>
对应物：unity_test/{DUT}_test_summary.md（如<code>Adder_test_summary.md</code>） 或报告页面（<code>output/uc_test_report</code>）。</p>
</li>
<li>
<p>dut_bug_analysis.md<br>
用途：Bug 记录与分析规范（复现步骤、根因分析、影响范围、修复建议、验证状态、标签与追踪）。<br>
对应物：unity_test/{DUT}_bug_analysis.md（如<code>Adder_bug_analysis.md</code>）。</p>
</li>
</ul>
</li>
<li>
<p>uc_test_report：由 toffee-test 生成的 index.html 报告，可直接使用浏览器打开。</p>
<ul>
<li>这个报告包含了 Line Coverage 行覆盖率，Functional Coverage 功能覆盖率，测试用例的通过情况，功能点标记具体情况等内容。</li>
</ul>
</li>
<li>
<p>unity_test/tests：验证代码文件夹</p>
<ul>
<li>
<p><code>Adder.ignore</code><br>
作用：行覆盖率忽略清单。支持忽略整个文件，或以“起止行段”形式忽略代码段。<br>
被谁使用：<code>Adder_api.py</code> 的 <code>set_line_coverage(request, get_coverage_data_path(request, new_path=False), ignore=current_path_file(&quot;Adder.ignore&quot;))</code>。</p>
<p>与 Guide_Doc 的关系：
对应参考：<code>dut_line_coverage.md</code>（说明如何启用/统计/分析行覆盖，以及忽略规则的意义和使用场景）。</p>
</li>
<li>
<p><code>Adder_api.py</code><br>
作用：测试公共基座，集中放 DUT 构造、覆盖率接线与采样、pytest 基础夹具（fixtures）和示例 API。</p>
<ul>
<li>create_dut(request): 实例化 DUT、设置覆盖率文件、可选波形、绑定 StepRis 采样。</li>
<li>AdderEnv: 封装引脚与常用操作（Step）。</li>
<li>api_Adder_add: 对外暴露的测试 API，完成参数校验、信号赋值、推进、读取结果。</li>
<li>pytest fixtures：dut（模块级，负责覆盖率采样/收集交给 toffee_test）、env（函数级，给每个 test 一个全新环境）。</li>
</ul>
<p>与 Guide_Doc 的关系：</p>
<ul>
<li>dut_fixture.md：夹具/环境（Fixture/Env）的组织、Step/StepRis 的用法与职责边界。</li>
<li>dut_api_instruction.md：API 设计（命名、参数约束、返回、示例、异常）和文档规范。</li>
<li>dut_function_coverage_def.md：如何将功能覆盖组接线到 DUT 并在 StepRis 内采样。</li>
<li>dut_line_coverage.md：如何设置行覆盖文件、忽略清单，并将数据上报给 toffee_test。</li>
</ul>
</li>
<li>
<p><code>Adder_function_coverage_def.py</code><br>
作用：功能覆盖定义（Functional Coverage），声明 FG/FC/CK 并给出 watch_point 条件。</p>
<ul>
<li>定义覆盖组：FG-API、FG-ARITHMETIC、FG-BIT-WIDTH。</li>
</ul>
</li>
<li>
<p>每组下定义 FC-_ 和 CK-_ 条件（如 CK-BASIC/CK-CARRY-IN/CK-OVERFLOW 等）。</p>
<ul>
<li>get_coverage_groups(dut): 初始化并返回覆盖组列表，供 Adder_api.py 绑定与采样。</li>
</ul>
<p>与 Guide_Doc 的关系：</p>
<ul>
<li>dut_function_coverage_def.md：覆盖组/覆盖点的组织方式与命名规范、watch_point 的表达方式。</li>
<li>dut_functions_and_checks.md：FG/FC/CK 的命名体系与映射关系来源，测试中用 mark_function 标记覆盖时需与此保持一致。</li>
</ul>
</li>
<li>
<p><code>test_Adder_api_basic.py</code><br>
作用：API 层面的基础功能测试，覆盖典型输入、进位、零值、溢出、边界等。</p>
<ul>
<li>使用 from Adder_api import * 来获取 fixtures（dut/env）与 API。</li>
<li>在每个测试中通过 env.dut.fc_cover[&ldquo;FG-&hellip;&rdquo;].mark_function(&ldquo;FC-&hellip;&rdquo;, &lt;test_fn&gt;, [&ldquo;CK-&hellip;&rdquo;]) 标注功能覆盖命中关系。
与 Guide_Doc 的关系：</li>
<li>dut_test_case.md：单测结构（目标/流程/预期）、命名与断言规范、可重复性、标记与日志。</li>
<li>dut_functions_and_checks.md：FG/FC/CK 的正确引用与标注。</li>
<li>dut_test_template.md：docstring 和结构写法的范式来源。</li>
</ul>
</li>
<li>
<p><code>test_Adder_functional.py</code><br>
作用：功能行为测试（接近“场景/功能项”的角度），比 API 基测覆盖更全面的功能点验证。</p>
<ul>
<li>同样通过 mark_function 与 FG/FC/CK 标签体系对齐。
与 Guide_Doc 的关系：
<ul>
<li>dut_test_case.md：功能类测试的编写规范与断言要求。</li>
<li>dut_functions_and_checks.md：功能覆盖标注的规范与完整性。</li>
<li>dut_test_template.md：测试函数组织的范式。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>test_example.py</code><br>
作用：空白样例（脚手架），用于新增测试文件的最小模板参考。
与 Guide_Doc 的关系：</p>
<ul>
<li>dut_test_template.md：新建测试文件/函数时的结构、引入方式与标注方法的模板。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>unity_test/*.md：验证相关文档</p>
<ul>
<li>
<p>Adder_basic_info.md</p>
<ul>
<li>用途：DUT 概览与接口说明（功能、端口、类型、粗粒度功能分类）。</li>
<li>参考：<code>Guide_Doc/dut_functions_and_checks.md</code>（接口/功能分类用语）、<code>Guide_Doc/dut_fixture.md</code>（从验证视角描述 I/O 与 Step 时可参考）。</li>
</ul>
</li>
<li>
<p>Adder_verification_needs_and_plan.md</p>
<ul>
<li>用途：验证需求与计划（目标、风险点、测试项规划、方法论）。</li>
<li>参考：<code>Guide_Doc/dut_test_program.md</code>（编排与选择策略）、<code>Guide_Doc/dut_test_case.md</code>（单测质量要求）、<code>Guide_Doc/dut_functions_and_checks.md</code>（从需求到 FG/FC/CK 的映射）。</li>
</ul>
</li>
<li>
<p>Adder_functions_and_checks.md</p>
<ul>
<li>用途：FG/FC/CK 真源清单，测试标注与功能覆盖定义需与此保持一致。</li>
<li>参考：<code>Guide_Doc/dut_functions_and_checks.md</code>（结构/命名）、<code>Guide_Doc/dut_function_coverage_def.md</code>（如何落地为覆盖实现）。</li>
</ul>
</li>
<li>
<p>Adder_line_coverage_analysis.md</p>
<ul>
<li>用途：行覆盖率结论与分析，解释忽略清单、未命中行、补测建议。</li>
<li>参考：<code>Guide_Doc/dut_line_coverage.md</code>；配合同目录 tests 下的 <code>Adder.ignore</code>。</li>
</ul>
</li>
<li>
<p>Adder_bug_analysis.md</p>
<ul>
<li>用途：缺陷分析报告，按 CK/TC 对应、置信度、根因、修复建议与回归方法撰写。</li>
<li>参考：<code>Guide_Doc/dut_bug_analysis.md</code>（结构/要素）、<code>Guide_Doc/dut_functions_and_checks.md</code>（命名一致）。</li>
</ul>
</li>
<li>
<p>Adder_test_summary.md</p>
<ul>
<li>用途：阶段性/最终测试总结（执行统计、覆盖情况、缺陷分布、建议、结论）。</li>
<li>参考：<code>Guide_Doc/dut_test_summary.md</code>，与 <code>Guide_Doc/dut_test_program.md</code> 呼应。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="11">
<li>流程总结</li>
</ol>
<p>要做什么：</p>
<ul>
<li>将 DUT（如 Adder）打包为可测的 Python 模块</li>
<li>启动 UCAgent（可带 MCP Server），让 Code Agent 协作按阶段推进验证</li>
<li>依据 Guide_Doc 规范生成/完善 unity_test 文档与 tests，并以功能覆盖+行覆盖驱动测试</li>
<li>发现并分析缺陷，产出报告与结论</li>
</ul>
<p>做了什么：</p>
<ul>
<li>用 picker 将 RTL 导出为 Python 包（<code>output/Adder/</code>），准备最小 README 与文件清单</li>
<li>启动 <code>ucagent</code>（含 <code>--mcp-server</code>/<code>--mcp-server-no-file-tools</code>），在 TUI/MCP 下协作</li>
<li>在 Guide_Doc 规范约束下，生成/补全：
<ul>
<li>功能清单与检测点：<code>unity_test/Adder_functions_and_checks.md</code>（FG/FC/CK）</li>
<li>夹具/环境与 API：<code>tests/Adder_api.py</code>（<code>create_dut</code>、<code>AdderEnv</code>、<code>api_Adder_*</code>）</li>
<li>功能覆盖定义：<code>tests/Adder_function_coverage_def.py</code>（绑定 <code>StepRis</code> 采样）</li>
<li>行覆盖配置与忽略：<code>tests/Adder.ignore</code>，分析文档 <code>unity_test/Adder_line_coverage_analysis.md</code></li>
<li>用例实现：<code>tests/test_*.py</code>（标注 <code>mark_function</code> 与 FG/FC/CK）</li>
<li>缺陷分析与总结：<code>unity_test/Adder_bug_analysis.md</code>、<code>unity_test/Adder_test_summary.md</code></li>
</ul>
</li>
<li>通过工具编排推进：<code>RunTestCases</code>/<code>Check</code>/<code>StdCheck</code>/<code>KillCheck</code>/<code>Complete</code>/<code>GoToStage</code></li>
<li>权限控制仅允许写 <code>unity_test/</code> 与 <code>tests</code>（<code>add_un_write_path</code>/<code>del_un_write_path</code>）</li>
</ul>
<p>实现的效果：</p>
<ul>
<li>自动/半自动地产出合规的文档与可回归的测试集，支持全量与定向回归</li>
<li>功能覆盖与行覆盖数据齐备，未命中点可定位与补测</li>
<li>缺陷根因、修复建议与验证方法有据可依，形成结构化报告（<code>uc_test_report/index.html</code>）</li>
<li>支持 MCP 集成与 TUI 协作，过程可暂停/检查/回补，易于迭代与复用</li>
</ul>
<p>典型操作轨迹（卡住时）：</p>
<ul>
<li><code>Check</code> → <code>StdCheck(lines=-1)</code> → <code>KillCheck</code> → 修复 → <code>Check</code> → <code>Complete</code></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6d7ccde5388a9664f923cf6de9f5e2d0">6.2 - 使用</h1>
    <div class="lead">两种使用方式、各个选项参数、TUI界面和FAQ说明。</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4c2f0764b1448b4485db5bdc8abbc971">6.2.1 - MCP集成模式（推荐）</h1>
    <div class="lead">如何使用MCP集成模式来使用UCAgent。</div>
	<h2 id="mcp-集成推荐集成code-agent">MCP 集成（推荐）集成Code Agent</h2>
<p>基于 MCP 的外部编程 CLI 协作方式。该模式能与所有支持 MCP-Server 调用的 LLM 客户端进行协同验证，例如：Cherry Studio、Claude Code、 Gemini-CLI、VS Code Copilot、Qwen-Code等。
平常使用是直接使用<code>make</code>命令的，要看详细命令可参考<a href="../ucagent/introduce.md/#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始</a>，也可以直接查看项目根目录的<code>Makefile</code>文件。</p>
<ul>
<li>
<p>准备RTL和对应的SPEC文档放入<code>examples/{dut}</code>文件夹。<code>{dut}</code>是模块的名称，比如<code>Adder</code>，如果是<code>Adder</code>，目录则为<code>examples/Adder</code>。</p>
</li>
<li>
<p>打包RTL，将文档放入工作目录并且启动 MCP server：<code>make mcp_{dut}</code>，<code>{dut}</code>为对应的模块。此处如果使用的<code>Adder</code>，则命令为<code>make mcp_Adder</code></p>
</li>
<li>
<p>在支持 MCP client 的应用中配置 JSON：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;mcpServers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&#34;unitytest&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">&#34;httpUrl&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://localhost:5000/mcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">&#34;timeout&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
<li>
<p>启动应用：此处使用的Qwen Code，在<code>UCAgent/output</code>启动qwen,然后输入提示词。</p>
</li>
<li>
<p>输入提示词：</p>
</li>
</ul>
<blockquote>
<p>请通过工具<code>RoleInfo</code>获取你的角色信息和基本指导，然后完成任务。工具<code>ReadTextFile</code>读取文件。你需要在当前工作目录进行文件操作，不要超出该目录。</p></blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7735a0965a81b3fff45d8f9c0238a813">6.2.2 - 直接使用模式</h1>
    <div class="lead">直接使用方式、各个选项参数、TUI界面和FAQ说明。</div>
	<h2 id="直接使用">直接使用</h2>
<p>基于本地 CLI 和大模型的使用方式。需要准备好 OpenAI 兼容的 API 和嵌入模型 API。</p>
<h3 id="使用环境变量配置推荐">使用环境变量配置（推荐）</h3>
<p>配置文件内容：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># OpenAI兼容的API配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">openai</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">model_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$(OPENAI_MODEL: Qwen/Qwen3-Coder-30B-A3B-Instruct)&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 模型名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$(OPENAI_API_KEY: YOUR_API_KEY)&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># API密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_base</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$(OPENAI_API_BASE: http://10.156.154.242:8000/v1)&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># API基础URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 向量嵌入模型配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 用于文档搜索和记忆功能，不需要可通过 --no-embed-tools 关闭</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">embed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">model_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$(EMBED_MODEL: Qwen/Qwen3-Embedding-0.6B)&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入模型名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$(EMBED_OPENAI_API_KEY: YOUR_API_KEY)&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入模型API密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_base</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$(EMBED_OPENAI_API_BASE: http://10.156.154.242:8001/v1)&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入模型API URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dims</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入维度</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>UCAgent 的配置文件支持 Bash 风格的环境变量占位：<code>$(VAR: default)</code>。加载时会用当前环境变量 <code>VAR</code> 的值替换；若未设置，则使用 <code>default</code>。</p>
<ul>
<li>例如在内置配置 <code>vagent/setting.yaml</code> 中：
<ul>
<li><code>openai.model_name: &quot;$(OPENAI_MODEL: &lt;your_chat_model_name&gt;)&quot;</code></li>
<li><code>openai.openai_api_key: &quot;$(OPENAI_API_KEY: [your_api_key])&quot;</code></li>
<li><code>openai.openai_api_base: &quot;$(OPENAI_API_BASE: http://&lt;your_chat_model_url&gt;/v1)&quot;</code></li>
<li><code>embed.model_name: &quot;$(EMBED_MODEL: &lt;your_embedding_model_name&gt;)&quot;</code></li>
<li>也支持其他提供商：<code>model_type</code> 可选 <code>openai</code>、<code>anthropic</code>、<code>google_genai</code>（详见 <code>vagent/setting.yaml</code>）。</li>
</ul>
</li>
</ul>
<p>你可以仅通过导出环境变量完成模型与端点切换，而无需改动配置文件。</p>
<p>示例：设置聊天模型与端点</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定聊天模型（OpenAI 兼容）</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">OPENAI_MODEL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;Qwen/Qwen3-Coder-30B-A3B-Instruct&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定 API Key 与 Base（按你的服务商填写）</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">OPENAI_API_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;你的API密钥&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">OPENAI_API_BASE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;https://你的-openai-兼容端点/v1&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可选：嵌入模型（若使用检索/记忆等功能）</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">EMBED_MODEL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;text-embedding-3-large&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">EMBED_OPENAI_API_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#000">$OPENAI_API_KEY</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">EMBED_OPENAI_API_BASE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#000">$OPENAI_API_BASE</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>然后按前述命令启动 UCAgent 即可。若要长期生效，可将上述 export 追加到你的默认 shell 启动文件（例如 bash: <code>~/.bashrc</code>，zsh: <code>~/.zshrc</code>，fish: <code>~/.config/fish/config.fish</code>），保存后重新打开终端或手动加载。</p>
<h3 id="使用-configyaml-来配置">使用 config.yaml 来配置</h3>
<ul>
<li>在项目根目录创建并编辑 <code>config.yaml</code> 文件，配置 AI 模型和嵌入模型：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># OpenAI兼容的API配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">openai</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_base</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_openai_api_base_url&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># API基础URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">model_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_model_name&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 模型名称，如 gpt-4o-mini</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_openai_api_key&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># API密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 向量嵌入模型配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 用于文档搜索和记忆功能，不需要可通过 --no-embed-tools 关闭</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">embed</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">model_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_embed_model_name&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入模型名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_base</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_openai_api_base_url&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入模型API URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">openai_api_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_api_key&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入模型API密钥</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dims</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;your_embed_model_dims&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 嵌入维度，如 1536</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="开始使用">开始使用</h3>
<ul>
<li>第一步和 MCP 模式相同，准备 RTL 和对应的 SPEC 文档放入<code>examples/{dut}</code>文件夹。<code>{dut}</code>是模块的名称，如果是<code>Adder</code>，目录则为<code>examples/Adder</code>。</li>
<li>第二步开始就不同了，打包 RTL，将文档放入工作目录并启动 UCAgent TUI：<code>make test_{dut}</code>，<code>{dut}</code>为对应的模块。若使用 <code>Adder</code>，命令为 <code>make test_Adder</code>（可在 <code>Makefile</code> 查看全部目标）。该命令会：
<ul>
<li>将 <code>examples/{dut}</code> 下文件拷贝到 <code>output/{dut}</code>（含 .v/.sv/.md/.py 等）</li>
<li>执行 <code>python3 ucagent.py output/ {dut} --config config.yaml -s -hm --tui -l</code></li>
<li>启动带 TUI 的 UCAgent，并自动进入任务循环（loop）</li>
</ul>
</li>
</ul>
<p>提示：验证产物默认写入 <code>output/unity_test/</code>，若需更改可通过 CLI 的 <code>--output</code> 参数指定目录名。</p>
<h3 id="直接用-cli-启动不经-makefile">直接用 CLI 启动（不经 Makefile）</h3>
<ul>
<li>未安装命令时（项目内运行）：
<ul>
<li><code>python3 ucagent.py output/ Adder --config config.yaml -s -hm --tui -l</code></li>
</ul>
</li>
<li>安装为命令后：
<ul>
<li><code>ucagent output/ Adder --config config.yaml -s -hm --tui -l</code></li>
</ul>
</li>
</ul>
<p>参数对齐 <code>vagent/cli.py</code>：</p>
<ul>
<li><code>workspace</code>：工作区目录（此处为 <code>output/</code>）</li>
<li><code>dut</code>：DUT 名称（工作区子目录名，如 <code>Adder</code>）</li>
<li>常用可选项：
<ul>
<li><code>--tui</code> 启动终端界面</li>
<li><code>-l/--loop --loop-msg &quot;...&quot;</code> 启动后立即进入循环并注入提示</li>
<li><code>-s/--stream-output</code> 实时输出</li>
<li><code>-hm/--human</code> 进入人工可干预模式（在阶段间可暂停）</li>
<li><code>--no-embed-tools</code> 如不需要检索/记忆工具</li>
<li><code>--skip/--unskip</code> 跳过/取消跳过阶段（可多次传入）</li>
</ul>
</li>
</ul>
<h3 id="常用-tui-命令速查直接使用模式">常用 TUI 命令速查（直接使用模式）</h3>
<ul>
<li>列出工具：<code>tool_list</code></li>
<li>阶段检查：<code>tool_invoke Check timeout=0</code></li>
<li>查看日志：<code>tool_invoke StdCheck lines=-1</code>（-1 表示所有行）</li>
<li>终止检查：<code>tool_invoke KillCheck</code></li>
<li>阶段完成：<code>tool_invoke Complete timeout=0</code></li>
<li>运行用例：
<ul>
<li>全量：<code>tool_invoke RunTestCases target='' timeout=0</code></li>
<li>单测函数：<code>tool_invoke RunTestCases target='tests/test_checker.py::test_run' timeout=120 return_line_coverage=True</code></li>
<li>过滤：<code>tool_invoke RunTestCases target='-k add or mul'</code></li>
</ul>
</li>
<li>阶段跳转：<code>tool_invoke GoToStage index=2</code>（索引从 0 开始）</li>
<li>继续执行：<code>loop 继续修复 ALU754 的未命中分支并重试用例</code></li>
</ul>
<p>建议的最小可写权限（只允许生成验证产物处可写）：</p>
<ul>
<li>仅允许 <code>unity_test/</code> 与 <code>unity_test/tests/</code> 可写：
<ul>
<li><code>add_un_write_path *</code></li>
<li><code>del_un_write_path unity_test</code></li>
<li><code>del_un_write_path unity_test/tests</code></li>
</ul>
</li>
</ul>
<h3 id="常见问题与提示">常见问题与提示</h3>
<ul>
<li>检查卡住/无输出：
<ul>
<li>先 <code>tool_invoke StdCheck lines=-1</code> 查看全部日志；必要时 <code>tool_invoke KillCheck</code>；修复后重试 <code>tool_invoke Check</code>。</li>
</ul>
</li>
<li>没找到工具名：
<ul>
<li>先执行 <code>tool_list</code> 确认可用工具；若缺失，检查是否在 TUI 模式、是否禁用了嵌入工具（通常无关）。</li>
</ul>
</li>
<li>产物位置：
<ul>
<li>默认在 <code>workspace/output_dir</code>，即本页示例为 <code>output/unity_test/</code>。</li>
</ul>
</li>
</ul>
<h3 id="相关文档">相关文档</h3>
<ul>
<li>人机协同的完整流程与示例，见<a href="/mlvp/docs/ucagent/usage/assit/">人机协同验证</a></li>
<li>MCP 集成（如 gemini-cli / qwen code），见<a href="/mlvp/docs/ucagent/usage/mcp/">MCP集成模式</a></li>
<li>TUI 界面与操作详解，见<a href="/mlvp/docs/ucagent/usage/tui/">TUI</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fbd7beae096d8cd3a81879ce0d6d9759">6.2.3 - 人机协同验证</h1>
    <div class="lead">如何与AI配合来验证模块。</div>
	<p>UCAgent 支持在验证过程中进行人机协同，允许用户暂停 AI 执行，人工干预验证过程，然后继续 AI 执行。这种模式适用于需要精细控制或复杂决策的场景。</p>
<p><strong>协同流程：</strong></p>
<ol>
<li>
<p>暂停 AI 执行：</p>
<ul>
<li>在直接接入 LLM 模式下：按 <code>Ctrl+C</code> 暂停。</li>
<li>在 Code Agent 协同模式下：根据 Agent 的暂停方式（如 Gemini-cli 使用 <code>Esc</code>）暂停。</li>
</ul>
</li>
<li>
<p>人工干预：</p>
<ul>
<li>手动编辑文件、测试用例或配置。</li>
<li>使用交互命令进行调试或调整。</li>
</ul>
</li>
<li>
<p>阶段控制：</p>
<ul>
<li>使用 <code>tool_invoke Check</code> 检查当前阶段状态。</li>
<li>使用 <code>tool_invoke Complete</code> 标记阶段完成并进入下一阶段。</li>
</ul>
</li>
<li>
<p>继续执行：</p>
<ul>
<li>使用 <code>loop [prompt]</code> 命令继续 AI 执行，并可提供额外的提示信息。</li>
<li>在 Code Agent 模式下，通过 Agent 的控制台输入提示。</li>
</ul>
</li>
<li>
<p>权限管理：</p>
<ul>
<li>可使用 <code>add_un_write_path</code>，<code>del_un_write_path</code> 等命令设置文件写权限，控制 AI 是否可以编辑特定文件。</li>
<li>适用于直接接入 LLM 或强制使用 UCAgent 文件工具。</li>
</ul>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-56fd437efd30e85d1af55e127ea86585">6.2.4 - 参数说明</h1>
    <div class="lead">各个选项参数说明。</div>
	<h2 id="参数与选项">参数与选项</h2>
<p>UCAgent 的使用方式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ucagent &lt;workspace&gt; &lt;dut_name&gt; <span style="color:#ce5c00;font-weight:bold">{</span>参数与选项<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="输入">输入</h3>
<ul>
<li>workspace：工作目录：
<ul>
<li>workspace/&lt;DUT_DIR&gt;: 待测设计（DUT），即由 picker 导出的 DUT 对应的 Python 包 &lt;DUT_DIR&gt;，例如：Adder</li>
<li>workspace/&lt;DUT_DIR&gt;/README.md: 以自然语言描述的该 DUT 验证需求与目标</li>
<li>workspace/&lt;DUT_DIR&gt;/*.md: 其他参考文件</li>
<li>workspace/&lt;DUT_DIR&gt;/*.v/sv/scala: 源文件，用于进行 bug 分析</li>
<li>其他与验证相关的文件（例如：提供的测试实例、需求说明等）</li>
</ul>
</li>
<li>dut_name: 待测设计的名称，即 &lt;DUT_DIR&gt;，例如：Adder</li>
</ul>
<h3 id="输出">输出</h3>
<ul>
<li>workspace：工作目录：
<ul>
<li>workspace/Guide_Doc：验证过程中所遵循的各项要求与指导文档</li>
<li>workspace/uc_test_report： 生成的 Toffee-test 测试报告</li>
<li>workspace/unity_test/tests： 自动生成的测试用例</li>
<li>workspace/*.md： 生成的各类文档，包括 Bug 分析、检查点记录、验证计划、验证结论等</li>
</ul>
</li>
</ul>
<blockquote>
<p>对输出的详细解释可以参考<a href="/mlvp/docs/ucagent/introduce/#%e8%af%a6%e7%bb%86%e8%be%93%e5%87%ba">快速开始的9</a></p></blockquote>
<h3 id="位置参数">位置参数</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">参数</th>
          <th style="text-align: center">必填</th>
          <th style="text-align: left">说明</th>
          <th style="text-align: left">示例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">workspace</td>
          <td style="text-align: center">是</td>
          <td style="text-align: left">运行代理的工作目录</td>
          <td style="text-align: left">./output</td>
      </tr>
      <tr>
          <td style="text-align: left">dut</td>
          <td style="text-align: center">是</td>
          <td style="text-align: left">DUT 名称（工作目录下的子目录名）</td>
          <td style="text-align: left">Adder</td>
      </tr>
  </tbody>
</table>
<h3 id="执行与交互">执行与交互</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--stream-output</td>
          <td style="text-align: left">-s</td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">关闭</td>
          <td style="text-align: left">流式输出到控制台</td>
      </tr>
      <tr>
          <td style="text-align: left">--human</td>
          <td style="text-align: left">-hm</td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">关闭</td>
          <td style="text-align: left">启动时进入人工输入/断点模式</td>
      </tr>
      <tr>
          <td style="text-align: left">--interaction-mode</td>
          <td style="text-align: left">-im</td>
          <td style="text-align: left">standard/enhanced/advanced</td>
          <td style="text-align: left">standard</td>
          <td style="text-align: left">交互模式；enhanced 含规划与记忆管理，advanced 含自适应策略</td>
      </tr>
      <tr>
          <td style="text-align: left">--tui</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">关闭</td>
          <td style="text-align: left">启用终端 TUI 界面</td>
      </tr>
      <tr>
          <td style="text-align: left">--loop</td>
          <td style="text-align: left">-l</td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">关闭</td>
          <td style="text-align: left">启动后立即进入主循环（可配合 --loop-msg），适用于直接使用模式</td>
      </tr>
      <tr>
          <td style="text-align: left">--loop-msg</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">str</td>
          <td style="text-align: left">空</td>
          <td style="text-align: left">进入循环时注入的首条消息</td>
      </tr>
      <tr>
          <td style="text-align: left">--seed</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">随机</td>
          <td style="text-align: left">随机种子（未指定则自动随机）</td>
      </tr>
      <tr>
          <td style="text-align: left">--sys-tips</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">str</td>
          <td style="text-align: left">空</td>
          <td style="text-align: left">覆盖系统提示词</td>
      </tr>
  </tbody>
</table>
<h3 id="配置与模板">配置与模板</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--config</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">path</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">配置文件路，如&ndash;config config.yaml径</td>
      </tr>
      <tr>
          <td style="text-align: left">--template-dir</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">path</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">自定义模板目录</td>
      </tr>
      <tr>
          <td style="text-align: left">--template-overwrite</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">渲染模板到 workspace 时允许覆盖已存在内容</td>
      </tr>
      <tr>
          <td style="text-align: left">--output</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">dir</td>
          <td style="text-align: left">unity_test</td>
          <td style="text-align: left">输出目录名</td>
      </tr>
      <tr>
          <td style="text-align: left">--override</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">A.B.C=VALUE[,X.Y=VAL2,&hellip;]</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">以“点号路径=值”覆盖配置；字符串需引号，其它按 Python 字面量解析</td>
      </tr>
      <tr>
          <td style="text-align: left">--gen-instruct-file</td>
          <td style="text-align: left">-gif</td>
          <td style="text-align: left">file</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">在 workspace 下生成外部 Agent 的引导文件（存在则覆盖）</td>
      </tr>
      <tr>
          <td style="text-align: left">--guid-doc-path</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">path</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">使用自定义 Guide_Doc 目录（默认使用内置拷贝）</td>
      </tr>
  </tbody>
</table>
<h3 id="计划与-todo">计划与 ToDo</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--force-todo</td>
          <td style="text-align: left">-fp</td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">在 standard 模式下也启用 ToDo 工具，并在每轮提示中附带 ToDo 信息</td>
      </tr>
      <tr>
          <td style="text-align: left">--use-todo-tools</td>
          <td style="text-align: left">-utt</td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">启用 ToDo 相关工具（不限于 standard 模式）</td>
      </tr>
  </tbody>
</table>
<h3 id="todo-工具概览与示例--给模型规划的小模型关闭大模型自行打开">ToDo 工具概览与示例  给模型规划的，小模型关闭，大模型自行打开</h3>
<p>说明：ToDo 工具是用于提升模型规划能力的工具，用户可以利用它来自定义模型的ToDo列表。目前该功能对模型能力要求较高，默认处于关闭状态。</p>
<p>启用条件：任意模式下使用 <code>--use-todo-tools</code>；或在 standard 模式用 <code>--force-todo</code> 强制启用并在每轮提示中附带 ToDo 信息。</p>
<p>约定与限制：步骤索引为 1-based；steps 数量需在 2~20；notes 与每个 step 文本长度 ≤ 100；超限会拒绝并返回错误字符串。</p>
<p>工具总览</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">工具类</th>
          <th style="text-align: left">调用名</th>
          <th style="text-align: left">主要功能</th>
          <th style="text-align: left">参数</th>
          <th style="text-align: left">返回</th>
          <th style="text-align: left">关键约束/行为</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">CreateToDo</td>
          <td style="text-align: left">CreateToDo</td>
          <td style="text-align: left">新建当前 ToDo（覆盖旧 ToDo）</td>
          <td style="text-align: left">task_description: str; steps: List[str]</td>
          <td style="text-align: left">成功提示 + 摘要字符串</td>
          <td style="text-align: left">校验步数与长度；成功后写入并返回摘要</td>
      </tr>
      <tr>
          <td style="text-align: left">CompleteToDoSteps</td>
          <td style="text-align: left">CompleteToDoSteps</td>
          <td style="text-align: left">将指定步骤标记为完成，可附加备注</td>
          <td style="text-align: left">completed_steps: List[int]=[]; notes: str=&quot;&quot;</td>
          <td style="text-align: left">成功提示（完成数）+ 摘要</td>
          <td style="text-align: left">仅未完成步骤生效；无 ToDo 时提示先创建；索引越界忽略</td>
      </tr>
      <tr>
          <td style="text-align: left">UndoToDoSteps</td>
          <td style="text-align: left">UndoToDoSteps</td>
          <td style="text-align: left">撤销步骤完成状态，可附加备注</td>
          <td style="text-align: left">steps: List[int]=[]; notes: str=&quot;&quot;</td>
          <td style="text-align: left">成功提示（撤销数）+ 摘要</td>
          <td style="text-align: left">仅已完成步骤生效；无 ToDo 时提示先创建；索引越界忽略</td>
      </tr>
      <tr>
          <td style="text-align: left">ResetToDo</td>
          <td style="text-align: left">ResetToDo</td>
          <td style="text-align: left">重置/清空当前 ToDo</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">重置成功提示</td>
          <td style="text-align: left">清空步骤与备注，随后可重新创建</td>
      </tr>
      <tr>
          <td style="text-align: left">GetToDoSummary</td>
          <td style="text-align: left">GetToDoSummary</td>
          <td style="text-align: left">获取当前 ToDo 摘要</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">摘要字符串 / 无 ToDo 提示</td>
          <td style="text-align: left">只读，不修改状态</td>
      </tr>
      <tr>
          <td style="text-align: left">ToDoState</td>
          <td style="text-align: left">ToDoState</td>
          <td style="text-align: left">获取状态短语（看板/状态栏）</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">状态描述字符串</td>
          <td style="text-align: left">动态显示：无 ToDo/已完成/进度统计等</td>
      </tr>
  </tbody>
</table>
<p>调用示例（以 MCP/内部工具调用为例，参数为 JSON 格式）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;tool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CreateToDo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;args&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&#34;task_description&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;为 Adder 核心功能完成验证闭环&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">&#34;steps&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;阅读 README 与规格，整理功能点&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;定义检查点与通过标准&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;生成首批单元测试&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;运行并修复失败用例&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;补齐覆盖率并输出报告&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;tool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CompleteToDoSteps&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;args&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;completed_steps&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">&#34;notes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;初始问题排查完成，准备补充用例&#34;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;tool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UndoToDoSteps&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;args&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;steps&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">&#34;notes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;第二步需要微调检查点&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;tool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ResetToDo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;args&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{}</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;tool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;GetToDoSummary&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;args&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{}</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">&#34;tool&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ToDoState&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;args&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{}</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="外部与嵌入工具">外部与嵌入工具</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--ex-tools</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">name1[,name2&hellip;]</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">逗号分隔的外部工具类名列表（如：SqThink）</td>
      </tr>
      <tr>
          <td style="text-align: left">--no-embed-tools</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">禁用内置的检索/记忆类嵌入工具</td>
      </tr>
  </tbody>
</table>
<h3 id="日志">日志</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--log</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">启用日志</td>
      </tr>
      <tr>
          <td style="text-align: left">--log-file</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">path</td>
          <td style="text-align: left">自动</td>
          <td style="text-align: left">日志输出文件（未指定则使用默认）</td>
      </tr>
      <tr>
          <td style="text-align: left">--msg-file</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">path</td>
          <td style="text-align: left">自动</td>
          <td style="text-align: left">消息日志文件（未指定则使用默认）</td>
      </tr>
  </tbody>
</table>
<h3 id="mcp-server">MCP Server</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--mcp-server</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">启动 MCP Server（含文件工具）</td>
      </tr>
      <tr>
          <td style="text-align: left">--mcp-server-no-file-tools</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">启动 MCP Server（无文件操作工具）</td>
      </tr>
      <tr>
          <td style="text-align: left">--mcp-server-host</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">host</td>
          <td style="text-align: left">127.0.0.1</td>
          <td style="text-align: left">Server 监听地址</td>
      </tr>
      <tr>
          <td style="text-align: left">--mcp-server-port</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">5000</td>
          <td style="text-align: left">Server 端口</td>
      </tr>
  </tbody>
</table>
<h3 id="阶段控制与安全">阶段控制与安全</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--force-stage-index</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">int</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">强制从指定阶段索引开始</td>
      </tr>
      <tr>
          <td style="text-align: left">--skip</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">int（可多次）</td>
          <td style="text-align: left">[]</td>
          <td style="text-align: left">跳过指定阶段索引，可重复提供</td>
      </tr>
      <tr>
          <td style="text-align: left">--unskip</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">int（可多次）</td>
          <td style="text-align: left">[]</td>
          <td style="text-align: left">取消跳过指定阶段索引，可重复提供</td>
      </tr>
      <tr>
          <td style="text-align: left">--no-write / &ndash;nw</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">path1 path2 &hellip;</td>
          <td style="text-align: left">无</td>
          <td style="text-align: left">限制写入目标列表；必须位于 workspace 内且存在</td>
      </tr>
  </tbody>
</table>
<h3 id="版本与检查">版本与检查</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">选项</th>
          <th style="text-align: left">简写</th>
          <th style="text-align: left">取值/类型</th>
          <th style="text-align: left">默认值</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">--check</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left">否</td>
          <td style="text-align: left">检查默认配置、语言目录、模板与 Guide_Doc 是否存在后退出</td>
      </tr>
      <tr>
          <td style="text-align: left">--version</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">flag</td>
          <td style="text-align: left"></td>
          <td style="text-align: left">输出版本并退出</td>
      </tr>
  </tbody>
</table>
<h3 id="示例">示例</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 ucagent.py ./output Adder <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -s <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -hm <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -im enhanced <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --tui <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -l <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --loop-msg <span style="color:#4e9a06">&#39;start verification&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --seed <span style="color:#0000cf;font-weight:bold">12345</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --sys-tips <span style="color:#4e9a06">&#39;按规范完成Adder的验证&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --config config.yaml <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --template-dir ./templates <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --template-overwrite <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --output unity_test <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --override <span style="color:#4e9a06">&#39;conversation_summary.max_tokens=16384,...&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --use-todo-tools <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --ex-tools <span style="color:#4e9a06">&#39;SqThink,AnotherTool&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --no-embed-tools <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --log <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --log-file ./output/ucagent.log <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --msg-file ./output/ucagent.msg <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --mcp-server-no-file-tools <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --mcp-server-host 127.0.0.1 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --mcp-server-port <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --force-stage-index <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --skip <span style="color:#0000cf;font-weight:bold">5</span> --skip <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --unskip <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --nw ./output/Adder ./output/unity_test
</span></span></code></pre></div><ul>
<li>位置参数
<ul>
<li>./output：workspace 工作目录</li>
<li>Adder：dut 子目录名</li>
</ul>
</li>
<li>执行与交互
<ul>
<li>-s：流式输出</li>
<li>-hm：启动即人工可介入</li>
<li>-im enhanced：交互模式为增强（含规划与记忆）</li>
<li>--tui：启用 TUI</li>
<li>--loop/&ndash;loop-msg：启动后立即进入循环并注入首条消息</li>
<li>--seed 12345：固定随机种子</li>
<li>--sys-tips：自定义系统提示</li>
</ul>
</li>
<li>配置与模板
<ul>
<li>--config config.yaml：从<code>config.yaml</code>加载项目配置</li>
<li>--template-dir ./templates：指定模板目录为<code>./templates</code></li>
<li>--template-overwrite：渲染模板时允许覆盖</li>
<li>--output unity_test：输出目录名<code>unity_test</code></li>
<li>--override &lsquo;&hellip;&rsquo;: 覆盖配置键值（点号路径=值，多项用逗号分隔；字符串需内层引号，整体用单引号包裹以保留引号），示例里设置了会话摘要上限、启用裁剪、文档语言为“中文”、模型名为 gpt-4o-mini</li>
<li>-gif/--gen-instruct-file GEMINI.md：在 <code>&lt;workspace&gt;/GEMINI.md</code> 下生成外部协作引导文件</li>
<li>--guid-doc-path ./output/Guide_Doc：自定义 Guide_Doc 目录为<code>./output/Guide_Doc</code></li>
</ul>
</li>
<li>计划与 ToDo
<ul>
<li>--use-todo-tools：启用 ToDo 工具及强制附带 ToDo 信息</li>
</ul>
</li>
<li>外部与嵌入工具
<ul>
<li>--ex-tools &lsquo;SqThink,AnotherTool&rsquo;：启用外部工具<code>SqThink,AnotherTool</code></li>
<li>--no-embed-tools：禁用内置嵌入检索/记忆工具</li>
</ul>
</li>
<li>日志
<ul>
<li>--log：开启日志文件</li>
<li>--log-file ./output/ucagent.log：指定日志输出文件为<code>./output/ucagent.log</code></li>
<li>--msg-file ./output/ucagent.msg：指定消息日志文件为<code>./output/ucagent.msg</code></li>
</ul>
</li>
<li>MCP Server
<ul>
<li>--mcp-server-no-file-tools：启动 MCP（无文件操作工具）</li>
<li>--mcp-server-host：Server 监听地址为<code>127.0.0.1</code></li>
<li>--mcp-server-port：Server 监听端口为<code>5000</code></li>
</ul>
</li>
<li>阶段控制与安全
<ul>
<li>--force-stage-index 2：从阶段索引 2 开始</li>
<li>--skip 5 --skip 7：跳过阶段5和阶段7</li>
<li>--unskip 7：取消跳过阶段7</li>
<li>--nw ./output/Adder ./output/unity_test：限制仅<code>./output/Adder</code>和<code>./output/unity_test</code>路径可写</li>
</ul>
</li>
<li>说明
<ul>
<li>--check 与 --version 会直接退出，未与运行组合使用</li>
<li>--mcp-server 与 --mcp-server-no-file-tools 二选一；此处选了后者带路径参数（如 --template-dir/--guid-doc-path/&ndash;nw 的路径）需实际存在，否则会报错</li>
<li>--override 字符串值务必带引号，并整体用单引号包住以避免 shell 吃掉引号（示例写法已处理）</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5fdb5ae128eebcc1e92c02708d6ec432">6.2.5 - TUI</h1>
    <div class="lead">tui界面的组成与操作说明。</div>
	<h2 id="tui界面与操作">TUI（界面与操作）</h2>
<p>UCAgent 自带基于 urwid 的终端界面（TUI），用于在本地交互式观察任务进度、消息流与控制台输出，并直接输入命令（如进入/退出循环、切换模式、执行调试命令等）。</p>
<h3 id="界面组成">界面组成</h3>
<p><img src="tui-part.png" alt="tui界面组成"></p>
<ul>
<li>
<p>Mission 面板（左侧）</p>
<ul>
<li>阶段列表：显示当前任务的阶段（索引、标题、失败数、耗时）。颜色含义：
<ul>
<li>绿色：已完成阶段</li>
<li>红色：当前进行阶段</li>
<li>黄色：被跳过的阶段（显示“skipped”）</li>
</ul>
</li>
<li>Changed Files：近期修改文件（含修改时间与相对时间，如“3m ago”）。较新的文件以绿色显示。</li>
<li>Tools Call：工具调用状态与计数。忙碌中的工具会以黄色高亮（如 SqThink(2)）。</li>
<li>Deamon Commands：后台运行的 demo 命令列表（带开始时间与已运行时长）。</li>
</ul>
</li>
<li>
<p>Status 面板（右上）</p>
<ul>
<li>显示 API 与代理状态摘要，以及当前面板尺寸参数（便于调节布局时参考）。</li>
</ul>
</li>
<li>
<p>Messages 面板（右上中）</p>
<ul>
<li>实时消息流（模型回复、工具输出、系统提示）。</li>
<li>支持焦点与滚动控制，标题会显示“当前/总计”的消息定位。例如：Messages (123/456)。</li>
</ul>
</li>
<li>
<p>Console（底部）</p>
<ul>
<li>Output：命令与系统输出区域，支持分页浏览。</li>
<li>Input：命令输入行（默认提示符 “(UnityChip) ”）。提供历史、补全、忙碌提示等。</li>
</ul>
</li>
</ul>
<p>提示：界面每秒自动刷新一次（不影响输入）。当消息或输出过长时，会进入分页或手动滚动模式。</p>
<h3 id="操作与快捷键">操作与快捷键</h3>
<ul>
<li>Enter：执行当前输入命令；若输入为空会重复上一次命令；输入 q/Q/exit/quit 退出 TUI。</li>
<li>Esc：
<ul>
<li>若正在浏览 Messages 的历史，退出滚动并返回末尾；</li>
<li>若 Output 正在分页查看，退出分页；</li>
<li>否则聚焦到底部输入框。</li>
</ul>
</li>
<li>Tab：命令补全；再次按 Tab 可分批显示更多可选项。</li>
<li>Shift+Right：清空 Console Output。</li>
<li>Shift+Up / Shift+Down：在 Messages 中向上/向下移动焦点（浏览历史）。</li>
<li>Ctrl+Up / Ctrl+Down：增/减 Console 输出区域高度。</li>
<li>Ctrl+Left / Ctrl+Right：减/增 Mission 面板宽度。</li>
<li>Shift+Up / Shift+Down（另一路径）：调整 Status 面板高度（最小 3，最大 100）。</li>
<li>Up / Down：
<ul>
<li>若 Output 在分页模式，Up/Down 用于翻页；</li>
<li>否则用于命令历史导航（将历史命令放入输入行，可编辑后回车执行）。</li>
</ul>
</li>
</ul>
<p>分页模式提示：当 Output 进入分页浏览时，底部标题会提示 “Up/Down: scroll, Esc: exit”，Esc 退出分页并返回输入状态。</p>
<h3 id="命令与用法">命令与用法</h3>
<ul>
<li>普通命令：直接输入并回车，例如 loop、tui、help 等（由内部调试器处理）。</li>
<li>历史命令：在输入行为空时按 Enter，将重复执行上一条命令。</li>
<li>清屏：输入 clear 并回车，仅清空 Output（不影响消息记录）。</li>
<li>演示/后台命令：命令末尾添加 &amp; 将在后台运行，完成后会在 Output 区域提示结束；当前后台命令可通过 list_demo_cmds 查看。</li>
<li>直接执行系统/危险命令：以 ! 前缀执行（例如 !loop），该模式执行后优先滚动到最新输出。</li>
<li>列出后台命令：list_demo_cmds 显示正在运行的 demo 命令列表与开始时间。</li>
</ul>
<h4 id="消息配置message_config">消息配置（message_config）</h4>
<ul>
<li>作用：在运行中查看/调整消息裁剪策略，控制历史保留与 LLM 输入 token 上限。</li>
<li>命令：
<ul>
<li>message_config 查看当前配置</li>
<li>message_config <key> <value> 设置配置项</li>
</ul>
</li>
<li>可配置项：
<ul>
<li>max_keep_msgs：保留的历史消息条数（影响会话记忆窗口）</li>
<li>max_token：进入模型前的消息裁剪 token 上限（影响开销/截断）</li>
</ul>
</li>
<li>示例：
<ul>
<li>message_config</li>
<li>message_config max_keep_msgs 8</li>
<li>message_config max_token 4096</li>
</ul>
</li>
</ul>
<p>其他说明</p>
<ul>
<li>自动补全：支持命令名与部分参数的补全；候选项过多时分批显示，可多次按 Tab 查看剩余项。</li>
<li>忙碌提示：命令执行期间，输入框标题会轮转显示 (wait.), (wait..), (wait&hellip;)，表示正在处理。</li>
<li>消息焦点：当未手动滚动时，消息焦点自动跟随最新消息；进入手动滚动后，会保持当前位置，直至按 Esc 或滚动至末尾。</li>
<li>错误容错：若某些 UI 操作异常（如终端不支持某些控制序列），TUI 会尽量回退到安全状态继续运行。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-496947e48f69f9f9e929fe92771d84e0">6.2.6 - FAQ</h1>
    <div class="lead">常见问题与解答。</div>
	<h2 id="faq">FAQ</h2>
<ul>
<li>模型切换：在 <code>config.yaml</code> 改 <code>openai.model_name</code></li>
<li>验证过程中出现错误怎么办：使用 <code>Ctrl+C</code> 进入交互模式，通过 <code>status</code> 查看当前状态，使用 <code>help</code> 获取调试命令。</li>
<li>Check 失败：先 <code>ReadTextFile</code> 阅读 reference_files；再按返回信息修复，循环 RunTestCases → Check</li>
<li>自定义阶段：修改 <code>vagent/lang/zh/config/default.yaml</code> 的 <code>stage</code>；或用 <code>--override</code> 临时覆盖</li>
<li>添加工具：<code>vagent/tools/</code> 下新建类，继承 <code>UCTool</code>，运行时 <code>--ex-tools YourTool</code></li>
<li>MCP 连接失败：检查端口/防火墙，改 <code>--mcp-server-port</code>；无嵌入可加 <code>--no-embed-tools</code></li>
<li>只读保护：通过 <code>--no-write/--nw</code> 指定路径限制写入（必须位于 workspace 内）</li>
</ul>
<h3 id="为什么快速启动找不到configyaml定制流程时找不到configyaml">为什么快速启动找不到config.yaml/定制流程时找不到config.yaml?</h3>
<ul>
<li>使用pip 安装后并没有<code>config.yaml</code>那个文件，所以在快速启动的<a href="/mlvp/docs/ucagent/introduce/#%e5%91%bd%e4%bb%a4">启动 MCP Server</a>没有加<code>--config config.yaml</code>这个选项。</li>
<li>可以通过在工作目录添加<code>config.yaml</code>文件并且加上<code>--config config.yaml</code>参数来启动；也可以使用克隆仓库来使用UCAgent的方式来解决。</li>
</ul>
<h3 id="运行中如何调整消息窗口与-token-上限">运行中如何调整消息窗口与 token 上限？</h3>
<ul>
<li>在 TUI 输入：<code>message_config</code> 查看当前配置；</li>
<li>设置：<code>message_config max_keep_msgs 8</code> 或 <code>message_config max_token 4096</code>；</li>
<li>作用范围：影响会话历史裁剪与送入 LLM 的最大 token 上限（通过 Summarization/Trim 节点生效）。</li>
</ul>
<h3 id="文档中的-ck-bug-要改吗">文档中的 “CK bug” 要改吗？</h3>
<ul>
<li>是。术语统一为 “TC bug”。同时确保 bug 文档里的 <code>&lt;TC-*&gt;</code> 能匹配失败用例（文件/类/用例名）。</li>
</ul>
<h3 id="为什么找不到-writetextfile-工具">为什么找不到 WriteTextFile 工具？</h3>
<ul>
<li>该工具已移除。请改用 <code>EditTextFile</code>（支持 overwrite/append/replace 三种模式）或其他文件工具（Copy/Move/Delete 等）。</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-123be64371eca729c53f6175259c146a">6.3 - 工作流</h1>
    <div class="lead">整体的工作流说明。</div>
	<p>整体采用“按阶段渐进推进”的方式，每个阶段都有明确目标、产出与通过标准；完成后用工具 Check 验证并用 Complete 进入下一阶段。若阶段包含子阶段，需按顺序 逐一完成子阶段并各自通过 Check。</p>
<ul>
<li>顶层阶段总数：11（见 <code>vagent/lang/zh/config/default.yaml</code>）</li>
<li>推进原则：未通过的阶段不可跳转；可用工具 CurrentTips 获取当前阶段详细指导；需要回补时可用 GotoStage 回到指定阶段；命令行也可用 &ndash;skip/--unskip 控制阶段索引。</li>
</ul>
<h2 id="整体流程概览11-个阶段">整体流程概览（11 个阶段）</h2>
<p>目前的流程包含：</p>
<ol>
<li>需求分析与验证规划 → 2) {DUT} 功能理解 → 3) 功能规格分析与测试点定义 → 4) 测试平台基础架构设计 → 5) 功能覆盖率模型实现 → 6) 基础 API 实现 → 7) 基础 API 功能测试 → 8) 测试框架脚手架 → 9) 全面验证执行与缺陷分析 → 10) 代码行覆盖率分析与提升（默认跳过，可启用）→ 11) 验证审查与总结</li>
</ol>
<p>以实际的工作流为准，下图仅供参考。
<img src="workflow.png" alt="工作流图"></p>
<p>说明：以下路径中的 <OUT> 默认为工作目录下的输出目录名（默认 unity_test）。例如文档输出到 <code>&lt;workspace&gt;/unity_test/</code>。</p>
<hr>
<p>阶段 1：需求分析与验证规划</p>
<ul>
<li>目标：理解任务、明确验证范围与策略。</li>
<li>怎么做：
<ul>
<li>阅读 <code>{DUT}/README.md</code>，梳理“需要测哪些功能/输入输出/边界与风险”。</li>
<li>形成可执行的验证计划与目标清单。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/{DUT}_verification_needs_and_plan.md</code>（中文撰写）。</li>
<li>通过标准：文档存在、结构规范（自动检查 markdown_file_check）。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerMarkdownFileFormat
<ul>
<li>作用：校验 Markdown 文件存在与格式，禁止把换行写成字面量“\n”。</li>
<li>参数：
<ul>
<li>markdown_file_list (str | List[str]): 待检查的 MD 文件路径或路径列表。示例：<code>{OUT}/{DUT}_verification_needs_and_plan.md</code></li>
<li>no_line_break (bool): 是否禁止把换行写成字面量 &ldquo;\n&rdquo;；true 表示禁止。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 2：{DUT} 功能理解</p>
<ul>
<li>目标：掌握 DUT 的接口与基本信息，明确是组合/时序电路。</li>
<li>怎么做：
<ul>
<li>阅读 <code>{DUT}/README.md</code> 与 <code>{DUT}/__init__.py</code>。</li>
<li>分析 IO 端口、时钟/复位需求与功能范围。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/{DUT}_basic_info.md</code>。</li>
<li>通过标准：文档存在、格式规范（markdown_file_check）。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerMarkdownFileFormat
<ul>
<li>作用：校验 Markdown 文件存在与格式，禁止把换行写成字面量“\n”。</li>
<li>参数：
<ul>
<li>markdown_file_list (str | List[str]): 待检查的 MD 文件路径或路径列表。示例：<code>{OUT}/{DUT}_basic_info.md</code></li>
<li>no_line_break (bool): 是否禁止把换行写成字面量 &ldquo;\n&rdquo;；true 表示禁止。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 3：功能规格分析与测试点定义（含子阶段 FG/FC/CK）</p>
<ul>
<li>目标：把功能分组（FG）、功能点（FC）和检测点（CK）结构化，作为后续自动化的依据。</li>
<li>怎么做：
<ul>
<li>阅读 <code>{DUT}/*.md</code> 与已产出文档，建立 <code>{DUT}_functions_and_checks.md</code> 的 FG/FC/CK 结构。</li>
<li>规范标签：&lt;FG-组名&gt;、&lt;FC-功能名&gt;、&lt;CK-检测名&gt;，每个功能点至少 1 个检测点。</li>
</ul>
</li>
<li>子阶段：
<ul>
<li>3.1 功能分组与层次（FG）：检查器 UnityChipCheckerLabelStructure(FG)</li>
<li>3.2 功能点定义（FC）：检查器 UnityChipCheckerLabelStructure(FC)</li>
<li>3.3 检测点设计（CK）：检查器 UnityChipCheckerLabelStructure(CK)</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/{DUT}_functions_and_checks.md</code>。</li>
<li>通过标准：三类标签结构均通过对应检查。</li>
<li>对应检查器（默认配置）：
<ul>
<li>3.1 UnityChipCheckerLabelStructure
<ul>
<li>作用：解析 <code>{DUT}_functions_and_checks.md</code> 中的标签结构并校验层级与数量（FG）。</li>
<li>参数：
<ul>
<li>doc_file (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>leaf_node (&ldquo;FG&rdquo; | &ldquo;FC&rdquo; | &ldquo;CK&rdquo;): 需要校验的叶子类型。示例：<code>&quot;FG&quot;</code></li>
<li>min_count (int, 默认 1): 该叶子类型的最小数量阈值。</li>
<li>must_have_prefix (str, 默认 &ldquo;FG-API&rdquo;): FG 名称要求的前缀，用于规范化分组命名。</li>
</ul>
</li>
</ul>
</li>
<li>3.2 UnityChipCheckerLabelStructure
<ul>
<li>作用：解析文档并校验功能点定义（FC）。</li>
<li>参数：
<ul>
<li>doc_file (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>leaf_node (&ldquo;FG&rdquo; | &ldquo;FC&rdquo; | &ldquo;CK&rdquo;): 需要校验的叶子类型。示例：<code>&quot;FC&quot;</code></li>
<li>min_count (int, 默认 1): 该叶子类型的最小数量阈值。</li>
<li>must_have_prefix (str, 默认 &ldquo;FG-API&rdquo;): 所属 FG 的前缀规范，用于一致性检查。</li>
</ul>
</li>
</ul>
</li>
<li>3.3 UnityChipCheckerLabelStructure
<ul>
<li>作用：解析文档并校验检测点设计（CK），并缓存 CK 列表用于后续分批实现。</li>
<li>参数：
<ul>
<li>doc_file (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>leaf_node (&ldquo;FG&rdquo; | &ldquo;FC&rdquo; | &ldquo;CK&rdquo;): 需要校验的叶子类型。示例：<code>&quot;CK&quot;</code></li>
<li>data_key (str): 共享数据键名，用于缓存 CK 列表（供后续分批实现使用）。示例：<code>&quot;COVER_GROUP_DOC_CK_LIST&quot;</code></li>
<li>min_count (int, 默认 1): 该叶子类型的最小数量阈值。</li>
<li>must_have_prefix (str, 默认 &ldquo;FG-API&rdquo;): 所属 FG 的前缀规范，用于一致性检查。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 4：测试平台基础架构设计（fixture/API 框架）</p>
<ul>
<li>目标：提供统一的 DUT 创建与测试生命周期管理能力。</li>
<li>怎么做：
<ul>
<li>在 <code>&lt;OUT&gt;/tests/{DUT}_api.py</code> 实现 create_dut()；时序电路配置时钟（InitClock），组合电路无需时钟。</li>
<li>实现 pytest fixture <code>dut</code>，负责初始化/清理与可选的波形/行覆盖率开关。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/tests/{DUT}_api.py</code>（含注释与文档字符串）。</li>
<li>通过标准：DUT 创建与 fixture 检查通过（UnityChipCheckerDutCreation / UnityChipCheckerDutFixture）。</li>
<li>子阶段检查器：
<ul>
<li>DUT 创建：UnityChipCheckerDutCreation
<ul>
<li>作用：校验 <code>{DUT}_api.py</code> 中的 create_dut(request) 是否实现规范（签名、时钟/复位、覆盖率路径等约定）。</li>
<li>参数：
<ul>
<li>target_file (str): DUT API 与 fixture 所在文件路径。示例：<code>{OUT}/tests/{DUT}_api.py</code></li>
</ul>
</li>
</ul>
</li>
<li>dut fixture：UnityChipCheckerDutFixture
<ul>
<li>作用：校验 pytest fixture <code>dut</code> 的生命周期管理、yield/清理，以及覆盖率收集调用是否到位。</li>
<li>参数：
<ul>
<li>target_file (str): 包含 <code>dut</code> fixture 的文件路径。示例：<code>{OUT}/tests/{DUT}_api.py</code></li>
</ul>
</li>
</ul>
</li>
<li>env fixture：UnityChipCheckerEnvFixture
<ul>
<li>作用：校验 <code>env*</code> 系列 fixture 的存在、数量与 Bundle 封装是否符合要求。</li>
<li>参数：
<ul>
<li>target_file (str): 包含 <code>env*</code> 系列 fixture 的文件路径。示例：<code>{OUT}/tests/{DUT}_api.py</code></li>
<li>min_env (int, 默认 1): 至少需要存在的 <code>env*</code> fixture 数量。示例：<code>1</code></li>
<li>force_bundle (bool, 当前未使用): 是否强制要求 Bundle 封装。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>覆盖率路径规范（重要）：</p>
<ul>
<li>在 create_dut(request) 中，必须通过 <code>get_coverage_data_path(request, new_path=True)</code> 获取新的行覆盖率文件路径，并传入 <code>dut.SetCoverage(...)</code>。</li>
<li>在 <code>dut</code> fixture 的清理阶段，必须通过 <code>get_coverage_data_path(request, new_path=False)</code> 获取已有路径，并调用 <code>set_line_coverage(request, &lt;path&gt;, ignore=...)</code> 写入统计。</li>
<li>若缺失上述调用，检查器会直接报错，并给出修复提示（含 <code>tips_of_get_coverage_data_path</code> 示例）。</li>
</ul>
<p>阶段 5：功能覆盖率模型实现</p>
<ul>
<li>目标：将 FG/FC/CK 转为可统计的覆盖结构，支撑进度度量与回归。</li>
<li>怎么做：
<ul>
<li>在 <code>&lt;OUT&gt;/tests/{DUT}_function_coverage_def.py</code> 实现 <code>get_coverage_groups(dut)</code>。</li>
<li>为每个 FG 建立 CovGroup；为 FC/CK 建 watch_point 与检查函数（优先用 lambda，必要时普通函数）。</li>
</ul>
</li>
<li>子阶段：
<ul>
<li>5.1 覆盖组创建（FG）</li>
<li>5.2 覆盖点与检查实现（FC/CK），支持“分批实现”提示（COMPLETED_POINTS/TOTAL_POINTS）。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/tests/{DUT}_function_coverage_def.py</code>。</li>
<li>通过标准：CoverageGroup 检查（FG/FC/CK）与批量实现检查通过。</li>
<li>子阶段检查器：
<ul>
<li>5.1 UnityChipCheckerCoverageGroup
<ul>
<li>作用：比对覆盖组定义与文档 FG 一致性。</li>
<li>参数：
<ul>
<li>test_dir (str): 测试目录根路径。示例：<code>{OUT}/tests</code></li>
<li>cov_file (str): 覆盖率模型定义文件路径。示例：<code>{OUT}/tests/{DUT}_function_coverage_def.py</code></li>
<li>doc_file (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>check_types (str | List[str]): 检查的类型集合。示例：<code>&quot;FG&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li>5.2 UnityChipCheckerCoverageGroup
<ul>
<li>作用：比对覆盖点/检查点实现与文档 FC/CK 一致性。</li>
<li>参数：
<ul>
<li>test_dir (str): 测试目录根路径。示例同上</li>
<li>cov_file (str): 覆盖率模型定义文件路径。示例同上</li>
<li>doc_file (str): 功能/检查点文档路径。示例同上</li>
<li>check_types (List[str]): 检查类型集合。示例：<code>[&quot;FC&quot;, &quot;CK&quot;]</code></li>
</ul>
</li>
</ul>
</li>
<li>5.2（分批）UnityChipCheckerCoverageGroupBatchImplementation
<ul>
<li>作用：按 CK 分批推进实现与对齐检查，维护进度（TOTAL/COMPLETED）。</li>
<li>参数：
<ul>
<li>test_dir (str): 测试目录根路径。</li>
<li>cov_file (str): 覆盖率模型定义文件路径。</li>
<li>doc_file (str): 功能/检查点文档路径。</li>
<li>batch_size (int, 默认 20): 每批实现与校验的 CK 数量上限。示例：<code>20</code></li>
<li>data_key (str): 共享数据键名，用于读取 CK 列表。示例：<code>&quot;COVER_GROUP_DOC_CK_LIST&quot;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 6：基础 API 实现</p>
<ul>
<li>目标：用 <code>api_{DUT}_*</code> 前缀提供可复用的操作封装，隐藏底层信号细节。</li>
<li>怎么做：
<ul>
<li>在 <code>&lt;OUT&gt;/tests/{DUT}_api.py</code> 实现至少 1 个基础 API；建议区分“底层功能 API”与“任务功能 API”。</li>
<li>补充详细 docstring：功能、参数、返回值、异常。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/tests/{DUT}_api.py</code>。</li>
<li>通过标准：UnityChipCheckerDutApi 通过（前缀必须为 <code>api_{DUT}_</code>）。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerDutApi
<ul>
<li>作用：扫描/校验 <code>api_{DUT}_*</code> 函数的数量、命名、签名与 docstring 完整度。</li>
<li>参数：
<ul>
<li>api*prefix (str): API 前缀匹配表达式。建议：<code>&quot;api*{DUT}\_&quot;</code></li>
<li>target_file (str): API 定义所在文件。示例：<code>{OUT}/tests/{DUT}_api.py</code></li>
<li>min_apis (int, 默认 1): 至少需要的 API 数量。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 7：基础 API 功能正确性测试</p>
<ul>
<li>目标：为每个已实现 API 编写至少 1 个基础功能用例，并标注覆盖率。</li>
<li>怎么做：
<ul>
<li>在 <code>&lt;OUT&gt;/tests/test_{DUT}_api_*.py</code> 新建测试；导入 <code>from {DUT}_api import *</code>。</li>
<li>每个测试函数的第一行：<code>dut.fc_cover['FG-API'].mark_function('FC-API-NAME', test_func, ['CK-XXX'])</code>。</li>
<li>设计典型/边界/异常数据，断言预期输出。</li>
<li>用工具 RunTestCases 执行与回归。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/tests/test_{DUT}_api_*.py</code> 与缺陷记录（若发现 bug）。</li>
<li>通过标准：UnityChipCheckerDutApiTest 通过（覆盖、用例质量、文档记录齐备）。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerDutApiTest
<ul>
<li>作用：运行 pytest 并检查每个 API 至少 1 个基础功能用例且正确覆盖标记；核对缺陷记录与文档一致。</li>
<li>参数：
<ul>
<li>api*prefix (str): API 前缀匹配表达式。建议：<code>&quot;api*{DUT}\_&quot;</code></li>
<li>target_file_api (str): API 文件路径。示例：<code>{OUT}/tests/{DUT}_api.py</code></li>
<li>target*file_tests (str): 测试文件 Glob。示例：<code>{OUT}/tests/test*{DUT}\_api\*.py</code></li>
<li>doc_func_check (str): 功能/检查点文档。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>doc_bug_analysis (str): 缺陷分析文档。示例：<code>{OUT}/{DUT}_bug_analysis.md</code></li>
<li>min_tests (int, 默认 1): 单 API 最少测试用例数。</li>
<li>timeout (int, 默认 15): 单次测试运行超时（秒）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 8：测试框架脚手架构建</p>
<ul>
<li>目标：为尚未实现的功能点批量生成“占位”测试模板，确保覆盖版图完整。</li>
<li>怎么做：
<ul>
<li>依据 <code>{DUT}_functions_and_checks.md</code>，在 <code>&lt;OUT&gt;/tests/</code> 创建 <code>test_*.py</code>，文件与用例命名语义化。</li>
<li>每个函数首行标注覆盖率 mark；补充 TODO 注释说明要测什么；末尾添加 <code>assert False, 'Not implemented'</code> 防误通过。</li>
</ul>
</li>
<li>产出：批量测试模板；覆盖率进度指标（COVERED_CKS/TOTAL_CKS）。</li>
<li>通过标准：UnityChipCheckerTestTemplate 通过（结构/标记/说明完整）。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerTestTemplate
<ul>
<li>作用：检查模板文件/用例结构、覆盖标记、TODO 注释与防误通过断言；统计覆盖进度。</li>
<li>参数：
<ul>
<li>doc_func_check (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>test_dir (str): 测试目录根路径。示例：<code>{OUT}/tests</code></li>
<li>ignore*ck_prefix (str): 统计覆盖时忽略的 CK 前缀（通常为基础 API 的用例）。示例：<code>&quot;test_api*{DUT}\_&quot;</code></li>
<li>data_key (str): 共享数据键名，用于生成/读取模板实现进度。示例：<code>&quot;TEST_TEMPLATE_IMP_REPORT&quot;</code></li>
<li>batch_size (int, 默认 20): 每批模板检查数量。</li>
<li>min_tests (int, 默认 1): 最少要求的模板测试数。</li>
<li>timeout (int, 默认 15): 测试运行超时（秒）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 9：全面验证执行与缺陷分析</p>
<ul>
<li>目标：将模板填充为真实测试，系统发现并分析 DUT bug。</li>
<li>怎么做：
<ul>
<li>在 <code>test_*.py</code> 填充逻辑，优先通过 API 调用，不直接操纵底层信号。</li>
<li>设计充分数据并断言；用 RunTestCases 运行；对 Fail 进行基于源码的缺陷定位与记录。</li>
</ul>
</li>
<li>子阶段：
<ul>
<li>9.1 分批测试用例实现与对应缺陷分析（COMPLETED_CASES/TOTAL_CASES）。</li>
</ul>
</li>
<li>产出：成体系的测试集与 <code>/{DUT}_bug_analysis.md</code>。</li>
<li>通过标准：UnityChipCheckerTestCase（质量/覆盖/缺陷分析）通过。</li>
<li>检查器：
<ul>
<li>父阶段：UnityChipCheckerTestCase
<ul>
<li>作用：运行整体测试并对照功能/缺陷文档检查质量、覆盖与记录一致性。</li>
<li>参数：
<ul>
<li>doc_func_check (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>doc_bug_analysis (str): 缺陷分析文档路径。示例：<code>{OUT}/{DUT}_bug_analysis.md</code></li>
<li>test_dir (str): 测试目录根路径。示例：<code>{OUT}/tests</code></li>
<li>min_tests (int, 默认 1): 最少要求的测试用例数量。</li>
<li>timeout (int, 默认 15): 测试运行超时（秒）。</li>
</ul>
</li>
</ul>
</li>
<li>子阶段（分批实现）：UnityChipCheckerBatchTestsImplementation
<ul>
<li>作用：分批将模板落地为真实用例并回归，维护实现进度与报告。</li>
<li>参数：
<ul>
<li>doc_func_check (str): 功能/检查点文档路径。</li>
<li>doc_bug_analysis (str): 缺陷分析文档路径。</li>
<li>test_dir (str): 测试目录根路径。</li>
<li>ignore*ck_prefix (str): 统计覆盖时忽略的 CK 前缀。示例：<code>&quot;test_api*{DUT}\_&quot;</code></li>
<li>batch_size (int, 默认 10): 每批转化并执行的用例数量。</li>
<li>data_key (str): 共享数据键名（必填），用于保存分批实现进度。示例：<code>&quot;TEST_TEMPLATE_IMP_REPORT&quot;</code></li>
<li>pre_report_file (str): 历史进度报告路径。示例：<code>{OUT}/{DUT}/.TEST_TEMPLATE_IMP_REPORT.json</code></li>
<li>timeout (int, 默认 15): 测试运行超时（秒）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>TC bug 标注规范与一致性（与文档/报告强关联）：</p>
<ul>
<li>术语：统一使用 “TC bug”（不再使用 “CK bug”）。</li>
<li>标注结构：<code>&lt;FG-*&gt;/&lt;FC-*&gt;/&lt;CK-*&gt;/&lt;BG-NAME-XX&gt;/&lt;TC-test_file.py::[ClassName]::test_case&gt;</code>；其中 BG 的置信度 XX 为 0–100 的整数。</li>
<li>失败用例与文档关系：
<ul>
<li>文档中出现的 &lt;TC-*&gt; 必须能与测试报告中的失败用例一一对应（文件名/类名/用例名匹配）。</li>
<li>失败的测试用例必须标注其关联检查点（CK），否则会被判定为“未标记”。</li>
<li>若存在失败用例未在 bug 文档中记录，将被提示为“未文档化的失败用例”。</li>
</ul>
</li>
</ul>
<p>阶段 10：代码行覆盖率分析与提升（默认跳过，可启用）</p>
<ul>
<li>目标：回顾未覆盖代码行，定向补齐。</li>
<li>怎么做：
<ul>
<li>运行 Check 获取行覆盖率；若未达标，围绕未覆盖行增补测试并回归；循环直至满足阈值。</li>
</ul>
</li>
<li>产出：行覆盖率报告与补充测试。</li>
<li>通过标准：UnityChipCheckerTestCaseWithLineCoverage 达标（默认阈值 0.9，可在配置中调整）。</li>
<li>说明：该阶段在配置中标记 skip=true，可用 <code>--unskip</code> 指定索引启用。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerTestCaseWithLineCoverage
<ul>
<li>作用：在 TestCase 基础上统计行覆盖率并对比阈值。</li>
<li>参数：
<ul>
<li>doc_func_check (str): 功能/检查点文档路径。示例：<code>{OUT}/{DUT}_functions_and_checks.md</code></li>
<li>doc_bug_analysis (str): 缺陷分析文档路径。示例：<code>{OUT}/{DUT}_bug_analysis.md</code></li>
<li>test_dir (str): 测试目录根路径。示例：<code>{OUT}/tests</code></li>
<li>cfg (dict | Config): 必填，用于推导默认路径以及环境配置。</li>
<li>min_line_coverage (float, 默认按配置，未配置则 0.8): 最低行覆盖率阈值。</li>
<li>coverage_json (str, 可选): 行覆盖率 JSON 路径。默认：<code>uc_test_report/line_dat/code_coverage.json</code></li>
<li>coverage_analysis (str, 可选): 行覆盖率分析 MD 输出。默认：<code>unity_test/{DUT}_line_coverage_analysis.md</code></li>
<li>coverage_ignore (str, 可选): 忽略文件清单。默认：<code>unity_test/tests/{DUT}.ignore</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>阶段 11：验证审查与总结</p>
<ul>
<li>目标：沉淀成果、复盘流程、给出改进建议。</li>
<li>怎么做：
<ul>
<li>完善 <code>/{DUT}_bug_analysis.md</code> 的缺陷条目（基于源码分析）。</li>
<li>汇总并撰写 <code>/{DUT}_test_summary.md</code>，回看规划是否达成；必要时用 GotoStage 回补。</li>
</ul>
</li>
<li>产出：<code>&lt;OUT&gt;/{DUT}_test_summary.md</code> 与最终结论。</li>
<li>通过标准：UnityChipCheckerTestCase 复核通过。</li>
<li>检查器：
<ul>
<li>UnityChipCheckerTestCase
<ul>
<li>作用：复核整体测试结果与文档一致性，形成最终结论。</li>
<li>参数：doc_func_check: &ldquo;{OUT}/{DUT}_functions_and_checks.md&rdquo;；doc_bug_analysis: &ldquo;{OUT}/{DUT}_bug_analysis.md&rdquo;；test_dir: &ldquo;{OUT}/tests&rdquo;。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>提示与最佳实践</p>
<ul>
<li>随时用工具：Detail/Status 查看 Mission 进度与当前阶段；CurrentTips 获取步骤级指导；Check/Complete 推进阶段。</li>
<li>TUI 左侧 Mission 会显示阶段序号、跳过状态与失败计数；可结合命令行 <code>--skip/--unskip/--force-stage-index</code> 控制推进。</li>
</ul>
<h2 id="定制工作流增删阶段子阶段">定制工作流（增删阶段/子阶段）</h2>
<h3 id="原理说明">原理说明</h3>
<ul>
<li>工作流定义在语言配置 <code>vagent/lang/zh/config/default.yaml</code> 的顶层 <code>stage:</code> 列表。</li>
<li>配置加载顺序：setting.yaml → ~/.ucagent/setting.yaml → 语言默认（含 stage）→ 项目根 <code>config.yaml</code> → CLI <code>--override</code>。</li>
<li>注意：列表类型（如 stage 列表）在合并时是“整体覆盖”，不是元素级合并；因此要“增删改”阶段，建议把默认的 stage 列表复制到你的项目 <code>config.yaml</code>，在此基础上编辑。</li>
<li>临时不执行某阶段：优先使用 CLI <code>--skip &lt;index&gt;</code> 或在运行中用工具 Skip/Goto；持久跳过可在你的 <code>config.yaml</code> 中把该阶段条目的 <code>skip: true</code> 写上（同样需要提供完整的 stage 列表）。</li>
</ul>
<h3 id="增加阶段">增加阶段</h3>
<ul>
<li>需求：在“全面验证执行”之后新增一个“静态检查与 Lint 报告”阶段，要求生成 <code>&lt;OUT&gt;/{DUT}_lint_report.md</code> 并做格式检查。</li>
<li>做法：在项目根 <code>config.yaml</code> 中提供完整的 <code>stage:</code> 列表，并在合适位置插入如下条目（片段示例，仅展示新增项，实际需要放入你的完整 stage 列表里）。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">stage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ...前面的既有阶段...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">static_lint_and_style_check</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;静态分析与代码风格检查报告&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">task</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;目标：完成 DUT 的静态检查/Lint，并输出报告&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;第1步：运行 lint 工具（按项目需要）&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;第2步：将结论整理为 &lt;OUT&gt;/{DUT}_lint_report.md（中文）&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;第3步：用 Check 校验报告是否存在且格式规范&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">checker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">markdown_file_check</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">clss</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;UnityChipCheckerMarkdownFileFormat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">markdown_file_list</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_lint_report.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># MD 文件路径或列表</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">no_line_break</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 禁止字面量 &#34;\n&#34; 作为换行</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">reference_files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">output_files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;{OUT}/{DUT}_lint_report.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">skip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ...后续既有阶段...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="减少子阶段">减少子阶段</h3>
<ul>
<li>场景：在“功能规格分析与测试点定义”中，临时不执行“功能点定义（FC）”子阶段。</li>
<li>推荐做法：运行时使用 CLI <code>--skip</code> 跳过该索引；若需长期配置，复制默认 <code>stage:</code> 列表到你的 <code>config.yaml</code>，在父阶段 <code>functional_specification_analysis</code> 的 <code>stage:</code> 子列表里移除对应子阶段条目，或为该子阶段加 <code>skip: true</code>。</li>
</ul>
<p>子阶段移除（片段示例，仅展示父阶段结构与其子阶段列表）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">stage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">functional_specification_analysis</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;功能规格分析与测试点定义&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">task</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;目标：将芯片功能拆解成可测试的小块，为后续测试做准备&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># ...省略父阶段任务...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">stage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">functional_grouping</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 保留 FG 子阶段</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># ...原有配置...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># - name: function_point_definition  # 原来的 FC 子阶段（此行及其内容整体删除，或在其中加 skip: true）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">check_point_design</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 保留 CK 子阶段</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># ...原有配置...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ...其他字段...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>小贴士</p>
<ul>
<li>仅需临时跳过：用 <code>--skip</code>/<code>--unskip</code> 最快，无需改配置文件。</li>
<li>需要永久增删：复制默认 <code>stage:</code> 列表到项目 <code>config.yaml</code>，编辑后提交到仓库；注意列表是整体覆盖，别只贴新增/删减的片段。</li>
<li>新增阶段的检查器可复用现有类（如 Markdown/Fixture/API/Coverage/TestCase 等），也可以扩展自定义检查器（放在 <code>vagent/checkers/</code> 并以可导入路径填写到 <code>clss</code>）。</li>
</ul>
<h2 id="定制校验器checker">定制校验器（checker）</h2>
<p>原理说明</p>
<ul>
<li>每个（子）阶段下的 <code>checker:</code> 是一个列表；执行 <code>Check</code> 时会依次运行该列表里的所有检查器。</li>
<li>配置字段：
<ul>
<li><code>name</code>: 该检查器在阶段内的标识（便于阅读/日志）</li>
<li><code>clss</code>: 检查器类名；短名默认从 <code>vagent.checkers</code> 命名空间导入，也可写完整模块路径（如 <code>mypkg.mychk.MyChecker</code>）</li>
<li><code>args</code>: 传给检查器构造函数的参数，支持模板变量（如 <code>{OUT}</code>、<code>{DUT}</code>）</li>
<li><code>extra_args</code>: 可选，部分检查器支持自定义提示/策略（如 <code>fail_msg</code>、<code>batch_size</code>、<code>pre_report_file</code> 等）</li>
</ul>
</li>
<li>解析与实例化：<code>vagent/stage/vstage.py</code> 会读取 <code>checker:</code>，按 <code>clss/args</code> 生成实例；运行期由 <code>ToolStdCheck/Check</code> 调用其 <code>do_check()</code>。</li>
<li>合并语义：配置合并时列表是“整体替换”，要在项目 <code>config.yaml</code> 修改某个阶段的 <code>checker:</code>，建议复制该阶段条目并完整替换其 <code>checker:</code> 列表。</li>
</ul>
<h3 id="增加-checker">增加 checker</h3>
<p>在“功能规格分析与测试点定义”父阶段，新增“文档格式检查”，确保 <code>{OUT}/{DUT}_functions_and_checks.md</code> 没有把换行写成字面量 <code>\n</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 片段示例：需要放入你的完整 stage 列表对应阶段中</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">functional_specification_analysis</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;功能规格分析与测试点定义&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ...existing fields...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">output_files</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">checker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">functions_and_checks_doc_format</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">clss</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;UnityChipCheckerMarkdownFileFormat&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">markdown_file_list</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 功能/检查点文档</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">no_line_break</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 禁止字面量 &#34;\n&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">stage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># ...子阶段 FG/FC/CK 原有配置...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>（可扩展）自定义检查器（最小实现，放在 <code>vagent/checkers/unity_test.py</code>）</p>
<p>很多场景下“增加的 checker”并非复用已有检查器，而是需要自己实现一个新的检查器。最小实现步骤：</p>
<ol>
<li>新建类并继承基类 <code>vagent.checkers.base.Checker</code></li>
<li>在 <code>__init__</code> 里声明你需要的参数（与 YAML args 对应）</li>
<li>实现 <code>do_check(self, timeout=0, **kw) -&gt; tuple[bool, object]</code>，返回 (是否通过, 结构化消息)</li>
<li>如需读/写工作区文件，使用 <code>self.get_path(rel)</code> 获取绝对路径；如需跨阶段共享数据，使用 <code>self.smanager_set_value/get_value</code></li>
<li>若想用短名 <code>clss</code> 引用，请在 <code>vagent/checkers/__init__.py</code> 导出该类（或在 <code>clss</code> 写完整模块路径）</li>
</ol>
<p>最小代码骨架（示例）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 文件：vagent/checkers/unity_test.py</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">typing</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Tuple</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">os</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">vagent.checkers.base</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Checker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UnityChipCheckerMyCustomCheck</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Checker</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">target_file</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threshold</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kw</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">target_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">target_file</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">threshold</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">threshold</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">do_check</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kw</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">Tuple</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">object</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;&#34;&#34;检查 target_file 是否存在并做简单规则校验。&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">real</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_path</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">target_file</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">real</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;file &#39;</span><span style="color:#4e9a06">{</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">target_file</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#39; not found&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># TODO: 这里写你的具体校验逻辑，例如统计/解析/比对等</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;MyCustomCheck passed&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在阶段 YAML 中引用（与“增加一个 checker”一致）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">checker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_custom_check</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">clss</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;UnityChipCheckerMyCustomCheck&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 若未在 __init__.py 导出，写完整路径 mypkg.mychk.UnityChipCheckerMyCustomCheck</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">target_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_something.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">threshold</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">extra_args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">fail_msg</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;未满足自定义阈值，请完善实现或调低阈值。&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 可选：通过 extra_args 自定义默认失败提示</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>进阶提示（按需）：</p>
<ul>
<li>长时任务/外部进程：在运行子进程时调用 <code>self.set_check_process(p, timeout)</code>，即可用工具 <code>KillCheck/StdCheck</code> 管理与查看进程输出。</li>
<li>模板渲染：实现 <code>get_template_data()</code> 可将进度/统计渲染到阶段标题与任务文案中。</li>
<li>初始化钩子：实现 <code>on_init()</code> 以在阶段开始时加载缓存/准备批任务（与 Batch 系列 checker 一致）。</li>
</ul>
<h3 id="删除-checker">删除 checker</h3>
<p>如临时不要“第 2 阶段 基本信息文档格式检查”，将该阶段的 <code>checker:</code> 置空或移除该项：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dut_function_understanding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{DUT}功能理解&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ...existing fields...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">checker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 删除原本的 markdown_file_check</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="修改-checker">修改 checker</h3>
<p>把“行覆盖率检查”的阈值从 0.9 调整到 0.8，并自定义失败提示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">line_coverage_analysis_and_improvement</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;代码行覆盖率分析与提升{COVERAGE_COMPLETE}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ...existing fields...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">checker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">line_coverage_check</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">clss</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;UnityChipCheckerTestCaseWithLineCoverage&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">doc_func_check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">doc_bug_analysis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_bug_analysis.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">min_line_coverage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0.8</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 调低阈值</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">extra_args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">fail_msg</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;未达到 80% 的行覆盖率，请补充针对未覆盖行的测试。&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可选：自定义检查器类</p>
<ul>
<li>在 <code>vagent/checkers/</code> 新增类，继承 <code>vagent.checkers.base.Checker</code> 并实现 <code>do_check()</code>；</li>
<li>在 <code>vagent/checkers/__init__.py</code> 导出类后，可在 <code>clss</code> 用短名；或直接写完整模块路径；</li>
<li><code>args</code> 中的字符串支持模板变量渲染；<code>extra_args</code> 可用于自定义提示文案（具体视检查器实现而定）。</li>
</ul>
<h3 id="常用-checker-参数结构化">常用 checker 参数（结构化）</h3>
<p>以下参数均来自实际代码实现（<code>vagent/checkers/unity_test.py</code>），名称、默认值与类型与代码保持一致；示例片段可直接放入阶段 YAML 的 <code>checker[].args</code>。</p>
<h4 id="unitychipcheckermarkdownfileformat">UnityChipCheckerMarkdownFileFormat</h4>
<ul>
<li>参数：
<ul>
<li>markdown_file_list (str | List[str]): 要检查的 Markdown 文件路径或路径列表。</li>
<li>no_line_break (bool, 默认 false): 是否禁止把换行写成字面量 &ldquo;\n&rdquo;；true 表示禁止。</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">markdown_file_list</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_basic_info.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">no_line_break</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerlabelstructure">UnityChipCheckerLabelStructure</h4>
<ul>
<li>参数：
<ul>
<li><code>doc_file</code> (str)</li>
<li><code>leaf_node</code> (&ldquo;FG&rdquo;|&ldquo;FC&rdquo;|&ldquo;CK&rdquo;)</li>
<li><code>min_count</code> (int, 默认 1)</li>
<li><code>must_have_prefix</code> (str, 默认 &ldquo;FG-API&rdquo;)</li>
<li><code>data_key</code> (str, 可选)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">leaf_node</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CK&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">data_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;COVER_GROUP_DOC_CK_LIST&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerdutcreation">UnityChipCheckerDutCreation</h4>
<ul>
<li>参数：
<ul>
<li><code>target_file</code> (str)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">target_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_api.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerdutfixture">UnityChipCheckerDutFixture</h4>
<ul>
<li>参数：
<ul>
<li><code>target_file</code> (str)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">target_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_api.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerenvfixture">UnityChipCheckerEnvFixture</h4>
<ul>
<li>参数：
<ul>
<li><code>target_file</code> (str)</li>
<li><code>min_env</code> (int, 默认 1)</li>
<li><code>force_bundle</code> (bool, 当前未使用)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">target_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_api.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">min_env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerdutapi">UnityChipCheckerDutApi</h4>
<ul>
<li>参数：
<ul>
<li><code>api_prefix</code> (str)</li>
<li><code>target_file</code> (str)</li>
<li><code>min_apis</code> (int, 默认 1)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">api_prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;api_{DUT}_&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">target_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_api.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">min_apis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckercoveragegroup">UnityChipCheckerCoverageGroup</h4>
<ul>
<li>参数：
<ul>
<li><code>test_dir</code> (str)</li>
<li><code>cov_file</code> (str)</li>
<li><code>doc_file</code> (str)</li>
<li><code>check_types</code> (str|List[str])</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cov_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_function_coverage_def.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">check_types</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;FG&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;FC&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;CK&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckercoveragegroupbatchimplementation">UnityChipCheckerCoverageGroupBatchImplementation</h4>
<ul>
<li>参数：
<ul>
<li><code>test_dir</code> (str)</li>
<li><code>cov_file</code> (str)</li>
<li><code>doc_file</code> (str)</li>
<li><code>batch_size</code> (int)</li>
<li><code>data_key</code> (str)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cov_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_function_coverage_def.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">batch_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">data_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;COVER_GROUP_DOC_CK_LIST&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckertesttemplate">UnityChipCheckerTestTemplate</h4>
<ul>
<li>基类参数：<code>doc_func_check</code> (str), <code>test_dir</code> (str), <code>min_tests</code> (int, 默认 1), <code>timeout</code> (int, 默认 15)</li>
<li>扩展参数（extra_args）：<code>batch_size</code> (默认 20), <code>ignore_ck_prefix</code> (str), <code>data_key</code> (str)</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_func_check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_ck_prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;test_api_{DUT}_&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">data_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;TEST_TEMPLATE_IMP_REPORT&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">batch_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerdutapitest">UnityChipCheckerDutApiTest</h4>
<ul>
<li>参数：
<ul>
<li><code>api_prefix</code> (str)</li>
<li><code>target_file_api</code> (str)</li>
<li><code>target_file_tests</code> (str)</li>
<li><code>doc_func_check</code> (str)</li>
<li><code>doc_bug_analysis</code> (str)</li>
<li><code>min_tests</code> (int, 默认 1)</li>
<li><code>timeout</code> (int, 默认 15)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">api_prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;api_{DUT}_&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">target_file_api</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/{DUT}_api.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">target_file_tests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests/test_{DUT}_api*.py&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_func_check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_bug_analysis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_bug_analysis.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckerbatchtestsimplementation">UnityChipCheckerBatchTestsImplementation</h4>
<ul>
<li>基类参数：<code>doc_func_check</code> (str), <code>test_dir</code> (str), <code>doc_bug_analysis</code> (str), <code>ignore_ck_prefix</code> (str), <code>timeout</code> (int, 默认 15)</li>
<li>进度参数：<code>data_key</code> (str, 必填)</li>
<li>扩展参数（extra_args）：<code>batch_size</code> (默认 5), <code>pre_report_file</code> (str)</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_func_check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_bug_analysis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_bug_analysis.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_ck_prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;test_api_{DUT}_&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">batch_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">data_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;TEST_TEMPLATE_IMP_REPORT&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pre_report_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}/.TEST_TEMPLATE_IMP_REPORT.json&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckertestcase">UnityChipCheckerTestCase</h4>
<ul>
<li>参数：
<ul>
<li><code>doc_func_check</code> (str)</li>
<li><code>doc_bug_analysis</code> (str)</li>
<li><code>test_dir</code> (str)</li>
<li><code>min_tests</code> (int, 默认 1)</li>
<li><code>timeout</code> (int, 默认 15)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_func_check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_bug_analysis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_bug_analysis.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h4 id="unitychipcheckertestcasewithlinecoverage">UnityChipCheckerTestCaseWithLineCoverage</h4>
<ul>
<li>基础参数同 <code>UnityChipCheckerTestCase</code></li>
<li>额外必需：<code>cfg</code> (dict|Config)</li>
<li>额外可选（extra_args）：
<ul>
<li><code>min_line_coverage</code> (float, 默认按配置，未配置则 0.8)</li>
<li><code>coverage_json</code> (str, 默认 <code>uc_test_report/line_dat/code_coverage.json</code>)</li>
<li><code>coverage_analysis</code> (str, 默认 <code>unity_test/{DUT}_line_coverage_analysis.md</code>)</li>
<li><code>coverage_ignore</code> (str, 默认 <code>unity_test/tests/{DUT}.ignore</code>)</li>
</ul>
</li>
<li>示例：
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_func_check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_functions_and_checks.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">doc_bug_analysis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/{DUT}_bug_analysis.md&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">test_dir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{OUT}/tests&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cfg</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&lt;CONFIG_OBJECT_OR_DICT&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">min_line_coverage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<p>提示：上面的 <code>示例</code> 仅展示 <code>args</code> 片段；实际需置于阶段条目下的 <code>checker[].args</code>。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2c9a60e5e9f300f565a6d475173df02">6.4 - 定制功能</h1>
    <div class="lead">如何自行定义参数、流程和工具。</div>
	<h2 id="添加工具与-mcp-server-工具">添加工具与 MCP Server 工具</h2>
<p>面向可修改本仓库代码的高级用户，以下说明如何：</p>
<ul>
<li>添加一个新工具（供本地/Agent 内调用）</li>
<li>将工具暴露为 MCP Server 工具（供外部 IDE/客户端调用）</li>
<li>控制选择哪些工具被暴露与如何调用</li>
</ul>
<p>涉及关键位置：</p>
<ul>
<li><code>vagent/tools/uctool.py</code>：工具基类 UCTool、to_fastmcp（LangChain Tool → FastMCP Tool）</li>
<li><code>vagent/util/functions.py</code>：<code>import_and_instance_tools</code>（按名称导入实例）、<code>create_verify_mcps</code>（启动 FastMCP）</li>
<li><code>vagent/verify_agent.py</code>：装配工具清单，<code>start_mcps</code> 组合并启动 Server</li>
<li><code>vagent/cli.py</code> / <code>vagent/verify_pdb.py</code>：命令行与 TUI 内的 MCP 启动命令</li>
</ul>
<h3 id="1-工具体系与装配">1) 工具体系与装配</h3>
<ul>
<li>工具基类 UCTool：
<ul>
<li>继承 LangChain BaseTool，内置：call_count 计数、call_time_out 超时、流式/阻塞提示、MCP Context 注入（ctx.info）、防重入等。</li>
<li>推荐自定义工具继承 UCTool，获得更好的 MCP 行为与调试体验。</li>
</ul>
</li>
<li>运行期装配（VerifyAgent 初始化）：
<ul>
<li>基础工具：RoleInfo、ReadTextFile</li>
<li>嵌入工具：参考检索与记忆（除非 <code>--no-embed-tools</code>）</li>
<li>文件工具：读/写/查找/路径等（可在 MCP 无文件工具模式下剔除）</li>
<li>阶段工具：由 StageManager 按工作流动态提供</li>
<li>外部工具：来自配置项 <code>ex_tools</code> 与 CLI <code>--ex-tools</code>（通过 <code>import_and_instance_tools</code> 零参实例化）</li>
</ul>
</li>
<li>名称解析：
<ul>
<li>短名：类/工厂函数需在 <code>vagent/tools/__init__.py</code> 导出（例如 <code>from .mytool import HelloTool</code>），即可在 <code>ex_tools</code> 写 <code>HelloTool</code></li>
<li>全路径：<code>mypkg.mytools.HelloTool</code> / <code>mypkg.mytools.Factory</code></li>
</ul>
</li>
</ul>
<h3 id="2-添加一个新工具本地agent-内">2) 添加一个新工具（本地/Agent 内）</h3>
<p>规范要求：</p>
<ul>
<li>唯一 name、清晰 description</li>
<li>使用 pydantic BaseModel 定义 args_schema（MCP 转换依赖）</li>
<li>实现 _run（同步）或 _arun（异步）；继承 UCTool 可直接获得超时、流式与 ctx 注入</li>
</ul>
<p>示例 1：同步工具（计数问候）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">pydantic</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">BaseModel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Field</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">vagent.tools.uctool</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UCTool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloArgs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BaseModel</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">who</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;要问候的人&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HelloTool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UCTool</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Hello&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">description</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;向指定对象问候，并统计调用次数&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">args_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">HelloArgs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">who</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">run_manager</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;Hello, </span><span style="color:#4e9a06">{</span><span style="color:#000">who</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">! (called </span><span style="color:#4e9a06">{</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">call_count</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> times)&#34;</span>
</span></span></code></pre></div><p>注册与使用：</p>
<ul>
<li>临时：<code>--ex-tools mypkg.mytools.HelloTool</code></li>
<li>持久：项目 <code>config.yaml</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ex_tools</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span>- <span style="color:#000">mypkg.mytools.HelloTool</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>（可选）短名注册：在 <code>vagent/tools/__init__.py</code> 导出 <code>HelloTool</code> 后，可写 <code>--ex-tools HelloTool</code>。</p>
<p>示例 2：异步流式工具（ctx.info + 超时）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">pydantic</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">BaseModel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Field</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">vagent.tools.uctool</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">UCTool</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">asyncio</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ProgressArgs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BaseModel</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">steps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ge</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">le</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;进度步数&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ProgressTool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UCTool</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Progress&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">description</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;演示流式输出与超时处理&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">args_schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ProgressArgs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">_arun</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">steps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">run_manager</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">steps</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>						<span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">put_alive_data</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">f</span><span style="color:#4e9a06">&#34;step </span><span style="color:#4e9a06">{</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/</span><span style="color:#4e9a06">{</span><span style="color:#000">steps</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 供阻塞提示/日志缓冲</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">asyncio</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;done&#34;</span>
</span></span></code></pre></div><p>说明：UCTool.ainvoke 会在 MCP 模式下注入 ctx，并启动阻塞提示线程；当 <code>sync_block_log_to_client=True</code> 时会周期性 <code>ctx.info</code> 推送日志，超时后返回错误与缓冲日志。</p>
<h3 id="3-暴露为-mcp-server-工具">3) 暴露为 MCP Server 工具</h3>
<p>工具 → MCP 转换（<code>vagent/tools/uctool.py::to_fastmcp</code>）：</p>
<ul>
<li>必须：args_schema 继承 BaseModel；不支持“注入参数”签名。</li>
<li>UCTool 子类会得到 context_kwarg=&ldquo;ctx&rdquo; 的 FastMCP 工具，具备流式交互能力。</li>
</ul>
<p>Server 端启动：</p>
<ul>
<li>VerifyAgent.start_mcps 组合工具：<code>tool_list_base + tool_list_task + tool_list_ext + [tool_list_file]</code></li>
<li><code>vagent/util/functions.py::create_verify_mcps</code> 将工具序列转换为 FastMCP 工具并启动 uvicorn（<code>mcp.streamable_http_app()</code>）。</li>
</ul>
<p>如何选择暴露范围：</p>
<ul>
<li>CLI：
<ul>
<li>启动（含文件工具）：<code>--mcp-server</code></li>
<li>启动（无文件工具）：<code>--mcp-server-no-file-tools</code></li>
<li>地址：<code>--mcp-server-host</code>，端口：<code>--mcp-server-port</code></li>
</ul>
</li>
<li>TUI 命令：<code>start_mcp_server [host] [port]</code> / <code>start_mcp_server_no_file_ops [host] [port]</code></li>
</ul>
<h3 id="4-客户端调用流程">4) 客户端调用流程</h3>
<p>FastMCP Python 客户端（参考 <code>tests/test_mcps.py</code>）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">fastmcp</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://127.0.0.1:5000/mcp&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">list_tools</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">call_tool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;who&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UCAgent&#34;</span><span style="color:#000;font-weight:bold">}))</span>
</span></span></code></pre></div><p>IDE/Agent（Claude Code、Copilot、Qwen Code 等）：将 <code>httpUrl</code> 指向 <code>http://&lt;host&gt;:&lt;port&gt;/mcp</code>，即可发现并调用工具。</p>
<h3 id="5-生命周期并发与超时">5) 生命周期、并发与超时</h3>
<ul>
<li>计数：UCTool 内置 call_count；非 UCTool 工具由 <code>import_and_instance_tools</code> 包装计数。</li>
<li>并发保护：is_in_streaming/is_alive_loop 防止重入；同一实例不允许并发执行。</li>
<li>超时：<code>call_time_out</code>（默认 20s）+ 客户端 timeout；阻塞时可用 <code>put_alive_data</code> + <code>sync_block_log_to_client=True</code> 推送心跳。</li>
</ul>
<h3 id="6-配置策略与最佳实践">6) 配置策略与最佳实践</h3>
<ul>
<li>ex_tools 列表为“整体覆盖”，项目 <code>config.yaml</code> 需写出完整清单。</li>
<li>短名 vs 全路径：短名更便捷，全路径适用于私有包不修改本仓库时。</li>
<li>无参构造/工厂：装配器直接调用 <code>(...)()</code>，复杂配置建议在工厂内部处理（读取环境/配置文件）。</li>
<li>文件写权限：MCP 无文件工具模式下不要暴露写类工具；如需写入，请在本地 Agent 内使用或显式允许写目录。</li>
</ul>
<h4 id="通过环境变量注入外部工具ex_tools">通过环境变量注入外部工具（EX_TOOLS）</h4>
<p>配置文件支持 Bash 风格环境变量占位：<code>$(VAR: default)</code>。你可以让 <code>ex_tools</code> 从环境变量注入工具类列表（支持模块全名或 <code>vagent.tools</code> 下的短名）。</p>
<ol>
<li>在项目的 <code>config.yaml</code> 或用户级 <code>~/.ucagent/setting.yaml</code> 中写入：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ex_tools: $(EX_TOOLS</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#000">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ol start="2">
<li>用环境变量提供列表（必须是可被 YAML 解析的数组字面量）：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">EX_TOOLS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;[&#34;SqThink&#34;,&#34;HumanHelp&#34;]&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或使用完整类路径：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># export EX_TOOLS=&#39;[&#34;vagent.tools.extool.SqThink&#34;,&#34;vagent.tools.human.HumanHelp&#34;]&#39;</span>
</span></span></code></pre></div><ol start="3">
<li>
<p>启动后本地对话与 MCP Server 中都会出现这些工具。短名需要在 <code>vagent/tools/__init__.py</code> 导出；否则请使用完整模块路径。</p>
</li>
<li>
<p>与 CLI 的 <code>--ex-tools</code> 选项是合并关系（两边都会被装配）。</p>
</li>
</ol>
<h3 id="7-常见问题排查">7) 常见问题排查</h3>
<ul>
<li>工具未出现在 MCP 列表：未被装配（ex_tools 未配置/未导出）、args_schema 非 BaseModel、Server 未按预期启动。</li>
<li>调用报“注入参数不支持”：工具定义包含 LangChain 的 injected args；请改成显式 args_schema 参数。</li>
<li>超时：调大 <code>call_time_out</code> 或客户端 timeout；在长任务中输出进度维持心跳。</li>
<li>短名无效：未在 <code>vagent/tools/__init__.py</code> 导出；改用全路径或补导出。</li>
</ul>
<p>完成以上步骤后：你的工具既能在本地对话中被 ReAct 自动调用，也能通过 MCP Server 暴露给外部 IDE/客户端统一调用。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-41ee5298b8c6094ee5f1fde353978dbe">6.5 - 工具列表</h1>
    <div class="lead">UCAgent 可用工具清单（按类别归纳）。</div>
	<p>以下为当前仓库内内置工具（UCTool 家族）的概览，按功能类别归纳：名称（调用名）、用途与参数说明（字段: 类型 — 含义）。</p>
<p>提示：</p>
<ul>
<li>带有“文件写”能力的工具仅在本地/允许写模式下可用；MCP 无文件工具模式不会暴露写类工具。</li>
<li>各工具均基于 args_schema 校验参数，MCP 客户端将根据 schema 生成参数表单。</li>
</ul>
<h2 id="基础信息类">基础/信息类</h2>
<ul>
<li>
<p>RoleInfo（RoleInfo）</p>
<ul>
<li>用途：返回当前代理的角色信息（可在启动时自定义 role_info）。</li>
<li>参数：无</li>
</ul>
</li>
<li>
<p>HumanHelp（HumanHelp）</p>
<ul>
<li>用途：向人类请求帮助（仅在确实卡住时使用）。</li>
<li>参数：
<ul>
<li>message: str — 求助信息</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="规划todo-类">规划/ToDo 类</h2>
<ul>
<li>CreateToDo
<ul>
<li>用途：创建 ToDo（覆盖旧 ToDo）。</li>
<li>参数：
<ul>
<li>task_description: str — 任务描述</li>
<li>steps: List[str] — 步骤（1–20 步）</li>
</ul>
</li>
</ul>
</li>
<li>CompleteToDoSteps
<ul>
<li>用途：将指定步骤标记为完成，可附加备注。</li>
<li>参数：
<ul>
<li>completed_steps: List[int] — 完成的步骤序号（1-based）</li>
<li>notes: str — 备注</li>
</ul>
</li>
</ul>
</li>
<li>UndoToDoSteps
<ul>
<li>用途：撤销步骤完成状态，可附加备注。</li>
<li>参数：
<ul>
<li>steps: List[int] — 撤销的步骤序号（1-based）</li>
<li>notes: str — 备注</li>
</ul>
</li>
</ul>
</li>
<li>ResetToDo
<ul>
<li>用途：重置/清空当前 ToDo。</li>
<li>参数：无</li>
</ul>
</li>
<li>GetToDoSummary / ToDoState
<ul>
<li>用途：获取 ToDo 摘要 / 看板状态短语。</li>
<li>参数：无</li>
</ul>
</li>
</ul>
<h2 id="记忆检索类">记忆/检索类</h2>
<ul>
<li>
<p>SemanticSearchInGuidDoc（SemanticSearchInGuidDoc）</p>
<ul>
<li>用途：在 Guide_Doc/项目文档中做语义检索，返回最相关片段。</li>
<li>参数：
<ul>
<li>query: str — 查询语句</li>
<li>limit: int — 返回条数（1–100，默认 3）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>MemoryPut</p>
<ul>
<li>用途：按 scope 写入长时记忆。</li>
<li>参数：
<ul>
<li>scope: str — 命名空间/范围（如 general/task-specific）</li>
<li>data: str — 内容（可为 JSON 文本）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>MemoryGet</p>
<ul>
<li>用途：按 scope 检索记忆。</li>
<li>参数：
<ul>
<li>scope: str — 命名空间/范围</li>
<li>query: str — 查询语句</li>
<li>limit: int — 返回条数（1–100，默认 3）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="测试执行类">测试/执行类</h2>
<ul>
<li>
<p>RunPyTest（RunPyTest）</p>
<ul>
<li>用途：在指定目录/文件下运行 pytest，支持返回 stdout/stderr。</li>
<li>参数：
<ul>
<li>test_dir_or_file: str — 测试目录或文件</li>
<li>pytest_ex_args: str — 额外 pytest 参数（如 &ldquo;-v --capture=no&rdquo;）</li>
<li>return_stdout: bool — 是否返回标准输出</li>
<li>return_stderr: bool — 是否返回标准错误</li>
<li>timeout: int — 超时秒数（默认 15）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>RunUnityChipTest（RunUnityChipTest）</p>
<ul>
<li>用途：面向 UnityChip 项目封装的测试执行，产生 toffee_report.json 等结果。</li>
<li>参数：同 RunPyTest；另含内部字段（workspace/result_dir/result_json_path）。</li>
</ul>
</li>
</ul>
<h2 id="文件路径文本类">文件/路径/文本类</h2>
<ul>
<li>
<p>SearchText（SearchText）</p>
<ul>
<li>用途：在工作区内按文本搜索，支持通配与正则。</li>
<li>参数：
<ul>
<li>pattern: str — 搜索模式（明文/通配/正则）</li>
<li>directory: str — 相对目录（为空则全仓；填文件则仅搜该文件）</li>
<li>max_match_lines: int — 每个文件返回的最大匹配行数（默认 20）</li>
<li>max_match_files: int — 返回的最大文件数（默认 10）</li>
<li>use_regex: bool — 是否使用正则</li>
<li>case_sensitive: bool — 区分大小写</li>
<li>include_line_numbers: bool — 返回是否带行号</li>
</ul>
</li>
</ul>
</li>
<li>
<p>FindFiles（FindFiles）</p>
<ul>
<li>用途：按通配符查找文件。</li>
<li>参数：
<ul>
<li>pattern: str — 文件名模式（fnmatch 通配）</li>
<li>directory: str — 相对目录（为空则全仓）</li>
<li>max_match_files: int — 返回最大文件数（默认 10）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>PathList（PathList）</p>
<ul>
<li>用途：列出目录结构（可限制深度）。</li>
<li>参数：
<ul>
<li>path: str — 目录（相对 workspace）</li>
<li>depth: int — 深度（-1 全部，0 当前）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ReadBinFile（ReadBinFile）</p>
<ul>
<li>用途：读取二进制文件（返回 [BIN_DATA]）。</li>
<li>参数：
<ul>
<li>path: str — 文件路径（相对 workspace）</li>
<li>start: int — 起始字节（默认 0）</li>
<li>end: int — 结束字节（默认 -1 表示 EOF）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ReadTextFile（ReadTextFile）</p>
<ul>
<li>用途：读取文本文件（带行号，返回 [TXT_DATA]）。</li>
<li>参数：
<ul>
<li>path: str — 文件路径（相对 workspace）</li>
<li>start: int — 起始行（1-based，默认 1）</li>
<li>count: int — 行数（-1 到文件末尾）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>EditTextFile（EditTextFile）</p>
<ul>
<li>用途：编辑/创建文本文件，模式：replace/overwrite/append。</li>
<li>参数：
<ul>
<li>path: str — 文件路径（相对 workspace，不存在则创建）</li>
<li>data: str — 写入的文本（None 表示清空）</li>
<li>mode: str — 编辑模式（replace/overwrite/append，默认 replace）</li>
<li>start: int — replace 模式的起始行（1-based）</li>
<li>count: int — replace 模式替换行数（-1 到末尾，0 插入）</li>
<li>preserve_indent: bool — replace 时是否保留缩进</li>
</ul>
</li>
</ul>
</li>
<li>
<p>CopyFile（CopyFile）</p>
<ul>
<li>用途：复制文件；可选覆盖。</li>
<li>参数：
<ul>
<li>source_path: str — 源文件</li>
<li>dest_path: str — 目标文件</li>
<li>overwrite: bool — 目标存在时是否覆盖</li>
</ul>
</li>
</ul>
</li>
<li>
<p>MoveFile（MoveFile）</p>
<ul>
<li>用途：移动/重命名文件；可选覆盖。</li>
<li>参数：
<ul>
<li>source_path: str — 源文件</li>
<li>dest_path: str — 目标文件</li>
<li>overwrite: bool — 目标存在时是否覆盖</li>
</ul>
</li>
</ul>
</li>
<li>
<p>DeleteFile（DeleteFile）</p>
<ul>
<li>用途：删除文件。</li>
<li>参数：
<ul>
<li>path: str — 文件路径</li>
</ul>
</li>
</ul>
</li>
<li>
<p>CreateDirectory（CreateDirectory）</p>
<ul>
<li>用途：创建目录（递归）。</li>
<li>参数：
<ul>
<li>path: str — 目录路径</li>
<li>parents: bool — 递归创建父目录</li>
<li>exist_ok: bool — 已存在是否忽略</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ReplaceStringInFile（ReplaceStringInFile）</p>
<ul>
<li>用途：精确字符串替换（强约束匹配；可新建文件）。</li>
<li>参数：
<ul>
<li>path: str — 目标文件</li>
<li>old_string: str — 需要被替换的完整原文（含上下文，精确匹配）</li>
<li>new_string: str — 新内容</li>
</ul>
</li>
</ul>
</li>
<li>
<p>GetFileInfo（GetFileInfo）</p>
<ul>
<li>用途：获取文件信息（大小、修改时间、人类可读尺寸等）。</li>
<li>参数：
<ul>
<li>path: str — 文件路径</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="扩展示例">扩展示例</h2>
<ul>
<li>SimpleReflectionTool（SimpleReflectionTool）
<ul>
<li>用途：示例型“自我反思”工具（来自 extool.py），可作为扩展参考。</li>
<li>参数：
<ul>
<li>message: str — 自我反思文本</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>备注：</p>
<ul>
<li>工具调用超时默认 20s（具体工具可重写）；长任务请周期性输出进度避免超时。</li>
<li>MCP 无文件工具模式下默认不暴露写类工具；如需写入，建议在本地 Agent 模式或按需限制可写目录。</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-636f24d07e5c63a708ce945a0d50c36c">7 - 多语言支持</h1>
    <div class="lead">开放验证平台支持多种语言</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-53c158edebe1befb67901d2b20c2f954">7.1 - 验证接口</h1>
    <div class="lead">DUT文件与编程语言都支持的验证接口</div>
	<h2 id="生成库文件">生成库文件</h2>
<p>picker可以通过参数<code>--lang</code>指定转换的对应语言（参数已支持cpp、python、java、lua、scala、golang），由于不同编程语言对应的“库”不同，因此生成的库文件有所区别，例如java生成的是jar包，python生成的为文件夹。picker导出对应编程语言的库，需要xcomm的支持，可以通过<code>picker --check</code>查看支持情况：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$picker</span> --check
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Version: 0.9.0-feat_performance_improve-b7001a6-2025-04-11-dirty
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Exec path: /usr/local/share/lib/python3.11/site-packages/picker/bin/picker
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Template path: /usr/local/share/lib/python3.11/site-packages/picker/share/picker/template
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Support    Cpp <span style="color:#ce5c00;font-weight:bold">(</span>find: <span style="color:#4e9a06">&#39;/usr/local/share/lib/python3.11/site-packages/picker/share/picker/lib&#39;</span> success<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Support Golang <span style="color:#ce5c00;font-weight:bold">(</span>find: <span style="color:#4e9a06">&#39;/usr/local/share/lib/python3.11/site-packages/picker/share/picker/golang&#39;</span> success<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Support   Java <span style="color:#ce5c00;font-weight:bold">(</span>find: <span style="color:#4e9a06">&#39;/usr/local/share/lib/python3.11/site-packages/picker/share/picker/java/xspcomm-java.jar&#39;</span> success<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Support    Lua <span style="color:#ce5c00;font-weight:bold">(</span>find: <span style="color:#4e9a06">&#39;/usr/local/share/lib/python3.11/site-packages/picker/share/picker/lua/luaxspcomm.so&#39;</span> success<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Support Python <span style="color:#ce5c00;font-weight:bold">(</span>find: <span style="color:#4e9a06">&#39;/usr/local/share/lib/python3.11/site-packages/picker/share/picker/python&#39;</span> success<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK <span style="color:#ce5c00;font-weight:bold">]</span> Support  Scala <span style="color:#ce5c00;font-weight:bold">(</span>find: <span style="color:#4e9a06">&#39;/usr/local/share/lib/python3.11/site-packages/picker/share/picker/scala/xspcomm-scala.jar&#39;</span> success<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>输出显示success表示支持，fail表示不支持。</p>
<h3 id="c">C++</h3>
<p>对于C++语言，picker生成的为so动态链接库，和对应的头文件。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>UT_Adder/
</span></span><span style="display:flex;"><span>├── UT_Adder.cpp       <span style="color:#8f5902;font-style:italic"># DUT 文件</span>
</span></span><span style="display:flex;"><span>├── UT_Adder.hpp       <span style="color:#8f5902;font-style:italic"># DUT 头文件</span>
</span></span><span style="display:flex;"><span>├── UT_Adder_dpi.hpp   <span style="color:#8f5902;font-style:italic"># DPI 头文件</span>
</span></span><span style="display:flex;"><span>├── dut_base.hpp       <span style="color:#8f5902;font-style:italic"># DUT base 头文件</span>
</span></span><span style="display:flex;"><span>├── libDPIAdder.a      <span style="color:#8f5902;font-style:italic"># DPI 静态库</span>
</span></span><span style="display:flex;"><span>└── libUTAdder.so      <span style="color:#8f5902;font-style:italic"># DUT 动态库</span>
</span></span></code></pre></div><p>在使用时，设置好LD路径，然后再测试代码中<code>#include UT_Adder.hpp</code></p>
<h3 id="python">Python</h3>
<p>Python语言生成的为目录（Python module以目录的方式表示）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>UT_Adder/
</span></span><span style="display:flex;"><span>├── _UT_Adder.so
</span></span><span style="display:flex;"><span>├── __init__.py
</span></span><span style="display:flex;"><span>├── libUTAdder.so
</span></span><span style="display:flex;"><span>└── libUT_Adder.py
</span></span></code></pre></div><p>设置PYTHONPATH后，可以在test中<code>import UT_Adder</code></p>
<h3 id="javascala">Java/scala</h3>
<p>对于Java和scala基于JVM的编程语言，picker生成的为对应的jar包。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>UT_Adder/
</span></span><span style="display:flex;"><span>├── UT_Adder-scala.jar
</span></span><span style="display:flex;"><span>└── UT_Adder-java.jar
</span></span></code></pre></div><h3 id="go">go</h3>
<p>go语言生成的为目录（类似python）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>UT_Adder/
</span></span><span style="display:flex;"><span>└── golang
</span></span><span style="display:flex;"><span>    └── src
</span></span><span style="display:flex;"><span>        └── UT_Adder
</span></span><span style="display:flex;"><span>            ├── UT_Adder.go
</span></span><span style="display:flex;"><span>            ├── UT_Adder.so
</span></span><span style="display:flex;"><span>            ├── UT_Adder_Wrapper.go
</span></span><span style="display:flex;"><span>            ├── go.mod
</span></span><span style="display:flex;"><span>            └── libUTAdder.so
</span></span></code></pre></div><p>设置GOPATH后，可直接进行import</p>
<h2 id="验证接口">验证接口</h2>
<p>DUT验证接口可以参考连接：<a href="https://github.com/XS-MLVP/picker/blob/master/doc/API.zh.md">https://github.com/XS-MLVP/picker/blob/master/doc/API.zh.md</a></p>
<p>xspcomm库接口请参考连接：<a href="https://github.com/XS-MLVP/xcomm/blob/master/docs/APIs.cn.md">https://github.com/XS-MLVP/xcomm/blob/master/docs/APIs.cn.md</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-57d72ed5388a70f688d60bc387d15b92">7.2 - 验证案例</h1>
    <div class="lead">多语言案例介绍</div>
	

<div class="pageinfo pageinfo-primary">
<p>本页将展示使用多种语言验证的各种案例。</p>

</div>


</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-50973acd0ef39be0a54f167be428bdba">7.2.1 - 加法器</h1>
    <div class="lead">使用C++、Java、Python和Golang验证加法器的案例</div>
	<p>以Adder为例，各语言的验证代码和注释如下：</p>

<div class="highlight">
    
    <div style="background-color: #f0f0f0; display: flex; justify-content: flex-end; gap: 5px; padding-right: 5px">
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='cpp' href="javascript://">Cpp</a>
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='java' href="javascript://">Java</a>
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='scala' href="javascript://">Scala</a>
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='python' href="javascript://">Python</a>
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='go' href="javascript://">Go</a>
        
    </div>
    




  
  


<pre name="group-lang-code-cpp" class="language-cpp line-numbers" style="display:true;"><code class="language-cpp">#include "UT_Adder.hpp"

int64_t random_int64()
{
    static std::random_device rd;
    static std::mt19937_64 generator(rd());
    static std::uniform_int_distribution<int64_t> distribution(INT64_MIN,
                                                               INT64_MAX);
    return distribution(generator);
}

int main()
{
    UTAdder *dut = new UTAdder();
    dut->Step(1);
    printf("Initialized UTAdder\n");

    struct input_t {
        uint64_t a;
        uint64_t b;
        uint64_t cin;
    };

    struct output_t {
        uint64_t sum;
        uint64_t cout;
    };

    for (int c = 0; c < 114514; c++) {
        input_t i;
        output_t o_dut, o_ref;

        i.a   = random_int64();
        i.b   = random_int64();
        i.cin = random_int64() & 1;

        auto dut_cal = [&]() {
            dut->a   = i.a;
            dut->b   = i.b;
            dut->cin = i.cin;
            dut->Step(1);
            o_dut.sum  = (uint64_t)dut->sum;
            o_dut.cout = (uint64_t)dut->cout;
        };

        auto ref_cal = [&]() {
            uint64_t sum = i.a + i.b;
            bool carry   = sum < i.a;

            sum += i.cin;
            carry = carry || sum < i.cin;

            o_ref.sum  = sum;
            o_ref.cout = carry ;
        };

        dut_cal();
        ref_cal();
        printf("[cycle %lu] a=0x%lx, b=0x%lx, cin=0x%lx\n", dut->xclock.clk, i.a,
               i.b, i.cin);
        printf("DUT: sum=0x%lx, cout=0x%lx\n", o_dut.sum, o_dut.cout);
        printf("REF: sum=0x%lx, cout=0x%lx\n", o_ref.sum, o_ref.cout);
        Assert(o_dut.sum == o_ref.sum, "sum mismatch");
    }

    dut->Finish();
    printf("Test Passed, destory UTAdder\n");
    return 0;
}</code></pre>





  
  


<pre name="group-lang-code-java" class="language-java line-numbers" style="display:none;"><code class="language-java">package com.ut;

import java.math.BigInteger;

// import the generated UT class
import com.ut.UT_Adder;

public class example {
    static public void main(String[] args){
        UT_Adder adder = new UT_Adder();
        for(int i=0; i<10000; i++){
            int N = 1000000;
            long a = (long) (Math.random() * N);
            long b = (long) (Math.random() * N);
            long c = (long) (Math.random() * N) > 50 ? 1 : 0;
            // set inputs
            adder.a.Set(a);
            adder.b.Set(b);
            adder.cin.Set(c);
            // step
            adder.Step();
            // reference model
            long sum = a + b;
            boolean carry = sum < a ? true : false;
            sum += c;
            carry = carry || sum < c;
            // assert
            assert adder.sum.U().longValue() == sum : "sum mismatch: " + adder.sum.U() + " != " + sum;
            assert adder.cout.U().intValue() == (carry ? 1 : 0) : "carry mismatch: " + adder.cout.U() + " != " + carry;
        }
        System.out.println("Java tests passed");
        adder.Finish();
    }
}</code></pre>





  
  


<pre name="group-lang-code-scala" class="language-scala line-numbers" style="display:none;"><code class="language-scala">package com.ut

import java.lang.Math
import com.ut.UT_Adder

object example {
    def main(args: Array[String]): Unit = {
      val adder = new UT_Adder()
      for (i <- 0 until 10000) {
        val N = 1000000
        val a = (Math.random() * N).toLong
        val b = (Math.random() * N).toLong
        val c = if ((Math.random() * N).toLong > 50) 1 else 0

        // set inputs
        adder.a.Set(a)
        adder.b.Set(b)
        adder.cin.Set(c)

        // step
        adder.Step()

        // reference model
        var sum = a + b
        var carry = if (sum < a) true else false
        sum += c
        carry = carry || (sum < c)

        // assert
        assert(adder.sum.U().longValue() == sum, s"sum mismatch: ${adder.sum.U()} != $sum")
        assert(adder.cout.U().intValue() == (if (carry) 1 else 0), s"carry mismatch: ${adder.cout.U()} != $carry")
        println(s"[cycle ${adder.xclock.getClk().intValue()}] a=${adder.a.U64()}, b=${adder.b.U64()}, cin=${adder.cin.U64()}")
      }
      println("Scala tests passed")
      adder.Finish()
    }
}</code></pre>





  
  


<pre name="group-lang-code-python" class="language-python line-numbers" style="display:none;"><code class="language-python">from Adder import *

import random

class input_t:
    def __init__(self, a, b, cin):
        self.a = a
        self.b = b
        self.cin = cin

class output_t:
    def __init__(self):
        self.sum = 0
        self.cout = 0

def random_int():
    return random.randint(-(2**127), 2**127 - 1) & ((1 << 128) - 1)

def as_uint(x, nbits):
    return x & ((1 << nbits) - 1)

def main():
    dut = DUTAdder()  # Assuming USE_VERILATOR

    print("Initialized UTAdder")

    for c in range(11451):
        i = input_t(random_int(), random_int(), random_int() & 1)
        o_dut, o_ref = output_t(), output_t()

        def dut_cal():
            dut.a.value, dut.b.value, dut.cin.value = i.a, i.b, i.cin
            dut.Step(1)
            o_dut.sum = dut.sum.value
            o_dut.cout = dut.cout.value

        def ref_cal():
            sum = as_uint( i.a + i.b + i.cin, 128+1)
            o_ref.sum = as_uint(sum, 128)
            o_ref.cout = as_uint(sum >> 128, 1)

        dut_cal()
        ref_cal()

        print(f"[cycle {dut.xclock.clk}] a=0x{i.a:x}, b=0x{i.b:x}, cin=0x{i.cin:x}")
        print(f"DUT: sum=0x{o_dut.sum:x}, cout=0x{o_dut.cout:x}")
        print(f"REF: sum=0x{o_ref.sum:x}, cout=0x{o_ref.cout:x}")

        assert o_dut.sum == o_ref.sum, "sum mismatch"

    dut.Finish()

    print("Test Passed, destroy UTAdder")

if __name__ == "__main__":
    main()</code></pre>





  
  


<pre name="group-lang-code-go" class="language-go line-numbers" style="display:none;"><code class="language-go">package main

import (
	"fmt"
    "time"
    "math/rand"
    ut "UT_Adder"
)

func assert(cond bool, msg string) {
    if !cond {
        panic(msg)
    }
}

func main() {
    adder := ut.NewUT_Adder()
    rand.Seed(time.Now().UnixNano())
    for i := 0; i < 10000; i++ {
        N := 1000000
        a := rand.Int63n(int64(N))
        b := rand.Int63n(int64(N))
        var c int64
        if rand.Int63n(int64(N)) > 50 {
            c = 1
        } else {
            c = 0
        }

        adder.A.Set(a)
        adder.B.Set(b)
        adder.Cin.Set(c)

        adder.Step()

        // reflerence model
        sum := a + b
        carry := sum < a
        sum += c
        carry = carry || sum < c

        // assert
        assert(adder.Sum.U64() == uint64(sum), fmt.Sprintf("sum mismatch: %d != %d\n", adder.Sum.U64(), uint64(sum)))

        var carry_bool uint64
        if carry {
            carry_bool = 1
        } else {
            carry_bool = 0
        }
        assert(adder.Cout.U64() == carry_bool, fmt.Sprintf("carry mismatch: %d != %t\n", adder.Cout.U().Int64(), carry))
    }
    adder.Finish();
    fmt.Println("Golang tests passed")
}</code></pre>




</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fccab6f4706bebc2fd1fa8ce99a21cc1">7.2.2 - CoupledL2</h1>
    <div class="lead">用C++、Java和Python简单验证香山L2 Cache的案例</div>
	<p><code>CoupledL2</code>是一个非阻塞的<a href="https://github.com/OpenXiangShan/CoupledL2">L2 Cache</a>。</p>
<p>下面的代码会对<code>CoupledL2</code>进行简单的验证，并使用数组作为参考模型，验证过程如下：</p>
<ol>
<li>生成随机的地址<code>addr</code>、执行<code>AcquireBlock</code>，请求读取<code>addr</code>的数据。</li>
<li>执行<code>GrantData</code>，接收<code>DUT</code>响应的数据。</li>
<li>把接收到的数据和参考模型的内容进行比较，验证行为是否一致。</li>
<li>执行<code>GrantAck</code>，响应<code>DUT</code>。</li>
<li>执行<code>ReleaseData</code>，向<code>DUT</code>请求在<code>addr</code>写入随机数据<code>data</code>。</li>
<li>同步参考模型，把<code>addr</code>的数据更新为<code>data</code>。</li>
<li>执行<code>ReleaseAck</code>，接收<code>DUT</code>的写入响应。</li>
</ol>
<p>上述步骤会重复4000次。</p>
<p>验证代码：</p>

<div class="highlight">
    
    <div style="background-color: #f0f0f0; display: flex; justify-content: flex-end; gap: 5px; padding-right: 5px">
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='cpp' href="javascript://">Cpp</a>
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='java' href="javascript://">Java</a>
        
            <a name="multi-lang-toggle" style="font-size: 12px;" lang='python' href="javascript://">Python</a>
        
    </div>
    




  
  


<pre name="group-lang-code-cpp" class="language-cpp line-numbers" style="display:true;"><code class="language-cpp">#include "UT_CoupledL2.hpp"
using TLDataArray = std::array<uint64_t, 2>;

enum class OpcodeA : uint32_t {
  PutFullData = 0x0,
  PutPartialData = 0x1,
  ArithmeticData = 0x2,
  LogicalData = 0x3,
  Get = 0x4,
  Hint = 0x5,
  AcquireBlock = 0x6,
  AcquirePerm = 0x7,
};

enum class OpcodeB : uint32_t { ProbeBlock = 0x6, ProbePerm = 0x7 };

enum class OpcodeC : uint32_t { ProbeAck = 0x4, ProbeAckData = 0x5, Release = 0x6, ReleaseData = 0x7 };

enum class OpcodeD : uint32_t { AccessAck, AccessAckData, HintAck, Grant = 0x4, GrantData = 0x5, ReleaseAck = 0x6 };

enum class OpcodeE : uint32_t { GrantAck = 0x4 };

constexpr std::initializer_list<const char *> ARGS = {"+verilator+rand+reset+0"};
auto dut = UTCoupledL2(ARGS);
auto &clk = dut.xclock;

void sendA(OpcodeA opcode, uint32_t size, uint32_t address) {
  const auto &valid = dut.master_port_0_0_a_valid;
  const auto &ready = dut.master_port_0_0_a_ready;
  while (ready.value == 0x0) clk.Step();
  valid.value = 1;
  dut.master_port_0_0_a_bits_opcode.value = opcode;
  dut.master_port_0_0_a_bits_size.value = size;
  dut.master_port_0_0_a_bits_address.value = address;
  clk.Step();
  valid.value = 0;
}

void getB() {
  assert(false);
  const auto &valid = dut.master_port_0_0_b_valid;
  const auto &ready = dut.master_port_0_0_b_ready;
  ready.value = 1;
  while (valid.value == 0)
    clk.Step();
  dut.master_port_0_0_b_bits_opcode = 0x0;
  dut.master_port_0_0_b_bits_param = 0x0;
  dut.master_port_0_0_b_bits_size = 0x0;
  dut.master_port_0_0_b_bits_source = 0x0;
  dut.master_port_0_0_b_bits_address = 0x0;
  dut.master_port_0_0_b_bits_mask = 0x0;
  dut.master_port_0_0_b_bits_data = 0x0;
  dut.master_port_0_0_b_bits_corrupt = 0x0;
  clk.Step();
  ready.value = 0;
}

void sendC(OpcodeC opcode, uint32_t size, uint32_t address, uint64_t data) {
  const auto &valid = dut.master_port_0_0_c_valid;
  const auto &ready = dut.master_port_0_0_c_ready;

  while (ready.value == 0) clk.Step();
  valid.value = 1;
  dut.master_port_0_0_c_bits_opcode.value = opcode;
  dut.master_port_0_0_c_bits_size.value = size;
  dut.master_port_0_0_c_bits_address.value = address;
  dut.master_port_0_0_c_bits_data.value = data;
  clk.Step();
  valid.value = 0;
}

void getD() {
  const auto &valid = dut.master_port_0_0_d_valid;
  const auto &ready = dut.master_port_0_0_d_ready;
  ready.value = 1;
  clk.Step();
  while (valid.value == 0) clk.Step();
  ready.value = 0;
}

void sendE(uint32_t sink) {
  const auto &valid = dut.master_port_0_0_e_valid;
  const auto &ready = dut.master_port_0_0_e_ready;
  while (ready.value == 0) clk.Step();
  valid.value = 1;
  dut.master_port_0_0_e_bits_sink.value = sink;
  clk.Step();
  valid.value = 0;
}

void AcquireBlock(uint32_t address) { sendA(OpcodeA::AcquireBlock, 0x6, address); }

void GrantData(TLDataArray &r_data) {
  const auto &opcode = dut.master_port_0_0_d_bits_opcode;
  const auto &data = dut.master_port_0_0_d_bits_data;

  for (int i = 0; i < 2; i++) {
    do { getD(); } while (opcode.value != OpcodeD::GrantData);
    r_data[i] = data.value;
  }
}

void GrantAck(uint32_t sink) { sendE(sink); }

void ReleaseData(uint32_t address, const TLDataArray &data) {
  for (int i = 0; i < 2; i++)
    sendC(OpcodeC::ReleaseData, 0x6, address, data[i]);
}

void ReleaseAck() {
  const auto &opcode = dut.master_port_0_0_d_bits_opcode;
  do { getD(); } while (opcode.value != OpcodeD::ReleaseAck);
}

int main() {
  TLDataArray ref_data[16] = {};
  /* Random generator */
  std::random_device rd;
  std::mt19937_64 gen_rand(rd());
  std::uniform_int_distribution<uint32_t> distrib(0, 0xf - 1);

  /* DUT init */
  dut.InitClock("clock");
  dut.reset.SetWriteMode(xspcomm::WriteMode::Imme);
  dut.reset.value = 1;
  clk.Step();
  dut.reset.value = 0;
  for (int i = 0; i < 100; i++) clk.Step();

  /* Test loop */
  for (int test_loop = 0; test_loop < 4000; test_loop++) {
    uint32_t d_sink;
    TLDataArray data{}, r_data{};
    /* Generate random */
    const auto address = distrib(gen_rand) << 6;
    for (auto &i : data)
      i = gen_rand();

    printf("[CoupledL2 Test\t%d]: At address(0x%03x), ", test_loop + 1, address);
    /* Read */
    AcquireBlock(address);
    GrantData(r_data);

    // Print read result
    printf("Read: ");
    for (const auto &x : r_data)
      printf("%08lx", x);

    d_sink = dut.master_port_0_0_d_bits_sink.value;
    assert ((r_data == ref_data[address >> 6]) && "Read Failed");
    GrantAck(d_sink);

    /* Write */
    ReleaseData(address, data);
    ref_data[address >> 6] = data;
    ReleaseAck();

    // Print write data
    printf(", Write: ");
    for (const auto &x : data)
      printf("%08lx", x);
    printf(".\n");
  }

  return 0;
}</code></pre>






  
  


<pre name="group-lang-code-java" class="language-java line-numbers" style="display:none;"><code class="language-java">import com.ut.UT_CoupledL2;
import com.xspcomm.WriteMode;

import java.io.BufferedWriter;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.math.BigInteger;
import java.util.Arrays;
import java.util.Random;
import java.util.random.RandomGenerator;

class Opcode {
    public enum A {
        PutFullData(0x0),
        PutPartialData(0x1),
        ArithmeticData(0x2),
        LogicalData(0x3),
        Get(0x4),
        Hint(0x5),
        AcquireBlock(0x6),
        AcquirePerm(0x7);

        private final int value;

        A(int value) {
            this.value = value;
        }

        public int getValue() {
            return value;
        }
    }

    public enum B {
        ProbeBlock(0x6), ProbePerm(0x7);

        private final int value;

        B(int value) {
            this.value = value;
        }

        public int getValue() {
            return value;
        }
    }

    public enum C {
        ProbeAck(0x4), ProbeAckData(0x5), Release(0x6), ReleaseData(0x7);

        private final int value;

        C(int value) {
            this.value = value;
        }

        public int getValue() {
            return value;
        }
    }

    public enum D {
        AccessAck(0x0), AccessAckData(0x1), HintAck(0x2), Grant(0x4), GrantData(0x5), ReleaseAck(0x6);

        private final int value;

        D(int value) {
            this.value = value;
        }

        public int getValue() {
            return value;
        }
    }

    public enum E {
        GrantAck(0x4);

        private final int value;

        E(int value) {
            this.value = value;
        }

        public int getValue() {
            return value;
        }
    }
}

public class TestCoupledL2 {
    static PrintWriter pwOut = new PrintWriter(new BufferedWriter(new OutputStreamWriter(System.out)));
    static UT_CoupledL2 dut;

    static void sendA(int opcode, int size, int address) {
        var valid = dut.master_port_0_0_a_valid;
        var ready = dut.master_port_0_0_a_ready;
        while (!ready.B()) dut.xclock.Step();
        valid.Set(1);
        dut.master_port_0_0_a_bits_opcode.Set(opcode);
        dut.master_port_0_0_a_bits_size.Set(size);
        dut.master_port_0_0_a_bits_address.Set(address);
        dut.xclock.Step();
        valid.Set(0);
    }

    static void getB() {
        var valid = dut.master_port_0_0_b_valid;
        var ready = dut.master_port_0_0_b_ready;
        ready.Set(1);
        while (!valid.B()) dut.xclock.Step();
        ready.Set(0);
    }

    static void sendC(int opcode, int size, int address, long data) {
        var valid = dut.master_port_0_0_c_valid;
        var ready = dut.master_port_0_0_c_ready;

        while (!ready.B()) dut.xclock.Step();
        valid.Set(1);
        dut.master_port_0_0_c_bits_opcode.Set(opcode);
        dut.master_port_0_0_c_bits_size.Set(size);
        dut.master_port_0_0_c_bits_address.Set(address);
        dut.master_port_0_0_c_bits_data.Set(data);
        dut.xclock.Step();
        valid.Set(0);
    }

    static void getD() {
        var valid = dut.master_port_0_0_d_valid;
        var ready = dut.master_port_0_0_d_ready;
        ready.Set(1);
        dut.xclock.Step();
        while (!valid.B()) dut.xclock.Step();
        ready.Set(0);
    }

    static void sendE(int sink) {
        var valid = dut.master_port_0_0_e_valid;
        var ready = dut.master_port_0_0_e_ready;
        while (!ready.B()) dut.xclock.Step();
        valid.Set(1);
        dut.master_port_0_0_e_bits_sink.Set(sink);
        dut.xclock.Step();
        valid.Set(0);
    }

    static void AcquireBlock(int address) {
        sendA(Opcode.A.AcquireBlock.getValue(), 0x6, address);
    }

    static BigInteger GrantData() {
        var opcode = dut.master_port_0_0_d_bits_opcode;
        var data = dut.master_port_0_0_d_bits_data;

        do {
            getD();
        } while (opcode.Get().intValue() != Opcode.D.GrantData.getValue());
        var r_data = data.U64().shiftLeft(64);
        do {
            getD();
        } while (opcode.Get().intValue() != Opcode.D.GrantData.getValue());
        return r_data.or(data.U64());
    }

    static void GrantAck(int sink) {
        sendE(sink);
    }

    static void ReleaseData(int address, BigInteger data) {
        sendC(Opcode.C.ReleaseData.getValue(), 0x6, address, data.longValue());
        sendC(Opcode.C.ReleaseData.getValue(), 0x6, address, data.shiftRight(64).longValue());
    }

    static void ReleaseAck() {
        var opcode = dut.master_port_0_0_d_bits_opcode;
        do {
            getD();
        } while (opcode.Get().intValue() != Opcode.D.ReleaseAck.getValue());
    }

    public static void main(String[] args) throws IOException {
        /* Random Generator */
        var gen_rand = RandomGenerator.getDefault();
        /* DUT init */
        final String[] ARGS = {"+verilator+rand+reset+0"};
        dut = new UT_CoupledL2(ARGS);
        dut.InitClock("clock");
        dut.reset.SetWriteMode(WriteMode.Imme);
        dut.reset.Set(1);
        dut.xclock.Step();
        dut.reset.Set(0);
        for (int i = 0; i < 100; i++) dut.xclock.Step();
        dut.xclock.Step();

        /* Ref */
        BigInteger[] ref_data = new BigInteger[16];
        Arrays.fill(ref_data, BigInteger.ZERO);

        /* Test loop */
        for (int test_loop = 0; test_loop < 4000; test_loop++) {
            var address = gen_rand.nextInt(0xf) << 6;
            var data = new BigInteger(128, Random.from(gen_rand));

            pwOut.print("[CoupledL2 Test%d]: At address(%#03x), ".formatted(test_loop + 1, address));
            /* Read */
            AcquireBlock(address);
            var r_data = GrantData();
            assert (r_data.equals(ref_data[address >> 6]));

            var sink = dut.master_port_0_0_d_bits_sink.Get().intValue();
            GrantAck(sink);


            /* Write */
            ReleaseData(address, data);
            ref_data[address >> 6] = data;
            ReleaseAck();

            pwOut.println("Read: %s, Write: %s".formatted(r_data.toString(), data.toString()));
            pwOut.flush();
        }
    }
}</code></pre>





  
  


<pre name="group-lang-code-python" class="language-python line-numbers" style="display:none;"><code class="language-python">################ bundle.py ################
from toffee import Bundle, Signals, Signal

class DecoupledBundle(Bundle):
    ready, valid = Signals(2)

class TileLinkBundleA(DecoupledBundle):
    opcode, param, size, source, address, user_alias, mask, data, corrupt = Signals(9)

class TileLinkBundleB(DecoupledBundle):
    opcode, param, size, source, address, mask, data, corrupt = Signals(8)

class TileLinkBundleC(DecoupledBundle):
    opcode, param, size, source, address, user_alias, data, corrupt = Signals(8)

class TileLinkBundleD(DecoupledBundle):
    opcode, param, size, source, sink, denied, data, corrupt = Signals(8)

class TileLinkBundleE(DecoupledBundle):
    sink = Signal()

class TileLinkBundle(Bundle):
    a = TileLinkBundleA.from_regex(r"a_(?:(valid|ready)|bits_(.*))")
    b = TileLinkBundleB.from_regex(r"b_(?:(valid|ready)|bits_(.*))")
    c = TileLinkBundleC.from_regex(r"c_(?:(valid|ready)|bits_(.*))")
    d = TileLinkBundleD.from_regex(r"d_(?:(valid|ready)|bits_(.*))")
    e = TileLinkBundleE.from_regex(r"e_(?:(valid|ready)|bits_(.*))")</code></pre>







  
  


<pre name="group-lang-code-python" class="language-python line-numbers" style="display:none;"><code class="language-python">################ agent.py ################
from toffee import Agent, driver_method
from toffee.triggers import Value
from bundle import TileLinkBundle


class TilelinkOPCodes:
    class A:
        PutFullData = 0x0
        PutPartialData = 0x1
        ArithmeticData = 0x2
        LogicalData = 0x3
        Get = 0x4
        Hint = 0x5
        AcquireBlock = 0x6
        AcquirePerm = 0x7

    class B:
        Probe = 0x8

    class C:
        ProbeAck = 0x4
        ProbeAckData = 0x5
        Release = 0x6
        ReleaseData = 0x7

    class D:
        AccessAck = 0x0
        AccessAckData = 0x1
        HintAck = 0x2
        Grant = 0x4
        GrantData = 0x5
        ReleaseAck = 0x6

    class E:
        GrantAck = 0x4


class TileLinkAgent(Agent):
    def __init__(self, tlbundle: TileLinkBundle):
        super().__init__(tlbundle.step)

        self.tlbundle = tlbundle

    @driver_method()
    async def put_a(self, dict):
        dict["valid"] = 1
        self.tlbundle.a.assign(dict)
        await Value(self.tlbundle.a.ready, 1)
        self.tlbundle.a.valid.value = 0

    @driver_method()
    async def get_d(self):
        self.tlbundle.d.ready.value = 1
        await Value(self.tlbundle.d.valid, 1)
        result = self.tlbundle.d.as_dict()
        self.tlbundle.d.ready.value = 0
        return result

    @driver_method()
    async def get_b(self):
        self.tlbundle.b.ready.value = 1
        await Value(self.tlbundle.b.valid, 1)
        result = self.tlbundle.b.as_dict()
        self.tlbundle.b.ready.value = 0
        return result

    @driver_method()
    async def put_c(self, dict):
        dict["valid"] = 1
        self.tlbundle.c.assign(dict)
        await Value(self.tlbundle.c.ready, 1)
        self.tlbundle.c.valid.value = 0

    @driver_method()
    async def put_e(self, dict):
        dict["valid"] = 1
        self.tlbundle.e.assign(dict)
        await Value(self.tlbundle.e.ready, 1)
        self.tlbundle.e.valid.value = 0

    ################################

    async def aquire_block(self, address):
        await self.put_a(
            {
                "*": 0,
                "size": 0x6,
                "opcode": TilelinkOPCodes.A.AcquireBlock,
                "address": address,
            }
        )

        data = 0x0
        for i in range(2):
            ret = await self.get_d()
            while ret["opcode"] != TilelinkOPCodes.D.GrantData:
                ret = await self.get_d()
            data = (ret["data"] << (256 * i)) | data

        await self.put_e({"sink": ret["sink"]})

        return data

    async def release_data(self, address, data):
        for _ in range(2):
            await self.put_c(
                {
                    "*": 0,
                    "size": 0x6,
                    "opcode": TilelinkOPCodes.C.ReleaseData,
                    "address": address,
                    "data": data % (2**256),
                }
            )
            data = data >> 256

        x = await self.get_d()
        while x["opcode"] != TilelinkOPCodes.D.ReleaseAck:
            x = await self.get_d()</code></pre>




  
  


<pre name="group-lang-code-python" class="language-python line-numbers" style="display:none;"><code class="language-python">################ test.py ################
import toffee
import random
from toffee.triggers import ClockCycles
from CoupledL2 import DUTCoupledL2
from bundle import TileLinkBundle
from agent import TileLinkAgent


async def test_top(dut: DUTCoupledL2):
    toffee.start_clock(dut)

    dut.reset.value = 1
    await ClockCycles(dut, 100)
    dut.reset.value = 0

    tlbundle = TileLinkBundle.from_prefix("master_port_0_0_").bind(dut)
    tlbundle.set_all(0)
    tlagent = TileLinkAgent(tlbundle)

    await ClockCycles(dut, 20)
    ref_data = [0] * 0x10

    for _ in range(4000):
        # Read
        address = random.randint(0, 0xF) << 6
        r_data = await tlagent.aquire_block(address)
        print(f"Read {address} = {hex(r_data)}")
        assert r_data == ref_data[address >> 6]

        # Write
        send_data = random.randint(0, 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF)
        await tlagent.release_data(address, send_data)
        ref_data[address >> 6] = send_data
        print(f"Write {address} = {hex(send_data)}")


if __name__ == "__main__":
    toffee.setup_logging(toffee.INFO)
    dut = DUTCoupledL2(["+verilator+rand+reset+0"])
    dut.InitClock("clock")
    dut.reset.AsImmWrite()

    toffee.run(test_top(dut))

    dut.Finish()</code></pre>



</div>


</div>



    
	
  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">BOSC</span></span><span class="td-footer__all_rights_reserved">保留所有权利</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/mlvp/js/main.min.8bdc707530d61dee3a6fd659f8a422c05d2e2319377a8710175451ca21fa83b0.js" integrity="sha256-i9xwdTDWHe46b9ZZ&#43;KQiwF0uIxk3eocQF1RRyiH6g7A=" crossorigin="anonymous"></script>
<script src='/mlvp/js/prism.js'></script>
<script src='/mlvp/js/tabpane-persist.js'></script>

  </body>
</html>
