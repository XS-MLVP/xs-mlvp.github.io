<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://xs-mlvp.github.io/mlvp/docs/mlvp/">
<link rel="alternate" type="application/rss&#43;xml" href="https://xs-mlvp.github.io/mlvp/docs/mlvp/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/mlvp/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/mlvp/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/mlvp/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/mlvp/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/mlvp/favicons/android-192x192.png" sizes="192x192">

<title>验证框架 | 开放验证平台学习资源</title>
<meta name="description" content="Toffee 是一套基于 Python 的硬件验证框架，帮助用户更加方便、规范地使用 Python 建立起硬件验证环境">
<meta property="og:title" content="验证框架" />
<meta property="og:description" content="Toffee 是一套基于 Python 的硬件验证框架，帮助用户更加方便、规范地使用 Python 建立起硬件验证环境" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://xs-mlvp.github.io/mlvp/docs/mlvp/" />
<meta itemprop="name" content="验证框架">
<meta itemprop="description" content="Toffee 是一套基于 Python 的硬件验证框架，帮助用户更加方便、规范地使用 Python 建立起硬件验证环境"><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="验证框架"/>
<meta name="twitter:description" content="Toffee 是一套基于 Python 的硬件验证框架，帮助用户更加方便、规范地使用 Python 建立起硬件验证环境"/>
<link rel="preload" href="/mlvp/scss/main.min.5e43f8574351718e9b44966c9f3a571202ed048c082f457fb574c10b1a1bc56c.css" as="style" integrity="sha256-XkP4V0NRcY6bRJZsnzpXEgLtBIwIL0V/tXTBCxobxWw=" crossorigin="anonymous">
<link href="/mlvp/scss/main.min.5e43f8574351718e9b44966c9f3a571202ed048c082f457fb574c10b1a1bc56c.css" rel="stylesheet" integrity="sha256-XkP4V0NRcY6bRJZsnzpXEgLtBIwIL0V/tXTBCxobxWw=" crossorigin="anonymous">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/mlvp/css/prism.css"/>

    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?6aacb1c7ca0a3ef4e3aa84c1eaa237dd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4Z2ZY6ZE84"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-4Z2ZY6ZE84');
    </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />

<script>
    $(document).ready(function() {
        $('a[name="multi-lang-toggle"]').on('click', function(event) {
            var language = $(this).attr('lang');
            var codeDiv = $(this).closest('.highlight');
            var preNodes = codeDiv.find('pre');
            preNodes.each(function(index, preNode) {
                if ($(preNode).attr("name").toLowerCase().indexOf(language.toLowerCase()) !== -1) {
                    preNode.style.display = 'block';
                } else {
                    preNode.style.display = 'none';
                }
            });
            var alist = codeDiv.find('a[name="multi-lang-toggle"]');
            alist.each(function(index, aNode) {
                if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                    aNode.style.fontWeight = 'bold';
                } else {
                    aNode.style.fontWeight = 'normal';
                }
            });
        })
        $(this).find('pre[name^="group-lang-code-"]').each(function(index, preNode) {
            if (preNode.style.display !== 'none') {
                var language = $(preNode).attr("name").replace('group-lang-code-', '');
                var alist = $(this).closest('.highlight').find('a[name="multi-lang-toggle"]');
                alist.each(function(index, aNode) {
                    if ($(aNode).attr('lang').toLowerCase() === language.toLowerCase()) {
                        aNode.style.fontWeight = 'bold';
                    } else {
                        aNode.style.fontWeight = 'normal';
                    }
                });
            }
        });
    });
</script>
    
  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/mlvp/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">开放验证平台学习资源</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item dropdown d-none d-lg-block">
        <div class="dropdown">
  <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文</a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="/mlvp/en/docs/mlvp/">English</a></li>
    </ul>
</div></li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    <div class="td-search td-search--offline">
  <div class="td-search__icon"></div>
  <input
    type="search"
    class="td-search__input form-control"
    placeholder="站内搜索…"
    aria-label="站内搜索…"
    autocomplete="off"
    
    data-offline-search-index-json-src="/mlvp/offline-search-index.c5413249454c5b4132bb14194367c00f.json"
    data-offline-search-base-href="/"
    data-offline-search-max-results="10"
  >
</div>
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/mlvp/docs/mlvp/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">验证框架</h1>
<div class="lead">Toffee 是一套基于 Python 的硬件验证框架，帮助用户更加方便、规范地使用 Python 建立起硬件验证环境</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-6b230018a9532ed03844c346cb1ab6b1">快速开始</a></li>


    
  
    
    
	
<li>2: <a href="#pg-b07ce7c9627fc1d6d7c8d73fb5b195f4">编写规范的验证环境</a></li>


    
  
    
    
	
<li>3: <a href="#pg-e77a7d893b67be7260a40bdc5eb52674">搭建验证环境</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-f0ad1b6fbd03350b4038655714fa526a">如何使用异步环境</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-24fbc3c0d43eefa92eb8f640766a6876">如何使用 Bundle</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-d8294406c872c50fb824daf8117b16c4">如何编写 Agent</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-ef7ff8d9b1e4680f7bfedab19681abb5">如何搭建 Env</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-561e9af58bbb529ed50067d0df763d91">如何编写参考模型</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-3c86338d72241e31623b577659ea691b">编写测试用例</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-59f61aa8e02aaee75f4d59274ed9c583">如何使用测试环境接口进行驱动</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-20d016e97daff972eb4b248aee8c24c1">如何使用 Pytest 管理测试用例</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-a072beec952896e88e69f09e9e661bc0">功能检查点（功能覆盖率）</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-218ae6a2d4629a583763e808ab9baf63">开始新的验证任务</a></li>


    
  
    
    
	
<li>6: <a href="#pg-c7e9635323f5bcd8850571649a8a42b8">API 文档</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-bd013f36b484950df4c10662b7c51cde">Bundle API</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p><strong>Toffee</strong> 是使用 Python 语言编写的一套硬件验证框架，它依赖于多语言转换工具 <a href="https://github.com/XS-MLVP/picker">picker</a>，该工具能够将硬件设计的 Verilog 代码转换为 Python Package，使得用户可以使用 Python 来驱动并验证硬件设计。</p>
<p>其吸收了部分 UVM 验证方法学，以保证验证环境的规范性和可复用性，并重新设计了整套验证环境的搭建方式，使其更符合软件领域开发者的使用习惯，从而使软件开发者可以轻易地上手硬件验证工作。</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b230018a9532ed03844c346cb1ab6b1">1 - 快速开始</h1>
    
	<h2 id="安装">安装</h2>
<h3 id="toffee">toffee</h3>
<p><a href="https://github.com/XS-MLVP/toffee">Toffee</a> 是一款基于 Python 的硬件验证框架，旨在帮助用户更加便捷、规范地使用 Python 构建硬件验证环境。它依托于多语言转换工具 <a href="https://github.com/XS-MLVP/picker">picker</a>，该工具能够将硬件设计的 Verilog 代码转换为 Python Package，使得用户可以使用 Python 来驱动并验证硬件设计。</p>
<p>Toffee 需要的依赖有：</p>
<ul>
<li>Python 3.6.8+</li>
<li>Picker 0.9.0+</li>
</ul>
<p>当安装好上述依赖后,可通过pip安装toffee：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install pytoffee
</span></span></code></pre></div><p>或通过以下命令安装最新版本的toffee：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install pytoffee@git+https://github.com/XS-MLVP/toffee@master
</span></span></code></pre></div><p>或通过以下方式进行本地安装：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/XS-MLVP/toffee.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> toffee
</span></span><span style="display:flex;"><span>pip install .
</span></span></code></pre></div><h3 id="toffee-test">toffee-test</h3>
<p><a href="https://github.com/XS-MLVP/toffee-test/tree/master">Toffee-test</a> 是一个用于为 Toffee 框架提供测试支持的 Pytest 插件，他为 toffee 框架提供了将测试用例函数标识为 toffee 的测试用例对象，使其可以被 toffee 框架识别并执行;测试用例资源的管理功能;测试报告生成功能，以便于用户编写测试用例。</p>
<p>通过 pip 安装 toffee-test</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install toffee-test
</span></span></code></pre></div><p>或安装开发版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install toffee-test@git+https://github.com/XS-MLVP/toffee-test@master
</span></span></code></pre></div><p>或通过源码安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/XS-MLVP/toffee-test.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> toffee-test
</span></span><span style="display:flex;"><span>pip install .
</span></span></code></pre></div><h2 id="搭建简单的验证环境">搭建简单的验证环境</h2>
<p>我们使用一个简单的加法器示例来演示 toffee 的使用方法，该示例位于 <code>example/adder</code> 目录下。</p>
<p>加法器的设计如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-verilog" data-lang="verilog"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">module</span> <span style="color:#000">Adder</span> <span style="color:#000;font-weight:bold">#(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">parameter</span> <span style="color:#000">WIDTH</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_a</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_b</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">input</span>              <span style="color:#000">io_cin</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">WIDTH</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">io_sum</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">output</span>             <span style="color:#000">io_cout</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">assign</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">io_cout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">io_sum</span><span style="color:#000;font-weight:bold">}</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">io_a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">io_b</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">io_cin</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">endmodule</span>
</span></span></code></pre></div><p>首先使用 picker 将其转换为 Python Package，再使用 toffee 来为其建立验证环境。安装好依赖后，可以直接在 <code>example/adder</code> 目录下运行以下命令来完成转换：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make dut
</span></span></code></pre></div><p>为了验证加法器的功能，我们使用 toffee 提供的方法来建立验证环境。</p>
<p>首先需要为其创建加法器接口的驱动方法，这里用到了 <code>Bundle</code> 来描述需要驱动的某类接口，<code>Agent</code> 用于编写对该接口的驱动方法。如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_method</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span></code></pre></div><p>我们使用了 <code>driver_method</code> 装饰器来标记 <code>Agent</code> 中用于驱动的方法 <code>exec_add</code>，该方法完成了对加法器的一次驱动操作，每当该方法被调用，其会将输入信号 <code>a</code>、<code>b</code>、<code>cin</code> 的值分别赋给加法器的输入端口，并在下一个时钟周期后读取加法器的输出信号 <code>sum</code> 和 <code>cout</code> 的值并返回。</p>
<p><code>Bundle</code> 是该 <code>Agent</code> 需要驱动的接口的描述。在 <code>Bundle</code> 中提供了一系列的连接方法来连接到 DUT 的输入输出端口。这样一来，我们可以通过此 <code>Agent</code> 完成所有拥有相同接口的 DUT 的驱动操作。</p>
<p>为了验证加法器的功能，我们还需要为其创建一个参考模型，用于验证加法器的输出是否正确。在 toffee 中，我们使用 <code>Model</code> 来定义参考模型。如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;add_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span>
</span></span></code></pre></div><p>在参考模型中，我们同样定义了一个 <code>exec_add</code> 方法，该方法与 <code>Agent</code> 中的 <code>exec_add</code> 方法含有相同的输入参数，我们用程序代码计算出了加法器的标准返回值。我们使用了 <code>driver_hook</code> 装饰器来标记该方法，以便该方法可以与 <code>Agent</code> 中的 <code>exec_add</code> 方法进行关联。</p>
<p>接下来，我们需要创建一个顶层的测试环境，将上述的驱动方法与参考模型相关联，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AdderModel</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>此时，验证环境已经搭建完成，toffee 会自动驱动参考模型并收集结果，并将结果与加法器的输出进行比对。</p>
<p>之后，需要编写测试用例来验证加法器的功能，通过 toffee-test，可以使用如下方式编写测试用例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@toffee_test.testcase</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_random</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">random</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">adder_env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@toffee_test.testcase</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_boundary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">cin</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">a</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">adder_env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以直接在 <code>example/adder</code> 目录下运行以下命令来运行该示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make run
</span></span></code></pre></div><p>运行结束后报告将自动在<code>reports</code>目录下生成。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b07ce7c9627fc1d6d7c8d73fb5b195f4">2 - 编写规范的验证环境</h1>
    
	<h2 id="概述">概述</h2>
<p>一个验证任务编写代码的主体工作可以大致分为两部分，<strong>验证环境的搭建</strong> 和 <strong>测试用例的编写</strong>。</p>
<p><strong>验证环境的搭建</strong> 旨在完成对待测设计（DUT）的封装，使得验证人员在驱动 DUT 时，不必面临繁杂的接口信号，而是可以直接使用验证环境中提供的高级接口。如果需要编写参考模型，则参考模型也应是验证环境的一部分。</p>
<p><strong>测试用例的编写</strong> 则是测试人员使用验证环境提供的接口，编写一个个测试用例，对 DUT 进行功能验证。</p>
<p>搭建验证环境是一件相当有挑战的事情，当 DUT 极度复杂，特别是在接口信号繁多的情况下，搭建验证环境的难度会更大。此时，若没有一个统一的规范，验证环境的搭建将会变得混乱不堪，一个人编写的验证环境很难被其他人维护。并且当出现新的验证任务与原有验证任务有交集时，因为原有的验证环境缺乏规范，很难将原有的验证环境复用。</p>
<p>本节将会介绍一个规范的验证环境所应该具备的特性，这将有助于理解 mlvp 验证环境的搭建流程。</p>
<h2 id="无法复用的验证代码">无法复用的验证代码</h2>
<p>以一个简单的加法器为例，该加法器拥有两个输入端口 <code>io_a</code> 和 <code>io_b</code>，一个输出端口 <code>io_sum</code>。 在没有意识到验证代码可能会被用于其他验证任务的情况下，我们可能会编写出这样的驱动代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span></code></pre></div><p>上述代码中，我们编写了一个 <code>exec_add</code> 方法，该方法本质上是对加法器加法操作的一次高层封装。拥有 <code>exec_add</code> 方法以后，我们无需再关心如何对加法器的接口信号进行赋值，也无需关心怎样驱动加法器并获取其输出，只需要调用 <code>exec_add</code> 方法即可驱动加法器完成一次加法操作。</p>
<p>然而，这个驱动函数却有一个很大的弊端，它直接使用了 DUT 的接口信号来与 DUT 进行交互，这也就意味着，这个驱动函数只能用于这个加法器。</p>
<p>与软件测试不同，在硬件验证中我们每时每刻都能碰到接口结构相同的情况。假设我们拥有另一个具有相同功能的加法器，但其接口信号名称分别是 <code>io_a_0</code>、<code>io_b_0</code> 和 <code>io_sum_0</code>，那么这个驱动函数对这个加法器则直接失效，无法复用。要想驱动，只能重新编写一个新的驱动函数。</p>
<p>一个加法器尚且如此，倘若我们拿到了一个拥有繁杂接口的 DUT，费尽心思为其编写了驱动代码。当后续发现驱动代码需要迁移至另一个相似结构的接口上时，我们将会面临巨大的工作量。例如出现接口名称改变、部分接口缺少但驱动代码中却有引用，部分接口新增等等一系列的问题。</p>
<p>出现这种问题的根本原因在于，我们在验证代码中直接对 DUT 的接口信号进行操作，如下图所示，这种做法是不可取的。</p>
<pre tabindex="0"><code>+-----------+   +-----------+
|           |--&gt;|           |
| Test Code |   |    DUT    |
|           |&lt;--|           |
+-----------+   +-----------+
</code></pre><h2 id="将验证代码与-dut-进行解耦">将验证代码与 DUT 进行解耦</h2>
<p>为了解决上述问题，我们需要将验证代码与 DUT 进行解耦，使得验证代码不再直接操作 DUT 的接口信号，而是通过一个中间层来与 DUT 进行交互。这个中间层是人为定义的一个接口结构，在 toffee 中，我们将这个中间层定义为 <code>Bundle</code>，下文也将会使用 <code>Bundle</code> 来代指这个中间层。</p>
<p>以上述加法器为例，我们可以定义一个 Bundle 结构，其中包含 <code>a</code>, <code>b</code> 和 <code>sum</code> 三个信号，并让测试代码与这个 Bundle 进行直接交互。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span></code></pre></div><p>此时，在 <code>exec_add</code> 中并没有直接操作 DUT 的接口信号，甚至不知道 DUT 中的接口信号名称是什么，其直接与我们在 Bundle 中定义的接口信号进行交互。</p>
<p>那如何让 Bundle 中的信号与 DUT 的引脚进行关联呢？只需要添加一个连接操作即可，最简单的连接方法是，我们直接指定 Bundle 中的每一个信号具体与 DUT 的哪一个引脚相连，例如：</p>
<pre tabindex="0"><code>bundle.a   &lt;-&gt; dut.io_a
bundle.b   &lt;-&gt; dut.io_b
bundle.sum &lt;-&gt; dut.io_sum
</code></pre><p>如果 DUT 的接口信号名称发生了变化，我们只需要修改这个连接过程，例如：</p>
<pre tabindex="0"><code>bundle.a   &lt;-&gt; dut.io_a_0
bundle.b   &lt;-&gt; dut.io_b_0
bundle.sum &lt;-&gt; dut.io_sum_0
</code></pre><p>这样一来，无论 DUT 的接口如何变化，只要其拥有相同的结构，都可以通过原有的驱动代码来驱动，需要修改的仅仅是连接过程。此时的验证代码与 DUT 的关系如下图所示：</p>
<pre tabindex="0"><code>+-----------+  +--------+             +-----------+
|           |-&gt;|        |             |           |
| Test Code |  | Bundle |-- connect --|    DUT    |
|           |&lt;-|        |             |           |
+-----------+  +--------+             +-----------+
</code></pre><p>在 toffee 中，我们为 <code>Bundle</code> 提供了简洁的定义过程以及大量的连接方法，可极大方便中间层的定义与连接，除此之外，<code>Bundle</code> 还提供了大量的实用功能来帮助验证人员更好的与接口信号进行交互。</p>
<h2 id="将-dut-接口进行分类驱动">将 DUT 接口进行分类驱动</h2>
<p>我们已经知道，需要定义一个 <code>Bundle</code> 来完成测试代码与 DUT 之间的解耦，但是如果 DUT 的接口信号过于复杂，我们将会面临一个新的问题————可能只有这一个 DUT 能与这个 <code>Bundle</code> 进行连接。因为我们会定义一个含有众多信号的中间层，将整个 DUT 的引脚全部涵盖在内，这样一来，只有与整个 DUT 结构相同的 DUT 才能与这个 <code>Bundle</code> 进行连接，这个条件是极为苛刻的。</p>
<p>这样一来，中间层的设置也就失去意义了。但我们观察到，每个 DUT 的接口结构往往是有规律的，他们通常由若干个具有独立功能的接口组成。例如 <a href="https://open-verify.cc/mlvp/docs/quick-start/eg-stack-callback/">这里</a> 提到的双端口栈，它的接口则由两个结构完全相同的子接口构成。因此，相比于将整个双端口栈的接口信号全部涵盖在一个 <code>Bundle</code> 中，我们可以将其拆分为两个 <code>Bundle</code>，每个 <code>Bundle</code> 分别对应一个子接口。</p>
<p>并且，对于双端口栈来说，两个子接口的结构是完全相同的，因此我们可以使用同一个 <code>Bundle</code> 来描述这两个子接口，无需重复定义。既然他们拥有同样的 Bundle，那么我们针对这个 Bundle 编写的驱动代码也是完全可以复用的！这就是验证环境可复用性的魅力。</p>
<p>总结一下，对于所有的 DUT 来说，我们应该将其接口信号划分成若干个独立的子接口，每个子接口拥有独立的功能，然后为每个子接口定义一个 <code>Bundle</code>，并编写与这个 <code>Bundle</code> 相关的驱动代码。</p>
<p>此时，我们的验证代码与 DUT 的关系如下图所示：</p>
<pre tabindex="0"><code>+-----------+  +--------+             +-----------+
|           |-&gt;|        |             |           |
| Test Code |  | Bundle |-- connect --|           |
|           |&lt;-|        |             |           |
+-----------+  +--------+             |           |
                                      |           |
     ...           ...                |    DUT    |
                                      |           |
+-----------+  +--------+             |           |
|           |-&gt;|        |             |           |
| Test Code |  | Bundle |-- connect --|           |
|           |&lt;-|        |             |           |
+-----------+  +--------+             +-----------+
</code></pre><p>同时，我们搭建验证环境的思路也变得清晰起来，只需要为分别每个独立的子接口编写高层封装的操作即可。</p>
<h2 id="驱动独立接口的结构">驱动独立接口的结构</h2>
<p>我们为每个 Bundle 都编写了高层封装的操作，这些代码之间相互独立，拥有极高的可复用性。如果我们把不同 Bundle 高层封装之间的交互逻辑都划分出去，放到测试用例中来完成，那么多个 <code>Test Code + Bundle</code> 的组合将会完成对整个 DUT 的驱动环境的搭建。</p>
<p>我们不妨对单个 <code>Test Code + Bundle</code> 的组合起一个名字，在 toffee 中，该结构被称之为 <code>Agent</code>。<code>Agent</code> 独立于 DUT，负责完成对一类接口的所有交互操作。</p>
<p>此时，我们的验证代码与 DUT 的关系如下图所示：</p>
<pre tabindex="0"><code>+---------+    +-----------+
|         |    |           |
|  Agent  |----|           |
|         |    |           |
+---------+    |           |
               |           |
    ...        |    DUT    |
               |           |
+---------+    |           |
|         |    |           |
|  Agent  |----|           |
|         |    |           |
+---------+    +-----------+
</code></pre><p>因此编写驱动环境的过程，就是编写一个个 <code>Agent</code> 的过程。但至此，我们还没有讨论过编写 <code>Agent</code> 的具体规范，如果每个人编写的 <code>Agent</code> 都各不相同，那么验证环境依然会变得较为混乱。</p>
<h2 id="编写规范的-agent">编写规范的 “Agent”</h2>
<p>为了探寻如何编写一个规范的 <code>Agent</code>，我们首先要明白 <code>Agent</code> 主要完成怎样的功能。如上文所述，<code>Agent</code> 中实现了对一类接口的所有交互操作，并提供高层封装。</p>
<p>我们首先来探讨，验证代码究竟会与接口产生怎样的交互，假设验证代码具备读取输入端口的能力，我们可以按照验证代码是否主动发起交互，与接口的方向性来划分为以下几类交互。</p>
<ol>
<li><strong>验证代码主动发起</strong>
<ul>
<li>验证代码主动读取输入/输出端口的值</li>
<li>验证代码主动给输入端口赋值</li>
</ul>
</li>
<li><strong>验证代码被动接收</strong>
<ul>
<li>验证代码被动接收输出/输出端口的值</li>
</ul>
</li>
</ol>
<p>这两类操作涵盖了验证代码侧与接口之间的的所有操作，因此 <code>Agent</code> 也必须具备这两类操作的能力。</p>
<h3 id="验证代码主动发起的交互">验证代码主动发起的交互</h3>
<p>我们首先考虑验证代码主动发起的两类交互，对这两类交互完成高层封装，就要求 <code>Agent</code> 必须具备两种能力：</p>
<ol>
<li>驱动发起者能够将上层语义信息转换为对接口信号的赋值操作</li>
<li>能够将接口信号转换为上层语义信息并返回给发起者</li>
</ol>
<p>能够完成这两类交互的形式有很多。但由于 toffee 是一个基于软件测试语言的验证框架，且我们希望验证代码的编写形式尽量简洁，toffee 中规范了使用 <strong>函数</strong> 为载体来完成这两类交互。</p>
<p>因为函数是编程语言中最基本的抽象单元，输入参数可直接作为上层语义信息并传递给函数体，函数体中通过赋值和读取操作完成上层语义信息与接口信号的转换，最后通过返回值将接口信号转换为上层语义信息并返回给发起者。</p>
<p>toffee 此类用于验证代码主动发起交互的函数称之为<strong>驱动方法</strong>，在 toffee 中，我们使用 <code>driver_method</code> 装饰器来标记此类函数。</p>
<h3 id="验证代码被动接收的交互">验证代码被动接收的交互</h3>
<p>接下来我们考虑验证代码被动接收的交互，并对此类交互完成高层封装。这类交互的呈现形式为，验证代码并不去主动发起对接口的输入输出，而是当满足特定的条件时，接口会将输出信号传递给验证代码。</p>
<p>例如，验证代码想要在 DUT 完成一次操作后，被动获取 DUT 的输出信号并转换为上层语义信息。再如，验证代码想在每一周期都被动获取 DUT 的输出信号并转换为上层语义信息。</p>
<p>与 <code>driver_method</code> 类似，toffee 中同样规范了使用 <strong>函数</strong> 为载体来完成这类交互，只不过这个函数没有输入参数，并且不受验证代码的主动控制。当特定条件满足时，该函数会被调用，完成对接口信号的读取操作，并转换为上层语义信息。该信息会被保存，等待验证代码的使用。</p>
<p>类似的，toffee 将此类用于验证代码被动接收交互的函数称之为<strong>监测方法</strong>，在 toffee 中，我们使用 <code>monitor_method</code> 装饰器来标记此类函数。</p>
<h3 id="一个规范的-agent-结构">一个规范的 “Agent” 结构</h3>
<p>综上所述，我们使用 <strong>函数</strong> 作为载体来完成验证代码与接口的所有交互，并将其分为两类：<strong>驱动方法</strong> 和 <strong>监测方法</strong>。这两类方法分别完成验证代码主动发起的交互和被动接收的交互。</p>
<p>因此，编写 <code>Agent</code>，其实就是编写一系列的驱动方法和检测方法。一个 Agent 编写好之后，也只需要提供其内部驱动方法和检测方法的列表，便能描述整个 <code>Agent</code> 的功能。</p>
<p>一个 <code>Agent</code> 的结构可以使用下图来描述：</p>
<pre tabindex="0"><code>+--------------------+
| Agent              |
|                    |
|   @driver_method   |
|   @driver_method   |
|   ...              |
|                    |
|   @monitor_method  |
|   @monitor_method  |
|   ...              |
|                    |
+--------------------+
</code></pre><h2 id="验证-dut-的功能正确性">验证 DUT 的功能正确性</h2>
<p>目前为止，我们完成了对 DUT 高层操作的封装，并使用函数完成了验证代码与 DUT 之间的交互。此时，为了验证 DUT 的功能是否正确，我们会编写测试用例，通过我们封装好的<strong>驱动方法</strong>来驱动起 DUT 完成特定的执行过程。与此同时，<strong>监测方法</strong> 在自动地被调用并监测收集 DUT 的相关信息。</p>
<p><strong>然而如何去验证 DUT 的功能是否正确呢？</strong></p>
<p>在测试用例中对 DUT 进行驱动后，能够得到 DUT 输出的信息包含两种，一种是通过驱动方法主动获取的信息，另一种是通过检测方法收集到的信息。因此，验证 DUT 的功能是否正确，实际上就是验证这两种信息是否符合预期。</p>
<p><strong>那如何判断这两种信息是否符合预期呢？</strong></p>
<p>一种情况是，我们本来就知道 DUT 的输出应该是什么，或是满足什么样的条件。这时我们在测试用例中拿到这两种信息后，直接对这两种信息（或是其中一种，取决于验证用例的需求）进行检查即可。</p>
<p>另一种情况是，我们并不知道 DUT 的输出应该是什么。此时我们只能编写一个与 DUT 功能相同的 <strong>参考模型(RM, Reference Model)</strong>，当主动发送给 DUT 任何信息时，同时将这些信息主动发送给参考模型。</p>
<p>为了对验证两类信息是否符合预期。当主动获取 DUT 的输出信息是时，同时主动去获取参考模型中的输出信息，并将两者进行比对；当监测方法监测到 DUT 的输出信息时，同时参考模型也应主动提供输出信息，并将两者进行比对。</p>
<p>这便是验证 DUT 功能正确性的两类方法：<strong>直接比对</strong> 和 <strong>参考模型比对</strong>。</p>
<h2 id="如何添加参考模型">如何添加参考模型</h2>
<p>对于直接比对的验证方法，我们直接在测试用例中编写比对逻辑即可。而如果我们使用参考模型的比对方式，测试用例可能会面临一些比较繁琐的步骤：驱动接口的同时，需要将信息同时发送给模型；收集接口信息的同时，需要同时收集模型的信息；对于被动监测的接口信息，还要额外编写逻辑来完成与参考模型的比对。这样一来，测试用例的代码会混乱，与参考模型的交互逻辑会混杂在测试用例中，不利于代码的维护。</p>
<p>我们注意到，对于驱动函数的每一次调用，代表着对 DUT 的每一次操作，这些操作都需要转发给参考模型。而参考模型的编写无需考虑 DUT 接口是怎样驱动的，它只需要分析高层语义信息，并且完成自身状态更新即可，因此参考模型中只需要获取上层发来的高层语义信息（即驱动函数的输入参数）。</p>
<p>所以在参考模型中只需要实现当驱动函数被调用时，如何做出反应即可。对于将调用信息传递给参考模型的操作完全可以交由框架来完成。与此同时，每一次操作的返回值、监测方法的检测值比较，也可以通过框架来自动完成。</p>
<p>这样一来，测试用例中只需要编写驱动 DUT 的逻辑，参考模型的同步与比对工作将会被框架自动完成。</p>
<p>为了实现参考模型的同步，toffee 中定义了一套参考模型的匹配规范，只需要按照此规范编写参考模型调用接口，便可实现参考模型的自动转发与比较。同时为了方便参考模型与整个验证环境相关联，toffee 中提供了 <code>Env</code> 的概念来打包整个验证环境，写好参考模型后，只需要将其与 <code>Env</code> 相关联，便可实现参考模型的自动同步。</p>
<h2 id="总结">总结</h2>
<p>这样一来，我们的验证环境变成了如下的结构：</p>
<pre tabindex="0"><code>+--------------------------------+
| Env                            |
|                  +-----------+ |  +-----------+
|   +---------+    |           | |  |           |
|   |  Agent  |----|           | |-&gt;| Reference |
|   +---------+    |    DUT    | |  |   Model   |
|   +---------+    |           | |&lt;-|           |
|   |  Agent  |----|           | |  |           |
|   +---------+    |           | |  +-----------+
|       ...        +-----------+ |
+--------------------------------+
</code></pre><p>此时，整个验证环境的搭建变得清晰而规范，需要复用时，只需挑选合适的 <code>Agent</code>，连接至 DUT，并打包到 <code>Env</code> 中。需要编写参考模型时，只需要根据 Env 中调用接口规范，实现参考模型的逻辑即可。</p>
<p>测试用例的编写与验证环境是分开的，当测试环境搭建完毕后，测试环境的接口就是每个 Agent 中的调用接口。测试用例可以清晰地使用这些接口来完成驱动逻辑的编写。参考模型的同步及对比工作也将由框架自动完成。</p>
<p>这是 toffee 中验证环境的搭建思想，toffee 中提供了大量的功能，来帮助你建立起这样一个规范的验证环境。同时，它提供了测试用例的管理方法，使得测试用例更易于编写和管理。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e77a7d893b67be7260a40bdc5eb52674">3 - 搭建验证环境</h1>
    
	<p><strong>toffee和toffee-test</strong> 提供了搭建验证环境全流程所需要的方法和工具，本章中将详细介绍如何使用 <strong>toffee和toffee-test</strong> 搭建一个完整的验证环境。</p>
<p>在阅读前请确保您已经阅读了 <a href="/mlvp/docs/mlvp/canonical_env/">如何编写规范的验证环境</a>，并了解了 toffee 规范验证环境的基本结构。</p>
<p>对于一次全新的验证工作来说，按照环境搭建步骤的开始顺序，搭建验证环境可以分为以下几个步骤：</p>
<ol>
<li>按照逻辑功能划分 DUT 接口，并定义 Bundle</li>
<li>为每个 Bundle 编写 Agent，完成对 Bundle 的高层封装</li>
<li>将多个 Agent 封装成 Env，完成对整个 DUT 的高层封装</li>
<li>按照 Env 的接口规范编写参考模型，并将其与 Env 进行绑定</li>
</ol>
<p>本章将会分别介绍每个步骤中如何使用 toffee和toffee-test 中的工具来完成环境搭建需求。</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f0ad1b6fbd03350b4038655714fa526a">3.1 - 如何使用异步环境</h1>
    
	<h2 id="启动事件循环">启动事件循环</h2>
<p>在如前介绍的验证环境中，设计了一套规范的验证环境。但是如果尝试用朴素单线程程序编写，会发现会遇到较为复杂的实现问题。</p>
<p>例如，我们创建了两个驱动方法分别驱动两个接口，在每一个驱动方法内部，都需要等待 DUT 经过若干个时钟周期，并且这两个驱动方法需要同时运行。这时候，如果使用朴素的单线程程序，会发现很难同时让两个驱动方法同时运行，即便我们使用多线程强势使他们同时运行，也会发现缺乏一种机制，使他们能够等待 DUT 经过若干时钟周期。这是因为在 Picker 提供的接口中，我们只能去推动 DUT 向前执行一个周期，而无法去等待 DUT 执行一个周期。</p>
<p>更不用说我们还会遇到有众多环境组件需要同时运行的情况了，因此我们首先需要一个能够运行异步程序的环境。toffee 使用了 Python 的协程来完成对异步程序的管理，其在单线程之上建立了一个事件循环，用于管理多个同时运行的协程，协程之间可以相互等待并通过事件循环来进行切换。</p>
<p>在启动事件循环之前，我们首先需要了解两个关键字 <code>async</code> 和 <code>await</code> 来了解 Python 对与协程的管理。</p>
<p>当我们在函数前加上 <code>async</code> 关键字时，这个函数就变成了一个协程函数，例如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>当我们在协程函数内部使用 <code>await</code> 关键字时，我们就可以执行一个协程函数，并等待其执行完成并返回结果，例如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;my_coro&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_coro2</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>如果不想等待一个协程函数完成，只想将这一函数加入到事件循环中放入后台运行，可以使用 toffee 提供的 <code>create_task</code> 方法，例如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;my_coro&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_coro2</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_task</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>那么如何启动事件循环，并使事件循环开始运行 <code>my_coro2</code> 呢？在 toffee 中，我们使用 <code>toffee.run</code> 来启动事件循环，并运行异步程序。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_coro2</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>toffee 中的环境组件都需要在事件循环中运行，因此当启动 toffee 验证环境时，必须通过 <code>toffee.run</code> 先启动事件循环，然后在事件循环中去创建 toffee 验证环境。</p>
<p>因此，在验证环境创建时，应该以类似如下的方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">start_test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 创建验证环境</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MyEnv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_test</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h2 id="如何管理-dut-时钟">如何管理 DUT 时钟</h2>
<p>正如开头提出的问题，如果我们需要两个驱动方法同时运行，并且在每个驱动方法需要等待 DUT 经过若干个时钟周期。异步环境给予了我们等待某个事件的能力，但 Picker 只提供了推动 DUT 向前执行一个周期的能力，没有有提供一个事件让我们来等待。</p>
<p>toffee 中提供了对这类功能的支持，它通过创建一个后台时钟，来实现对 DUT 进行一个个周期的向前推动，每推动一个周期，后台时钟就会向其他协程发出时钟信号，使得其他协程能够继续执行。因此，DUT 的实际执行周期推动是由后台时钟来完成的，其他协程中只需要等待后台时钟发布的时钟信号即可。</p>
<p>在 toffee 中，通过<code>start_clock</code>来创建后台时钟：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">start_test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MyDUT</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">start_clock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_test</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>只需要在事件循环中调用 <code>start_clock</code> 即可创建后台时钟，它需要一个 DUT 对象作为参数，用于推动 DUT 的执行，以及将时钟信号绑定到 DUT 以及其各个引脚。</p>
<p>在其他协程中，我们可以通过 <code>ClockCycles</code> 来等待时钟信号到来，<code>ClockCycles</code> 的参数可以是 DUT，也可以是 DUT 的每一个引脚。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee.triggers</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">ClockCycles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;10 cycles passed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">start_test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MyDUT</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">start_clock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">my_coro</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_test</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>在 <code>my_coro</code> 中，通过 <code>ClockCycles</code> 来等待 DUT 经过 10 个时钟周期，当 10 个时钟周期经过后，<code>my_coro</code> 就会继续执行，并打印 &ldquo;10 cycles passed&rdquo;。</p>
<p>toffee 中提供了多种等待时钟信号的方法，例如：</p>
<ul>
<li><code>ClockCycles</code> 等待 DUT 经过若干个时钟周期</li>
<li><code>Value</code> 等待 DUT 的某个引脚的值等于某个值</li>
<li><code>AllValid</code> 等待 DUT 的所有引脚的值同时有效</li>
<li><code>Condition</code> 等待某个条件满足</li>
<li><code>Change</code> 等待 DUT 的某个引脚的值发生变化</li>
<li><code>RisingEdge</code> 等待 DUT 的某个引脚的上升沿</li>
<li><code>FallingEdge</code> 等待 DUT 的某个引脚的下降沿</li>
</ul>
<p>更多等待时钟信号的方法，参见 API 文档。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24fbc3c0d43eefa92eb8f640766a6876">3.2 - 如何使用 Bundle</h1>
    
	<p><code>Bundle</code> 在 toffee 验证环境中，用于构建 <code>Agent</code> 与 DUT 之间交互的中间层，以保证 <code>Agent</code> 与 DUT 之间的解耦。同时 <code>Bundle</code> 也起到了对 DUT 接口层次结构划分的作用，使得对 DUT 接口的访问变得更加清晰、方便。</p>
<h2 id="一个简单的-bundle-的定义">一个简单的 Bundle 的定义</h2>
<p>为了定义一个 <code>Bundle</code>，需要自定义一个新类，并继承 toffee 中的 <code>Bundle</code> 类。下面是一个简单的 <code>Bundle</code> 的定义示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Signals</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>该 Bundle 定义了一个简单的加法器接口，在 <code>AdderBundle</code> 类中，我们定义了五个信号 <code>a</code>, <code>b</code>, <code>sum</code>, <code>cin</code>, <code>cout</code>，这五个信号分别代表了加法器的输入端口 <code>a</code>, <code>b</code>，输出端口 <code>sum</code>，以及进位输入端口 <code>cin</code> 和进位输出端口 <code>cout</code>。</p>
<p>定义完成后，我们可以通过 <code>AdderBundle</code> 类的实例来访问这些信号，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="将-dut-绑定到-bundle">将 DUT 绑定到 Bundle</h2>
<p>在上述代码中，我们虽然创建了一个 bundle 实例，并对他进行了驱动，但是我们并没有将这个 bundle 与任何 DUT 绑定，也就意味着对这个 bundle 的操作，无法真正影响到 DUT。</p>
<p>使用 <code>bind</code> 方法，可以将一个 DUT 绑定到 bundle 上。例如我们有一个简单的加法器 DUT，其接口名称与 Bundle 中定义的名称相同。</p>
<pre tabindex="0"><code>adder = DUTAdder()

adder_bundle = AdderBundle()
adder_bundle.bind(adder)
</code></pre><p><code>bind</code> 函数会自动检索 DUT 中所有的接口，并将名称相同的接口进行绑定。绑定完成后，对 bundle 的操作，就会直接影响到 DUT。</p>
<p>但是，如果 DUT 的接口名称与 Bundle 中定义的名称不同，直接使用 <code>bind</code> 则无法正确绑定。在 Bundle 中，我们提供多种绑定方法，以适应不同的绑定需求。</p>
<h3 id="通过字典进行绑定">通过字典进行绑定</h3>
<p>在 <code>bind</code> 函数中，我们可以通过传入一个字典，来指定 DUT 中的接口名称与 Bundle 中的接口名称之间的映射关系。</p>
<p>假设 Bundle 中的接口名称与 DUT 中的接口名称拥有如下对应关系：</p>
<pre tabindex="0"><code>a    -&gt; a_in
b    -&gt; b_in
sum  -&gt; sum_out
cin  -&gt; cin_in
cout -&gt; cout_out
</code></pre><p>在实例化 <code>bundle</code> 时，我们可以通过 <code>from_dict</code> 方法创建，并传入一个字典，告知 <code>Bundle</code> 以字典的方式进行绑定。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_dict</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;a_in&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;b_in&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;sum&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;sum_out&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;cin_in&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;cout&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;cout_out&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>此时，<code>adder_bundle</code> 可正确绑定至 <code>adder</code>。</p>
<h3 id="通过前缀进行绑定">通过前缀进行绑定</h3>
<p>假设 DUT 中的接口名称与 Bundle 中的接口名称拥有如下对应关系：</p>
<pre tabindex="0"><code>a    -&gt; io_a
b    -&gt; io_b
sum  -&gt; io_sum
cin  -&gt; io_cin
cout -&gt; io_cout
</code></pre><p>可以发现，实际 DUT 的接口名称相比于 Bundle 中的接口名称，都多了一个 <code>io_</code> 的前缀。在这种情况下，我们可以通过 <code>from_prefix</code> 方法创建 <code>Bundle</code>，并传入前缀名称，告知 <code>Bundle</code> 以前缀的方式进行绑定。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;io_&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="通过正则表达式进行绑定">通过正则表达式进行绑定</h3>
<p>在某些情况下，DUT 中的接口名称与 Bundle 中的接口名称之间的对应关系并不是简单的前缀或者字典关系，而是更为复杂的规则。例如，DUT 中的接口名称与 Bundle 中的接口名称之间的对应关系为：</p>
<pre tabindex="0"><code>a    -&gt; io_a_in
b    -&gt; io_b_in
sum  -&gt; io_sum_out
cin  -&gt; io_cin_in
cout -&gt; io_cout_out
</code></pre><p>在这种情况下，我们可以通过传入正则表达式，来告知 <code>Bundle</code> 以正则表达式的方式进行绑定。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_regex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">r</span><span style="color:#4e9a06">&#39;io_(.*)_.*&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>使用正则表达式时，Bundle 会尝试将 DUT 中的接口名称与正则表达式进行匹配，匹配成功的接口，将会读取正则表达式中的所有捕获组，将其连接为一个字符串。再使用这个字符串与 Bundle 中的接口名称进行匹配。</p>
<p>例如对于上面代码中的正则表达式，<code>io_a_in</code> 会与正则表达式成功匹配，唯一的捕获组捕获到的内容为 <code>a</code>。<code>a</code> 这个名称与 Bundle 中的接口名称 <code>a</code> 匹配，因此 <code>io_a_in</code> 会被正确绑定至 <code>a</code>。</p>
<h2 id="创建子-bundle">创建子 Bundle</h2>
<p>很多时候，我们会需要一个 Bundle 包含一个或多个其他 Bundle 的情况，这时我们可以将其他已经定义好的 Bundle 作为当前 Bundle 的子 Bundle。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Signal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Signals</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MultiplierBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ArithmeticBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">selector</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signal</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">adder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;add_&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">multiplier</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MultiplierBundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;mul_&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>在上面的代码中，我们定义了一个 <code>ArithmeticBundle</code>，它包含了自己的信号 <code>selector</code>。除此之外它还包含了一个 <code>AdderBundle</code> 和一个 <code>MultiplierBundle</code>，这两个子 Bundle 分别被命名为 <code>adder</code> 和 <code>multiplier</code>。</p>
<p>当我们需要访问 <code>ArithmeticBundle</code> 中的子 Bundle 时，可以通过 <code>.</code> 运算符来访问：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ArithmeticBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">selector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">multiplier</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">multiplier</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span></code></pre></div><p>同时，当我们以这种定义方式进行定义后，在最顶层的 Bundle 进行绑定时，会同时将子 Bundle 也绑定到 DUT 上，在定义子 Bundle 时，依然可以使用前文提到的多种绑定方式。</p>
<p>需要注意的是，子 Bundle 的创建方法去匹配的信号名称，是经过上一次 Bundle 的创建方法进行处理过后的名称。例如在上面的代码中，我们将顶层 Bundle 的匹配方式设置为 <code>from_prefix('io_')</code>，那么在 <code>AdderBundle</code> 中去匹配的信号，是去除了 <code>io_</code> 前缀后的名称。</p>
<p>同时，字典匹配方法会将信号名称转换为字典映射后的名称传递给子 Bundle 进行匹配，正则表达式匹配方法会将正则表达式捕获到的名称传递给子 Bundle 进行匹配。</p>
<h2 id="bundle-中的实用操作">Bundle 中的实用操作</h2>
<h3 id="信号访问与赋值">信号访问与赋值</h3>
<p><strong>访问信号值</strong></p>
<p>在 Bundle 中，我们不仅可以通过 <code>.</code> 运算符来访问 Bundle 中的信号，也可以通过 <code>[]</code> 运算符来访问 Bundle 中的信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p><strong>访问未连接信号</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unconnected_signal_access</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>在 <code>bind</code> 时，我们可以通过传入 <code>unconnected_signal_access</code> 参数来控制是否允许访问未连接的信号。默认为 <code>True</code>，即允许访问未连接的信号，此时当写入该信号时，该信号不会发生变化，当读取该信号时，会返回 <code>None</code>。 当 <code>unconnected_signal_access</code> 为 <code>False</code> 时，访问未连接的信号会抛出异常。</p>
<p><strong>同时赋值所有信号</strong></p>
<p>可以通过 <code>set_all</code> 方法同时将所有输入信号更改为某个值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set_all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>随机赋值所有信号</strong></p>
<p>可以通过 <code>randomize_all</code> 方法随机赋值所有信号。&ldquo;value_range&rdquo; 参数用于指定随机值的范围，&ldquo;exclude_signals&rdquo; 参数用于指定不需要随机赋值的信号，&ldquo;random_func&rdquo; 参数用于指定随机函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">randomize_all</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>信号赋值模式更改</strong></p>
<p>信号赋值模式是 <code>picker</code> 中的概念，用于控制信号的赋值方式，请查阅 <code>picker</code> 文档以了解更多信息。</p>
<p>Bundle 中支持通过 <code>set_write_mode</code> 来改变整个 Bundle 的赋值模式。</p>
<p>同时，Bundle 提供了设置的快捷方法：<code>set_write_mode_as_imme</code>, <code>set_write_mode_as_rise</code> 与 <code>set_write_mode_as_fall</code>，分别用于设置 Bundle 的赋值模式为立即赋值、上升沿赋值与下降沿赋值。</p>
<h3 id="消息支持">消息支持</h3>
<p><strong>默认消息类型赋值</strong></p>
<p>toffee 支持一个默认的消息类型，可以通过 <code>assign</code> 方法将一个字典赋值给 Bundle 中的信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>Bundle 将会自动将字典中的值赋值给对应的信号，当需要将未指定的信号赋值成某个默认值时，可以通过 <code>*</code> 来指定默认值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p><strong>子 Bundle 的默认消息赋值支持</strong></p>
<p>如果希望通过默认消息类型同时赋值子 Bundle 中的信号，可以通过两种方式实现。当 <code>assign</code> 中的 <code>multilevel</code> 参数为 <code>True</code> 时，Bundle 支持多级字典赋值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;selector&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">multilevel</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>当 <code>multilevel</code> 为 <code>False</code> 时，Bundle 支持通过 <code>.</code> 来指定子 Bundle 的赋值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">({</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;selector&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder.cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier.a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier.b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">multilevel</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>默认消息类型读取</strong></p>
<p>在 Bundle 中可以使用，<code>as_dict</code> 方法将 Bundle 当前的信号值转换为字典。其同样支持两种格式，当 <code>multilevel</code> 为 <code>True</code> 时，返回多级字典；当 <code>multilevel</code> 为 <code>False</code> 时，返回扁平化的字典。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">as_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">multilevel</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;selector&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;sum&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;cout&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#39;product&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">arithmetic_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">as_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">multilevel</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;selector&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder.a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder.b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder.sum&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder.cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;adder.cout&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier.a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier.b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;multiplier.product&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>自定义消息类型</strong></p>
<p>在我们自定义的消息结构中，可以执行规则将其赋值给 Bundle 中的信号。</p>
<p>一种方法是，在自定义消息结构中，实现 <code>as_dict</code> 函数，将自定义消息结构转换为字典，然后通过 <code>assign</code> 方法赋值给 Bundle。</p>
<p>另一种方法是，在自定义消息结构中，实现 <code>__bundle_assign__</code> 函数，其接收一个 Bundle 实例，将自定义消息结构赋值给 Bundle。实现后，可以通过 <code>assign</code> 方法赋值给 Bundle，Bundle 将会自动调用 <code>__bundle_assign__</code> 函数进行赋值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyMessage</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__bundle_assign__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">my_message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MyMessage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_message</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>当需要将 Bundle 中的信号值转换为自定义消息结构时，简易在自定义消息结构中实现 <code>from_bundle</code> 的类方法，接收一个 Bundle 实例，返回一个自定义消息结构。在创建自定义消息结构时，可以通过 <code>from_bundle</code> 方法将 Bundle 中的信号值转换为自定义消息结构。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyMessage</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">from_bundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">message</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">my_message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MyMessage</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">from_bundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="时序封装">时序封装</h3>
<p>Bundle 类除了对 DUT 的引脚进行封装外，还提供了基于数组的时序封装，可以适用于部分简单时序场景。Bundle 类提供了<code>process_requests(data_list)</code>函数，他接受一个数组输入，第<code>i</code>个时钟周期，会将<code>data_list[i]</code>对应的数据赋值给引脚。<code>data_list</code>中的数据可以是<code>dict</code>类型，或者<code>callable(cycle, bundle_ins)</code>类型的可调用对象。对于<code>dict</code>类型，特殊<code>key</code>有：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>__funcs__: func<span style="color:#ce5c00;font-weight:bold">(</span>cycle, self<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 可调用对象，可以为函数数组[f1,f2,..]</span>
</span></span><span style="display:flex;"><span>__condition_func__:  func<span style="color:#ce5c00;font-weight:bold">(</span>cycle, slef, cargs<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 条件函数，当改函数返回为true时，进行赋值，否则继续推进时钟</span>
</span></span><span style="display:flex;"><span>__condition_args__:  cargs <span style="color:#8f5902;font-style:italic"># 条件函数需要的参数</span>
</span></span><span style="display:flex;"><span>__return_bundles__:  bundle <span style="color:#8f5902;font-style:italic"># 需要本次dict赋值时返回的bundle数据，可以是list[bundle]</span>
</span></span></code></pre></div><p>如果输入的<code>dict</code>中有<code>__return_bundles__</code>，则函数会返回该输入对应的 bundle 值，例如<code>{&quot;data&quot;: x, &quot;cycle&quot;: y}</code>。以 Adder 为例，期望第三次加后返回结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Adder虽然为存组合逻辑，但此处当时序逻辑使用</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>             <span style="color:#8f5902;font-style:italic"># 指定引脚</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># init clock</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># dut.InitClock(&#34;clock&#34;)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>                            <span style="color:#8f5902;font-style:italic"># 绑定到dut</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">add_list</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data_list</span> <span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">[(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">),(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)]):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># make input dit</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">enumerate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data_list</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">}</span>             <span style="color:#8f5902;font-style:italic"># 构建budle赋值的dict</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;__return_bundles__&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span>    <span style="color:#8f5902;font-style:italic"># 设置需要返回的bundle</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">X</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">process_requests</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>        <span style="color:#8f5902;font-style:italic"># 推动时钟，赋值，返回结果</span>
</span></span></code></pre></div><p>当调用<code>add_list()</code>后，返回的结果为:</p>
<pre tabindex="0"><code class="language-pthon" data-lang="pthon">[
  {&#34;data&#34;: {&#34;a&#34;:5, &#34;b&#34;:6, &#34;cin&#34;: 0, &#34;sum&#34;:11, &#34;cout&#34;: 0}, &#34;cycle&#34;:3},
  {&#34;data&#34;: {&#34;a&#34;:7, &#34;b&#34;:8, &#34;cin&#34;: 0, &#34;sum&#34;:15, &#34;cout&#34;: 0}, &#34;cycle&#34;:4}
]
</code></pre><h3 id="异步支持">异步支持</h3>
<p>在 Bundle 中，为了方便的接收时钟信息，提供了 <code>step</code> 函数。当 Bundle 连接至 DUT 的任意一个信号时，step 函数会自动同步至 DUT 的时钟信号。</p>
<p>可以通过 <code>step</code> 函数来完成时钟周期的等待。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">adder_process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="信号连接">信号连接</h3>
<p><strong>信号连接规则</strong></p>
<p>当定义好 Bundle 实例后，可以调用 <code>all_signals_rule</code> 方法，获取所有信号的连接规则，以帮助用户检查信号的连接规则是否符合预期。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">all_signals_rule</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>信号可连接性检查</strong></p>
<p><code>detect_connectivity</code> 方法可以检查一个特定的信号名称是否可以连接到该 Bundle 中的某个信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">detect_connectivity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;io_a&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>detect_specific_connectivity</code> 方法可以检查一个特定的信号名称是否可以连接到该 Bundle 中的某个特定的信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">detect_specific_connectivity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;io_a&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>如果需要检测子 Bundle 的信号连接性，可以通过 <code>.</code> 运算符来指定。</p>
<h3 id="dut-信号连接检查">DUT 信号连接检查</h3>
<p><strong>未连接信号检查</strong></p>
<p><code>detect_unconnected_signals</code> 方法可以检查 DUT 中未连接到任何 Bundle 的信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">Bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">detect_unconnected_signals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>重复连接检查</strong></p>
<p><code>detect_multiple_connections</code> 方法可以检查 DUT 中同时连接到多个 Bundle 的信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">Bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">detect_multiple_connections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="其他实用操作">其他实用操作</h3>
<p><strong>设置 Bundle 名称</strong></p>
<p>可以通过 <code>set_name</code> 方法设置 Bundle 的名称。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set_name</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;adder&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>设置名称之后，将会得到更加直观的提示信息。</p>
<p><strong>获取 Bundle 中所有信号</strong></p>
<p><code>all_signals</code> 信号会返回一个 generator，其中包含了包括子 Bundle 信号在内的所有信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">signal</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">adder_bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">all_signals</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="bundle-的自动生成脚本">Bundle 的自动生成脚本</h2>
<p>在很多情况下，DUT 的接口可能过于复杂，手动去编写 Bundle 的定义会变得非常繁琐。然而，Bundle 作为中间层，提供一个确切的信号名称定义是必要的。为了解决这个问题，toffee 提供了一个自动生成 Bundle 的脚本来从 DUT 的接口定义中生成 Bundle 的定义。</p>
<p>可以在 toffee 仓库目录下的 <code>scripts</code> 文件夹中找到 <code>bundle_code_gen.py</code> 脚本。该脚本可以通过解析 DUT 实例，以及指定的绑定规则自动生成 Bundle 的定义。</p>
<p>其中提供了三个函数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">gen_bundle_code_from_regex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle_name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">regex</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_width</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">120</span><span style="color:#000;font-weight:bold">):</span>
</span></span></code></pre></div><p>分别用于通过字典、前缀、正则表达式的方式生成 Bundle 的定义。</p>
<p>使用时，指定 Bundle 的名称，DUT 实例，以及对应的生成规则便可生成 Bundle 的定义，还可以通过 <code>max_width</code> 参数来指定生成的代码的最大宽度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">bundle_code_gen</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">gen_bundle_code_from_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;AdderBundle&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;a&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;io_a&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;b&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;io_b&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;sum&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;io_sum&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;cin&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;io_cin&#39;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#39;cout&#39;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;io_cout&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">gen_bundle_code_from_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;AdderBundle&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;io_&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">gen_bundle_code_from_regex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;AdderBundle&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dut</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">r</span><span style="color:#4e9a06">&#39;io_(.*)&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>生成好的代码可以直接或经过简单的修改后，复制到代码中使用。也可以作为子 Bundle 的定义，应用到其他 Bundle 中。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d8294406c872c50fb824daf8117b16c4">3.3 - 如何编写 Agent</h1>
    
	<p><code>Agent</code> 在 toffee 验证环境中实现了对一类 <code>Bundle</code> 中信号的高层封装，使得上层驱动代码可以在不关心具体信号赋值的情况下，完成对 Bundle 中信号的驱动及监测。</p>
<p>一个 <code>Agent</code> 由 <strong>驱动方法(driver_method)</strong> 和 <strong>监测方法(monitor_method)</strong> 组成，其中驱动方法用于主动驱动 <code>Bundle</code> 中的信号，而监测方法用于被动监测 <code>Bundle</code> 中的信号。</p>
<h2 id="初始化-agent">初始化 Agent</h2>
<p>为了定义一个 <code>Agent</code>，需要自定义一个新类，并继承 toffee 中的 <code>Agent</code> 类。下面是一个简单的 <code>Agent</code> 的定义示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee.agent</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span>
</span></span></code></pre></div><p>在 <code>AdderAgent</code> 类初始化时，需要外界传入该 Agent 需要驱动的 Bundle，并且需要向父类 <code>Agent</code> 中传入一个时钟同步函数，以便 <code>Agent</code> 使用这一函数来决定何时调用监测方法。一般来说，可以将其设置为 <code>bundle.step</code>，即 <code>Bundle</code> 中的时钟同步函数，<code>Bundle</code> 中的 step 与 DUT 中的时钟同步。</p>
<h2 id="创建驱动方法">创建驱动方法</h2>
<p>在 <code>Agent</code> 中，驱动方法是一个异步函数，用于主动驱动 <code>Bundle</code> 中的信号。驱动函数需要将函数的传入参数进行解析，并根据解析结果对 <code>Bundle</code> 中的信号进行赋值，赋值的过程可以跨越多个时钟周期。如果需要获取 Bundle 的信号值，那么在函数中编写相应的逻辑，并将其转换为需要的数据，通过函数返回值返回。</p>
<p>每一个驱动方法都应是一个异步函数，并且使用 <code>@driver_method</code> 装饰器进行修饰，以便 <code>Agent</code> 能够识别该函数为驱动方法。</p>
<p>下面是一个简单的驱动方法的定义示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee.agent</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_method</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cin</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cin</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cin</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cout</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span>
</span></span></code></pre></div><p>在 <code>drive</code> 函数中，我们将传入的 <code>a</code>, <code>b</code>, <code>cin</code> 三个参数分别赋值给 <code>Bundle</code> 中的 <code>a</code>, <code>b</code>, <code>cin</code> 信号，并等待一个时钟周期。在时钟周期结束后，我们返回 <code>Bundle</code> 中的 <code>sum</code>, <code>cout</code> 信号值。</p>
<p>在驱动函数的编写过程中，你可以使用 <a href="/mlvp/docs/mlvp/env/start_test/">如何使用异步环境</a> 中介绍的所有等待时钟信号的同步方法，例如 <code>ClockCycles</code>, <code>Value</code> 等。</p>
<p>创建完毕后，你可以像调用普通函数一样在驱动代码中调用该驱动方法，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">adder_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cout</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>被标识为 <code>@driver_method</code> 的函数在调用时拥有诸多特性，这一部分将在编写测试用例中详细介绍。同时，该类函数还会完成参考模型的匹配与自动调用以返回值对比，这一部分将在编写参考模型中详细介绍。</p>
<h2 id="创建监测方法">创建监测方法</h2>
<p>监测方法同样需要是一个异步函数，并且使用 <code>@monitor_method</code> 装饰器进行修饰，以便 <code>Agent</code> 能够识别该函数为监测方法。</p>
<p>一个简单的监测方法的定义示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee.agent</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bundle</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@monitor_method</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">monitor_sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">as_dict</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>在 <code>monitor_sum</code> 函数中，我们以 Bundle 中的 sum 信号作为监测对象，当 sum 信号的值大于 0 时，收集 Bundle 生成的默认消息类型，收集到的返回值将会被存储到内部的消息队列中。</p>
<p>添加 <code>monitor_method</code> 装饰器后，<code>monitor_sum</code> 函数将会被 <code>Agent</code> 自动调用，它会使用 <code>Agent</code> 初始化时提供的时钟同步函数来决定何时调用监测方法。默认情况下，<code>Agent</code> 会在每个时钟周期都调用一次监测方法，如果监测方法有返回值，那么返回值将会被存储到内部的消息队列中。若监测方法的一次调用会经过多个时钟周期，<code>Agent</code> 会等待上一次监测方法调用结束后再次调用监测方法。</p>
<p>如果编写了类似下面的监测方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@monitor_method</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">monitor_sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">bundle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">as_dict</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>该监测方法将会在每个周期都往消息队列中添加一个消息。</p>
<p><strong>获取监测消息</strong></p>
<p>由于该监测方法被标记为了 <code>@monitor_method</code>，因此该方法将会被 <code>Agent</code> 自动调用，在测试用例中如果按照以下方式直接调用该函数，并不能执行该函数的预期行为。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">adder_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">adder_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">adder_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">monitor_sum</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>相反的，按照上述方式调用监测方法，它将会弹出消息队列中收集到的最早的消息，并返回该消息。如果消息队列为空，该次调用将会等待消息队列中有消息后再返回。</p>
<p>如果想获取消息队列中的消息数量，可以使用如下方式获取：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">message_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">adder_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">monitor_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;monitor_sum&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过创建监测方法，你可以方便地添加一个后台监测任务，监测 <code>Bundle</code> 中的信号值，并在满足条件时收集消息。将函数标记为监测方法后，框架还会为这一方法提供与参考模型的匹配与自动收集对比，这一部分将在编写参考模型中详细介绍。</p>
<p>通过在 Agent 中编写多个驱动方法和监测方法，便完成了整个 <code>Agent</code> 的编写。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ef7ff8d9b1e4680f7bfedab19681abb5">3.4 - 如何搭建 Env</h1>
    
	<p><code>Env</code> 在 toffee 验证环境中用于打包整个验证环境，Env 中直接实例化了验证环境中需要用的所有 agent，并负责将这些 Agent 需要的 bundle 传递给它们。</p>
<p>创建好 Env 后，参考模型的编写规范也随之确定，按照此规范编写的参考模型可直接附加到 Env 上，由 Env 来完成参考模型的自动同步。</p>
<h2 id="创建-env">创建 Env</h2>
<p>为了定义一个 <code>Env</code>，需要自定义一个新类，并继承 toffee 中的 <code>Env</code> 类。下面是一个简单的 <code>Env</code> 的定义示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee.env</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">DualPortStackEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port1_bundle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port2_bundle</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">StackAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port1_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">StackAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port2_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>在这个例子中，我们定义了一个 <code>DualPortStackEnv</code> 类，该类中实例化了两个相同的 <code>StackAgent</code>，分别用于驱动两个不同的 <code>Bundle</code>。</p>
<p>可以选择在 Env 之外连接 Bundle，也可以在 Env 内部连接 Bundle，只要能保证向 Agent 中传入正确的 Bundle 即可。</p>
<p>此时，如果不需要编写额外的参考模型，那么整个验证环境的搭建就完成了，可以直接编写测试用例并且在测试用例中使用 Env 提供的接口，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">port1_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">StackPortBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">port2_bundle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">StackPortBundle</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DualPortStackEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port1_bundle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port2_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h2 id="附加参考模型">附加参考模型</h2>
<p>定义好 Env 后，整个验证环境的接口也就随之确定，例如：</p>
<pre tabindex="0"><code>DualPortStackEnv
  - port1_agent
    - @driver_method push
    - @driver_method pop
    - @monitor_method some_monitor
  - port2_agent
    - @driver_method push
    - @driver_method pop
    - @monitor_method some_monitor
</code></pre><p>按照此规范编写的参考模型都可以直接附加到 Env 上，由 Env 来完成参考模型的自动同步，方式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DualPortStackEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">port1_bundle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port2_bundle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>一个 Env 可以附加多个参考模型，这些参考模型都将会被 Env 自动同步。</p>
<p>参考模型的具体编写方式将在编写参考模型一节中详细介绍。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-561e9af58bbb529ed50067d0df763d91">3.5 - 如何编写参考模型</h1>
    
	<p><code>参考模型</code> 用于模拟待验证设计的行为，以便在验证过程中对设计进行验证。在 toffee 验证环境中，参考模型需要遵循 <code>Env</code> 的接口规范，以便能够附加到 <code>Env</code> 上，由 <code>Env</code> 来完成参考模型的自动同步。</p>
<h2 id="参考模型的两种实现方式">参考模型的两种实现方式</h2>
<p>toffee 提供了两种参考模型的实现方式，这两种方式都可以被附加到 <code>Env</code> 上，并由 <code>Env</code> 来完成参考模型的自动同步。在不同的场景下，可以选择更适合的方式来实现参考模型。</p>
<p>这两种方式分别是 <strong>函数调用模式</strong> 与 <strong>独立执行流模式</strong>，下面将分别介绍这两种方式的具体概念。</p>
<h3 id="函数调用模式">函数调用模式</h3>
<p><strong>函数调用模式</strong>即是将参考模型的对外接口定义为一系列的函数，通过调用这些函数来驱动参考模型的行为。此时，我们通过输入参数向参考模型发送数据，并通过返回值获取参考模型的输出数据，参考模型通过函数体的逻辑来更新内部状态。</p>
<p>下面是一个简单的函数调用模式的参考模型的定义示例：</p>
<p>例如，这是一个简单的加法器参考模型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderRefModel</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span>
</span></span></code></pre></div><p>在这个参考模型中，不需要任何内部状态，通过一个对外函数接口即可实现参考模型所有功能。</p>
<p>需要注意的是，使用函数调用模式编写的参考模型，只能通过外部主动调用的方式来执行，无法被动输出内部数据。因此，其无法与 Agent 中的监测方法进行匹配。在 Agent 中编写监测方法，在函数调用模式编写参考模型时是没有意义的。</p>
<h3 id="独立执行流模式">独立执行流模式</h3>
<p><strong>独立执行流模式</strong>即是将参考模型的行为定义为一个独立的执行流，它不再受外部主动调用函数控制，而拥有了主动获取输入数据和主动输出数据的能力。当外部给参考模型发送数据时，参考模型不会立即响应，而是将这一数据保存起来，等待其执行逻辑主动获取该数据。</p>
<p>我们用一段代码来说明这种模式，该示例中用到了 toffee 中提供的相关概念来实现，但目前无需关心这些概念的使用细节。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AdderRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DriverPort</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MonitorPort</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">operands</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_port</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">operands</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">operands</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sum_port</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>在这里，我们在参考模型构造函数中定义了两类接口，一类为<strong>驱动接口(DriverPort)</strong>，即代码中的<code>add_port</code>，用于接收外部输入数据；另一类为<strong>监测接口(MonitorPort)</strong>，即代码中的<code>sum_port</code>，用于向外部输出数据。</p>
<p>定义了这两个接口后，上层代码在给参考模型发送数据时，并不会触发参考模型中的某个函数，而是会将数据发送到 <code>add_port</code> 这个驱动接口中。同时，上层代码也无法主动获取到参考模型的输出数据了。参考模型的输出数据会通过 <code>sum_port</code> 这个监测接口，由参考模型主动输出。</p>
<p>那么参考模型如何去使用这两个接口呢？在参考模型中，有一个 main 函数，这是参考模型执行的入口，当参考模型创建时, main 函数会被自动调用，并在后台持续运行。在上面代码中 main 函数里，参考模型通过不断重复这一过程：等待 <code>add_port</code> 中的数据、计算结果、将结果输出到 <code>sum_port</code> 中 来实现参考模型的行为。</p>
<p>参考模型会主动向 <code>add_port</code> 请求数据，如果 <code>add_port</code> 中没有数据，参考模型会等待数据的到来。当数据到来后，参考模型将会进行计算，将计算结果主动的输出到 <code>sum_port</code> 中。它的执行过程是一个独立的执行流，不受外部的主动调用控制。当参考模型变得复杂时，其将会含有众多的驱动接口和监测接口，通过独立执行流的方式，可以更好的去处理结构之间的相互关系，尤其是接口之间存在调用顺序的情况。</p>
<h2 id="如何编写函数调用模式的参考模型">如何编写函数调用模式的参考模型</h2>
<h3 id="驱动函数匹配">驱动函数匹配</h3>
<p>假如 Env 中定义的接口如下：</p>
<pre tabindex="0"><code>StackEnv
  - port_agent
    - @driver_method push
    - @driver_method pop
</code></pre><p>那么如果我们想要编写与之对应的参考模型，自然地，我们需要定义这四个驱动函数被调用时参考模型的行为。也就是说为每一个驱动函数编写一个对应的函数，这些函数将会在驱动函数被调用时被框架自动调用。</p>
<p>如何让参考模型中定义的函数能够与某个驱动函数匹配呢？首先应该使用 <code>@driver_hook</code> 装饰器来表示这个函数是一个驱动函数的匹配函数。接着，为了建立对应关系，我们需要在装饰器中指定其对应的 Agent 和驱动函数的名称。最后，只需要保证函数的参数与驱动函数的参数一致，两个函数便能够建立对应关系。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">driver_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;push&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">driver_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;pop&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p>此时，驱动函数与参考模型的对应关系已经建立，当 Env 中的某个驱动函数被调用时，参考模型中对应的函数将会被自动调用，并自动对比两者的返回值是否一致。</p>
<p>toffee 还提供了以下几种匹配方式，以便更好地匹配驱动函数：</p>
<p><strong>指定驱动函数路径</strong></p>
<p>可以通过 &ldquo;.&rdquo; 来指定驱动函数的路径，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;port_agent.push&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;port_agent.pop&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p><strong>使用函数名称匹配驱动函数名称</strong></p>
<p>如果参考模型中的函数名称与驱动函数名称相同，可以省略 <code>driver_name</code> 参数，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p><strong>使用函数名称同时匹配 Agent 名称与驱动函数名称</strong></p>
<p>可以在函数名中通过双下划线 &ldquo;__&rdquo; 来同时匹配 Agent 名称与驱动函数名称，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">port_agent__push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@driver_hook</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">port_agent__pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><h3 id="agent-匹配">Agent 匹配</h3>
<p>除了对 Agent 中每一个驱动函数都编写一个 <code>driver_hook</code> 之外，还可以通过 <code>@agent_hook</code> 装饰器来一次性匹配 Agent 中的所有驱动函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@agent_hook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">port_agent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">driver_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p>在这个例子中，<code>port_agent</code> 函数将会匹配 <code>port_agent</code> Agent 中的所有驱动函数，当 Agent 中的任意一个驱动函数被调用时，<code>port_agent</code> 函数将会被自动调用。除了 self 之外，<code>port_agent</code> 函数还需接受且只接受两个参数，第一个参数为驱动函数的名称，第二个参数为驱动函数的参数。</p>
<p>当某个驱动函数被调用时，driver_name 参数将会传入驱动函数的名称，args 参数将会传入该该驱动函数被调用时的参数，参数将会以字典的形式传入。port_agent 函数可以根据 driver_name 和 args 来决定如何处理这个驱动函数的调用，并将结果返回。此时框架将会使用此函数的返回值与驱动函数的返回值进行对比。</p>
<p>与驱动函数类似，<code>@agent_hook</code> 装饰器也支持当函数名与 Agent 名称相同时省略 <code>agent_name</code> 参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@agent_hook</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">port_agent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">driver_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p><strong>agent_hook 与 driver_hook 同时存在</strong></p>
<p>当 <code>agent_hook</code> 被定义后，理论上无需再定义任何 <code>driver_hook</code> 与 Agent 中的驱动函数进行匹配。但是，如果需要对某个驱动函数进行特殊处理，可以再定义一个 <code>driver_hook</code> 与该驱动函数进行匹配。</p>
<p>当 <code>agent_hook</code> 与 <code>driver_hook</code> 同时存在时，框架会优先调用 <code>agent_hook</code> 函数，再调用 <code>driver_hook</code> 函数，并将 <code>driver_hook</code> 函数的返回值用于结果的对比。</p>
<p>当 Env 中所有的驱动函数都能找到对应的 <code>driver_hook</code> 或 <code>agent_hook</code> 时，参考模型便能成功与 Env 建立匹配关系，此时可以直接通过 Env 中的 <code>attach</code> 方法将参考模型附加到 Env 上。</p>
<h2 id="如何编写独立执行流模式的参考模型">如何编写独立执行流模式的参考模型</h2>
<p>独立执行流模式的参考模型是通过 <code>port</code> 接口的形式来完成数据的输入输出，他可以主动向 <code>port</code> 请求数据，也可以主动向 <code>port</code> 输出数据。在 toffee 中，我们提供了两种接口来实现这一功能，分别是 <code>DriverPort</code> 和 <code>MonitorPort</code>。</p>
<p>类似地，我们需要定义一系列的 <code>DriverPort</code> 使其与 Env 中的驱动函数匹配，同时定义一系列的 <code>MonitorPort</code> 使其与 Env 中的监测函数匹配。</p>
<p>当 Env 中的驱动函数被调用时，调用数据将会被发送到 <code>DriverPort</code> 中，参考模型将会主动获取这些数据，并进行计算。计算结果将会被输出到 <code>MonitorPort</code> 中，当 Env 中的监测函数被调用时，比较器会自动从 <code>MonitorPort</code> 中获取数据，并与 Env 中的监测函数的返回值进行比较。</p>
<h3 id="驱动方法接口匹配">驱动方法接口匹配</h3>
<p>为了接收到 Env 中所有的驱动函数的调用，参考模型可以选择为每一个驱动函数编写对应的 <code>DriverPort</code>。可以通过 <code>DriverPort</code> 的参数 <code>agent_name</code> 与 <code>driver_name</code> 来匹配 Env 中的驱动函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DriverPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">driver_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;push&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">pop_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DriverPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">driver_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;pop&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>与 <code>driver_hook</code> 类似，也可以使用下面的方式来匹配 Env 中的驱动函数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用 &#34;.&#34; 来指定驱动函数的路径</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DriverPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;port_agent.push&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果参考模型中的变量名称与驱动函数名称相同，可以省略 driver_name 参数</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DriverPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用变量名称同时匹配 Agent 名称与驱动函数名称，并使用 `__` 分隔</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_agent__push</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DriverPort</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="agent-接口匹配">Agent 接口匹配</h3>
<p>也可以选择定义 <code>AgentPort</code> 同时匹配一个 Agent 中的所有驱动函数。但与 <code>agent_hook</code> 不同的是，定义了 <code>AgentPort</code> 后，便不能为该 Agent 中的任何驱动函数再定义 <code>DriverPort</code>。所有的驱动函数调用将会被发送到 <code>AgentPort</code> 中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">StackRefModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Model</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">super</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AgentPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>类似的，当变量名称与 Agent 名称相同时，可以省略 <code>agent_name</code> 参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_agent</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AgentPort</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h2 id="监测方法接口匹配">监测方法接口匹配</h2>
<p>为了与 Env 中的监测函数匹配，参考模型需要为每一个监测函数编写对应的 <code>MonitorPort</code>，定义方法与 <code>DriverPort</code> 一致。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">monitor_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MonitorPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">monitor_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用 &#34;.&#34; 来指定监测函数的路径</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">monitor_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MonitorPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;port_agent.monitor&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果参考模型中的变量名称与监测函数名称相同，可以省略 monitor_name 参数</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">monitor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MonitorPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;port_agent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用变量名称同时匹配 Agent 名称与监测函数名称，并使用 `__` 分隔</span>
</span></span><span style="display:flex;"><span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port_agent__monitor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MonitorPort</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>MonitorPort 中送入的数据，将会自动与 Env 中的监测函数的返回值进行比较，来完成参考模型的比对工作。</p>
<p>当参考模型中定义的 <code>DriverPort</code>, <code>AgentPort</code> 和 <code>MonitorPort</code> 能够与 <code>Env</code> 中所有接口匹配时，参考模型便能成功与 <code>Env</code> 建立匹配关系，此时可以直接通过 <code>Env</code> 中的 <code>attach</code> 方法将参考模型附加到 <code>Env</code> 上。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c86338d72241e31623b577659ea691b">4 - 编写测试用例</h1>
    
	<p>编写测试用例需要使用验证环境中定义好的接口来实现，但在用例中，往往会遇到同时驱动多个接口的情况，并且对于参考模拟的同步往往也有不同的需求，这一部分将详细介绍如何更好地使用验证环境中的接口来编写测试用例。</p>
<p>当验证环境搭建完成后，编写测试用例用于验证设计的功能是否符合预期。对于硬件验证中的验证，两个重要的导向是：<strong>功能覆盖率</strong>和<strong>行覆盖率</strong>，功能覆盖率意味着测试用例是否覆盖了设计的所有功能，行覆盖率意味着测试用例是否触发了设计的所有代码行。在 toffee-test 中，不仅提供了对这两种覆盖率的支持，还会再每次运行过后，自动计算出这两种覆盖率的结果，并生成一个验证报告。toffee-test 使用 pytest 来管理测试用例，使其拥有强大的测试用例管理能力。</p>
<p>在本节中，会在以下几个方面来讲述如何编写测试用例，以使用 toffee 和 toffee-test 提供的强大功能：</p>
<ol>
<li>如何使用测试环境接口进行驱动</li>
<li>如何使用 pytest 管理测试用例</li>
<li>如何添加功能测试点</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59f61aa8e02aaee75f4d59274ed9c583">4.1 - 如何使用测试环境接口进行驱动</h1>
    
	<h2 id="如何同时调用多个驱动函数">如何同时调用多个驱动函数</h2>
<p>当验证环境搭建完成后，可以通过验证环境提供的接口来编写测试用例。然而，通过普通的串行代码，往往无法完成两个驱动函数的同时调用。在多个接口需要同时驱动的情况下，这种情况变得尤为重要，toffee 为这种场景提供了简便的调用方式。</p>
<h3 id="同时调用多个不同类别的驱动函数">同时调用多个不同类别的驱动函数</h3>
<p>例如目前的 Env 结构如下：</p>
<pre tabindex="0"><code>DualPortStackEnv
  - port1_agent
    - @driver_method push
    - @driver_method pop
  - port2_agent
    - @driver_method push
    - @driver_method pop
</code></pre><p>我们期望在测试用例中同时调用 <code>port1_agent</code> 和 <code>port2_agent</code> 的 <code>push</code> 函数，以便同时驱动两个接口。</p>
<p>在 toffee 中，可以通过 <code>Executor</code> 来完成。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>我们使用 <code>async with</code> 来创建一个 <code>Executor</code> 对象，并建立一个执行块，通过直接调用 <code>exec</code> 可以添加需要执行的驱动函数。当 <code>Executor</code> 对象退出作用域时，会将所有添加的驱动函数同时执行。<code>Executor</code> 会自动等待所有驱动函数执行完毕。</p>
<p>如果需要获取驱动函数的返回值，可以通过 <code>get_results</code> 方法来获取，<code>get_results</code> 会以字典的形式返回所有驱动函数的返回值，其中键为驱动函数的名称，值为一个列表，列表中存放了对应驱动函数的返回值。</p>
<h3 id="同一驱动函数被多次调用">同一驱动函数被多次调用</h3>
<p>如果在在执行块中多次调用同一驱动函数，<code>Executor</code> 会自动将这些调用串行执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>例如上述代码中，<code>port1_agent.push</code> 会被调用 5 次，<code>port2_agent.push</code> 会被调用 1 次。由于 <code>port1_agent.push</code> 是同一驱动函数，<code>Executor</code> 会自动将这 10 次调用串行执行，其返回值会被依次存放在返回值列表中。通过，<code>port2_agent.push</code> 将会与 <code>port1_agent.push</code> 并行执行。</p>
<p>上述过程中，我们创建了这样一个调度过程：</p>
<pre tabindex="0"><code>------------------  current time --------------------
  +---------------------+   +---------------------+
  | group &#34;agent1.push&#34; |   | group &#34;agent2.push&#34; |
  | +-----------------+ |   | +-----------------+ |
  | |   agent1.push   | |   | |   agent2.push   | |
  | +-----------------+ |   | +-----------------+ |
  | +-----------------+ |   +---------------------+
  | |   agent1.push   | |
  | +-----------------+ |
  | +-----------------+ |
  | |   agent1.push   | |
  | +-----------------+ |
  | +-----------------+ |
  | |   agent1.push   | |
  | +-----------------+ |
  | +-----------------+ |
  | |   agent1.push   | |
  | +-----------------+ |
  +---------------------+
------------------- Executor exit -------------------
</code></pre><p>Executor 根据两个驱动函数的函数名自动创建了两个调度组，并按照调用顺序将驱动函数添加到对应的调度组中。在调度组内部，驱动函数会按照添加的顺序依次执行。在调度组之间，驱动函数会并行执行。</p>
<p>调度组的默认名称为以 <code>.</code> 分隔的驱动函数路径名。</p>
<p>通过 <code>sche_group</code> 参数，你可以在执行函数时手动指定驱动函数调用时所属的调度组，例如</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sche_group</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;group1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sche_group</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;group1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>这样一来，<code>port1_agent.push</code> 和 <code>port2_agent.push</code> 将会被按顺序添加到同一个调度组 <code>group1</code> 中，表现出串行执行的特性。同时 <code>get_results</code> 返回的字典中，<code>group1</code> 会作为键，其值为一个列表，列表中存放了 <code>group1</code> 中所有驱动函数的返回值。</p>
<h3 id="将自定义函数加入-executor">将自定义函数加入 Executor</h3>
<p>如果我们在一个自定义函数中调用了驱动函数或其他驱动函数，并希望自定义函数也可以通过 <code>Executor</code> 来调度，可以通过与添加驱动函数相同的方式来添加自定义函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">multi_push_port1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">multi_push_port1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>此时，<code>multi_push_port1</code> 会被添加到 <code>Executor</code> 中，并创建以 <code>multi_push_port1</code> 为名称的调度组，并向其中添加两次调用。其会与 <code>port2_agent.push</code> 调度组并行执行。</p>
<p>我们也可以在自定义函数中使用 <code>Executor</code>，或调用其他自定义函数。这样一来，我们可以通过 <code>Executor</code> 完成任意复杂的调度。以下提供了若干个案例：</p>
<p><strong>案例一</strong></p>
<p>环境接口如下：</p>
<pre tabindex="0"><code>Env
- agent1
    - @driver_method send
- agent2
    - @driver_method send
</code></pre><p>两个 Agent 中的 <code>send</code> 函数各需要被并行调用 5 次，并且调用时需要发送上一次的返回结果，第一次发送时发送 0，两个函数调用相互独立。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sche_group</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;agent1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sche_group</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;agent2&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p><strong>案例二</strong></p>
<p>环境接口如下：</p>
<pre tabindex="0"><code>env
- agent1
    - @driver_method long_task
- agent2
    - @driver_method task1
    - @driver_method task2
</code></pre><p>task1 和 task2 需要并行执行，并且一次调用结束后需要同步，task1 和 task2 都需要调用 5 次，long_task 需要与 task1 和 task2 并行执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">exec_once</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">task1</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">task2</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_case</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exec_once</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">long_task</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h3 id="设置-executor-的退出条件">设置 Executor 的退出条件</h3>
<p>Executor 会等待所有添加的驱动函数执行完毕后退出，但有时我们并不需要等待所有驱动函数执行完毕，可以通过在创建 Executor 时使用 <code>exit</code> 参数来设置退出条件。</p>
<p><code>exit</code> 参数可以被设置为 <code>all</code>, <code>any</code> 或 <code>none</code> 三种值，分别表示所有调度组执行完毕后退出、任意一个调度组执行完毕后退出、不等待直接退出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">send_forever</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agent</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">exit</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;any&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">send_forever</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">agent2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>例如上述代码中 <code>send_forever</code> 函数是一个无限循环的函数，将 <code>exit</code> 设置为 <code>any</code> 后，Executor 会在 <code>env.agent2.send</code> 函数执行完毕后退出，而不会等待 <code>send_forever</code> 函数执行完毕。</p>
<p>如果后续需要等待所有任务执行完毕，可以通过等待 <code>exec.wait_all</code> 来实现。</p>
<h2 id="如何控制参考模型调度">如何控制参考模型调度</h2>
<p>在 toffee 中，参考模型的调度是由 toffee 自动完成的，但在某些情况下需要手动控制参考模型的调度顺序，例如在参考模型中需要调用多个函数，且这些函数之间存在调用顺序的情况。或者是控制参考模型与驱动函数之间的调用顺序。</p>
<h3 id="参考模型的调度顺序">参考模型的调度顺序</h3>
<p>在使用 Executor 执行时，可以使用参数 <code>sche_order</code> 来控制参考模型是在驱动函数之前、之后或同时执行。当为 <code>model_first</code> 时，参考模型会在驱动函数之前执行；当为 <code>dut_first</code> 时，驱动函数会在参考模型之前执行；当为 <code>parallel</code> 时，参考模型会与驱动函数同时执行。默认情况下为并行执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sche_order</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;dut_first&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">sche_order</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;dut_first&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>上述代码中，参考模型将会在对应的驱动函数结束之后才会被调用。</p>
<h3 id="参考模型函数之间的调用顺序">参考模型函数之间的调用顺序</h3>
<p>当使用函数调用模式编写参考模型时，参考模型中的函数之间可能存在调用顺序相关的一来，例如一个函数在调用之前必须需要另一个函数先被调用。</p>
<p>这一过程若不使用 Executor 使函数并行执行，很容易得到控制，串行执行的代码中函数的调用顺序即为其执行顺序。</p>
<p>但如果使用 Executor 并行执行函数，两个参考模型之间的调用顺序就无法保证。toffee 为此场景提供了 <code>priority</code> 参数，用于指定参考模型函数的调用顺序，数值越小其优先级较高。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Executor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#000">Executor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port1_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">priority</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">port2_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">priority</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exec</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_results</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>例如上述代码中，<code>port2_agent.push</code> 和 <code>port1_agent.push</code> 两个函数会并行执行，其参考模型的调用也将在同一时钟周期内完成。由于我们指定了<code>port2_agent.push</code> 的优先级为 0，<code>port1_agent.push</code> 的优先级为 1，因此在该周期的执行过程中，<code>port2_agent.push</code> 会优先被调用。</p>
<p>注意，优先级只在同一时钟周期内有效，若两个函数调用跨越了时钟周期，那么时钟周期靠前的函数依然会被优先调用。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-20d016e97daff972eb4b248aee8c24c1">4.2 - 如何使用 Pytest 管理测试用例</h1>
    
	<h2 id="编写测试用例">编写测试用例</h2>
<p>在 toffee 中，测试用例是通过 pytest 来管理的。pytest 是一个功能强大的 Python 测试框架，如果你不熟悉 pytest，可以查看 <a href="https://docs.pytest.org/en/latest/">pytest 官方文档</a>。</p>
<h3 id="编写第一个测试用例">编写第一个测试用例</h3>
<p>首先，我们需要创建一个测试用例文件，例如 <code>test_adder.py</code>，该文件需要以 <code>test_</code> 开头，或以 <code>_test.py</code> 结尾，以便 pytest 能够识别。接着可以在其中编写我们的第一个测试用例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># test_adder.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_test</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderEnv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_adder</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_test</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>pytest 并不能直接运行协程测试用例，因此我们需要在测试用例中调用 <code>toffee.run</code> 来运行异步测试用例。</p>
<p>用例编写完成后，我们可以在终端中运行 pytest。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pytest
</span></span></code></pre></div><p>pytest 会查找当前目录下所有以 <code>test_</code> 开头或以 <code>_test.py</code> 结尾的文件，并运行其中以 <code>test_</code> 开头的函数，每一个函数被视作一个测试用例。</p>
<h3 id="运行协程测试用例">运行协程测试用例</h3>
<p>为了使 pytest 能够直接运行协程测试用例，toffee 提供了 <code>toffee_async</code> 标记来标记异步测试用例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># test_adder.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_async</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_adder</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>如图所示，我们只需要在测试用例函数上添加 <code>@pytest.mark.toffee_async</code> 标记，pytest 就能够直接运行协程测试用例。</p>
<h2 id="生成测试报告">生成测试报告</h2>
<p>在运行 pytest 时，toffee 会自动收集测试用例的执行结果，自动统计覆盖率信息，并生成一个验证报告，想要生成该报告，需要在调用 pytest 时添加 <code>--toffee-report</code> 参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pytest --toffee-report
</span></span></code></pre></div><p>默认情况下，toffee 将会为每次运行生成一个默认报告名称，并将报告放至 <code>reports</code> 目录下。可以通过 <code>--report-dir</code> 参数来指定报告的存放目录，通过 <code>--report-name</code> 参数来指定报告的名称。</p>
<p>但此时，由于 toffee 无法得知覆盖率文件名称，因此在报告中无法显示覆盖率信息，如果想要在报告中显示覆盖率信息，需要在每个测试用例中传入功能覆盖组及行覆盖率文件的名称。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_async</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">adder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">waveform_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;adder.fst&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coverage_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;adder.dat&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adder&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_func_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cov_groups</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_line_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;adder.dat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>上述代码中，在创建 DUT 时，我们传入了波形文件和覆盖率文件的名称，使得 DUT 在运行时可以生成指定名称的覆盖率文件。接着我们定义了一个覆盖组，来收集 DUT 的功能覆盖率信息，具体如何使用将在下个文档中介绍。</p>
<p>接着，调用了 DUT 的 <code>Finish</code> 方法，用于结束波形文件的记录。最终我们通过 <code>set_func_coverage</code> 和 <code>set_line_coverage</code> 函数来设置功能覆盖组及行覆盖率文件信息。</p>
<p>此时再次运行 pytest 时，toffee 将会自动收集覆盖率信息，并在报告中显示。</p>
<h2 id="使用-toffee-test-管理资源">使用 toffee-test 管理资源</h2>
<p>然而，上述过程过于繁琐，并且为了保证每个测试用例之间文件名称不产生冲突，我们需要在每个测试用例中传入不一样的文件名称。并且在测试用例出现异常时，测试用例并不会运行完毕，导致覆盖率文件无法生成。</p>
<p>因此，toffee-test 提供了 <code>toffee_request</code> Fixture 来管理资源，简化了测试用例的编写。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># test_adder.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.mark.toffee_async</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_adder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AdderEnv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_agent</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">exec_add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">my_request</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toffee_request</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ToffeeRequest</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toffee_request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_cov_groups</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adder&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">toffee_request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">create_dut</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DUTAdder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Fixture 是 pytest 中的概念，例如上述代码中定义了一个名为 <code>my_request</code> 的 Fixture。如果在其他测试用例的输出参数中含有 <code>my_request</code> 参数，pytest 将会自动调用 <code>my_request</code> Fixture，并将其返回值传入测试用例。</p>
<p>上述代码中自定义了一个 Fixture <code>my_request</code>，并在测试用例中进行使用，这也就意味着资源的管理工作都将会在 Fixture 中完成，测试用例只需要关注测试逻辑即可。<code>my_request</code> 必须使用 toffee-test 提供的 <code>toffee_request</code> Fixture 作为参数，以便进行资源管理，<code>toffee_request</code> 提供了一系列的方法来管理资源。</p>
<p>通过 <code>add_cov_groups</code> 添加覆盖组，toffee-test 会自动将其生成至报告中。
通过 <code>create_dut</code> 创建 DUT 实例，toffee-test 会自动管理 DUT 的波形文件和覆盖率文件的生成，并确保文件名称不产生冲突。</p>
<p>在 <code>my_request</code> 中，可以自定义返回值传入测试用例中。如果想要任意测试用例都可以访问到该 Fixture，可以将 Fixture 定义在 <code>conftest.py</code> 文件中。</p>
<p>至此，我们实现了测试用例资源管理和逻辑编写的分离，无需在每个测试用例中手动管理资源的创建与释放。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a072beec952896e88e69f09e9e661bc0">4.3 - 功能检查点（功能覆盖率）</h1>
    
	<h2 id="什么是功能检查点">什么是功能检查点</h2>
<p>在 toffee 中，<strong>功能检查点(Cover Point)</strong> 是指对设计的某个功能进行验证的最小单元，判断该功能是否满足设计目标。<strong>测试组(Cover Croup)</strong> 是一类检查点的集合。</p>
<p>定义一个检查点，需要指定检查点的名称及检查点的触发条件（触发条件可以有多个，最终的检查结果为所有条件取“逻辑与”，触发条件称为<code>Cover Bin</code>）。例如，可以定义了一个检查点，“当加法器运算结果不为 0 时，结果运算正确”，此时，检查点的触发条件可以为 “加法器的 sum 信号不为零”。</p>
<p>当检查点的所有触发条件都满足时，检查点被触发，此时，验证报告将会记录下该检查点的触发。并会提升验证的功能覆盖率。当所有检查点都被触发时，验证的功能覆盖率达到 100%。</p>
<h2 id="如何编写检查点">如何编写检查点</h2>
<p>编写检查点前，首先需要创建一个测试组，并指定测试组的名称</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee.funcov</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">fc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Group-A&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>接着，需要往这个测试组中添加检查点。一般情况下，一个功能点对应一个或多个检查点，用来检查是否满足该功能。例如我们需要检查<code>Adder</code>的<code>cout</code>是否有<code>0</code>出现，我们可以通过如下方式添加：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_cout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;io_cout is 0&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Eq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;cover_point_1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>在上述检查点中，需要观察的数据为<code>io_cout</code>引脚，检查条件(<code>Cover Bin</code>)的名称为<code>io_cout is 0</code>，检查点名称为<code>cover_point_1</code>。函数<code>add_watch_point</code>的参数说明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">target</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">bins</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">str</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">once</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        @param target: 检查目标，可以是一个引脚，也可以是一个DUT对象
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        @param bins: 检查条件，dict格式，key为条件名称，value为具体检查方法或者检查方法的数组。
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        @param name: 检查点名称
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">        @param once，如果once=True，表明只检查一次，一旦该检查点满足要求后就不再进行重复条件判断。
</span></span></span></code></pre></div><p>通常情况下，<code>target</code>为<code>DUT</code>引脚，<code>bins</code>中的检查函数来检查<code>target</code>的<code>value</code>是否满足预定义条件。<code>funcov</code>模块内存了部分检查函数，例如<code>Eq(x), Gt(x), Lt(x), Ge(x), Le(x), Ne(x), In(list), NotIn(list), isInRange([low,high])</code>等。当内置检查函数不满足要求时，也可以自定义，例如需要跨时钟周期进行检查等。自定义检查函数的输入参数为<code>target</code>，返回值为<code>bool</code>。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">add_watch_point</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adder</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">io_cout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#4e9a06">&#34;io_cout is 0&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#4e9a06">&#34;io_cout is 1&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#4e9a06">&#34;io_cout is x&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Eq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">In</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;cover_point_1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>当添加完所有的检查点后，需要在<code>DUT</code>的<code>Step</code>回调函数中调用<code>CovGroup</code>的<code>sample()</code>方法进行判断。在检查过程中，或者测试运行完后，可以通过<code>CovGroup</code>的<code>as_dict()</code>方法查看检查情况。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">as_dict</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h2 id="如何在测报告中展示">如何在测报告中展示</h2>
<p>在测试<code>case</code>每次运行结束时，可以通过<code>set_func_coverage(request, cov_groups)</code>告诉框架对所有的功能覆盖情况进行合并收集。相同名字的<code>CoverGroup</code>会被自动合并。下面是一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">pytest</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">toffee.funcov</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">fc</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">toffee_test.reporter</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">set_func_coverage</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fc</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">CovGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Group X&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">init_function_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># add your points here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@pytest.fixture</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">dut_input</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># before test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init_function_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DUT</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">InitClock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clock&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">StepRis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">lambda</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">sample</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">yield</span> <span style="color:#000">dut</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># after test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dut</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Finish</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">set_func_coverage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_case1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut_input</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_case2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dut_input</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">assert</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ...</span>
</span></span></code></pre></div><p>在上述例子中，每个<code>case</code>都会通过<code>dut_input</code>函数来创建输入参数。该函数用<code>yield</code>返回<code>dut</code>，在运行<code>case</code>前初始化<code>dut</code>，并且设置在<code>dut</code>的<code>step</code>回调中执行<code>g.sample()</code>。运行完<code>case</code>后，调用<code>set_func_coverage</code>收集覆盖率，然后清空收集的信息。所有测试运行完成后，可在生成的测试报告中查看具体的覆盖情况。</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-218ae6a2d4629a583763e808ab9baf63">5 - 开始新的验证任务</h1>
    
	<p>使用 toffee，你已经可以搭建出一个完整的验证环境，并且方便地去编写测试用例了。然而在实际的业务中，往往无法理解如何开始上手，并最终完成验证任务。实际编写代码后，会遇到无法正确划分 Bundle，无法正确理解 Agent 的高级语义封装，搭建完环境之后不知道做什么等问题。</p>
<p>在这一节中，将会介绍如何从头开始完成一个新的验证任务，以及如何更好地使用 toffee 来完成验证任务。</p>
<h2 id="1-了解待验证设计">1. 了解待验证设计</h2>
<p>拿到一个新的设计后，往往面对的是几十或数百个输入输出信号，如果直接看这些信号，很可能一头雾水，感觉无从下手。在这时，你必须坚信，输入输出信号都是设计人员来定义的，只要能够理解设计的功能，就能够理解这些信号的含义。</p>
<p>如果设计人员提供了设计文档，那么你可以阅读设计文档，了解设计的功能，并一步步地将功能与输入输出信号对应起来，并且要清楚地理解输入输出信号的时序，以及如何使用这些信号来驱动设计。一般来说，你还需要阅读设计的源代码，来找寻更细节的接口时序问题。</p>
<p>当大致了解了 DUT 的功能，并明白如何驱动起 DUT 接口之后，你就可以开始搭建验证环境了。</p>
<h2 id="2-划分-bundle">2. 划分 Bundle</h2>
<p>搭建环境的第一件事，就是根据接口的逻辑功能，将其划分为若干个接口集合，我们可以每一个接口集合视作一个 Bundle。划分为的每个 Bundle 都应是独立的，由一个独立的 Agent 来驱动。</p>
<p>但是，往往实际中的接口是这样的：</p>
<pre tabindex="0"><code>|---------------------- DUT Bundle -------------------------------|

|------- Bundle 1 ------| |------ Bundle 2 ------| |-- Bundle 3 --|

|-- B1.1 --| |-- B1.2 --| |-- B2.1 --|
</code></pre><p>那么问题就出现了，例如究竟是应该为 B1.1， B1.2 各自创建一个 Agent，还是应该直接为 Bundle 1 建立一个 Agent 呢？</p>
<p>这还是取决于接口的逻辑功能，如果需要定义一个独立的请求，这个请求需要对 B1.1 和 B1.2 同时进行操作，那么就应该为 Bundle 1 创建一个 Agent，而不是为 B1.1 和 B1.2 分别创建 Agent。</p>
<p>即便如此，为 B1.1 和 B1.2 定义 1.2 也是可行的，这增添了 Agent 的划分粒度，但牺牲了操作的连续性，上层代码和参考模型的编写都会变得复杂。因此选择合适的划分粒度是需要对具体业务的权衡。最终的划分，所有的 Agent 加起来应该能覆盖 DUT Bundle 的所有接口。</p>
<p>实践中，为了方便 DUT 的连接，可以定义一个 <code>DUT</code> Bundle，一次性将所有的接口都连接到这个 Bundle 上，由 Env 将其中的子 Bundle 分发给各个 Agent。</p>
<h2 id="3-编写-agent">3. 编写 Agent</h2>
<p>当 Bundle 划分完成后，就可以开始编写 Agent 来驱动这些 Bundle 了，你需要为每个 Bundle 编写一个 Agent。</p>
<p>首先，可以从驱动方法开始写起，驱动方法实际上是对 Bundle 的一种高级语义封装，因此，高级语义信息应该携带了足以驱动 Bundle 的所有信息。如果 Bundle 中存在一个信号需要数字，但参数中并没有提供与这一信号相关的信息，那么这种高级语义封装就是不完整的。应尽量避免在驱动方法中对某个信号值进行假定，如果对这一信号在 Agent 中进行假定，DUT 的输出将会受到这一假定的影响，可能导致参考模型与 DUT 的行为不一致。</p>
<p>同时，这一高层封装也决定了参考模型的功能层级，参考模型会直接与高层语义信息进行交互，并不会涉及到底层信号。</p>
<p>如果参考模型需要用函数调用模式编写，那么应该将 DUT 的输出通过函数返回值来返回。如果参考模型需要用独立执行流模式编写，那么应该编写监测方法，将 DUT 的所有输出转换成高层语义信息，通过监测方法输出。</p>
<h2 id="4-封装成-env">4. 封装成 Env</h2>
<p>当所有的 Agent 编写完成后，或者挑选之前已有的 Agent，就可以将这些 Agent 封装成 Env 了。</p>
<p>Env 封装了整个验证环境，并确定了参考模型的编写规范。</p>
<h2 id="5-编写参考模型">5. 编写参考模型</h2>
<p>参考模型的编写没有必要在 Env 编写完成之后再开始，可以与 Agent 的编写同时进行，并实时编写一些驱动代码，来检验编写的正确性。当然如果 Agent 的编写特别规范，编写完整 Env 后再编写参考模型也是可行的。</p>
<p>参考模型最重要的是选择合适的编写模式，函数调用模式和独立执行流模式都是可行的，但在不同的场景下，选择不同的模式会更加方便。</p>
<h2 id="6-确定功能点及测试点">6. 确定功能点及测试点</h2>
<p>编写好 Env 以及参考模型后，并不能直接开始编写测试用例，因为此时并没有测试用例的编写方向，盲目的编写测试用例，没有办法让待测设计验证完全。</p>
<p>首先需要列出功能点及测试点列表。功能点是待测设计支持的所有功能，例如对于一个算术逻辑单元（ALU）来说，功能点的形式可能是“支持加法”，“支持乘法”等。每个功能点需要对应一个或多个测试点，测试点通过将功能划分为不同的测试场景，来验证功能点是否正确。例如对于“支持加法”这个功能点，可能有“当输入都为正数时，加法正确”等测试点。</p>
<h2 id="7-编写测试用例">7. 编写测试用例</h2>
<p>当功能点及测试点列表确定后，就可以开始编写测试用例了，一个测试用例需要能够覆盖一个或多个测试点，以验证功能点是否正确。所有的测试用例应该能够覆盖所有的测试点（功能覆盖率 100%），以及覆盖所有的设计行（行覆盖率 100%），这样一来就能保证验证的完备性。</p>
<p>如何保证验证的正确性呢？如果采用参考模型比对的方式，当比对失败时，toffee 会自动抛出异常，使得测试用例失败。如果采用直接比对的方式，应该在测试用例中使用 <code>assert</code> 来编写比对代码，当比对失败时，测试用例也会失败。最终，当所有的测试用例都通过时，意味着功能已验证为正确。</p>
<p>编写过程中，你需要使用 <code>Env</code> 中提供的接口来驱动 DUT，如果出现了需要多个驱动方法交互的情况，可以使用 <code>Executor</code> 来封装更高层的函数。也就是说驱动方法级的交互，是在测试用例的编写中完成的。</p>
<h2 id="8-编写验证报告">8. 编写验证报告</h2>
<p>当行覆盖率和功能覆盖率都达到了 100% 之后，意味着验证已经完成。最终需要编写一个验证报告，来总结验证任务的结果。如果验证出了待测设计的问题，也应在验证报告中详细描述问题的原因。如果行覆盖率或者功能覆盖率没有达到 100%，也应在验证报告中说明原因，报告的格式应该遵循公司内部统一的规范。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c7e9635323f5bcd8850571649a8a42b8">6 - API 文档</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-bd013f36b484950df4c10662b7c51cde">6.1 - Bundle API</h1>
    
	
</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="User mailing list" aria-label="User mailing list">
    <a target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2025
    <span class="td-footer__authors">BOSC</span></span><span class="td-footer__all_rights_reserved">保留所有权利</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/mlvp/js/main.min.37d14e870feb76f0f7a2a2422bae231efb0186c477999a4ab9ca7e9924ced592.js" integrity="sha256-N9FOhw/rdvD3oqJCK64jHvsBhsR3mZpKucp&#43;mSTO1ZI=" crossorigin="anonymous"></script>
<script src='/mlvp/js/prism.js'></script>
<script src='/mlvp/js/tabpane-persist.js'></script>

  </body>
</html>
